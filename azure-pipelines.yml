# TODO: implement features

trigger:
  - master

variables:
  FeatureNamePrefix: 'feature/'
  FeatureName: ''
  VERBOSITY: minimal
  GIT_SHA: $(Build.SourceVersion)
  GIT_BRANCH_NAME: $(Build.SourceBranchName)
  BUILD_NUMBER: $(Build.BuildId)
  FEATURE_NAME: $(FeatureName)

jobs:
  # PRE-BUILD JOBS
  - job: Prepare
    displayName: Prepare Build Variables
    pool: 
      vmImage: ubuntu-16.04
    steps:
      - checkout: self
        clean: true
        subbodules: recursive
      - script: |
          echo Preparing to build $(GIT_SHA) on branch $(GIT_BRANCH_NAME)...
          echo Build started for build \# $(BUILD_NUMBER).

  # NATIVE JOBS
  - job: Native_Win32
    displayName: Build Native Win32 (Windows)
    dependsOn: Prepare
    pool:
      vmImage: vs2017-win2016
    steps:
      - checkout: self
        clean: true
        subbodules: recursive
      - powershell: .\bootstrapper.ps1 -t externals-windows -v $env:VERBOSITY
      - task: PublishPipelineArtifact@0
        inputs:
          artifactName: nativeArtifacts
          targetPath: 'output'
  - job: Native_MacOS
    displayName: Build Native macOS (macOS)
    dependsOn: Prepare
    pool:
      vmImage: macos-10.13
    steps:
      - checkout: self
        clean: true
        subbodules: recursive
      - bash: ./bootstrapper.sh -t externals-macos -v $VERBOSITY
      - task: PublishPipelineArtifact@0
        inputs:
          artifactName: nativeArtifacts
          targetPath: 'output'

  # MANAGED JOBS
  - job: Managed_Windows
    displayName: Build Managed Windows
    dependsOn: 
      - Native_Win32
      - Native_MacOS
    pool:
      vmImage: vs2017-win2016
    steps:
      - checkout: self
        clean: true
        subbodules: recursive
      - bash: .\bootstrapper.ps1 -t everything --skipexternals=all -v $env:VERBOSITY
      - task: PublishPipelineArtifact@0
        inputs:
          artifactName: nativeArtifacts
          targetPath: 'output'

  # POST-BUILD JOBS