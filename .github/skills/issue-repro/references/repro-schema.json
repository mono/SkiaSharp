{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/mono/SkiaSharp/repro-schema.json",
  "title": "SkiaSharp Bug Reproduction",
  "description": "Per-issue AI bug reproduction v2.0. Captures systematic reproduction attempts with step-by-step results, environment details, and binary artifact references. Output limits: 2KB per step (4KB for failure steps), 50 lines for stack traces. Absolute paths containing usernames must be redacted.",
  "type": "object",
  "required": ["meta", "conclusion", "notes", "reproductionSteps", "environment"],
  "additionalProperties": false,
  "$defs": {
    "stepResult": {
      "type": "string",
      "enum": ["success", "failure", "wrong-output", "skip"],
      "description": "TECHNICAL outcome only — NOT whether it matched expectations. success=command exited 0. failure=command exited non-zero or exception thrown (EVEN IF this confirms the bug). wrong-output=process ran without error but output is incorrect. skip=step was skipped."
    },
    "stepLayer": {
      "type": "string",
      "enum": ["csharp", "c-api", "native", "deployment", "setup"],
      "description": "Which layer of the SkiaSharp stack this step exercises."
    },
    "conclusionValue": {
      "type": "string",
      "enum": [
        "reproduced",
        "not-reproduced",
        "wrong-output",
        "needs-platform",
        "needs-hardware",
        "partial",
        "inconclusive"
      ],
      "description": "FACTUAL observation of whether reported behavior occurred. reproduced=reported behavior was observed (even if 'working as designed'). not-reproduced=reported behavior was NOT observed. wrong-output=process succeeded but output incorrect. needs-platform=requires unavailable OS/platform. needs-hardware=requires specific hardware. partial=some aspects reproduced. inconclusive=insufficient info."
    },
    "artifactSource": {
      "type": "string",
      "enum": ["issue-attachment", "test-data", "generated", "external"],
      "description": "Where the binary artifact comes from."
    }
  },
  "properties": {
    "meta": {
      "type": "object",
      "required": ["schemaVersion", "number", "repo", "analyzedAt"],
      "additionalProperties": false,
      "properties": {
        "schemaVersion": {
          "type": "string",
          "const": "1.0",
          "description": "Schema version."
        },
        "number": {
          "type": "integer",
          "minimum": 1,
          "description": "GitHub issue number."
        },
        "repo": {
          "type": "string",
          "description": "Repository in owner/name format.",
          "pattern": "^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$"
        },
        "analyzedAt": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 UTC timestamp of when reproduction was performed."
        }
      }
    },
    "inputs": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "triageFile": {
          "type": "string",
          "description": "Relative path to ai-triage JSON if consumed, e.g. 'ai-triage/2997.json'."
        }
      },
      "description": "Upstream pipeline files consumed by this step."
    },
    "conclusion": {
      "$ref": "#/$defs/conclusionValue"
    },
    "notes": {
      "type": "string",
      "minLength": 10,
      "description": "Free-text summary of reproduction results for humans."
    },
    "assessment": {
      "type": "string",
      "enum": ["unknown", "likely-bug", "working-as-designed", "breaking-change", "docs-gap", "user-error"],
      "description": "EDITORIAL classification only. Use to record opinions without corrupting the factual 'conclusion'."
    },
    "scope": {
      "type": "string",
      "description": "Cross-platform scope derived from Phase 3D verification. 'universal'=reproduced on ≥2 platforms, 'platform-specific/{platform}'=reproduced only on one platform, 'unknown'=only tested one platform.",
      "pattern": "^(universal|unknown|platform-specific/(macos|linux|windows|wasm|ios|android))$"
    },
    "reproductionTime": {
      "type": "string",
      "description": "Approximate time spent reproducing, e.g. '~10 minutes'."
    },
    "versionResults": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["version", "source", "result"],
        "additionalProperties": false,
        "properties": {
          "version": {
            "type": "string",
            "description": "SkiaSharp version tested, e.g. '2.88.9', '3.116.1', 'main (source)'."
          },
          "source": {
            "type": "string",
            "enum": ["nuget", "source"],
            "description": "nuget=released NuGet package, source=built from source code."
          },
          "result": {
            "type": "string",
            "enum": ["reproduced", "not-reproduced", "wrong-output", "error", "not-tested"],
            "description": "What happened with this version."
          },
          "notes": {
            "type": "string",
            "description": "Brief note about result on this version."
          },
          "platform": {
            "type": "string",
            "description": "Platform/environment where this version was tested, e.g. 'host-macos-arm64', 'docker-linux-x64', 'wasm-blazor'."
          }
        }
      },
      "description": "Results of testing across different SkiaSharp versions."
    },
    "reproProject": {
      "type": "object",
      "required": ["type", "tfm", "packages"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["console", "blazorwasm", "docker", "mobile", "wpf", "winforms", "winui", "maui", "test", "existing"],
          "description": "Project type used for reproduction. Must match the platform file used."
        },
        "tfm": {
          "type": "string",
          "description": "Target framework moniker, e.g. 'net10.0'."
        },
        "packages": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "version"],
            "additionalProperties": false,
            "properties": {
              "name": { "type": "string" },
              "version": { "type": "string" }
            }
          }
        }
      }
    },
    "reproductionSteps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["stepNumber", "description", "layer"],
        "additionalProperties": false,
        "properties": {
          "stepNumber": {
            "type": "integer",
            "minimum": 1,
            "description": "Sequential step number starting from 1."
          },
          "description": {
            "type": "string",
            "minLength": 5,
            "description": "What this step does and why."
          },
          "layer": {
            "$ref": "#/$defs/stepLayer"
          },
          "command": {
            "type": "string",
            "description": "Shell command executed. Redact absolute paths containing usernames."
          },
          "exitCode": {
            "type": "integer",
            "minimum": 0,
            "description": "Process exit code. 0=success. Required when command ran and result is success/failure/wrong-output."
          },
          "output": {
            "type": "string",
            "maxLength": 4096,
            "description": "Command output. Max 2KB for success steps, 4KB for failure steps. Truncate with [...truncated...] if needed."
          },
          "filesCreated": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["filename", "description"],
              "additionalProperties": false,
              "properties": {
                "filename": {
                  "type": "string",
                  "description": "Filename or relative path from project root."
                },
                "description": {
                  "type": "string",
                  "description": "What this file contains and why it was created."
                },
                "content": {
                  "type": "string",
                  "description": "Full source code content. Include for source files (Program.cs, .csproj) that form the reproduction."
                }
              }
            },
            "description": "Files created in this step. Include content for source files that form the reproduction."
          },
          "result": {
            "$ref": "#/$defs/stepResult"
          }
        }
      }
    },
    "artifacts": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["filename", "description", "source", "available"],
        "additionalProperties": false,
        "properties": {
          "filename": {
            "type": "string",
            "description": "Filename of the binary asset."
          },
          "description": {
            "type": "string",
            "description": "What this file is and why it's needed."
          },
          "source": {
            "$ref": "#/$defs/artifactSource"
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "URL to the asset."
          },
          "available": {
            "type": "boolean",
            "description": "Whether the file could be obtained for reproduction."
          }
        }
      },
      "description": "Binary files needed for reproduction. Reference by URL/filename, never inline binary content."
    },
    "errorMessages": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "primaryError": {
          "type": "string",
          "description": "Main error message or exception type."
        },
        "stackTrace": {
          "type": "string",
          "maxLength": 5000,
          "description": "Stack trace, max 50 lines. Redact absolute paths."
        },
        "additionalErrors": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Other error messages observed."
        }
      }
    },
    "environment": {
      "type": "object",
      "required": ["os", "arch", "dotnetVersion", "skiaSharpVersion", "dockerUsed"],
      "additionalProperties": false,
      "properties": {
        "os": {
          "type": "string",
          "description": "Operating system, e.g. 'macOS 15.3', 'Ubuntu 24.04'."
        },
        "arch": {
          "type": "string",
          "description": "CPU architecture, e.g. 'arm64', 'x64'."
        },
        "dotnetVersion": {
          "type": "string",
          "description": ".NET runtime version, e.g. '10.0.2'."
        },
        "dotnetSdkVersion": {
          "type": "string",
          "description": "Exact .NET SDK version from 'dotnet --info', e.g. '10.0.102'. CRITICAL: run dotnet --info in the TEST directory (/tmp/), NOT the SkiaSharp repo (which has global.json pinning to SDK 8)."
        },
        "wasmToolsVersion": {
          "type": "string",
          "description": "wasm-tools workload manifest version from 'dotnet --info', e.g. '10.0.102/10.0.100'. Required for WASM/Blazor reproductions."
        },
        "skiaSharpVersion": {
          "type": "string",
          "description": "Primary SkiaSharp version used."
        },
        "dockerUsed": {
          "type": "boolean",
          "description": "Whether Docker was used for reproduction."
        },
        "gpu": {
          "type": "object",
          "required": ["available"],
          "additionalProperties": false,
          "properties": {
            "backend": {
              "type": "string",
              "description": "GPU backend, e.g. 'Metal', 'OpenGL', 'Vulkan'."
            },
            "available": {
              "type": "boolean",
              "description": "Whether GPU acceleration was available."
            }
          },
          "description": "GPU details. Include for rendering bugs."
        }
      }
    },
    "blockers": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1,
      "description": "Specific reasons reproduction was incomplete. Required when conclusion is partial, needs-platform, needs-hardware, or inconclusive."
    },
    "feedback": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "triageCorrections": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["topic", "upstream", "corrected"],
            "additionalProperties": false,
            "properties": {
              "topic": {
                "type": "string",
                "description": "What category of finding was corrected, e.g. 'classification', 'scope', 'affected-platforms', 'expected-behavior'."
              },
              "upstream": {
                "type": "string",
                "description": "What the triage step said or concluded."
              },
              "corrected": {
                "type": "string",
                "description": "What reproduction actually found to be true."
              }
            }
          },
          "description": "Corrections to triage findings discovered during reproduction."
        }
      },
      "description": "Feedback on upstream pipeline steps. Record corrections when reproduction contradicts triage."
    }
  },
  "allOf": [
    {
      "if": {
        "properties": { "conclusion": { "const": "reproduced" } }
      },
      "then": {
        "properties": {
          "reproductionSteps": {
            "contains": {
              "properties": { "result": { "enum": ["failure", "wrong-output"] } },
              "required": ["result"]
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": { "conclusion": { "const": "not-reproduced" } }
      },
      "then": {
        "properties": {
          "reproductionSteps": {
            "allOf": [
              {
                "contains": {
                  "properties": { "result": { "const": "success" } },
                  "required": ["result"]
                }
              },
              {
                "not": {
                  "contains": {
                    "properties": { "result": { "enum": ["failure", "wrong-output"] } },
                    "required": ["result"]
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "conclusion": { "enum": ["needs-platform", "needs-hardware", "partial", "inconclusive"] }
        }
      },
      "then": {
        "required": ["meta", "conclusion", "notes", "reproductionSteps", "environment", "blockers"]
      }
    }
  ]
}
