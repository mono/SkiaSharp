{
  "number": 1971,
  "type": "issue",
  "state": "closed",
  "title": "[QUESTION] how to correctly resize a hardware canvas",
  "body": "\u003C!--\r\n\r\nYou can ask questions here, but there might be better places to do that as well:\r\n\r\n - If you have questions on how to use SkiaSharp with .NET, this is the best place.\r\n - If you have questions on how to draw a picture, but need some suggestions, there is the community to help:\r\n    - StackOverflow: https://stackoverflow.com/questions/tagged/skiasharp\r\n    - Xamarin Forums: https://forums.xamarin.com\r\n    - Gitter.im Chat: https://gitter.im/xamarin/XamarinComponents\r\n - If you have questions on skia, or need to ask more advanced questions about the native API, the skia Group is the place to go: https://groups.google.com/forum/#!forum/skia-discuss\r\n\r\nBut... If you still aren\u0027t sure about where to ask your question, then go ahead and ask here! We will try and answer you, but if we can\u0027t, then we will help you get the answers you want.\r\n\r\n--\u003E\r\n\r\nhow do i correctly resize a SkiaSharp canvas?\r\n\r\nas i sometimes get this when constantly resizing the window very quickly and very rapidly\r\n\r\nthis DOES NOT happen when i OMIT the drawing code (eg it does not crash when i do not create a hardware canvas)\r\n\r\n\u0060\u0060\u0060\r\nOnPaintSurface\r\nOnPaintSurface\r\nOnPaintSurface\r\nOnPaintSurface\r\n\r\n=================================================================\r\n\tNative Crash Reporting\r\n=================================================================\r\nGot a segv while executing native code. This usually indicates\r\na fatal error in the mono runtime or one of the native libraries\r\nused by your application.\r\n=================================================================\r\n\r\n=================================================================\r\n\tNative stacktrace:\r\n=================================================================\r\n\t0x10aca9846 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : mono_dump_native_crash_info\r\n\t0x10ac9d3be - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : mono_handle_native_crash\r\n\t0x10af636e7 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : altstack_handle_and_restore.cold.1\r\n\t0x10ac1948e - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : altstack_handle_and_restore\r\n\t0x7fff3d1217b7 - /System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib : glDeleteFramebuffers\r\n\t0x10b8d45b1 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b8e5a7e - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b8e7b4b - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b77520f - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b79c1ca - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b7b9822 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b7bad09 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b78b5da - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b84e250 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b55845e - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b558073 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b5584ce - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10b858d80 - /Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x1157df5d1 - Unknown\r\n\t0x1157df4fb - Unknown\r\n\t0x1157df3f3 - Unknown\r\n\t0x1157de57c - Unknown\r\n\t0x1157de4bb - Unknown\r\n\t0x1157de45b - Unknown\r\n\t0x1157e0b72 - Unknown\r\n\t0x1157a453c - Unknown\r\n\t0x10ad6e1c0 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : mono_gc_run_finalize\r\n\t0x10ae6b025 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : sgen_gc_invoke_finalizers\r\n\t0x10ad70013 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : finalizer_thread\r\n\t0x10ae41373 - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : start_wrapper_internal\r\n\t0x10ae411be - /Users/smallville7123/Projects/Xamarin_DAW/./Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MacOS/Xamarin DAW : start_wrapper\r\n\t0x7fff6d5b6109 - /usr/lib/system/libsystem_pthread.dylib : _pthread_start\r\n\t0x7fff6d5b1b8b - /usr/lib/system/libsystem_pthread.dylib : thread_start\r\n\r\n=================================================================\r\n\tTelemetry Dumper:\r\n=================================================================\r\nPkilling 0x4553973184x from 0x123145410846720x\r\nCould not exec mono-hang-watchdog, expected on path \u0027/Users/smallville7123/Projects/Xamarin_DAW/Xamarin_DAW.MacOS/bin/Debug/Xamarin DAW.app/Contents/MonoBundle/../bin/mono-hang-watchdog\u0027 (errno 2)\r\nmono_os_sem_init: semaphore_create failed with error -301Entering thread summarizer pause from 0x123145410846720x\r\nFinished thread summarizer pause from 0x123145410846720x.\r\nFailed to create breadcrumb file (null)/crash_hash_0xd8f5bec72\r\n\r\nWaiting for dumping threads to resume\r\n\r\n=================================================================\r\n\tExternal Debugger Dump:\r\n=================================================================\r\n\r\n=================================================================\r\n\tBasic Fault Address Reporting\r\n=================================================================\r\nMemory around native instruction pointer (0x7fff3d1217b7):0x7fff3d1217a7  89 e5 48 89 f2 89 fe 65 48 8b 04 25 f0 00 00 00  ..H....eH..%....\r\n0x7fff3d1217b7  48 8b 88 10 15 00 00 48 8b 38 5d ff e1 55 48 89  H......H.8]..UH.\r\n0x7fff3d1217c7  e5 48 89 f2 89 fe 65 48 8b 04 25 f0 00 00 00 48  .H....eH..%....H\r\n0x7fff3d1217d7  8b 88 18 15 00 00 48 8b 38 5d ff e1 55 48 89 e5  ......H.8]..UH..\r\n\r\n=================================================================\r\n\tManaged Stacktrace:\r\n=================================================================\r\n\t  at \u003Cunknown\u003E \u003C0xffffffff\u003E\r\n\t  at SkiaSharp.SkiaApi:sk_refcnt_safe_unref \u003C0x000a0\u003E\r\n\t  at SkiaSharp.SKObjectExtensions:SafeUnRef \u003C0x000ea\u003E\r\n\t  at SkiaSharp.SKObject:DisposeNative \u003C0x000c2\u003E\r\n\t  at SkiaSharp.SKNativeObject:Dispose \u003C0x000ab\u003E\r\n\t  at SkiaSharp.SKObject:Dispose \u003C0x0004a\u003E\r\n\t  at SkiaSharp.SKSurface:Dispose \u003C0x0004a\u003E\r\n\t  at SkiaSharp.SKNativeObject:Finalize \u003C0x00041\u003E\r\n\t  at System.Object:runtime_invoke_virtual_void__this__ \u003C0x000ab\u003E\r\n=================================================================\r\nAbort trap: 6\r\nMatthews-MacBook-Pro:Xamarin_DAW smallville7123$\r\n\u0060\u0060\u0060\r\n\r\n\r\nthis is my skia view\r\n\r\n\u0060\u0060\u0060cs\r\nusing System;\r\nusing SkiaSharp;\r\nusing SkiaSharp.Views.Forms;\r\nusing Xamarin.Forms;\r\n\r\nnamespace Xamarin_DAW.Skia_UI_Kit\r\n{\r\n    [ContentProperty(\u0022Content\u0022)]\r\n    public class SkiaViewHost : SKGLView\r\n    {\r\n        public static readonly BindableProperty ContentProperty = BindableProperty.Create(\u0022Content\u0022, typeof(View), typeof(SkiaViewHost), default(View), propertyChanged: OnContentChanged);\r\n\r\n        private static void OnContentChanged(BindableObject bindable, object oldValue, object newValue) =\u003E ((SkiaViewHost)bindable).Content = (View)newValue;\r\n\r\n        public View Content\r\n        {\r\n            get =\u003E (View)GetValue(ContentProperty);\r\n            set =\u003E SetValue(ContentProperty, value);\r\n        }\r\n\r\n        public static readonly BindableProperty ApplicationProperty = BindableProperty.Create(\u0022Application\u0022, typeof(Application), typeof(SkiaViewHost), default(Application), propertyChanged: OnApplicationChanged);\r\n\r\n        private static void OnApplicationChanged(BindableObject bindable, object oldValue, object newValue)\r\n        {\r\n            SkiaViewHost bindable1 = (SkiaViewHost)bindable;\r\n            bindable1.Application?.OnPause();\r\n            bindable1.Application?.SetHost(null);\r\n            bindable1.Application = (Application)newValue;\r\n            bindable1.Application?.SetHost(bindable1);\r\n        }\r\n\r\n        public void INTERNAL_ERROR(string error)\r\n        {\r\n            // TODO: display error to screen\r\n            throw new ApplicationException(error);\r\n        }\r\n\r\n        public Application Application\r\n        {\r\n            get =\u003E (Application)GetValue(ApplicationProperty);\r\n            set =\u003E SetValue(ApplicationProperty, value);\r\n        }\r\n\r\n        public UI.Utils.MultiTouch multiTouch;\r\n\r\n        SKCanvas canvas;\r\n\r\n        public SkiaViewHost()\r\n        {\r\n            multiTouch = new UI.Utils.MultiTouch();\r\n            multiTouch.setMaxSupportedTouches(10);\r\n            multiTouch.throw_on_error = false;\r\n            EnableTouchEvents = true;\r\n        }\r\n\r\n        protected override void OnPaintSurface(SKPaintGLSurfaceEventArgs e)\r\n        {\r\n            Console.WriteLine(\u0022OnPaintSurface\u0022);\r\n\r\n            base.OnPaintSurface(e);\r\n\r\n            e.Surface.Canvas.Clear(SKColors.Black);\r\n\r\n            if (Application is not null)\r\n            {\r\n                bool canvas_exists = canvas is not null;\r\n                bool canvas_needs_creation = !canvas_exists\r\n                    || canvas.getWidth() != e.BackendRenderTarget.Width\r\n                    || canvas.getHeight() != e.BackendRenderTarget.Height;\r\n\r\n                if (canvas_needs_creation)\r\n                {\r\n                    canvas = SKCanvasExtensions.CreateHardwareAcceleratedCanvas(null, GRContext, e.BackendRenderTarget.Width, e.BackendRenderTarget.Height);\r\n                }\r\n\r\n                //Application.Draw(canvas);\r\n\r\n                canvas.Flush();\r\n                canvas.DrawToCanvas(e.Surface.Canvas, 0, 0);\r\n            }\r\n        }\r\n\r\n        public void OnTouch()\r\n        {\r\n            //if (Application?.Content != null)\r\n            //{\r\n            //    Application.Content.OnTouch(multiTouch);\r\n            //}\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\nand this is my SKCanvasExtensions\r\n\r\n\u0060\u0060\u0060cs\r\nusing System;\r\nusing SkiaSharp;\r\n\r\nnamespace Xamarin_DAW.Skia_UI_Kit\r\n{\r\n\tpublic static class SKCanvasExtensions\r\n\t{\r\n\t\t/// \u003Csummary\u003EReturns true if this canvas is Hardware Accelerated.\u003C/summary\u003E\r\n\t\tpublic static bool isHardwareAccelerated(this SKCanvas this_canvas)\r\n\t\t{\r\n\t\t\treturn (bool)this_canvas.ExtensionProperties_GetValue(\u0022HardwareAccelerated\u0022, false);\r\n\t\t}\r\n\r\n\t\t/// \u003Csummary\u003ECreates a Hardware Accelerated canvas.\u003C/summary\u003E\r\n\t\tpublic static SKCanvas CreateHardwareAcceleratedCanvas(this SKCanvas this_canvas, GRContext context, int width, int height)\r\n\t\t{\r\n\t\t\tSKSurface s = SKSurface.Create(context, false, new SKImageInfo(width, height));\r\n\t\t\tSKCanvas c = s.Canvas;\r\n\t\t\tc.ExtensionProperties_SetValue(\u0022GRContext\u0022, context);\r\n\t\t\tc.ExtensionProperties_SetValue(\u0022Width\u0022, width);\r\n\t\t\tc.ExtensionProperties_SetValue(\u0022Height\u0022, height);\r\n\t\t\tc.ExtensionProperties_SetValue(\u0022Surface\u0022, s);\r\n\t\t\tc.ExtensionProperties_SetValue(\u0022HardwareAccelerated\u0022, true);\r\n\t\t\treturn c;\r\n\t\t}\r\n\r\n\t\t// ...\r\n\t}\r\n}\r\n\u0060\u0060\u0060",
  "author": {
    "login": "mgood7123",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-03-08T08:04:34",
  "updatedAt": "2022-08-19T00:01:54",
  "closedAt": "2022-03-08T09:28:14",
  "commentCount": 1,
  "reactionCount": 0
}