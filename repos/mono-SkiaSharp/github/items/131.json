{
  "number": 131,
  "type": "issue",
  "state": "closed",
  "title": "NullReferenceException in SKCodec.Create()",
  "body": "With SkiaSharp HEAD, I am trying to create an \u0060SKBitmap\u0060 from a \u0060System.Drawing.Bitmap\u0060 instance like this:\n\n\u0060\u0060\u0060\npublic static SKBitmap SKBitmapFromBitmap(System.Drawing.Bitmap bitmap) {\n    using (System.IO.MemoryStream memstr = new System.IO.MemoryStream()) {\n        bitmap.Save(memstr, bitmap.RawFormat);\n        using (var s = new SKManagedStream(memstr)) {\n            using (var codec = SKCodec.Create(s)) {\n                var info = codec.Info;\n                var skbitmap = new SKBitmap(info.Width, info.Height, SKImageInfo.PlatformColorType, info.IsOpaque ? SKAlphaType.Opaque : SKAlphaType.Premul);\n                IntPtr length;\n                var result = codec.GetPixels(skbitmap.Info, skbitmap.GetPixels(out length));\n                if (result == SKCodecResult.Success) {\n                    return skbitmap;\n                } else {\n                    throw new ArgumentException();\n                }\n            }\n        }\n    }\n}\n\u0060\u0060\u0060\n\nBut during the \u0060SKCodec.Create(s)\u0060 call I am getting a NullReferenceException at SKCodec.cs [line 142](https://github.com/mono/SkiaSharp/blob/master/binding/Binding/SKCodec.cs#L142). Stepping through in the debugger, it appears \u0060GetObject\u003CSKCodec\u003E(...)\u0060 is returning null. Note that \u0060stream.Handle\u0060 is 0, presumably because it\u0027s a managed stream.\n\nAm I doing something wrong in creating the SKBitmap? I\u0027m basing my code off of the sample code [BitmapDecoder](https://github.com/mono/SkiaSharp/blob/master/samples/SharedDemo/SkiaSharp.Demos.cs#L499).\n",
  "author": {
    "login": "tdenniston",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "1.53.1",
  "createdAt": "2016-08-10T16:39:09",
  "updatedAt": "2022-08-20T00:02:22",
  "closedAt": "2016-08-11T16:32:05",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:53:40.2667406Z",
    "reactions": [],
    "comments": [
      {
        "id": 239115917,
        "author": "mattleibow",
        "body": "@tdenniston Thanks for creating an issue. There is no real problem with your code except that you are reading a stream when the position is already at the end (after the \u0060bitmap.Save\u0060 operation).\nTo fix this, just flush and rewind:\n\n\u0060\u0060\u0060 csharp\n// ...\nbitmap.Save(memstr, bitmap.RawFormat);\n// rewind the stream\nmemstr.Flush();\nmemstr.Position = 0;\n// ...\n\u0060\u0060\u0060\n\nWhat is happening is that you are saving, and when the codec tries to read it, it is unable to get data since there is no more data after the current position. As a result, the codec is returned as \u0060null\u0060. Internally we assume it will never be \u0060null\u0060 (which is wrong), and thus the \u0060NullReferenceException\u0060.\n\n\u0060stream.Handle\u0060 is \u00600\u0060 due to the fact that the \u0060SKCodec\u0060 takes ownership of the stream in native code and then disposes and releases the memory. As a result, the handle is \u00600\u0060 or \u0060NULL\u0060.\n\nI have made a small change in our code to prevent an exception, and it should just return \u0060null\u0060 as expected. However, the correct way to use these types is to first rewind the **\u0060MemoryStream\u0060**. \u0060SKManagedStream\u0060 will always have its own start at the position of the provided stream.\n",
        "createdAt": "2016-08-11T09:41:40",
        "reactions": []
      },
      {
        "id": 239124524,
        "author": "mattleibow",
        "body": "Improved the ownership management: https://github.com/mono/SkiaSharp/commit/8239f1670e1f733167e853ab1900f97629a7cdc5\n",
        "createdAt": "2016-08-11T10:26:18",
        "reactions": []
      },
      {
        "id": 239180633,
        "author": "tdenniston",
        "body": "Confirmed that adding the \u0060Flush()\u0060 and \u0060Position = 0\u0060 fixes my issue. Thanks for responding so quickly!\n",
        "createdAt": "2016-08-11T14:38:43",
        "reactions": []
      }
    ]
  }
}