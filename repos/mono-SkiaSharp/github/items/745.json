{
  "number": 745,
  "type": "issue",
  "state": "closed",
  "title": "GPU-accelerated WPF without WindowsFormsHost",
  "body": "After reading through many issues mentioning the drawbacks of \u0060WindowsFormsHost\u0060 (no transparency, no event bubbling, no borderless windows), I\u0027ve tried to implement another approach: Do the expensive computing off-screen and copy the result into a (non-GPU-accelerated) \u0060SKElement\u0060.\r\n\r\nAs @mattleibow mentioned in #717, the unit tests\u0027 \u0060WglContext\u0060 should be able to deliver a GPU-accelerated off-screen context. \r\n\r\nMy main view with \u0060SKElement\u0060:\r\n\r\n\u0060\u0060\u0060xaml\r\n\u003CWindow x:Class=\u0022WPF.MainWindow\u0022\r\n        xmlns=\u0022http://schemas.microsoft.com/winfx/2006/xaml/presentation\u0022\r\n        xmlns:x=\u0022http://schemas.microsoft.com/winfx/2006/xaml\u0022\r\n        xmlns:d=\u0022http://schemas.microsoft.com/expression/blend/2008\u0022\r\n        xmlns:mc=\u0022http://schemas.openxmlformats.org/markup-compatibility/2006\u0022\r\n        xmlns:wpf=\u0022clr-namespace:SkiaSharp.Views.WPF;assembly=SkiaSharp.Views.WPF\u0022\r\n        mc:Ignorable=\u0022d\u0022\r\n        Title=\u0022MainWindow\u0022 Height=\u0022450\u0022 Width=\u0022800\u0022\u003E\r\n    \u003CGrid HorizontalAlignment=\u0022Stretch\u0022 VerticalAlignment=\u0022Stretch\u0022\u003E\r\n        \u003Cwpf:SKElement x:Name=\u0022BitmapHost\u0022 PaintSurface=\u0022OnPaintCanvas\u0022 /\u003E\r\n    \u003C/Grid\u003E\r\n\u003C/Window\u003E\r\n\u0060\u0060\u0060\r\nCode behind:\r\n\r\n\u0060\u0060\u0060c#\r\npublic partial class MainWindow : Window\r\n{\r\n\tprivate SKSurface _surface;\r\n\tprivate GRContext _grContext;\r\n\tprivate SKSize _screenCanvasSize;\r\n\r\n\tpublic MainWindow()\r\n\t{\r\n\t\tInitializeComponent();\r\n\r\n\t\tvar glContext = new WglContext();\r\n\t\tglContext.MakeCurrent();\r\n\t}\r\n\r\n\tprivate void OnPaintCanvas(object sender, SKPaintSurfaceEventArgs e)\r\n\t{\r\n\t\tOnPaintSurface(e.Surface.Canvas, e.Info.Width, e.Info.Height);\r\n\t}\r\n\r\n\tprivate void OnPaintSurface(SKCanvas canvas, int width, int height)\r\n\t{\r\n\t\tvar canvasSize = new SKSize(width, height);\r\n\r\n\t\t// check if we need to recreate the off-screen surface\r\n\t\tif (_screenCanvasSize != canvasSize) {\r\n\t\t\t_surface?.Dispose();\r\n\t\t\t_grContext?.Dispose();\r\n\t\t\t_grContext = GRContext.Create(GRBackend.OpenGL);\r\n\t\t\t_surface = SKSurface.Create(_grContext, true, new SKImageInfo(width, height));\r\n\t\t\t_screenCanvasSize = canvasSize;\r\n\t\t}\r\n\r\n\t\t// draw onto off-screen gl context\r\n\t\tDrawOffscreen(_surface.Canvas, width, height);\r\n\r\n\t\t// draw offscreen surface onto screen\r\n\t\tcanvas.DrawSurface(_surface, new SKPoint(0f, 0f));\r\n\t}\r\n\r\n\tprivate void DrawOffscreen(SKCanvas canvas, int width, int height)\r\n\t{\r\n\t\t// will be more expensive in the real world\r\n\t\tusing (var paint = new SKPaint()) {\r\n\t\t\tpaint.TextSize = 64.0f;\r\n\t\t\tpaint.IsAntialias = true;\r\n\t\t\tpaint.Color = 0xFF4281A4;\r\n\t\t\tpaint.IsStroke = false;\r\n\t\t\tcanvas.DrawText(\u0022SkiaSharp\u0022, width / 2f, 64.0f, paint);\r\n\t\t}\r\n\t}\r\n}\r\n\u0060\u0060\u0060\r\nThe \u0060WglContext\u0060 class is copied from this repo\u0027s test directory.\r\n\r\nThe problem I\u0027m having is when running this, I\u0027m getting first this:\r\n\r\n\u003E Managed Debugging Assistant \u0027CallbackOnCollectedDelegate\u0027 : \u0027A callback was made on a garbage collected delegate of type \u0027WPF!SkiaSharp.Tests.WNDPROC::Invoke\u0027. This may cause application crashes, corruption and data loss. When passing delegates to unmanaged code, they must be kept alive by the managed application until it is guaranteed that they will never be called.\u0027\r\n\r\nThis is followed by a \u0060System.NullReferenceException\u0060 without any stack trace. So it\u0027s somewhere in a native call, but I can\u0027t figure out where. Any hints or suggestions would be appreciated!\r\n\r\nI\u0027ve created a repo to reproduce: [freezy/wpf-skia-opengl](https://github.com/freezy/wpf-skia-opengl).\r\n\r\nRelated: #213, #622, #688\n\n\u003E VS bug [#776804](https://devdiv.visualstudio.com/DevDiv/_workitems/edit/776804)",
  "author": {
    "login": "freezy",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/enhancement",
      "color": "84b6eb"
    },
    {
      "name": "os/Windows-Classic",
      "color": "fbca04"
    },
    {
      "name": "area/SkiaSharp.Views",
      "color": "0052cc"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    },
    {
      "name": "type/feature-request",
      "color": "ededed"
    }
  ],
  "assignees": [
    {
      "login": "mattleibow",
      "type": "User"
    }
  ],
  "createdAt": "2018-12-30T13:50:13",
  "updatedAt": "2024-03-28T14:11:24",
  "closedAt": "2024-03-28T14:11:23",
  "commentCount": 41,
  "reactionCount": 5,
  "engagement": {
    "syncedAt": "2026-02-06T12:55:45.6225869Z",
    "reactions": [
      {
        "user": "charlesroddie",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:55:45.6225913Z"
      },
      {
        "user": "MichaelRumpler",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:55:45.6225919Z"
      },
      {
        "user": "mgnslndh",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:55:45.6225921Z"
      },
      {
        "user": "pauldendulk",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:55:45.6225923Z"
      },
      {
        "user": "DlbSt",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:55:45.6225925Z"
      }
    ],
    "comments": [
      {
        "id": 450569287,
        "author": "freezy",
        "body": "Okay, after some more debugging, I figured out what caused the \u0060NullReferenceException\u0060: The \u0060WNDCLASS\u0060 instance was garbage collected when it shouldn\u0027t, [moving it to a static property](https://github.com/freezy/wpf-skia-opengl/commit/4a800e1340a6ac466bda42c91dc04df705308f9e) solved it.\r\n\r\nHowever, when closing the window, I\u0027m now getting an \u0060System.AccessViolationException\u0060, again within some native code:\r\n\r\n\u0060\u0060\u0060\r\nSystem.AccessViolationException\r\n  HResult=0x80004003\r\n  Message=Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\n  Source=\u003CCannot evaluate the exception source\u003E\r\n  StackTrace:\r\n\u003CCannot evaluate the exception stack trace\u003E\r\n\u0060\u0060\u0060\r\n\r\nIf anyone could shed some light on that, that would be great. I\u0027ve updated the sample repo, just launch it and close the window to reproduce.",
        "createdAt": "2018-12-30T15:51:29",
        "reactions": []
      },
      {
        "id": 450569855,
        "author": "freezy",
        "body": "Turns out that \u0060Unloaded\u0060 for disposal is too late, \u0060Closing\u0060 seems to do the trick.\r\n\r\n@mattleibow if you think that SkiaSharp would benefit from a WPF view implementing this approach, let me know, otherwise feel free to close!",
        "createdAt": "2018-12-30T16:01:10",
        "reactions": [
          {
            "user": "mgnslndh",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:37.849884Z"
          },
          {
            "user": "BigBadaboom",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:37.8498845Z"
          },
          {
            "user": "romen-h",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:37.8498846Z"
          }
        ]
      },
      {
        "id": 457051615,
        "author": "mattleibow",
        "body": "Also related #764 and #755 \r\n\r\nWith regards to drawing offscreen for WPF - this seems like a good way (you only pay for the final draw). I may hook some things up.\r\n\r\nI am going to leave this open as a feature request so we can track/prioritize this.",
        "createdAt": "2019-01-24T03:16:39",
        "reactions": [
          {
            "user": "mgnslndh",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:38.0923581Z"
          },
          {
            "user": "beachwalker",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:38.0923585Z"
          },
          {
            "user": "AnarchyMob",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:38.0923586Z"
          }
        ]
      },
      {
        "id": 556369337,
        "author": "mattleibow",
        "body": "From @Mikolaytis in #819:\r\n\r\n\u003E Hi, I\u0027m using SkiaSharp in my WPF app with WGL rendering as described here.\r\n\u003E\r\n\u003E The FPS of this approach is low (all performance is thrown into copy bytes to WritableBitmap), so I\u0027m in search for another solution and found an perfect example, how to render in WPF D3DImage over OpenGL via SharpDX, Angle.\r\n\u003E\r\n\u003E https://github.com/l3m/wpf-gles\r\n\u003E\r\n\u003EPerformance is on another level, but I\u0027m failing to connect this example to SkiaSharp.\r\n\u003E Is this possible at all?\r\n\u003E Did you ever considered this type of approach for WPF apps?\r\n\u003E If this approach will connect to skia - it will be awesome!",
        "createdAt": "2019-11-20T20:43:14",
        "reactions": []
      },
      {
        "id": 556369826,
        "author": "mattleibow",
        "body": "From @Mikolaytis:\r\n\r\n\u003E Here we go! Done: https://github.com/Mikolaytis/WpfSkiaAngleSharpDxOpenTK\r\n\r\n",
        "createdAt": "2019-11-20T20:43:41",
        "reactions": []
      },
      {
        "id": 556370114,
        "author": "mattleibow",
        "body": "From @Mikolaytis:\r\n\r\n\u003E Turns out text/line/etc. draw do not render anything, only images are rendering.\r\n\r\n",
        "createdAt": "2019-11-20T20:43:56",
        "reactions": []
      },
      {
        "id": 556370535,
        "author": "mattleibow",
        "body": "From @john-cullen: \r\n\r\n\u003E @Mikolaytis did you ever get text / lines rendering for this?",
        "createdAt": "2019-11-20T20:44:19",
        "reactions": []
      },
      {
        "id": 556373291,
        "author": "mattleibow",
        "body": "@john-cullen, I can\u0027t be sure at this point, but it might be that the stencil buffers aren\u0027t set up right. I see this is \u00600\u0060: https://github.com/Mikolaytis/WpfSkiaAngleSharpDxOpenTK/blob/f41433c75701519991eb861aa063653293d1781f/src/WpfGlesDemo/SkiaRenderer.cs#L78\r\n\r\nHopefully @Mikolaytis has got a working solution that we can benefit from. \uD83E\uDD1E ",
        "createdAt": "2019-11-20T20:46:42",
        "reactions": []
      },
      {
        "id": 556379483,
        "author": "mattleibow",
        "body": "Just merging some issues and it appears that @freezy has some code in a repo: \r\n\r\n\u003E @ibgorton\u00A0in case you\u0027re still using a CPU-based surface, I\u0027ve created a proof of concept using an accelerated off-screen surface without OpenTK or ANGLE that seems to work well. More info and code\u00A0here: https://github.com/freezy/wpf-skia-opengl. ",
        "createdAt": "2019-11-20T20:52:11",
        "reactions": []
      },
      {
        "id": 556997908,
        "author": "ghost",
        "body": "@mattleibow thanks for responding immediately!\r\n\r\nI have a couple of questions. First of all, I apologise if these are obvious, but I\u0027ve never done any graphics work before now.\r\n\r\nHow does the approach in this issue / the linked repository differ from using a \u0060WriteableBitmap\u0060 as done here https://github.com/8/SkiaSharp-Wpf-Example (which I got to work on dotnetcore). \r\n\r\nDoes being accelerated imply that the rendering to the bitmap buffer is calculated on the graphics card instead of the cpu?\r\n\r\nDoes this translate to noticeably better performance for Skia?\r\n\r\nIf I\u0027m just issuing API calls to Skia, from a development perspective should the experience be transparent? ie, could I develop using the mechanism I\u0027ve got to work and later on switch to an accelerated backend without any change in the Skia code? (obviously I\u0027d expect some change in that code that wires up the bitmap to my WPF control).\r\n\r\nBasically, I\u0027m evaluating a method to create a high performance chart as there does not seem to be an existing general-purpose implementation that both fits our use-case well enough and has the required performance. SkiaSharp seems to be the nicest way to accomplish that on dotnetcore.\r\n\r\nThank you for your time.\r\n\r\nedit: both approaches seem to have about the same performance if I call \u0060InvalidateVisual\u0060  on the bitmaphost in freezy\u0027s example from \u0060CompositionTarget.Rendering\u0060 event.",
        "createdAt": "2019-11-21T09:31:06",
        "reactions": []
      },
      {
        "id": 557217491,
        "author": "Mikolaytis",
        "body": "@mattleibow We are using @freezy approach for a 6 month already. Issue is - we are still using \u0060WriteableBitmap\u0060 to draw canvas on a WPF window. WriteableBitmap is stored in the RAM so - on GPU rendering we are having next pipeline:\r\n1) Rendering surface on GPU\r\n2) Converting surface to bitmap pixels\r\n3) Copying pixels to the Writeablebitmap handle (from GPU to the RAM)\r\n4) WPF will push buffer from RAM to it\u0027s texture buffer on GPU\r\n5) Image will be rendered on a WPF window\r\n\r\n2-4 steps are terrific performance downgrade.\r\n\r\nI want to have next pipeline:\r\n1) Rendering surface on GPU\r\n2) Copying it to the D3DSurface\r\n3) Image will be rendered on a WPF window\r\n\r\nI imagine this pipeline should work at least 10x faster than first one.\r\n\r\nI\u0027ve tried a lot of options over a 6 month and did not found a working solution.\r\nThe best solution I found I posted here: https://github.com/Mikolaytis/WpfSkiaAngleSharpDxOpenTK\r\nAll we need is to try to fix Skia rendering proplems in it.\r\nChanging stencilbuffers options do not help.",
        "createdAt": "2019-11-21T18:39:26",
        "reactions": [
          {
            "user": "Orcomp",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:39.6619051Z"
          },
          {
            "user": "xiejiang2014",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:39.6619056Z"
          },
          {
            "user": "LeoYang06",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:39.6619056Z"
          }
        ]
      },
      {
        "id": 581060597,
        "author": "Mikolaytis",
        "body": "So, the fail of my code was to use Avalonia EGL libs. Today I\u0027ve built angle myself and everything is working. Wow! https://github.com/Mikolaytis/WpfSkiaAngleSharpDxOpenTK - here is an example with updated libs.\r\nNow I will try to integrate this thing into our project. ",
        "createdAt": "2020-02-01T19:15:25",
        "reactions": []
      },
      {
        "id": 581581567,
        "author": "mattleibow",
        "body": "@Mikolaytis Thanks for keeping this thread updated. I just haven\u0027t had the time to work on this. But, due to changes and things, I will be having to build the ANGLE libraries for UWP from source. And, since vcpkg will be doing the work, it seems to be super trivial to get a Win32 version out as well. As a result, I will be including the ANGLE bits in the main Views package.\r\n\r\nWith all this, I will be having a closer look at implementing true native rendering for WPF. I will look at what you have got in that repo and hopefully get something going. I do look forward to the day when we can have a DX view in WPF.\r\n\r\nThanks again for your work.",
        "createdAt": "2020-02-03T19:36:50",
        "reactions": [
          {
            "user": "mgnslndh",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464895Z"
          },
          {
            "user": "Mikolaytis",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.04649Z"
          },
          {
            "user": "tstuts",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464901Z"
          },
          {
            "user": "YoshihiroIto",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464901Z"
          },
          {
            "user": "Jonarw",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464902Z"
          },
          {
            "user": "manishjh",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464903Z"
          },
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464903Z"
          },
          {
            "user": "beachwalker",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0464904Z"
          },
          {
            "user": "HarlanHugh",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0465036Z"
          },
          {
            "user": "xiejiang2014",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0465038Z"
          },
          {
            "user": "SparkieLabs",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0465047Z"
          },
          {
            "user": "AnarchyMob",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.0465048Z"
          }
        ]
      },
      {
        "id": 703217172,
        "author": "Mikolaytis",
        "body": "@mattleibow Maybe let me try to integrate this into \u0060SkiaSharp.Views.WPF\u0060. I can do this in 2-6 hours and make a PR. We are already using my solution for a half of a year in production.\r\n\r\nWhat will be added:\r\n1. \u0060OpenTK\u0060 nuget package 3.2.0 for GLES launch\r\n2. \u0060SharpDX.Direct3D9\u0060 nuget package 4.2.0 for DirectX texture creation\r\n3. 4 dlls prebuilt libs of \u0060Angle\u0060 (2 x64 and 2 x86) latest master - you can make an automatic build from source later.\r\n3. Fallback logic to the CPU rendering if target PC do not have GPU.\r\n4. (optional) Rendering in separate thread - huge perf boost and no UI thread freezes\r\n5. (optional) (will take additional time) We can get rid of SKElement and provide the output as an ImageSource (D3DImage) that can be used as brush or source of an Image Element.\r\n\r\nUnresolved issues that will be added too :)\r\n1. App crash on PC Sleep and other Device Lost events. I did not found a solution yet to solve this issue. Somehow D3dImage are breaking the WPF window rendering and I did not find a way to recover it. I hope maybe someone more experienced in DirectX than me will be able to help us to resolve this someday.",
        "createdAt": "2020-10-04T07:46:30",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.2343448Z"
          },
          {
            "user": "MichaelRumpler",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.2343452Z"
          },
          {
            "user": "AnarchyMob",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.2343453Z"
          },
          {
            "user": "LeoYang06",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:40.2343454Z"
          }
        ]
      },
      {
        "id": 703239843,
        "author": "mattleibow",
        "body": "Sounds like a good plan. I can get ANGLE building very quickly as all the bits are there. I just use VCPKG.\r\n\r\n**EDIT**\r\n\r\nFor step 4, we will need to chat to the Avalonia team. I know they also distribute a custom build of ANGLE, so we need to make sure we work with them to override our version that we distribute. If e are using .targets files, this would be easy because we can just exclude. With the new automatic runtimes folder, I am not sure how to exclude conditionally.\r\n\r\n@Mikolaytis, we can include ANGLE dlls in the \u0060SkiaSharp.Views.WPF\u0060 package, but what happens if we manage to add ANGLE support in WinForms? Also, what happens if you are working on a server and there is no UI... I\u0027m thinking of maybe a new package \u0060SkiaSharp.NativeAssets.ANGLE.Desktop\u0060 or something that WPF can reference. If we add WinForms, then we just add a new dependency. And, if you have no UI, you can just manually pull that in. That was my first thought, let me know what you think.\r\n\r\n@kekekeks might have some words on this.",
        "createdAt": "2020-10-04T11:14:13",
        "reactions": []
      },
      {
        "id": 703241637,
        "author": "mattleibow",
        "body": "Just referencing this issue as it is very much related: https://github.com/mono/SkiaSharp/issues/243",
        "createdAt": "2020-10-04T11:29:42",
        "reactions": []
      },
      {
        "id": 703245337,
        "author": "Mikolaytis",
        "body": "Is Avalonia using \u0060SkiaSharp.Views.WPF\u0060? I think they are using only SkiaSharp itself. So there will be no dll overwrite conflicts because I want to add ANGLE libs only into \u0060SkiaSharp.Views.WPF\u0060.\r\nI don\u0027t think that ANGLE is needed for WinForms because in WinForms you can use openGL without any problem.\r\nAbout separate package for ANGLE libs idea - I\u0027m in, but I have 0 experience with nuget.",
        "createdAt": "2020-10-04T12:01:06",
        "reactions": []
      },
      {
        "id": 703277740,
        "author": "mattleibow",
        "body": "OK, cool. Go ahead with the WPF work, I\u0027ll see what needs to be done with the packages. I\u0027ll try a few things and see what I come up with.\n\nBut, packages are just the final step, no need to look at that right now. ",
        "createdAt": "2020-10-04T16:10:16",
        "reactions": []
      },
      {
        "id": 703448578,
        "author": "kekekeks",
        "body": "I have a somewhat working setup for one of my WPF apps (closed-source, unfortunately) which doesn\u0027t involve OpenTK.\r\n\r\nNote that\r\n1) GPU-\u003ECPU-\u003EGPU is terribly show, FPS will be abysmal\r\n2) For some reason D3DImage is tricky to get right, you either get lost frames or flicker, my current approach is: \u0060glFinish\u0060, lock the image, do the blit, \u0060glFinish\u0060, unlock the image.",
        "createdAt": "2020-10-05T07:17:24",
        "reactions": []
      },
      {
        "id": 703449353,
        "author": "kekekeks",
        "body": "Regarding ANGLE binaries, for now you can use ones [packaged for Avalonia](https://www.nuget.org/packages/Avalonia.Angle.Windows.Natives/), they generally work well",
        "createdAt": "2020-10-05T07:18:52",
        "reactions": []
      },
      {
        "id": 704145483,
        "author": "Mikolaytis",
        "body": "@kekekeks I\u0027ve solved flickers in my closed source app by using 2 surfaces. 1 surface(just a background surface) to draw everything, and in the end just DrawSurface() the surface to another surface(that is connected to the ANGLE output).\r\n\r\n2 surfaces will use 2x of memory, but will significantly reduce the lock state time amounth of the D3DImage.\r\n\r\npipeline:\r\n1) draw to the 1 surface in another thread (Render thread)\r\n2) drawSurface to second surface (Render thread)\r\n3) secondSurface.Flush() or GrContext.Flush() (Render thread)\r\n4) GL.Finish or GL.FLush (can be invoked in any thread with MakeCurrent before call)\r\n5) trylock, setdirty and unlock image in (ui thread)",
        "createdAt": "2020-10-06T09:24:17",
        "reactions": []
      },
      {
        "id": 704160410,
        "author": "Mikolaytis",
        "body": "@kekekeks did you handle DEVICE_LOST in your closed source WPF app? If so can you provide any useful article in the web that can guide me in the right direction?",
        "createdAt": "2020-10-06T09:52:32",
        "reactions": []
      },
      {
        "id": 787563752,
        "author": "enissimsek",
        "body": "OpenTK [GLWpfControl](https://github.com/opentk/GLWpfControl) is (almost) a drop-in replacement for its WinForms counterpart GLControl. So, I used it to port SKGLcontrol to WPF (a SKWpfGLControl, if you will) and it seems to work in my limited testing with GPU support, no flickering etc.\r\n\r\nMy use-case is fairly limited to just some background, lines and text so please let me know if I am missing anything or if there is a reason that this is not a good solution.\r\n\r\n\r\n",
        "createdAt": "2021-03-01T00:45:28",
        "reactions": []
      },
      {
        "id": 788646679,
        "author": "xiejiang2014",
        "body": "\u003E OpenTK [GLWpfControl](https://github.com/opentk/GLWpfControl) is (almost) a drop-in replacement for its WinForms counterpart GLControl. So, I used it to port SKGLcontrol to WPF (a SKWpfGLControl, if you will) and it seems to work in my limited testing with GPU support, no flickering etc.\r\n\u003E \r\n\u003E My use-case is fairly limited to just some background, lines and text so please let me know if I am missing anything or if there is a reason that this is not a good solution.\r\n\r\ncool\uFF01 may i try it\uFF1F",
        "createdAt": "2021-03-02T06:18:24",
        "reactions": []
      },
      {
        "id": 789202749,
        "author": "enissimsek",
        "body": "\u003E cool\uFF01 may i try it\uFF1F\r\n\r\nHere is  a small example that compares to SKElement:\r\n[SKGLWpfControlExample.zip](https://github.com/mono/SkiaSharp/files/6071687/SKGLWpfControlExample.zip)\r\n",
        "createdAt": "2021-03-02T20:44:02",
        "reactions": []
      },
      {
        "id": 791936080,
        "author": "xiejiang2014",
        "body": "\u003E \u003E cool\uFF01 may i try it\uFF1F\r\n\u003E \r\n\u003E Here is a small example that compares to SKElement:\r\n\u003E [SKGLWpfControlExample.zip](https://github.com/mono/SkiaSharp/files/6071687/SKGLWpfControlExample.zip)\r\n\r\nThe program runs normally. \r\nThere are no errors when the computer wakes up or changes the monitor resolution.\r\nIt looks like the problem is solved perfectly?\r\nTest with rtx 2070",
        "createdAt": "2021-03-06T13:11:12",
        "reactions": []
      },
      {
        "id": 805199563,
        "author": "dedmen",
        "body": "@enissimsek Thanks alot! It works just beautifully.\r\nI\u0027m using this with MapsUI and I can finally run in full screen with very smooth fps instead of like.. 0.2fps before.\r\n\r\nHere is a before and after comparison video:\r\nhttps://www.youtube.com/watch?v=_DyyLLqbS34\r\n\r\nBut it does have some problems, it doesn\u0027t really seem to like rendering two dock windows (AvalonDock) it gets confused.\r\n![firefox_2021-03-23_20-32-23](https://user-images.githubusercontent.com/3768165/112207870-f6578780-8c17-11eb-8f2a-e5837782016b.png)\r\nSome elements suddenly stop showing up, swapping back and forth when zooming.\r\nWhen I hide my grid element (basically just rendering a bunch of lines) it partially comes back, but other things bug out.\r\n\r\nDefinitely related to GL, if I swap back to SKElement it renders normally again.\r\nI\u0027m using one SKGLWpfControl per window, and it messes up pretty badly.\r\nIf I use SKElement for both it works fine.\r\nHacky workaround, use SKGLWpfControl for the first Map window, and SKElement for all further created Map windows.\r\nWorks nicely too, but of course is missing the performance improvement on the second window.\r\n\r\nhttps://github.com/WolfCorps/TacControl/commit/a90164a9e6c1dc91091d55982270a42f4d46d338\r\nHere is my code, didn\u0027t make any changes to SKGLWpfControl itself. I assume the issue is inside OpenTK.GLWpfControl\r\n\r\n\r\n\r\nEdit: I thought this might be the problem.\r\nhttps://github.com/opentk/GLWpfControl/blob/0e657c1033944fbc6b6e7fc53694a7aae139dadc/src/GLWpfControl/DXGLContext.cs#L115\r\nIt shares the same context, for both windows, which it seems like it shouldn\u0027t.\r\nBut even using \u0060mainSettings.ContextToUse\u0060 to select seperate context for both windows, doesn\u0027t help.\r\n\r\nChanging the code to manually get the correct window handle via \u0060Application.Current.Windows\u0060, also not better.\r\nTwo contexts in two seperate windows will confuse eachother.\r\nOut of ideas at this point, but I also don\u0027t really know GL nor any of this code.",
        "createdAt": "2021-03-23T20:03:32",
        "reactions": []
      },
      {
        "id": 810223730,
        "author": "enissimsek",
        "body": "I don\u2019t have the expertise in this area to offer deeper insight but I knew it is something that needs to be worked around explicitly if you need multiple instances of controls that use GRContext. This may help: [[BUG] Weird crosstalk between multiple canvas when using GPU-accelerated WPF with WindowsFormsHost](https://github.com/mono/SkiaSharp/issues/920)",
        "createdAt": "2021-03-30T13:10:33",
        "reactions": []
      },
      {
        "id": 810778393,
        "author": "SuRGeoNix",
        "body": "Hey guys, just came across this randomly and might have something that could help you out. It seems that you try to resolve the classic airspace wpf issue. The only solution that I\u0027ve found is by creating a transparent forewindow and transfer the overlay contents there. I\u0027ve used the libvlcsharp\u0027s code as a base (I\u0027ve also resolved the issue rendering during the design mode and fullscreen, i will commit my version soon). You can find the libvlcsharp\u0027s code here https://github.com/videolan/libvlcsharp/tree/3.x/src/LibVLCSharp.WPF",
        "createdAt": "2021-03-31T05:38:00",
        "reactions": []
      },
      {
        "id": 827266458,
        "author": "xiejiang2014",
        "body": "\u003E @enissimsek Thanks alot! It works just beautifully.\r\n\u003E I\u0027m using this with MapsUI and I can finally run in full screen with very smooth fps instead of like.. 0.2fps before.\r\n\u003E \r\n\u003E Here is a before and after comparison video:\r\n\u003E https://www.youtube.com/watch?v=_DyyLLqbS34\r\n\u003E \r\n\u003E ....................\r\n\r\nHello, I also encountered the same problem. I have tried various attempts and still have not solved it. Do you have any new progress? Thank you.\r\n\r\nI tried:\r\nModify the source code of GLWpfControl, add the MakeCurrent method to it, and call it in SKGLWpfControl.OnPaintSurface.",
        "createdAt": "2021-04-27T02:24:45",
        "reactions": []
      },
      {
        "id": 953386956,
        "author": "NogginBops",
        "body": "Y\u0027all know that you can open issues in the OpenTK repos and we are likely able to fix the problems you are encountering?\r\nNothing is going to get fixed if the maintainers don\u0027t know about the issues.\r\nI just happened to stumble upon this issue but I would appreciate if you would open an issue in the relevant OpenTK repo and we can likely find a working solution.",
        "createdAt": "2021-10-27T23:38:56",
        "reactions": []
      },
      {
        "id": 954777721,
        "author": "dedmen",
        "body": "My repro is very dependent on Mapsui/SkiaSharp/AvalonDock, I have no repro with GLWpfControl itself, without SkiaSharp.\r\nSo not sure where that belongs, but I made a ticket now https://github.com/opentk/GLWpfControl/issues/58\r\nBut I don\u0027t know how useful it is without a easy repro without tons of extra stuff.\r\nIf anyone has a more simpler repro then please put it in there.\r\n\r\n",
        "createdAt": "2021-10-29T14:11:44",
        "reactions": [
          {
            "user": "NogginBops",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:55:43.8115104Z"
          }
        ]
      },
      {
        "id": 981867872,
        "author": "gmurray81",
        "body": "Is it just me or is there no way to make \u0060GLWPFControl\u0060 use a transparent background? IMO it doesn\u0027t really solve any airspace issues without being able to do that....",
        "createdAt": "2021-11-29T17:46:53",
        "reactions": []
      },
      {
        "id": 1179501922,
        "author": "mgood7123",
        "body": "im not exactly sure this is trying to achieve but if you want a GPU accelerated off-screen surface\r\n\r\nthen why not create a new GL thread with Gr* api\u0027s to create GL context in the new thread, and then obtain a SKSurface and draw to it\u0027s Canvas ?",
        "createdAt": "2022-07-09T08:15:45",
        "reactions": []
      },
      {
        "id": 1179502057,
        "author": "mgood7123",
        "body": "or might you be trying to create a \u0060Render Thread\u0060 (in which the thread is an off-screen GL render loop consisting of a draw callback) ?",
        "createdAt": "2022-07-09T08:17:04",
        "reactions": []
      },
      {
        "id": 1248879185,
        "author": "gmurray81",
        "body": "Please consider this for soon @mattleibow would be super useful!",
        "createdAt": "2022-09-16T03:30:31",
        "reactions": []
      },
      {
        "id": 1332410828,
        "author": "gmurray81",
        "body": "I\u0027ve attempted to add a GL element for WPF that utilizes OpenTK\u0027s GL WPF control here: https://github.com/mono/SkiaSharp/pull/2317",
        "createdAt": "2022-11-30T16:14:48",
        "reactions": []
      },
      {
        "id": 1332412140,
        "author": "gmurray81",
        "body": "seems to work ok for me, even in cross-talk scenarios (multiple elements on same thread) after I started resetting the Graphics context before painting",
        "createdAt": "2022-11-30T16:15:43",
        "reactions": []
      },
      {
        "id": 1345997911,
        "author": "ghost",
        "body": "Has anyone managed to get performant GL rendering? I\u0027ve tried several options posted on here, and can\u0027t seem to get over 15-30 fps and my render feels sluggish.\n\nI get 300\u002B fps on native WinForms with SKGLControl (for some reason I can\u0027t do this using the FormsHost in WPF)\n\nIs WPF just a bad choice for this?",
        "createdAt": "2022-12-12T07:11:06",
        "reactions": []
      },
      {
        "id": 1645183527,
        "author": "VRage",
        "body": "I tried out @freezy solution and it worked good, even over rdp (this is where OpenTk fails).\r\nBut if i try the same solution with a newer version of SkiaSharp (2.88) it fails on \u0060DrawSurface()\u0060: \u0022Exception thrown at 0x00007FFB68F16B4C (libSkiaSharp.dll): 0xC0000005: Access violation reading location 0x0000000000000000.\u0022 . \r\nAny idea how to fix this? @mattleibow @freezy \r\n",
        "createdAt": "2023-07-21T08:08:19",
        "reactions": []
      },
      {
        "id": 1740398241,
        "author": "najak3d",
        "body": "\u003E I tried out @freezy solution and it worked good, even over rdp (this is where OpenTk fails). But if i try the same solution with a newer version of SkiaSharp (2.88) it fails on \u0060DrawSurface()\u0060: \u0022Exception thrown at 0x00007FFB68F16B4C (libSkiaSharp.dll): 0xC0000005: Access violation reading location 0x0000000000000000.\u0022 . Any idea how to fix this? @mattleibow @freezy\r\n\r\nLikewise, I just tried it now with SkiaSharp 2.88.6 - and mine is crashing on the same line of code (DrawSurface), but with this similar error:\r\n\r\nSystem.AccessViolationException: \u0027Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\u0027\r\n\r\nShown here:\r\n![image](https://github.com/mono/SkiaSharp/assets/10914515/66fa8c96-618c-4dfb-8edd-5c362ca99a75)\r\n\r\n\r\nOur project is fine with the \u0022copy back to writeable Bitmap\u0022 performance hit - although a pure GPU solution is way better.  Our main reason for needing a GPU Surface is because we\u0027re using SKSL Shaders that only work on GPU surfaces.\r\n\r\nIt\u0027s working fine for us on Android now (haven\u0027t checked iOS yet), but having big issues on WPF.\r\n\r\nI\u0027ve also dabbled with just trying to get a GPU Surface to copy it\u0027s contents to a CPU-base SKBitmap - no luck here either - same error as above.\r\n\r\nWe would really appreciate seeing ANY GL-based WPF Surface Solution working in the main SkiaSharp.Views package.\r\n\r\n==\r\nI\u0027m going to try the other solutions from above, to see if either of those will work for us now on latest SkiaSharp 2.88.6.\r\n\r\nPing @mattleibow  @freezy ",
        "createdAt": "2023-09-29T06:58:07",
        "reactions": []
      }
    ]
  }
}