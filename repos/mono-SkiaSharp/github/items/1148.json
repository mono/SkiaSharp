{
  "number": 1148,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Seg Fault with SKTypeface.MatchTypeface with Ubuntu",
  "body": "**Description**\r\n\r\nWhen loading a font file from a file/stream in Ubuntu 18.04, it is possible to cause a seg fault in the process and instantly kill it. This is done by calling SKFontManager.MatchTypeface and providing it the loaded SKTypeface from the stream and an SKFontStyle. This code does not fail in Windows (and possibly iOS is okay too).\r\n\r\nThis was reproduced in a pair of VMs, one running Ubuntu 18.04.3 Server and the other via VS Code in 18.04.3 Desktop. I crashed a live server application running in an Ubuntu docker container by exploiting this. The repro below uses the latest 1.68.1.1 SkiaSharp, but the server application is running 1.68.0.\r\n\r\nMy theory is that this is an underlying problem with the Skia library. Their implementation is getting a wire crossed somewhere when given the stream loaded typeface and exploding in the unmanaged code. I\u0027m not sure if there\u0027s anything that can necessarily be done on the SkiaSharp side if this is the case.\r\n\r\n**Code**\r\n\r\nThis can be reproduced with a csproj and a cs file, and by using the easily obtained [Roboto TTF font files](https://fonts.google.com/specimen/Roboto?selection.family=Roboto) downloaded from Google. This code runs x64 in .NET Core 3.1. Place the downloaded TTF files in the same folder as the csproj and Program.cs file. \r\n\r\nCSProj contents:\r\n\u0060\u0060\u0060\r\n\u003CProject Sdk=\u0022Microsoft.NET.Sdk\u0022\u003E\r\n\r\n  \u003CPropertyGroup\u003E\r\n    \u003COutputType\u003EExe\u003C/OutputType\u003E\r\n    \u003CTargetFramework\u003Enetcoreapp3.1\u003C/TargetFramework\u003E\r\n  \u003C/PropertyGroup\u003E\r\n\r\n  \u003CPropertyGroup Condition=\u0022\u0027$(Configuration)|$(Platform)\u0027==\u0027Debug|AnyCPU\u0027\u0022\u003E\r\n    \u003CPlatformTarget\u003Ex64\u003C/PlatformTarget\u003E\r\n  \u003C/PropertyGroup\u003E\r\n\r\n  \u003CItemGroup\u003E\r\n    \u003CNone Remove=\u0022Roboto-Bold.ttf\u0022 /\u003E\r\n    \u003CNone Remove=\u0022Roboto-Regular.ttf\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\r\n  \u003CItemGroup\u003E\r\n    \u003CEmbeddedResource Include=\u0022Roboto-Bold.ttf\u0022 /\u003E\r\n    \u003CEmbeddedResource Include=\u0022Roboto-Regular.ttf\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\r\n  \u003CItemGroup\u003E\r\n    \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00221.68.1.1\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux\u0022 Version=\u00221.68.1.1\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\r\n\u003C/Project\u003E\r\n\u0060\u0060\u0060\r\n\r\nProgram.cs\r\n\u0060\u0060\u0060\r\nusing System;\r\nusing System.IO;\r\nusing System.Linq;\r\nusing System.Reflection;\r\n\r\nnamespace TestFont\r\n{\r\n    class Program\r\n    {\r\n        static void Main(string[] args)\r\n        {\r\n            try\r\n            {\r\n                var fm = SkiaSharp.SKFontManager.Default;\r\n                Console.WriteLine(\u0022Count:\u0022);\r\n                Console.WriteLine(fm.FontFamilyCount);\r\n                /*\r\n                foreach (var s in fm.GetFontFamilies().OrderBy(o =\u003E o)) {\r\n                    Console.WriteLine(s);\r\n                }\r\n                */\r\n\r\n                //Change if you don\u0027t have this.\r\n\t\t\t\tvar matchName = \u0022FreeSans\u0022;\r\n\r\n                Console.WriteLine(\u0022Match 1\u0022);\r\n                var matchNormalFamily = fm.MatchFamily(matchName, SkiaSharp.SKFontStyle.Normal);\r\n                Console.WriteLine(matchNormalFamily.FamilyName);\r\n                Console.WriteLine(\u0022Match 2\u0022);\r\n                var matchBoldFamily = fm.MatchFamily(matchName, SkiaSharp.SKFontStyle.Bold);\r\n                Console.WriteLine(matchBoldFamily.FamilyName);\r\n                Console.WriteLine(\u0022Match 3\u0022);\r\n                var matchBoldTypeface = fm.MatchTypeface(matchNormalFamily, SkiaSharp.SKFontStyle.Bold);\r\n                Console.WriteLine(matchBoldTypeface.FamilyName);\r\n\r\n                Console.WriteLine(\u0022LoadFonts\u0022);\r\n                LoadFonts();\r\n\r\n                matchName = \u0022Roboto\u0022;\r\n\r\n                Console.WriteLine(\u0022Match 4\u0022);\r\n                matchNormalFamily = fm.MatchFamily(matchName, SkiaSharp.SKFontStyle.Normal);\r\n                Console.WriteLine(matchNormalFamily != null ? matchNormalFamily.FamilyName : \u0022null\u0022);\r\n                Console.WriteLine(\u0022Match 5\u0022);\r\n                matchBoldFamily = fm.MatchFamily(matchName, SkiaSharp.SKFontStyle.Bold);\r\n                Console.WriteLine(matchBoldFamily != null ? matchBoldFamily.FamilyName : \u0022null\u0022);\r\n                if (matchNormalFamily != null)\r\n                {\r\n                    Console.WriteLine(\u0022Match 6\u0022);\r\n                    matchBoldTypeface = fm.MatchTypeface(matchNormalFamily, SkiaSharp.SKFontStyle.Bold);\r\n                    Console.WriteLine(matchBoldTypeface != null ? matchBoldTypeface.FamilyName : \u0022null\u0022);\r\n                }\r\n\r\n                Console.WriteLine(\u0022Match 7\u0022);\r\n                matchNormalFamily = fm.MatchFamily(defaultRegular.FamilyName, SkiaSharp.SKFontStyle.Normal);\r\n                Console.WriteLine(matchNormalFamily != null ? matchNormalFamily.FamilyName : \u0022null\u0022);\r\n                Console.WriteLine(\u0022Match 8\u0022);\r\n                matchBoldFamily = fm.MatchFamily(defaultRegular.FamilyName, SkiaSharp.SKFontStyle.Bold);\r\n                Console.WriteLine(matchBoldFamily != null ? matchBoldFamily.FamilyName : \u0022null\u0022);\r\n\r\n                Console.WriteLine(\u0022Match 9\u0022);\r\n                matchBoldTypeface = fm.MatchTypeface(defaultRegular, SkiaSharp.SKFontStyle.Bold);\r\n                Console.WriteLine(matchBoldTypeface != null ? matchBoldTypeface.FamilyName : \u0022null\u0022);\r\n\r\n\t\t\t\tConsole.WriteLine(\u0022End, but you won\u0027t see this.\u0022);\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                Console.WriteLine(ex.ToString());\r\n            }\r\n        }\r\n\r\n        private static SkiaSharp.SKTypeface defaultRegular;\r\n        private static SkiaSharp.SKTypeface defaultBold;\r\n\r\n        private static void LoadFonts()\r\n        {\r\n            try\r\n            {\r\n                var existingFonts = new[] { defaultRegular, defaultBold };\r\n                foreach (var f in existingFonts)\r\n                {\r\n                    f?.Dispose();\r\n                }\r\n\r\n                defaultRegular = SkiaSharp.SKFontManager.Default.CreateTypeface(GetFontStreamFromResource(\u0022Roboto-Regular\u0022));\r\n                defaultBold = SkiaSharp.SKFontManager.Default.CreateTypeface(GetFontStreamFromResource(\u0022Roboto-Bold\u0022));\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                Console.WriteLine($\u0022LoadFonts Error: {ex.Message}\u0022);\r\n            }\r\n        }\r\n        private static Stream GetFontStreamFromResource(string resourceName)\r\n        {\r\n            var fullResourceName = resourceName;\r\n            if (!fullResourceName.StartsWith(\u0022TestFont.\u0022))\r\n            {\r\n                fullResourceName = \u0022TestFont.\u0022 \u002B fullResourceName;\r\n            }\r\n\r\n            fullResourceName \u002B= \u0022.ttf\u0022;\r\n\r\n            using (Stream stream = Assembly.GetExecutingAssembly().GetManifestResourceStream(fullResourceName))\r\n            {\r\n                if (stream == null)\r\n                {\r\n                    Console.WriteLine($\u0022GetFontStreamFromResource cannot find resource {resourceName}.\u0022);\r\n                    return null;\r\n                }\r\n                var fontStream = new MemoryStream();\r\n                stream.CopyTo(fontStream);\r\n                fontStream.Flush();\r\n                fontStream.Position = 0;\r\n                Console.WriteLine($\u0022GetFontStreamFromResource found {resourceName}.\u0022);\r\n                return fontStream;\r\n            }\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nIt is expected that the program is run to completion, but when it reaches \u0022Match 9\u0022, the call to MatchTypeface will cause a seg fault and instantly kill the program.\r\n\r\n**Actual Behavior**\r\n\r\nHere\u0027s the console output:\r\n\u0060\u0060\u0060\r\nCount:\r\n143\r\nMatch 1\r\nFreeSans\r\nMatch 2\r\nFreeSans\r\nMatch 3\r\nFreeSans\r\nLoadFonts\r\nGetFontStreamFromResource found Roboto-Regular.\r\nGetFontStreamFromResource found Roboto-Bold.\r\nMatch 4\r\nnull\r\nMatch 5\r\nnull\r\nMatch 7\r\nnull\r\nMatch 8\r\nnull\r\nMatch 9\r\nThe program \u0027[10036] TestFont.dll\u0027 has exited with code 0 (0x0).\r\n\u0060\u0060\u0060\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.0, 1.68.1.1\r\n- Last known good version:  Unknown\r\n- IDE:  VSCode\r\n- Platform Target Frameworks: \r\n  - Linux:  Ubuntu 18.04.3\r\n",
  "author": {
    "login": "mlptownsend",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "milestone": "v2.88.x Planning",
  "createdAt": "2020-02-19T19:15:38",
  "updatedAt": "2025-07-25T00:26:00",
  "commentCount": 7,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-04T19:50:44.6865647Z",
    "reactions": [
      {
        "user": "handerss-spotfire",
        "content": "eyes",
        "createdAt": "2026-02-04T19:50:44.6865685Z"
      }
    ],
    "comments": [
      {
        "id": 589614027,
        "author": "mattleibow",
        "createdAt": "2020-02-21T11:25:00",
        "reactions": []
      },
      {
        "id": 589616379,
        "author": "mattleibow",
        "createdAt": "2020-02-21T11:32:31",
        "reactions": []
      },
      {
        "id": 589689740,
        "author": "mlptownsend",
        "createdAt": "2020-02-21T15:00:21",
        "reactions": []
      },
      {
        "id": 1493567909,
        "author": "JerryJian",
        "createdAt": "2023-04-03T02:58:19",
        "reactions": []
      },
      {
        "id": 1494350783,
        "author": "mlptownsend",
        "createdAt": "2023-04-03T13:44:28",
        "reactions": []
      },
      {
        "id": 2237202704,
        "author": "furness-io",
        "createdAt": "2024-07-18T18:13:38",
        "reactions": []
      },
      {
        "id": 3115109431,
        "author": "superbonaci",
        "createdAt": "2025-07-24T22:01:24",
        "reactions": []
      }
    ]
  }
}