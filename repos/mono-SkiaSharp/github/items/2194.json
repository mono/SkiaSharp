{
  "number": 2194,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] AccessViolationException in finalizer thread",
  "body": "**Description**\r\n\r\nAfter upgrading from v2.80.4-preview.9 to v2.88.0, I am now getting an uncatchable \u0060AccessViolationException\u0060 in the finalizer thread, as described in the comment to #1817.\r\n\r\n**Code**\r\n\r\nThe code is an ASP.NET MVC 5  application targeting .NET Framework 4.8. It uses QuestPDF v2022.6.3 to generate a PDF file. The only remotely complicated part of the code is for adding rounded corners to an image:\r\n\r\n\u0060\u0060\u0060csharp\r\npublic class RoundedImage : IDynamicComponent\u003Cint\u003E\r\n{\r\n    public RoundedImage([NotNull] string imagePath)\r\n    {\r\n        ImagePath = imagePath;\r\n    }\r\n\r\n    [NotNull]\r\n    public string ImagePath { get; }\r\n\r\n    int IDynamicComponent\u003Cint\u003E.State { get; set; }\r\n\r\n    [NotNull]\r\n    private static SKBitmap LoadImage([NotNull] string imagePath)\r\n    {\r\n        using var stream = File.OpenRead(imagePath);\r\n        return SKBitmap.Decode(stream);\r\n    }\r\n\r\n    private static float CalculateImageHeight([NotNull] string imagePath, float width)\r\n    {\r\n        using var image = LoadImage(imagePath);\r\n        return width * image.Height / image.Width;\r\n    }\r\n\r\n    /// \u003Cinheritdoc /\u003E\r\n    public DynamicComponentComposeResult Compose(DynamicContext context)\r\n    {\r\n        string imagePath = ImagePath;\r\n        if (string.IsNullOrEmpty(imagePath) || !File.Exists(imagePath))\r\n        {\r\n            return new();\r\n        }\r\n\r\n        var content = context.CreateElement(container =\u003E\r\n        {\r\n            var width = context.AvailableSize.Width;\r\n            var imageHeight = CalculateImageHeight(imagePath, width);\r\n\r\n            container.MaxHeight(imageHeight).Canvas((canvas, size) =\u003E\r\n            {\r\n                canvas.Save();\r\n                var canvasRect = SKRect.Create(0, 0, size.Width, size.Height);\r\n                using SKPath path = new();\r\n                path.AddRoundRect(canvasRect, 15f, 15f);\r\n                canvas.ClipPath(path, antialias: true);\r\n                using var image = LoadImage(imagePath);\r\n                var imageRect = SKRect.Create(0, 0, image.Width, image.Height);\r\n                canvas.DrawBitmap(image, imageRect, canvasRect);\r\n                canvas.Restore();\r\n            });\r\n        });\r\n\r\n        return new() { Content = content };\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThe code works as expected, and the PDF is generated correctly.\r\n\r\n**Expected Behavior**\r\n\r\nNo exception should be thrown in the finalizer thread.\r\n\r\n**Actual Behavior**\r\n\r\nAn uncatchable exception is thrown in the finalizer thread.\r\n\r\n\u0060\u0060\u0060\r\nApplication: w3wp.exe\r\nFramework Version: v4.0.30319\r\nDescription: The process was terminated due to an unhandled exception.\r\nException Info: System.AccessViolationException\r\n   at SkiaSharp.Internals.PlatformLock\u002BNonAlertableWin32Lock.EnterCriticalSection(IntPtr)\r\n   at SkiaSharp.Internals.PlatformLock\u002BNonAlertableWin32Lock.EnterWriteLock()\r\n   at SkiaSharp.HandleDictionary.DeregisterHandle(IntPtr, SkiaSharp.SKObject)\r\n   at SkiaSharp.SKObject.DeregisterHandle(IntPtr, SkiaSharp.SKObject)\r\n   at SkiaSharp.SKObject.set_Handle(IntPtr)\r\n   at SkiaSharp.SKNativeObject.Dispose(Boolean)\r\n   at SkiaSharp.SKNativeObject.Finalize()\r\n\u0060\u0060\u0060\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.0\r\n- Last known good version: v2.80.4-preview.9\r\n- IDE:  Visual Studio 2022\r\n- Platform Target Frameworks:\r\n  - Windows Classic:  Windows 11\r\n  \r\n\u003Cdetails\u003E\r\n  \u003Csummary\u003EDetailed IDE/OS information (click to expand)\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\n\r\nMicrosoft Visual Studio Professional 2022\r\nVersion 17.2.6\r\nVisualStudio.17.Release/17.2.6\u002B32630.192\r\nMicrosoft .NET Framework\r\nVersion 4.8.04161\r\n\r\nInstalled Version: Professional\r\n\r\n.NET Core Debugging with WSL   1.0\r\n.NET Core Debugging with WSL\r\n\r\nADL Tools Service Provider   1.0\r\nThis package contains services used by Data Lake tools\r\n\r\nASA Service Provider   1.0\r\n\r\nASP.NET and Web Tools 2019   17.2.393.26812\r\nASP.NET and Web Tools 2019\r\n\r\nASP.NET Web Frameworks and Tools 2012   17.2.393.26812\r\nFor additional information, visit https://www.asp.net/\r\n\r\nAzure App Service Tools v3.0.0   17.2.393.26812\r\nAzure App Service Tools v3.0.0\r\n\r\nAzure Data Lake Tools for Visual Studio   2.6.5000.0\r\nMicrosoft Azure Data Lake Tools for Visual Studio\r\n\r\nAzure Functions and Web Jobs Tools   17.2.393.26812\r\nAzure Functions and Web Jobs Tools\r\n\r\nAzure Stream Analytics Tools for Visual Studio   2.6.5000.0\r\nMicrosoft Azure Stream Analytics Tools for Visual Studio\r\n\r\nBundler \u0026 Minifier   2.9.3\r\nAdds support for bundling and minifying JavaScript, CSS and HTML files in any project.\r\n\r\nC# Tools   4.2.0-4.22281.5\u002B8d3180e5f00d42f0f0295165f756f368f0cbfa44\r\nC# components used in the IDE. Depending on your project type and settings, a different version of the compiler may be used.\r\n\r\nCommon Azure Tools   1.10\r\nProvides common services for use by Azure Mobile Services and Microsoft Azure Tools.\r\n\r\nDotfuscator Community Edition   6.5.0\u002B76d4669002\r\nPreEmptive Protection - Dotfuscator CE\r\n\r\nExtensibility Message Bus   1.2.6 (master@34d6af2)\r\nProvides common messaging-based MEF services for loosely coupled Visual Studio extension components communication and integration.\r\n\r\nFile Icons   2.7\r\nAdds icons for files that are not recognized by Solution Explorer\r\n\r\nGhostDoc   22.2.22190.0\r\nGenerate XML Comments from your code, maintain clean and up-to-date documentation, produce help documentation in multiple formats, use intelligent source code Spell Checker in Visual Studio.\r\n\r\nMicrosoft Azure Hive Query Language Service   2.6.5000.0\r\nLanguage service for Hive query\r\n\r\nMicrosoft Azure Stream Analytics Language Service   2.6.5000.0\r\nLanguage service for Azure Stream Analytics\r\n\r\nMicrosoft Azure Tools for Visual Studio   2.9\r\nSupport for Azure Cloud Services projects\r\n\r\nMicrosoft JVM Debugger   1.0\r\nProvides support for connecting the Visual Studio debugger to JDWP compatible Java Virtual Machines\r\n\r\nMono Debugging for Visual Studio   17.2.20 (482eb2a)\r\nSupport for debugging Mono processes with Visual Studio.\r\n\r\nNuGet Package Manager   6.2.1\r\nNuGet Package Manager in Visual Studio. For more information about NuGet, visit https://docs.nuget.org/\r\n\r\nRazor (ASP.NET Core)   17.0.0.2218101\u002B885a343b00bcab620a90c1550c37dafd730ce984\r\nProvides languages services for ASP.NET Core Razor.\r\n\r\nSandcastle Help File Builder   SHFB\r\nVisual Studio integration for the Sandcastle Help File Builder.\r\nhttps://GitHub.com/EWSoftware/SHFB\r\n\r\nSQL Server Data Tools   17.0.62204.01010\r\nMicrosoft SQL Server Data Tools\r\n\r\nSyntax Visualizer   1.0\r\nAn extension for visualizing Roslyn SyntaxTrees.\r\n\r\nToolWindowHostedEditor   1.0\r\nHosting json editor into a tool window\r\n\r\nTypeScript Tools   17.0.10418.2001\r\nTypeScript Tools for Microsoft Visual Studio\r\n\r\nVisual Basic Tools   4.2.0-4.22281.5\u002B8d3180e5f00d42f0f0295165f756f368f0cbfa44\r\nVisual Basic components used in the IDE. Depending on your project type and settings, a different version of the compiler may be used.\r\n\r\nVisual F# Tools   17.1.0-beta.22329.1\u002B702b8e77f5fbfe21e6743324c1750503e02f182d\r\nMicrosoft Visual F# Tools\r\n\r\nVisual Studio IntelliCode   2.2\r\nAI-assisted development for Visual Studio.\r\n\r\nVisualStudio.DeviceLog   1.0\r\nInformation about my package\r\n\r\nVisualStudio.Mac   1.0\r\nMac Extension for Visual Studio\r\n\r\nWeb Compiler   1.14.8\r\nCompiler for LESS, Sass and CoffeeScript files\r\n\r\nXamarin   17.2.0.177 (d17-2@2f6c881)\r\nVisual Studio extension to enable development for Xamarin.iOS and Xamarin.Android.\r\n\r\nXamarin Designer   17.2.0.244 (remotes/origin/d17-2@197e1a0b7)\r\nVisual Studio extension to enable Xamarin Designer tools in Visual Studio.\r\n\r\nXamarin Templates   17.2.15 (2e3b60e)\r\nTemplates for building iOS, Android, and Windows apps with Xamarin and Xamarin.Forms.\r\n\r\nXamarin.Android SDK   12.3.3.3 (d17-2/4e061b7)\r\nXamarin.Android Reference Assemblies and MSBuild support.\r\n    Mono: dffa5ab\r\n    Java.Interop: xamarin/java.interop/d17-2@9760f0a9\r\n    ProGuard: Guardsquare/proguard/v7.0.1@912d149\r\n    SQLite: xamarin/sqlite/3.38.2@7b1e016\r\n    Xamarin.Android Tools: xamarin/xamarin-android-tools/d17-2@fc3c2ac\r\n\r\n\r\nXamarin.iOS and Xamarin.Mac SDK   15.10.0.5 (96b3edb6d)\r\nXamarin.iOS and Xamarin.Mac Reference Assemblies and MSBuild support.\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E",
  "author": {
    "login": "RichardD2",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "v2.88.1",
  "createdAt": "2022-08-03T10:37:39",
  "updatedAt": "2022-09-03T12:01:24",
  "closedAt": "2022-08-04T10:57:35",
  "commentCount": 1,
  "reactionCount": 0
}