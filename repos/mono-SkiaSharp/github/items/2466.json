{
  "number": 2466,
  "type": "issue",
  "state": "open",
  "title": "[BUG] SKBitmapImageSource handles non-sRGB bitmaps incorrectly",
  "body": "**Description**\r\n\u0060SKBitmapImageSource\u0060 interprets every non-sRGB bitmaps incorrectly, ie. when \u0060SKBitmap.ColorSpace\u0060 is not \u0060null\u0060, and the color space represents any other color space than sRGB.\r\n\r\nThe issue might be related to the fact that \u0060SKBitmap.GetPixel\u0060 has the same issue, as it\u0027s reported in #2354\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060cs\r\nvar myImageSource = new SKBitmapImageSource { Bitmap = myNonSrgbBitmap };\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nThe visual appearance should be the same, regardless of the color space used in the background.\r\n\r\n**Actual Behavior**\r\n\r\nThe displayed colors are incorrect if the bitmap has another color space. For example, using the linear color space the result appears much darker.\r\n\r\n**Further Details and Platform Specific Issues**\r\n\r\n- SkiaSharp version: 2.88.3\r\n- .NET version: 7.0.302\r\n- Visual Studio version:\r\n  - Visual Studio 2022: 17.6.0\r\n  - Visual Studio for Mac: 17.5 (build 1802)\r\n\r\nThe issue above apparently affects all platforms. Tested on:\r\n- MAUI/Windows 11\r\n- WPF/Windows 11\r\n- MAUI/Andoid\r\n- MAUI/macOS\r\n- MAUI/iOS\r\n\r\nFurther issues, only on specific platforms:\r\n- Android: Argb4444 color type is displayed incorrectly even with sRGB color space\r\n- macOS/iOS: Every color type is displayed incorrectly, except Bgra8888, even with sRGB color space\r\n\r\n**Screenshots**\r\n\r\n\u003Cp align=\u0022center\u0022\u003E\r\n  \u003Cimg alt=\u0022Expected result\u0022 src=\u0022https://github.com/mono/SkiaSharp/assets/27336165/978e55ed-7f16-4fd2-9fae-439db49d29e5\u0022/\u003E\r\n  \u003Cbr/\u003E\u003Cem\u003EExpected result, regardless of color space\u003C/em\u003E\r\n\u003C/p\u003E\r\n\r\n\u003Cp align=\u0022center\u0022\u003E\r\n  \u003Cimg alt=\u0022Linear color space issue\u0022 src=\u0022https://github.com/mono/SkiaSharp/assets/27336165/b2fbfdc0-9d06-4618-83e0-1f7973abb86c\u0022/\u003E\r\n  \u003Cbr/\u003E\u003Cem\u003EUsing linear color space (here Windows 11 but affects all platforms)\u003C/em\u003E\r\n\u003C/p\u003E\r\n\r\n\u003Cp align=\u0022center\u0022\u003E\r\n  \u003Cimg alt=\u0022Android Argb4444 issue\u0022 src=\u0022https://github.com/mono/SkiaSharp/assets/27336165/426814aa-193b-427d-8254-a631283c6e60\u0022/\u003E\r\n  \u003Cbr/\u003E\u003Cem\u003EAndroid specific: Argb4444 color space is wrong even with sRGB color space\u003C/em\u003E\r\n\u003C/p\u003E\r\n\r\n\u003Cp align=\u0022center\u0022\u003E\r\n  \u003Cimg alt=\u0022macOS/iOS issue\u0022 src=\u0022https://github.com/mono/SkiaSharp/assets/27336165/0c445b83-e0d6-4aa3-bfb7-c33f389963f1\u0022/\u003E\r\n  \u003Cbr/\u003E\u003Cem\u003EmacOS/iOS and maybe other non-Windows/Android platforms: only Bgra8888 sRGB is displayed correctly\u003C/em\u003E\r\n\u003C/p\u003E\r\n\r\n**Reproduction Link**\r\n\r\nYou can use [this](https://github.com/koszeggy/KGySoft.Drawing/tree/master/Examples/SkiaSharp_(Maui)) MAUI example application for testing.\r\n\r\n\u003E \u26A0\uFE0F _Important:_ To be able to reproduce the issue you need to comment out the [workaround](https://github.com/koszeggy/KGySoft.Drawing/blob/7e71765998fe31fc8f9a7477c27bf7f473c8b512/Examples/SkiaSharp_(Maui)/ViewModel/MainViewModel.cs#L362) in the view model:\r\n\r\n\u0060\u0060\u0060cs\r\n//// BUG WORKAROUND: SKBitmapImageSource handles SKBitmap incorrectly under a lot of conditions, which are also platform dependent\r\n//// - Everywhere, including Windows: only sRGB color space is displayed correctly so results with linear actual color space must be converted to sRGB\r\n//// - On Android: ColorType.Argb4444 is displayed incorrectly\r\n//// - On Mac/iOS: Everything but Rgba8888/Premul works incorrectly. Actually applying the workaround for all non-Windows/Android systems just for sure.\r\n//else if (result != null \u0026\u0026 (result.ColorSpace?.GammaIsLinear == true\r\n//             || DeviceInfo.Current.Platform == DevicePlatform.Android \u0026\u0026 result.ColorType == SKColorType.Argb4444\r\n//             || !isWindowsOrAndroid \u0026\u0026 (result.ColorType != SKImageInfo.PlatformColorType || result.AlphaType == SKAlphaType.Unpremul)))\r\n//{\r\n//    SKBitmap displayResult = new SKBitmap(result.Info\r\n//        .WithColorType(SKImageInfo.PlatformColorType)\r\n//        .WithAlphaType(SKAlphaType.Premul)\r\n//        .WithColorSpace(SKColorSpace.CreateSrgb()));\r\n\r\n//    using (IReadableBitmapData src = result.GetReadableBitmapData())\r\n//    using (IWritableBitmapData dst = displayResult.GetWritableBitmapData())\r\n//    {\r\n//        await src.CopyToAsync(dst, new System.Drawing.Rectangle(System.Drawing.Point.Empty, src.Size), System.Drawing.Point.Empty,\r\n//            asyncConfig: asyncConfig);\r\n//    }\r\n\r\n//    if (!token.IsCancellationRequested)\r\n//    {\r\n//        result.Dispose();\r\n//        result = displayResult;\r\n//    }\r\n//}\r\n\u0060\u0060\u0060",
  "author": {
    "login": "koszeggy",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-05-23T12:33:19",
  "updatedAt": "2023-05-23T12:33:19",
  "commentCount": 0,
  "reactionCount": 0
}