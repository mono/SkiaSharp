{
  "number": 755,
  "type": "issue",
  "state": "open",
  "title": "\u0022SystemAcesssViolation\u0022 when generating offscreeen bitmaps",
  "body": "This is a follow on from my question #688.  I\u0027m happy to report that we have been successful in generating the GRContexts for both UWP and iOS and with it can create surfaces to generate bitmaps which get supplied as a serve to SKXamlCanvas or SKCanvasView controls.  I have added comments in #688 about further details to help anyone which is interested in doing the same thing.\r\n\r\nThe app using the technology generates complex maps, often with thousands of features in a single bitmap.  The features are built up in layers and come in as tiles.  As tiles arrive, more layers are added to the bitmap, so the generation of the bitmap is like a daisy chain of progressive updates until all the layers have been added in.\r\n\r\nHere is the central method:\r\n![image](https://user-images.githubusercontent.com/1115118/51092996-3a99a280-17d9-11e9-8ff0-9a1f29ce430b.png)\r\n\r\nSo each time tiles arrives, a surface gets created, and its canvas is used to update the latest image through the renderActivity method.  The latest bitmap then gets sent to the control for rendering.  The calls to the Render method happen in a single thread and are sequential.  When the control is heavily used, for instance to when the user is doing a series of quick pans and zooms, occasionally a \u0022SystemAccessViolation exception  occurs - \u0027Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\u0027 \r\n\r\nAdding in the \u0027surface.Dispose()\u0027 call at the end of the method significantly reduces the number of times this occurs.\r\n\r\nIt seems that something is happening in the snapshotting and bitmap creation which doesn\u0027t close things properly.\r\n\r\nI also noticed that combining the results of surfaces is most commonly the situation where the exception arises.  I keep a bitmap of the features as they get built up and another one for markups.  The tiles and the markup information come in at random times, but they are always processed sequentially in the method above.  So a features bitmap is being generated and a markup bitmap is being generated.  At the end I merge the two bitmaps together.  The requests to the method come in via a queue, so I have some sense of what is going on when the exception happens.  If there is the last update to the feature bitmap, followed by a quite update to the markups layers(which happens very quickly with its bitmap being mostly empty), it is during the merge processing of just drawing the features bitmap, followed by the markups bitmap that the exception arises.  It is like the markups bitmap hasn\u0027t closed yet, and I\u0027m trying to render it to a canvas.  Is there any way to test if a bitmap is finished?  Originally I passed back images to the control instead of bitmaps, but that caused these SystemAccessViolation messages almost continually.  Here is the method that merges the bitmaps:\r\n\r\n![image](https://user-images.githubusercontent.com/1115118/51093460-b3e7c400-17de-11e9-8bf5-603ff3f85168.png)\r\n\r\n\r\nI wonder if it has to do with resources?  I create the surfaces simply, without using the constructor that uses budgeting, or sample count.  The documentation doesn\u0027t really explain what these parameters do or how they should be set.  Could it be that the current settings are reusing a buffer somewhere which causes the conflict?  I do everything in usings, so I thought this wouldn\u0027t be a problem.  I also thought that the flush method would finish guarantee that the GPU has all the instructions it needs to generate the updates to the canvas.\r\n\r\nIn the interim, is there someway to be able to recover from the SystemAcessViolation exception?  I\u0027d really prefer not to have to put timers in things to slow everything down.  The whole point was to make things go fast using the GPU (and when it works it goes really fast :-))\r\n\r\nAny insights would be greatly appreciated,\r\nTom Cuthill\n\n\u003E VS bug [#770228](https://devdiv.visualstudio.com/DevDiv/_workitems/edit/770228)",
  "author": {
    "login": "pathw0rk3r",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/question",
      "color": "daffa8"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    }
  ],
  "assignees": [
    {
      "login": "mattleibow",
      "type": "User"
    }
  ],
  "createdAt": "2019-01-14T01:28:36",
  "updatedAt": "2019-06-17T16:50:26",
  "commentCount": 2,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:36:39.2671789Z",
    "reactions": [],
    "comments": [
      {
        "id": 454901505,
        "author": "mattleibow",
        "body": "Good to hear that you got most of the bits working from #688. With regards to this particular issue, all skia operations are synchronous - this means that when the method returns, it is finished the job.\r\n\r\nAs you are drawing on the GPU, using bitmaps means that the image data is being copied back and forth between memory and the GPU. You mention that if you use images, you get exceptions all over. Do you have a stack trace of some sort?\r\n\r\nI am actually not that sure about the rules about multithreaded, cross-threaded, cross-context drawing, so I asked a question on the skia forums: https://groups.google.com/forum/#!topic/skia-discuss/dj8UJT_tqcU For some reason, I seem to recall that images created with one context can\u0027t be used by another - which may be what you are seeing when using images.\r\n\r\nWith this code, are you using a single context across threads? Are you using multiple contexts at all? (this may be the case if you are creating your own context, but then drawing to a view with that context) If there is multiple threads, is the underlying OpenGLES context able to handle multiple threads? (which again may be the case because you are creating a new context - I know iOS has something called sharegroups.\r\n\r\nAs for the exception, do you have any stack traces that may give some more information.",
        "createdAt": "2019-01-16T19:08:57",
        "reactions": []
      },
      {
        "id": 468778874,
        "author": "Al3xlab",
        "body": "To complete the observation of @pathw0rk3r: I copied the code of #688 to create a GRContext on UWP. My SKSurface \u0027accelerated\u0027 is running on a background thread, but the snapshot (SKImage) is empty in the main thread and can not be displayed by SKCanvasView! Similarly, like @pathw0rk3r, I created a SKBitmap from the snapshot, and the pixel array is identical from the backgroung thread to the main thread.\r\nSo far, I don\u0027t see a SystemAcesssViolation exception, but other problems: when I change the size of the accelerated SKSurface at runtime, the bitmap can no longer be created from the snapshot (become null because the snapshot is corrupt ?). I instantiate and dispose the surface, canvas, image, and bitmap in the background rendering loop.\r\nAnother surprise, when my rendering loop is repeated (only 1 FPS), multiple frames are not displayed and I get glitches on the bitmap. Have you seen anything like this before ?\r\n\r\nNormal:\r\n![img1](https://user-images.githubusercontent.com/48130657/53659994-30364980-3c5d-11e9-8d14-3cb4cf991cfa.jpg)\r\nGlitches:\r\n![img2](https://user-images.githubusercontent.com/48130657/53660046-4b08be00-3c5d-11e9-9ced-641cc0ad1f83.jpg)\r\n\r\n\r\n",
        "createdAt": "2019-03-01T19:15:49",
        "reactions": []
      }
    ]
  }
}