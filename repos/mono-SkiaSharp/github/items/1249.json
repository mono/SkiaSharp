{
  "number": 1249,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKImage.FromEncodedData fails on loading image",
  "body": "**Description**\r\n\r\nI am getting an exception when trying to load a botmap from file into an AvaloniaUI \u0060\u003CImage\u003E\u0060 control.  The bitmap is a 1 pixel wide image, but with a potentially large (ridiculous) height. The image control will scale the image to fit the associated size. \r\n\r\nIt works when the image is not too high. But when it gets large it fails. \r\n\r\n**Code**\r\n\r\n1. The image is created using SixLabors ImageSharp, and was saved to disk via \u0060img.Save(\u0022name.bmp\u0022, new BmpEncoder());\u0060. The file appears on disk and can be opened in image-viewers without any issue. \r\n\r\nThe size for the **failing** test-scenario is about 9 MB (1 x 2 309 534 pixels). \r\n\r\nThe size for a **non-failing** test-scenario is about 4 KB (1 x 1 065 pixels).\r\n\r\n2. An Avalonia UI \u0060\u003CImage\u003E\u0060 control is set up as follows\r\n\u0060\u0060\u0060\r\n\u003CImage Width=\u002210\u0022 Stretch=\u0022Fill\u0022 DockPanel.Dock=\u0022Right\u0022 /\u003E\r\n\u0060\u0060\u0060\r\nWhen the view-model detects that the file is created it assigns the filename to the image control\u0027s \u0060Source\u0060 attribute.\r\n\r\n**Expected Behavior**\r\n\r\nAn image that expands in width to 10 pixels (based on the single pixel width), with a height equal to the height of the DockPanel. The height should (normally) shrink to fit the height.\r\n\r\nFor the working test-scenario this works exactly as expected.\r\n\r\n**Actual Behavior**\r\n\r\nI get an exception as a result of assigning the filename to the Source attribute for the failing test-scenario.\r\n\r\n\u0060\u0060\u0060\r\nSystem.ArgumentException\r\n  HResult=0x80070057\r\n  Message=Unable to load bitmap from provided data\r\n  Source=Avalonia.Skia\r\n  StackTrace:\r\n   at Avalonia.Skia.ImmutableBitmap..ctor(Stream stream)\r\n   at Avalonia.Skia.PlatformRenderInterface.LoadBitmap(Stream stream)\r\n   at Avalonia.Skia.PlatformRenderInterface.LoadBitmap(String fileName)\r\n   at Avalonia.Media.Imaging.Bitmap..ctor(String fileName)\r\n   at LogExpress.ViewModels.LogViewModel.\u003C.ctor\u003Eb__15_13(String fileName) in D:\\src\\Haive\\LogExpress\\src\\LogExpress-Avalonia\\ViewModels\\LogViewModel.cs:line 75\r\n   at System.Reactive.AnonymousSafeObserver\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\AnonymousSafeObserver.cs:line 54\r\n   at System.Reactive.Linq.ObservableImpl.DistinctUntilChanged\u00602._.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\DistinctUntilChanged.cs:line 74\r\n   at System.Reactive.Linq.ObservableImpl.Switch\u00601._.InnerObserver.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\Switch.cs:line 100\r\n   at System.Reactive.IdentitySink\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\IdentitySink.cs:line 16\r\n   at System.Reactive.Linq.ObservableImpl.Cast\u00602._.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\Cast.cs:line 41\r\n   at System.Reactive.IdentitySink\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\IdentitySink.cs:line 16\r\n   at System.Reactive.Subjects.Subject\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Subjects\\Subject.cs:line 148\r\n   at System.Reactive.IdentitySink\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\IdentitySink.cs:line 16\r\n   at System.Reactive.Linq.ObservableImpl.SelectMany\u00602.EnumerableSelector._.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\SelectMany.cs:line 1351\r\n   at System.Reactive.Linq.ObservableImpl.Buffer\u00602.Boundaries._.BufferClosingObserver.OnNext(TBufferClosing value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\Buffer.cs:line 829\r\n   at System.Reactive.Linq.ObservableImpl.Merge\u00601.Observables._.InnerObserver.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\Merge.cs:line 236\r\n   at System.Reactive.Linq.ObservableImpl.Select\u00602.Selector._.OnNext(TSource value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Linq\\Observable\\Select.cs:line 48\r\n   at System.Reactive.Subjects.Subject\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Subjects\\Subject.cs:line 148\r\n   at ReactiveUI.IReactiveObjectExtensions.ExtensionState\u00601.NotifyObservable[T](TSender rxObj, T item, ISubject\u00601 subject) in d:\\a\\1\\s\\src\\ReactiveUI\\ReactiveObject\\IReactiveObjectExtensions.cs:line 386\r\n   at ReactiveUI.IReactiveObjectExtensions.ExtensionState\u00601.RaisePropertyChanged(String propertyName) in d:\\a\\1\\s\\src\\ReactiveUI\\ReactiveObject\\IReactiveObjectExtensions.cs:line 380\r\n   at ReactiveUI.IReactiveObjectExtensions.RaisingPropertyChanged[TSender](TSender reactiveObject, String propertyName) in d:\\a\\1\\s\\src\\ReactiveUI\\ReactiveObject\\IReactiveObjectExtensions.cs:line 193\r\n   at ReactiveUI.IReactiveObjectExtensions.RaiseAndSetIfChanged[TObj,TRet](TObj reactiveObject, TRet\u0026 backingField, TRet newValue, String propertyName) in d:\\a\\1\\s\\src\\ReactiveUI\\ReactiveObject\\IReactiveObjectExtensions.cs:line 119\r\n   at LogExpress.Services.VirtualLogFile.set_LogLevelMapFile(String value) in D:\\src\\Haive\\LogExpress\\src\\LogExpress-Avalonia\\Services\\VirtualLogFile.cs:line 194\r\n   at LogExpress.Services.VirtualLogFile.CreateLogLevelMapImage() in D:\\src\\Haive\\LogExpress\\src\\LogExpress-Avalonia\\Services\\VirtualLogFile.cs:line 185\r\n   at LogExpress.Services.VirtualLogFile.\u003C.ctor\u003Eb__11_5(Boolean x) in D:\\src\\Haive\\LogExpress\\src\\LogExpress-Avalonia\\Services\\VirtualLogFile.cs:line 134\r\n   at System.Reactive.AnonymousSafeObserver\u00601.OnNext(T value) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\AnonymousSafeObserver.cs:line 44\r\n   at System.Reactive.ObserveOnObserverNew\u00601.DrainStep(ConcurrentQueue\u00601 q) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\ScheduledObserver.cs:line 577\r\n   at System.Reactive.ObserveOnObserverNew\u00601.DrainShortRunning(IScheduler recursiveScheduler) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\ScheduledObserver.cs:line 509\r\n   at System.Reactive.ObserveOnObserverNew\u00601.\u003C\u003Ec.\u003C.cctor\u003Eb__17_0(IScheduler scheduler, ObserveOnObserverNew\u00601 self) in d:\\a\\1\\s\\Rx.NET\\Source\\src\\System.Reactive\\Internal\\ScheduledObserver.cs:line 497\r\n   at Avalonia.Threading.AvaloniaScheduler.\u003C\u003Ec__DisplayClass2_1\u00601.\u003CSchedule\u003Eb__1()\r\n   at Avalonia.Threading.JobRunner.RunJobs(Nullable\u00601 priority)\r\n   at Avalonia.Win32.Win32Platform.WndProc(IntPtr hWnd, UInt32 msg, IntPtr wParam, IntPtr lParam)\r\n   at Avalonia.Win32.Interop.UnmanagedMethods.DispatchMessage(MSG\u0026 lpmsg)\r\n   at Avalonia.Win32.Win32Platform.RunLoop(CancellationToken cancellationToken)\r\n   at Avalonia.Threading.Dispatcher.MainLoop(CancellationToken cancellationToken)\r\n   at Avalonia.Controls.ApplicationLifetimes.ClassicDesktopStyleApplicationLifetime.Start(String[] args)\r\n   at Avalonia.ClassicDesktopStyleApplicationLifetimeExtensions.StartWithClassicDesktopLifetime[T](T builder, String[] args, ShutdownMode shutdownMode)\r\n   at LogExpress.Program.Main(String[] args) in D:\\src\\Haive\\LogExpress\\src\\LogExpress-Avalonia\\Program.cs:line 32\r\n\r\n  This exception was originally thrown at this call stack:\r\n    Avalonia.Skia.ImmutableBitmap.ImmutableBitmap(System.IO.Stream)\r\n    Avalonia.Skia.PlatformRenderInterface.LoadBitmap(System.IO.Stream)\r\n    Avalonia.Skia.PlatformRenderInterface.LoadBitmap(string)\r\n    Avalonia.Media.Imaging.Bitmap.Bitmap(string)\r\n    LogExpress.ViewModels.LogViewModel..ctor.AnonymousMethod__15_13(string) in LogViewModel.cs\r\n    System.Reactive.AnonymousSafeObserver\u003CT\u003E.OnNext(T) in AnonymousSafeObserver.cs\r\n    System.Reactive.Linq.ObservableImpl.DistinctUntilChanged\u003CTSource, TKey\u003E._.OnNext(TSource) in DistinctUntilChanged.cs\r\n    System.Reactive.Linq.ObservableImpl.Switch\u003CTSource\u003E._.InnerObserver.OnNext(TSource) in Switch.cs\r\n    System.Reactive.IdentitySink\u003CT\u003E.OnNext(T) in IdentitySink.cs\r\n    System.Reactive.Linq.ObservableImpl.Cast\u003CTSource, TResult\u003E._.OnNext(TSource) in Cast.cs\r\n    ...\r\n    [Call Stack Truncated]\r\n\u0060\u0060\u0060\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  AvaloniaUI v9.9 (not sure which version of SkiaSharp is used for it)\r\n- Last known good version:  Don\u0027t know. This is new code.\r\n- IDE:  Visual Studio\r\n- Platform Target Frameworks: \r\n  - Windows Classic:  Windows 10\r\n\r\n**Screenshots**\r\n\r\n[failing-image.zip](https://github.com/mono/SkiaSharp/files/4533900/failing-image.zip)\r\n[non-failing-image.zip](https://github.com/mono/SkiaSharp/files/4533904/non-failing-image.zip)\r\n\r\n**Reproduction Link**\r\n\r\nN/A",
  "author": {
    "login": "Spiralis",
    "type": "User"
  },
  "labels": [
    {
      "name": "status/duplicate",
      "color": "B8EC4A"
    }
  ],
  "assignees": [],
  "createdAt": "2020-04-25T19:57:43",
  "updatedAt": "2022-08-19T06:01:55",
  "closedAt": "2020-05-08T17:52:05",
  "commentCount": 12,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:12:55.9923524Z",
    "reactions": [],
    "comments": [
      {
        "id": 619433474,
        "author": "Spiralis",
        "body": "@kekekeks (from the AvaloniaUI core team I believe) suggested that this could be an issue in SkiaSharp and that I should file an issue for it. \r\n\r\nHe didn\u0027t think that they could fix this by changing anything within Avalonia.\r\n ",
        "createdAt": "2020-04-25T20:04:45",
        "reactions": []
      },
      {
        "id": 619433852,
        "author": "kekekeks",
        "body": "Relevant image loading code:\r\n\r\n\u0060\u0060\u0060cs\r\n        public ImmutableBitmap(Stream stream)\r\n        {\r\n            using (var skiaStream = new SKManagedStream(stream))\r\n            {\r\n                using (var data = SKData.Create(skiaStream))\r\n                    _image = SKImage.FromEncodedData(data);\r\n\r\n                if (_image == null)\r\n                {\r\n                    throw new ArgumentException(\u0022Unable to load bitmap from provided data\u0022);\r\n                }\r\n\r\n                PixelSize = new PixelSize(_image.Width, _image.Height);\r\n\r\n                // TODO: Skia doesn\u0027t have an API for DPI.\r\n                Dpi = new Vector(96, 96);\r\n            }\r\n        }\r\n\u0060\u0060\u0060\r\nhttps://github.com/AvaloniaUI/Avalonia/blob/9b73c1027b8bc03b8f2501d0fe4df8d311be7dac/src/Skia/Avalonia.Skia/ImmutableBitmap.cs#L20-L37",
        "createdAt": "2020-04-25T20:08:05",
        "reactions": []
      },
      {
        "id": 619437903,
        "author": "Gillibald",
        "body": "Skia has a limit for bitmap sizes. Can\u0027t remember the actual value.",
        "createdAt": "2020-04-25T20:40:47",
        "reactions": []
      },
      {
        "id": 619438105,
        "author": "Gillibald",
        "body": "https://groups.google.com/forum/m/#!topic/skia-discuss/886WuVcQUGo",
        "createdAt": "2020-04-25T20:42:49",
        "reactions": []
      },
      {
        "id": 619448817,
        "author": "Spiralis",
        "body": "Why does it have this limitation, by the way? \r\n\r\nI can make them multiple images and create new Image controls to handle each, but I would have to handle scaling myself. Which is a pity when the single image control handles this nicely. I am not even sure how to stack them and scale them, so that will mean a lot of additional work.\r\n\r\nDoes this btw mean that any Avalonia \u003CImage\u003E control will not be able to handle images larger than 32Kx32K?\r\n\r\nFinally, why the 32Kx32K limitations? Would it not make sense if the limitation was by the multiplied total, allowing for rectangles to go beyond 32K in one direction? Or is this related to some hardware specific graphics card limitations?",
        "createdAt": "2020-04-25T22:27:01",
        "reactions": []
      },
      {
        "id": 619478288,
        "author": "mattleibow",
        "body": "@Spiralis check out the link from @Gillibald for more info. It also has some info on drawing tiles, which may be something that a control suite can handle for you.\r\n\r\nThe issue might be loading this image to process... I\u0027ll see if I can whip up some demo code that makes it possible to load infinity without breaking... \u0060SKCodec\u0060 hopefully supports reading chunks of pixels even if the full image can\u0027t be decoded in one go. ",
        "createdAt": "2020-04-26T04:09:33",
        "reactions": []
      },
      {
        "id": 619493567,
        "author": "mattleibow",
        "body": "Duplicate of #648",
        "createdAt": "2020-04-26T06:38:26",
        "reactions": []
      },
      {
        "id": 619535116,
        "author": "mattleibow",
        "body": "Just so that we know, even macOS can\u0027t open it. The other one is fine, just the super huge one is broken. Windows is good.\r\n\r\n\u003Cimg width=\u0022431\u0022 alt=\u0022Screenshot 2020-04-26 at 13 36 23\u0022 src=\u0022https://user-images.githubusercontent.com/1096616/80306325-ee525600-87c2-11ea-8044-b5aa91674bd6.png\u0022\u003E\r\n",
        "createdAt": "2020-04-26T11:37:13",
        "reactions": []
      },
      {
        "id": 619540339,
        "author": "Gillibald",
        "body": "It is just wrong having a bitmap that is that big. Think about some tiling mechanism and load your pixel data on-demand in chunks.",
        "createdAt": "2020-04-26T12:15:42",
        "reactions": []
      },
      {
        "id": 619547119,
        "author": "mattleibow",
        "body": "Yeah. This is going to explode your computer 2M x 2M pixels is like 4 trillion pixels - each with 32 bits of data. A HUGE amount of data to load into memory. 128 trillion bits, 16 trillion bytes, 2 TB or something. That is not going to load.",
        "createdAt": "2020-04-26T13:09:21",
        "reactions": []
      },
      {
        "id": 619554255,
        "author": "mattleibow",
        "body": "Just saw this about .bmp files: https://github.com/google/skia/blob/master/src/codec/SkBmpCodec.cpp#L286-L290\r\n\r\n\u003E \u0060\u0060\u0060cpp\r\n\u003E // Arbitrary maximum. Matches Chromium.\r\n\u003E constexpr int kMaxDim = 1 \u003C\u003C 16;\r\n\u003E if (width \u003C= 0 || height \u003C= 0 || width \u003E= kMaxDim || height \u003E= kMaxDim) {\r\n\u003E     SkCodecPrintf(\u0022Error: invalid bitmap dimensions.\\n\u0022);\r\n\u003E     return kInvalidInput;\r\n\u003E }\r\n\u003E\u0060\u0060\u0060\r\n\r\nThis means I can\u0027t even instantiate the codec to load tiles of the bitmap... Let me try png... \uD83E\uDD1E \r\n\r\n**EDIT**\r\n\r\nI can\u0027t even save that file with Paint or Paint.NET... I can\u0027t even load it with GIMP or other software. \r\n\r\n**EDIT 2**\r\n\r\nI just tried WPF and it just breaks with random yellow stripes.",
        "createdAt": "2020-04-26T13:59:02",
        "reactions": []
      },
      {
        "id": 625938191,
        "author": "Spiralis",
        "body": "Yeah. I have changed it to do chunks at a time. I used it to create a \u0022heatmap\u0022 that I then scaled down. Problem was that each line needed to be represented. So, now I read a given number of lines, create the image, scale it down, and then processes the next chunk, and scales that etc. Then, at then end each of these images are tiled, but each of them are also scaled down. Because, the number of them is dynamic and have to handle any number of files/lines that I analyze. Which means that, if the number gets really large, I\u0027d even need to do another pass on the generated images, combining a number of them and scaling again...\r\n\r\nBut, this surely can be closed,I think. I have solved it for my case at least.",
        "createdAt": "2020-05-08T17:52:05",
        "reactions": []
      }
    ]
  }
}