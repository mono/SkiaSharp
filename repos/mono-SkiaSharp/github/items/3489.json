{
  "number": 3489,
  "type": "pr",
  "state": "open",
  "title": "Optimize the CopyTo method of SKBitmap",
  "body": "**Description of Change**\r\n\r\nA simple PR\r\n\r\nOptimize the CopyTo method of SKBitmap.\r\n\r\nUse direct memory copy instead of creating SKCanvas and DrawBitmap when source and destination Bitmap have the same SKColorType and Width.\r\n\r\n\u003C!-- Describe your changes here. --\u003E\r\n\r\n**Bugs Fixed**\r\n\r\nNone\r\n\r\n\u003C!-- Provide links to issues here. Ensure that a GitHub issue was created for your feature or bug fix before sending PR. --\u003E\r\n\r\n**API Changes**\r\n\r\nNone.\r\n\r\n\u003C!-- REPLACE THIS COMMENT\r\n\r\nList all API changes here (or just put None), example:\r\n\r\nAdded: \r\n \r\n- \u0060string Class.Property { get; set; }\u0060\r\n- \u0060void Class.Method();\u0060\r\n\r\nChanged:\r\n\r\n - \u0060object Cell.OldPropertyName =\u003E object Cell.NewPropertyName\u0060\r\n\r\n--\u003E\r\n\r\n**Behavioral Changes**\r\n\r\nNone.\r\n\r\n\u003C!-- Describe any non-bug related behavioral changes that may change how users app behaves when upgrading to this version of the codebase. --\u003E\r\n\r\n**Required skia PR**\r\n\r\nNone.\r\n\r\n\u003C!-- Replace this with the full URL to the skia PR. --\u003E\r\n\r\n**PR Checklist**\r\n\r\n- [ ] Has tests (if omitted, state reason in description)\r\n- [x] Rebased on top of main at time of PR\r\n- [ ] Merged related skia PRs\r\n- [x] Changes adhere to coding standard\r\n- [ ] Updated documentation\r\n",
  "author": {
    "login": "jyswjjgdwtdtj",
    "type": "User"
  },
  "labels": [
    {
      "name": "community \u2728",
      "color": "ededed"
    }
  ],
  "assignees": [],
  "createdAt": "2026-02-02T02:05:21",
  "updatedAt": "2026-02-04T15:52:25",
  "commentCount": 7,
  "reactionCount": 0,
  "draft": false,
  "mergeable": true,
  "merged": false,
  "mergeableState": "behind",
  "baseBranch": "main",
  "headBranch": "main",
  "additions": 36,
  "deletions": 0,
  "changedFiles": 1,
  "commits": 3,
  "reviews": [
    {
      "author": "jeremy-visionaid",
      "state": "COMMENTED",
      "submittedAt": "2026-02-02T04:23:03"
    },
    {
      "author": "jyswjjgdwtdtj",
      "state": "COMMENTED",
      "submittedAt": "2026-02-02T14:32:33"
    },
    {
      "author": "jeremy-visionaid",
      "state": "COMMENTED",
      "submittedAt": "2026-02-02T19:48:23"
    },
    {
      "author": "jyswjjgdwtdtj",
      "state": "COMMENTED",
      "submittedAt": "2026-02-03T02:00:30"
    },
    {
      "author": "jyswjjgdwtdtj",
      "state": "COMMENTED",
      "submittedAt": "2026-02-04T15:52:25"
    }
  ],
  "engagement": {
    "syncedAt": "2026-02-06T12:35:24.3362872Z",
    "reactions": [],
    "comments": [
      {
        "id": 3832544205,
        "author": "jyswjjgdwtdtj",
        "body": "@dotnet-policy-service agree\r\n",
        "createdAt": "2026-02-02T02:06:17",
        "reactions": []
      },
      {
        "id": 3832549880,
        "author": "jyswjjgdwtdtj",
        "body": "\u003E \u8BF7\u9605\u8BFB\u4EE5\u4E0B\u8D21\u732E\u8005\u8BB8\u53EF\u534F\u8BAE\uFF08CLA\uFF09\u3002\u5982\u679C\u60A8\u540C\u610FCLA\u7684\u89C2\u70B9\uFF0C\u8BF7\u56DE\u590D\u4EE5\u4E0B\u4FE1\u606F\u3002\r\n\u003E \r\n\u003E \u0060\u0060\u0060\r\n\u003E @dotnet-policy-service agree [company=\u0022{your company}\u0022]\r\n\u003E \u0060\u0060\u0060\r\n\u003E \r\n\u003E \u003E \u9009\u9879\uFF1A\r\n\u003E \u003E \r\n\u003E \u003E * \uFF08\u9ED8\u8BA4 - \u672A\u6307\u5B9A\u516C\u53F8\uFF09\u6211\u62E5\u6709\u6211\u63D0\u4EA4\u7684\u77E5\u8BC6\u4EA7\u6743\u72EC\u5360\u6743\uFF0C\u4E14\u6211\u4E0D\u5728\u5DE5\u4F5C\u8FC7\u7A0B\u4E2D\u4E3A\u96C7\u4E3B\u63D0\u4EA4\u3002\r\n\u003E \u003E \r\n\u003E \u003E \u0060\u0060\u0060\r\n\u003E \u003E @dotnet-policy-service agree\r\n\u003E \u003E \u0060\u0060\u0060\r\n\u003E \u003E \r\n\u003E \u003E \r\n\u003E \u003E     \r\n\u003E \u003E       \r\n\u003E \u003E     \r\n\u003E \u003E \r\n\u003E \u003E       \r\n\u003E \u003E     \r\n\u003E \u003E \r\n\u003E \u003E     \r\n\u003E \u003E   \r\n\u003E \u003E \r\n\u003E \u003E * \uFF08\u5F53\u6709\u4EBA\u966A\u4F34\u65F6\uFF09\u6211\u6B63\u5728\u4E3A\u96C7\u4E3B\u5DE5\u4F5C\u671F\u95F4\u63D0\u4EA4\u6750\u6599\uFF08\u6216\u8005\u6211\u7684\u96C7\u4E3B\u6839\u636E\u5408\u540C\u6216\u9002\u7528\u6CD5\u5F8B\u62E5\u6709\u6211\u7684\u63D0\u4EA4\u5185\u5BB9\u7684\u77E5\u8BC6\u4EA7\u6743\uFF09\u3002\u6211\u5DF2\u83B7\u5F97\u96C7\u4E3B\u7684\u8BB8\u53EF\uFF0C\u53EF\u4EE5\u4EE3\u8868\u96C7\u4E3B\u63D0\u4EA4\u610F\u89C1\u5E76\u7B7E\u7F72\u672C\u534F\u8BAE\u3002\u5728\u4E0B\u65B9\u7B7E\u540D\uFF0C\u5B9A\u4E49\u7684\u201C\u4F60\u201D\u4E00\u8BCD\u5305\u62EC\u6211\u548C\u6211\u7684\u96C7\u4E3B\u3002\r\n\u003E \u003E \r\n\u003E \u003E \u0060\u0060\u0060\r\n\u003E \u003E @dotnet-policy-service agree company=\u0022Microsoft\u0022\r\n\u003E \u003E \u0060\u0060\u0060\r\n\u003E \r\n\u003E \u8D21\u732E\u8005\u8BB8\u53EF\u534F\u8BAE\r\n\r\n@dotnet-policy-service agree",
        "createdAt": "2026-02-02T02:09:21",
        "reactions": []
      },
      {
        "id": 3832833435,
        "author": "jeremy-visionaid",
        "body": "I also have a memory copy approach since CopyTo is both slow and leaky as is (#2915). Unfortunately, this one doesn\u0027t handle that the bitmap might be a subset of another, in which case the source pixel span can be a lot bigger than the destination. I don\u0027t mind putting in a PR for mine or helping fix this if it\u0027s of interest though?",
        "createdAt": "2026-02-02T04:21:19",
        "reactions": []
      },
      {
        "id": 3833716273,
        "author": "jyswjjgdwtdtj",
        "body": "\u003E I also have a memory copy approach since CopyTo is both slow and leaky as is (#2915). Unfortunately, this one doesn\u0027t handle that the bitmap might be a subset of another, in which case the source pixel span can be a lot bigger than the destination. I don\u0027t mind putting in a PR for mine or helping fix this if it\u0027s of interest though?\n\nyou are right. Actually I\u0027m not a Skia professor\uD83D\uDE22 and I have never used ExtractSubset. I just find my project use up 1gb memories for no reason but a copyto.\nMay be I should have some additional code to deal with the subset situation.",
        "createdAt": "2026-02-02T08:32:59",
        "reactions": []
      },
      {
        "id": 3833777007,
        "author": "jeremy-visionaid",
        "body": "No worries. I think a fair few people have been tripped up by the leak there. I have a PR to fix that: #3317 You can just copy the code from there for that if you want, but a memory copy like what you were doing is orders of magnitude faster \uD83D\uDC4D ",
        "createdAt": "2026-02-02T08:45:19",
        "reactions": []
      },
      {
        "id": 3833831271,
        "author": "jyswjjgdwtdtj",
        "body": "\u003E No worries. I think a fair few people have been tripped up by the leak there. I have a PR to fix that: #3317 You can just copy the code from there for that if you want, but a memory copy like what you were doing is orders of magnitude faster \uD83D\uDC4D \n\nIt seems that there isn\u0027t a property refers to if a skbitmap is a subset of the other one. I don\u0027t know whether it\u0027s available in skia (not skiasharp )\n\nSo maybe the easiest way to solve the problem is to delete ExtractSubset or let the method create a new skbitmap with new memory. \n\nIt is not worthwhile to reduce the security and efficiency of the commonly used CopyTo method at the cost of improving the efficiency of the infrequently used ExtractSubset method.\n\nAnd I think since the name of the method is CopyTo, it must be designed to copy a bitmap to the other one which has the same color type and size. The current CopyTo must be called \u0022DrawTo\u0022.  This will only lead to ambiguity and inefficiency\n\nIt is meaningless to blindly conform to Skia\u0027s api",
        "createdAt": "2026-02-02T08:58:07",
        "reactions": []
      },
      {
        "id": 3835501906,
        "author": "jyswjjgdwtdtj",
        "body": "\u003E No worries. I think a fair few people have been tripped up by the leak there. I have a PR to fix that: #3317 You can just copy the code from there for that if you want, but a memory copy like what you were doing is orders of magnitude faster \uD83D\uDC4D\r\n\r\nI add some code, and in it I copy pixels row by row when one or both of the src and des bitmap is a subset of another bitmap.\nWhen their ColorType are not the same, CopyTo may still use drawpaint ",
        "createdAt": "2026-02-02T14:34:48",
        "reactions": []
      }
    ]
  }
}