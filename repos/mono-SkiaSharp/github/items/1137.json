{
  "number": 1137,
  "type": "issue",
  "state": "closed",
  "title": "Access Violation  sometimes when trying to draw rectangles",
  "body": "**Description**\r\nWhen using skiasharp to draw rectangles, it gives access violation error.\r\nThis happens when I do from wpf and I use the SkElement and the first time it triggers the PaintSurface Event.\r\n\r\n**Code**\r\n\r\non wpf is this\r\n\r\n        private void PaintSurface(object? sender, SKPaintSurfaceEventArgs e)\r\n        {\r\n            Execute.OnUIThread(() =\u003E\r\n            {\r\n                e.Surface.Canvas.Clear();\r\n                _thisSquare.DrawSquare(e.Surface.Canvas, e.Info.Width, e.Info.Height);\r\n\r\n            });\r\n        }\r\n\r\non cross platform is this\r\n\r\n        public void DrawSquare(SKCanvas thisCanvas, float width, float height)\r\n        {\r\n\r\n            var bounds = SKRect.Create(0, 0, width, height);\r\n            _redPenBrush!.StrokeWidth = bounds.Width / 20;\r\n            _slateGrayPenBrush!.StrokeWidth = bounds.Width / 30;\r\n            _blackPenBrush!.StrokeWidth = bounds.Width / 20;\r\n            _darkGrayPenBrush!.StrokeWidth = bounds.Width / 30;\r\n            MiscHelpers.DefaultFont = \u0022Verdana\u0022;\r\n            var thisPercs = MiscHelpers.EnumLinearGradientPercent.Angle45;\r\n            if (IsFlipped == true)\r\n            {\r\n                if (IsMine == true || Flagged == true)\r\n                {\r\n                    var firstColor = new SKColor(255, 255, 255, 100);\r\n                    var secondColor = new SKColor(0, 0, 0, 100);\r\n                    var secondBrush = MiscHelpers.GetLinearGradientPaint(firstColor, secondColor, bounds, thisPercs);\r\n                    thisCanvas.DrawOval(bounds.Left \u002B (bounds.Width / 2), bounds.Top \u002B (bounds.Width / 2), bounds.Width / 4, bounds.Height / 4, _redSolidBrush);\r\n                    // well see how the second part comes along (could be iffy)(?)\r\n                    thisCanvas.DrawOval(bounds.Left \u002B (bounds.Width / 2), bounds.Top \u002B (bounds.Width / 2), bounds.Width / 4, bounds.Height / 4, secondBrush);\r\n                }\r\n                else if (NeighborMines \u003E 0)\r\n                {\r\n                    var textPaint = MiscHelpers.GetTextPaint(SKColors.Aqua, (bounds.Height * 3) / 4);\r\n                    thisCanvas.DrawCustomText(NeighborMines.ToString(), TextExtensions.EnumLayoutOptions.Center, TextExtensions.EnumLayoutOptions.Center, textPaint, bounds, out _); // i think\r\n                }\r\n                if (Flagged == true)\r\n                {\r\n                    thisCanvas.DrawLine(bounds.Location.X, bounds.Location.Y, bounds.Location.X \u002B bounds.Width, bounds.Location.Y \u002B bounds.Height, _blackPenBrush);\r\n                    thisCanvas.DrawLine(bounds.Location.X \u002B bounds.Width, bounds.Location.Y, bounds.Location.X, bounds.Location.Y \u002B bounds.Height, _blackPenBrush);\r\n                }\r\n            }\r\n            else\r\n            {\r\n                SKRect otherRect;\r\n                otherRect = SKRect.Create(bounds.Location.X \u002B (bounds.Width / 6), bounds.Location.Y \u002B (bounds.Height / 6), (bounds.Width * 2) / 3, (bounds.Height * 2) / 3);\r\n                SKColor firstColor;\r\n                SKColor secondColor;\r\n                SKPaint currentPaint;\r\n                if (Pressed == true)\r\n                {\r\n                    currentPaint = _darkGrayPenBrush;\r\n                    firstColor = new SKColor(0, 0, 0, 150);\r\n                    secondColor = new SKColor(255, 255, 255, 150);\r\n                }\r\n                else\r\n                {\r\n                    currentPaint = _slateGrayPenBrush;\r\n                    firstColor = new SKColor(255, 255, 255, 150);\r\n                    secondColor = new SKColor(0, 0, 0, 150);\r\n                }\r\n                var tempPaint = MiscHelpers.GetLinearGradientPaint(firstColor, secondColor, bounds, thisPercs);\r\n                thisCanvas.DrawRect(bounds, tempPaint);\r\n                thisCanvas.DrawRect(otherRect, currentPaint);\r\n                if (Flagged == true)\r\n                {\r\n                    SKPath ThisPath = new SKPath();\r\n                    ThisPath.MoveTo(bounds.Location.X \u002B (bounds.Width / 2), bounds.Location.Y \u002B (bounds.Height / 4));\r\n                    ThisPath.LineTo(bounds.Location.X \u002B ((bounds.Width * 3) / 4), bounds.Location.Y \u002B ((bounds.Height * 3) / 8));\r\n                    ThisPath.LineTo(bounds.Location.X \u002B (bounds.Width / 2), bounds.Location.Y \u002B (bounds.Height / 2));\r\n                    thisCanvas.DrawPath(ThisPath, _redSolidBrush);\r\n                    thisCanvas.DrawLine(bounds.Location.X \u002B (bounds.Width / 2), bounds.Location.Y \u002B ((bounds.Height * 3) / 4), bounds.Location.X \u002B (bounds.Width / 2), bounds.Location.Y \u002B (bounds.Height / 4), _redPenBrush);\r\n                }\r\n            }\r\n            thisCanvas.DrawRect(bounds, _slateGrayPenBrush);\r\n        }\r\n\r\nthe 2 lines causing the problem is this\r\n\r\n    thisCanvas.DrawRect(bounds, tempPaint);\r\n    thisCanvas.DrawRect(otherRect, currentPaint);\r\n\r\n\r\n\r\n**Expected Behavior**\r\nExpected behavior is to actually draw\r\n\r\n**Actual Behavior**\r\nAccess violation on one of the 2 lines of code\r\n\r\n    thisCanvas.DrawRect(bounds, tempPaint);\r\n    thisCanvas.DrawRect(otherRect, currentPaint);\r\n\r\n\r\n**Basic Information**\r\n\r\nversion is 1.68.1.1\r\nwith wpf.\r\nhowever, the part that raise the error and won\u0027t let me handle it is the cross platform skiasharp.\r\n\r\n",
  "author": {
    "login": "musictopia2",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "v1.68.2",
  "createdAt": "2020-02-10T21:36:31",
  "updatedAt": "2022-08-19T06:02:46",
  "closedAt": "2020-04-09T01:52:30",
  "commentCount": 28,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-06T14:11:25.4415614Z",
    "reactions": [
      {
        "user": "alexandrvslv",
        "content": "\u002B1",
        "createdAt": "2026-02-06T14:11:25.4415682Z"
      }
    ],
    "comments": [
      {
        "id": 584374896,
        "author": "mattleibow",
        "body": "Is the \u0060Execute.OnUIThread\u0060 blocking? If not (which is likely) the canvas will actually be disposed and you are now trying to access something that is gone from memory. \r\n\r\nOn this note, why are you using the \u0060Execute.OnUIThread\u0060 method? The paint callback should already be on the UI thread. You shouldn\u0027t need to use any additional logic to move it.",
        "createdAt": "2020-02-10T21:50:42",
        "reactions": []
      },
      {
        "id": 584377457,
        "author": "musictopia2",
        "body": "I actually tried the same code on the 16.8.0 and the problem did not happen.  I did the OnUIThread to try to fix the problem.  Because when the problem first occured, I tried several things and same issue.  I finally decided to try on an older version of skiasharp and the problem did not happen.",
        "createdAt": "2020-02-10T21:57:12",
        "reactions": []
      },
      {
        "id": 584445606,
        "author": "mattleibow",
        "body": "Are you able to attach a full stack trace?\r\nAre you using WPF with .NET Framework or .NET Core?\r\n\r\nDoes the issue still happen with 1.68.0 without the \u0060Execute.OnUIThread\u0060?",
        "createdAt": "2020-02-11T01:48:21",
        "reactions": []
      },
      {
        "id": 584456235,
        "author": "musictopia2",
        "body": "How do I attach a full stack trace?  I am using WPF with .net core.  I tried without the OnUIThread and the problem did not reoccur with 1.68.0.\r\nIt would not even let me to do a try catch to try the drawings again with 1.68.1.1\r\nEven with 1.68.0 I was using .WPF with .net core.  I used \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00221.68.0\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022SkiaSharp.Views\u0022 Version=\u00221.68.0\u0022\u003E\r\n      \u003CNoWarn\u003ENU1701\u003C/NoWarn\u003E\r\n    \u003C/PackageReference\u003E code for the project so i don\u0027t get the warnings.",
        "createdAt": "2020-02-11T02:38:20",
        "reactions": []
      },
      {
        "id": 584457497,
        "author": "musictopia2",
        "body": "I tried to run it again after changing over to the new version and here is what i was able to copy.\r\nSystem.AccessViolationException\r\n  HResult=0x80004003\r\n  Message=Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\n  Source=\u003CCannot evaluate the exception source\u003E\r\n  StackTrace:\r\n\u003CCannot evaluate the exception stack trace\u003E\r\n\r\n\r\n",
        "createdAt": "2020-02-11T02:46:03",
        "reactions": []
      },
      {
        "id": 584458009,
        "author": "musictopia2",
        "body": "I checked the stack trace and it showed it as null.  I did a screenshot but could not figure out how to send the screenshot.  The problem would not happen every time but once in a while.",
        "createdAt": "2020-02-11T02:48:59",
        "reactions": []
      },
      {
        "id": 584579053,
        "author": "mattleibow",
        "body": "You can just copy-paste the screenshot into the comments box. Or even drag the image into the comments. GitHub should just put the image in line. ",
        "createdAt": "2020-02-11T10:55:34",
        "reactions": []
      },
      {
        "id": 584631869,
        "author": "musictopia2",
        "body": "![skiasharperror](https://user-images.githubusercontent.com/39104606/74240338-01ab5600-4c97-11ea-94bc-c2674a28e228.png)\r\n",
        "createdAt": "2020-02-11T13:23:28",
        "reactions": []
      },
      {
        "id": 584632249,
        "author": "musictopia2",
        "body": "Thanks for letting me know.  I tried that and worked.  Here is the full screenshot now.  You can see the stack trace actually showed null.",
        "createdAt": "2020-02-11T13:24:18",
        "reactions": []
      },
      {
        "id": 585071989,
        "author": "mattleibow",
        "body": "Very interesting. Especially without the stack trace. \r\n\r\nAre you able to create a minimal repro at all? I will help to get started. ",
        "createdAt": "2020-02-12T07:37:14",
        "reactions": []
      },
      {
        "id": 585252103,
        "author": "musictopia2",
        "body": "I need help with creating a minimum repro.\r\nWhen the problem happens, the strange thing is it does not happen every time.  Sometimes I can hit new game several times and no problems.  Other times, it happens after 5 times.  When I use the 1.68.0, the problem never happens.  Do you think we can do a visual studio share.  I do know that option is available where you see my code on my machine.",
        "createdAt": "2020-02-12T15:11:45",
        "reactions": []
      },
      {
        "id": 585269020,
        "author": "musictopia2",
        "body": "One question.  If you mean to create a repository of the solution I was working on, I can do that.  What I would do is to copy/paste and make sure they are all the same folder and that would be the repository.  If that would be helpful, I can do that then.  What would happen is I would create it where you can always hit next game.  You will see that sometimes, the issue would happen.  But does not happen every time you do new game though.  The cases where it happens, its always at the beginning of new game.",
        "createdAt": "2020-02-12T15:45:54",
        "reactions": []
      },
      {
        "id": 592238917,
        "author": "mattleibow",
        "body": "It would be great if you managed to get a repro with as little code as possible. Often just by trying to do that you see some weird things.\r\n\r\nBut, I am looking at the code that you have here and maybe something is being disposed...\r\n\r\n\u0060\u0060\u0060csharp\r\nthisCanvas.DrawRect(bounds, tempPaint);\r\nthisCanvas.DrawRect(otherRect, currentPaint);\r\n\u0060\u0060\u0060\r\n\r\nIs it randomly different ones crashing? Or is it always the second one?\r\n\r\nAlso, could it be that one of the paints \u0060_darkGrayPenBrush\u0060 or \u0060_slateGrayPenBrush\u0060 is being disposed?\r\n\r\nWhat you can try and see if it is really this method that is failing is to replace the paints with \u0060new SKPaint()\u0060 or the rects with \u0060SKRect.Create(10, 10)\u0060 or something. This way you can remove any external code from the system.\r\n\r\nAnd, another thing to try is to hit continue and see if there is another exception. Or check the output log for any info. Or, you can even check the \u0022Common Language Runtime Exceptions\u0022 check box in the exceptions window. Maybe there is another exception that causes this exception.\r\n\r\nThe whole thing without the stack trace is weird.\r\n\r\nOne thing you can also try as well is using .NET Core. That might have a better exception.\r\n\r\nThe fact that there is no stack trace may mean that there is an issue with the version of .net framework. We are using portable pdbs, and .net framework _should_ support it, but this file does say that there are a few issues: https://github.com/dotnet/core/blob/master/Documentation/diagnostics/portable_pdb.md Maybe bump the version to net472 or even 48...",
        "createdAt": "2020-02-28T00:00:10",
        "reactions": []
      },
      {
        "id": 592761516,
        "author": "musictopia2",
        "body": "I was actually using .net core 3.1 in wpf.\r\nI would hate to have to use the old framework and not the core.\r\nNot sure if that could be an issue.  I actually had to put some extra code in the project file to eliminate the warnings.  The strange thing is the old version did not have the problem.\r\nAre there plans to have a version that would support the wpf core without the warnings?",
        "createdAt": "2020-02-28T22:37:49",
        "reactions": []
      },
      {
        "id": 599097461,
        "author": "alexandrvslv",
        "body": "I have same behavior\r\n- Win 10 (many hosts)\r\n- Access Violation\r\n- Repeated randomly \r\n- DrawRect method\r\n- only 1.68.1.1\r\n- Xamarin.Forms 4.4\r\n- both UWP(10.0.17763.0) and WPF(net461)\r\n\r\nSteps to reproduce:\r\n1 On start the UI, cache it thread context: \u0060MainContext = SynchronizationContext.Current;\u0060 \r\n2 On paint method use \u0060readonly SKPaint paint\u0060 variables. Calls ~500 DrawRect and DrawText (simple table) per invocation.\r\n3 From background thread often and randomly call Invalidate:\r\n    \u0060MainContext.Post((state) =\u003E((SKCanvasView)state).InvalidateSurface(), canvas);\u0060",
        "createdAt": "2020-03-14T16:54:36",
        "reactions": []
      },
      {
        "id": 601337602,
        "author": "musictopia2",
        "body": "I now have a simple sample to show this always happening eventually.\r\nMy repository is here.\r\nhttps://github.com/musictopia2/SkiaBugSample \r\n\r\nTo see it happening, just click new game.  However, do several times.  Eventually the error will occur.  The problem did not happen with the 1.68.0.",
        "createdAt": "2020-03-19T18:17:08",
        "reactions": []
      },
      {
        "id": 601364961,
        "author": "mattleibow",
        "body": "I think this may be related to #1121, which I am testing a fix with #1180. \r\n\r\nI\u0027ll see if I can get feedback on that ASAP and then fix the rest of the views.",
        "createdAt": "2020-03-19T19:10:54",
        "reactions": []
      },
      {
        "id": 601602028,
        "author": "mattleibow",
        "body": "I have just published the PR (#1180) NuGet (**1.68.2-pr.1180.4**) to the preview feed: https://aka.ms/skiasharp-eap/index.json\r\nThis contains the fixes for macOS, iOS and Android. More platforms coming soon.\r\n\r\nGive that a go and let me know if it fixes the crashes.",
        "createdAt": "2020-03-20T09:17:58",
        "reactions": []
      },
      {
        "id": 601734749,
        "author": "musictopia2",
        "body": "How do I get the private feed one.  I went to the preview on nuget and the latest version still showed 1.68.2-preview.43",
        "createdAt": "2020-03-20T14:40:02",
        "reactions": []
      },
      {
        "id": 601753904,
        "author": "mattleibow",
        "body": "You need to att https://aka.ms/skiasharp-eap/index.json to the feeds for nuget. In VS add a new package source.\r\n\r\nCheck out this doc for a visual guide https://docs.microsoft.com/en-us/nuget/consume-packages/install-use-packages-visual-studio#package-sources ",
        "createdAt": "2020-03-20T15:18:35",
        "reactions": []
      },
      {
        "id": 601780918,
        "author": "musictopia2",
        "body": "![sample](https://user-images.githubusercontent.com/39104606/77182674-61610200-6a8a-11ea-9d21-4526f862c195.png)\r\n\r\nI followed to get the private feeds.  Its still showing the same version that the nuget.org showed as you can see from the screenshot.",
        "createdAt": "2020-03-20T16:09:09",
        "reactions": []
      },
      {
        "id": 601826214,
        "author": "mattleibow",
        "body": "Look in the drop down for 1.68.2-pr.1180.4 as this is a PR preview and it is somewhere in the middle of the previews ",
        "createdAt": "2020-03-20T17:35:31",
        "reactions": []
      },
      {
        "id": 601832174,
        "author": "musictopia2",
        "body": "I found it now.  Just did not realize it would not be at the top.  However, the same problem still occured even with that one.  I was using windows 10 with wpf core.",
        "createdAt": "2020-03-20T17:48:15",
        "reactions": []
      },
      {
        "id": 601840084,
        "author": "mattleibow",
        "body": "OK, might be something else. Is this link still the correct place?\r\n\r\n\u003E https://github.com/musictopia2/SkiaBugSample",
        "createdAt": "2020-03-20T18:06:38",
        "reactions": []
      },
      {
        "id": 601852147,
        "author": "musictopia2",
        "body": "This is still the correct place.",
        "createdAt": "2020-03-20T18:34:21",
        "reactions": []
      },
      {
        "id": 611283210,
        "author": "mattleibow",
        "body": "This is now fixed and no longer crashes on 1.68.2-preview.50",
        "createdAt": "2020-04-09T01:52:30",
        "reactions": []
      },
      {
        "id": 617324002,
        "author": "axel578",
        "body": "@mattleibow \r\n![image](https://user-images.githubusercontent.com/44734791/79897684-55aa8780-840a-11ea-90a3-e441a7ddbf18.png)\r\nThis is what i get when I call too much the InvalidateVisual() method of the SkElement, I used a SKGLControl to make context current and then used a Surface named \u0027Surface\u0027 to draw on it using the Gl context setted up previously, and I pass the \u0027Surface\u0027 snapshot SkImage to the SkElement and it gives me this : System.AccessViolationException\u00A0Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\nI Looked at the GrContext made by the SKGLConttrol and it seems that the GPU memory ( called cache memory ) never gets free and is still growing ( some sort of memory leaks for the GPU ? ) ",
        "createdAt": "2020-04-21T18:04:58",
        "reactions": []
      },
      {
        "id": 617494144,
        "author": "mattleibow",
        "body": "@axel578 I think that is another issue. It is most likely the image is actually a GPU image. Maybe try calling image.ToRasterImage to convert it to memory.\r\n\r\nIf that doesn\u0027t work, then please make a new issue. Thanks! ",
        "createdAt": "2020-04-22T01:30:52",
        "reactions": []
      }
    ]
  }
}