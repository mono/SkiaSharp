{
  "number": 576,
  "type": "issue",
  "state": "open",
  "title": "GPU Accelerated SKSurface Memory Leaks on Integrated HD Graphics",
  "body": "The the issue only occurs when my laptop is attempting to run my application using Intels HD Graphics 520 to render. \r\n\r\n\u0060\u0060\u0060csharp\r\nvar surface = SKSurface.Create(_skiaGlControl.GRContext, false, new SKImageInfo(Width, Height));\r\n//var surface = SKSurface.Create(new SKImageInfo(Width, Height));\r\n_skiaMain.Compose(surface.Canvas, plane);\r\nsurface.Canvas.Flush();\r\n_skiaMain.DisplayImages[plane] = surface.Snapshot();\r\nsurface.Dispose();\r\n_skiaMain.DisplayPlaneRecompose[plane] = false;\r\n\u0060\u0060\u0060\r\n\r\nEvery time I run through this section of code visual studios shows 30-40MB step ups in memory usage until eventually it crashes.  I have desperately used garbage collection as a means to make the program run longer.\r\n\r\n![image](https://user-images.githubusercontent.com/41022806/42469527-fdefdc92-8385-11e8-96d5-cfa8b693ae34.png)\n\n\u003E VS bug [#754180](https://devdiv.visualstudio.com/DevDiv/_workitems/edit/754180)",
  "author": {
    "login": "mclose90",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "area/SkiaSharp",
      "color": "0052cc"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    }
  ],
  "assignees": [
    {
      "login": "mattleibow",
      "type": "User"
    }
  ],
  "createdAt": "2018-07-09T18:40:43",
  "updatedAt": "2019-06-17T16:50:42",
  "commentCount": 2,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:36:27.208185Z",
    "reactions": [],
    "comments": [
      {
        "id": 407266201,
        "author": "mattleibow",
        "body": "This line: \u0060_skiaMain.DisplayImages[plane] = surface.Snapshot();\u0060 may be the cause. What is happening here is that you are making a copy of the surface, and storing it in memory.\r\n\r\nWhat is the size of \u0060_skiaMain.DisplayImages\u0060? Chances are, each image is 30MB.\r\n\r\nA test you can do is to comment out this line: \u0060_skiaMain.Compose(surface.Canvas, plane);\u0060 and see if there is a leak in your drawing code. If it still grows, comment out \u0060_skiaMain.DisplayImages[plane] = surface.Snapshot();\u0060. If it STILL grows, then we have a bad bug.",
        "createdAt": "2018-07-24T03:09:09",
        "reactions": []
      },
      {
        "id": 407450273,
        "author": "mclose90",
        "body": "The issue actually was appearing based on the snapshot() because when I would overwrite the SkImage without disposing first then the ref was getting lost and when it was getting lost in the GPU memory GC.Collect was not cleaning up the lost reference. ",
        "createdAt": "2018-07-24T15:33:31",
        "reactions": []
      }
    ]
  }
}