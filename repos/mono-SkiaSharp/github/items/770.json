{
  "number": 770,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKRegion.Intersects() causes Access Violation and instantly crashes program",
  "body": "**Description**\r\n\r\nI haven\u0027t been able to pin down the _exact_ cause, but from stepping through my code I can see that the instant the code hits a call to SKRegion\u0027s \u0060Intersects()\u0060 method, having been passed an SKRectI to check intersection against, an access violation is reported and the entire program crashes.\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060csharp\r\nusing System;\r\nusing SkiaSharp;\r\n\r\nnamespace Test\r\n{\r\n    static class Extensions\r\n    {\r\n        public static SKRectI ToSKRectI(this SKRect rect)\r\n        {\r\n            return new SKRectI(\r\n                (int)Math.Round(rect.Left),\r\n                (int)Math.Round(rect.Top),\r\n                (int)Math.Round(rect.Right),\r\n                (int)Math.Round(rect.Bottom));\r\n        }\r\n    }\r\n\r\n    class Program\r\n    {\r\n        private static SKSizeI _imageSize { get; } = new SKSizeI(4096, 2304);\r\n        private static string[] _wordList { get; } = new[] { \u0022hello\u0022, \u0022darkness\u0022, \u0022my\u0022, \u0022old\u0022, \u0022friend\u0022 };\r\n        private static Random _random = new Random();\r\n        private static string _filePath = @\u0022C:\\Test\\output.svg\u0022;\r\n\r\n        static void Main(string[] args)\r\n        {\r\n            SKPath wordPath = null;\r\n            Console.WriteLine(\u0022Image size is {0}\u0022, _imageSize.ToString());\r\n\r\n            try\r\n            {\r\n                using (SKRegion occupiedSpace = new SKRegion())\r\n                using (SKPaint brush = new SKPaint())\r\n                using (SKFileWStream streamWriter = new SKFileWStream(_filePath))\r\n                using (SKXmlStreamWriter xmlWriter = new SKXmlStreamWriter(streamWriter))\r\n                using (SKCanvas canvas = SKSvgCanvas.Create(SKRect.Create(_imageSize), xmlWriter))\r\n                {\r\n                    brush.Color = SKColors.Black;\r\n                    foreach (string word in _wordList)\r\n                    {\r\n                        bool next = false;\r\n\r\n                        brush.TextSize = _imageSize.Height / (10 * (Array.IndexOf(_wordList, word) \u002B 1));\r\n                        for (float x = 0; x \u003C= _imageSize.Width; x \u002B= (float)_random.NextDouble() * _imageSize.Width / 100)\r\n                        {\r\n                            for (float y = 0; y \u003C= _imageSize.Width; y \u002B= (float)_random.NextDouble() * _imageSize.Width / 100)\r\n                            {\r\n                                wordPath = brush.GetTextPath(word, x, y);\r\n                                if (!occupiedSpace.Intersects(wordPath.Bounds.ToSKRectI()))\r\n                                {\r\n                                    Console.WriteLine(\u0022Found space for word {0} at {1}\u0022, word, wordPath.Bounds.Location);\r\n                                    canvas.DrawPath(wordPath, brush);\r\n                                    using (SKRegion wordRegion = new SKRegion())\r\n                                    {\r\n                                        wordRegion.SetRect(SKRectI.Create(_imageSize));\r\n                                        wordRegion.SetPath(wordPath);\r\n                                        occupiedSpace.Op(wordRegion, SKRegionOperation.Union);\r\n                                        next = true;\r\n                                    }\r\n                                }\r\n\r\n                                if (next) break;\r\n                            }\r\n\r\n                            if (next) break;\r\n                        }\r\n                    }\r\n\r\n                    // All words written, tidy and ensure file is saved\r\n                    canvas.Flush();\r\n                    streamWriter.Flush();\r\n                }\r\n            }\r\n            finally\r\n            {\r\n                wordPath?.Dispose();\r\n            }\r\n\r\n            Console.WriteLine(\u0022Drawing complete; press Enter to exit\u0022);\r\n            // Wait for exit\r\n            Console.ReadLine();\r\n            Environment.Exit(0);\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nProgram will loop through the word list, attempting to draw each in turn. Console should output found positions as it progresses, and eventually an SVG file would be output at the specified location.\r\n\r\n**Actual Behavior**\r\n\r\nProgram progresses through the first loop and then instantly closes silently. If the application is debugged, an access violation will be reported when the \u0060Intersects()\u0060 method is called.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.0\r\n- Last known good version:  unknown if this ever worked\r\n- IDE:  Visual Studio Code\r\n- Platform Target Frameworks: \r\n  - Windows Classic:  Windows 10\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - PC\r\n\r\n**Reproduction Link**\r\n\r\nhttps://github.com/vexx32/PSWordCloud/tree/Cmdlet/Cmdlet\r\n\r\nThe following PowerShell module attempts to use SkiaSharp to draw a word cloud. \r\n\r\n1. Use \u0060dotnet publish\u0060 to compile the module DLL\r\n2. Open a PowerShell or PowerShell Core console\r\n3. Execute \u0060Import-Module .\\PSWordCloud.psm1\u0060 from a PowerShell console with current location at this folder in the repo: https://github.com/vexx32/PSWordCloud/tree/Cmdlet/Cmdlet\r\n4. Execute the following command in PowerShell and watch it _burn_ :wink:\r\n\r\n\u0060\u0060\u0060powershell\r\n\u0022Hello darkness my old friend\u0022,\u0022I\u0027ve come to talk with you again\u0022 | New-WordCloud -Path $env:TEMP\\test.svg\r\n\u0060\u0060\u0060\r\n\r\n5. Observe the _entire PowerShell application_ crash due to the access violation without warning.\r\n\r\nElsewhere in the repo you can find working code (check the latest release) written in PowerShell utilising System.Drawing for the same task and example pictures and commands to do the same with the published version of the module.\r\n",
  "author": {
    "login": "vexx32",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "milestone": "v1.68.1",
  "createdAt": "2019-01-29T17:50:54",
  "updatedAt": "2022-08-19T12:01:55",
  "closedAt": "2019-01-31T03:10:24",
  "commentCount": 8,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:06:37.015949Z",
    "reactions": [],
    "comments": [
      {
        "id": 458700701,
        "author": "mattleibow",
        "body": "Thanks for the detail. I will investigate and get this fixed as soon as possible. Just been flying around and talking at our local #MSIgniteTheTour",
        "createdAt": "2019-01-29T20:47:10",
        "reactions": [
          {
            "user": "vexx32",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:06:35.414601Z"
          },
          {
            "user": "vexx32",
            "content": "heart",
            "createdAt": "2026-02-06T14:06:35.4146015Z"
          }
        ]
      },
      {
        "id": 458703526,
        "author": "vexx32",
        "body": "Thanks, much appreciated! \uD83D\uDE04 \r\n\r\nHave fun! ^^",
        "createdAt": "2019-01-29T20:56:20",
        "reactions": []
      },
      {
        "id": 459191283,
        "author": "mattleibow",
        "body": "Hehe, I\u0027ll try.",
        "createdAt": "2019-01-31T02:30:36",
        "reactions": []
      },
      {
        "id": 459194079,
        "author": "mattleibow",
        "body": "I had a look and I believe that either Google or I changed the signature of the \u0060Intersects\u0060 method on the native side. It was expecting a region, and I gave it a rect. This should not have happened and I am creating more tests so that this will never happen again.\r\n\r\nThis will be fixed in the next release, but as a temporary workaround, you can just create a region:\r\n\r\n\u0060\u0060\u0060csharp\r\n// the temporary region - you can cache this for performance\r\nvar rectRegion = new SKRegion();\r\n\r\n// set the rect\r\nrectRegion.SetRect(wordPath.Bounds.ToSKRectI());\r\n\r\n// do the test\r\nif (!occupiedSpace.Intersects(rectRegion))\r\n...\r\n\u0060\u0060\u0060",
        "createdAt": "2019-01-31T02:45:39",
        "reactions": []
      },
      {
        "id": 459194706,
        "author": "vexx32",
        "body": "@mattleibow I\u0027ll give that a shot and see if it works. Thank you!",
        "createdAt": "2019-01-31T02:49:08",
        "reactions": []
      },
      {
        "id": 459194796,
        "author": "mattleibow",
        "body": "I also just wanted to let you know about some cool methods that you can use - not as cool as the extension method, but we do have \u0060Round\u0060, \u0060Ceiling\u0060, \u0060Floor\u0060 and \u0060Truncate\u0060 that can be used like this:\r\n\r\n\u0060\u0060\u0060csharp\r\nSKRect floatRect = ...;\r\nSKRectI intRect = SKRectI.Round(floatRect);\r\n\u0060\u0060\u0060\r\n\r\nhttps://docs.microsoft.com/en-us/dotnet/api/skiasharp.skrecti.round?view=skiasharp-1.68.0#SkiaSharp_SKRectI_Round_SkiaSharp_SKRect_",
        "createdAt": "2019-01-31T02:49:43",
        "reactions": [
          {
            "user": "vexx32",
            "content": "heart",
            "createdAt": "2026-02-06T14:06:36.488988Z"
          }
        ]
      },
      {
        "id": 459219649,
        "author": "vexx32",
        "body": "@mattleibow Thank you for the prompt response!\r\n\r\nI recompiled my original version just using regions instead of rectangles and it does seem much more stable.\r\n\r\nInterestingly, this doesn\u0027t actually seem to detect intersections all that well. ([example](https://www.dropbox.com/s/i2xp0kx4xe7kd5z/paterson.test.svg?dl=0))\r\n\r\nI\u0027ll have to see if I can figure out whether that\u0027s my own code here or the Intersects() method once again... similar code does work with the System.Drawing intersection testing methods, though. I\u0027m wondering if the \u0060SKRegion.SetPath()\u0060 and \u0060SKRegion.Op(wordRegion, SKRegionOperation.Union)\u0060 lines are behaving as they ought, but I\u0027m not sure exactly how to test those... Have to dig a little and see what I can see.\r\n\r\nOnce again, thank you! Small progress is progress. \uD83D\uDE04 ",
        "createdAt": "2019-01-31T05:21:45",
        "reactions": []
      },
      {
        "id": 460007400,
        "author": "mattleibow",
        "body": "Good to hear things are just exploding. If you get more information, just open a new issue with any deets!",
        "createdAt": "2019-02-02T23:08:32",
        "reactions": [
          {
            "user": "vexx32",
            "content": "laugh",
            "createdAt": "2026-02-06T14:06:36.9656832Z"
          }
        ]
      }
    ]
  }
}