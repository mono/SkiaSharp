{
  "number": 3049,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Blazor App Crashes in AOT mode with SkiaSharp.HarfBuzz in .NET 8",
  "body": "### Description\n\nThe library SkiaSharp.HarfBuzz does not work at all in AOT mode with .NET 8 and 9, however everything works fine in .NET 7. \r\n![image](https://github.com/user-attachments/assets/164a8fd5-333a-403a-927b-bfb7ef695b57)\r\n\n\n### Code\n\nThe github repo with minimal project to reproduce:\r\nhttps://github.com/elepner/harfbuzzsharp-wasm-aot-bug/tree/report_bug\r\n\r\nPublish the project\r\n\u0060\u0060dotnet publish -c Release -o wasm-output\u0060\u0060\r\nnavigate to the output folder \u0060\u0060wasm-output/wwwroot\u0060\u0060 and start any http-server.\n\n### Expected Behavior\n\nThe app should not crash.\n\n### Actual Behavior\n\n_No response_\n\n### Version of SkiaSharp\n\n2.88.8 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.7 (Previous)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nOther (Please indicate in the description)\n\n### Platform / Operating System Version\n\nBlazor\n\n### Devices\n\nGoogle chrome\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n_No response_\n\n### Code of Conduct\n\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "elepner",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "os/WASM",
      "color": "fbca04"
    },
    {
      "name": "area/SkiaSharp.Views.Blazor",
      "color": "0052cc"
    }
  ],
  "assignees": [],
  "milestone": "3.118.0",
  "createdAt": "2024-10-31T10:22:07",
  "updatedAt": "2024-11-28T16:09:33",
  "closedAt": "2024-11-27T22:52:47",
  "commentCount": 6,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:48:45.5870669Z",
    "reactions": [],
    "comments": [
      {
        "id": 2455549461,
        "author": "mattleibow",
        "body": "Does it work with SkiaSharp 3.0?",
        "createdAt": "2024-11-04T19:39:01",
        "reactions": []
      },
      {
        "id": 2455714093,
        "author": "elepner",
        "body": "If I update \u0060\u0060SkiaSharp.HarfBuzz\u0060\u0060 to the version \u0060\u00603.0.0-preview.5.4\u0060\u0060 along with \u0060\u0060SkiaSharp.NativeAssets.WebAssembly\u0060\u0060 I get the error \r\n\u0060\u0060\u0060\r\nUnhandled exception rendering component: The type initializer for \u0027SkiaSharp.SKObject\u0027 threw an exception.\r\nSystem.TypeInitializationException: The type initializer for \u0027SkiaSharp.SKObject\u0027 threw an exception.\r\n ---\u003E System.InvalidOperationException: The version of the native libSkiaSharp library (116.0) is incompatible with this version of SkiaSharp. Supported versions of the native libSkiaSharp library are in the range [88.1, 89.0).\r\n\u0060\u0060\u0060",
        "createdAt": "2024-11-04T21:13:55",
        "reactions": []
      },
      {
        "id": 2478778593,
        "author": "elepner",
        "body": "I have given a try to run this in .net9 with no success. There\u0027s another error which appears even in Debug mode.\r\n\u0060\u0060\u0060\r\nlogging.ts:43 MONO_WASM: instantiate_wasm_module() failed CompileError: WebAssembly.compileStreaming(): Compiling function #28714:\u0022CompressionNative_Crc32\u0022 failed: expected 1 elements on the stack for fallthru, found 3 @\u002B8898931\r\n\u0060\u0060\u0060\r\nThe code: https://github.com/elepner/harfbuzzsharp-wasm-aot-bug/tree/net9_bug",
        "createdAt": "2024-11-15T13:10:16",
        "reactions": []
      },
      {
        "id": 2501798957,
        "author": "mattleibow",
        "body": "This may be fixed with https://github.com/mono/SkiaSharp/pull/3064\r\n\r\nCan you try the nightly on the preview feed: \u00603.118.0-nightly.27\u0060\r\n\r\n\u0060\u0060\u0060\r\nhttps://aka.ms/skiasharp-eap/index.json\r\n\u0060\u0060\u0060\r\n\r\nLet me know if this fixes it and I will push out the 3.x release.\r\n\r\n**EDIT:** I see my fix was in the Blazor package, so will not reach your project. I got a PR to fix it in all the WASM things.\r\n\r\nA fix for you now with the nightly will be to just install the Blazor package. I hope to have that fix merged ASAP.",
        "createdAt": "2024-11-26T19:53:29",
        "reactions": []
      },
      {
        "id": 2503606260,
        "author": "elepner",
        "body": "I have [checked](https://github.com/elepner/harfbuzzsharp-wasm-aot-bug/commit/2c5eac71a6dbd976d2aba673d260c3a34b58d3ae) this with .NET9 and get same error\r\n\u0060\u0060\u0060\r\nMONO_WASM: instantiate_wasm_module() failed CompileError: WebAssembly.compileStreaming(): Compiling function #28716:\u0022CompressionNative_Crc32\u0022 failed: expected 1 elements on the stack for fallthru, found 3 @\u002B8897861\r\n\u0060\u0060\u0060\r\nThe code: https://github.com/elepner/harfbuzzsharp-wasm-aot-bug/tree/net9_bug",
        "createdAt": "2024-11-27T11:16:13",
        "reactions": []
      },
      {
        "id": 2506443172,
        "author": "elepner",
        "body": "I have checked on this small project version nightly.33 and it works. Thanks @mattleibow! When can one expect this fix published on stable?",
        "createdAt": "2024-11-28T16:09:22",
        "reactions": []
      }
    ]
  }
}