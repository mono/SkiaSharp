{
  "number": 304,
  "type": "issue",
  "state": "closed",
  "title": "Forms: SKCanvasView in ListView glitch",
  "body": "I got an issue with a SKCanvasView when used in a list.  The list is dynamically resized and after many many many redraws, the contexts seem to get messed up and they swap from one row to the other.  So in the following sample, just tap on the names repeatedly (around 20-30 times should do the trick).  My guess is that the bug is alwas there but the amount of redraws makes it easier to reproduce in the below sample.\r\n\r\nhttps://github.com/LeRondPoint/FormsSkiaBikeTracker/tree/SKCanvasViewBug\r\n\r\nThanks",
  "author": {
    "login": "sgravel-dev",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2017-05-25T17:21:22",
  "updatedAt": "2022-08-19T21:01:49",
  "closedAt": "2017-06-14T14:46:13",
  "commentCount": 6,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:57:56.8322291Z",
    "reactions": [],
    "comments": [
      {
        "id": 304167451,
        "author": "mattleibow",
        "body": "This one has been a bit tough to look at. I think I have seen something about what you mention, but I may need more info.\r\n\r\nFirst, what device are you testing on? I tested an iPhone 6s with iOS 10.2\r\n\r\nYou say the contexts get swapped - what are you meaning here? Could you get some screenshot of a bad case?\r\n\r\nI did manage to get some weirdness, when tapping various items repeatedly, two things happened:\r\n\r\n1. The text would randomly change size\r\n2. The text would flicker and sometimes disappear for a few milliseconds.\r\n\r\nThese two issue were mainly cause by the fact that the size of the canvas (SKLabel) was changing as the row expanded or collapsed. This issue disappeared when I set a fixed height to the label element.\r\n\r\nOther then those two issues, I am not sure exactly what you may mean, more info will help a great deal.",
        "createdAt": "2017-05-26T01:32:04",
        "reactions": []
      },
      {
        "id": 304168755,
        "author": "sgravel-dev",
        "body": "Those two issues are what I\u0027m refering to.  The names also get swapped at times, but always keep the same View width, stretching or compressing the contents.  It looks like the wrong memory buffer is being assigned to the Canvas.\r\nTested on iphone 5s 9.3 simulator, iPod touch 4th gen ios 9.3 and iPhone 5 ios 10.2.\r\n\r\nI have a way to reproduce it almost all the time if it helps.  You need to change the SKLabel to the DrawableView base class and rename a few methods (see the CircledImage as a sample).  I\u0027m not exactly sure what is different between both custom renderers to be honest but they behave differently.  If you want the code for the DrawableView I can provide it, given it helps.\r\n\r\nIs there any other way I can help on this?",
        "createdAt": "2017-05-26T01:42:58",
        "reactions": []
      },
      {
        "id": 304265389,
        "author": "sgravel-dev",
        "body": "Using the DrawableView base class, I end up with this :\r\n\u0060\u0060\u0060\r\n// **********************************************************************\r\n// \r\n//   SKLabel.xaml.cs\r\n//   \r\n//   This file is subject to the terms and conditions defined in\r\n//   file \u0027LICENSE.txt\u0027, which is part of this source code package.\r\n//   \r\n//   Copyright (c) 2017, Le rond-point\r\n// \r\n// ***********************************************************************\r\n\r\nusing System;\r\nusing System.IO;\r\nusing LRPLib.Services.Resources;\r\nusing LRPLib.Views.XForms;\r\nusing MvvmCross.Platform;\r\nusing SkiaSharp;\r\nusing SkiaSharp.Views.Forms;\r\nusing Xamarin.Forms;\r\n\r\nnamespace FormsSkiaBikeTracker.Forms.UI.Controls\r\n{\r\n    public class SKLabel : DrawableView\r\n    {\r\n        public static readonly BindableProperty FontResourcePathProperty = BindableProperty.Create(nameof(FontResourcePath), typeof(string), typeof(SKLabel), string.Empty, BindingMode.OneWay, null, FontResourcePathPropertyChanged);\r\n        public static readonly BindableProperty TextProperty = BindableProperty.Create(nameof(Text), typeof(string), typeof(SKLabel), string.Empty, BindingMode.OneWay, null, ResizePropertyChanged);\r\n        public static readonly BindableProperty TextColorProperty = BindableProperty.Create(nameof(TextColor), typeof(Color), typeof(SKLabel), Color.Black, BindingMode.OneWay, null, InvalidatePropertyChanged);\r\n        public static readonly BindableProperty FontSizeProperty = BindableProperty.Create(nameof(FontSize), typeof(double), typeof(SKLabel), 14.0, BindingMode.OneWay, null, ResizePropertyChanged);\r\n        private IResourceLocator _resourceLocator;\r\n\r\n        public string FontResourcePath\r\n        {\r\n            get { return (string)GetValue(FontResourcePathProperty); }\r\n            set { SetValue(FontResourcePathProperty, value); }\r\n        }\r\n\r\n        public string Text\r\n        {\r\n            get { return (string)GetValue(TextProperty); }\r\n            set { SetValue(TextProperty, value); }\r\n        }\r\n\r\n        public Color TextColor\r\n        {\r\n            get { return (Color)GetValue(TextColorProperty); }\r\n            set { SetValue(TextColorProperty, value); }\r\n        }\r\n\r\n        public double FontSize\r\n        {\r\n            get { return (double)GetValue(FontSizeProperty); }\r\n            set { SetValue(FontSizeProperty, value); }\r\n        }\r\n\r\n        private SizeRequest? _LastSize { get; set; }\r\n        private SKPaint _Paint { get; }\r\n        private SKTypeface _Typeface { get; set; }\r\n\r\n        public SKLabel()\r\n        {\r\n            _Paint = new SKPaint();\r\n            _resourceLocator = Mvx.Resolve\u003CIResourceLocator\u003E();\r\n        }\r\n\r\n        ~SKLabel()\r\n        {\r\n            _Typeface?.Dispose();\r\n            _Paint?.Dispose();\r\n\r\n            HasTransparency = true;\r\n        }\r\n\r\n        private static void FontResourcePathPropertyChanged(BindableObject bindable, object oldvalue, object newvalue)\r\n        {\r\n            SKLabel view = bindable as SKLabel;\r\n\r\n            view.RefreshPaint();\r\n            view.RefreshTypeface();\r\n            ResizePropertyChanged(bindable, oldvalue, newvalue);\r\n        }\r\n\r\n        private void RefreshTypeface()\r\n        {\r\n            string resourcePath = _resourceLocator.GetResourcePath(\u0022Fonts\u0022, FontResourcePath);\r\n            Stream resStream = _resourceLocator.ResourcesAssembly.GetManifestResourceStream(resourcePath);\r\n\r\n            _Typeface?.Dispose();\r\n\r\n            if (resStream != null)\r\n            {\r\n                using (resStream)\r\n                {\r\n                    _Typeface = SKTypeface.FromStream(resStream);\r\n                }\r\n            }\r\n            else\r\n            {\r\n                _Typeface = null;\r\n            }\r\n        }\r\n\r\n        private static void InvalidatePropertyChanged(BindableObject bindable, object oldValue, object newValue)\r\n        {\r\n            SKLabel view = bindable as SKLabel;\r\n\r\n            view.RefreshPaint();\r\n            view.Invalidate();\r\n        }\r\n                \r\n        private static void ResizePropertyChanged(BindableObject bindable, object oldValue, object newValue)\r\n        {\r\n            SKLabel view = bindable as SKLabel;\r\n\r\n            view.RefreshPaint();\r\n            view.InvalidateMeasure();\r\n            view.Invalidate();\r\n        }\r\n\r\n        protected override void InvalidateMeasure()\r\n        {\r\n            _LastSize = null;\r\n            base.InvalidateMeasure();\r\n        }\r\n\r\n        protected override SizeRequest OnMeasure(double widthConstraint, double heightConstraint)\r\n        {\r\n            if (_LastSize == null \u0026\u0026 HasSomethingToDraw())\r\n            {\r\n                SKRect textBounds = new SKRect();\r\n                Rectangle requestRect;\r\n\r\n                _Paint.MeasureText(Text, ref textBounds);\r\n                requestRect = textBounds.ToFormsRect();\r\n\r\n                requestRect.Height \u002B= _Paint.FontMetrics.Descent;\r\n                requestRect.Width = Math.Ceiling(Math.Min(requestRect.Width, widthConstraint));\r\n                requestRect.Height = Math.Ceiling(Math.Min(requestRect.Height, heightConstraint));\r\n\r\n                _LastSize = new SizeRequest(requestRect.Size);\r\n            }\r\n\r\n            return _LastSize.GetValueOrDefault(new SizeRequest());\r\n        }\r\n\r\n        protected override void Paint(SKCanvas canvas)\r\n        {\r\n            if (HasSomethingToDraw())\r\n            {\r\n                canvas.DrawText(Text, 0, (float)Height - (_Paint.FontMetrics.Descent * 0.5f), _Paint);\r\n            }\r\n        }\r\n\r\n        private bool HasSomethingToDraw()\r\n        {\r\n            return _Typeface != null \u0026\u0026 !string.IsNullOrEmpty(Text) \u0026\u0026 TextColor != Color.Transparent \u0026\u0026 FontSize \u003E 0;\r\n        }\r\n\r\n        private void RefreshPaint()\r\n        {\r\n            _Paint.Typeface = _Typeface;\r\n            _Paint.Color = TextColor.ToSKColor();\r\n            _Paint.TextSize = (float)FontSize;\r\n            _Paint.IsAntialias = true;\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\nAnd bug...\r\n\r\n![image](https://cloud.githubusercontent.com/assets/15251145/26493661/ca0cedb4-41e8-11e7-9d7e-cd55d730f739.png)\r\n",
        "createdAt": "2017-05-26T11:58:03",
        "reactions": []
      },
      {
        "id": 306615832,
        "author": "sgravel-dev",
        "body": "Hello,\r\nI updated my sample repo to make it easier to isolate the issue.  I removed my custom renderer and am now using the SKCanvasView with a bit of helpers and getting the glitch big time.  My CrawableView class is very simple : \r\n\r\n\u0060\u0060\u0060\r\nusing SkiaSharp;\r\nusing SkiaSharp.Views.Forms;\r\n\r\nnamespace LRPLib.Views.XForms\r\n{\r\n    public abstract class DrawableView : SKCanvasView\r\n    {\r\n        public bool HasTransparency { get; set; }\r\n        public SKPath ClippingPath { get; set; }\r\n\r\n        protected override void OnPaintSurface(SKPaintSurfaceEventArgs e)\r\n        {\r\n            SKCanvas canvas = e.Surface.Canvas;\r\n            float screenDensity = e.Info.Width / (float)Width;\r\n\r\n            canvas.Scale(screenDensity, screenDensity);\r\n             \r\n            if (HasTransparency || ClippingPath != null)\r\n            {\r\n                canvas.Clear();\r\n            }\r\n\r\n            if (ClippingPath != null)\r\n            {\r\n                canvas.ClipPath(ClippingPath);\r\n            }\r\n\r\n            Paint(canvas);\r\n        }\r\n\r\n        protected void Invalidate()\r\n        {\r\n            InvalidateSurface();\r\n        }\r\n\r\n        protected abstract void Paint(SKCanvas canvas);\r\n    }\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2017-06-06T21:00:53",
        "reactions": []
      },
      {
        "id": 308454446,
        "author": "sgravel-dev",
        "body": "Alright so after more investigation, I realized my issue was due to having the Skia bitmaps and Canvas in the renderer instead of in a view.  Since Xamarin reuses renderers in a list, the draw data was being passed from one row to the other, hence causing the glitches.  After using the Skia provided views and renderers and removing possibilities of small resizes due to floating point errors in my OnMeasure, all seems well.\r\n\r\nClosing this issue.",
        "createdAt": "2017-06-14T14:46:11",
        "reactions": []
      },
      {
        "id": 308546504,
        "author": "mattleibow",
        "body": "Great to hear you have things up and running again. I forgot about the fact that renderers are sometimes re-used - especially in lists.",
        "createdAt": "2017-06-14T20:19:56",
        "reactions": []
      }
    ]
  }
}