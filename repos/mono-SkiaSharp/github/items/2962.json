{
  "number": 2962,
  "type": "pr",
  "state": "closed",
  "title": "Implement SkCanvas::SaveLayerRec",
  "body": "**Description of Change**\r\n\r\nImplement SkCanvas::SaveLayerRec\r\n\r\n**Bugs Fixed**\r\n\r\n- Fixes #2773 \r\n\r\n**API Changes**\r\n\r\nAdded: \r\n \r\n\u0060\u0060\u0060cs\r\nclass SKCanvas {\r\n    public int SaveLayer (SKCanvasSaveLayerRec rec)\r\n}\r\n\u0060\u0060\u0060\r\n\r\n\u0060\u0060\u0060cs\r\npublic enum SKCanvasSaveLayerRecFlags {\r\n    None = 0,\r\n    PreserveLcdText = 2,\r\n    InitializeWithPrevious = 4,\r\n    F16ColorType = 16,\r\n}\r\n\u0060\u0060\u0060\r\n\r\n\u0060\u0060\u0060cs\r\npublic unsafe class SKCanvasSaveLayerRec {\r\n    public SKRect? Bounds { get; set; }\r\n    public SKPaint? Paint { get; set; }\r\n    public SKImageFilter? Backdrop { get; set; }\r\n    public SKCanvasSaveLayerRecFlags Flags { get; set; }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Behavioral Changes**\r\n\r\nNone.\r\n\r\n**Required skia PR**\r\n\r\nhttps://github.com/mono/skia/pull/130\r\n\r\n**PR Checklist**\r\n\r\n- [ ] Has tests (if omitted, state reason in description)\r\n- [x] Rebased on top of main at time of PR\r\n- [ ] Merged related skia PRs\r\n- [x] Changes adhere to coding standard\r\n- [ ] Updated documentation\r\n",
  "author": {
    "login": "ahmed605",
    "type": "User"
  },
  "labels": [
    {
      "name": "community \u2728",
      "color": "ededed"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-30T20:20:23",
  "updatedAt": "2025-03-04T13:07:07",
  "closedAt": "2025-03-04T13:04:57",
  "commentCount": 12,
  "reactionCount": 2,
  "draft": false,
  "merged": true,
  "mergedAt": "2025-03-04T13:04:57",
  "mergeableState": "unknown",
  "baseBranch": "main",
  "headBranch": "main",
  "additions": 166,
  "deletions": 8,
  "changedFiles": 5,
  "commits": 7,
  "reviews": [
    {
      "author": "mattleibow",
      "state": "COMMENTED",
      "submittedAt": "2024-08-20T12:48:00"
    }
  ],
  "engagement": {
    "syncedAt": "2026-02-06T12:46:36.3137635Z",
    "reactions": [
      {
        "user": "Gillibald",
        "content": "heart",
        "createdAt": "2026-02-06T12:46:36.3137692Z"
      },
      {
        "user": "Youssef1313",
        "content": "heart",
        "createdAt": "2026-02-06T12:46:36.3137698Z"
      }
    ],
    "comments": [
      {
        "id": 2298745022,
        "author": "mattleibow",
        "body": "Not sure my magic with CI is working with the auto detection of the skia branch (probably because I am not doing it right for forks) so maybe just update the submodule here and we can merge in one go later once the skia PR is merged.",
        "createdAt": "2024-08-20T12:31:30",
        "reactions": []
      },
      {
        "id": 2442017473,
        "author": "mattleibow",
        "body": "/azp run",
        "createdAt": "2024-10-28T16:09:24",
        "reactions": []
      },
      {
        "id": 2442017787,
        "author": "azure-pipelines[bot]",
        "body": "\u003Csamp\u003E\nAzure Pipelines could not run because the pipeline triggers exclude this branch/path.\u003Cbr\u003E\r\n\n\u003C/samp\u003E",
        "createdAt": "2024-10-28T16:09:32",
        "reactions": []
      },
      {
        "id": 2452345737,
        "author": "ramezgerges",
        "body": "@mattleibow Hello, I\u0027m an Uno Platform dev and I\u0027m following up on this PR (and [the accompanying mono/skia PR](https://github.com/mono/skia/pull/130)). I haven\u0027t actually tested the new APIs yet, but here are my thoughts.\r\n\r\n* The \u0060SaveLayer\u0060 signature that takes an \u0060SKCanvasSaveLayerRec\u0060 (instead of individual components) seems to be identical to the C\u002B\u002B API, so it makes sense. \r\n* Shouldn\u0027t we make \u0060SKCanvasSaveLayerRec\u0060 a struct instead? It seems to be something you create, immediately pass to \u0060SaveLayer\u0060, and then throw away. The example in google/skia (https://github.com/google/skia/blob/d2ac2b0d6467fdca614bd85b49bf01363fe94604/docs/examples/Canvas_SaveLayerRec.cpp#L15) confirms this.",
        "createdAt": "2024-11-01T18:08:33",
        "reactions": []
      },
      {
        "id": 2454677735,
        "author": "mattleibow",
        "body": "Thanks for the review @ramezgerges, this makes sense today with the small struct. But, if you look at the latest skia, does your thought still seem valid? The struct is getting fairly large: https://github.com/google/skia/blob/main/include/core/SkCanvas.h#L689 There are new properties to be added - color space, image filters as well as a collection/array of image filters.\r\n\r\nNot sure either way here, but at what point to we think a class is better? Will we ever re-use this object for multiple calls?\r\n\r\nI was also thinking that due to the large-ish size and potentially fairly complex nature, it should be a class: https://learn.microsoft.com/dotnet/standard/design-guidelines/choosing-between-class-and-struct\r\n\r\nHowever, rules in .NET are just best ideas for most cases, not the law. So, maybe we can break it. But, a struct may still be the best. Not sure if any of this changes anything? Let me know if you still think a struct is better.",
        "createdAt": "2024-11-04T13:10:15",
        "reactions": []
      },
      {
        "id": 2454773194,
        "author": "ramezgerges",
        "body": "Thanks for getting back to me, @mattleibow. Just to be clear, the struct-vs-class point is merely a suggestion/observation, and I\u0027m okay with the PR either way.\r\n\r\n* I didn\u0027t notice the new properties that were added. However, I think the argument is still the same: assuming that 99% of the usescases follow the \u0022Create a SaveLayerRec -\u003E Immediately give it to \u0060SaveLayer\u0060 -\u003E forget about it\u0022 pattern, then allocating a new object every time seems wasteful. If we\u0027re worried about the cost of copying, then can\u0027t we just make \u0060SaveLayer\u0060 take a \u0060ref\u0060 (or a \u0060ref readonly\u0060) parameter? i.e.\r\n\u0060public int SaveLayer (ref readonly SKCanvasSaveLayerRec rec)\u0060\r\n\r\n* If we keep it as a class, can we instead add a \u0060Reset\u0060 method to reset the SaveLayerRec to its initial state? We\u0027ve had to deal with excessive SKPath/SKPaint allocations in our main loop before and the workaround I did was to use an ObjectPool \u002B a \u0060Reset()\u0060 call to get a \u0022fresh\u0022 SKPath/SKPaint.",
        "createdAt": "2024-11-04T13:51:49",
        "reactions": []
      },
      {
        "id": 2686035751,
        "author": "mattleibow",
        "body": "/azp run",
        "createdAt": "2025-02-26T19:47:11",
        "reactions": []
      },
      {
        "id": 2686036019,
        "author": "azure-pipelines[bot]",
        "body": "\u003Csamp\u003E\nAzure Pipelines could not run because the pipeline triggers exclude this branch/path.\u003Cbr\u003E\r\n\n\u003C/samp\u003E",
        "createdAt": "2025-02-26T19:47:18",
        "reactions": []
      },
      {
        "id": 2686048379,
        "author": "mattleibow",
        "body": "@ramezgerges Sorry for the super long wait. I think your comments are the way to go, so I have updated the rec type to be a struct and also use the new \u0060in\u0060 keywork so that we don\u0027t make a copy of the struct either.\r\n\r\nLet me know if this will work for you and if there are any other changes that you think need to be made.",
        "createdAt": "2025-02-26T19:52:43",
        "reactions": [
          {
            "user": "angelofb",
            "content": "hooray",
            "createdAt": "2026-02-06T12:46:35.5113147Z"
          }
        ]
      },
      {
        "id": 2691330044,
        "author": "ramezgerges",
        "body": "@mattleibow No worries. I tested the CI packages today and things are working great!",
        "createdAt": "2025-02-28T18:49:12",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "heart",
            "createdAt": "2026-02-06T12:46:35.7668972Z"
          }
        ]
      },
      {
        "id": 2697507118,
        "author": "mattleibow",
        "body": "Thanks for creating this PR and sticking with it for a year :)\r\n\r\nI have merged and it should go out into the preview feed shortly. If there are any issues or adjustments, feel free to open a PR.\r\n\r\nThanks again!",
        "createdAt": "2025-03-04T13:06:01",
        "reactions": [
          {
            "user": "michaldobrodenka",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:46:36.0057515Z"
          },
          {
            "user": "angelofb",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:46:36.0057521Z"
          },
          {
            "user": "Nebula-Developer",
            "content": "hooray",
            "createdAt": "2026-02-06T12:46:36.0057522Z"
          }
        ]
      },
      {
        "id": 2697511127,
        "author": "jeromelaban",
        "body": "Many thanks @mattleibow!",
        "createdAt": "2025-03-04T13:07:06",
        "reactions": []
      }
    ]
  }
}