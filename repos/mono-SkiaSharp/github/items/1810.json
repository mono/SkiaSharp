{
  "number": 1810,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Text measuring issue when calculating width using  SkiaSharp.HarfBuzz",
  "body": "**Description**\r\nText width not measured properly when measuring using  SkiaSharp.HarfBuzz library.\r\n\r\nI am using SkiaSharp.HarfBuzz for unicode text measuring, which works properly for Arabic.\r\nBut, don\u0027t know why this same code not works for normal text.\r\n\r\n**Code**\r\n_____________________________________________________________________________________________________________\r\n\r\n\r\n            Console.WriteLine(\u0022Text: \u0022 \u002B text);\r\n            Console.WriteLine(\u0022Font Name :\u0022 \u002B fontName);\r\n            Console.WriteLine(\u0022Font Size :\u0022 \u002B fontSize);\r\n\r\n            Console.WriteLine(\u0022SkiaSharp.HarfBuzz v2.80.2\u0022);\r\n\r\n            Console.WriteLine(\u0022GDI Width = \u0022 \u002B GDIMeasuring(text, fontSize, fontName));\r\n            Console.WriteLine(\u0022SkiaSharp Width = \u0022 \u002B SkiaMeasurng(text, fontSize, fontName));\r\n            Console.WriteLine(\u0022SkiaSharp.HarfBuzz width = \u0022 \u002B HarfbuffMeasuring(text, fontSize, fontName));\r\n            Console.ReadKey();\r\n\r\n        \r\n        private static float SkiaMeasurng(string text2, float fontsize, string fontName)\r\n        {\r\n            float skiaMeasurement = 0;\r\n            SKFontStyleWeight weight = SKFontStyleWeight.Normal;\r\n            SKFontStyleSlant sKFontStyleSlant = SKFontStyleSlant.Upright;\r\n            SKFontStyleWidth sKFontStyleWidth = SKFontStyleWidth.Normal;\r\n            using (SKPaint paint = new SKPaint())\r\n            {\r\n                paint.Typeface = SKTypeface.FromFamilyName(fontName, weight, sKFontStyleWidth, sKFontStyleSlant);\r\n                paint.Color = SKColors.Black;\r\n                paint.IsAntialias = true;\r\n                paint.TextSize = fontsize;\r\n                paint.SubpixelText = true;\r\n                paint.TextAlign = SKTextAlign.Left;\r\n                paint.TextEncoding = SKTextEncoding.Utf8;\r\n\r\n                SKRect rect = new SKRect();\r\n                skiaMeasurement = paint.MeasureText(text2, ref rect);\r\n                return skiaMeasurement;\r\n            }\r\n        }\r\n        private static float GDIMeasuring(string text, float fontSize, string fontName)\r\n        {\r\n            Bitmap bitmap = new Bitmap(540, 720);\r\n            Graphics graphics = Graphics.FromImage(bitmap);\r\n            // Create string to draw.\r\n            String drawString = text;\r\n            graphics.FillRectangle(Brushes.White, new System.Drawing.Rectangle(0, 0, (int)540, (int)720));\r\n            // Create font and brush.\r\n            Font drawFont = new Font(fontName, fontSize, FontStyle.Regular, GraphicsUnit.Point);\r\n            SolidBrush drawBrush = new SolidBrush(Color.Black);\r\n            StringFormat drawFormat = new StringFormat(StringFormat.GenericTypographic);\r\n            //remove the linelimit flag from create stringformat object.\r\n            //The behavior of the linelimit flag is \u201Conly entire lines are laid out in the formatting rectangle\u201D, \r\n            //By default layout continues until the end of the text, or until no more lines are visible as a result of clipping\u201D.\r\n            drawFormat.FormatFlags \u0026= ~StringFormatFlags.LineLimit;\r\n            drawFormat.FormatFlags |= StringFormatFlags.MeasureTrailingSpaces;\r\n            drawFormat.FormatFlags |= StringFormatFlags.NoClip;\r\n            graphics.PageUnit = GraphicsUnit.Point;\r\n\r\n            drawFormat.Trimming = StringTrimming.Word;\r\n            return graphics.MeasureString(drawString, drawFont, new PointF(0, 0), drawFormat).Width;\r\n        }\r\n        private static float HarfbuffMeasuring(string text, float fontsize, string fontName)\r\n        {\r\n            SKFontStyleWeight weight = SKFontStyleWeight.Normal;\r\n            SKFontStyleSlant sKFontStyleSlant = SKFontStyleSlant.Upright;\r\n            SKFontStyleWidth sKFontStyleWidth = SKFontStyleWidth.Normal;\r\n            using (SKPaint paint = new SKPaint())\r\n            {\r\n                paint.Typeface = SKTypeface.FromFamilyName(fontName, weight, sKFontStyleWidth, sKFontStyleSlant);\r\n                paint.Color = SKColors.Black;\r\n                paint.IsAntialias = true;\r\n                paint.TextSize = fontsize;\r\n                paint.SubpixelText = true;\r\n                paint.TextAlign = SKTextAlign.Left;\r\n                paint.TextEncoding = SKTextEncoding.Utf8;\r\n\r\n                using (var blob = paint.Typeface.OpenStream().ToHarfBuzzBlob())\r\n                using (var hbface = new Face(blob, 0))\r\n                {\r\n                    using (var hbFont = new HarfBuzzSharp.Font(hbface))\r\n                    {\r\n                        using (var buffer = new HarfBuzzSharp.Buffer())\r\n                        {\r\n                            buffer.AddUtf16(text);\r\n                            buffer.GuessSegmentProperties();\r\n                            hbFont.Shape(buffer);\r\n\r\n                            hbFont.GetScale(out var xScale, out _);\r\n                            var scale = fontsize / xScale;\r\n                            return buffer.GlyphPositions.Sum(x =\u003E x.XAdvance) * scale;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n____________________________________________________________________________________________________________________________________\r\n\r\n**Expected Behavior**\r\n\r\nWidth should be same as GDI.\r\n\r\n**Actual Behavior**\r\n\r\nYou can see SkiaSharp.HarfBuzz returns improper value,\r\n![image](https://user-images.githubusercontent.com/41197331/133606038-9c390940-fea7-4dd6-b266-adc9ea16829e.png)\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  SKiaSharp.HarfBuzz v2.80.2\r\n- IDE:  Visual Studio \r\n- Platform Target Frameworks: \r\nASP.NET Core platform. \r\nI planned to use this in Windows, Linux, Mac and other platforms\r\n\r\n  \r\n\r\n**Reproduction Link**\r\nYou can run the above code and refer the screenshot\r\n\r\n\r\nPlease suggest the solution. Is the above approach is valid for measuring text using HarfBuzz?\r\n\r\n",
  "author": {
    "login": "MohanaselvamJ",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2021-09-16T12:00:50",
  "updatedAt": "2021-11-01T18:12:05",
  "commentCount": 4,
  "reactionCount": 1
}