{
  "number": 3204,
  "type": "issue",
  "state": "open",
  "title": "android call dotnet aot draw skbitmap has flickering problem",
  "body": "### Description\n\nAfter referring to the project [https://github.com/jonathanpeppers/Android-NativeAOT], I have a android studio project also want to draw skbitmap by the  jni bridge and skiasharp,if i draw a single bitmap,it is work ok,However, if keep drawing, the problem of flickering will occur \uFF0Cthe main source code as follows,please help how to fixed this bug ,thanks\n\n\n\n\n\n### Code\n\n**GLSurfaceView.Renderer**\n\u0060public class VinnoGLRender implements GLSurfaceView.Renderer {\n\n    private VinnoGLView glView;\n\n    public VinnoGLRender(VinnoGLView v) {\n        Net2Native.getInstance().setVinnoGLView(this);\n        glView = v;\n    }\n\n    @Override\n    public void onSurfaceCreated(GL10 gl10, EGLConfig eglConfig) {\n        Log.d(\u0022VinnoGLRender\u0022, \u0022onSurfaceCreated:\u0022 \u002B Net2Native.getInstance().nativeThreadId());\n        //VinnoBridge.glInit();\n        GLES20.glClearColor(0.0f, 0.0f, 0.0f, 1.0f);\n    }\n\n    @Override\n    public void onSurfaceChanged(GL10 gl10, int w, int h) {\n        Log.d(\u0022VinnoGLRender\u0022, \u0022onSurfaceChanged:\u0022 \u002B Net2Native.getInstance().nativeThreadId());\n        VinnoBridge.glResize(w, h);\n    }\n\n    @Override\n    public void onDrawFrame(GL10 gl10) {\n        //Log.d(\u0022VinnoGLRender\u0022,\u0022onDrawFrame:\u0022 \u002B Net2Native.getInstance().nativeThreadId());\n        VinnoBridge.glDraw();\n    }\n\n    public void Refresh() {\n        //glView.queueEvent();\n        glView.requestRender();\n    }\n}\u0060\n\n**JniBridge**\n\u0060extern \u0022C\u0022 JNIEXPORT void JNICALL Java_com_vinno_sdk_VinnoBridge_glResize(JNIEnv *env, jclass clazz, jint width, jint height)\n{\n    VSkiaResize(width,height);\n}\n\nextern \u0022C\u0022 JNIEXPORT void JNICALL Java_com_vinno_sdk_VinnoBridge_glDraw(JNIEnv *env, jclass clazz)\n{\n    VSkiaDrawFrame();\n}\u0060\n\n**C# Render**\n\u0060using SkiaSharp;\nusing Vinno.Infrastructure;\n\nnamespace Vinno.Sdk.GLES\n{\n    public class GLRender\n    {\n        private const SKColorType colorType = SKColorType.Rgba8888;\n        private const GRSurfaceOrigin surfaceOrigin = GRSurfaceOrigin.BottomLeft;\n        private GRContext context = null;\n        private GRGlFramebufferInfo glInfo;\n        private GRBackendRenderTarget renderTarget;\n        private SKSurface surface;\n        private SKCanvas canvas;\n        \n        private SKSizeI lastSize;\n        private SKSizeI newSize;\n\t\tprivate SKBitmap _backBm;\n\n        public void Render()\n        {\n            GLES20.glClear(GLES20.COLOR_BUFFER_BIT | GLES20.DEPTH_BUFFER_BIT | GLES20.STENCIL_BUFFER_BIT);\n\n            // create the contexts if not done already\n            if (context == null)\n            {\n                var glInterface = GRGlInterface.Create();\n                context = GRContext.CreateGl(glInterface);\n                Logger.ForceWriteLine($\u0022GLRender.Render init  GRContext successful:{context}\u0022);\n            }\n\n            // manage the drawing surface\n            if (renderTarget == null || lastSize != newSize || !renderTarget.IsValid)\n            {\n                // create or update the dimensions\n                lastSize = newSize;\n\n                // read the info from the buffer\n                GLES20.glGetIntegerv(GLES20.FRAMEBUFFER_BINDING, out int frame);\n                GLES20.glGetIntegerv(GLES20.STENCIL_BITS, out int stencil);\n                GLES20.glGetIntegerv(GLES20.SAMPLES, out int samples);\n                var maxSamples = context.GetMaxSurfaceSampleCount(colorType);\n                if (samples \u003E maxSamples)\n                {\n                    samples = maxSamples;\n                }\n                glInfo = new GRGlFramebufferInfo((uint)frame, colorType.ToGlSizedFormat());\n\n                // destroy the old surface\n                surface?.Dispose();\n                surface = null;\n                canvas = null;\n\n                // re-create the render target\n                renderTarget?.Dispose();\n                renderTarget = new GRBackendRenderTarget(newSize.Width, newSize.Height, samples, stencil, glInfo);\n                Logger.ForceWriteLine($\u0022GLRender.Render init  GRBackendRenderTarget successful:frame[{frame}],stencil[{stencil}],samples[{samples}]\u0022);\n            }\n\n            // create the surface\n            if (surface == null)\n            {\n                surface = SKSurface.Create(context, renderTarget, surfaceOrigin, colorType);\n                canvas = surface.Canvas;\n                Logger.ForceWriteLine($\u0022GLRender.Render init  SKSurface successful:{surface}\u0022);\n            }\n\n            // flush the SkiaSharp contents to GL\n            if (canvas != null)\n            {\n\t\t\t\tif (_backBm == null)\n\t\t\t\t{\n\t\t\t\t\t_backBm = new SKBitmap(new SKImageInfo(950, 1000, SKColorType.Rgba8888));\n\t\t\t\t}\n                using (new SKAutoCanvasRestore(canvas, true))\n                {\n                    canvas.Clear(SKColors.Transparent);\n                    \n\t\t\t\t\tRandom rd = new Random();\n\t\t\t\t\tbyte r = (byte)rd.Next(255);\n\t\t\t\t\tbyte g = (byte)rd.Next(255);\n\t\t\t\t\tbyte b = (byte)rd.Next(255);\n\t\t\t\t\tbyte a = (byte)rd.Next(255);\n\t\t\t\t\t_backBm.Erase(new SKColor(r,g,b,a));\n\t\t\t\t\tcanvas.DrawBitmap(_backBm,0,0,null);\n                }\n                context.Flush(true,true);\n            }\n        }\n\n        public void Resize(int width, int height)\n        {\n            Logger.ForceWriteLine($\u0022GLRender.Resize({width}, {height})\u0022);\n            try\n            {\n                GLES20.glViewport(0, 0, width, height);\n\n                // get the new surface size\n                newSize = new SKSizeI(width, height);\n            }\n            catch (Exception exc)\n            {\n                Logger.ForceWriteLine($\u0022GLRender.Resize error:{exc.StackTrace}\u0022);\n            }\n        }\n\t\t\n    }\n}\n\u0060\n\n\n### Expected Behavior\n\ncan keep drawing skbitmap without flickering\n\n### Actual Behavior\n\nkeep drawing skbitmap with flickering\n\n### Version of SkiaSharp\n\n3.118.0-preview.2 (Next Preview)\n\n### Last Known Good Version of SkiaSharp\n\n3.118.0-preview.2 (Next Preview)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nAndroid\n\n### Platform / Operating System Version\n\n\nvisualstudio 2022\n\ndotnet 9\n\nskiasharp 3.118.0-preview.2.3\n\nandroid studio 2024\n\n### Devices\n\n_No response_\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n\u0060\u0060\u0060shell\n\n\u0060\u0060\u0060\n\n### Code of Conduct\n\n- [x] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "llzz19851985",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2025-03-15T07:35:29",
  "updatedAt": "2025-04-16T18:38:30",
  "commentCount": 1,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T19:53:37.6792077Z",
    "reactions": [],
    "comments": []
  }
}