{
  "number": 1621,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SkBitmap.Decode always fail some images, but using SKImage.FromEncodedData works ",
  "body": "**Description**\r\n\r\nI am trying to load images in UWP with StorageFile, but some images always fail with a weird error message. \r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\nusing (var stream = await storageFile.OpenStreamForReadAsync())\r\n{\r\n    SKBitmap bitmap = SKBitmap.Decode(stream);\r\n    // the rest\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nthe image should be loaded\r\n\r\n**Actual Behavior**\r\n\r\nsome pictures fail at the line of calling SKBitmap.Decode, with this error message:\r\n\r\n\u0060\u0060\u0060\r\nValue cannot be null.\r\nParameter name: buffer\r\n\u0060\u0060\u0060\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.80.3-preview.24\r\n- Last known good version:  N/A\r\n- IDE:  VS.NET\r\n- Platform Target Frameworks: 10.0.19041.0 - 10.0.17763.0\r\n  - Android: \u003C!-- the version of the Android SDK you are compiling against, e.g. 7.1 --\u003E \r\n  - iOS:  \u003C!-- the version of the iOS SDK you are compiling against, e.g. 11.1 --\u003E\r\n  - Linux:  \u003C!-- The version and distro of linux that you are building for, e.g. Ubuntu 16.04 --\u003E\r\n  - macOS:  \u003C!-- The version of macOS you are building for, e.g. 10.10 --\u003E\r\n  - Tizen:  \u003C!-- the version of the Tizen SDK you are compiling against, e.g. 4.0 --\u003E \r\n  - tvOS:  \u003C!-- the version of the tvOS SDK you are compiling against, e.g. 11.1 --\u003E\r\n  - UWP:  6.2.10\r\n  - watchOS:  \u003C!-- the version of the watchOS SDK you are compiling against, e.g. 11.1 --\u003E\r\n  - Windows Classic:  \u003C!-- the version of Windows you are building for, e.g. Windows 7 --\u003E\r\n- Target Devices:   x64\r\n  \r\n** Details ** \r\n\r\nThe manifest permission is all opened. For those images that fail, I can call \u0060GetThumbnailAsync\u0060 properly. \r\n\r\nMoreover, the stream is not null, I added the following code: \r\n\r\n\u0060\u0060\u0060\r\n                        if (stream.CanRead \u0026\u0026 stream.CanSeek)\r\n                        {\r\n                            stream.Seek(0, SeekOrigin.Begin);\r\n                        }\r\n\u0060\u0060\u0060\r\n\r\nthese lines pass, and the \u0060Decode\u0060 still failed. \r\n\r\nHowever, if I do this instead: \r\n\r\n\u0060\u0060\u0060\r\nSKImage img = SKImage.FromEncodedData(stream);\r\nSKBitmap bitmap = SKBitmap.FromImage(img);\r\n\u0060\u0060\u0060  \r\n\r\nNow those images can be loaded. \r\n\r\nbut why? \r\n\r\n**Screenshots**\r\n\r\nI uploaded one failed image in SO: \r\nhttps://stackoverflow.com/questions/66096184/why-does-skiasharp-fail-to-load-some-image-in-uwp-when-calling-skbitmap-decode\r\n\r\n**Reproduction Link**\r\n\r\n\u003C!-- please upload or provide a link to a reproduction case --\u003E\r\n\r\n",
  "author": {
    "login": "sowenzhang",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "v2.88.3",
  "createdAt": "2021-02-09T15:09:58",
  "updatedAt": "2022-10-29T09:01:17",
  "closedAt": "2022-09-29T06:55:01",
  "commentCount": 9,
  "reactionCount": 9,
  "engagement": {
    "syncedAt": "2026-02-06T13:48:29.5084132Z",
    "reactions": [
      {
        "user": "intenzive",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.508418Z"
      },
      {
        "user": "webseb",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084186Z"
      },
      {
        "user": "stesee",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084188Z"
      },
      {
        "user": "basvis",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.508419Z"
      },
      {
        "user": "drk-mtr",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084192Z"
      },
      {
        "user": "rheusinkveld",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084193Z"
      },
      {
        "user": "NicoloBeltrame",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084198Z"
      },
      {
        "user": "91378246",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.50842Z"
      },
      {
        "user": "ThinkElevenDave",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:48:29.5084201Z"
      }
    ],
    "comments": [
      {
        "id": 776072938,
        "author": "mattleibow",
        "body": "Are you able to attach the file here in a zip? These websites like to process them. ",
        "createdAt": "2021-02-09T16:40:09",
        "reactions": []
      },
      {
        "id": 776090604,
        "author": "sowenzhang",
        "body": "yes, sorry, I was distracted after I quickly post the bug. \r\n\r\nThere are 2 photos in the folder \u0060Photos\u0060, the 4.jpg cannot be loaded but the other one works fine. \r\n\r\nIf you change the code to: using SKImage to read stream and then load into SKBitmap, then it works. \r\n\r\n[SkiaLoadTest.zip](https://github.com/mono/SkiaSharp/files/5952921/SkiaLoadTest.zip)\r\n",
        "createdAt": "2021-02-09T17:04:40",
        "reactions": []
      },
      {
        "id": 880470398,
        "author": "intenzive",
        "body": "I am experiencing the exact same behaviour with some images exported from Photoshop.\r\nDo we have information why this is happening? ",
        "createdAt": "2021-07-15T07:39:42",
        "reactions": []
      },
      {
        "id": 886046512,
        "author": "glintpursuit",
        "body": "SKBitmap bitMap = SKBitmap.FromImage(SKImage.FromEncodedData(new MemoryStream(mediaFileBytearray))); \r\n\r\nDoes not work using SKImage too \r\n\r\nskia version 2.80.3 ",
        "createdAt": "2021-07-24T12:26:33",
        "reactions": [
          {
            "user": "taublast",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.4185548Z"
          },
          {
            "user": "Jacko1394",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.4185553Z"
          },
          {
            "user": "ThinkElevenDave",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.4185554Z"
          }
        ]
      },
      {
        "id": 889044692,
        "author": "mattleibow",
        "body": "Duplicate of #1551",
        "createdAt": "2021-07-29T11:37:47",
        "reactions": []
      },
      {
        "id": 895436918,
        "author": "taublast",
        "body": "Can it do anything with \u0022some images\u0022 are thoses with specific metadata, causing this to happen?.. \r\n\r\nI have the following error happening with stable 2.80.3 on iOS 14.x (on iOS 12.x it\u0027s not happening):\r\n\r\n\u0060var bitmap = SKBitmap.Decode(stream);\u0060\r\n\r\ncrash boom bang:\r\n\r\n\u0060\u0060\u0060\r\n{System.ArgumentNullException: Value cannot be null.\r\nParameter name: buffer\r\n  at SkiaSharp.SKManagedStream.OnReadManagedStream (System.IntPtr buffer, System.IntPtr size) [0x0000d] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at SkiaSharp.SKManagedStream.OnRead (System.IntPtr buffer, System.IntPtr size) [0x00006] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at SkiaSharp.SKAbstractManagedStream.ReadInternal (System.IntPtr s, System.Void* context, System.Void* buffer, System.IntPtr size) [0x00015] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at (wrapper native-to-managed) SkiaSharp.SKAbstractManagedStream.ReadInternal(intptr,void*,void*,intptr)\r\n  at (wrapper managed-to-native) SkiaSharp.SkiaApi.sk_codec_new_from_stream(intptr,SkiaSharp.SKCodecResult*)\r\n  at SkiaSharp.SKCodec.Create (SkiaSharp.SKStream stream, SkiaSharp.SKCodecResult\u0026 result) [0x0003b] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at SkiaSharp.SKCodec.Create (System.IO.Stream stream, SkiaSharp.SKCodecResult\u0026 result) [0x00006] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at SkiaSharp.SKCodec.Create (System.IO.Stream stream) [0x00000] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n  at SkiaSharp.SKBitmap.Decode (System.IO.Stream stream) [0x0000e] in \u003C870e9db956e7461cb750c2b6d9037f6f\u003E:0 \r\n\u0060\u0060\u0060\r\n\r\n\r\nDowngrading to 2.80.2 solved it.. \r\n",
        "createdAt": "2021-08-09T18:19:22",
        "reactions": [
          {
            "user": "sowenzhang",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665663Z"
          },
          {
            "user": "texaclou",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665667Z"
          },
          {
            "user": "webseb",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665668Z"
          },
          {
            "user": "funwaywang",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665669Z"
          },
          {
            "user": "stesee",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.866567Z"
          },
          {
            "user": "fr4gles",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665671Z"
          },
          {
            "user": "rheusinkveld",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665672Z"
          },
          {
            "user": "91378246",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665672Z"
          },
          {
            "user": "ThinkElevenDave",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:48:28.8665673Z"
          }
        ]
      },
      {
        "id": 947343119,
        "author": "ThanhNg",
        "body": "\u0022Some images\u0022 are landscape-oriented images, portrait works. Hope it helps.",
        "createdAt": "2021-10-20T05:34:13",
        "reactions": []
      },
      {
        "id": 1046670681,
        "author": "max-kroell",
        "body": "I am getting the same errors for images with a high DPI (300). Images with lower ones (\u003C 96) are working fine. Any ideas why this is the case?",
        "createdAt": "2022-02-21T09:46:47",
        "reactions": []
      },
      {
        "id": 1261739270,
        "author": "mattleibow",
        "body": "Hi folks. Sorry it took forever to fix this - especially since it was so simple and totally my fault. I will try get a package out ASAP after this merges: https://github.com/mono/SkiaSharp/pull/2265",
        "createdAt": "2022-09-29T04:29:16",
        "reactions": []
      }
    ]
  }
}