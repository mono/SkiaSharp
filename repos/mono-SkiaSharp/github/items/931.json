{
  "number": 931,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Color of jpeg image changed after decode/encode",
  "body": "**Description**\r\nAfter decoding and encoding image it\u0027s color is changed (blue color becomes brighter). The latest (1.68) version is used, tested on Windows.\r\n\r\n**Code**\r\n\r\nusing (FileStream inputStream = File.Open(@\u0022C:\\Temp\\in.jpeg\u0022, FileMode.Open))\r\nusing (SkiaSharp.SKBitmap bmp = SkiaSharp.SKBitmap.Decode(inputStream))\r\nusing (SkiaSharp.SKFileWStream outputStream = new SkiaSharp.SKFileWStream(@\u0022C:\\Temp\\out.jpeg\u0022))\r\n{\r\n        SkiaSharp.SKPixmap.Encode(outputStream, bmp, SkiaSharp.SKEncodedImageFormat.Jpeg, 100);\r\n}\r\n\r\n**Expected Behavior**\r\n\r\nThe result image must look the same as input. Attached input and output images.\r\n![in](https://user-images.githubusercontent.com/31235892/63153083-1ecbd880-c016-11e9-9559-dafdd0c748c0.jpeg)\r\n![out](https://user-images.githubusercontent.com/31235892/63153084-1ecbd880-c016-11e9-8563-a512c773dda1.jpeg)",
  "author": {
    "login": "AlexNosk",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "milestone": "v2.88.x Planning",
  "createdAt": "2019-08-16T08:10:00",
  "updatedAt": "2024-12-04T00:50:13",
  "commentCount": 23,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-06T12:48:38.8900563Z",
    "reactions": [
      {
        "user": "AndersMad",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:48:38.8900613Z"
      }
    ],
    "comments": [
      {
        "id": 522571959,
        "author": "AndersMad",
        "body": "I can confirm that using above image - using both bitmap and image - and the SkImage will make it entirely black on downscaling (#932).",
        "createdAt": "2019-08-19T13:21:09",
        "reactions": []
      },
      {
        "id": 623021858,
        "author": "mattleibow",
        "body": "What happens if you try \u0060SKImage.FromEncodedData\u0060? The bitmap loses it\u0027s colorspace information for backwards compatibility.",
        "createdAt": "2020-05-02T22:08:09",
        "reactions": []
      },
      {
        "id": 623087496,
        "author": "AndersMad",
        "body": "in this project I cannot access \u0060SKData\u0060 but I did Q1 from here https://github.com/mono/SkiaSharp/issues/1269 and that should be about the same right? being all codec and image - and see my Q to your A on Q1 there :) I\u0027m am using that to test this (last) color bug with... I had this in my code too - must have been there for a (older) reason: \u0060if (!info.ColorSpace.IsSrgb) info = info.WithColorSpace(SKColorSpace.CreateSrgb());\u0060\r\n\r\nbut that, color space = null, codec \u002B image only etc. it seems to lose some color data still (I\u0027m am doing blind try\u0027n\u0027error here) - but I think I saw that the v2.80 made it \u002250%\u0022 better / closer to org. color - so most likely a Skia core thing.",
        "createdAt": "2020-05-03T10:22:40",
        "reactions": []
      },
      {
        "id": 623090272,
        "author": "AndersMad",
        "body": "okay - so this might be fixed now - the only \u0022cause\u0022 of the difference now is that Chrome shows the original image in a brighter color - but it\u0027s the only app that does so!.. windows explorer, adobe photoshop, paint .net, edge - all shows with the produced color.. so in my opinion v2.80 closes this one too! \uD83C\uDF7A\uD83D\uDD7A",
        "createdAt": "2020-05-03T10:46:33",
        "reactions": []
      },
      {
        "id": 623103404,
        "author": "AndersMad",
        "body": "just to confirm - old:\r\n![5937-model-photo-OLD](https://user-images.githubusercontent.com/4574570/80914230-84015e80-8d4a-11ea-92fe-a3cab324f719.png)\r\n\r\nnew - more saturated/vibrant colors on the skin tones:\r\n![5937-model-photo-NEW](https://user-images.githubusercontent.com/4574570/80914229-8368c800-8d4a-11ea-8b50-b3ed78634f20.png)\r\n\r\nit only seems to have effected a few \u0022types\u0022 of images (their color type or space I presume)",
        "createdAt": "2020-05-03T12:34:54",
        "reactions": []
      },
      {
        "id": 623129051,
        "author": "mattleibow",
        "body": "\u003E okay - so this might be fixed now - the only \u0022cause\u0022 of the difference now is that Chrome shows the original image in a brighter color - but it\u0027s the only app that does so!.. windows explorer, adobe photoshop, paint .net, edge - all shows with the produced color.. so in my opinion v2.80 closes this one too! \uD83C\uDF7A\uD83D\uDD7A\r\n\r\nOooh, this reminds me of something...  https://github.com/mono/SkiaSharp/issues/1238\r\n\r\nMight be that skia is using a codec that only Chrome understands. Try it in GIMP and see what happens.\r\n\r\nSee also: https://groups.google.com/forum/#!topic/skia-discuss/b8JtsaOw7_o",
        "createdAt": "2020-05-03T15:40:46",
        "reactions": []
      },
      {
        "id": 625078180,
        "author": "AndersMad",
        "body": "too me it seems like (not being concrete here) old image bad in chrome, new image (skia produced) a new kind of bad in all viewers.. new skia alpha version, old image bad in chrome, new image good in all viewers.. anyway - I\u0027m happy with the new alpha :) so closed imho",
        "createdAt": "2020-05-07T07:22:15",
        "reactions": []
      },
      {
        "id": 693205818,
        "author": "AlexNosk",
        "body": "We encountered this problem with another JPEG image. Adding the image here.\r\n[images.zip](https://github.com/mono/SkiaSharp/files/5230126/images.zip)\r\nIs there any estimate about this issue?\r\n\r\n",
        "createdAt": "2020-09-16T06:38:48",
        "reactions": []
      },
      {
        "id": 693310325,
        "author": "AndersMad",
        "body": "@AlexNosk  as i said this has been fixed in the alpha - now its 2.84.0-preview.2. To prove it I scaled your image - here saved as WebP (but that should not matter - used to be prone to more \u0022errors\u0022): [in.zip](https://github.com/mono/SkiaSharp/files/5231440/in.zip)",
        "createdAt": "2020-09-16T10:13:00",
        "reactions": []
      },
      {
        "id": 693312943,
        "author": "ziriax",
        "body": "FYI: The GIMP shows the images the same as Chrome... \r\n\r\nWhen dumping the metadata with ExifTool, the \u0060in.jpeg\u0060 gives an unknown color transform:\r\n\u0060\u0060\u0060\r\nColor Transform                 : Unknown (RGB or CMYK)\r\n\u0060\u0060\u0060\r\n\r\nI will try re-encoding using the official LibJpeg tools, and see...\r\n\r\n\r\n\r\n",
        "createdAt": "2020-09-16T10:17:22",
        "reactions": []
      },
      {
        "id": 694790775,
        "author": "AlexNosk",
        "body": "@AndersMad Where can I get this (2.84.0-preview.2) build to test on my side? by the way the image you have attached still looks incorrect to me. Here is comparison. The top image is the original and the bottom is after resaving with SkiaSharp.\r\n![comparison](https://user-images.githubusercontent.com/31235892/93587740-036a9400-f9b3-11ea-9636-6a30a481f487.png)\r\n",
        "createdAt": "2020-09-18T10:31:15",
        "reactions": []
      },
      {
        "id": 695184590,
        "author": "AndersMad",
        "body": "@AlexNosk I did save it as WebP - maybe theres a diff. there.. Try opening the image out formats in different browsers and editors to see - including the source image.\r\n\r\nTo get the beta version add this to your NuGet package source list: https://nugetized.blob.core.windows.net/skiasharp-eap/index.json",
        "createdAt": "2020-09-19T08:36:32",
        "reactions": []
      },
      {
        "id": 696538757,
        "author": "AlexNosk",
        "body": "@AndersMad I have checked with the latest beta and IMHO the problem is still there. I have compared the input and output image in different browsers:\r\non Windows\r\nIE - colors are different.\r\nEdge -  colors are the same\r\nChrome - colors are the same\r\non Mac\r\nSafari - Colors are different\r\nChrome - Colors are different\r\n\r\nIn viewers and editors\r\non Windows\r\nStandard Photos viewer - Colors are different\r\nMS Paint - Colors are different\r\nPaint 3D - Colors are different\r\non Mac\r\nStandard Preview - Colors are different\r\n\r\nAlso checked on mobile devices - \r\non Android  - Colors are the same\r\non iOS - Colors are different\r\n\r\nThe problem is that in our software SkiaSharp is used to process graphics when convert MS Word documents to different formats and our customers expect that colors they see in MS Word remain unchanged.\r\n  \r\n",
        "createdAt": "2020-09-22T06:42:45",
        "reactions": []
      },
      {
        "id": 696546752,
        "author": "AndersMad",
        "body": "@AlexNosk but its better right ;) try send the out.jpg you generated with the beta and I will try it out in the latest Adobe Photoshop ",
        "createdAt": "2020-09-22T07:05:04",
        "reactions": []
      },
      {
        "id": 696556086,
        "author": "AlexNosk",
        "body": "@AndersMad Here are input and output produced by the latest beta \r\n[images.zip](https://github.com/mono/SkiaSharp/files/5259677/images.zip)\r\n",
        "createdAt": "2020-09-22T07:29:36",
        "reactions": []
      },
      {
        "id": 696646096,
        "author": "ziriax",
        "body": "I think this is related to #523\r\n\r\nIt was resolved by setting the colorspace explicitly. Maybe that helps in your case too?\r\n\r\nNow, your JPEG files are 4 component CMYK or YCCK, see e.g. https://stackoverflow.com/questions/50798014/determining-color-space-for-jpeg\r\n\r\nNot a lot of image software will handle these correctly I\u0027m afraid...\r\n",
        "createdAt": "2020-09-22T10:50:44",
        "reactions": []
      },
      {
        "id": 696648585,
        "author": "ziriax",
        "body": "Also, since no JPEG decoders support the CMYK to RGB conversion, Skia tries to do this manually. The source code contains some interesting comments:\r\n\r\nhttps://source.chromium.org/chromium/chromium/src/\u002B/master:third_party/skia/include/private/SkEncodedInfo.h;l=88?q=cmyk\u0026ss=chromium%2Fchromium%2Fsrc:third_party%2Fskia%2F\u0026start=11\r\n\r\n\u0060\u0060\u0060\r\n        // JPEG\r\n        // Photoshop actually writes inverted CMYK data into JPEGs, where zero\r\n        // represents 100% ink coverage.  For this reason, we treat CMYK JPEGs\r\n        // as having inverted CMYK.  libjpeg-turbo warns that this may break\r\n        // other applications, but the CMYK JPEGs we see on the web expect to\r\n        // be treated as inverted CMYK.\r\n\u0060\u0060\u0060\r\n\r\n",
        "createdAt": "2020-09-22T10:56:58",
        "reactions": []
      },
      {
        "id": 697164973,
        "author": "AlexNosk",
        "body": "@Ziriax Thank you for your suggestion. I tried setting colorspace explicitly, but, unfortunately, this does not help. ",
        "createdAt": "2020-09-23T06:37:38",
        "reactions": []
      },
      {
        "id": 697189265,
        "author": "ziriax",
        "body": "I\u0027m interested to find out what is going on. I will debug this. Hopefully I can find the reason. ",
        "createdAt": "2020-09-23T07:34:10",
        "reactions": []
      },
      {
        "id": 699893449,
        "author": "AndersMad",
        "body": "@AlexNosk confirmed that Adobe Photoshop (latest version) shows a color difference too.. So only Google Chromium display the Google Skia output correctly.",
        "createdAt": "2020-09-28T09:29:45",
        "reactions": []
      },
      {
        "id": 722958871,
        "author": "ProDInfo",
        "body": "I have the same problem.\r\nA jpg file the pixel color is different to MS Paint or Paint.NET\r\n\r\nI Atatch the image\r\n[481.zip](https://github.com/mono/SkiaSharp/files/5500165/481.zip)\r\n\r\n",
        "createdAt": "2020-11-06T08:52:28",
        "reactions": []
      },
      {
        "id": 787916032,
        "author": "AlexNosk",
        "body": "@mattleibow @AndersMad @Ziriax I encountered a similar issue with another Jpeg image. Attached the files for testing.\r\n[images.zip](https://github.com/mono/SkiaSharp/files/6061595/images.zip)",
        "createdAt": "2021-03-01T12:35:23",
        "reactions": []
      },
      {
        "id": 1790494659,
        "author": "zleao",
        "body": "@mattleibow @AndersMad @ziriax , I to have this problem with different images. Attaching them to for testing \r\n[images.zip](https://github.com/mono/SkiaSharp/files/13237849/images.zip)\r\n",
        "createdAt": "2023-11-02T10:48:33",
        "reactions": []
      }
    ]
  }
}