{
  "number": 2669,
  "type": "pr",
  "state": "open",
  "title": "More Span\u003CT\u003E and ReadOnlySpan\u003CT\u003E",
  "body": "**Description of Change**\r\n\r\nI have add Span overloads to many methods that previously only accepted Arrays, IntPtrs, or Strings.\r\n\r\nSome methods could not be given span overloads because the Array/Strings must be marshaled as null-terminated types. This _could_ be solved by copying the contents of the span into a rented array and filling the rest of the array with \u0060null\u0060, however I wanted to discuss this change before making it.\r\n\r\n_The next changes aren\u0027t strictly related to converting to spans, but I figured they were related enough to include them here. If not, I can move them to a new PR._\r\n\r\nI changed a few \u0060return new T[0]\u0060 to \u0060return Array.Empty\u003CT\u003E ()\u0060 to reduce pointless allocations. As far as I can tell, this does not change the behaviour of dereferencing a pointer to the array.\r\n\r\nI also changed the algorithm of \u0060implicit operator SKRuntimeEffectUniform (float[][] value)\u0060 to make allocations linearly associated with the length of \u0060value\u0060 rather than using a variable length list.\r\n\r\nLastly, I believe I fixed 4 memory leaks in \u0060SKCanvas.DrawVertices\u0060, swapped out 3 \u0060SKTypeFace.ToFont\u0060 calls to \u0060SKTypeFace.GetFont\u0060 in \u0060SKTypeFace.GetGlyphs\u0060, and fixed a potential(?) nullptr dereference in \u0060SKPath.GetPoints\u0060. If any changed behaviour occurs in those methods as a result, that might have been my fault.\r\n\r\n\u003C!-- Describe your changes here. --\u003E\r\n\r\n**Bugs Fixed**\r\n\r\n- Related to #2616 \r\n\r\n\u003C!-- Provide links to issues here. Ensure that a GitHub issue was created for your feature or bug fix before sending PR. --\u003E\r\n\r\n**API Changes**\r\n\r\n* [x]  SKCanvas.cs\r\n* [x]  SKCodec.cs\r\n* [x]  SKColorFilter.cs\r\n* [x]  SKColorSpace.cs\r\n* [x]  SKColorSpaceStructs.cs\r\n* [x]  SKData.cs\r\n* [x]  SKFont.cs\r\n* [x]  SKMaskFilter.cs\r\n* [x]  SKMatrix.cs\r\n* [x]  SKMatrix44.cs\r\n  - Removed some redundant null checks\r\n* [x]  SKPMColor.cs\r\n* [x]  SKPath.cs\r\n* [x]  SKPathEffect.cs\r\n* [x]  SKRoundRect.cs\r\n  - Removed some redundant null checks\r\n* [x]  SKRuntimeEffect.cs\r\n* [x]  SKShader.cs\r\n* [x]  SKString.cs\r\n* [x]  SKTypeface.cs\r\n* [x]  SKVertices.cs\r\n* [x]  Util.cs\r\n  - Swapped \u0060new T[0]\u0060 for \u0060Array.Empty\u003CT\u003E ()\u0060\r\n* [x] SKShaper\r\n* [x] CanvasExtensions\r\n\r\n**Behavioral Changes**\r\n\r\nNone.\r\n\r\n\u003C!-- Describe any non-bug related behavioral changes that may change how users app behaves when upgrading to this version of the codebase. --\u003E\r\n\r\n**Required skia PR**\r\n\r\nNone.\r\n\r\n\u003C!-- Replace this with the full URL to the skia PR. --\u003E\r\n\r\n**PR Checklist**\r\n\r\n- [x] Has tests (if omitted, state reason in description)\r\n- [x] Rebased on top of main at time of PR\r\n- [x] Merged related skia PRs\r\n- [x] Changes adhere to coding standard\r\n- [ ] Updated documentation\r\n",
  "author": {
    "login": "ScrubN",
    "type": "User"
  },
  "labels": [
    {
      "name": "community \u2728",
      "color": "ededed"
    }
  ],
  "assignees": [],
  "createdAt": "2023-11-10T09:45:21",
  "updatedAt": "2025-02-28T04:40:55",
  "commentCount": 11,
  "reactionCount": 5,
  "draft": false,
  "mergeable": true,
  "merged": false,
  "mergeableState": "behind",
  "baseBranch": "main",
  "headBranch": "reduce-arrays",
  "additions": 773,
  "deletions": 290,
  "changedFiles": 33,
  "commits": 26,
  "reviews": [
    {
      "author": "ScrubN",
      "state": "COMMENTED",
      "submittedAt": "2023-11-14T05:19:38"
    },
    {
      "author": "mattleibow",
      "state": "COMMENTED",
      "submittedAt": "2024-11-04T14:07:37"
    },
    {
      "author": "ScrubN",
      "state": "COMMENTED",
      "submittedAt": "2024-11-07T05:36:15"
    },
    {
      "author": "ScrubN",
      "state": "COMMENTED",
      "submittedAt": "2024-11-07T05:45:34"
    },
    {
      "author": "divay-ironsoftware",
      "state": "COMMENTED",
      "submittedAt": "2024-12-02T03:55:22"
    },
    {
      "author": "ScrubN",
      "state": "COMMENTED",
      "submittedAt": "2024-12-02T04:08:54"
    },
    {
      "author": "divay-ironsoftware",
      "state": "APPROVED",
      "submittedAt": "2024-12-02T04:41:30"
    }
  ],
  "engagement": {
    "syncedAt": "2026-02-06T13:29:41.0651745Z",
    "reactions": [
      {
        "user": "charlesroddie",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:29:41.0651801Z"
      },
      {
        "user": "inforithmics",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:29:41.0651807Z"
      },
      {
        "user": "angelofb",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:29:41.0651811Z"
      },
      {
        "user": "jeremy-visionaid",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:29:41.0651814Z"
      },
      {
        "user": "MichaelRumpler",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:29:41.0651817Z"
      }
    ],
    "comments": [
      {
        "id": 1805406536,
        "author": "ScrubN",
        "body": "I\u0027ll make some tests later.\r\n\r\nFeedback on the null-terminated LPArray/LPStr situation would be appreciated!",
        "createdAt": "2023-11-10T09:45:57",
        "reactions": []
      },
      {
        "id": 1809639675,
        "author": "ScrubN",
        "body": "Since the CI didn\u0027t run, here\u0027s a screenshot of the test results from my IDE. Was a bit of a pain to get it working since its setup for azure pipelines.\r\n![image](https://github.com/mono/SkiaSharp/assets/72096833/7efa18ee-ba7f-4a83-ae2f-8c41f28f070c)\r\n",
        "createdAt": "2023-11-14T06:55:23",
        "reactions": []
      },
      {
        "id": 2285107851,
        "author": "ScrubN",
        "body": "@mattleibow What steps are needed to get this PR merged into dev/reduce-arrays, then dev/reduce-arrays into main?",
        "createdAt": "2024-08-13T00:12:18",
        "reactions": []
      },
      {
        "id": 2325477747,
        "author": "DJGosnell",
        "body": "This would be fantastic to include especially for rendering partial arrays like on the \u0060SKCanvas.DrawPoints\u0060 method.  Is the only reason this is stalled due to the numerous changes on the main or is there a more fundamental reason?",
        "createdAt": "2024-09-03T02:15:41",
        "reactions": []
      },
      {
        "id": 2460898391,
        "author": "ScrubN",
        "body": "Thanks for the response! I\u0027ll get working on the requested changes.\r\n\r\n\u003E Could you rebase\r\n\r\nI presume this means this PR will supersede #2617?\r\n\r\n\u003E I also added a few extra comments to things that I saw maybe should not be changed in this PR.\r\n\r\nYeah, I\u0027m not sure what I was thinking with some of the changes either. It probably had something to do with the changes being authored at 4am \uD83D\uDE05",
        "createdAt": "2024-11-06T22:14:44",
        "reactions": []
      },
      {
        "id": 2461419423,
        "author": "ScrubN",
        "body": "All tests currently still pass\r\n![image](https://github.com/user-attachments/assets/6265bb3e-e4d4-485f-95f5-bb2bda0d738f)",
        "createdAt": "2024-11-07T06:21:59",
        "reactions": []
      },
      {
        "id": 2461421773,
        "author": "ScrubN",
        "body": "In \u0060SKShaper\u0060, I would like to redirect \u0060public Result Shape(string text, float xOffset, float yOffset, SKFont font)\u0060 to the span overload for consistency, however the string overload currently uses \u0060Buffer.AddUtf8\u0060 which only accepts \u0060string\u0060/\u0060byte[]\u0060/\u0060span\u003Cbyte\u003E\u0060. Because of this, the span overload currently uses \u0060Buffer.AddUtf16\u0060, which produces a different (but technically more correct) cluster sequence when shaped by harfbuzz.\r\n\r\nBecause this is a breaking change, I do not want to make the call in this PR, but I would like to start a discussion on whether it can be done in order to maintain output parity between the string and span overloads.",
        "createdAt": "2024-11-07T06:23:58",
        "reactions": []
      },
      {
        "id": 2684412790,
        "author": "xoofx",
        "body": "Hey, I\u0027m also really interested in this PR landing to be able to use it in e.g. Avalonia.\r\n\r\nWhat is left here to review, how can we help?",
        "createdAt": "2025-02-26T09:31:51",
        "reactions": []
      },
      {
        "id": 2689648862,
        "author": "mattleibow",
        "body": "/rebase",
        "createdAt": "2025-02-28T03:46:03",
        "reactions": []
      },
      {
        "id": 2689654008,
        "author": "mattleibow",
        "body": "/azp run",
        "createdAt": "2025-02-28T03:51:23",
        "reactions": []
      },
      {
        "id": 2689654079,
        "author": "azure-pipelines[bot]",
        "body": "\u003Csamp\u003E\nAzure Pipelines will not run the associated pipelines, because the pull request was updated after the run command was issued. Review the pull request again and issue a new run command.\u003Cbr\u003E\r\n\n\u003C/samp\u003E",
        "createdAt": "2025-02-28T03:51:29",
        "reactions": []
      }
    ]
  }
}