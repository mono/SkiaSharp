{
  "number": 1179,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] NullReferenceException occurs when use SKTypeface and SKPaint in multi Threading",
  "body": "**Description**\r\n\r\nI have try to use the SKTypeface font in the multi threading but the exception occurs. I have given the simple code sample to reproduce the issue. Kindly provide the your suggestion to resolve the issue. \r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060csharp\r\nclass Program\r\n{\r\n    static void Main(string[] args)\r\n    {\r\n\r\n        for (int i = 0; i \u003C 50; i\u002B\u002B)\r\n        {\r\n            Console.WriteLine(i);\r\n            Thread thread = new Thread(SkiaTypefaceThreading);\r\n            thread.Name = i.ToString();\r\n            thread.Start();\r\n\r\n        }\r\n\r\n    }\r\n    private static void SkiaTypefaceThreading()\r\n    {\r\n        string[] fonts = new string[] { \u0022Arial\u0022, \u0022Verdana\u0022, \u0022Calibri\u0022 };\r\n        foreach (string fontName in fonts)\r\n        {\r\n            FontExtension ext = new FontExtension(\u0022Arial\u0022, 12);\r\n            Console.WriteLine(ext.Typeface.FamilyName);\r\n        }\r\n        FontExtension.ClearFontCache();\r\n    }\r\n}\r\n\r\npublic class FontExtension : SKPaint\r\n{\r\n    [ThreadStatic]\r\n    private static Dictionary\u003Cstring, SKTypeface\u003E typeFaceCache;\r\n    public static Dictionary\u003Cstring, SKTypeface\u003E TypeFaceCache\r\n    {\r\n        get\r\n        {\r\n            if (typeFaceCache == null)\r\n                typeFaceCache = new Dictionary\u003Cstring, SKTypeface\u003E();\r\n            return typeFaceCache;\r\n        }\r\n    }\r\n    internal FontExtension(string fontName, float fontSize)\r\n    {\r\n        this.TextEncoding = SKTextEncoding.Utf8;\r\n        this.IsAntialias = true;\r\n        this.SubpixelText = true;\r\n\r\n        if (TypeFaceCache != null \u0026\u0026 TypeFaceCache.ContainsKey(fontName \u002B \u0022;\u0022))\r\n            this.Typeface = TypeFaceCache[fontName \u002B \u0022;\u0022];\r\n        else\r\n        {\r\n            this.Typeface = SKTypeface.FromFamilyName(fontName, SKFontStyleWeight.Normal, SKFontStyleWidth.Normal, SKFontStyleSlant.Upright); ;\r\n\r\n            TypeFaceCache.Add(fontName \u002B \u0022;\u0022, this.Typeface);\r\n        }\r\n        this.TextSize = fontSize;\r\n    }\r\n    public static void ClearFontCache()\r\n    {\r\n\r\n        if (typeFaceCache != null)\r\n        {\r\n            foreach (string key in typeFaceCache.Keys)\r\n            {\r\n                SKTypeface sKTypeface = typeFaceCache[key];\r\n                if (sKTypeface != null)\r\n                {\r\n                    sKTypeface.Dispose();\r\n                    sKTypeface = null;\r\n                }\r\n            }\r\n\r\n            typeFaceCache.Clear();\r\n            typeFaceCache = null;\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nPrint the output properly.\r\n\r\n**Actual Behavior**\r\n\r\nNull reference exception occurs\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.59.3\r\n- IDE:  Visual Studio 2017\r\n- Platform Target Frameworks: .Net Core 2.1\r\n- Target Devices:   Console Application.\r\n\r\n**Screenshots**\r\n\r\n\u003C!-- if the issue is a visual issue, please include screenshots showing the problem if possible --\u003E\r\n![image](https://user-images.githubusercontent.com/48026813/76960846-4be0c080-6942-11ea-8acf-a276ef053a51.png)\r\n\r\n\r\n",
  "author": {
    "login": "MadhanKumarasamy",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2020-03-18T12:36:16",
  "updatedAt": "2022-08-19T06:02:21",
  "closedAt": "2020-04-15T22:18:14",
  "commentCount": 5,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-06T14:12:07.3031641Z",
    "reactions": [
      {
        "user": "VijayRM",
        "content": "\u002B1",
        "createdAt": "2026-02-06T14:12:07.3031716Z"
      }
    ],
    "comments": [
      {
        "id": 607621999,
        "author": "VijayRM",
        "body": "@Redth - Any update on this? ",
        "createdAt": "2020-04-02T05:01:03",
        "reactions": []
      },
      {
        "id": 607718751,
        "author": "mattleibow",
        "body": "I have pushed what I think is now a good version to the preview feed: https://aka.ms/skiasharp-eap/index.json\r\nCheck out the PR version: **1.68.2-pr.1200.20**",
        "createdAt": "2020-04-02T09:04:38",
        "reactions": []
      },
      {
        "id": 607788485,
        "author": "mattleibow",
        "body": "I had a look at the code and I think I found the issue. You have a dictionary that you are caching your fonts in - this is all good. But, when you clear the dictionary, you are disposing the objects - when they are still in the dictionary. Then, in another thread - before you remove it from the dictionary - the typeface is being used. As a result, it is setting a disposed object to the paint - which is basically null at this point.\r\n\r\nThere probably is an improvement to SkiaSharp that can be done here. Maybe we can throw if you assign a disposed object to a property. But, for a fix on your side, you can either first remove the object in the dictionary or do some locking so a read and clear don\u0027t happen together.\r\n\r\nThere are a few things to note as well. \u0060SKTypeface.FromFamilyName(fontName)\u0060 will actually **return the same object for the same typeface**. This means that if you dispose it but still have a reference you actually have a reference to a disposed object. You do want to dispose typefaces that you read from a file because we need to close file handles and things, but from the matching from installed fonts can be left.\r\n\r\nTo work in your case, I would actually not use a \u0060[ThreadStatic]\u0060 as some dictionaries might have references to the same object. Instead I would just use a plain static \u0060ConcurrentDictionary\u003CK, V\u003E\u0060 and let .NET do the work. Also, I would change the clear to basically iterate over the dictionary and remove then dispose:\r\n\r\n\u0060\u0060\u0060csharp\r\npublic class FontExtension : SKPaint\r\n{\r\n    private static readonly ConcurrentDictionary\u003Cstring, SKTypeface\u003E typeFaceCache =\r\n        new ConcurrentDictionary\u003Cstring, SKTypeface\u003E();\r\n\r\n    public static IReadOnlyDictionary\u003Cstring, SKTypeface\u003E TypeFaceCache =\u003E typeFaceCache;\r\n\r\n    internal FontExtension(string fontName, float fontSize)\r\n    {\r\n        TextEncoding = SKTextEncoding.Utf8;\r\n        IsAntialias = true;\r\n        SubpixelText = true;\r\n        TextSize = fontSize;\r\n\r\n        Typeface = typeFaceCache.GetOrAdd(\r\n            fontName \u002B \u0022;\u0022,\r\n            key =\u003E SKTypeface.FromFamilyName(fontName, SKFontStyleWeight.Normal, SKFontStyleWidth.Normal, SKFontStyleSlant.Upright));\r\n    }\r\n\r\n    public static void ClearFontCache()\r\n    {\r\n        foreach (string key in typeFaceCache.Keys)\r\n        {\r\n            typeFaceCache.TryRemove(key, out var typeface);\r\n            typeface?.Dispose();\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2020-04-02T11:28:50",
        "reactions": []
      },
      {
        "id": 613981784,
        "author": "mattleibow",
        "body": "The particular fix for the disposing of system typefaces is fixed in #1224",
        "createdAt": "2020-04-15T11:27:46",
        "reactions": []
      },
      {
        "id": 613982358,
        "author": "mattleibow",
        "body": "Released to NuGet as version **1.68.2-preview.60**",
        "createdAt": "2020-04-15T11:29:03",
        "reactions": []
      }
    ]
  }
}