{
  "number": 1674,
  "type": "issue",
  "state": "open",
  "title": "[BUG] [2.80.2] Crash in HandleDictionary.RegisterHandle",
  "body": "**Description**\r\n\r\nI use Skiasharp for the UI rendering in my game Sector\u0027s Edge, which runs on OpenGL. Quite a few users (all on Windows 10) are facing abrupt crashes while playing the game. They sent me crash minidumps, which showed the application failed with the following details\r\n\r\n\u0060\u0060\u0060\r\nProcess Architecture: x64\r\nException Code: 0x80000004\r\nException Information: A trace trap or other single-instruction mechanism signaled that one instruction has been executed)\r\nHeap Information: Not Present\r\n\r\nStack Trace:\r\n[Managed to Native Transition]\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.Handle.set(System.IntPtr value)\r\nSkiaSharp.dll!SkiaSharp.SKFont.SKFont(SkiaSharp.SKTypeface typeface, float size, float scaleX, float skewX)\r\n\u0060\u0060\u0060\r\n\r\n\r\n**Code**\r\n\r\nThis error happens when creating an SKFont, but I believe it happens when creating any kind of SKObject.\r\n\r\n**Expected Behavior**\r\n\r\nUI rendering works smoothly\r\n\r\n**Actual Behavior**\r\n\r\nThe program and all associated threads (e.g. OpenAL thread) crashes instantly.\r\n\r\nI have noticed this crash occurs on screens with a lot of text, as well as on screens with minimal amounts of text. It happens to some users on machines with a lot of RAM, as well as users with low amounts of RAM. Some users don\u0027t face this issue at all.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.80.2\r\n- Last known good version:  I believe I\u0027ve always used 2.80.2\r\n- IDE:  Visual Studio Community 2019 Preview - \r\n- Platform Target Frameworks: \r\n  - Windows Classic: 10\r\n  \r\n\u003Cdetails\u003E\r\n  \u003Csummary\u003EDetailed IDE/OS information (click to expand)\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\nIDE Version: Version 16.9.0 Preview 2.0\r\nOS Version: 10.0.19041\r\nCLR Version(s): 4.8.4300.0\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n**Reproduction Link**\r\n\r\nI\u0027m not exactly sure what to put here since the game\u0027s repository is private, but if I am able to get the \u0060Skiasharp.pdb\u0060 file for NuGet version 2.80.2, I will be able to dig deeper into the stack trace to determine where exactly it\u0027s crashing.\r\n\r\n@toptensoftware is the developer of [RichTextKit](https://github.com/toptensoftware/RichTextKit), which is the library I use for rendering rich strings. He may have additional info or insight into what\u0027s causing this.\r\n\r\nThe full stack trace including RichTextKit code is here:\r\n\r\n\u0060\u0060\u0060\r\n[Managed to Native Transition]\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.Handle.set(System.IntPtr value)\r\nSkiaSharp.dll!SkiaSharp.SKFont.SKFont(SkiaSharp.SKTypeface typeface, float size, float scaleX, float skewX)\r\nsectorsedge.exe!Topten.RichTextKit.FontFallback.\u003CGetFontRuns\u003Ed__2.MoveNext()\r\nsectorsedge.exe!Topten.RichTextKit.TextBlock.AddDirectionalRun(Topten.RichTextKit.StyleRun styleRun, int start, int length, Topten.RichTextKit.TextDirection direction, Topten.RichTextKit.IStyle style)\r\nsectorsedge.exe!Topten.RichTextKit.TextBlock.BuildFontRuns()\r\nsectorsedge.exe!Topten.RichTextKit.TextBlock.Layout()\r\nsectorsedge.exe!Topten.RichTextKit.RichString.ParagraphInfo.Layout(ref Topten.RichTextKit.RichString.LayoutContext ctx)\r\nsectorsedge.exe!Topten.RichTextKit.RichString.Layout()\r\nsectorsedge.exe!Topten.GuiKit.OpenGL.OpenGLDrawingContext.DrawText(Topten.RichTextKit.RichString text, Topten.GuiKit.Rectangle rect, Topten.GuiKit.Font font, Topten.GuiKit.Color color, Topten.GuiKit.Gravity align, int maxLines)\r\n\u0060\u0060\u0060",
  "author": {
    "login": "Vercidium",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2021-03-27T02:03:18",
  "updatedAt": "2021-05-18T22:18:31",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:24:58.9618833Z",
    "reactions": [],
    "comments": [
      {
        "id": 809881636,
        "author": "Vercidium",
        "body": "Here\u0027s a stack trace from a crash that happened today on my PC.\r\n\r\nThe crash dump has the same details as above, except that I am running \u0060OS Version: 10.0.19041\u0060.\r\n\r\n\u0060\u0060\u0060\r\n[Managed to Native Transition]\t\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.Handle.set(System.IntPtr value)\r\nSkiaSharp.dll!SkiaSharp.SKCanvas.GetObject.AnonymousMethod__135_0(System.IntPtr h, bool o)\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.GetOrAddObject\u003CSystem.__Canon\u003E(System.IntPtr handle, bool owns, bool unrefExisting, System.Func\u003CSystem.IntPtr, bool, System.__Canon\u003E objectFactory)\r\nSkiaSharp.dll!SkiaSharp.SKObject.GetOrAddObject\u003CSystem.__Canon\u003E(System.IntPtr handle, bool owns, bool unrefExisting, System.Func\u003CSystem.IntPtr, bool, System.__Canon\u003E objectFactory)\r\nSkiaSharp.dll!SkiaSharp.SKCanvas.GetObject(System.IntPtr handle, bool owns, bool unrefExisting)\r\nSkiaSharp.dll!SkiaSharp.SKSurface.Canvas.get()\r\nsectorsedge.exe!Topten.GuiKit.OpenGL.OpenGLDrawingContext.DrawText(Topten.RichTextKit.RichString text, Topten.GuiKit.Rectangle rect, Topten.GuiKit.Font font, Topten.GuiKit.Color color, Topten.GuiKit.Gravity align, int maxLines)\r\n\u0060\u0060\u0060",
        "createdAt": "2021-03-30T03:39:22",
        "reactions": []
      },
      {
        "id": 809949691,
        "author": "toptensoftware",
        "body": "I don\u0027t really have much to add to this except to say:\r\n\r\n* don\u0027t think this is related to bad typeface/size/scale values as I\u0027ve seen a crash log that captured those details and it all looked fine - just a standard Segoe UI font with normal size.\r\n* don\u0027t think this is threading related as all rendering in my case is done on a single UI thread.\r\n* I\u0027ve seen this in cases where OpenGL is not involved - just plain rendering to a Canvas.\r\n* Subtle clue maybe from first crash log above... exception code 0x80000004 is \u0022No such interface supported\u0022.  Not sure if that helps.",
        "createdAt": "2021-03-30T06:29:23",
        "reactions": []
      },
      {
        "id": 843602564,
        "author": "Vercidium",
        "body": "I have received a new crash dump from a user with \u0060Exception 0x80000004\u0060 in \u0060SkiaSharp.dll\u0060.\r\n\r\nThe crash dump is available here: https://www.dropbox.com/s/wlozoysbm06th9p/sectorsedge.exe.2544.zip?dl=0\r\nA build of the game is available here: https://www.dropbox.com/s/aalyxs0285wnaw0/sectorsedgev136.zip?dl=0\r\n\r\nThe call stack is:\r\n\u0060\u0060\u0060\r\n[Managed to Native Transition]\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.RegisterHandle(System.IntPtr handle, SkiaSharp.SKObject instance)\r\nSkiaSharp.dll!SkiaSharp.SKObject.Handle.set(System.IntPtr value)\r\nSkiaSharp.dll!SkiaSharp.SKFont.SKFont(SkiaSharp.SKTypeface typeface, float size, float scaleX, float skewX)\r\n\u0060\u0060\u0060\r\n\r\nSome details have changed slightly:\r\n\u0060\u0060\u0060\r\nOS Version: 10.0.19042\r\nCLR Version(s): 4.8.4341.0\r\n\u0060\u0060\u0060",
        "createdAt": "2021-05-18T22:18:31",
        "reactions": []
      }
    ]
  }
}