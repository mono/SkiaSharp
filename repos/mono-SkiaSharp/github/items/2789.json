{
  "number": 2789,
  "type": "pr",
  "state": "closed",
  "title": "Add and remove the compatibility APIs",
  "body": "**Description of Change**\r\n\r\nIn SkiaSharp 3.0 we are focusing on performance and making use of new APIs and structures.\r\n\r\nHowever, we can add a few compatibility things back to make upgrades much simple/easier.\r\n\r\n- Part of https://github.com/mono/SkiaSharp/issues/2790",
  "author": {
    "login": "mattleibow",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2024-03-07T22:57:45",
  "updatedAt": "2024-04-25T11:54:32",
  "closedAt": "2024-04-08T19:08:58",
  "commentCount": 10,
  "reactionCount": 2,
  "draft": false,
  "merged": true,
  "mergedAt": "2024-04-08T19:08:58",
  "mergeableState": "unknown",
  "baseBranch": "main",
  "headBranch": "dev/compat-apis",
  "additions": 211,
  "deletions": 25,
  "changedFiles": 8,
  "commits": 9,
  "reviews": [],
  "engagement": {
    "syncedAt": "2026-02-06T13:37:31.5293694Z",
    "reactions": [
      {
        "user": "maxkatz6",
        "content": "heart",
        "createdAt": "2026-02-06T13:37:31.5293775Z"
      },
      {
        "user": "workgroupengineering",
        "content": "heart",
        "createdAt": "2026-02-06T13:37:31.5293918Z"
      }
    ],
    "comments": [
      {
        "id": 1986267042,
        "author": "maxkatz6",
        "body": "\u0060SKPath.Transform(SKMatrix)\u0060 can be added as well. ",
        "createdAt": "2024-03-08T19:19:28",
        "reactions": []
      },
      {
        "id": 2023859856,
        "author": "mattleibow",
        "body": "I am trying to add back magic here, but I am wondering if this is actually useful. For example, we added some overloads - but what about all the other things that are changed - like switching from array to a span? Are we just making things better for 1% of apps?",
        "createdAt": "2024-03-27T20:01:27",
        "reactions": []
      },
      {
        "id": 2026421095,
        "author": "maxkatz6",
        "body": "@mattleibow testing on Avalonia, I didn\u0027t have any incompatibilities with span/array methods. Possibly because we didn\u0027t use these. The only issues I had were \u0060CreateBlur/DrowShadow\u0060 methods, as well as \u0060SKPath.Transform\u0060 and \u0060SKCanvas.SetMatrix\u0060. Not sure if it covers 1% or more.\r\n\r\nI would expect apps that heavily use SkiaSharp API would have to upgrade either way.\r\nAlso, it seems the biggest breaking change PRs weren\u0027t merged (yet?), like other Span related PRs.",
        "createdAt": "2024-03-29T01:07:43",
        "reactions": []
      },
      {
        "id": 2040355252,
        "author": "mattleibow",
        "body": "Doing some more testing and I think this is working nicely. We have some new tolling that you can use to help detect things. Check out this issue description for more information: https://github.com/mono/SkiaSharp/issues/2790\r\n\r\nAdd comments on that issue if there are any general upgrade issues or issues with the tools.",
        "createdAt": "2024-04-05T18:03:59",
        "reactions": [
          {
            "user": "maxkatz6",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:37:30.0127837Z"
          }
        ]
      },
      {
        "id": 2040803771,
        "author": "maxkatz6",
        "body": "Wow, didn\u0027t know about this tool. Quite useful. I will test 2.88.8-preview1 on Avalonia, thank you!",
        "createdAt": "2024-04-06T00:09:13",
        "reactions": []
      },
      {
        "id": 2040852733,
        "author": "maxkatz6",
        "body": "@mattleibow for some reason, I see some false positives with this tool.\r\n\r\nThat all the compat issues it found (comparing with the latest nuget preview):\r\n\u0060\u0060\u0060xml\r\n\u003Cmember fullname=\u0022System.Void SkiaSharp.SKCanvas::SetMatrix(SkiaSharp.SKMatrix)\u0022 /\u003E\r\n\u003Cmember fullname=\u0022System.Void SkiaSharp.SKPath::Transform(SkiaSharp.SKMatrix)\u0022 /\u003E\r\n\u003Cmember fullname=\u0022SkiaSharp.SKPoint[] SkiaSharp.SKRoundRect::get_Radii()\u0022 /\u003E\r\n\u003Cmember fullname=\u0022System.Void SkiaSharp.SKMatrix::Concat(SkiaSharp.SKMatrix\u0026amp;,SkiaSharp.SKMatrix,SkiaSharp.SKMatrix)\u0022 /\u003E\r\n\u003Cmember fullname=\u0022System.Boolean SkiaSharp.SKPathMeasure::GetPosition(System.Single,SkiaSharp.SKPoint\u0026amp;)\u0022 /\u003E\r\n\u003Cmember fullname=\u0022System.Boolean SkiaSharp.SKPathMeasure::GetPositionAndTangent(System.Single,SkiaSharp.SKPoint\u0026amp;,SkiaSharp.SKPoint\u0026amp;)\u0022 /\u003E\r\n\u003Cmember fullname=\u0022System.Boolean SkiaSharp.SKRegion/RectIterator::Next(SkiaSharp.SKRectI\u0026amp;)\u0022 /\u003E\r\n\u0060\u0060\u0060\r\n\r\nSetMatrix and Transform make sense, as these changes weren\u0027t yet pushed.\r\n\r\nBut all other APIs: SKRoundRect::get_Radii, SKMatrix::Concat, SKPathMeasure::GetPosition, SKPathMeasure::GetPositionAndTangent,  SKRegion/RectIterator::Next were not really changed, as I can see, right?\r\n\r\nLike, [before](https://github.com/mono/SkiaSharp/blob/v2.88.7/binding/Binding/SKRegion.cs) and [after](https://github.com/mono/SkiaSharp/blob/a290ccffc74bc95a45569e8b74e77be851d4a688/binding/SkiaSharp/SKRegion.cs#L248) for RectIterator.\r\n",
        "createdAt": "2024-04-06T01:49:59",
        "reactions": []
      },
      {
        "id": 2040880406,
        "author": "maxkatz6",
        "body": "[Enabled render tests](https://github.com/AvaloniaUI/Avalonia/pull/15255) for SkiaSharp 3.0, some outputs are different, most likely we need to somehow use \u0060SKSamplingOptions\u0060 apis with SKBitmap now ([see for details](https://github.com/mono/SkiaSharp/pull/2756#issuecomment-1945620634)). But at least compilation works well, and all the tests are passing. I think it will be enough for us, until we move to SkiaSharp 3.0 as a minimum version somewhere with 12.0 (no eta, but probably early 2025).\r\n\r\nWill remove SKCanvas/SKPath hacks later as well, when this PR is shipped.\r\nThank you!",
        "createdAt": "2024-04-06T02:10:39",
        "reactions": []
      },
      {
        "id": 2043475828,
        "author": "mattleibow",
        "body": "\u003E for some reason, I see some false positives with this tool.\r\n\r\n@maxkatz6 thanks for letting me know. I had a bug in the tool that was not reporting ref/out params, but I fixed that and pushed an update to nuget.\r\n\r\n\r\n\u003E some outputs are different\r\n\r\nDo you have some examples? There has been over a year of changes to skia, and before the sampling options the filter quality was whatever the implementation felt like. Now it is a bit more predictable. Not sure how one would handle cases where they did a pixel rounding adjustment or a slightly different algorithm for a path or something. Technically neither will be \u0022wrong\u0022 just different based on your old baselines. If there are major differences, then maybe there is a bug in v2 or v3.",
        "createdAt": "2024-04-08T19:08:11",
        "reactions": []
      },
      {
        "id": 2076187402,
        "author": "maxkatz6",
        "body": "@mattleibow created https://github.com/AvaloniaUI/Avalonia/issues/15503 tracking issue, what I should have done earlier. \r\nThanks to these PRs, Avalonia now works with SkiaSharp 3.0 without any reflection hacks which is great.\r\nOnly difference, what I mentioned before, is that \u0060paint.FilterQuality\u0060 is a no-op now in native Skia code, effectively disabling rendering interpolation for bitmaps in Avalonia. But that\u0027s what I would call a \u0022best effort\u0022 support, sufficient until 12.0.",
        "createdAt": "2024-04-25T01:59:33",
        "reactions": []
      },
      {
        "id": 2077005878,
        "author": "mattleibow",
        "body": "I see we do store the filter quality on the paint, but I think it was like that for some time.\n\nDo you have an example of where it is not working properly? Maybe I am using some wrong api and not passing the quality from paint. ",
        "createdAt": "2024-04-25T11:54:31",
        "reactions": []
      }
    ]
  }
}