{
  "number": 2649,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKSL doesn\u0027t recognize \u0027smoothstep\u0027, or \u0027fwidth\u0027 (and other OpenGL operators)",
  "body": "### Description\r\n\r\nWe are needing SkiaSharp\u0027s SKSL to provide better OpenGL shader support - namely \u0027smoothstep\u0027 and \u0027fwidth\u0027.\r\n\r\nBoth of these operators (built-in methods) result in this shader compiler error:\r\n\r\n    \u0022error: 48: unknown identifier \u0027smoothstep\u0027\u0022\r\n\r\nAnd the shader won\u0027t compile.\r\n\r\nNOTE: We\u0027re using latest Skia 2.88.6  (not .3 as shown below, as it didn\u0027t give me the .6 option)\r\n\r\nNOTE#2:  If we can\u0027t get Skia to do these operations, our fallback is to do something more complex where we do it using OpenTK/OpenGL - with a RenderTarget that hopefully we can share back with SKIA, where we can Blit our OpenTK/GL result onto an SKGLSurface in some efficient manner.\r\n\r\n\r\n### Code\r\n\r\nOur actual shader is far more involved, but the following very simple shader code triggers the exact same error:\r\n\u0060\u0060\u0060cs\r\nfloat4 main(float2 fragCoord) {\r\n\tfloat red = smoothstep(0.3, 0.7, fragCoord.x);   // \u003C== FAILS \u0027smoothstep\u0027\r\n\tfloat blue = fwidth(fragCoord.x);                      // \u003C== ALSO FAILS \u0027fwidth\u0027\r\n\tfloat4 color = float4(red, 0.0, blue, 1.0);\r\n\treturn color;\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThen in C#, our code looks like this:  (where \u0027source\u0027 string is equal to the SKSL code above)\r\n\r\n\u0060\u0060\u0060cs\r\n\t_shaderEffect = SKRuntimeEffect.Create(source, out string error);\r\n\u0060\u0060\u0060\r\n\r\nError returns as \u0022error: 48: unknown identifier \u0027smoothstep\u0027\u0022\r\n\r\n### Expected Behavior\r\n\r\nI was sure hoping that SKSL would support these very useful and commonly used operators - smoothstep and fwidth, and that we could see the same effects here as we were producing using OpenGL, in a 3D view context.\r\n\r\n\r\n### Actual Behavior\r\n\r\nShader won\u0027t compile, and therefore does not run at all.\r\n\r\n### Version of SkiaSharp\r\n\r\n2.88.3 (Current)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nWindows\r\n\r\n### Platform / Operating System Version\r\n\r\nWindow 11.   Latest Home Edition\r\n\r\n### Devices\r\n\r\nDell XPS PC\r\n\r\n### Relevant Screenshots\r\n\r\n_No response_\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "najak3d",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "status/needs-info",
      "color": "B8EC4A"
    },
    {
      "name": "status/no-recent-activity",
      "color": "B8EC4A"
    }
  ],
  "assignees": [],
  "createdAt": "2023-10-16T07:40:25",
  "updatedAt": "2024-02-17T03:00:24",
  "closedAt": "2024-01-18T02:00:27",
  "commentCount": 11,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:57:10.8851993Z",
    "reactions": [],
    "comments": [
      {
        "id": 1765265942,
        "author": "najak3d",
        "body": "Looking more, it looks like you may have fixed this in #2547.\r\nhttps://github.com/mono/SkiaSharp/pull/2547\r\n\r\nBut I don\u0027t know how to access this fix.  Is there a way I can get a pre-release of 3.0.   It\u0027s not showing up as an option under Nuget \u0022pre-releases\u0022, so I\u0027m unable to validate this fix, assuming it\u0027s included in 3.0 already.",
        "createdAt": "2023-10-16T20:59:25",
        "reactions": []
      },
      {
        "id": 1770469661,
        "author": "angelofb",
        "body": "add this line to your nuget.config and enable prerelease\r\n\r\n\u0060\u003Cadd key=\u0022skiasharp-eap\u0022 value=\u0022https://aka.ms/skiasharp-eap/index.json\u0022 /\u003E \u0060\r\n",
        "createdAt": "2023-10-19T09:54:52",
        "reactions": [
          {
            "user": "najak3d",
            "content": "heart",
            "createdAt": "2026-02-06T12:57:09.0936626Z"
          },
          {
            "user": "taublast",
            "content": "heart",
            "createdAt": "2026-02-06T12:57:09.0936631Z"
          }
        ]
      },
      {
        "id": 1771552498,
        "author": "najak3d",
        "body": "For now, we are omitting the feature that requires \u0027fwidth\u0027 (i.e. elevation contour lines on the map), and have simulated, well-enough, the \u0027smoothstep\u0027 with our own method:\r\n\r\nfloat smoothstep(float min, float max, float val) {\r\n\treturn (val \u003C= min) ? 0.0 : (val \u003E= max) ? 1.0 : ((val - min) / (max - min));\r\n}\r\n\r\nSo we\u0027re less desperate for this currently.  I think we may wait for the first official \u0022Pre-release\u0022 of 3.0 to test out the \u0027fwidth\u0027.\r\n\r\nSince the 3.0 Shader support API has changed, it wouldn\u0027t be a trivial \u0022trial\u0022 for us -- we\u0027d actually have to change code to test it, but since we have to release our next release to production in 2 months, we can\u0027t use 3.0 for that.\r\n\r\nWe have 3-4 releases per year, and are tentatively planning to incorporate SkiaSharp 3.0 with \u0027fwidth\u0027 (contour lines) and the actual \u0027smoothstep\u0027 by our July 2024 release next year.",
        "createdAt": "2023-10-19T19:03:01",
        "reactions": []
      },
      {
        "id": 1773745129,
        "author": "taublast",
        "body": "maybe\r\n\u0060\u0060\u0060\r\n\r\n float smoothstep(float a, float b, float x) {\r\n        float t = clamp((x - a) / (b - a), 0.0, 1.0);\r\n        return t * t * (3.0 - 2.0 * t);\r\n    }\r\n\u0060\u0060\u0060",
        "createdAt": "2023-10-21T10:24:10",
        "reactions": [
          {
            "user": "najak3d",
            "content": "heart",
            "createdAt": "2026-02-06T12:57:09.4937561Z"
          }
        ]
      },
      {
        "id": 1773895543,
        "author": "najak3d",
        "body": "\u003E maybe\r\n\u003E \r\n\u003E \u0060\u0060\u0060\r\n\u003E \r\n\u003E  float smoothstep(float a, float b, float x) {\r\n\u003E         float t = clamp((x - a) / (b - a), 0.0, 1.0);\r\n\u003E         return t * t * (3.0 - 2.0 * t);\r\n\u003E     }\r\n\u003E \u0060\u0060\u0060\r\n\r\nThank you for this!",
        "createdAt": "2023-10-21T19:02:22",
        "reactions": []
      },
      {
        "id": 1817469240,
        "author": "najak3d",
        "body": "\u003E add this line to your nuget.config and enable prerelease\r\n\u003E \r\n\u003E \u0060\u003Cadd key=\u0022skiasharp-eap\u0022 value=\u0022https://aka.ms/skiasharp-eap/index.json\u0022 /\u003E \u0060\r\n\r\n@angelofb :\r\nI tried for about an hour to get this working... but no dice. (I went to every possible location for the Nuget.config.)\r\n\r\nIn Visual Studio 2022, Nuget still won\u0027t show me the Alpha release option for SkiaSharp.  I have \u0022pre-releases\u0022 checkbox checked in VStudio 2022, and can see the \u0022pre-releases\u0022 fine, but 2.88 is still the latest it shows in Visual Studio 2022.\r\n\r\nIs there some other way to get the 3.0 alpha?   Or got any tips on how to make Visual Studio show it?",
        "createdAt": "2023-11-18T10:23:00",
        "reactions": []
      },
      {
        "id": 1817762572,
        "author": "taublast",
        "body": "Have you checked the \u0022Include prerelease\u0022 option? Also make sure package source is not selected to show \u0022nuget.org\u0022 only.",
        "createdAt": "2023-11-19T06:28:06",
        "reactions": [
          {
            "user": "najak3d",
            "content": "heart",
            "createdAt": "2026-02-06T12:57:10.0624296Z"
          },
          {
            "user": "najak3d",
            "content": "rocket",
            "createdAt": "2026-02-06T12:57:10.06243Z"
          },
          {
            "user": "najak3d",
            "content": "hooray",
            "createdAt": "2026-02-06T12:57:10.0624301Z"
          },
          {
            "user": "najak3d",
            "content": "laugh",
            "createdAt": "2026-02-06T12:57:10.0624301Z"
          },
          {
            "user": "najak3d",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:57:10.0624302Z"
          }
        ]
      },
      {
        "id": 1817769435,
        "author": "najak3d",
        "body": "\u003E Have you checked the \u0022Include prerelease\u0022 option? Also make sure package source is not selected to show \u0022nuget.org\u0022 only.\r\n\r\nTHANKS!!  That worked -- I was set to \u0022nuget.org\u0022 -- I\u0027ve never noticed that setting before.  I changed it to \u0022skiasharp-eap\u0022 and now I can see the alpha releases.   I\u0027ll be trying those out very soon.\r\n\r\n![image](https://github.com/mono/SkiaSharp/assets/10914515/688cb1a8-0f1f-49f4-95c2-3990570d6798)\r\n",
        "createdAt": "2023-11-19T07:08:08",
        "reactions": []
      },
      {
        "id": 1885729384,
        "author": "mattleibow",
        "body": "Not sure if this issue is now resolved in v3?",
        "createdAt": "2024-01-10T21:03:47",
        "reactions": []
      },
      {
        "id": 1891118560,
        "author": "ghost",
        "body": "This issue has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **4 days**. It will be closed if no further activity occurs **within 3 days of this comment**. If it *is* closed, feel free to comment when you are able to provide the additional information and we will re-investigate.",
        "createdAt": "2024-01-15T00:00:33",
        "reactions": []
      },
      {
        "id": 1891164505,
        "author": "najak3d",
        "body": "\u003E Not sure if this issue is now resolved in v3?\r\n\r\nI\u0027m not sure yet either.   Is it supposedly resolved in v3?  I\u0027ve been hoping to push off validation of this until v3 reaches Beta, rather than while it\u0027s still in Alpha.",
        "createdAt": "2024-01-15T01:29:21",
        "reactions": []
      }
    ]
  }
}