{
  "number": 2368,
  "type": "issue",
  "state": "closed",
  "title": "[BUG][MemoryLeak] Animated SKPath causes memory leak. Example Project included",
  "body": "**Description**\r\n\r\nI\u0027m currently experimenting with animated SKPaths, but I stumbled upon a memory leak issue I couldn\u0027t resolve.\r\nI\u0027m not entirely sure but I suspect there is some unmanaged resource, which is not released correctly.\r\n(Either in SKPath, or in SKSurfce, maybe related to both?)\r\nI tried two different methods of creating an animated SKPath. Either by calling Reset() and rebuilding a new shape,\r\nor by calling Dispose() on the old path and creating a new one.\r\n\r\nBoth options result in a memory leak.\r\n\r\nSome further observations:\r\n- The memory leak affects both RAM and VRAM.\r\n- Forcing a garbage collection run does not free up the leaked memory.\r\n- The SKPaint settings (Antialias / Stroke / Fill) don\u0027t affect the memory leak. (Apparently)\r\n- SKCanvas matrix changes don\u0027t affect the memory leak. (Translation and Scale get applied each frame)\r\n- Only rebuilding but not drawing the path doesn\u0027t cause a memory leak.\r\n- Only drawing the same path, without rebuilding it, doesn\u0027t cause a memory leak. \r\n- Using dispose on the SKPath, instead of resetting and reusing it, doesn\u0027t stop the memory leak.\r\n- Disposing \u002B recreating or resetting \u002B rebuilding the SKPath but skipping the \u0022animation\u0022 (essentially re-adding the same points each frame) stops the memory leak?! (How is that even possible?)\r\n\r\nAfter digging though some of the Google Skias documentation about SKPath, I found the [isVolatile] flag.\r\nThe description of which sounds suspiciously like what is going wrong here:\r\n\r\n_Returns true if the path is volatile; it will not be altered or discarded by the caller after it is drawn.\r\n[SkPath](https://api.skia.org/classSkPath.html) by default have volatile set false, allowing [SkSurface](https://api.skia.org/classSkSurface.html) to attach a cache of data which speeds repeated drawing. If true, [SkSurface](https://api.skia.org/classSkSurface.html) may not speed repeated drawing._\r\n\r\nI don\u0027t know if the volatile setting was added to Skia in a later Version, than what SkiaSharp is build on, but both the Flag and the related setIsVolatile() function are absent in SkiaSharp.\r\n\r\n**Code**\r\n\r\nAlternative methods of creating the animated path (Running once each frame):\r\n\u0060\u0060\u0060\r\n//-----------------------------------------------------------------------------------------------------//\r\n//Reset and reuse existing SKPath\r\n//-----------------------------------------------------------------------------------------------------//\r\nPathBuffer.Reset();\r\n\r\n//Move to first point position\r\nPathBuffer.MoveTo(CurrentPoints[0].Position);\r\n\r\n//Connect bezier points\r\nfor (int x = 1; x \u003C CurrentPoints.Length; x\u002B\u002B)\r\n{\r\n\tPathBuffer.CubicTo(CurrentPoints[x - 1].HandleNext, CurrentPoints[x].HandleLast, CurrentPoints[x].Position);\r\n}\r\n\r\n//Close loop\r\nSKPoint first = PathBuffer.GetPoint(0);\r\nPathBuffer.CubicTo(CurrentPoints.Last().HandleNext, CurrentPoints[0].HandleLast, first);\r\nPathBuffer.Close();\r\n\u0060\u0060\u0060\r\n\r\n\u0060\u0060\u0060\r\n//-----------------------------------------------------------------------------------------------------//\r\n//Dispose old SKPath and create new SKPath\r\n//-----------------------------------------------------------------------------------------------------//\r\nPathBuffer.Reset();\r\nPathBuffer.Dispose();\r\nPathBuffer = new SKPath();\r\n\r\n//Move to first point position\r\nPathBuffer.MoveTo(CurrentPoints[0].Position);\r\n\r\n//Connect bezier points\r\nfor (int x = 1; x \u003C CurrentPoints.Length; x\u002B\u002B)\r\n{\r\n\tPathBuffer.CubicTo(CurrentPoints[x - 1].HandleNext, CurrentPoints[x].HandleLast, CurrentPoints[x].Position);\r\n}\r\n\r\n//Close loop\r\nSKPoint first = PathBuffer.GetPoint(0);\r\nPathBuffer.CubicTo(CurrentPoints.Last().HandleNext, CurrentPoints[0].HandleLast, first);\r\nPathBuffer.Close();\r\n\u0060\u0060\u0060\r\n\r\nDrawing the animated path to the screen:\r\n\u0060\u0060\u0060\r\n//Clear rendertarget\r\ngameTarget.Clear(new SKColor(0, 0, 0, 0));\r\n\r\n//Center canvas in the middle of the screen\r\ngameTarget.surface.Canvas.Translate(gameTarget.width / 2f, gameTarget.height / 2f);\r\n\r\n//Scale canvas (Path point coords are within -1 to 1 space)\r\ngameTarget.surface.Canvas.Scale(100f, 100f);\r\n\r\nusing (SKPaint paint = new SKPaint())\r\n{\r\n\tpaint.Color = new SKColor(255, 255, 255);\r\n\tpaint.IsAntialias = true;\r\n\tpaint.IsStroke = true;\r\n\tpaint.StrokeWidth = 0.02f;\r\n\r\n\tif (!DEBUG_SKIP_DRAW)\r\n\t{\r\n\t\t//Draw current path to canvas\r\n\t\tgameTarget.surface.Canvas.DrawPath(PathBuffer, paint);\r\n\t}\r\n}\r\n\r\n//Reset rendertarget matrix\r\ngameTarget.surface.Canvas.ResetMatrix();\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nCorrectly releasing all unmanaged data (and caches?) related to SKPath and SKSurface if SKPath gets disposed.\r\n\r\n**Actual Behavior**\r\n\r\nI have no idea, what is going on \u0022behind the curtains\u0022...\r\nAll I see is a 100mb of RAM leaking every 10 seconds. Even though I called Dispose() on everything I have access to.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.3, GPU Renderer\r\n- Last known good version:  Unknown\r\n- IDE:  Visual Studio 2022\r\n- Platform Target Frameworks: Windows10, .NET 7\r\n\r\n**Screenshots**\r\n\r\ndotMemory screenshot:\r\n![dotMemory](https://user-images.githubusercontent.com/7701826/215282730-e7c93cf4-bc03-441b-b0b3-5474115eb346.jpg)\r\n\r\n**Reproduction Link**\r\n\r\nVery simplified example project to showcase the memory leak issue. (Everything importand is in the DEBUG_SKPath.cs file)\r\nThis project uses .NET 7 and requires the newest version of Visual Studio 2022 to compile:\r\n[ExampleProjectFiles.zip](https://github.com/mono/SkiaSharp/files/10527777/ExampleProjectFiles.zip)\r\n\r\nMemory profile produced by JetBrains dotMemory profiler (I have not enough experience to know, what I have to look for):\r\n[MemoryProfiling.zip](https://github.com/mono/SkiaSharp/files/10527894/MemoryProfiling.zip)\r\n\r\n",
  "author": {
    "login": "AquilaAbriel",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-01-28T17:50:25",
  "updatedAt": "2025-03-09T16:33:23",
  "closedAt": "2025-03-07T16:11:38",
  "commentCount": 6,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:29:17.831457Z",
    "reactions": [],
    "comments": [
      {
        "id": 2706454158,
        "author": "najak3d",
        "body": "YES!  This is happening to us now, causing Application instability/crashing.   Our usage is less aggressive than yours, only rapid firing during user map panning where we replot the vector map lines rapidly -- using Reset() method.    Dispose() method might be better, but, still, the Reset() shouldn\u0027t be causing rampant memory leaks, and is our preference (seems more responsible than doing a rapid disposal of SKPaths).\n\nAdditionally, would love to have a means of \u0022maintaining the previous path buffers\u0022 - more like a \u0022SoftReset()\u0022 which maintains the buffer, and just refills it with the new data, rather than ditching/disposing of the buffer and making a new one each time.\n\nIt\u0027s a common use case for us to rapid-update the Paths... and in essence, we would like to just be \u0022changing the content of the buffers\u0022 - not ditching/disposing the old buffer and making new ones each time.\n",
        "createdAt": "2025-03-07T13:26:53",
        "reactions": []
      },
      {
        "id": 2706855398,
        "author": "AquilaAbriel",
        "body": "After my bug report was essentially ignored and the problem was not even acknowledged, I gave up on SkiaSharp.\nI have since rewritten my entire engine in Java and switched to Skija as an alternative to SkiaSharp.\n(This wasn\u0027t a perfect solution either, but at least the project maintainers are very responsive and genuinely helpful)\n\n**But as far as I can tell, the memory leak I reported was actually fixed at some point:**\nI just updated my debug project to SkiaSharp 3.116.1 and the bug seems to be fixed... So good job, I guess.\nToo bad I already spent literally a year porting my work to Java...\n\nSo for whatever it\u0027s worth, this issue has been resolved.",
        "createdAt": "2025-03-07T16:11:38",
        "reactions": []
      },
      {
        "id": 2707999906,
        "author": "mattleibow",
        "body": "@AquilaAbriel thanks for coming back to update the issue after over a year.\n\nI know it is frustrating to have your issue ignored. I apologize for that. I am pretty much working alone on this in between working on other products. You are not alone in your frustrations, both other folks and myself wish I could/would do more. I am working to get more time to focus on SkiaSharp. I would be spending more weekends and evenings on this, but we just got my first baby born a few months ago so I do need to spread the love.\n\nBut, thanks again for trying/using SkiaSharp. I hope for your next C# project you will try us again.",
        "createdAt": "2025-03-08T04:25:17",
        "reactions": [
          {
            "user": "AquilaAbriel",
            "content": "heart",
            "createdAt": "2026-02-06T13:29:17.1817391Z"
          },
          {
            "user": "najak3d",
            "content": "heart",
            "createdAt": "2026-02-06T13:29:17.1817397Z"
          }
        ]
      },
      {
        "id": 2708000187,
        "author": "mattleibow",
        "body": "@najak3d could you please open a new issue with your details and a repro for the issue that you are seeing. ",
        "createdAt": "2025-03-08T04:26:05",
        "reactions": [
          {
            "user": "najak3d",
            "content": "rocket",
            "createdAt": "2026-02-06T13:29:17.3812301Z"
          }
        ]
      },
      {
        "id": 2708909167,
        "author": "najak3d",
        "body": "\u003E [@najak3d](https://github.com/najak3d) could you please open a new issue with your details and a repro for the issue that you are seeing.\n\nI was able to fully switch over to SKIA 3.116.1, and this FULLY RESOLVES the memory leak!\n\nBUT - 3.116.1 is WORSE for us, currently, because there is a new crashing bug (even crashes it faster), associated with SKImage Disposal triggered by finalizer (might be other types of Disposal issues).  The error is:\n\n\u0022System.AccessViolationException: \u0027Attempted to read or write protected memory.  This is often an indication that other memory is corrupt.\u0027\n\nSo we\u0027re stuck with 2.8x - until this crash is fixed (which happens consistently within a few minutes of operation).\n\nHere are images - this one shows the Memory Leak Fixed (top=broken, vs bottom=fixed)\n![Screenshot](https://drive.google.com/uc?export=view\u0026id=1kClV_2w2wfnjEJJYazQIBsSN7JVY2QPh)\n\nHere are the images of the new 3.116.1 crash on finalizing SKImage:\n![Crash-Shot#1](https://drive.google.com/uc?export=view\u0026id=1Dna_ITYcoQwIdtYc_aH_RnuQ2Bwjoab7)\n\n![Crash-Shot#2](https://drive.google.com/uc?export=view\u0026id=1QH76_egvSNMcBqfOLwYB52EQlnh91_2m)\n\n\nI\u0027m available new 24/7 to iterate with you to getting this fixed. \n",
        "createdAt": "2025-03-09T15:15:48",
        "reactions": []
      },
      {
        "id": 2708949429,
        "author": "najak3d",
        "body": "The new bug that is preventing us from switching to Skia 3.x, is here:\n\n[Issue 2794](https://github.com/mono/SkiaSharp/issues/2794)",
        "createdAt": "2025-03-09T16:33:22",
        "reactions": []
      }
    ]
  }
}