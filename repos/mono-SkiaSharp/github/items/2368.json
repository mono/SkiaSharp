{
  "number": 2368,
  "type": "issue",
  "state": "closed",
  "title": "[BUG][MemoryLeak] Animated SKPath causes memory leak. Example Project included",
  "body": "**Description**\r\n\r\nI\u0027m currently experimenting with animated SKPaths, but I stumbled upon a memory leak issue I couldn\u0027t resolve.\r\nI\u0027m not entirely sure but I suspect there is some unmanaged resource, which is not released correctly.\r\n(Either in SKPath, or in SKSurfce, maybe related to both?)\r\nI tried two different methods of creating an animated SKPath. Either by calling Reset() and rebuilding a new shape,\r\nor by calling Dispose() on the old path and creating a new one.\r\n\r\nBoth options result in a memory leak.\r\n\r\nSome further observations:\r\n- The memory leak affects both RAM and VRAM.\r\n- Forcing a garbage collection run does not free up the leaked memory.\r\n- The SKPaint settings (Antialias / Stroke / Fill) don\u0027t affect the memory leak. (Apparently)\r\n- SKCanvas matrix changes don\u0027t affect the memory leak. (Translation and Scale get applied each frame)\r\n- Only rebuilding but not drawing the path doesn\u0027t cause a memory leak.\r\n- Only drawing the same path, without rebuilding it, doesn\u0027t cause a memory leak. \r\n- Using dispose on the SKPath, instead of resetting and reusing it, doesn\u0027t stop the memory leak.\r\n- Disposing \u002B recreating or resetting \u002B rebuilding the SKPath but skipping the \u0022animation\u0022 (essentially re-adding the same points each frame) stops the memory leak?! (How is that even possible?)\r\n\r\nAfter digging though some of the Google Skias documentation about SKPath, I found the [isVolatile] flag.\r\nThe description of which sounds suspiciously like what is going wrong here:\r\n\r\n_Returns true if the path is volatile; it will not be altered or discarded by the caller after it is drawn.\r\n[SkPath](https://api.skia.org/classSkPath.html) by default have volatile set false, allowing [SkSurface](https://api.skia.org/classSkSurface.html) to attach a cache of data which speeds repeated drawing. If true, [SkSurface](https://api.skia.org/classSkSurface.html) may not speed repeated drawing._\r\n\r\nI don\u0027t know if the volatile setting was added to Skia in a later Version, than what SkiaSharp is build on, but both the Flag and the related setIsVolatile() function are absent in SkiaSharp.\r\n\r\n**Code**\r\n\r\nAlternative methods of creating the animated path (Running once each frame):\r\n\u0060\u0060\u0060\r\n//-----------------------------------------------------------------------------------------------------//\r\n//Reset and reuse existing SKPath\r\n//-----------------------------------------------------------------------------------------------------//\r\nPathBuffer.Reset();\r\n\r\n//Move to first point position\r\nPathBuffer.MoveTo(CurrentPoints[0].Position);\r\n\r\n//Connect bezier points\r\nfor (int x = 1; x \u003C CurrentPoints.Length; x\u002B\u002B)\r\n{\r\n\tPathBuffer.CubicTo(CurrentPoints[x - 1].HandleNext, CurrentPoints[x].HandleLast, CurrentPoints[x].Position);\r\n}\r\n\r\n//Close loop\r\nSKPoint first = PathBuffer.GetPoint(0);\r\nPathBuffer.CubicTo(CurrentPoints.Last().HandleNext, CurrentPoints[0].HandleLast, first);\r\nPathBuffer.Close();\r\n\u0060\u0060\u0060\r\n\r\n\u0060\u0060\u0060\r\n//-----------------------------------------------------------------------------------------------------//\r\n//Dispose old SKPath and create new SKPath\r\n//-----------------------------------------------------------------------------------------------------//\r\nPathBuffer.Reset();\r\nPathBuffer.Dispose();\r\nPathBuffer = new SKPath();\r\n\r\n//Move to first point position\r\nPathBuffer.MoveTo(CurrentPoints[0].Position);\r\n\r\n//Connect bezier points\r\nfor (int x = 1; x \u003C CurrentPoints.Length; x\u002B\u002B)\r\n{\r\n\tPathBuffer.CubicTo(CurrentPoints[x - 1].HandleNext, CurrentPoints[x].HandleLast, CurrentPoints[x].Position);\r\n}\r\n\r\n//Close loop\r\nSKPoint first = PathBuffer.GetPoint(0);\r\nPathBuffer.CubicTo(CurrentPoints.Last().HandleNext, CurrentPoints[0].HandleLast, first);\r\nPathBuffer.Close();\r\n\u0060\u0060\u0060\r\n\r\nDrawing the animated path to the screen:\r\n\u0060\u0060\u0060\r\n//Clear rendertarget\r\ngameTarget.Clear(new SKColor(0, 0, 0, 0));\r\n\r\n//Center canvas in the middle of the screen\r\ngameTarget.surface.Canvas.Translate(gameTarget.width / 2f, gameTarget.height / 2f);\r\n\r\n//Scale canvas (Path point coords are within -1 to 1 space)\r\ngameTarget.surface.Canvas.Scale(100f, 100f);\r\n\r\nusing (SKPaint paint = new SKPaint())\r\n{\r\n\tpaint.Color = new SKColor(255, 255, 255);\r\n\tpaint.IsAntialias = true;\r\n\tpaint.IsStroke = true;\r\n\tpaint.StrokeWidth = 0.02f;\r\n\r\n\tif (!DEBUG_SKIP_DRAW)\r\n\t{\r\n\t\t//Draw current path to canvas\r\n\t\tgameTarget.surface.Canvas.DrawPath(PathBuffer, paint);\r\n\t}\r\n}\r\n\r\n//Reset rendertarget matrix\r\ngameTarget.surface.Canvas.ResetMatrix();\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nCorrectly releasing all unmanaged data (and caches?) related to SKPath and SKSurface if SKPath gets disposed.\r\n\r\n**Actual Behavior**\r\n\r\nI have no idea, what is going on \u0022behind the curtains\u0022...\r\nAll I see is a 100mb of RAM leaking every 10 seconds. Even though I called Dispose() on everything I have access to.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.3, GPU Renderer\r\n- Last known good version:  Unknown\r\n- IDE:  Visual Studio 2022\r\n- Platform Target Frameworks: Windows10, .NET 7\r\n\r\n**Screenshots**\r\n\r\ndotMemory screenshot:\r\n![dotMemory](https://user-images.githubusercontent.com/7701826/215282730-e7c93cf4-bc03-441b-b0b3-5474115eb346.jpg)\r\n\r\n**Reproduction Link**\r\n\r\nVery simplified example project to showcase the memory leak issue. (Everything importand is in the DEBUG_SKPath.cs file)\r\nThis project uses .NET 7 and requires the newest version of Visual Studio 2022 to compile:\r\n[ExampleProjectFiles.zip](https://github.com/mono/SkiaSharp/files/10527777/ExampleProjectFiles.zip)\r\n\r\nMemory profile produced by JetBrains dotMemory profiler (I have not enough experience to know, what I have to look for):\r\n[MemoryProfiling.zip](https://github.com/mono/SkiaSharp/files/10527894/MemoryProfiling.zip)\r\n\r\n",
  "author": {
    "login": "AquilaAbriel",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-01-28T17:50:25",
  "updatedAt": "2025-03-09T16:33:23",
  "closedAt": "2025-03-07T16:11:38",
  "commentCount": 6,
  "reactionCount": 0
}