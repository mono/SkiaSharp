{
  "number": 3139,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Encode overload with Stream destination produces \u0022corruption\u0022 at the bottom.",
  "body": "### Description\n\nThe overload of \u0060SKPixmap\u0060\r\n\u0060\u0060\u0060c#\r\npublic bool Encode(Stream dst, SKEncodedImageFormat encoder, int quality)\r\n\u0060\u0060\u0060\r\nis producing a black bar that is cropping the bottom part, but when i use this overload\r\n\u0060\u0060\u0060c#\r\npublic SKData Encode(SKEncodedImageFormat encoder, int quality)\r\n\u0060\u0060\u0060\r\nand _manually_ save the \u0060SKData\u0060 its fine without cropping the bottom part.\r\n\r\nIt might have been a \u0060SKManagedWStream\u0060 issue.\n\n### Code\n\n\u0060\u0060\u0060c#\r\nvar pxs = Marshal.AllocHGlobal(skInfo.BytesSize);\r\n\r\nvar bmp2 = new SKPixmap(skInfo.WithSize(640, 640), pxs);\r\nimage.ScalePixels(bmp2, SKSamplingOptions.Default);\r\n\r\nbmp2.Encode(File.Create(\u0022save2.png\u0022), SKEncodedImageFormat.Png, 100);\r\n\r\nvar enc = bmp2.Encode(SKEncodedImageFormat.Png, 100);\r\nvar f = File.Create(\u0022save3.png\u0022);\r\nenc.SaveTo(f);\r\n\u0060\u0060\u0060\n\n### Expected Behavior\n\nNo black bar just like \u0060save3.png\u0060\n\n### Actual Behavior\n\nProduces a black bar at the bottom for \u0060save2.png\u0060\n\n### Version of SkiaSharp\n\n3.116.0 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n3.116.0 (Current)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nWindows\n\n### Platform / Operating System Version\n\n_No response_\n\n### Devices\n\n_No response_\n\n### Relevant Screenshots\n\n# Save2.png\r\n\u003Cdetails\u003E\r\n\u003Csummary\u003Esave2.png\u003C/summary\u003E\r\n\r\n![save2](https://github.com/user-attachments/assets/0bc74fe4-6c99-4b43-9537-20961832b55f)\r\n\r\n\u003C/details\u003E\r\n\r\n# Save3.png\r\n\r\n\u003Cdetails\u003E\r\n\u003Csummary\u003Esave3.png\u003C/summary\u003E\r\n\r\n![save3](https://github.com/user-attachments/assets/2ceafd13-5a5c-46e0-bd0d-c49d7dfef439)\r\n\r\n\u003C/details\u003E\r\n\n\n### Relevant Log Output\n\n_No response_\n\n### Code of Conduct\n\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "ha-ves",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2025-01-14T09:47:26",
  "updatedAt": "2025-07-26T18:28:29",
  "closedAt": "2025-07-26T18:28:29",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:25:44.0488643Z",
    "reactions": [],
    "comments": [
      {
        "id": 2589465163,
        "author": "ha-ves",
        "body": "As I was writing this issue, I realized it has different behavior when uploaded to github.\r\nNotice the bottom part.\r\n![image](https://github.com/user-attachments/assets/79a02b86-6105-42fe-9f0b-1f52251f797d)\r\n",
        "createdAt": "2025-01-14T09:49:31",
        "reactions": []
      },
      {
        "id": 3121539862,
        "author": "molesmoke",
        "body": "Looks like a usage error. Fixing the code eliminates the problem:\n\n\u0060\u0060\u0060\n        using var bmp2 = new SKPixmap(skInfo.WithSize(640, 640), pxs);\n        image.ScalePixels(bmp2, SKSamplingOptions.Default);\n\n        using var f2 = File.Create(\u0022save2.png\u0022);\n        bmp2.Encode(f2, SKEncodedImageFormat.Png, 100);\n\n        using var enc = bmp2.Encode(SKEncodedImageFormat.Png, 100);\n        using var f3 = File.Create(\u0022save3.png\u0022);\n        enc.SaveTo(f3);\n\u0060\u0060\u0060",
        "createdAt": "2025-07-26T09:03:36",
        "reactions": []
      },
      {
        "id": 3122204124,
        "author": "ha-ves",
        "body": "@molesmoke, I forgot where the excerpt originated from.\n\nI tried again in 3.119.0 by loading a .png file and then the code, but it doesn\u0027t replicate the issue.\n\nSame with 3.116.0.\n\nMaybe because this time I used .net 9, or maybe something else.\n\nAs it seems no one else encountered this issue, I\u0027ll close this one.",
        "createdAt": "2025-07-26T18:28:29",
        "reactions": [
          {
            "user": "molesmoke",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:25:43.9986041Z"
          }
        ]
      }
    ]
  }
}