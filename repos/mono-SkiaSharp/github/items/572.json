{
  "number": 572,
  "type": "issue",
  "state": "closed",
  "title": "BadImageFormatException on .NET Framework 4.6.2 with AnyCPU setting AND Cannot found libskiasharp on desing view",
  "body": "### Description\r\n\r\nWe are having problems with SkiaSharp 1.60.2 when we try to run our desktop application. The problem, in our opinion, is that you are not choosing correctly between x64 and x86 when compiling the solution.\r\n\r\nOn the other hand, we are having problems with the design view of the forms that use skiasharp (we can not use the design view on that forms) and we believe that this error could be related to the previous one.\r\n\r\nI do not know if it will help or not, but if the problem is to decide on which platform to run the SkiaSharp version, a possible solution could be this:\r\n\r\n### Code\r\n\r\nvar uri = new Uri(typeof(DWGSpatialDriver).Assembly.CodeBase);\r\nvar path = Path.Combine(Path.GetDirectoryName(uri.LocalPath), IntPtr.Size == 8 ? \u0022x64\u0022 : \u0022x86\u0022);\r\n\r\n### Expected Behavior\r\n\r\n\u003C!-- a general description of what was the expected behavior or result --\u003E\r\n\r\n### Actual Behavior\r\n\r\n\u003C!-- a general description of what really happened --\u003E\r\n\r\n### Basic Information\r\n\r\n- Version with issue:  1.60.2\r\n- Last known good version:  \u003C!-- the version of SkiaSharp that still working --\u003E\r\n- IDE:  Visual Studio 2017 (15.7.4)\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Android: \u003C!-- the version of the Android SDK you are compiling against, e.g. 7.1 --\u003E \r\n  - Windows Classic: Windows 10  \u003C!-- the version of Windows you are building for, e.g. Windows 7 --\u003E\r\n- Target Devices:\r\n  -   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n\r\n### Screenshots\r\n\r\n\u003C!-- if the issue is a visual issue, please include screenshots showing the problem if possible --\u003E\r\n![image](https://user-images.githubusercontent.com/37209374/42156578-b9be7690-7deb-11e8-8def-fdd11a5c2049.png)\r\n\r\n\r\n\r\n### Reproduction Link\r\n\r\n\u003C!-- please upload or provide a link to a reproduction case --\u003E\n\n\u003E VS bug [#738682](https://devdiv.visualstudio.com/DevDiv/_workitems/edit/738682)",
  "author": {
    "login": "TerceraFaseSoftware",
    "type": "User"
  },
  "labels": [
    {
      "name": "area/SkiaSharp",
      "color": "0052cc"
    }
  ],
  "assignees": [
    {
      "login": "mattleibow",
      "type": "User"
    }
  ],
  "createdAt": "2018-07-02T09:36:03",
  "updatedAt": "2022-08-19T15:02:10",
  "closedAt": "2020-10-14T00:35:43",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:03:26.3039925Z",
    "reactions": [],
    "comments": [
      {
        "id": 637522844,
        "author": "Danielku15",
        "body": "I personally decided to rather load the native libs manually before start using SkiaSharp. It gives quite nice control about where to exactly load it from: \r\n\r\nSimplified version of the helper class I\u0027m using: \r\n\u0060\u0060\u0060cs\r\npublic static class SkiaHelper\r\n{\r\n\t[DllImport(\u0022kernel32.dll\u0022, CharSet = CharSet.Auto, SetLastError = true)]\r\n\tprivate static extern IntPtr LoadLibrary(string libname);\r\n\r\n\tpublic static void LoadNativeLibrary()\r\n\t{\r\n\t\tvar libSkiaSharpPath = Path.GetDirectoryName(typeof(Program).Assembly.Location);\r\n\t\tstring runtime;\r\n\t\tswitch (Environment.OSVersion.Platform)\r\n\t\t{\r\n\t\t\tcase PlatformID.MacOSX:\r\n\t\t\t\tlibSkiaSharpPath = Path.Combine(libSkiaSharpPath, \u0022runtimes\u0022, \u0022osx\u0022, \u0022native\u0022,\r\n\t\t\t\t\t\u0022libSkiaSharp.dylib\u0022);\r\n\t\t\t\tbreak;\r\n\t\t\tcase PlatformID.Unix:\r\n\t\t\t\truntime = IntPtr.Size == 4 ? \u0022tizen-x86\u0022 : \u0022tizen-x64\u0022;\r\n\t\t\t\tlibSkiaSharpPath = Path.Combine(libSkiaSharpPath, \u0022runtimes\u0022, runtime, \u0022native\u0022,\r\n\t\t\t\t\t\u0022libSkiaSharp.so\u0022);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\truntime = IntPtr.Size == 4 ? \u0022win-x86\u0022 : \u0022win-x64\u0022;\r\n\t\t\t\tlibSkiaSharpPath = Path.Combine(libSkiaSharpPath, \u0022runtimes\u0022, runtime, \u0022native\u0022,\r\n\t\t\t\t\t\u0022libSkiaSharp.dll\u0022);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\tConsole.WriteLine($\u0022Loading native lib from \u0027{libSkiaSharpPath}\u0027\u0022);\r\n\t\t\r\n\t\t// for .net core\r\n\t\t// var lib = System.Runtime.InteropServices.NativeLibrary.Load(libSkiaSharpPath);\r\n\t\t// for .net framework\r\n\t\tvar lib = LoadLibrary(libSkiaSharpPath);\r\n\t\t\r\n\t\tConsole.WriteLine(lib == IntPtr.Zero\r\n\t\t\t? $\u0022Loading native lib from \u0027{libSkiaSharpPath}\u0027 failed\u0022\r\n\t\t\t: $\u0022Loading native lib from \u0027{libSkiaSharpPath}\u0027 successful\u0022\r\n\t\t);\r\n\t}\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThe manual load is picked up by SkiaSharp. The different runtimes can be adopted based on the platforms you actually use and which libs you want to load. ",
        "createdAt": "2020-06-02T12:53:54",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:03:25.8506309Z"
          },
          {
            "user": "Peru-S",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:03:25.8506313Z"
          }
        ]
      },
      {
        "id": 708084007,
        "author": "mattleibow",
        "body": "I have recently worked a bit on the targets and the library to get them to work far better with .NET Framework.\r\nHowever, I am not sure if there is a way to reliably and generically load the libSkiaSharp.dll from the NuGet package - for the designer. \r\n\r\nThe good thing is that it works with the .NET Core designer.\r\n\r\nI am going to close this as the most probably way to make use of SkiaSharp in the old .NET Framework designer is to probably use the \u0060DesignMode\u0060 on controls and not actually draw anything.\r\n\r\nIf there is another way to get the net4x designer to work, then please open a new issue with any suggestions. I will also see what I can do with the designer teams.",
        "createdAt": "2020-10-14T00:35:43",
        "reactions": []
      },
      {
        "id": 1123041068,
        "author": "Peru-S",
        "body": "@Danielku15 Thank you for the great solution. \r\nThis is a major problem using a project that works on Windows 10 on a PC; the same project doesn\u0027t work on say, Windows 10 on a M1 because of the way SkiaSharp looks up the DLL.\r\nCould @Danielku15 \u0027s solution be incorporated as part of SkiaSharp itself please? @mattleibow :) \r\nI haven\u0027t experienced a similar problem with other components, so it seems particular to SkiaSharp (native lib).\r\nthank you in advance!\r\n",
        "createdAt": "2022-05-11T00:23:48",
        "reactions": []
      }
    ]
  }
}