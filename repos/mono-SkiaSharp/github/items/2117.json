{
  "number": 2117,
  "type": "issue",
  "state": "open",
  "title": "libHarfBuzzSharp.so symbols",
  "body": "Trying to build a libHarfBuzzSharp using the ninja build system.  I\u0027ve had good success building libSkiaSharp (I still need to report a few bugs with the build script).  The platform is a raspberry pi 3b\u002B running the latest 64 bit raspberry pi os.\r\n\r\nThe exact commands I ran from the mono/skia directory were:\r\n\r\n# run the gn build script generator:\r\n./bin/gn gen \u0027out/linux/arm64\u0027 --args=\u0027is_official_build=true\r\nskia_enable_tools=false\r\ntarget_os=\u0022linux\u0022\r\ntarget_cpu=\u0022arm64\u0022\r\nskia_use_icu=true\r\nskia_use_system_icu=true\r\nskia_use_harfbuzz=true\r\nskia_use_system_harfbuzz=true\r\nskia_pdf_subset_harfbuzz=false\r\nskia_use_sfntly=false\r\nskia_use_piex=true\r\nskia_use_system_expat=false\r\nskia_use_system_freetype2=true\r\nskia_use_system_libjpeg_turbo=true\r\nskia_use_system_libpng=true\r\nskia_use_system_libwebp=true\r\nskia_use_system_zlib=true\r\nskia_enable_gpu=true\r\nextra_cflags=[ \u0022-DSKIA_C_DLL\u0022, \u0022-DHAVE_PTHREAD\u0022, \u0022-DHB_EXTERN=extern\u0022, \u0022-I/usr/local/lib/aarch64-linux-gnu/harfbuzz/include/\u0022, \u0022-I/usr/include/freetype2/\u0022 ]\u0027\r\n--cflags=\u0027[ \u0022-DSKIA_C_DLL\u0022, \u0022-DHAVE_PTHREAD\u0022, \u0022-DHB_EXTERN=extern\u0022, \u0022-I/usr/local/lib/aarch64-linux-gnu/harfbuzz/include/\u0022, \u0022-I/usr/include/freetype2/\u0022 ]\u0027\r\n\r\n# build libSkiaSharp (no issues here, the build and generated library are a success)\r\nninja \u0027SkiaSharp\u0027 -C \u0027/out/linux/arm64\u0027\r\n\r\n# build libHarfBuzzSharp (builds fine, issues occur later...)\r\nninja \u0027HarfBuzzSharp\u0027 -C \u0027/out/linux/arm64\u0027\r\n\r\n# copy the built libSkiaSharp.so and libHarfBuzzSharp.so files to the project that needs them (UVTools), then run\r\nLD_DEBUG=libs dotnet UVTools.dll\r\n\r\n# get a bunch of output text, then the issue occurs as:\r\n..... libHarfBuzzSharp.so: error: symbol lookup error: undefined symbol: hb_face_create_for_tables (fatal)\r\n\r\n# running \u0027readelf -Ws --dyn-syms libHarfBuzzSharp.so\u0027 gives a *very* short list of symbols, none of which seem to have anything to do with harfbuzz\r\n  _ITM_deregisterTMCloneTable\r\n __cxa_finalize@GLIBC_2.17 (2)\r\n __gmon_start__\r\n __getauxval@GLIBC_2.17 (2)\r\n  _ITM_registerTMCloneTable\r\n\r\n# I\u0027ve also built SkiaSharp and HarfBuzzSharp using almost all of the third_party options (non skia_use_system_... build), and get the same result.  (I\u0027ve probably built the pair 10 times in the last couple of weeks, each time trying something slightly different).\r\n\r\nAt this point one thing is obvious: I\u0027m doing something wrong.  Any chance anyone can help me out?\r\n",
  "author": {
    "login": "TruckDynasty",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-06-17T00:04:24",
  "updatedAt": "2022-06-27T10:47:02",
  "commentCount": 2,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:20:47.407322Z",
    "reactions": [],
    "comments": [
      {
        "id": 1158674970,
        "author": "TruckDynasty",
        "body": "got it compiled today, had to edit more build scripts: removed -fvisibility=hidden from cflags and -fvisibility-inlines-hidden from cflags_cc, then added -shared and -rdynamic to ldflags\r\n\r\nthe symbols all show up, but the source built libHarfBuzzSharp gives me the same issues as the nuget libHarfBuzzSharp: it seg faults as soon as it loads\r\n\r\nI think I\u0027m going to throw in the bandana until arm64 platforms are better supported by dotnet and others, but I appreciate everyone\u0027s hard work!  new architectures are never fun for anyone",
        "createdAt": "2022-06-17T09:15:34",
        "reactions": []
      },
      {
        "id": 1167194629,
        "author": "TruckDynasty",
        "body": "Revisiting:\r\nrun \u0027gdb dotnet\u0027 to start dotnet\r\nthen \u0027run /opt/UVtools-3.4.3/UVtools.WPF/bin/Debug/net6.0/UVtools.dll\u0027 to load up the compiled dotnet project\r\n... bunch of output as threads spawn ...\r\nThread 1 \u0022dotnet\u0022 received signal SIGSEGV, Segmentation fault.\r\n0x0000000000000000 in ?? ()\r\n(gdb) bt\r\n/#0  0x0000000000000000 in ()\r\n/#1  0x0000007f80b40c7c in ()\r\n/#2  0x0000007ff7a29000 in vtable for InlinedCallFrame () at /opt/dotnet-sdk-6.0.103/shared/Microsoft.NETCore.App/6.0.3/libcoreclr.so\r\n\r\nAlso:\r\nrun LD_DEBUG=libs dotnet /opt/UVtools-3.4.3/UVtools.WPF/bin/Debug/net6.0/UVtools.dll\r\n... bunch of library load output ...\r\ncalling init:  /opt/UVTools-3.4.3/UVtools.WPF/bin/Debug/net6.0/runtimes/linux-arm64/native/libHarfbuzzSharp.so\r\nSegmentation Fault\r\n\r\n(NOTE: I moved the libHarfbuzzSharp.so and libSkiaSharp.so from the source build dir to the directory listed above as well as to the system library)\r\n\r\ndoes this help at all??  I really wish I could help more with this, UVtools is also an app built on Avalonia, which needs libHarfbuzzSharp (at least for this project)\r\n\r\nI also just finished recompiling openssl 1.1.1, openssl 3, and dotnet from source (the prebuilt dotnet 6\u0027s have serious issues right now with the dated versions of ossl that ship with raspberry pi os).  I\u0027ll try harfbuzz, libSkiaSharp, libHarfbuzzSharp, then UVTools and see if anything changes",
        "createdAt": "2022-06-27T10:47:02",
        "reactions": []
      }
    ]
  }
}