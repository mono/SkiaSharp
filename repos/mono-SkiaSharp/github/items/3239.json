{
  "number": 3239,
  "type": "issue",
  "state": "open",
  "title": "[BUG] InvalidateMeasure doesn\u0027t call MeasureOverride after the first call.",
  "body": "### Description\n\nI have two different cases where this occurs.  The scenario is essentially the same for both.\n\nSkLabel: A custom control derived from SKCanvasView\nGlyphView: A custom control derived from SKCanvasView\n\nI\u0027m using SkiaSharp.Views.Maui.Controls Version 3.116.1. I haven\u0027t tried it on earlier versions.\n\nIn both cases, I\u0027m attempting to resize the SKCanvasView based on the contents.\n\nFor SkLabel, I define various properties to configure the font to use to draw the text. The propertyChanged handles each call InvalidateMeasure.\n\nThe desired size is calculated in MeasureSize based on the text and the font properties.\n\nAfter the first successful MeasureOverride, I trigger a change to one of the font properties, such as FontSize.  InvalidateMeasure is called but MeasureOverride is not called and the canvas is not resized.\n\nI\u0027ve debugged into the InvalidateMeasure call to see the handler resolve to SKCanvasViewHandlerSkiaSharp.Views.Maui.Handlers.SKCanvasViewHandler\n***\n\u003EMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.Element.Handler.get() Line 380\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.Handler.get() Line 1054\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureOverride() Line 2142\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.Microsoft.Maui.IView.InvalidateMeasure() Line 2137\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureInternal(Microsoft.Maui.Controls.InvalidationEventArgs eventArgs) Line 1712\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureInternal(Microsoft.Maui.Controls.Internals.InvalidationTrigger trigger) Line 1699\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasure() Line 1616\tC#\nGlyphViewer.dll!GlyphViewer.Controls.SkLabel.InvalidateTextMetrics() Line 300\tC#\n***\n\nOnce it resolves I reach the _commandMapper?.Invoke but I\u0027m not able to debug into it.\n\n_commandMapper?.Invoke(this, VirtualView, command, args);\n\n***\n\u003E Microsoft.Maui.dll!Microsoft.Maui.Handlers.ElementHandler.Invoke(string command, object args) Line 94\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureOverride() Line 2143\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.Microsoft.Maui.IView.InvalidateMeasure() Line 2137\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureInternal(Microsoft.Maui.Controls.InvalidationEventArgs eventArgs) Line 1712\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasureInternal(Microsoft.Maui.Controls.Internals.InvalidationTrigger trigger) Line 1699\tC#\nMicrosoft.Maui.Controls.dll!Microsoft.Maui.Controls.VisualElement.InvalidateMeasure() Line 1616\tC#\nGlyphViewer.dll!GlyphViewer.Controls.SkLabel.InvalidateTextMetrics() Line 300\tC#\n***\n\nThe scenario for GlyphView is simpler since it has a single value that changes the size but the failure is the same. After the first MeasureOverride call, InvalidateMeasure no longer results subsequent MeasureOverride calls.\n\n\n### Code\n\nThe SkLabel issue is illustrated here:  https://github.com/DanTravison/GlyphViewer/blob/Preferences/Controls/SkLabel.cs\n\n* Refer to the comments in InvalidateTextMetrics and MeasureOverride.\n* In each case, explicitly setting HeightRequest in these two methods is required to workaround the issue.\n\nThe GlyphView issue is here: \nhttps://github.com/DanTravison/GlyphViewer/blob/Preferences/Views/GlyphView.cs\n* Refer to the comments in OnGlyphChanged().\n* Again, explicitly setting HeightRequest is required to workaround the issue. \n\nTo repro The SkLabel case:\n1: Sync the repro and use the Preferences branch\n2: Edit Controls\\SkLabel and comment out the two calls to setting HeightRequest.\n3: Build/Run the app\n4: Select the gear icon in the upper left.\n5: Use any of the sliders adjacent to the font option sizes and not that the same text does not change.\n\nI\u0027ll see if I can repro this with a simpler app.\n\n### Expected Behavior\n\nAfter calling InvalidateMeasure, MeasureOverride should be called prior to calling OnPaintSurface\n\n### Actual Behavior\n\nAfter the first MeasureOverride occurs, calling InvalidateMeasure no longer causes MeasureOverride to occur.\n\n### Version of SkiaSharp\n\n3.116.0 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.9 (Previous)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nWindows\n\n### Platform / Operating System Version\n\nI\u0027ve only tested this on Windows 11 so far.\n\n### Devices\n\nWindows 11 Desktop\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n\u0060\u0060\u0060shell\n\n\u0060\u0060\u0060\n\n### Code of Conduct\n\n- [x] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "DanTravison",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2025-04-20T03:32:35",
  "updatedAt": "2025-06-18T13:47:58",
  "commentCount": 5,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:43:35.8587441Z",
    "reactions": [],
    "comments": [
      {
        "id": 2818462955,
        "author": "DanTravison",
        "body": "I added a sample application that illustrates the issue [here](https://github.com/DanTravison/SKInvalidateMeasure)\nThe sample has three instances of an SkLabel\n1: Directly in the root layout (VerticalStackLayout)\n2: In a nested HorizontalStackLayout\n3: In a nested Grid\nA Maui Label in a nested HorizontalStackLayout\nA \u0027Try Workaround\u0027 checkbox to enable/disable the workaround.\nA  \u0027[\u002B]\u0027 and \u0027[-]\u0027 button allow changing the font size in the view model\n\nAll labels bind the FontSize to the view model.\nSkLabel.InvalidateTextMetrics contains a workaround that set WidthRequest and HeightRequest when a font property changes.\n\nResults:\n* The Maui Label and the \u0027root\u0027 SkLabel both resize as expected when the font size changes.\n* The two nested SkLabel instances don\u0027t resize unless the \u0027Try Workaround\u0027 checkbox is checked.\n",
        "createdAt": "2025-04-21T13:58:20",
        "reactions": []
      },
      {
        "id": 2831279037,
        "author": "janne-hmp",
        "body": "I had the a similar problem, which I reported over a year ago. Luckily, there\u0027s a workaround: https://github.com/mono/SkiaSharp/issues/2811#issuecomment-2028482236\n\nIt would be great if @mattleibow would have time to fix this, possibly just like in the workaround.",
        "createdAt": "2025-04-25T19:33:33",
        "reactions": []
      },
      {
        "id": 2881877985,
        "author": "DanTravison",
        "body": "I\u0027m curious what the expectations are here @mattleibow. Do I need to implement the workaround or is it going to be addressed in SkiaSharp?\n\nI have 9 projects that use SkiaSharp and would rather limit the regression testing to an upgrade of SkiaSharp versus a fix now and an upgrade later.\n\nAs it stands, my current workaround where I encounter it, is just too fragile.\n\nThanks,\nDan.",
        "createdAt": "2025-05-15T00:17:53",
        "reactions": []
      },
      {
        "id": 2972009152,
        "author": "DanTravison",
        "body": "@janne-hmp When I look at the suggested workaround, I have to wonder if the custom SKCanvasView is even needed.\n\nWhy isn\u0027t it sufficient to call SKCanvasView.DesiredSize in the handler and, if empty, call base.GetDesiredSize.\n\nWith this approach, I don\u0027t need to change my SKCanvasView classes to use the workaround, I simply register the handler.\n\nThis resolves my issue, but I don\u0027t know if there are other paths I\u0027m not aware of or not hitting.\n\nMy handler looks like the following:\n\u0060\u0060\u0060\n/// \u003Csummary\u003E\n/// Provides a custom \u003Csee cref=\u0022SKCanvasViewHandler\u0022/\u003E for handing issue 18700 https://github.com/mono/SkiaSharp/issues/3239\n/// \u003C/summary\u003E\ninternal class CanvasViewHandler : SKCanvasViewHandler\n{\n    public override Size GetDesiredSize(double widthConstraint, double heightConstraint)\n    {\n        Size size = Size.Zero;\n        if (this.VirtualView is SKCanvasView view)\n        {\n            size = view.DesiredSize;\n        }\n        if (size == Size.Zero)\n        {\n            size = base.GetDesiredSize(widthConstraint, heightConstraint);\n        }\n        return size;\n    }\n}\n\u0060\u0060\u0060\n\nI enable it with a MauiAppBuilder extension:\n\u0060\u0060\u0060\n/// \u003Csummary\u003E\n/// Provides a \u003Csee cref=\u0022MauiAppBuilder\u0022/\u003E for configuring the \u003Csee cref=\u0022CanvasView\u0022/\u003E.\n/// \u003C/summary\u003E\npublic static class CanvasViewExtensions\n{\n    public static MauiAppBuilder UseCanvasView(this MauiAppBuilder builder)\n    {\n        builder.ConfigureMauiHandlers(handlers =\u003E\n        {\n            handlers.AddHandler\u003CSKCanvasView, CanvasViewHandler\u003E();\n        });\n        return builder;\n    }\n}\n\u0060\u0060\u0060\n\n",
        "createdAt": "2025-06-14T00:09:45",
        "reactions": []
      },
      {
        "id": 2984295317,
        "author": "DanTravison",
        "body": "FYI: It turns out the overriding SKCanvasViewHandler.GetDesiredSize does not fix the issue for me.  I must still set HeightRequest to ensure MeasureOverride is called.\n\n @mattleibow: Is this a problem with SkiaSharp or is it in Maui?  I\u0027m not aware of other cases where I need to explicitly set HeightRequest to ensure MeasureOverride is called.\n\nThanks.",
        "createdAt": "2025-06-18T13:47:58",
        "reactions": []
      }
    ]
  }
}