{
  "number": 2224,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Blazor \u0060SKGLView\u0060 randomly throws \u0060memory access out of bounds\u0060 when using \u0060SKImageFilter\u0060 or \u0060SKMaskFilter\u0060",
  "body": "**Description**\r\n\r\nRandom \u0060memory access out of bounds\u0060 exceptions being thrown when using \u0060SKGLView\u0060 component in Blazor standalone wasm application and trying to draw shapes with \u0060SKImageFilter\u0060 or \u0060SKMaskFilter\u0060 provided for \u0060SKPaint\u0060. When this happens nothing is drawn to the canvas and render loop crashes.\r\n\r\nOn the contrary \u0060SKCanvasView\u0060 Blazor component looks stable and doesn\u0027t crash. \r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\n\u003CSKGLView IgnorePixelScaling=\u0022true\u0022 EnableRenderLoop=\u0022true\u0022 OnPaintSurface=\u0022OnPaintSurface\u0022/\u003E\r\n\r\n@code {\r\n  void OnPaintSurface(SKPaintGLSurfaceEventArgs e)\r\n  {\r\n      var canvas = e.Surface.Canvas;\r\n  \r\n      // below is a sample from:\r\n      // https://docs.microsoft.com/en-us/xamarin/xamarin-forms/user-interface/graphics/skiasharp/effects/image-filters\r\n  \r\n      float dx = 5;\r\n      float dy = 5;\r\n      float sigmaX = 3.5f;\r\n      float sigmaY = 3.5f;\r\n  \r\n      using (SKPaint paint = new SKPaint())\r\n      {\r\n          // Set SKPaint properties\r\n          paint.TextSize = 100;\r\n          paint.Color = SKColors.Blue;\r\n  \r\n          // ImageFilter leads to a \u0022memory access out of bounds\u0022 exception\r\n          // while the application is running\r\n          paint.ImageFilter = SKImageFilter.CreateDropShadow(dx, dy, sigmaX, sigmaY, SKColors.Red);\r\n  \r\n          float xText = 0;\r\n          float yText = 100;\r\n  \r\n          canvas.DrawText(\u0022SKIA\u0022, xText, yText, paint);\r\n      }\r\n  }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nSkiaSharp wasm render loop shouldn\u0027t crash when \u0060SKImageFilter\u0060 or \u0060SKMaskFilter\u0060 is used.\r\n\u003Cdetails\u003E\r\n \u003Csummary\u003EException stack trace\u003C/summary\u003E\r\n\r\n\u0060\u0060\u0060\r\n Uncaught RuntimeError: memory access out of bounds\r\n    at SkSL::VariableReference::constantPropagate(SkSL::IRGenerator const\u0026, SkTHashMap\u003CSkSL::Variable const*, std::__2::unique_ptr\u003CSkSL::Expression, std::__2::default_delete\u003CSkSL::Expression\u003E \u003E*, SkGoodHash\u003E const\u0026) (04df2e02:0x1dd486)\r\n    at SkSL::Compiler::simplifyExpression(SkTHashMap\u003CSkSL::Variable const*, std::__2::unique_ptr\u003CSkSL::Expression, std::__2::default_delete\u003CSkSL::Expression\u003E \u003E*, SkGoodHash\u003E\u0026, SkSL::BasicBlock\u0026, std::__2::__wrap_iter\u003CSkSL::BasicBlock::Node*\u003E*, SkSL::Compiler::OptimizationContext*) (04df2e02:0x23c3f6)\r\n    at SkSL::Compiler::scanCFG(SkSL::FunctionDefinition\u0026, SkSL::ProgramUsage*) (04df2e02:0x23f952)\r\n    at SkSL::Compiler::optimize(SkSL::Program\u0026) (04df2e02:0x240573)\r\n    at SkSL::Compiler::convertProgram(SkSL::Program::Kind, SkSL::String, SkSL::Program::Settings const\u0026, std::__2::vector\u003Cstd::__2::unique_ptr\u003CSkSL::ExternalValue, std::__2::default_delete\u003CSkSL::ExternalValue\u003E \u003E, std::__2::allocator\u003Cstd::__2::unique_ptr\u003CSkSL::ExternalValue, std::__2::default_delete\u003CSkSL::ExternalValue\u003E \u003E \u003E \u003E const*) (04df2e02:0x2402c2)\r\n    at GrSkSLtoGLSL(GrGLContext const\u0026, SkSL::Program::Kind, SkSL::String const\u0026, SkSL::Program::Settings const\u0026, SkSL::String*, GrContextOptions::ShaderErrorHandler*) (04df2e02:0x24bf79)\r\n    at GrGLProgramBuilder::finalize(GrGLPrecompiledProgram const*) (04df2e02:0x24cca7)\r\n    at GrGLProgramBuilder::CreateProgram(GrGLGpu*, GrRenderTarget*, GrProgramDesc const\u0026, GrProgramInfo const\u0026, GrGLPrecompiledProgram const*) (04df2e02:0x24c614)\r\n    at GrGLGpu::ProgramCache::findOrCreateProgram(GrRenderTarget*, GrProgramDesc const\u0026, GrProgramInfo const\u0026, GrGpu::Stats::ProgramCacheResult*) (04df2e02:0x250270)\r\n    at GrGLGpu::ProgramCache::findOrCreateProgram(GrRenderTarget*, GrProgramInfo const\u0026) (04df2e02:0x2500a6)\r\n$SkSL::VariableReference::constantPropagate(SkSL::IRGenerator const\u0026, SkTHashMap\u003CSkSL::Variable const*, std::__2::unique_ptr\u003CSkSL::Expression, std::__2::default_delete\u003CSkSL::Expression\u003E \u003E*, SkGoodHash\u003E const\u0026)\t@\t04df2e02:0x1dd486\r\n$SkSL::Compiler::simplifyExpression(SkTHashMap\u003CSkSL::Variable const*, std::__2::unique_ptr\u003CSkSL::Expression, std::__2::default_delete\u003CSkSL::Expression\u003E \u003E*, SkGoodHash\u003E\u0026, SkSL::BasicBlock\u0026, std::__2::__wrap_iter\u003CSkSL::BasicBlock::Node*\u003E*, SkSL::Compiler::OptimizationContext*)\t@\t04df2e02:0x23c3f6\r\n$SkSL::Compiler::scanCFG(SkSL::FunctionDefinition\u0026, SkSL::ProgramUsage*)\t@\t04df2e02:0x23f952\r\n$SkSL::Compiler::optimize(SkSL::Program\u0026)\t@\t04df2e02:0x240573\r\n$SkSL::Compiler::convertProgram(SkSL::Program::Kind, SkSL::String, SkSL::Program::Settings const\u0026, std::__2::vector\u003Cstd::__2::unique_ptr\u003CSkSL::ExternalValue, std::__2::default_delete\u003CSkSL::ExternalValue\u003E \u003E, std::__2::allocator\u003Cstd::__2::unique_ptr\u003CSkSL::ExternalValue, std::__2::default_delete\u003CSkSL::ExternalValue\u003E \u003E \u003E \u003E const*)\t@\t04df2e02:0x2402c2\r\n$GrSkSLtoGLSL(GrGLContext const\u0026, SkSL::Program::Kind, SkSL::String const\u0026, SkSL::Program::Settings const\u0026, SkSL::String*, GrContextOptions::ShaderErrorHandler*)\t@\t04df2e02:0x24bf79\r\n$GrGLProgramBuilder::finalize(GrGLPrecompiledProgram const*)\t@\t04df2e02:0x24cca7\r\n$GrGLProgramBuilder::CreateProgram(GrGLGpu*, GrRenderTarget*, GrProgramDesc const\u0026, GrProgramInfo const\u0026, GrGLPrecompiledProgram const*)\t@\t04df2e02:0x24c614\r\n$GrGLGpu::ProgramCache::findOrCreateProgram(GrRenderTarget*, GrProgramDesc const\u0026, GrProgramInfo const\u0026, GrGpu::Stats::ProgramCacheResult*)\t@\t04df2e02:0x250270\r\n$GrGLGpu::ProgramCache::findOrCreateProgram(GrRenderTarget*, GrProgramInfo const\u0026)\t@\t04df2e02:0x2500a6\r\n$GrGLGpu::flushGLState(GrRenderTarget*, GrProgramInfo const\u0026)\t@\t04df2e02:0x25bce7\r\n$GrGLOpsRenderPass::onBindPipeline(GrProgramInfo const\u0026, SkRect const\u0026)\t@\t04df2e02:0x253c26\r\n$GrOpsRenderPass::bindPipeline(GrProgramInfo const\u0026, SkRect const\u0026)\t@\t04df2e02:0x16f18d\r\n$(anonymous namespace)::FillRectOp::onExecute(GrOpFlushState*, SkRect const\u0026)\t@\t04df2e02:0x2a8086\r\n$GrOp::execute(GrOpFlushState*, SkRect const\u0026)\t@\t04df2e02:0x2cb4a4\r\n$GrOpsTask::onExecute(GrOpFlushState*)\t@\t04df2e02:0x2cb309\r\n$GrDrawingManager::executeRenderTasks(int, int, GrOpFlushState*, int*)\t@\t04df2e02:0x2d17f7\r\n$GrDrawingManager::flush(SkSpan\u003CGrSurfaceProxy*\u003E, SkSurface::BackendSurfaceAccess, GrFlushInfo const\u0026, GrBackendSurfaceMutableState const*)\t@\t04df2e02:0x2d11c2\r\n$GrDrawingManager::flushSurfaces(SkSpan\u003CGrSurfaceProxy*\u003E, SkSurface::BackendSurfaceAccess, GrFlushInfo const\u0026, GrBackendSurfaceMutableState const*)\t@\t04df2e02:0x2d19b0\r\n$GrSurfaceContext::flush(SkSurface::BackendSurfaceAccess, GrFlushInfo const\u0026, GrBackendSurfaceMutableState const*)\t@\t04df2e02:0x2da49c\r\n$SkGpuDevice::flush()\t@\t04df2e02:0x3383be\r\n$SkCanvas::onFlush()\t@\t04df2e02:0x33ff8a\r\n$SkCanvas::flush()\t@\t04df2e02:0x33ff67\r\n$sk_canvas_flush\t@\t04df2e02:0x4b05aa\r\n$do_icall\t@\t04df2e02:0x4fa72c\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_invoke_checked\t@\t04df2e02:0x57a188\r\n$mono_runtime_try_invoke_array\t@\t04df2e02:0x57ed7f\r\n$mono_runtime_invoke_array_checked\t@\t04df2e02:0x57f454\r\n$ves_icall_InternalInvoke\t@\t04df2e02:0x55318e\r\n$ves_icall_InternalInvoke_raw\t@\t04df2e02:0x55a9a9\r\n$do_icall\t@\t04df2e02:0x4fa7f8\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_try_invoke\t@\t04df2e02:0x57a991\r\n$mono_runtime_invoke\t@\t04df2e02:0x57cd4c\r\n$mono_wasm_invoke_method\t@\t04df2e02:0x7381d2\r\nModule._mono_wasm_invoke_method\t@\tdotnet..perw0yxp0m.js:11779\r\nmanaged__Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_InvokeDotNet\t@\tmanaged__Microsoft_A\u2026ime_InvokeDotNet:19\r\ninvokeDotNetFromJS\t@\tblazor.webassembly.js:1\r\ng\t@\tblazor.webassembly.js:1\r\ninvokeMethod\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tSKHtmlCanvas.js:101\r\nrequestAnimationFrame (async)\t\t\r\nrequestAnimationFrame\t@\tSKHtmlCanvas.js:96\r\nsetEnableRenderLoop\t@\tSKHtmlCanvas.js:113\r\nrequestAnimationFrame\t@\tSKHtmlCanvas.js:86\r\nrequestAnimationFrame\t@\tSKHtmlCanvas.js:66\r\ninvokeJSFromDotNet\t@\tblazor.webassembly.js:1\r\nSt\t@\tblazor.webassembly.js:1\r\n_mono_wasm_invoke_js_blazor\t@\tdotnet..perw0yxp0m.js:10644\r\n$do_icall\t@\t04df2e02:0x4fa857\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_try_invoke\t@\t04df2e02:0x57a991\r\n$mono_runtime_invoke\t@\t04df2e02:0x57cd4c\r\n$mono_wasm_invoke_method\t@\t04df2e02:0x7381d2\r\nModule._mono_wasm_invoke_method\t@\tdotnet..perw0yxp0m.js:11779\r\nmanaged__Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_EndInvokeJS\t@\tmanaged__Microsoft_A\u2026time_EndInvokeJS:16\r\nendInvokeJSFromDotNet\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tblazor.webassembly.js:1\r\nPromise.then (async)\t\t\r\nbeginInvokeJSFromDotNet\t@\tblazor.webassembly.js:1\r\nSt\t@\tblazor.webassembly.js:1\r\n_mono_wasm_invoke_js_blazor\t@\tdotnet..perw0yxp0m.js:10644\r\n$do_icall\t@\t04df2e02:0x4fa857\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_try_invoke\t@\t04df2e02:0x57a991\r\n$mono_runtime_invoke\t@\t04df2e02:0x57cd4c\r\n$mono_wasm_invoke_method\t@\t04df2e02:0x7381d2\r\nModule._mono_wasm_invoke_method\t@\tdotnet..perw0yxp0m.js:11779\r\nmanaged__Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_EndInvokeJS\t@\tmanaged__Microsoft_A\u2026time_EndInvokeJS:16\r\nendInvokeJSFromDotNet\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tblazor.webassembly.js:1\r\nPromise.then (async)\t\t\r\nbeginInvokeJSFromDotNet\t@\tblazor.webassembly.js:1\r\nSt\t@\tblazor.webassembly.js:1\r\n_mono_wasm_invoke_js_blazor\t@\tdotnet..perw0yxp0m.js:10644\r\n$do_icall\t@\t04df2e02:0x4fa857\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_invoke_checked\t@\t04df2e02:0x57a188\r\n$mono_runtime_try_invoke_array\t@\t04df2e02:0x57ed7f\r\n$mono_runtime_invoke_array_checked\t@\t04df2e02:0x57f454\r\n$ves_icall_InternalInvoke\t@\t04df2e02:0x55318e\r\n$ves_icall_InternalInvoke_raw\t@\t04df2e02:0x55a9a9\r\n$do_icall\t@\t04df2e02:0x4fa7f8\r\n$do_icall_wrapper\t@\t04df2e02:0x4f9a2b\r\n$interp_exec_method\t@\t04df2e02:0x4eba3b\r\n$interp_runtime_invoke\t@\t04df2e02:0x4ea8f2\r\n$mono_jit_runtime_invoke\t@\t04df2e02:0x6cd936\r\n$do_runtime_invoke\t@\t04df2e02:0x57a200\r\n$mono_runtime_try_invoke\t@\t04df2e02:0x57a991\r\n$mono_runtime_invoke\t@\t04df2e02:0x57cd4c\r\n$mono_wasm_invoke_method\t@\t04df2e02:0x7381d2\r\nModule._mono_wasm_invoke_method\t@\tdotnet..perw0yxp0m.js:11779\r\nmanaged__Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_BeginInvokeDotNet\t@\tmanaged__Microsoft_A\u2026eginInvokeDotNet:19\r\nbeginInvokeDotNetFromJS\t@\tblazor.webassembly.js:1\r\nb\t@\tblazor.webassembly.js:1\r\ne.invokeMethodAsync\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tblazor.webassembly.js:1\r\nve\t@\tblazor.webassembly.js:1\r\nwe\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tblazor.webassembly.js:1\r\n(anonymous)\t@\tblazor.webassembly.js:1\r\nonGlobalEvent\t@\tblazor.webassembly.js:1\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n\r\n\r\n**Actual Behavior**\r\n\r\nSkiaSharp wasm render loop crashes and app needs to be restarted.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  SkiaSharp.Views.Blazor 2.88.1\r\n- IDE:  Visual Studio and Visual Studio Code\r\n- Target Framework: net6.0, AOT disabled\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - WebAssembly. Edge Version 104.0.1293.63 (Official build) (arm64)\r\n\r\n**Reproduction Link**\r\n\r\nRepro and more samples https://github.com/max1287/SkiaSharpBlazorApp\r\n\r\n",
  "author": {
    "login": "romansp",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-08-25T21:52:33",
  "updatedAt": "2022-12-09T00:00:55",
  "closedAt": "2022-11-08T19:47:06",
  "commentCount": 3,
  "reactionCount": 0
}