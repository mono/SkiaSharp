{
  "number": 2915,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Excessive Memory Consumption in SkiaSharp Library Leading to OOM Crashes",
  "body": "### Description\r\n\r\n**Issue Description**\r\n**Description**\r\nOur application is experiencing high memory consumption, leading to Out of Memory (OOM) exceptions. After extensive debugging and analysis with the Microsoft support team, we have identified that the SkiaSharp library is the primary driver of the excessive memory usage.\r\n\r\n**Steps to Reproduce**\r\n\r\n1. Deploy the application using SkiaSharp 2.88.8 in a Docker container with the official .NET SDK 8.0 image.\r\n2. Run the application under typical load, processing images.\r\n3. Monitor memory usage over time.\r\n\r\n**Expected Behavior**\r\nMemory usage should remain stable and within acceptable limits, without leading to OOM crashes.\r\n\r\n**Actual Behavior**\r\nMemory usage continually increases over time, ultimately causing the application to crash with an OOM exception. The issue is most prevalent when processing images, which suggests that SkiaSharp\u0027s memory management might be the root cause.\r\n\r\n**Evidence and Analysis**\r\n\r\n1. Heap Dumps: Multiple heap dumps indicate significant memory consumption in PAGE_READWRITE regions, which is likely attributed to native memory allocations.\r\n2. Heaptrack Analysis:\r\n\r\n- Peak memory consumers show SkiaSharp\u0027s native library (libSkiaSharp.so) consuming large amounts of memory.\r\n- At its peak, SkiaSharp allocated ~250MB of RAM over 1257 calls, with specific functions like sk_bitmap_try_alloc_pixels being notable contributors.\r\n\r\n**Environment**\r\n\r\n- SkiaSharp Version: 2.88.8\r\n- .NET Version: 8.0.5\r\n- OS: Linux Debian (Docker Container)\r\n- Image: mcr.microsoft.com/dotnet/sdk:8.0\r\n\r\n**Relevant Files**\r\n\r\n- ImageHelper.cs: The primary usage of SkiaSharp within our application.\r\n- Heap Dumps and Heaptrack Traces: Available upon request.\r\n\r\nAny advice on configuration changes or code adjustments to mitigate the issue would be appreciated.\r\nUpdates: Information on any known issues or updates in SkiaSharp that address this problem.\r\n\r\n\r\n\r\n### Code\r\n\u0060\u0060\u0060cs\r\npublic class ImageHelper : IImageHelper\r\n    {\r\n        public byte[]? ResizeImage(byte[] img, Size maxSize)\r\n        {\r\n            try\r\n            {\r\n                // If the size is 0, return the default image size\r\n                if (maxSize.IsEmpty)\r\n                    return img;\r\n\r\n                using MemoryStream ms = new MemoryStream(img);\r\n\r\n                using SKCodec skCodec = SKCodec.Create(ms);\r\n                using SKBitmap sourceBitmap = SKBitmap.Decode(skCodec);\r\n\r\n                // Rotate if needed\r\n                using SKBitmap rotatedBitmap = HandleOrientation(sourceBitmap, skCodec.EncodedOrigin);\r\n\r\n                // Calculate the new size\r\n                var newSize = CalculateNewSize(maxSize, new Size(rotatedBitmap.Width, rotatedBitmap.Height));\r\n\r\n                SKFilterQuality quality = SKFilterQuality.Medium;\r\n                using SKBitmap scaledBitmap = rotatedBitmap.Resize(new SKImageInfo(newSize.Width, newSize.Height), quality);\r\n\r\n                using SKImage scaledImage = SKImage.FromBitmap(scaledBitmap);\r\n                using SKData data = scaledImage.Encode(SKEncodedImageFormat.Jpeg, 75);\r\n\r\n                return data?.ToArray();\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                Console.WriteLine($\u0022Error while resising the picture: {ex}\u0022);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        private static SKBitmap HandleOrientation(SKBitmap bitmap, SKEncodedOrigin orientation)\r\n        {\r\n            SKBitmap rotated;\r\n            switch (orientation)\r\n            {\r\n                case SKEncodedOrigin.BottomRight:\r\n\r\n                    using (var surface = new SKCanvas(bitmap))\r\n                    {\r\n                        surface.RotateDegrees(180, (float)bitmap.Width / 2, (float)bitmap.Height / 2);\r\n                        surface.DrawBitmap(bitmap.Copy(), 0, 0);\r\n                    }\r\n\r\n                    return bitmap;\r\n\r\n                case SKEncodedOrigin.RightTop:\r\n                    rotated = new SKBitmap(bitmap.Height, bitmap.Width);\r\n\r\n                    using (var surface = new SKCanvas(rotated))\r\n                    {\r\n                        surface.Translate(rotated.Width, 0);\r\n                        surface.RotateDegrees(90);\r\n                        surface.DrawBitmap(bitmap, 0, 0);\r\n                    }\r\n\r\n                    return rotated;\r\n\r\n                case SKEncodedOrigin.LeftBottom:\r\n                    rotated = new SKBitmap(bitmap.Height, bitmap.Width);\r\n\r\n                    using (var surface = new SKCanvas(rotated))\r\n                    {\r\n                        surface.Translate(0, rotated.Height);\r\n                        surface.RotateDegrees(270);\r\n                        surface.DrawBitmap(bitmap, 0, 0);\r\n                    }\r\n\r\n                    return rotated;\r\n\r\n                default:\r\n                    return bitmap;\r\n            }\r\n        }\r\n\r\n        private static Size CalculateNewSize(Size maxSize, Size currentSize)\r\n        {\r\n            var newSize = currentSize;\r\n\r\n            // Check the height\r\n            if (newSize.Height \u003E maxSize.Height)\r\n            {\r\n                newSize.Height = maxSize.Height;\r\n                newSize.Width = currentSize.Width * newSize.Height / currentSize.Height;\r\n            }\r\n\r\n            currentSize = newSize;\r\n\r\n            // Check the width\r\n            if (newSize.Width \u003E maxSize.Width)\r\n            {\r\n                newSize.Width = maxSize.Width;\r\n                newSize.Height = newSize.Height * newSize.Width / currentSize.Width;\r\n            }\r\n\r\n            return newSize;\r\n        }\r\n    }\r\n\u0060\u0060\u0060\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "luigisaggese",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-02T05:23:55",
  "updatedAt": "2025-07-27T21:10:47",
  "commentCount": 7,
  "reactionCount": 14,
  "engagement": {
    "syncedAt": "2026-02-06T12:42:53.7118985Z",
    "reactions": [
      {
        "user": "matthew-minish",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119092Z"
      },
      {
        "user": "LeoYang06",
        "content": "eyes",
        "createdAt": "2026-02-06T12:42:53.7119102Z"
      },
      {
        "user": "mstijak",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119105Z"
      },
      {
        "user": "janhybs",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119108Z"
      },
      {
        "user": "PsykerUdot",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119111Z"
      },
      {
        "user": "JohanLindvall",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119115Z"
      },
      {
        "user": "viniciuschiele",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119118Z"
      },
      {
        "user": "AlexPetrova",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.711912Z"
      },
      {
        "user": "constantins2001",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119122Z"
      },
      {
        "user": "constantins2001",
        "content": "eyes",
        "createdAt": "2026-02-06T12:42:53.7119125Z"
      },
      {
        "user": "llxee",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.711913Z"
      },
      {
        "user": "joakimskoog",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119132Z"
      },
      {
        "user": "joakimskoog",
        "content": "eyes",
        "createdAt": "2026-02-06T12:42:53.7119134Z"
      },
      {
        "user": "TwentyFourMinutes",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:42:53.7119135Z"
      }
    ],
    "comments": [
      {
        "id": 2552899761,
        "author": "LionelXN",
        "body": "I eagerly look forward to resolving this issue as soon as possible, and we are also troubled by it in our applications",
        "createdAt": "2024-12-19T06:35:49",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-06T12:42:52.4552472Z"
          },
          {
            "user": "nezhadian",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:42:52.4552476Z"
          }
        ]
      },
      {
        "id": 2552990244,
        "author": "mattleibow",
        "body": "Is it possible to set up a repro sample so I can run it and see how you are using the helper method? What type of images are you loading? ",
        "createdAt": "2024-12-19T07:46:21",
        "reactions": []
      },
      {
        "id": 2553097879,
        "author": "alensindicic",
        "body": "We are also troubled by this bug - probably. We have Telerik Reporting (which relies on SkiaSharp for rendering) running as an Azure Container App, so it fits the environment Luigi posted. Very desperate to get it resolved.",
        "createdAt": "2024-12-19T08:46:12",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-06T12:42:52.8649084Z"
          }
        ]
      },
      {
        "id": 2553102847,
        "author": "luigisaggese",
        "body": "Hi @mattleibow,\r\n\r\nThanks for looking into this. Here\u0027s a breakdown of our scenario.\r\n\r\n**Context**\r\nWe load images as streams from Amazon S3, resize them using SkiaSharp, and return the resized images from our API. The resizing process is straightforward, but we\u2019re encountering high memory consumption that eventually leads to OOM exceptions in our Dockerized application.\r\n\r\n**Observations**\r\nHeap dumps and heaptrack analysis suggest that SkiaSharp\u2019s native memory allocations (e.g., sk_bitmap_try_alloc_pixels) are contributing to the issue.\r\nMemory usage escalates under load when processing images.\r\n\r\n**Current Approach**\r\nWe\u2019re using the following steps in our code:\r\n\r\n1. Decode the image using SKCodec.\r\n2. Handle orientation with SKBitmap.\r\n3. Resize using SKBitmap.Resize with medium quality.\r\n4. Encode the result back into a JPEG format.\r\n\r\n**Known Problem**\r\nSkiaSharp\u0027s native memory usage appears to persist beyond the lifecycle of managed objects. This is especially problematic in environments with limited memory, like Docker containers.\r\n\r\n\r\nQuestions:\r\n\r\n1. Memory Management: Are there specific guidelines to ensure native memory is released promptly? For example, should we enforce explicit disposal patterns or other configurations for SkiaSharp to manage memory effectively?\r\n2. Image Decoding/Resizing Alternatives: Would using another SkiaSharp API or configuration (e.g., SKPixmap) for decoding or resizing images help reduce memory overhead?\r\n3. Recent Updates: Are there any recent updates or bug fixes in SkiaSharp that address this behavior?\r\n4. Configuration Tips: Do you recommend tuning any settings for SkiaSharp or Docker (e.g., memory limits, threading) to mitigate this issue?\r\n\r\nAny guidance or insights would be incredibly helpful! Thanks again.",
        "createdAt": "2024-12-19T08:48:53",
        "reactions": []
      },
      {
        "id": 3116804640,
        "author": "constantins2001",
        "body": "This issue also occurs in our production environment",
        "createdAt": "2025-07-25T07:59:29",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-06T12:42:53.2603633Z"
          }
        ]
      },
      {
        "id": 3117034001,
        "author": "jeremy-visionaid",
        "body": "A fairly trivial fix.... You could copy the fixed \u0060CopyTo\u0060 function as an extension method as a workaround in the meantime.",
        "createdAt": "2025-07-25T09:18:06",
        "reactions": []
      },
      {
        "id": 3124729807,
        "author": "jeremy-visionaid",
        "body": "Not related, but the analyzers highlighted some other missing dispose calls: #3319",
        "createdAt": "2025-07-27T21:10:47",
        "reactions": []
      }
    ]
  }
}