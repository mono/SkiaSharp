{
  "number": 2915,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Excessive Memory Consumption in SkiaSharp Library Leading to OOM Crashes",
  "body": "### Description\r\n\r\n**Issue Description**\r\n**Description**\r\nOur application is experiencing high memory consumption, leading to Out of Memory (OOM) exceptions. After extensive debugging and analysis with the Microsoft support team, we have identified that the SkiaSharp library is the primary driver of the excessive memory usage.\r\n\r\n**Steps to Reproduce**\r\n\r\n1. Deploy the application using SkiaSharp 2.88.8 in a Docker container with the official .NET SDK 8.0 image.\r\n2. Run the application under typical load, processing images.\r\n3. Monitor memory usage over time.\r\n\r\n**Expected Behavior**\r\nMemory usage should remain stable and within acceptable limits, without leading to OOM crashes.\r\n\r\n**Actual Behavior**\r\nMemory usage continually increases over time, ultimately causing the application to crash with an OOM exception. The issue is most prevalent when processing images, which suggests that SkiaSharp\u0027s memory management might be the root cause.\r\n\r\n**Evidence and Analysis**\r\n\r\n1. Heap Dumps: Multiple heap dumps indicate significant memory consumption in PAGE_READWRITE regions, which is likely attributed to native memory allocations.\r\n2. Heaptrack Analysis:\r\n\r\n- Peak memory consumers show SkiaSharp\u0027s native library (libSkiaSharp.so) consuming large amounts of memory.\r\n- At its peak, SkiaSharp allocated ~250MB of RAM over 1257 calls, with specific functions like sk_bitmap_try_alloc_pixels being notable contributors.\r\n\r\n**Environment**\r\n\r\n- SkiaSharp Version: 2.88.8\r\n- .NET Version: 8.0.5\r\n- OS: Linux Debian (Docker Container)\r\n- Image: mcr.microsoft.com/dotnet/sdk:8.0\r\n\r\n**Relevant Files**\r\n\r\n- ImageHelper.cs: The primary usage of SkiaSharp within our application.\r\n- Heap Dumps and Heaptrack Traces: Available upon request.\r\n\r\nAny advice on configuration changes or code adjustments to mitigate the issue would be appreciated.\r\nUpdates: Information on any known issues or updates in SkiaSharp that address this problem.\r\n\r\n\r\n\r\n### Code\r\n\u0060\u0060\u0060cs\r\npublic class ImageHelper : IImageHelper\r\n    {\r\n        public byte[]? ResizeImage(byte[] img, Size maxSize)\r\n        {\r\n            try\r\n            {\r\n                // If the size is 0, return the default image size\r\n                if (maxSize.IsEmpty)\r\n                    return img;\r\n\r\n                using MemoryStream ms = new MemoryStream(img);\r\n\r\n                using SKCodec skCodec = SKCodec.Create(ms);\r\n                using SKBitmap sourceBitmap = SKBitmap.Decode(skCodec);\r\n\r\n                // Rotate if needed\r\n                using SKBitmap rotatedBitmap = HandleOrientation(sourceBitmap, skCodec.EncodedOrigin);\r\n\r\n                // Calculate the new size\r\n                var newSize = CalculateNewSize(maxSize, new Size(rotatedBitmap.Width, rotatedBitmap.Height));\r\n\r\n                SKFilterQuality quality = SKFilterQuality.Medium;\r\n                using SKBitmap scaledBitmap = rotatedBitmap.Resize(new SKImageInfo(newSize.Width, newSize.Height), quality);\r\n\r\n                using SKImage scaledImage = SKImage.FromBitmap(scaledBitmap);\r\n                using SKData data = scaledImage.Encode(SKEncodedImageFormat.Jpeg, 75);\r\n\r\n                return data?.ToArray();\r\n            }\r\n            catch (Exception ex)\r\n            {\r\n                Console.WriteLine($\u0022Error while resising the picture: {ex}\u0022);\r\n                return null;\r\n            }\r\n        }\r\n\r\n        private static SKBitmap HandleOrientation(SKBitmap bitmap, SKEncodedOrigin orientation)\r\n        {\r\n            SKBitmap rotated;\r\n            switch (orientation)\r\n            {\r\n                case SKEncodedOrigin.BottomRight:\r\n\r\n                    using (var surface = new SKCanvas(bitmap))\r\n                    {\r\n                        surface.RotateDegrees(180, (float)bitmap.Width / 2, (float)bitmap.Height / 2);\r\n                        surface.DrawBitmap(bitmap.Copy(), 0, 0);\r\n                    }\r\n\r\n                    return bitmap;\r\n\r\n                case SKEncodedOrigin.RightTop:\r\n                    rotated = new SKBitmap(bitmap.Height, bitmap.Width);\r\n\r\n                    using (var surface = new SKCanvas(rotated))\r\n                    {\r\n                        surface.Translate(rotated.Width, 0);\r\n                        surface.RotateDegrees(90);\r\n                        surface.DrawBitmap(bitmap, 0, 0);\r\n                    }\r\n\r\n                    return rotated;\r\n\r\n                case SKEncodedOrigin.LeftBottom:\r\n                    rotated = new SKBitmap(bitmap.Height, bitmap.Width);\r\n\r\n                    using (var surface = new SKCanvas(rotated))\r\n                    {\r\n                        surface.Translate(0, rotated.Height);\r\n                        surface.RotateDegrees(270);\r\n                        surface.DrawBitmap(bitmap, 0, 0);\r\n                    }\r\n\r\n                    return rotated;\r\n\r\n                default:\r\n                    return bitmap;\r\n            }\r\n        }\r\n\r\n        private static Size CalculateNewSize(Size maxSize, Size currentSize)\r\n        {\r\n            var newSize = currentSize;\r\n\r\n            // Check the height\r\n            if (newSize.Height \u003E maxSize.Height)\r\n            {\r\n                newSize.Height = maxSize.Height;\r\n                newSize.Width = currentSize.Width * newSize.Height / currentSize.Height;\r\n            }\r\n\r\n            currentSize = newSize;\r\n\r\n            // Check the width\r\n            if (newSize.Width \u003E maxSize.Width)\r\n            {\r\n                newSize.Width = maxSize.Width;\r\n                newSize.Height = newSize.Height * newSize.Width / currentSize.Width;\r\n            }\r\n\r\n            return newSize;\r\n        }\r\n    }\r\n\u0060\u0060\u0060\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "luigisaggese",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-02T05:23:55",
  "updatedAt": "2025-07-27T21:10:47",
  "commentCount": 7,
  "reactionCount": 14,
  "engagement": {
    "syncedAt": "2026-02-04T19:50:27.5081185Z",
    "reactions": [
      {
        "user": "matthew-minish",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.508122Z"
      },
      {
        "user": "LeoYang06",
        "content": "eyes",
        "createdAt": "2026-02-04T19:50:27.5081225Z"
      },
      {
        "user": "mstijak",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081228Z"
      },
      {
        "user": "janhybs",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081234Z"
      },
      {
        "user": "PsykerUdot",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081237Z"
      },
      {
        "user": "JohanLindvall",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081238Z"
      },
      {
        "user": "viniciuschiele",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081241Z"
      },
      {
        "user": "AlexPetrova",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081241Z"
      },
      {
        "user": "constantins2001",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081243Z"
      },
      {
        "user": "constantins2001",
        "content": "eyes",
        "createdAt": "2026-02-04T19:50:27.5081245Z"
      },
      {
        "user": "llxee",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081247Z"
      },
      {
        "user": "joakimskoog",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081249Z"
      },
      {
        "user": "joakimskoog",
        "content": "eyes",
        "createdAt": "2026-02-04T19:50:27.5081251Z"
      },
      {
        "user": "TwentyFourMinutes",
        "content": "\u002B1",
        "createdAt": "2026-02-04T19:50:27.5081252Z"
      }
    ],
    "comments": [
      {
        "id": 2552899761,
        "author": "LionelXN",
        "createdAt": "2024-12-19T06:35:49",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-04T19:50:25.8832496Z"
          },
          {
            "user": "nezhadian",
            "content": "\u002B1",
            "createdAt": "2026-02-04T19:50:25.8832501Z"
          }
        ]
      },
      {
        "id": 2552990244,
        "author": "mattleibow",
        "createdAt": "2024-12-19T07:46:21",
        "reactions": []
      },
      {
        "id": 2553097879,
        "author": "alensindicic",
        "createdAt": "2024-12-19T08:46:12",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-04T19:50:26.4525936Z"
          }
        ]
      },
      {
        "id": 2553102847,
        "author": "luigisaggese",
        "createdAt": "2024-12-19T08:48:53",
        "reactions": []
      },
      {
        "id": 3116804640,
        "author": "constantins2001",
        "createdAt": "2025-07-25T07:59:29",
        "reactions": [
          {
            "user": "luigisaggese",
            "content": "heart",
            "createdAt": "2026-02-04T19:50:26.9486648Z"
          }
        ]
      },
      {
        "id": 3117034001,
        "author": "jeremy-visionaid",
        "createdAt": "2025-07-25T09:18:06",
        "reactions": []
      },
      {
        "id": 3124729807,
        "author": "jeremy-visionaid",
        "createdAt": "2025-07-27T21:10:47",
        "reactions": []
      }
    ]
  }
}