{
  "number": 3386,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Unable to load on Azure Container app with Aspire",
  "body": "### Description\n\nWe are deploying a set of WebAPIs using .NET Aspire. This creates a Linux based Container App. While everything works locally it does not work when deployed in this way.\n\n### Code\n\n\u0060\u0060\u0060xaml\n\u003CPackageReference Include=\u0022SkiaSharp\u0022 /\u003E\n\u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 /\u003E\n\u0060\u0060\u0060\n\n### Expected Behavior\n\nImages should be able to generate.\n\n### Actual Behavior\n\nImages fail to generate\n\n### Version of SkiaSharp\n\n3.116.0 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.9 (Previous)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nLinux\n\n### Platform / Operating System Version\n\n- (Linux) Azure Container App - deployed with .NET Aspire\n\n### Devices\n\n_No response_\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n\u0060\u0060\u0060shell\nstdout F fail: Microsoft.AspNetCore.Server.Kestrel[13]\nstdout F       Connection id \u00220HNGDGHEEMT83\u0022, Request id \u00220HNGDGHEEMT83:00000004\u0022: An unhandled exception was thrown by the application.\nstdout F       System.TypeInitializationException: The type initializer for \u0027SkiaSharp.SKAbstractManagedStream\u0027 threw an exception.\nstdout F        ---\u003E System.DllNotFoundException: Unable to load shared library \u0027libSkiaSharp\u0027 or one of its dependencies. In order to help diagnose loading problems, consider using a tool like strace. If you\u0027re using glibc, consider setting the LD_DEBUG environment variable: \nstdout F       libfontconfig.so.1: cannot open shared object file: No such file or directory\nstdout F       /usr/share/dotnet/shared/Microsoft.NETCore.App/9.0.10/libSkiaSharp.so: cannot open shared object file: No such file or directory\nstdout F       /app/liblibSkiaSharp.so: cannot open shared object file: No such file or directory\nstdout F       /usr/share/dotnet/shared/Microsoft.NETCore.App/9.0.10/liblibSkiaSharp.so: cannot open shared object file: No such file or directory\nstdout F       /app/libSkiaSharp: cannot open shared object file: No such file or directory\nstdout F       /usr/share/dotnet/shared/Microsoft.NETCore.App/9.0.10/libSkiaSharp: cannot open shared object file: No such file or directory\nstdout F       /app/liblibSkiaSharp: cannot open shared object file: No such file or directory\nstdout F       /usr/share/dotnet/shared/Microsoft.NETCore.App/9.0.10/liblibSkiaSharp: cannot open shared object file: No such file or directory\nstdout F       \nstdout F          at SkiaSharp.SkiaApi.sk_managedstream_set_procs(SKManagedStreamDelegates procs)\nstdout F          at SkiaSharp.SkiaApi.sk_managedstream_set_procs(SKManagedStreamDelegates procs)\nstdout F          at SkiaSharp.SKAbstractManagedStream..cctor()\nstdout F          --- End of inner exception stack trace ---\nstdout F          at SkiaSharp.SKAbstractManagedStream..ctor(Boolean owns)\nstdout F          at SkiaSharp.SKManagedStream..ctor(Stream managedStream, Boolean disposeManagedStream)\nstdout F          at SkiaSharp.SKCodec.WrapManagedStream(Stream stream)\nstdout F          at SkiaSharp.SKCodec.Create(Stream stream, SKCodecResult\u0026 result)\nstdout F          at SkiaSharp.SKCodec.Create(Stream stream)\nstdout F          at SkiaSharp.SKBitmap.Decode(Stream stream)\n\u0060\u0060\u0060\n\n### Code of Conduct\n\n- [x] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "dansiegel",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "os/Linux",
      "color": "fbca04"
    },
    {
      "name": "area/libSkiaSharp.native",
      "color": "0052cc"
    },
    {
      "name": "tenet/compatibility",
      "color": "BFD4F2"
    }
  ],
  "assignees": [],
  "createdAt": "2025-10-17T14:21:04",
  "updatedAt": "2025-10-20T21:25:03",
  "commentCount": 2,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:23:21.5225524Z",
    "reactions": [],
    "comments": [
      {
        "id": 3415816788,
        "author": "github-actions[bot]",
        "body": "**Triage Summary**  \n\nLabels will be applied to indicate the specific area of the issue (libSkiaSharp.native), the affected operating system (Linux), and a potential compatibility concern.\n\nThis issue is not explicitly defined as a regression but indicates a compatibility issue with different versions of SkiaSharp.\n\nAdditional remarks:\n* The problem relates to a bug in deploying a web API using SkiaSharp; however, the currently available labels do not cover SkiaSharp or image processing contexts directly.\n\n\u003Cdetails\u003E\n\u003Csummary\u003EDetailed Summary and Actions\u003C/summary\u003E\n\nSummary of the triage:\n\n- The issue involves a failure in loading the native library \u0027libSkiaSharp\u0027 on Linux.\n- It is specifically occurring in a Linux-based Azure Container App.\n- There\u0027s a potential compatibility concern between the current version of SkiaSharp (3.116.0) and the last known good version (2.88.9).\n\nSummary of the actions that will be performed:\n\n| Action          | Item                              | Description                                                                                                    |\n| :-------------- | :-------------------------------- | :------------------------------------------------------------------------------------------------------------- |\n| Apply Label     | area/libSkiaSharp.native         | The issue pertains to a failure in loading the \u0027libSkiaSharp\u0027 library, which relates to the native bindings.  |\n| Apply Label     | os/Linux                         | The issue is specifically occurring on a Linux-based Azure Container App.                                     |\n| Apply Label     | tenet/compatibility              | The issue indicates a potential compatibility problem with the current version of SkiaSharp compared to an earlier version. |\n\n\u003C/details\u003E\n\n\n\n_This entire triage process was automated by AI and mistakes may have been made. Please let us know so we can continue to improve._",
        "createdAt": "2025-10-17T14:21:45",
        "reactions": []
      },
      {
        "id": 3423780577,
        "author": "dansiegel",
        "body": "In case it helps anyone else who may find this later, I was able to come up with the following work around.\n\n## Fixing the TypeInitializationException\n\n1) Since we had to use a custom image with the native dependencies installed, I switched to \u0060SkiaSharp.NativeAssets.Linux\u0060.\n2) I created the following repo [AvantiPoint/aspnet-skia](/AvantiPoint/aspnet-skia). This has a \u0060Dockerfile\u0060 based on the \u0060mcr.microsoft.com/dotnet/aspnet:X.0-noble\u0060 image. This then installs all of the required native dependencies into the Linux Environment for SkiaSharp. You can find the public images for this on \u0060ghcr.io\u0060\n    - ghcr.io/avantipoint/aspnet-skia:9.0\n    - ghcr.io/avantipoint/aspnet-skia:10.0\n3) I updated the \u0060csproj\u0060 for each of the executable projects that we are deploying which might make use of SkiaSharp to include the following:\n\u0060\u0060\u0060xml\n\u003CPropertyGroup\u003E\n  \u003COutputType\u003EExe\u003C/OutputType\u003E\n  \u003CTargetFramework\u003Enet9.0\u003C/TargetFramework\u003E\n  \u003CContainerBaseImage\u003Eghcr.io/avantipoint/aspnet-skia:9.0\u003C/ContainerBaseImage\u003E\n\u003C/PropertyGroup\u003E\n\u0060\u0060\u0060\n4) While the packages are public, \u0060ghcr.io\u0060 requires authentication. Generate a PAT for GitHub and run \u0060docker login ghcr.io\u0060.\n\n---\n\n## Fixing the Missing Assembly (Trimming)\n\nFollowing the \u0060TypeInitializationException\u0060 we were still getting another fatal error. This was being caused by the fact that \u0060System.Memory.Data\u0060 was not found. This assembly was a transitive reference for us and was therefore being stripped out because trimming is enabled. When we set this to be a Top Level NuGet dependency this issue was resolved and our APIs began working as expected and like they do in development.\n\n\u0060\u0060\u0060xml\n\u003CItemGroup\u003E\n  \u003C!-- \n    NOTE: \n       We use Central Package Management... \n       you should target the version that makes sense for your project. \n  --\u003E\n  \u003CPackageReference Include=\u0022System.Memory.Data\u0022 /\u003E\n\u003C/ItemGroup\u003E\n\u0060\u0060\u0060",
        "createdAt": "2025-10-20T21:25:03",
        "reactions": []
      }
    ]
  }
}