{
  "number": 365,
  "type": "issue",
  "state": "closed",
  "title": "Targetting linux-arm - and Linux in general.",
  "body": "Hi,\r\n\r\nI was reading the [issue](https://github.com/dotnet/corefx/issues/20325#issuecomment-328683446) about \u0060System.Drawing\u0060 for dotnet core, and someone suggested to use SkiaSharp for it.\r\nSo I have looked at SkiaSharp for a possible usage in my code, on a Raspberry Pi.\r\n\r\nDoes SkiaSharp run on \u0060linux-arm\u0060 target ? I am writing apps on \u0060netstandard2.0\u0060 running on RaspberryPi.",
  "author": {
    "login": "maitredede",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/enhancement",
      "color": "84b6eb"
    }
  ],
  "assignees": [],
  "createdAt": "2017-09-11T23:32:23",
  "updatedAt": "2022-08-19T18:02:38",
  "closedAt": "2018-05-08T04:46:44",
  "commentCount": 15,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:59:42.3949315Z",
    "reactions": [],
    "comments": [
      {
        "id": 333852066,
        "author": "migueldeicaza",
        "body": "It should, but you will need to compile the unmanaged library yourself",
        "createdAt": "2017-10-03T14:04:06",
        "reactions": []
      },
      {
        "id": 348738377,
        "author": "migueldeicaza",
        "body": "Hijacking this bug to discuss a possible approach for Linux.\r\n\r\nIt is unlikely that we will be able to get NuGet to properly support all the ways to distribute the native payloads.   I think that we should go ahead and create \u0060.deb\u0060 and \u0060.rpm\u0060 definition files and use something like https://build.opensuse.org/ to build those packages.\r\n\r\nWe would then require users of Skiasharp to install the separate payload on their systems.",
        "createdAt": "2017-12-03T03:52:32",
        "reactions": []
      },
      {
        "id": 348757624,
        "author": "kekekeks",
        "body": "@migueldeicaza I don\u0027t quite understand why it\u0027s not viable to statically link everything except glibc and libfontconfig. We had some success with this approach in our package with x64 binaries (I\u0027ve compiled it against glibc 2.14), it works quite well across the Linux distros. The only downside is that some distros like Alpine are using different C library, but there are compatibility layers available.\r\nThe same could be done for ARM, the only problem is the lack of prebuilt depot tools, so cross-compilation is needed.",
        "createdAt": "2017-12-03T11:30:34",
        "reactions": []
      },
      {
        "id": 358326443,
        "author": "migueldeicaza",
        "body": "The answer is that the devil is in the details, and without a full infrastructure to test every part of the stack, and to test on every distribution, we might end up with just slightly broken code in some places which is very hard to debug and rectify.\r\n\r\nWe have been down this path in the Linux world many years ago, and we rather err on the side of safety and find a safe way of plugging the payload in a native way there.",
        "createdAt": "2018-01-17T14:47:26",
        "reactions": []
      },
      {
        "id": 364806467,
        "author": "galvesribeiro",
        "body": "As I mentioned on #18 before, I was able after lots of hackery (really A LOT) with @mattleibow to build it using a cross compiler and linking by hand lots of .a to finally get SkiaSharp native built.\r\n\r\nI just tried now to build again (lost the \u0022docs\u0022 we had) and doomed again. The \u0060bootstrapper.sh\u0060 script is completely ignoring the cross compiler and all variables passed to it, even \u0060GYP_DEFINES\u0060.",
        "createdAt": "2018-02-12T00:40:46",
        "reactions": []
      },
      {
        "id": 365036125,
        "author": "mattleibow",
        "body": "@galvesribeiro The new version no longer uses gyp, but gn instead. You can check out what I am doing here: https://github.com/mono/SkiaSharp/blob/master/cake/BuildExternals.cake#L715\r\n\r\nWhat I really now do is just build Linux as Google specifies as a static archive, and then I create a dynamic library that links out everything except what SkiaSharp uses - ie: just the public C API is preserved.",
        "createdAt": "2018-02-12T19:33:11",
        "reactions": []
      },
      {
        "id": 365037377,
        "author": "galvesribeiro",
        "body": "@mattleibow yeah, I noticed that... Still, it is ignoring the compiler and arch parameters we pass to it. There are a bunch of hardcoded params there. For example, the compiler params are not forwarded to the dependencies (including skia) and they try to compile for the host arch, not the target one.\r\n\r\nAfter change a lot of files, the closest I got was:\r\n\r\n\u0060\u0060\u0060\r\n========================================\r\nexternals-linux\r\n========================================\r\nExecuting task: externals-linux\r\n[0212/190217.034905:ERROR:process_posix.cc(192)] Not implemented reached in bool (anonymous namespace)::WaitForExitWithTimeoutImpl(base::ProcessHandle, int *, base::TimeDelta)\r\n[0212/190217.207897:ERROR:process_posix.cc(192)] Not implemented reached in bool (anonymous namespace)::WaitForExitWithTimeoutImpl(base::ProcessHandle, int *, base::TimeDelta)\r\n[0212/190217.501813:ERROR:process_posix.cc(192)] Not implemented reached in bool (anonymous namespace)::WaitForExitWithTimeoutImpl(base::ProcessHandle, int *, base::TimeDelta)\r\nDone. Made 32 targets from 20 files in 713ms\r\nninja: Entering directory \u0060out/linux/arm\u0027\r\n[35/684] compile ../../../src/effects/SkEmbossMask.cpp\r\nFAILED: obj/src/effects/effects.SkEmbossMask.o\r\narm-arm1176jzs-linux-gnueabi-c\u002B\u002B -MMD -MF obj/src/effects/effects.SkEmbossMask.o.d -DNDEBUG -DSK_SAMPLES_FOR_X -DSK_SUPPORT_GPU=0 -DSK_GAMMA_APPLY_TO_A8 -DSK_ALLOW_STATIC_GLOBAL_INITIALIZERS=0 -DSKIA_IMPLEMENTATION=1 -I../../../include/android -I../../../include/c -I../../../include/codec -I../../../include/config -I../../../include/core -I../../../include/effects -I../../../include/encode -I../../../include/gpu -I../../../include/gpu/gl -I../../../include/pathops -I../../../include/ports -I../../../include/svg -I../../../include/utils -I../../../include/utils/mac -I../../../third_party/vulkan -I../../../include/private -I../../../src/c -I../../../src/codec -I../../../src/core -I../../../src/effects -I../../../src/effects/gradients -I../../../src/fonts -I../../../src/image -I../../../src/images -I../../../src/lazy -I../../../src/opts -I../../../src/pathops -I../../../src/pdf -I../../../src/ports -I../../../src/sfnt -I../../../src/sksl -I../../../src/utils -I../../../src/utils/win -I../../../src/xml -I../../../third_party/gif -fstrict-aliasing -fPIC -fvisibility=hidden -Werror -march=armv6j -Wall -Wextra -Winit-self -Wpointer-arith -Wsign-compare -Wvla -Wno-deprecated-declarations -Wno-maybe-uninitialized -Wno-unused-parameter -Os -fdata-sections -ffunction-sections -march=armv6j -msoft-float -mfpu=vfp -mfloat-abi=soft -DSKIA_C_DLL -funwind-tables -std=c\u002B\u002B11 -fno-threadsafe-statics -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -Wnon-virtual-dtor -c ../../../src/effects/SkEmbossMask.cpp -o obj/src/effects/effects.SkEmbossMask.o\r\nIn file included from ../../../src/effects/SkEmbossMask.cpp:10:0:\r\n../../../include/private/SkFixed.h: In static member function \u0027static void SkEmbossMask::Emboss(SkMask*, const SkEmbossMaskFilter::Light\u0026)\u0027:\r\n../../../include/private/SkFixed.h:106:49: error: inconsistent operand constraints in an \u0027asm\u0027\r\n         asm(\u0022vcvt.s32.f32 %0, %0, #16\u0022: \u0022\u002Bw\u0022(x));\r\n                                                 ^\r\n../../../include/private/SkFixed.h:106:49: error: inconsistent operand constraints in an \u0027asm\u0027\r\n         asm(\u0022vcvt.s32.f32 %0, %0, #16\u0022: \u0022\u002Bw\u0022(x));\r\n                                                 ^\r\n../../../include/private/SkFixed.h:106:49: error: inconsistent operand constraints in an \u0027asm\u0027\r\n         asm(\u0022vcvt.s32.f32 %0, %0, #16\u0022: \u0022\u002Bw\u0022(x));\r\n                                                 ^\r\n[44/684] compile ../../../src/effects/SkLightingImageFilter.cpp\r\nninja: build stopped: subcommand failed.\r\nAn error occurred when executing task \u0027externals-linux\u0027.\r\nError: One or more errors occurred.\r\n        Process \u0027/mnt/c/dev/repos/skiaprojects/SkiaSharp/externals/depot_tools/ninja\u0027 failed with error: 1\r\n\u0060\u0060\u0060",
        "createdAt": "2018-02-12T19:37:26",
        "reactions": []
      },
      {
        "id": 365041297,
        "author": "mattleibow",
        "body": "Hmm. I really need to get an arm linxu device.\r\nBut, while browsing for Tizen, I found this guy did something for Rasberry Pi:\r\nhttps://github.com/terwoord/skiasharp-raspberry\r\n\r\nNote the \u0060extra_asmflags\u0060... I see your error has something to do with assembly bits, maybe you need something like this? This is for an older version of Skia, but it may be something.\r\n\r\nI will try and get an ARM Linux device for testing as soon as possible.",
        "createdAt": "2018-02-12T19:51:10",
        "reactions": []
      },
      {
        "id": 365042162,
        "author": "galvesribeiro",
        "body": "Actually, you don\u0027t need an ARM device. You can build on x86/x64 linux using a cross compiler toolchain and you will have that effect. My device can\u0027t build it (even if it could would take months!) so I have to crosscompile.\r\n\r\nI can give you my toolchain if you want to. Ping me on Gitter and I can send the .tar.gz.",
        "createdAt": "2018-02-12T19:54:02",
        "reactions": []
      },
      {
        "id": 367368695,
        "author": "mattleibow",
        "body": "Just asking this question in multiple places:\r\n\r\nRight now I have a x64 build for Linux that was compiled on Ubuntu 14.04. I am thinking of adding a few more to help the average dev use SkiaSharp without having to build their own. What other distros or CPUs would be helpful?\r\n\r\nLeave a comment on this issue and track progress: #453",
        "createdAt": "2018-02-21T15:43:52",
        "reactions": []
      },
      {
        "id": 367377815,
        "author": "galvesribeiro",
        "body": "@mattleibow if you get it to build with the dependencies embedded(static linked), you can build for armv6 (no FPU) and armv7\u002B (with FPU). That way you would attend a wide range of ARM devices without depend on the specific distro.",
        "createdAt": "2018-02-21T16:09:25",
        "reactions": []
      },
      {
        "id": 367466452,
        "author": "mattleibow",
        "body": "@galvesribeiro What should the host be for the arm builds? Can I use Ubuntu 14.04 or is there a better one?",
        "createdAt": "2018-02-21T20:46:13",
        "reactions": []
      },
      {
        "id": 367469064,
        "author": "galvesribeiro",
        "body": "Yeah, you can use Ubuntu 16.04 as a build host. \r\n\r\nWhat matters is have a toolchain to crosscompile capable of generate 2 builds, one for armv6 (for legacy and very embedded devices) and other for armv7\u002B which cover the majority of Android devices nowadays and PI2\u002B and its variants.",
        "createdAt": "2018-02-21T20:55:44",
        "reactions": []
      },
      {
        "id": 375963241,
        "author": "mattleibow",
        "body": "To make life easier for everyone, I moved code around and added a new target to the GN files. Now, the native \u0060libSkiaSharp\u0060 build is done with GN and ninja directly: https://github.com/mono/SkiaSharp/wiki/Building-on-Linux",
        "createdAt": "2018-03-25T11:27:56",
        "reactions": []
      },
      {
        "id": 387283013,
        "author": "mattleibow",
        "body": "Closing this issue as the Linux topic is getting a bit duplicated.\r\n\r\n - for building your own native file, see https://github.com/mono/SkiaSharp/wiki/Building-on-Linux\r\n - for the discussion on NuGet distribution, see https://github.com/mono/SkiaSharp/issues/312\r\n - for requesting pre-built Linux libraries, see https://github.com/mono/SkiaSharp/issues/453",
        "createdAt": "2018-05-08T04:46:44",
        "reactions": []
      }
    ]
  }
}