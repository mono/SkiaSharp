{
  "number": 1686,
  "type": "issue",
  "state": "open",
  "title": "[QUESTION] Reading 24-bit Netpbm (PPM, PGM) Image With SkiaSharp",
  "body": "Is there any way to parse a 24-bit RGB image with Skiasharp? I have an image in a byte array in PPM format which is a 24-bit RGB image format: 24 bits per pixel: 8 for red, 8 for green, 8 for blue. There is no alpha channel so reading this as a 32-bit ARGB or BGRA will not read properly. \r\n\r\nI have not been successful in reading this image with a SKBitmap. Is there a better class in SkiaSharp to read this image format with or a way to parse it and display it?\r\n\r\nMore info on the PPM format:\r\n\r\nhttps://en.wikipedia.org/wiki/Netpbm",
  "author": {
    "login": "comfr3ak",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2021-04-08T22:48:55",
  "updatedAt": "2024-04-02T09:36:40",
  "commentCount": 1,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:55:06.1128888Z",
    "reactions": [],
    "comments": [
      {
        "id": 2031515228,
        "author": "simonegli8",
        "body": "I use the follwing class PpmImage for this:\r\n\r\n\u0060\u0060\u0060\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Text;\r\nusing System.Diagnostics;\r\nusing System.IO;\r\nusing SkiaSharp;\r\n\r\nnamespace SolidCP.Providers.Virtualization\r\n{\r\n\tpublic class PpmImage\r\n\t{\r\n\t\tpublic SKImage SkiaImage { get; set; } = null;\r\n\r\n\t\tpublic static implicit operator SKImage(PpmImage img) =\u003E img.SkiaImage; \r\n\r\n\t\tpublic enum ImageFormat { P3, P6 };\r\n\r\n\t\tpublic class Reader: IDisposable\r\n\t\t{\r\n\t\t\tpublic ImageFormat Format;\r\n\t\t\tpublic Stream BaseStream;\r\n\t\t\tpublic bool EOF = false;\r\n\t\t\tpublic int MaxColor;\r\n\r\n\t\t\tchar[] token = new char[64];\r\n\r\n\t\t\tpublic Reader() { }\r\n\t\t\tpublic Reader(Stream stream): this()\r\n\t\t\t{\r\n\t\t\t\tBaseStream = stream;\r\n\t\t\t}\r\n\r\n\t\t\tpublic int ReadColorFragment()\r\n\t\t\t{\r\n\t\t\t\tint x, y;\r\n\t\t\t\tx = BaseStream.ReadByte();\r\n\t\t\t\tif (x == -1 || MaxColor \u003C= 255) return x;\r\n\t\t\t\telse x = x * 256;\r\n\t\t\t\ty = BaseStream.ReadByte();\r\n\t\t\t\tif (y == -1) new Exception(\u0022Bad file format.\u0022);\r\n\t\t\t\treturn (x \u002B y) * 255 / MaxColor;\r\n\t\t\t}\r\n\r\n\t\t\tpublic string? ReadString()\r\n\t\t\t{\r\n\t\t\t\tif (EOF) return null;\r\n\r\n\t\t\t\tint n = 0, x;\r\n\t\t\t\tchar ch;\r\n\t\t\t\twhile ((x = BaseStream.ReadByte()) != -1 \u0026\u0026 char.IsWhiteSpace((char)x)) ;\r\n\t\t\t\tif (x != -1)\r\n\t\t\t\t{\r\n\t\t\t\t\ttoken[n\u002B\u002B] = (char)x;\r\n\t\t\t\t\twhile ((x = BaseStream.ReadByte()) != -1 \u0026\u0026 !char.IsWhiteSpace(ch = (char)x)) token[n\u002B\u002B] = ch;\r\n\t\t\t\t\tEOF = x == -1;\r\n\t\t\t\t\treturn new string(token, 0, n);\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tEOF = true;\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tpublic bool ReadColor(out SKColor color)\r\n\t\t\t{\r\n\t\t\t\tif (EOF)\r\n\t\t\t\t{\r\n\t\t\t\t\tcolor = default(SKColor);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (Format == ImageFormat.P3)\r\n\t\t\t\t{\r\n\t\t\t\t\tcolor = new SKColor((byte)(int.Parse(ReadString() ?? \u00220\u0022) * 255 / MaxColor),\r\n\t\t\t\t\t\t(byte)(int.Parse(ReadString() ?? \u00220\u0022) * 255 / MaxColor),\r\n\t\t\t\t\t\t(byte)(int.Parse(ReadString() ?? \u00220\u0022) * 255 / MaxColor));\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t} else\r\n\t\t\t\t{\r\n\t\t\t\t\tint red, green, blue;\r\n\t\t\t\t\tred = ReadColorFragment();\r\n\t\t\t\t\tif (red == -1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tEOF = true;\r\n\t\t\t\t\t\tcolor = default(SKColor);\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tgreen = ReadColorFragment();\r\n\t\t\t\t\tif (green == -1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tEOF = true;\r\n\t\t\t\t\t\tthrow new Exception(\u0022Bad file format.\u0022);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tblue = ReadColorFragment();\r\n\t\t\t\t\tif (blue == -1)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tEOF = true;\r\n\t\t\t\t\t\tthrow new Exception(\u0022Bad file format.\u0022);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcolor = new SKColor((byte)(red * 255 / MaxColor), (byte)(green * 255 / MaxColor), (byte)(blue * 255 / MaxColor));\r\n\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tpublic void Dispose() =\u003E BaseStream?.Dispose();\r\n\t\t}\r\n\r\n\t\tpublic static SKBitmap BitmapFromStream(Stream stream)\r\n\t\t{\r\n\r\n\t\t\tusing (var r = new Reader(stream))\r\n\t\t\t{\r\n\t\t\t\tstring format = r.ReadString();\r\n\t\t\t\tif (format != \u0022P3\u0022 \u0026\u0026 format != \u0022P6\u0022) throw new Exception(\u0022This file format is not supported.\u0022);\r\n\t\t\t\tif (format == \u0022P3\u0022) r.Format = ImageFormat.P3;\r\n\t\t\t\telse r.Format = ImageFormat.P6;\r\n\r\n\t\t\t\tint width = int.Parse(r.ReadString() ?? \u00220\u0022);\r\n\t\t\t\tint height = int.Parse(r.ReadString() ?? \u00220\u0022);\r\n\t\t\t\tr.MaxColor = int.Parse(r.ReadString() ?? \u0022255\u0022);\r\n\r\n\t\t\t\t// prepare the bitmap\r\n\t\t\t\tvar bitmap = new SKBitmap(width, height, SKColorType.Rgb888x, SKAlphaType.Opaque);\r\n\t\t\t\tvar nofpixels = width * height;\r\n\r\n\t\t\t\tint n = 0, x = 0, y = 0;\r\n\t\t\t\tSKColor color;\r\n\t\t\t\twhile (r.ReadColor(out color))\r\n\t\t\t\t{\r\n\t\t\t\t\tif (x \u003E= width)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ty\u002B\u002B; x = 0;\r\n\t\t\t\t\t\tif (y \u003E= height) throw new Exception(\u0022Bad image foramt.\u0022);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbitmap.SetPixel(x\u002B\u002B, y, color);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (y * width \u002B x != nofpixels) throw new Exception(\u0022Bad image format.\u0022);\r\n\r\n\t\t\t\treturn bitmap;\r\n\t\t\t}\r\n\t\t}\r\n\t\tpublic static SKBitmap BitmapFromFile(string filename)\r\n\t\t{\r\n\t\t\tusing (var file = File.OpenRead(filename)) return BitmapFromStream(file);\r\n\t\t}\r\n\r\n\t\tpublic static SKImage SkiaImageFromStream(Stream stream) =\u003E SKImage.FromBitmap(BitmapFromStream(stream));\r\n\t\tpublic static SKImage SkiaImageFromFile(string filename) =\u003E SKImage.FromBitmap(BitmapFromFile(filename));\r\n\r\n\t\tpublic PpmImage() { }\r\n\t\tpublic PpmImage(Stream stream)\r\n\t\t{\r\n\t\t\tSkiaImage = SkiaImageFromStream(stream);\r\n\t\t}\r\n\t\tpublic PpmImage(string filename)\r\n\t\t{\r\n\t\t\tSkiaImage = SkiaImageFromFile(filename);\r\n\t\t}\r\n\r\n\t\tpublic static PpmImage FromStream(Stream stream) =\u003E new PpmImage(stream);\r\n\t\tpublic static PpmImage FromFile(string filename) =\u003E new PpmImage(filename);\r\n\t}\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2024-04-02T09:31:07",
        "reactions": []
      }
    ]
  }
}