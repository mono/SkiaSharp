{
  "number": 2446,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Memory leak occurs while measuring the text using font stream",
  "body": "**Description**\r\n\r\nMemory keep on increasing while measuring the text using font stream\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\nfor (int i = 0; true; i\u002B\u002B)\r\n{\r\n    Console.WriteLine(i);\r\n    // Memory leak occurs while measuring the text using font stream.\r\n    MeasureTextUsingFontStream();\r\n}\r\n\r\n// Measure the text using font stream\r\nstatic void MeasureTextUsingFontStream() {\r\n    using (var stream = File.OpenRead(@\u0022../../../arial.ttf\u0022)) {\r\n        using (var typeface = SKTypeface.FromStream(stream)) {\r\n            using (var paint = new SKPaint { Typeface = typeface }) {\r\n                // Issue doesn\u0027t occur if we commented the below line.\r\n                var width = paint.MeasureText(\u0022Hello, world!\u0022);\r\n                paint.Dispose();\r\n            }\r\n            typeface.Dispose();\r\n        }\r\n        stream.Dispose();\r\n    }    \r\n    GC.Collect();\r\n    GC.WaitForPendingFinalizers();\r\n}\r\n\u0060\u0060\u0060\r\n**_Note: You can use any available TTF font to replicate this problem._**\r\n\r\n**Expected Behavior**\r\n\r\nAllocated memory should be disposed properly\r\n\r\n**Actual Behavior**\r\n\r\nMemory allocation increasing rapidly without any disposal\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.3\r\n- Last known good version: None\r\n- IDE:  Visual Studio\r\n- Platform Target Frameworks:\r\n  - Windows Classic:  Windows 10\r\n  \r\n\u003Cdetails\u003E\r\n**IDE:**\r\nMicrosoft Visual Studio Professional 2022 (64-bit) - Preview\r\nVersion 17.6.0 Preview 1.0\r\n\r\n**OS:**\r\nOS\t\t- Windows 10 Pro\r\nProcessor\t- Intel(R) Core(TM) i5-7200U CPU @ 2.50GHz   2.71 GHz\r\nInstalled RAM\t- 16.0 GB (15.9 GB usable)\r\nSystem type\t- 64-bit operating system, x64-based processor\r\n\u0060\u0060\u0060\r\n\r\nPASTE ANY DETAILED VERSION INFO HERE\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n\r\n**Screenshots**\r\n\r\n**Measuring the text using font stream:** (Memory keep on increasing here)\r\n\r\n![image](https://user-images.githubusercontent.com/93113962/233086270-1fb5b85a-d5e0-4758-8ff0-1737f3593a55.png)\r\n\r\n**Measuring the text using installed font:** (Memory disposed properly here and it\u0027s maintained in same level)\r\n\r\n![image](https://user-images.githubusercontent.com/93113962/233086612-91c672a0-e8e0-41a1-8079-7974cb324fe0.png)\r\n\r\n**Reproduction Link**\r\n\r\nPlease use the attached sample to replicate the same problem,\r\n[SkiaSharpTesting.zip](https://github.com/mono/SkiaSharp/files/11273548/SkiaSharpTesting.zip)\r\n\r\n",
  "author": {
    "login": "Ramaraj-Marimuthu",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-04-19T13:20:25",
  "updatedAt": "2024-09-19T14:01:22",
  "commentCount": 9,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:34:25.848048Z",
    "reactions": [],
    "comments": [
      {
        "id": 1514862237,
        "author": "Gillibald",
        "body": "Could you try to create the typeface outside the loop? You will most likely not see any increase in memory usage. Skia is caching glyphs data and is only clearing the cache if it reaches some defined memory usage level.",
        "createdAt": "2023-04-19T14:40:59",
        "reactions": [
          {
            "user": "Ramaraj-Marimuthu",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:34:24.1581457Z"
          }
        ]
      },
      {
        "id": 1515824909,
        "author": "Ramaraj-Marimuthu",
        "body": "@Gillibald, Thanks for the update.\r\n\r\nYes, as you mentioned memory leak doesn\u2019t occur if we create the typeface outside the loop.\r\n\r\nBut for our requirement, we need to create a typeface for every looping. So, is there any possibility to forcibly dispose the memory by using any API\u2019s?",
        "createdAt": "2023-04-20T07:12:05",
        "reactions": []
      },
      {
        "id": 1519406647,
        "author": "Ramaraj-Marimuthu",
        "body": "@Gillibald \u0026 @mattleibow - Any solution for this?\r\n\r\nIt would be very helpful for us.",
        "createdAt": "2023-04-24T05:27:49",
        "reactions": []
      },
      {
        "id": 1520626602,
        "author": "FoggyFinder",
        "body": "\u003E But for our requirement, we need to create a typeface for every looping\r\n\r\nWhy do you need it though?",
        "createdAt": "2023-04-24T18:19:12",
        "reactions": [
          {
            "user": "Ramaraj-Marimuthu",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:34:24.7500092Z"
          }
        ]
      },
      {
        "id": 1521170987,
        "author": "Ramaraj-Marimuthu",
        "body": "@FoggyFinder - Please find the below requirement details,\r\n\r\nWe are working on the Word document to PDF conversion project, and we are using the SkiaSharp library to measure the width and height of the text by using an [embedded font](https://support.microsoft.com/en-us/topic/how-to-embed-a-truetype-font-in-a-document-883f5212-0c1a-28df-8bb1-21273fa67e7e) stream in the document.\r\n\r\nWhile converting multiple (more than 100) Word documents to PDF in for loop, memory keeps on growing until the loop ends due to creating more number of SKTypeface for each Word document. Since each Word document may have a different set of embedded font streams, it\u2019s not possible to create SKTypeface commonly (outside of the loop).\r\n\r\nTo avoid this memory leak problem, we expected to dispose the SKTypeface allocated memory after completing each conversion. Could you please help us to solve this memory problem?\r\n\r\n**_Note: At certain stage, app crashed with out of memory problem._**",
        "createdAt": "2023-04-25T05:25:02",
        "reactions": []
      },
      {
        "id": 1522896979,
        "author": "Ramaraj-Marimuthu",
        "body": "@FoggyFinder \u0026 @Gillibald  \u0026 @mattleibow - Any help would be much more appreciated.",
        "createdAt": "2023-04-26T07:07:51",
        "reactions": []
      },
      {
        "id": 1527643381,
        "author": "themcoo",
        "body": "\u0060SkTypefaceCache\u0060 is not exposed in skia sharp, but the purge can be called via SkGraphics:\r\n\r\n\u0060SKGraphics.PurgeFontCache();\u0060\r\n\r\nYou can also set your own limits in the cache via\r\n\u0060\u0060\u0060\r\nSKGraphics.SetFontCacheCountLimit\r\nSKGraphics.SetFontCacheLimit\r\n\u0060\u0060\u0060\r\n",
        "createdAt": "2023-04-28T14:18:55",
        "reactions": []
      },
      {
        "id": 1531596714,
        "author": "Ramaraj-Marimuthu",
        "body": "@themcoo - Huge thanks for your solution. It\u0027s solved the problem in attached simple app.\r\n\r\nWill try the same in our project and will update further details.\r\n\r\nThanks again @themcoo",
        "createdAt": "2023-05-02T14:36:47",
        "reactions": []
      },
      {
        "id": 2361071824,
        "author": "afruzan",
        "body": "I had same memory leak issue when using \u0060SKTypeface.FromFile\u0060.  Using \u0060SKGraphics.PurgeFontCache();\u0060 didn\u0027t solve my issue.\r\n\r\n At the end I solved memory leak by encapsulating and caching output of \u0060SKTypeface.FromFile\u0060 in a static class.\r\n \r\n \u0060\u0060\u0060c#\r\n public static SKTypeface? GetTypefaceFromFile(string filename)\r\n {\r\n     return typefaceCache.GetOrAdd(filename, filename =\u003E SKTypeface.FromFile(filename) ?? null);\r\n }\r\n \u0060\u0060\u0060",
        "createdAt": "2024-09-19T14:00:24",
        "reactions": []
      }
    ]
  }
}