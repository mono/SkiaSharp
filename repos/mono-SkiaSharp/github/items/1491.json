{
  "number": 1491,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Protected Memory Access Attemps on GPU GRContext",
  "body": "Description:\r\n\r\nI have an application with an SkElement in WPF, I Made a GPU GrContext, and everything works, but at random times the error: System.AccessViolationException\u00A0happears when any attempt to drawing on the Surface canvas binded with the gr context is made. The error was triggered when the InvalidateVisual() was called on the SKElement from a background worker, if I don\u0027t use the background worker, everything goes fine. \u003C Maybe dued to the memory used like montains in the TaskManager\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\nvar vb = new WpfGles.GlesImage(); //Set The GrContext\r\n            vb.Width = 1920;\r\n            vb.Height = 1080;\r\n            vb.start();\r\n            interf = GRGlInterface.Create();\r\n            _context = GRContext.CreateGl(interf);\r\n            //_context.SetResourceCacheLimits(200, 4000000000);\r\n            _context.SetResourceCacheLimit(4000000000);\r\n            var glInfo = new GRGlFramebufferInfo(\r\n                fboId: 0,\r\n                format: SKColorType.Rgba8888.ToGlSizedFormat());\r\n\r\n            var renderTarget = new GRBackendRenderTarget(\r\n                width: 1920,\r\n                height: 1080,\r\n                sampleCount: 0,\r\n                stencilBits: 0,\r\n                glInfo: glInfo\r\n                );\r\n            \r\n\r\n            Surface = SKSurface.Create(\r\n                _context, renderTarget, GRSurfaceOrigin.BottomLeft, SKColorType.Rgba8888);\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nSurface.Canvas.Draw(...) without any System.AccessViolationException\r\n\r\n**Actual Behavior**\r\n\r\n   at SkiaSharp.SkiaApi.sk_canvas_draw_image(IntPtr param0, IntPtr param1, Single x, Single y, IntPtr param4)\r\n   at SkiaSharp.SKCanvas.DrawImage(SKImage image, SKPoint p, SKPaint paint)\r\n   at sdg.VideoConceptor.Scene_PaintSurface(Object sender, SKPaintSurfaceEventArgs e) in C:\\Users\\axel\\source\\repos\\sdg\\sdg\\VideoConceptor.xaml.cs:line 524\r\n   at SkiaSharp.Views.WPF.SKElement.OnRender(DrawingContext drawingContext)\r\n   at System.Windows.UIElement.Arrange(Rect finalRect)\r\n   at System.Windows.ContextLayoutManager.UpdateLayout()\r\n   at System.Windows.ContextLayoutManager.UpdateLayoutCallback(Object arg)\r\n   at System.Windows.Media.MediaContext.FireInvokeOnRenderCallbacks()\r\n   at System.Windows.Media.MediaContext.RenderMessageHandlerCore(Object resizedCompositionTarget)\r\n   at System.Windows.Media.MediaContext.RenderMessageHandler(Object resizedCompositionTarget)\r\n   at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Int32 numArgs)\r\n   at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Int32 numArgs, Delegate catchHandler)\r\n   at System.Windows.Threading.DispatcherOperation.InvokeImpl()\r\n   at MS.Internal.CulturePreservingExecutionContext.CallbackWrapper(Object obj)\r\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\r\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\r\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)\r\n   at MS.Internal.CulturePreservingExecutionContext.Run(CulturePreservingExecutionContext executionContext, ContextCallback callback, Object state)\r\n   at System.Windows.Threading.DispatcherOperation.Invoke()\r\n   at System.Windows.Threading.Dispatcher.ProcessQueue()\r\n   at System.Windows.Threading.Dispatcher.WndProcHook(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean\u0026 handled)\r\n   at MS.Win32.HwndWrapper.WndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean\u0026 handled)\r\n   at MS.Win32.HwndSubclass.DispatcherCallbackOperation(Object o)\r\n   at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Int32 numArgs)\r\n   at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Int32 numArgs, Delegate catchHandler)\r\n   at System.Windows.Threading.Dispatcher.LegacyInvokeImpl(DispatcherPriority priority, TimeSpan timeout, Delegate method, Object args, Int32 numArgs)\r\n   at MS.Win32.HwndSubclass.SubclassWndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam)\r\n   at MS.Win32.UnsafeNativeMethods.DispatchMessage(MSG\u0026 msg)\r\n   at System.Windows.Threading.Dispatcher.PushFrameImpl(DispatcherFrame frame)\r\n   at System.Windows.Application.RunDispatcher(Object ignore)\r\n   at System.Windows.Application.RunInternal(Window window)\r\n   at sdg.App.Main()\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.80.2-preview.36\r\n- Last known good version:  None\r\n- IDE:  Visual Studio 2019\r\n\r\n  \r\n\r\n\r\n\r\n**Screenshots**\r\n\r\n\r\n![image](https://user-images.githubusercontent.com/44734791/92410290-f5f81300-f143-11ea-9997-a91e7105994e.png)\r\n\r\n\r\n",
  "author": {
    "login": "axel578",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2020-09-07T17:55:03",
  "updatedAt": "2020-10-14T00:55:54",
  "commentCount": 6,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:27:02.9589916Z",
    "reactions": [],
    "comments": [
      {
        "id": 688474915,
        "author": "mattleibow",
        "body": "It might be because you are drawing on the surface using a different thread that you created the buffer?\r\n\r\nI am not exactly sure how GL works, but I don\u0027t think you can create and use a FBO from different threads? Or, you may be conflicting with multiple calls and such. Finally, is the GLES context set to be the current?\r\n\r\nAre you able to replace all the drawing code and say clear with red? Does that crash?\r\nYou can also try using the same background thread to create and draw, that might show where the issue is happening.\r\n\r\nFinally, are you able to provide a small repro case?",
        "createdAt": "2020-09-07T18:56:02",
        "reactions": []
      },
      {
        "id": 688488359,
        "author": "axel578",
        "body": "Yeah, seems it\u0027s that, Is there any way to give access to drawing on the SkElement directly rather than doing it through the event Scene_PaintSurface ?\r\nIs there also any way to implement A GrContext from open gl 64 bits and not 32bits or something different from open gl ?  because skiasharp works really well with gpu ",
        "createdAt": "2020-09-07T19:43:44",
        "reactions": []
      },
      {
        "id": 688503691,
        "author": "mattleibow",
        "body": "I am assuming you are using https://github.com/l3m/wpf-gles?\r\n\r\nThat code doesn\u0027t seem to be 32/64 bit specific. It might just be the binaries or target you are compiling?\r\n\r\nFor UWP I actually \u0022cheat\u0022 a bit and don\u0027t actually follow the same pattern. I have a render thread that runs and when the view is \u0022invalidated\u0022 a simple raise an event from the background thread. \r\n\r\nAlso, that Gles is a view... Can you not use that directly? Basically create your own \u0022paint\u0022 event? Effectively, create a new control that inherits from GlesImage and then creates and draws via a internal renderer? The you don\u0027t need an SKElement at all.",
        "createdAt": "2020-09-07T20:39:22",
        "reactions": []
      },
      {
        "id": 689556486,
        "author": "axel578",
        "body": "Okay I\u0027ll give a try on that, I used the SkElement because it\u0027s the fastest way to render from my test, thanks again for your answer",
        "createdAt": "2020-09-09T13:16:38",
        "reactions": []
      },
      {
        "id": 689702207,
        "author": "mattleibow",
        "body": "Let me know how it goes.\r\n\r\nSKElement is not the most exciting things, but it will always come back to the UI thread - which may not be what you want: https://github.com/mono/SkiaSharp/blob/master/source/SkiaSharp.Views/SkiaSharp.Views.WPF/SKElement.cs\r\n\r\nIf you get  nice working example of GLES and SkiaSharp, then I\u0027ll have a look at merging it into this repo so you won\u0027t have to maintain it. If you are interested in that sort of thing \uD83D\uDE04 ",
        "createdAt": "2020-09-09T17:14:39",
        "reactions": []
      },
      {
        "id": 708089388,
        "author": "mattleibow",
        "body": "There is also the #1521  PR which has some things that is related to this one. And #745",
        "createdAt": "2020-10-14T00:55:27",
        "reactions": []
      }
    ]
  }
}