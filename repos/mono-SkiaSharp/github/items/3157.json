{
  "number": 3157,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKImage.FromPicture throws System.AccessViolationException in V3, it works in V2",
  "body": "### Description\n\n[SKImage.FromPicture](https://learn.microsoft.com/en-us/dotnet/api/skiasharp.skimage.frompicture?view=skiasharp-2.88#skiasharp-skimage-frompicture(skiasharp-skpicture-skiasharp-sksizei)) method throws\n**System.AccessViolationException:** \u0027Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\u0027\n\nCall Stack:\n\u0060\u0060\u0060\n[Managed to Native Transition]\t\nSkiaSharp.dll!SkiaSharp.SkiaApi.sk_image_new_from_picture(nint picture, SkiaSharp.SKSizeI* dimensions, SkiaSharp.SKMatrix* cmatrix, nint paint, bool useFloatingPointBitDepth, nint colorSpace, nint props)\tUnknown\nSkiaSharp.dll!SkiaSharp.SKImage.FromPicture(SkiaSharp.SKPicture picture, SkiaSharp.SKSizeI dimensions, SkiaSharp.SKMatrix* matrix, SkiaSharp.SKPaint paint, bool useFloatingPointBitDepth, SkiaSharp.SKColorSpace colorspace, SkiaSharp.SKSurfaceProperties props)\tUnknown\nSkiaSharp.dll!SkiaSharp.SKImage.FromPicture(SkiaSharp.SKPicture picture, SkiaSharp.SKSizeI dimensions)\tUnknown\nSkiaSharpIssue.dll!SkiaSharpIssue.Program.Main(string[] args) Line 26\tC#\n\u0060\u0060\u0060\n\nThe issue is reproduced using any V3 version of the [SkiaSharp](https://www.nuget.org/packages/SkiaSharp/) package.\nThe code works as expected when using the V2 version.\n\nThe issue is reproduced both on Windows and Linux (reproduced via Docker).\n\n\n### Code\n\nVisual Studio solution that reproduces the issue: [SkiaSharpIssue.zip](https://github.com/user-attachments/files/18687981/SkiaSharpIssue.zip)\n\n**Program.cs**\n\u0060\u0060\u0060cs\nusing System;\nusing System.IO;\nusing SkiaSharp;\n\nnamespace SkiaSharpIssue\n{\n    internal class Program\n    {\n        static void Main(string[] args)\n        {\n            SKPicture picture;\n            using (var pictureRecorder = new SKPictureRecorder())\n            {\n                using (var canvas = pictureRecorder.BeginRecording(new SKRect(0, 0, 500, 500)))\n                {\n                    using (var paint = new SKPaint())\n                    {\n                        paint.Color = new SKColor(0xFF, 0, 0);\n                        canvas.DrawRect(100, 100, 300, 200, paint);\n                    }\n                }\n\n                picture = pictureRecorder.EndRecording();\n            }\n\n            SKBitmap bitmap;\n            using (picture)\n            using (var image = SKImage.FromPicture(picture, new SKSizeI(500, 500)))\n                bitmap = SKBitmap.FromImage(image);\n\n            using (bitmap)\n            using (var stream = File.OpenWrite(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.Desktop), \u0022picture.png\u0022)))\n                bitmap.Encode(stream, SKEncodedImageFormat.Png, 100);\n        }\n    }\n}\n\u0060\u0060\u0060\n\n**SkiaSharpIssue.csproj**\n\u0060\u0060\u0060xml\n\u003CProject Sdk=\u0022Microsoft.NET.Sdk\u0022\u003E\n\n  \u003CPropertyGroup\u003E\n    \u003COutputType\u003EExe\u003C/OutputType\u003E\n    \u003CTargetFramework\u003Enet8.0\u003C/TargetFramework\u003E\n    \u003CNullable\u003Eenable\u003C/Nullable\u003E\n    \u003CDockerDefaultTargetOS\u003ELinux\u003C/DockerDefaultTargetOS\u003E\n  \u003C/PropertyGroup\u003E\n\n  \u003CItemGroup\u003E\n\n    \u003C!-- DOESN\u0027T WORK --\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.118.0-preview.2.3\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.118.0-preview.2.3\u0022 /\u003E\n\n    \u003C!-- DOESN\u0027T WORK --\u003E\n    \u003C!--\u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.116.1\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.116.1\u0022 /\u003E--\u003E\n\n    \u003C!-- DOESN\u0027T WORK --\u003E\n    \u003C!--\u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.116.0\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.116.0\u0022 /\u003E--\u003E\n\n    \u003C!-- DOESN\u0027T WORK --\u003E\n    \u003C!--\u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.0.0-preview.0.132\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.0.0-preview.0.132\u0022 /\u003E--\u003E\n\n    \u003C!-- WORKS --\u003E\n    \u003C!--\u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00222.88.9\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00222.88.9\u0022 /\u003E--\u003E\n\n    \u003CPackageReference Include=\u0022Microsoft.VisualStudio.Azure.Containers.Tools.Targets\u0022 Version=\u00221.21.0\u0022 /\u003E\n  \u003C/ItemGroup\u003E\n\n\u003C/Project\u003E\n\u0060\u0060\u0060\n\n\n### Expected Behavior\n\nExpected behavior of the code is that the file \u0027picture.png\u0027 should be created.\n\n### Actual Behavior\n\nActual behavior of the code is that the System.AccessViolationException is thrown.\n\n### Version of SkiaSharp\n\n3.116.0 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.9 (Previous)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nWindows\n\n### Platform / Operating System Version\n\n- Windows 10\n- Linux (via Docker)\n\n### Devices\n\n- Laptop\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n\u0060\u0060\u0060shell\n\n\u0060\u0060\u0060\n\n### Code of Conduct\n\n- [x] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "StipoR",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2025-02-06T10:03:44",
  "updatedAt": "2025-04-10T22:33:47",
  "closedAt": "2025-04-10T22:33:47",
  "commentCount": 3,
  "reactionCount": 0
}