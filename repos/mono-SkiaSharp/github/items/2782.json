{
  "number": 2782,
  "type": "issue",
  "state": "open",
  "title": "SKShader.CreateLocalMatrix may or may not return the same object",
  "body": "\r\n_Originally posted by @andersforsgren in https://github.com/mono/SkiaSharp/discussions/2652#discussioncomment-7324838_\r\n\r\nI think both the C# api wrapper and the C\u002B\u002B code **should** return the same object, but that object should have an increased ref count?\r\n\r\n\u0060\u0060\u0060c\u002B\u002B\r\n if (localMatrix.isIdentity()) {\r\n        return sk_ref_sp(const_cast\u003CSkShader*\u003E(this));\r\n }\r\n\u0060\u0060\u0060 \r\nShuldn\u0027t this increase the ref count to \u0027this\u0027 by one before it returns the same ref counted pointer? I can\u0027t see where it\u0027s going wrong then. But it definitely changed behavior since 1.X\r\n\r\nHere is the behavior in e.g. v1.60.1 (I Didn\u0027t actually look at the ref counts in this version because I didn\u0027t find SkiaApi.sk_refcnt_get_ref_count but the object \u0060temp\u0060 is the same as the object \u0060shader1\u0060 here, in when \u0060mat\u0060 is identity. So that behavior of returning the same shader reference has not changed. But the ref counting seems to have stopped working?)\r\n\r\n\u0060\u0060\u0060csharp\r\nusing (SKShader shader1 = SKShader.CreateColor(new SKColor()))    // shader1 has ref count=1\r\n{\r\n   using (SKShader temp = SKShader.CreateLocalMatrix(shader1, mat)) // Temp has the same Handle but with ref count 2\r\n   {\r\n       // use temp wrapper here\r\n   }  // temp is disposed which decrements the ref count on its handle to 1, so the handle is still not IntPtr.Zero\r\n   \r\n   // keep using shader1 here.  This works.\r\n   \r\n} // shader1 is disposed which decrements the ref count to 0  and the Handle becomes IntPtr.Zero here.\r\n\r\n\u0060\u0060\u0060 \r\n\r\nBehavior in v2.88:\r\n\u0060\u0060\u0060csharp\r\nusing (SKShader shader1 = SKShader.CreateColor(new SKColor()))    // shader1 has ref count=1\r\n{\r\n   using (SKShader temp = SKShader.CreateLocalMatrix(shader1, mat)) // Temp has the same Handle, and ref count=1 (!)\r\n   {\r\n       // use temp wrapper here\r\n   }  // temp is disposed, ref count becomes 0, so the handle becomes IntPtr.Zero for both temp and shader1\r\n   \r\n   // keep using shader1 here. This will fail.\r\n} \r\n\u0060\u0060\u0060 \r\n\r\nIn 2.88 I could actually check the ref counts in the above example simply by adding a watch statement for SkiaApi.sk_refcnt_get_ref_count to confirm that the ref count is never 2.\r\n\r\nUpdate: Stepping through it I can see that the createLocalMatrix does bump the ref count to 2, but that the managed wrapper does an unref() before returning. That happens in GetOrAddObject() which is called with unrefExisting=true\r\n\r\n\u0060\u0060\u0060\r\nSkiaSharp.dll!SkiaSharp.SKObjectExtensions.SafeUnRef(SkiaSharp.ISKReferenceCounted obj) Line 341\r\nSkiaSharp.dll!SkiaSharp.HandleDictionary.GetOrAddObject\u003CSkiaSharp.SKShader\u003E(nint handle, bool owns, bool unrefExisting, System.Func\u003Cnint, bool, SkiaSharp.SKShader\u003E objectFactory) Line 86\r\nSkiaSharp.dll!SkiaSharp.SKObject.GetOrAddObject\u003CSkiaSharp.SKShader\u003E(nint handle, System.Func\u003Cnint, bool, SkiaSharp.SKShader\u003E objectFactory) Line 104\r\nSkiaSharp.dll!SkiaSharp.SKShader.GetObject(nint handle) Line 434\r\nSkiaSharp.dll!SkiaSharp.SKShader.WithLocalMatrix(SkiaSharp.SKMatrix localMatrix) Line 31\r\n\u0060\u0060\u0060 \r\n\r\nI used this test case \r\n\r\n\u0060\u0060\u0060csharp\r\n[Fact]\r\npublic void TestCreateLocalMatrixRefCount()\r\n{\r\n\tSKShader s1 = SKShader.CreateColor(new SKColor(255, 0, 0, 128));\r\n\tAssert.Equal(1, SkiaApi.sk_refcnt_get_ref_count(s1.Handle));\r\n\tSKShader s2 = s1.WithLocalMatrix(SKMatrix.CreateIdentity());\r\n\tAssert.True(ReferenceEquals(s1, s2));\r\n\tAssert.Equal(2, SkiaApi.sk_refcnt_get_ref_count(s1.Handle));\r\n\ts2.Dispose();\r\n\tAssert.Equal(1, SkiaApi.sk_refcnt_get_ref_count(s1.Handle));\r\n\tAssert.NotEqual(IntPtr.Zero, s1.Handle);\r\n\ts1.Dispose();\r\n\tAssert.Equal(IntPtr.Zero, s1.Handle);\r\n}\r\n\u0060\u0060\u0060\r\n",
  "author": {
    "login": "mattleibow",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2024-03-03T18:06:57",
  "updatedAt": "2024-03-04T15:16:31",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:56:32.9841183Z",
    "reactions": [],
    "comments": [
      {
        "id": 1975249739,
        "author": "mattleibow",
        "body": "In the older versions, the matrix shader was always a new instance, however, that API was removed. I had naively assumed the instance method with the same feature was exactly the same. They made an optimization in the method to just return \u0060this\u0060 if the matrix was an identity.\r\n\r\nThe solution here is to actually always make a new instance. It is not the fastest path, but it is the better one for the managed world. If you make a shader, you will be in control of the lifetime. Disposing of one will always clean up things. We _can_ make instances smart and dereference, but in .NET \u0060Dispose()\u0060 really is a cleanup and it would be unexpected to still have it around and you having to call dispose multiple times.\r\n\r\nI think I am just going to remove the fast path and skip the identity check. The color filter variation also suffers from this issue where a null color filter will return the same instance, but I block that with an exception. However, I can\u0027t do that as an identity matrix is mostly still valid. ",
        "createdAt": "2024-03-03T18:13:37",
        "reactions": [
          {
            "user": "andersforsgren",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:56:32.5401999Z"
          }
        ]
      },
      {
        "id": 1976538452,
        "author": "andersforsgren",
        "body": "Sounds good. Cheers.\r\nSounds like I don\u0027t need to create a bug then? Let me know if you insist on one. \r\n",
        "createdAt": "2024-03-04T13:04:01",
        "reactions": []
      },
      {
        "id": 1976818670,
        "author": "mattleibow",
        "body": "Ah sorry, this is the bug. Decided to press a button and convert your findings into an issue. Technology makes it so easy :)",
        "createdAt": "2024-03-04T15:16:29",
        "reactions": []
      }
    ]
  }
}