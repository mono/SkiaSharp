{
  "number": 2429,
  "type": "issue",
  "state": "open",
  "title": "[BUG] SKBitmap.Decode always returns null for a specific image",
  "body": "**Description**\r\n\r\nCannot create Bitmap or Codec of a specific jpg image (attached).\r\n\r\nThe image is not corrupted, it can be opened in Windows Photos and other image viewers, it can be displayed by browser.\r\n\r\nLooks similar to https://github.com/mono/SkiaSharp/issues/1621 and https://github.com/mono/SkiaSharp/issues/1551. However, this workaround does not work:\r\n\r\n\u0060\u0060\u0060csharp\r\nStream? stream = /*......*/;\r\nusing var inputStream = new SKManagedStream(stream);\r\nusing var inputData = SKData.Create(inputStream);\r\nvar bitmap = SKBitmap.Decode(inputData);\r\nvar image = SKImage.FromBitmap(bitmap);\r\nvar outputData = image.Encode(SKEncodedImageFormat.Png, 100);\r\n\u0060\u0060\u0060\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060csharp\r\nusing var bitmap = SKBitmap.Decode(imageContentStream); // Returns null\r\nusing var codec = SKCodec.Create(imageContentStream); // Returns null\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nBitmap and codec are created from a stream.\r\n\r\n**Actual Behavior**\r\n\r\nBitmap and codec creation returns \u0060null\u0060.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue: 2.80.4 (also tested on 2.88.3)\r\n- Last known good version:  N/A\r\n- IDE:  Rider\r\n- Platform Target Frameworks:\r\n  - Linux: Debian 11 (bullseye-slim docker image)\r\n  - Windows Classic:  Windows 10 (10.0.19045)\r\n- Target Devices: x64\r\n\r\n**Screenshots**\r\n\r\n**Reproduction Link**\r\n\r\n[image.zip](https://github.com/mono/SkiaSharp/files/11087936/image.zip)\r\n\r\n",
  "author": {
    "login": "olegbaslak",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-03-28T10:35:08",
  "updatedAt": "2024-11-19T12:21:15",
  "commentCount": 8,
  "reactionCount": 2,
  "engagement": {
    "syncedAt": "2026-02-06T12:49:20.3590286Z",
    "reactions": [
      {
        "user": "lindexi",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:49:20.359035Z"
      },
      {
        "user": "torum",
        "content": "\u002B1",
        "createdAt": "2026-02-06T12:49:20.3590355Z"
      }
    ],
    "comments": [
      {
        "id": 1487035134,
        "author": "olegbaslak",
        "body": "It does not work for Java bindings too. Looks like the problem may be in the Skia code.",
        "createdAt": "2023-03-28T14:47:33",
        "reactions": []
      },
      {
        "id": 1493052247,
        "author": "JanKotschenreuther",
        "body": "I think i ran into the same problem.\r\n\r\nI am using InputFile to offer the user the option to pick a file from his local client-site filesystem.\r\nAfter has been picked, the \u0060OnChange\u0060-Event is fired and after all conditions are met, stream is read by the event handler \u0060PickFileAsync\u0060.\r\nStream lengths have been checked to make sure the streams contain all bytes of the file.\r\n\u0060SKBitmap.Decode\u0060 returns null, when passing the memorystream.\r\n\r\nI have been using simple .png files with QR-Codes as content, like this one:\r\n\r\n![qr5](https://user-images.githubusercontent.com/20000282/229305641-e4777e8a-2b9d-4e14-982a-28b367dc456d.png)\r\n\r\n\u0060\u0060\u0060razor\r\n@using SkiaSharp.Views.Blazor\r\n@using SkiaSharp;\r\n\r\n\u003Cdiv\u003E\r\n  @*InputFile is of type Microsoft.AspNetCore.Components.Forms.IBrowserFile.InputFile*@\r\n  \u003CInputFile OnChange=\u0022PickFileAsync\u0022\u003E\u003C/InputFile\u003E\r\n\u003C/div\u003E\r\n\u003Cdiv\u003E\r\n  \u003CSKCanvasView @ref=\u0022_canvasView\u0022 OnPaintSurface=\u0022PaintSurface\u0022 width=\u0022@(_bitmap?.Width ?? 0)\u0022 height=\u0022@(_bitmap?.Height ?? 0)\u0022\u003E\u003C/SKCanvasView\u003E\r\n\u003C/div\u003E\r\n\r\n@code {\r\n    private SKCanvasView? _canvasView;\r\n    private SKBitmap? _bitmap;\r\n\r\n    private async Task PickFileAsync(InputFileChangeEventArgs e)\r\n    {\r\n        if (e.FileCount \u003E 1)\r\n        {\r\n            Console.WriteLine(\u0022To many files selected!\u0022);\r\n            return;\r\n        }\r\n\r\n        var allowedContentType = \u0022image/png\u0022;\r\n        if (e.File.ContentType != allowedContentType)\r\n        {\r\n            Console.WriteLine($\u0022File ContentType \u0027{e.File.ContentType}\u0027 not supported! Pick an image of ContentType {allowedContentType}\u0022);\r\n            return;\r\n        }\r\n\r\n        if (_bitmap != null)\r\n        {\r\n            _bitmap.Dispose();\r\n            _bitmap = null;\r\n        }\r\n\r\n        //File is of type Microsoft.AspNetCore.Components.Forms.IBrowserFile\r\n        using var stream = e.File.OpenReadStream();\r\n        Console.WriteLine(stream.Length); //returns correct byte size of the file.\r\n        using var memoryStream = new MemoryStream();\r\n        await stream.CopyToAsync(memoryStream);\r\n        Console.WriteLine(memoryStream.Length); //returns correct byte size of the file.\r\n\r\n        //_bitmap is null after SKBitmap.Decode returns.\r\n        this._bitmap = SKBitmap.Decode(memoryStream);\r\n        this._canvasView?.Invalidate();\r\n    }\r\n\r\n    public void PaintSurface(SKPaintSurfaceEventArgs e)\r\n    {\r\n        if (this._bitmap == null)\r\n        {\r\n            return;\r\n        }\r\n\r\n        var canvas = e.Surface.Canvas;\r\n        canvas.Clear();\r\n        canvas.DrawBitmap(this._bitmap, new SKPoint(0, 0));\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThe position of the pointer of the stream has already been at 0.\r\nI tried setting the position to 0 anyway, just to make sure that this is not the same problem as in Issue https://github.com/mono/SkiaSharp/issues/640#issuecomment-711481285.\r\n\u0060\u0060\u0060csharp\r\n//Did not help.\r\nmemoryStream.Seek(0, SeekOrigin.Begin);\r\nmemoryStream.Position = 0;\r\n\u0060\u0060\u0060\r\n\r\nI checked, if \u0060SKData.Create\u0060 may be the point of failure, but it returned an object.\r\n\u0060\u0060\u0060csharp\r\n//skData is not null, but I am absolutley not sure, what the content should look like.\r\nvar skData = SKData.Create(memoryStream);\r\n\u0060\u0060\u0060\r\n\r\n---\r\n\r\n**Workaround**\r\n\r\nIn my case, I am able to workaround this problem using byte-arrays as shown in the following example.\r\n\u0060\u0060\u0060csharp\r\nusing var stream = e.File.OpenReadStream();        \r\nusing var memoryStream = new MemoryStream();        \r\nawait stream.CopyToAsync(memoryStream);\r\nvar byteArray = memoryStream.ToArray();\r\n\r\nthis._bitmap = SKBitmap.Decode(byteArray);\r\nthis._canvasView?.Invalidate();\r\n\u0060\u0060\u0060\r\n\r\nIt is somehow weird that \u0060SKBitmap.Decode\u0060 behaves differently for byte-arrays and streams.\r\n\r\n---\r\n\r\n**Error Handling**\r\n\r\nIt is kind of weird to return null to indicate errors, as the API-Description hints \u0060The decoded bitmap, or null on error.\u0060.\r\nThis makes it very hard to find the true problem.\r\n- Some kind of logging would be nice.\r\n- Throwing an exception, with a message could be helpful, of course that could be a breaking change if anyone relies on null results.\r\n- Or a wrapping object could be returned, like \u0060SkiaSharpResult\u003CSKBitmap\u003E\u0060 or \u0060SKBitmapDecodeResult\u003CSKBitmap\u003E\u0060. The result could contain a boolean like \u0060IsSuccess\u0060 or \u0060IsError\u0060 and nullable properties for error messages and error codes and a property of the result type, which can be null on error or not null on success.\r\n\r\n---\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.3\r\n- Last known good version:  N/A\r\n- IDE:  Microsoft Visual Studio Community 2022 (64-Bit) - Version 17.5.3\r\n- Platform Target Frameworks:\r\n  - Blazor WebAssembly: net7\r\n  - Browser: Microsoft Edge\r\n- Target Devices:  \r\n  - PC: Windows 11 Pro 21H2",
        "createdAt": "2023-04-01T17:26:33",
        "reactions": [
          {
            "user": "AlexPetrova",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:49:19.1611011Z"
          },
          {
            "user": "arthow4n",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:49:19.1611016Z"
          },
          {
            "user": "ecomizzoli",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:49:19.1611017Z"
          }
        ]
      },
      {
        "id": 1494235047,
        "author": "themcoo",
        "body": "@JanKotschenreuther \u0060SKBitmap.Decode(memoryStream);\u0060 overload for streams simply wraps it if it\u0027s seekable. So you create the SKBitmap \u0060this._bitmap\u0060 but before using it you dispose the stream(it\u0027s wrapped in using statement) making SKBitmap unusable. This explains why \u0022the workaround\u0022 with byte arrays works",
        "createdAt": "2023-04-03T12:28:54",
        "reactions": []
      },
      {
        "id": 1495495073,
        "author": "JanKotschenreuther",
        "body": "As far as I know, the using statement I am using there, is scoped to the scope of the method.\r\n\r\nUsing statements without braces and termination by \u0060;\u0060 are disposed at the end of the scope in which they are declared.\r\n- https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/statements/using\r\n",
        "createdAt": "2023-04-04T07:39:24",
        "reactions": []
      },
      {
        "id": 1495501595,
        "author": "themcoo",
        "body": "I know how \u0027using\u0027 is scoped. Are you sure though that\u0060 this._canvasView?.Invalidate();\u0060 is causing synchronous access to the \u0060this._bitmap\u0060 field before the nethod ends? Because I\u0027m pretty sure it does not.",
        "createdAt": "2023-04-04T07:44:41",
        "reactions": []
      },
      {
        "id": 1495519847,
        "author": "JanKotschenreuther",
        "body": "I do not know, if the method \u0060SKCanvasView.Invalidate\u0060 is doing anything asynchronous.\r\n\r\nThe name, parameters or return-types are not telling me it is using any of the well known asynchronous patterns.\r\nI also were not able to find any docs telling me that it could be an asynchronous operation.\r\n- https://learn.microsoft.com/en-us/dotnet/api/skiasharp.views.blazor.skcanvasview.invalidate?view=skiasharp-views-2.88\r\n- https://learn.microsoft.com/en-us/dotnet/api/skiasharp.views.blazor.skcanvasview?view=skiasharp-views-2.88",
        "createdAt": "2023-04-04T07:59:49",
        "reactions": []
      },
      {
        "id": 2099008398,
        "author": "umartechboy",
        "body": "This is strange, either something wrong with Bitmap Data creation, OnPaint event scope or something that isn\u0027t properly documented. I was getting the same issue in a slightly different scenario.\r\n\r\n**Platform:** WebAssembly\r\n**Problem statement:** SKBitmap.Decode on simple byte[] within an OnPaint of the blazor view, bitmap is returned non-null. Image info looks right too (Height, Width, DPI etc). It just doesn\u0027t render rightaway in the same OnPaint call. \r\n**What didn\u0027t work.**\r\nSwitching from SKGLView to SKCanvasView. The only difference was the error shown in console. SKGLView showed a warning of failed image drawing, no info about memory access. SKCanvasView displayed a error with memory access exception. \r\ntry/catch didn\u0027t work either and the OnPaint event returned rightaway.\r\n**What partially worked:** \r\nCacheing the bitmap in global scope and rendering in any coming OnPaint was always successful. \r\nCalling the Bitmap Cache routine in mouse events instead of OnPaint\r\n**Wrong Suspect** My initial suspect was some thread sync issue in WebGL, but there something must be wrong with OnPaint\r\n**Root Cause**: Unknown\r\n**Resolve:** Double Buffering. Keep a buffer of SKBitmap, the same size as the the canvas. Render on the buffer outside OnPaint. Draw on OnPaint request only if the buffer has been prepared. Works like a charm. I only have to keep in mind one extra refresh/invalidate request due to an added layer of buffer.",
        "createdAt": "2024-05-07T18:01:36",
        "reactions": []
      },
      {
        "id": 2485566730,
        "author": "lindexi",
        "body": "Can I ask any update?",
        "createdAt": "2024-11-19T12:21:13",
        "reactions": []
      }
    ]
  }
}