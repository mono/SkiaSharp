{
  "number": 2300,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Indexed image is broken after decode and encode",
  "body": "**Description**\r\n\r\nThe Image is an indexed image, it is broken after decode and encode. Also, the result image changes when you try my sample code for several times.\r\n\r\nsourceImage.png:\r\n![sourceImage](https://user-images.githubusercontent.com/6427581/199411942-d8993e91-7444-41f3-af41-d8b802f35991.png)\r\n\r\ndestImage.png:\r\n![destImage](https://user-images.githubusercontent.com/6427581/199412014-ac8c1aa3-3dcc-4bb3-abc5-7223f3ed5475.png)\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060cs\r\nusing (SKBitmap b = SKBitmap.Decode(\u0022sourceImage.png\u0022))\r\n{\r\n    using (FileStream fs = new FileStream(\u0022destImage.png\u0022, FileMode.Create))\r\n    {\r\n        b.Encode(fs, SKEncodedImageFormat.Png, 100);\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nThe result image is not broken.\r\n\r\n**Actual Behavior**\r\n\r\nThe result image is broken.\r\n\r\n**Basic Information**\r\n\r\n- SkiaSharp 2.88.3\r\n- .Net 6\r\n- Windows 10\r\n\r\n",
  "author": {
    "login": "dallonxu",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-11-01T10:07:38",
  "updatedAt": "2022-11-28T21:08:58",
  "commentCount": 5,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:47:48.9640851Z",
    "reactions": [],
    "comments": [
      {
        "id": 1298303731,
        "author": "dallonxu",
        "body": "It is also not working with the following code:\r\n\u0060\u0060\u0060cs\r\nSKImage image = SKImage.FromEncodedData(\u0022sourceImage.png\u0022);\r\nSKBitmap b = SKBitmap.FromImage(image);\r\nusing (FileStream fs = new FileStream(\u0022destImage.png\u0022, FileMode.Create))\r\n{\r\n    b.Encode(fs, SKEncodedImageFormat.Png, 100);\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2022-11-01T10:08:58",
        "reactions": []
      },
      {
        "id": 1327135496,
        "author": "themcoo",
        "body": "This started with 2.80.0. Previous versions were handling this correctly. \r\n\r\nI played around with libpng version, reverting it to commithash 2ee8cb0559bf826d9bc5c0b0f3c9015f51190814 and bumping to the latest version. No changes whatsoever.",
        "createdAt": "2022-11-25T08:08:00",
        "reactions": []
      },
      {
        "id": 1327867427,
        "author": "themcoo",
        "body": "I found the issue and fix in google/skia repo:\r\nhttps://github.com/google/skia/commit/983ae8625b05737e7528fac074030d11e225961d\r\n\r\n@dallonxu When I cherry-picked this change and rebuilt the libskiasharp.dll your image is decoded/encoded fine.\r\n\r\n@mattleibow how welcome/unwelcone would be cherry picking fixes from google/skia?",
        "createdAt": "2022-11-25T20:25:35",
        "reactions": []
      },
      {
        "id": 1328694749,
        "author": "dallonxu",
        "body": "@themcoo Thanks for your investigation.\r\n\r\n@mattleibow  Is it possbile that the issue will also be fixed in SkiaSharp?",
        "createdAt": "2022-11-28T08:13:35",
        "reactions": []
      },
      {
        "id": 1329765774,
        "author": "themcoo",
        "body": "Anyway I created a PR to mono/skia, in case it can be merged.\r\nhttps://github.com/mono/skia/pull/98",
        "createdAt": "2022-11-28T21:08:58",
        "reactions": [
          {
            "user": "dallonxu",
            "content": "\u002B1",
            "createdAt": "2026-02-06T13:47:48.913898Z"
          }
        ]
      }
    ]
  }
}