{
  "number": 83,
  "type": "issue",
  "state": "closed",
  "title": "Crash in SkManagedSkStream when running in multiple threads",
  "body": "Hi,\n\nI\u0027ve been running some stress testing with the SkiaSharp backend, but I am consistently getting exceptions or out of memory conditions. Those are not reproducible, and sometimes the tests run all correctly, but they do happen a lot.\n\nThe main issue seems to be with SkManagedStream. I get many \u0022ObjectDisposed\u0022 exceptions in AsManagedStream:\n![Object disposed Exception](http://www.tmssoftware.biz/flexcel/img/objectdisposed.png)\n\nAnd also NullExceptions in the SkManagedStream constructor:\n![Object disposed Exception](http://www.tmssoftware.biz/flexcel/img/nullexception.png)\n\nNote that in the image above both \u0022this\u0022 and \u0022ManagedStreams\u0022 are not null.\n\nIt is not something that reproduces always, so I can\u0027t really provide an automated test, but the following code triggers both exceptions here about 50%  of the times:\n\n\u0060\u0060\u0060 c#\nusing SkiaSharp;\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace ConsoleApplication2\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            Random rnd = new Random();\n            Parallel.For(0, 100, \n            (i)=\u003E {\n                OpenImage();\n                Thread.Sleep(rnd.Next(100));\n            });\n            Console.WriteLine(\u0022ok!\u0022);\n        }\n\n        private static void OpenImage()\n        {\n            using (Stream imgStream = new FileStream(@\u0022R:\\tests\\WriteBmp\\extractedshadow1.png\u0022, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))\n            {\n                using (SKManagedStream aSKManagedStream = new SKManagedStream(imgStream))\n                {\n                    SKBitmap.Decode(aSKManagedStream);\n\n                }\n            }\n        }\n    }\n}\n\n\u0060\u0060\u0060\n\nIn the code above,the image is just an small png, but it should happen with any image. (note that larger images might need a larger Sleep() call so there are more probabilities of crashing.\nJust so you can reproduce the test, the image I used is here:\nhttp://www.tmssoftware.biz/flexcel/img/extractedshadow1.png\n\nFrom what I see in the code, it seems that managedStream is a static dictionary (so it is shared among all threads):\n\n\u0060\u0060\u0060 c#\n        private static readonly Dictionary\u003CIntPtr, WeakReference\u003CSKManagedStream\u003E\u003E managedStreams = new Dictionary\u003CIntPtr, WeakReference\u003CSKManagedStream\u003E\u003E();\n\n\u0060\u0060\u0060\n\nBut there doesn\u0027t seem to be any lock or critical sections if 2 threads want to set different values to the dictionary at the same time.\n\nI don\u0027t really know the internals of the code and why the design choices, but I am also not sure about the choice of a WeakReference here: isn\u0027t a WeakReference supposed to be collected even if the object is still referenced? If that is the case, the code:\n\n\u0060\u0060\u0060 c#\n        private static SKManagedStream AsManagedStream(IntPtr ptr)\n        {\n            SKManagedStream target;\n            if (AsManagedStream (ptr, out target)) {\n                return target;\n            }\n            throw new ObjectDisposedException (\u0022SKManagedStream: \u0022 \u002B ptr);\n        }\n\n\u0060\u0060\u0060\n\nCould return null if the object was collected (and so set to null), but the callers of AsManagedStream don\u0027t seem to check for null and try to recreate the object if it was collected.\n",
  "author": {
    "login": "agallero",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "1.59.2",
  "createdAt": "2016-05-14T23:55:47",
  "updatedAt": "2022-08-20T06:01:23",
  "closedAt": "2017-10-25T14:30:58",
  "commentCount": 7,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:52:17.5581408Z",
    "reactions": [],
    "comments": [
      {
        "id": 219752303,
        "author": "migueldeicaza",
        "body": "Thanks for reporting this issue!\n\nThis should be fixed now.\n",
        "createdAt": "2016-05-17T15:21:22",
        "reactions": []
      },
      {
        "id": 287070621,
        "author": "ncthbrt",
        "body": "This seems to have returned in dotnet core ",
        "createdAt": "2017-03-16T14:16:38",
        "reactions": []
      },
      {
        "id": 287420870,
        "author": "mattleibow",
        "body": "Are you able to provide a test case that I can use to get some stacktrace, or some sort of test?",
        "createdAt": "2017-03-17T17:33:08",
        "reactions": []
      },
      {
        "id": 287619806,
        "author": "ncthbrt",
        "body": "This repo https://github.com/ncthbrt/skia-fsharp reliably crashes out when run after browsing to \u0060http://localhost:5000/api/test/1234/image.png\u0060  twice. It doesn\u0027t crash when this line: https://github.com/ncthbrt/skia-fsharp/blob/master/Drawing/Test.fs#L187 is commented out. \r\n\r\nI\u0027ve tried a large number of permutations including locking the decoder thread, loading the image as a byte array, using the file path overload, etc. I\u0027m newish to F# (coming from a C# background) so I am not 100% that this isn\u0027t user error however. I\u0027m getting a hard crash with an exit code that indicates that the crash is a result of an access violation. ",
        "createdAt": "2017-03-19T14:20:14",
        "reactions": []
      },
      {
        "id": 288927983,
        "author": "mattleibow",
        "body": "Moving to the next release so we can get the new skia out.",
        "createdAt": "2017-03-24T04:03:46",
        "reactions": []
      },
      {
        "id": 335844802,
        "author": "mattleibow",
        "body": "I believe this is the more specific issue: #376 ",
        "createdAt": "2017-10-11T15:14:05",
        "reactions": []
      },
      {
        "id": 339349512,
        "author": "mattleibow",
        "body": "Closed with the merge of https://github.com/mono/SkiaSharp/pull/386",
        "createdAt": "2017-10-25T14:30:58",
        "reactions": []
      }
    ]
  }
}