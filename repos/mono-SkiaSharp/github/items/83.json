{
  "number": 83,
  "type": "issue",
  "state": "closed",
  "title": "Crash in SkManagedSkStream when running in multiple threads",
  "body": "Hi,\n\nI\u0027ve been running some stress testing with the SkiaSharp backend, but I am consistently getting exceptions or out of memory conditions. Those are not reproducible, and sometimes the tests run all correctly, but they do happen a lot.\n\nThe main issue seems to be with SkManagedStream. I get many \u0022ObjectDisposed\u0022 exceptions in AsManagedStream:\n![Object disposed Exception](http://www.tmssoftware.biz/flexcel/img/objectdisposed.png)\n\nAnd also NullExceptions in the SkManagedStream constructor:\n![Object disposed Exception](http://www.tmssoftware.biz/flexcel/img/nullexception.png)\n\nNote that in the image above both \u0022this\u0022 and \u0022ManagedStreams\u0022 are not null.\n\nIt is not something that reproduces always, so I can\u0027t really provide an automated test, but the following code triggers both exceptions here about 50%  of the times:\n\n\u0060\u0060\u0060 c#\nusing SkiaSharp;\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Text;\nusing System.Threading;\nusing System.Threading.Tasks;\n\nnamespace ConsoleApplication2\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            Random rnd = new Random();\n            Parallel.For(0, 100, \n            (i)=\u003E {\n                OpenImage();\n                Thread.Sleep(rnd.Next(100));\n            });\n            Console.WriteLine(\u0022ok!\u0022);\n        }\n\n        private static void OpenImage()\n        {\n            using (Stream imgStream = new FileStream(@\u0022R:\\tests\\WriteBmp\\extractedshadow1.png\u0022, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))\n            {\n                using (SKManagedStream aSKManagedStream = new SKManagedStream(imgStream))\n                {\n                    SKBitmap.Decode(aSKManagedStream);\n\n                }\n            }\n        }\n    }\n}\n\n\u0060\u0060\u0060\n\nIn the code above,the image is just an small png, but it should happen with any image. (note that larger images might need a larger Sleep() call so there are more probabilities of crashing.\nJust so you can reproduce the test, the image I used is here:\nhttp://www.tmssoftware.biz/flexcel/img/extractedshadow1.png\n\nFrom what I see in the code, it seems that managedStream is a static dictionary (so it is shared among all threads):\n\n\u0060\u0060\u0060 c#\n        private static readonly Dictionary\u003CIntPtr, WeakReference\u003CSKManagedStream\u003E\u003E managedStreams = new Dictionary\u003CIntPtr, WeakReference\u003CSKManagedStream\u003E\u003E();\n\n\u0060\u0060\u0060\n\nBut there doesn\u0027t seem to be any lock or critical sections if 2 threads want to set different values to the dictionary at the same time.\n\nI don\u0027t really know the internals of the code and why the design choices, but I am also not sure about the choice of a WeakReference here: isn\u0027t a WeakReference supposed to be collected even if the object is still referenced? If that is the case, the code:\n\n\u0060\u0060\u0060 c#\n        private static SKManagedStream AsManagedStream(IntPtr ptr)\n        {\n            SKManagedStream target;\n            if (AsManagedStream (ptr, out target)) {\n                return target;\n            }\n            throw new ObjectDisposedException (\u0022SKManagedStream: \u0022 \u002B ptr);\n        }\n\n\u0060\u0060\u0060\n\nCould return null if the object was collected (and so set to null), but the callers of AsManagedStream don\u0027t seem to check for null and try to recreate the object if it was collected.\n",
  "author": {
    "login": "agallero",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "1.59.2",
  "createdAt": "2016-05-14T23:55:47",
  "updatedAt": "2022-08-20T06:01:23",
  "closedAt": "2017-10-25T14:30:58",
  "commentCount": 7,
  "reactionCount": 0
}