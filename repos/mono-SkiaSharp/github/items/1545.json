{
  "number": 1545,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Cubic antialiasing path isn\u0027t draw on OpenGL",
  "body": "**Description**\r\n\r\nCubic antialiasing path isn\u0027t draw on OpenGL in Windows console project.\r\n\r\n**Code**\r\n\n\u0060\u0060\u0060cs\r\n            var paint = new SKPaint()\r\n            {\r\n                Color = SKColors.White.WithAlpha(100),\r\n                Style = SKPaintStyle.Stroke,\r\n                StrokeWidth = 2,\r\n                IsAntialias = true\r\n            };\r\n\r\n            {\r\n                var path = new SKPath();\r\n                path.MoveTo(0, 0);\r\n                path.LineTo(100, 200);\r\n                canv.DrawPath(path, paint); //is on screen\r\n            }\r\n\r\n            {\r\n                var path = new SKPath();\r\n                path.MoveTo(30, 40);\r\n                path.CubicTo(50, 60, 100, 150, 300, 200);\r\n                canv.DrawPath(path, paint); //is NOT on screen\r\n            }\r\n\u0060\u0060\u0060\n\r\n**Expected Behavior**\r\n\r\nI want to see line and arc on screen. \r\n\r\n**Actual Behavior**\r\n\r\nI see only line, not arc.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.80.2\r\n- Last known good version:  \u003C!-- the version of SkiaSharp that still working --\u003E\r\n- IDE:  Visual Studio Community 2019 Version 16.7.1\r\n- Platform Target Frameworks: \r\n  - Windows Classic:  Windows 10\r\n  \r\n\r\n\u003Cdetails\u003E\r\n  \u003Csummary\u003EDetailed IDE/OS information (click to expand)\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\n\r\nGeforce GTX 760\r\nDriver 26.21.14.3200\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n\r\n**Screenshots**\r\n\r\nNO antialiasing, all lines are present\r\n![image](https://user-images.githubusercontent.com/7722773/97773141-62006180-1b5e-11eb-8992-578f9b355241.png)\r\n\r\nWITH antialiasing, it\u0027s only one line\r\n![image](https://user-images.githubusercontent.com/7722773/97773158-7fcdc680-1b5e-11eb-8083-c1f630d37d8c.png)\r\n\r\n\r\n**Reproduction Link**\r\n\r\nhttps://cemm302.visualstudio.com/_git/SkiaTest?path=%2FSkiaTest\r\n\r\n",
  "author": {
    "login": "MonahovS",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2020-10-31T06:55:44",
  "updatedAt": "2023-08-29T20:53:32",
  "commentCount": 4,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T13:43:42.601858Z",
    "reactions": [],
    "comments": [
      {
        "id": 1694628543,
        "author": "Mis012",
        "body": "I can still reproduce this, it seems clear it\u0027s an issue with Skia since the issue is present even when using the C API.\r\nPresumably it would happen even with the C\u002B\u002B API but I didn\u0027t test that.\r\n\r\nOne thing to note is that I noticed the first frame is always rendered correctly. Also, self-compiled skia from the skiasharp branch with debugging enabled and using system libraries enabled where possible behaves slightly differently, rendering a blinking line which reacts weirdly to canvas size changing.\r\n\r\nantialiasing off (canvas resizing is not a problem here):\r\n![image](https://github.com/mono/SkiaSharp/assets/10321751/8bfd395a-ccbe-4443-8cd4-e08acc05aab2)\r\n\r\nantialiasing on, first frame (canvas resizing would trigger rendering of new frames):\r\n![image](https://github.com/mono/SkiaSharp/assets/10321751/5d5ef973-6dda-477f-80bc-536098334086)\r\n\r\nantialiasing on, non-first frame:\r\n![image](https://github.com/mono/SkiaSharp/assets/10321751/16822e78-3eb1-435f-89a9-3e7ea4986ecd)\r\n\r\n\u0060\u0060\u0060C\r\n// compile with \u0060gcc -g -o skia-c-example -I \u003Cpath to skia\u003E gl_area.c -L\u003Cdirectory with libSkiaSharp.so\u003E -lSkiaSharp \u0060pkgconf --cflags --libs gtk4 epoxy\u0060 -Wall -Wextra -Wno-unused-parameter\u0060\r\n\r\n#include \u003Cgtk/gtk.h\u003E\r\n\r\n#include \u003Cepoxy/egl.h\u003E\r\n#include \u003Cepoxy/gl.h\u003E\r\n\r\n#include \u003Cstdio.h\u003E\r\n#include \u0022include/c/sk_canvas.h\u0022\r\n#include \u0022include/c/sk_data.h\u0022\r\n#include \u0022include/c/sk_image.h\u0022\r\n#include \u0022include/c/sk_imageinfo.h\u0022\r\n#include \u0022include/c/sk_paint.h\u0022\r\n#include \u0022include/c/sk_path.h\u0022\r\n#include \u0022include/c/sk_surface.h\u0022\r\n#include \u0022include/c/gr_context.h\u0022\r\n\r\n#define ___GL_TRACE___(message) glDebugMessageInsert(GL_DEBUG_SOURCE_THIRD_PARTY, GL_DEBUG_TYPE_MARKER, 0xdeadbeef, GL_DEBUG_SEVERITY_NOTIFICATION, strlen(message), message)\r\n\r\n// --- skia\r\n\r\nvoid draw(sk_canvas_t* canvas) {\r\n\tstatic int frame_number = 0;\r\n\tsk_paint_t* fill = sk_paint_new();\r\n\tsk_paint_set_color(fill, sk_color_set_argb(0xFF, 0x00, 0x00, 0xFF));\r\n\tsk_canvas_draw_paint(canvas, fill);\r\n\tsk_paint_set_color(fill, sk_color_set_argb(0xFF, 0x00, 0xFF, 0xFF));\r\n\tsk_rect_t rect;\r\n\trect.left = 100.0f;\r\n\trect.top = 100.0f;\r\n\trect.right = 540.0f;\r\n\trect.bottom = 380.0f;\r\n\tsk_canvas_draw_rect(canvas, \u0026rect, fill);\r\n\tsk_paint_t* stroke = sk_paint_new();\r\n\tsk_paint_set_color(stroke, sk_color_set_argb(0xFF, 0xFF, 0x00, 0x00));\r\n//\tsk_paint_set_antialias(stroke, true); // causes paths which include cubic sections to not render properly\r\n\tsk_paint_set_antialias(stroke, false);\r\n\tsk_paint_set_style(stroke, STROKE_SK_PAINT_STYLE);\r\n\tsk_paint_set_stroke_width(stroke, 5.0f);\r\n\tsk_path_t* path = sk_path_new();\r\n\tsk_path_move_to(path, 50.0f, 50.0f);\r\n\tsk_path_line_to(path, 590.0f, 50.0f);\r\n\tsk_path_cubic_to(path, -490.0f, 50.0f, 1130.0f, 430.0f, 50.0f, 430.0f); // this causes the path to not render properly with antialiasing on\r\n\tsk_path_line_to(path, 590.0f, 430.0f);\r\n\tsk_canvas_draw_path(canvas, path, stroke);\r\n\tsk_canvas_draw_line(canvas, 0, 0, 100, 100, stroke);\r\n\tsk_paint_set_color(fill, sk_color_set_argb(0x80, 0x00, 0xFF, frame_number));\r\n\tsk_rect_t rect2;\r\n\trect2.left = 120.0f;\r\n\trect2.top = 120.0f;\r\n\trect2.right = 520.0f;\r\n\trect2.bottom = 360.0f;\r\n\tsk_canvas_draw_oval(canvas, \u0026rect2, fill);\r\n\tsk_path_delete(path);\r\n\tsk_paint_delete(stroke);\r\n\tsk_paint_delete(fill);\r\n\r\n\tframe_number\u002B\u002B;\r\n\tif(frame_number \u003E 0xFF)\r\n\t\tframe_number = 0;\r\n}\r\n\r\nstatic gr_gl_func_ptr egl_get_gl_proc(void* unused, const char name[]) {\r\n\treturn eglGetProcAddress(name);\r\n}\r\n\r\n// --- gtk\r\n\r\nstruct render_data {\r\n\tgr_direct_context_t *gr_context;\r\n\tsk_surface_t* surface;\r\n\tsk_canvas_t* canvas;\r\n\tgr_backendrendertarget_t *render_target;\r\n\tint prev_width;\r\n\tint prev_height;\r\n};\r\n\r\nstatic gboolean render(GtkGLArea *gl_area, GdkGLContext *context, struct render_data *d)\r\n{\r\n\tint width = gtk_widget_get_width(GTK_WIDGET(gl_area));\r\n\tint height = gtk_widget_get_height(GTK_WIDGET(gl_area));\r\n\r\n\t___GL_TRACE___(\u0022start of render()\u0022);\r\n\r\n\tif(!d-\u003Egr_context) {\r\n\t\tconst gr_glinterface_t *gl_interface = gr_glinterface_assemble_interface(NULL, egl_get_gl_proc);\r\n\t\td-\u003Egr_context = gr_direct_context_make_gl(gl_interface);\r\n\t}\r\n\r\n\tgr_direct_context_reset_context(d-\u003Egr_context, 0);\r\n\r\n\tif(width != d-\u003Eprev_width || height != d-\u003Eprev_height) {\r\n\t\tGLint framebuffer = 0;\r\n\t\tGLint stencil_bits = 0;\r\n\t\tGLint samples = 0;\r\n\t\tglGetIntegerv(GL_FRAMEBUFFER_BINDING, \u0026framebuffer);\r\n\t\tglGetFramebufferAttachmentParameteriv(GL_DRAW_FRAMEBUFFER, GL_STENCIL, GL_FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE, \u0026stencil_bits);\r\n\t\tglGetIntegerv(GL_SAMPLES, \u0026samples);\r\n\r\n\t\tprintf(\u0022GL_STENCIL_BITS: %d\\nhas_stencil_buffer: %d\\n\u0022, stencil_bits, gtk_gl_area_get_has_stencil_buffer(gl_area));\r\n\r\n\t\tif(d-\u003Esurface) {\r\n\t\t\tsk_surface_unref(d-\u003Esurface);\r\n\t\t\td-\u003Esurface = NULL;\r\n\t\t\td-\u003Ecanvas = NULL;\r\n\t\t}\r\n\r\n\t\tif(d-\u003Erender_target)\r\n\t\t\tgr_backendrendertarget_delete(d-\u003Erender_target);\r\n\r\n\t\tgr_gl_framebufferinfo_t gl_info = {.fFBOID = framebuffer, .fFormat = GL_RGBA8};\r\n\t\td-\u003Erender_target = gr_backendrendertarget_new_gl(width, height, samples, stencil_bits, \u0026gl_info);\r\n\t\td-\u003Esurface = sk_surface_new_backend_render_target((gr_recording_context_t *)d-\u003Egr_context, d-\u003Erender_target, BOTTOM_LEFT_GR_SURFACE_ORIGIN, RGBA_8888_SK_COLORTYPE, NULL, NULL);\r\n\t\td-\u003Ecanvas = sk_surface_get_canvas(d-\u003Esurface);\r\n\t}\r\n\r\n\tdraw(d-\u003Ecanvas);\r\n\t___GL_TRACE___(\u0022sk_canvas_flush(d-\u003Ecanvas);\u0022);\r\n\tsk_canvas_flush(d-\u003Ecanvas);\r\n\t___GL_TRACE___(\u0022gr_direct_context_flush(d-\u003Egr_context);\u0022);\r\n\tgr_direct_context_flush(d-\u003Egr_context);\r\n\r\n\td-\u003Eprev_width = width;\r\n\td-\u003Eprev_height = height;\r\n\r\n\t___GL_TRACE___(\u0022end of render()\u0022);\r\n\r\n\treturn true;\r\n}\r\n\r\ngboolean tick_callback(GtkWidget* widget, GdkFrameClock* frame_clock, gpointer user_data)\r\n{\r\n\tgtk_widget_queue_draw(widget);\r\n\treturn G_SOURCE_CONTINUE;\r\n}\r\n\r\nstatic void activate(GtkApplication *app, gpointer user_data)\r\n{\r\n\tGtkWidget *window;\r\n\tGtkWidget *gl_area;\r\n\twindow = gtk_application_window_new(app);\r\n\tgtk_window_set_title(GTK_WINDOW(window), \u0022GL Area\u0022);\r\n\tgl_area = gtk_gl_area_new();\r\n\t/* set a minimum size */\r\n\tgtk_widget_set_size_request(gl_area, 640, 400);\r\n\tgtk_window_set_child(GTK_WINDOW(window), gl_area);\r\n\tstruct render_data *render_data = calloc(1, sizeof(struct render_data));\r\n\tg_signal_connect(gl_area, \u0022render\u0022, G_CALLBACK(render), render_data);\r\n\tgtk_widget_add_tick_callback(gl_area, tick_callback, NULL, NULL); // if this is commented out, only one frame is rendered. that one frame is rendered correctly.\r\n\r\n\tgtk_window_present(GTK_WINDOW(window));\r\n}\r\nint main(int argc, char **argv)\r\n{\r\n\tGtkApplication *app;\r\n\tint status;\r\n\tapp = gtk_application_new(\u0022org.gtk.example\u0022, G_APPLICATION_DEFAULT_FLAGS);\r\n\tg_signal_connect(app, \u0022activate\u0022, G_CALLBACK(activate), NULL);\r\n\tstatus = g_application_run(G_APPLICATION(app), argc, argv);\r\n\tg_object_unref(app);\r\n\treturn status;\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2023-08-27T10:21:25",
        "reactions": []
      },
      {
        "id": 1694727716,
        "author": "mattleibow",
        "body": "You appear to be using an old version of skia, does this still happen with skia 88- the later stable version? ",
        "createdAt": "2023-08-27T18:05:51",
        "reactions": []
      },
      {
        "id": 1694759164,
        "author": "Mis012",
        "body": "I\u0027ve pushed https://gitlab.com/Mis012/gtk4-sk-area so that\u0027s probably more convenient to use for testing this than just the single C file that I apparently also had an incorrect include line in, it happens both with the \u0060skiasharp\u0060 branch (which is the default branch on github) and the lib packaged in https://globalcdn.nuget.org/packages/skiasharp.nativeassets.linux.2.88.5.nupkg which I used originally before deciding to compile my own in order to get debug symbols\r\n\r\na thing to note is that I seem to recall having a VERY similar problem with cairo at one point, but since clearly this issue is (or was) also reproducible on Windows, there shouldn\u0027t be any common denominator to explain that (also, my memory is pretty bad, so I wouldn\u0027t trust it *too* much)",
        "createdAt": "2023-08-27T20:49:58",
        "reactions": []
      },
      {
        "id": 1698114416,
        "author": "Mis012",
        "body": "so I just realized that gr_direct_context_reset_context should be called with 0xffffffff, that seems to fix the issue for me",
        "createdAt": "2023-08-29T20:53:32",
        "reactions": []
      }
    ]
  }
}