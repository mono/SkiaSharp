{
  "number": 2917,
  "type": "pr",
  "state": "closed",
  "title": "Function pointers and LibraryImport",
  "body": "**Description of Change**\r\n\r\nThis PR is pretty big. If necessary, I can split HarfBuzz and Skia changes on two PRs. In theory, generated code can be be extracted into a separated PR as well, since all changes should be under conditional compilation.\r\n\r\nWhat was changed step by step:\r\n- Generator was updated to emit LibraryImport instead of DllImport, when USE_LIBRARY_IMPORT is set.\r\n- Generator was updated to emit function pointers instead of managed delegates, when USE_LIBRARY_IMPORT is used.\r\n- Since function pointers can\u0027t be used as generics, every \u0060DelegateProxies.Create\u003CT\u003E\u0060 usage was replaced without generics.\r\n- Since Skia expects \u0060bool\u0060 as 1 byte, and function pointers by default marshal it as 4 bytes, I had to disable runtime marshalling. This change required to replace remaining DllImports with LibraryImport as well. As a bonus - final app size should be smaller without runtime marshalling (assuming other dependencies don\u0027t use it too).\r\n\r\nNote:\r\n- Due to older Mono bug, LibraryImport were defined with \u0060void*\u0060 instead of full function pointer, but it doesn\u0027t seem to cause other issues\r\n- Generated file diffs only have additions and no removals, tried to keep this way to keep less impact.\r\n- For HarfBuss I used 2.8.2 native baseline version, as it seems latest when it was regenerated (to keep diff smaller).\r\n- Tested on Windows and WASM (only .NET 9, but both Mono and LLVM). Will test on mobile and mac once there is any nightly build.\r\n\r\n**Bugs Fixed**\r\n\r\n- Fixes #2615\r\n- Fixes #2916 (only reproducible with function pointers)\r\n\r\nNot sure if this PR fixed them, or some another, but these two issues are not reproducible anymore:\r\n- Fixes #1928\r\n- Fixes #1931\r\n\r\n**API Changes**\r\n\r\nNone. Unless I missed any.\r\n\r\n**Behavioral Changes**\r\n\r\nNone. Hopefully.\r\n\r\n**Required skia PR**\r\n\r\nNone.\r\n\r\n**PR Checklist**\r\n\r\n- [ ] Has tests (if omitted, state reason in description)\r\n- [x] Rebased on top of main at time of PR\r\n- [ ] Merged related skia PRs\r\n- [x] Changes adhere to coding standard\r\n- [ ] Updated documentation\r\n",
  "author": {
    "login": "maxkatz6",
    "type": "User"
  },
  "labels": [
    {
      "name": "community \u2728",
      "color": "ededed"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-03T07:03:10",
  "updatedAt": "2024-08-21T15:17:05",
  "closedAt": "2024-08-21T15:16:05",
  "commentCount": 30,
  "reactionCount": 10,
  "draft": false,
  "merged": true,
  "mergedAt": "2024-08-21T15:16:05",
  "mergeableState": "unknown",
  "baseBranch": "main",
  "headBranch": "function-pointers-and-library-import",
  "additions": 7937,
  "deletions": 536,
  "changedFiles": 62,
  "commits": 30,
  "reviews": [
    {
      "author": "filipnavara",
      "state": "COMMENTED",
      "submittedAt": "2024-08-20T14:23:39"
    },
    {
      "author": "maxkatz6",
      "state": "COMMENTED",
      "submittedAt": "2024-08-20T18:53:09"
    },
    {
      "author": "mattleibow",
      "state": "COMMENTED",
      "submittedAt": "2024-08-21T05:04:19"
    },
    {
      "author": "filipnavara",
      "state": "COMMENTED",
      "submittedAt": "2024-08-21T06:55:45"
    }
  ],
  "engagement": {
    "syncedAt": "2026-02-06T12:51:55.208177Z",
    "reactions": [
      {
        "user": "angelofb",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081831Z"
      },
      {
        "user": "mattleibow",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081838Z"
      },
      {
        "user": "charlesroddie",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081839Z"
      },
      {
        "user": "ptasev",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.208184Z"
      },
      {
        "user": "inforithmics",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081842Z"
      },
      {
        "user": "hez2010",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081843Z"
      },
      {
        "user": "latop2604",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081844Z"
      },
      {
        "user": "ScrubN",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081845Z"
      },
      {
        "user": "FoggyFinder",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081846Z"
      },
      {
        "user": "myd7349",
        "content": "rocket",
        "createdAt": "2026-02-06T12:51:55.2081847Z"
      }
    ],
    "comments": [
      {
        "id": 2207122422,
        "author": "mattleibow",
        "body": "YES!",
        "createdAt": "2024-07-03T19:59:09",
        "reactions": [
          {
            "user": "angelofb",
            "content": "laugh",
            "createdAt": "2026-02-06T12:51:47.9004123Z"
          }
        ]
      },
      {
        "id": 2207125066,
        "author": "mattleibow",
        "body": "So far this:\r\n\r\n\u0060\u0060\u0060\r\nD:\\a\\1\\s\\binding\\SkiaSharp\\GRGlInterface.cs(216,83): error CA1420: Managed parameter or return types require runtime marshalling to be enabled (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/ca1420) [D:\\a\\1\\s\\binding\\SkiaSharp\\SkiaSharp.csproj::TargetFramework=net7.0-tizen]\r\nD:\\a\\1\\s\\binding\\SkiaSharp\\GRGlInterface.cs(234,11): error CA1421: \u0027System.Runtime.InteropServices.Marshal.PtrToStructure\u003CSkiaSharp.GRGlInterface.EvasGlApi\u003E(nint)\u0027 uses runtime marshalling even when \u0027DisableRuntimeMarshallingAttribute\u0027 is applied. Use features like \u0027sizeof\u0027 and pointers directly to ensure accurate results. (https://learn.microsoft.com/dotnet/fundamentals/code-analysis/quality-rules/ca1421) [D:\\a\\1\\s\\binding\\SkiaSharp\\SkiaSharp.csproj::TargetFramework=net7.0-tizen]\r\n\u0060\u0060\u0060",
        "createdAt": "2024-07-03T20:00:05",
        "reactions": []
      },
      {
        "id": 2207275965,
        "author": "mattleibow",
        "body": "The device failures are because all my certs just expired. The other test failures are the fact that the main branch is read and cannot pull assets. I have updated certs and re-triggered a full build.\r\n\r\nThe compile will still fail for windows I think, but the devices may run. Not 10% sure as I think there may be some bad conditionals somewhere causing the error.",
        "createdAt": "2024-07-03T20:57:53",
        "reactions": []
      },
      {
        "id": 2207289889,
        "author": "mattleibow",
        "body": "\u003E Will test on mobile and mac once there is any nightly build.\r\n \r\nThe device tests should be running for iOS, Android and macOS for .NET 7, so we shall see. I do need to add .NET 8 but I will do that once this is merged.",
        "createdAt": "2024-07-03T21:02:47",
        "reactions": []
      },
      {
        "id": 2207356609,
        "author": "mattleibow",
        "body": "New build here: https://dev.azure.com/xamarin/public/_build/results?buildId=118700\u0026view=results",
        "createdAt": "2024-07-03T21:39:02",
        "reactions": []
      },
      {
        "id": 2207400642,
        "author": "maxkatz6",
        "body": "\u003E So far this:\r\n\r\nThanks. Pushed another commit that should fix tizen build. EvasGlApi\u002Breflection probably could be replaced with a \u0060nint[]\u0060 array \u002B named dictionary over it, but that\u0027s something for another day.",
        "createdAt": "2024-07-03T22:18:27",
        "reactions": []
      },
      {
        "id": 2207419547,
        "author": "maxkatz6",
        "body": "Also updated remaining main interop projects for consistency: SkiaSharp.Resources, SkiaSharp.SceneGraph, SkiaSharp.Skottie. Didn\u0027t touch \u0060SkiaSharp.Views.**\u0060 projects, as these would require even more changes.",
        "createdAt": "2024-07-03T22:31:29",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:51:49.5782979Z"
          }
        ]
      },
      {
        "id": 2208088882,
        "author": "maxkatz6",
        "body": "@mattleibow tests are failing, but I am a bit confused why.\r\nFrom linux (and similar iOS) build tests, it fails on:\r\n\u0060\u0060\u0060\r\n  Error Message:\r\n   System.EntryPointNotFoundException : Unable to find an entry point named \u0027sk_rtree_factory_new\u0027 in shared library \u0027libSkiaSharp\u0027.\r\n  Stack Trace:\r\n     at SkiaSharp.SkiaApi.sk_rtree_factory_new()\r\n   at SkiaSharp.SKPictureRecorder.BeginRecording(SKRect cullRect, Boolean useRTree) in /home/vsts/work/1/s/binding/SkiaSharp/SKPictureRecorder.cs:line 43\r\n   at SkiaSharp.Tests.SKPictureRecorderTest.CanCreateDrawableFromRecorder(Boolean useRTree) in /home/vsts/work/1/s/tests/Tests/SkiaSharp/SKPictureRecorderTest.cs:line 60\r\n\u0060\u0060\u0060\r\n\r\nBut I tripple checked, and sk_rtree_factory_new is correctly defined in LibraryImport/DllImport, as well as referenced skia submodule has this method included. \r\nAm I missing something?",
        "createdAt": "2024-07-04T04:16:01",
        "reactions": []
      },
      {
        "id": 2208657911,
        "author": "mattleibow",
        "body": "as part of the build I check to see if the native things have changed and then download the previous native binaries. However, the last few builds on main never finished. I triggered them so should work now.\r\n\r\nLet me retry.",
        "createdAt": "2024-07-04T10:38:10",
        "reactions": []
      },
      {
        "id": 2219922015,
        "author": "maxkatz6",
        "body": "@mattleibow side question, but what frameworks does skia sharp still supports? Especially from Mono world.\r\nIt seems like net framework does support function pointers, if you provide UnmanagedCallersOnly polyfill. But I doubt old Xamarin/Mono will work this way, without MonoPInvokeCallback. It\u0027s still technically can be used via netstandard target of the lib.",
        "createdAt": "2024-07-10T08:46:07",
        "reactions": []
      },
      {
        "id": 2219933282,
        "author": "filipnavara",
        "body": "\u003E Xamarin/Mono\r\n\r\nThe old mono/mono (along with Xamarin.iOS/Xamarin.Android) went out of support earlier this year. I doubt there\u0027s any point in wasting more time on it. If someone uses the unsupported framework they can stick to older SkiaSharp release.",
        "createdAt": "2024-07-10T08:51:21",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:51:50.5841265Z"
          }
        ]
      },
      {
        "id": 2219950808,
        "author": "maxkatz6",
        "body": "Another problem is DisableRuntimeMarshalling, which also makes it easier to marshal bools in function pointers. Since DisableRuntimeMarshalling is not supported in .NET Framework, I don\u0027t think I can use function pointers without replacing all booleans with bytes or something.",
        "createdAt": "2024-07-10T09:00:14",
        "reactions": []
      },
      {
        "id": 2220001502,
        "author": "mattleibow",
        "body": "\u003E Another problem is DisableRuntimeMarshalling, which also makes it easier to marshal bools in function pointers. Since DisableRuntimeMarshalling is not supported in .NET Framework, I don\u0027t think I can use function pointers without replacing all booleans with bytes or something.\r\n\r\nWe can do this in the generator... I usually add a \u0060[MarshalAs (UnmanagedType.I1)]\u0060 to everything that is bool. Does that stop working with LibraryImport?\r\n\r\n\u0060\u0060\u0060cs\r\ninternal static extern sk_maskfilter_t sk_maskfilter_new_blur_with_flags (SKBlurStyle param0, Single sigma, [MarshalAs (UnmanagedType.I1)] bool respectCTM);\r\n\u0060\u0060\u0060",
        "createdAt": "2024-07-10T09:25:35",
        "reactions": []
      },
      {
        "id": 2220050328,
        "author": "mattleibow",
        "body": "\u003E @mattleibow side question, but what frameworks does skia sharp still supports? Especially from Mono world. It seems like net framework does support function pointers, if you provide UnmanagedCallersOnly polyfill. But I doubt old Xamarin/Mono will work this way, without MonoPInvokeCallback. It\u0027s still technically can be used via netstandard target of the lib.\r\n\r\nYou can see from the root package: https://www.nuget.org/packages/SkiaSharp/3.0.0-preview.3.1#supportedframeworks-body-tab\r\n\r\nAnd this PR is going to bump the SDK to net8 things: https://github.com/mono/SkiaSharp/pull/2927\r\n\r\nBasically, whatever you can build with the .NET 8 SDK:\r\n\r\n* \u0060net6.0\u0060 for console/server apps (since that is still supported by MS)\r\n* \u0060net8.0\u0060 for console/server apps\r\n* \u0060net8.0-\u003Cplatform\u003E\u0060 for desktop/mobile\r\n* \u0060netstandard2.0\u0060 (just for MSBuild tasks because VS is still using full framework)\r\n* \u0060net462\u0060 (literally just to appease VS build tasks like resizetizer)\r\n\r\nIn summary, just net8.0 and the basics of net6.0 because that is still LTS. Then also netstandard and netfx because we have to use VS.\r\n\r\nIf we have to do bad and slow things for netstandard and netfx then we can. If you want perf, then you want a real modern framework. For me full framework is _just_ because the IDE is still on that and most machines running VS are more powerful so we can go slow paths. I support no fancy things like AOT/linking/anything with netfx at all and if we break some corner case with some corner thing, then we can.",
        "createdAt": "2024-07-10T09:49:34",
        "reactions": [
          {
            "user": "maxkatz6",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:51:51.3036139Z"
          }
        ]
      },
      {
        "id": 2220079394,
        "author": "maxkatz6",
        "body": "\u003E  I usually add a [MarshalAs (UnmanagedType.I1)] to everything that is bool. \r\n\r\nI don\u0027t think it\u0027s possible to add an attribute on a function pointer argument.",
        "createdAt": "2024-07-10T10:04:03",
        "reactions": []
      },
      {
        "id": 2220118981,
        "author": "mattleibow",
        "body": "This works (builds at least):\r\n\r\n\u0060\u0060\u0060cs\r\n[LibraryImport (\u0022test\u0022)]\r\n[UnmanagedCallersOnly(CallConvs = new [] {typeof(CallConvCdecl)})]\r\ninternal static partial nint test_method (nint a, [MarshalAs (UnmanagedType.I1)] bool b);\r\n\r\npublic static readonly delegate* unmanaged[Cdecl] \u003Cnint, bool, nint\u003E Proxy = \u0026Testing;\r\n\r\n[UnmanagedCallersOnly(CallConvs = new [] {typeof(CallConvCdecl)})]\r\ninternal static nint Testing (nint a, [MarshalAs (UnmanagedType.I1)] bool b)\r\n{\r\n    return 0;\r\n}\r\n\u0060\u0060\u0060\r\n\r\nGenerated code:\r\n\r\n\u0060\u0060\u0060cs\r\npublic unsafe static readonly global::System.UIntPtr/*delegate* unmanaged[Cdecl]\u003Cglobal::System.IntPtr, bool, global::System.IntPtr\u003E*/ Proxy = (global::System.UIntPtr/*delegate* unmanaged[Cdecl]\u003Cglobal::System.IntPtr, bool, global::System.IntPtr\u003E*/)(void*)(ulong)(global::System.UIntPtr/*delegate*\u003Cglobal::System.IntPtr, bool, global::System.IntPtr\u003E*/)(\u0026Testing);\r\n\r\n[LibraryImport(\u0022test\u0022)]\r\n[UnmanagedCallersOnly(CallConvs = new global::System.Type[] { typeof(CallConvCdecl) })]\r\n[GeneratedCode(\u0022Microsoft.Interop.LibraryImportGenerator\u0022, \u00229.0.10.30607\u0022)]\r\n[SkipLocalsInit]\r\ninternal static global::System.IntPtr test_method(global::System.IntPtr a, [MarshalAs(3)] bool b)\r\n{\r\n    sbyte __b_native2 = (sbyte)(b ? 1 : 0);\r\n    return __PInvoke(a, __b_native2);\r\n    [DllImport(\u0022test\u0022, EntryPoint = \u0022test_method\u0022, ExactSpelling = true)]\r\n    [CompilerGenerated]\r\n    static extern global::System.IntPtr __PInvoke(global::System.IntPtr __a_native, sbyte __b_native);\r\n}\r\n\r\n[UnmanagedCallersOnly(CallConvs = new global::System.Type[] { typeof(CallConvCdecl) })]\r\ninternal static global::System.IntPtr Testing(global::System.IntPtr a, [MarshalAs(3)] bool b)\r\n{\r\n    return (global::System.IntPtr)0;\r\n}\r\n\u0060\u0060\u0060\r\n\r\nIt nicely does bools and bytes for us :) Very cool if I say so myself!",
        "createdAt": "2024-07-10T10:22:50",
        "reactions": []
      },
      {
        "id": 2234394492,
        "author": "maxkatz6",
        "body": "@mattleibow I was wrong with UnmanagedCallersOnly being possible to polyfill on net framework. It doesn\u0027t seem to be guaranteed to work on all - https://github.com/AvaloniaUI/Avalonia/pull/16295#discussion_r1676800518. Also confirmed by runtime team.\r\nOld delegates have to stay, I guess.",
        "createdAt": "2024-07-17T21:59:11",
        "reactions": []
      },
      {
        "id": 2237455592,
        "author": "mattleibow",
        "body": "I wonder if there is a source generator we could write/use to convert the \u0060UnmanagedCallersOnly\u0060 into the old way? Then the code we type is the same, but at compile time we get the old things... Do source generators work for the old netfx tfms?",
        "createdAt": "2024-07-18T19:55:10",
        "reactions": []
      },
      {
        "id": 2237739325,
        "author": "maxkatz6",
        "body": "@mattleibow it should be possible to write a source generator (instead of current tool) that will find methods with a custom attribute:\r\n\u0060\u0060\u0060csharp\r\n[PInvokeCallback]\r\ninternal static partial void ReleaseDelegateProxyImplementation (void* context)\r\n{\r\n}\r\n\r\n// and later\r\nvar callback = DelegateProxies.ReleaseDelegateProxy; // ReleaseDelegateProxy is fully generated with a correct type\r\n\u0060\u0060\u0060\r\n\r\nand generate:\r\n\u0060\u0060\u0060csharp\r\n#if NET7_0_OR_GREATER\r\n\r\npublic static readonly delegate* unmanaged[Cdecl] \u003Cvoid*, void\u003E ReleaseDelegateProxy = \u0026ReleaseDelegateProxyImplementation;\r\n[UnmanagedCallersOnly(CallConvs = new [] {typeof(CallConvCdecl)})]\r\ninternal static partial void ReleaseDelegateProxyImplementation();\r\n\r\n#else\r\n\r\npublic static readonly DestroyProxyDelegate ReleaseDelegateProxy = ReleaseDelegateProxyImplementation;\r\n[MonoPInvokeCallback (typeof (DestroyProxyDelegate))]\r\ninternal static partial void ReleaseDelegateProxyImplementation();\r\n\r\n#endif\r\n\u0060\u0060\u0060",
        "createdAt": "2024-07-18T22:41:30",
        "reactions": []
      },
      {
        "id": 2237740109,
        "author": "maxkatz6",
        "body": "Or, since you already know ahead all the callbacks, can avoid an extra attribute with source generators, and just generate these proxy headers with current tool. ",
        "createdAt": "2024-07-18T22:42:35",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-06T12:51:52.7297622Z"
          }
        ]
      },
      {
        "id": 2237740933,
        "author": "maxkatz6",
        "body": "Either way it should work with netframework, since it\u0027s just a source code generation, nothing different in runtime.",
        "createdAt": "2024-07-18T22:43:33",
        "reactions": []
      },
      {
        "id": 2237828348,
        "author": "maxkatz6",
        "body": "@mattleibow just pushed a commit moving all the #if #else from DelegateProxy files to auto generated code. I reused the same generator tool for now just by extending it.\r\n\r\nThis way almost all the boilerplate is hidden behind generated code.",
        "createdAt": "2024-07-19T01:00:05",
        "reactions": []
      },
      {
        "id": 2237952994,
        "author": "mattleibow",
        "body": "Yeah, much smarter... Writing a source generator to generate source for generated sources... At this point am I thinking like AI. ",
        "createdAt": "2024-07-19T02:35:37",
        "reactions": []
      },
      {
        "id": 2292423976,
        "author": "maxkatz6",
        "body": "@mattleibow hi!\r\nChecked CI build and found two problems with tests:\r\n1. I used \u0060protected internal\u0060 in methods used by delegate proxies. It doesn\u0027t affect library consumers as per [protected internal (C# Reference)](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/protected-internal#overriding-protected-internal-members) (If the derived class is defined in a different assembly from the base class, overridden members have protected access. - which is exactly how it worked before this PR). But since Tests projects has InternalsVisibleTo configured, it also has to use \u0060protected internal\u0060.\r\n2. There were two tests asserting generated managed delegates. Since these managed delegates are not generated anymore in .NET7\u002B builds, I disabled them. .NET Framework tests still check for them.\r\n\r\nHopefully CI should pass now.\r\nDo you think anything else needs to be done for this PR?",
        "createdAt": "2024-08-15T22:57:45",
        "reactions": []
      },
      {
        "id": 2298784576,
        "author": "mattleibow",
        "body": "After _much_ thrashing on CI just to get a green main branch, I see we now have some failing tests that are related to this PR.\r\n\r\nhttps://dev.azure.com/xamarin/public/_build/results?buildId=121990\u0026view=ms.vss-test-web.build-test-results-tab\r\n\r\nI think it is just these 2 really: \r\n![image](https://github.com/user-attachments/assets/4476a48d-3280-45c4-8528-ceb88f5d2d86)\r\n\r\n\r\nThe first one is interesting be cause it can\u0027t find \u0060LoadLibrary\u0060. I see it is actually \u0060LoadLibraryA\u0060: https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya Not sure if the new attributes require special treatment of this? I see the old way had \u0060CharSet = CharSet.Ansi\u0060. Is there an equivalent to this with the new things:\r\n\r\n\u003E Use this field with a member of the [CharSet](https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.charset?view=net-8.0) enumeration to specify the marshaling behavior of string parameters and to specify which entry-point name to invoke (the exact name given or a name ending with \u0022A\u0022 or \u0022W\u0022).\r\n\r\nThe second failure is probably because you are skipping the tests in the .Console project but it also needs to be in the .Devices project.",
        "createdAt": "2024-08-20T12:50:56",
        "reactions": []
      },
      {
        "id": 2298924121,
        "author": "mattleibow",
        "body": "@maxkatz6 I think this PR is good, just the 2 failures. One is a missing condition/define in the .Devices project and then the other is the auto-naming of p/invokes based on Charset that I am not sure has a direct parallel, but maybe setting the string marshalling or just using the \u0060EntryPoint\u0060 property on the attribute?",
        "createdAt": "2024-08-20T13:54:42",
        "reactions": []
      },
      {
        "id": 2298981884,
        "author": "filipnavara",
        "body": "\u003E The first one is interesting be cause it can\u0027t find \u0060LoadLibrary\u0060. I see it is actually \u0060LoadLibraryA\u0060: https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya Not sure if the new attributes require special treatment of this? I see the old way had \u0060CharSet = CharSet.Ansi\u0060.\r\n\r\nThe distinction of \u0060A\u0060/\u0060W\u0060-suffixed APIs has not been relevant for a long while. All supported Windows versions have \u0060LoadLibraryW\u0060 Unicode API and it should be used, if necessary by specifying \u0060Entrypoint = \u0022LoadLibraryW\u0022, StringMarshalling = StringMarshalling.Utf16\u0060 in the \u0060LibraryImport\u0060 attribute. (\u0060LoadLibraryA\u0060 is legacy API dating back to Windows 9x era.)\r\n\r\nModern .NET has [NativeLibrary.Load](https://learn.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.nativelibrary.load?view=net-8.0) but I guess that may not be applicable here if the tests still run on .NET Framework.",
        "createdAt": "2024-08-20T14:19:16",
        "reactions": []
      },
      {
        "id": 2299163765,
        "author": "mattleibow",
        "body": "I need to check that these new things are not slower: https://github.com/dotnet/runtime/issues/106491\r\n\r\nMight be unrelated, but might be related to usage of new things. Has anyone done any perf benchmarks on any platforms? \r\n\r\nI will try set up something, but if anyone has a complex app that draws a bunch of things it would be great if you ran a check and got a speedscope: https://github.com/dotnet/maui/wiki/Profiling-.NET-MAUI-Apps\r\n\r\nI suppose a test would be:\r\n\r\n* Release\r\n* Debug (maybe)\r\n* Debug with Interpreter",
        "createdAt": "2024-08-20T15:39:59",
        "reactions": []
      },
      {
        "id": 2299553872,
        "author": "maxkatz6",
        "body": "@mattleibow both tests should be fixed now.\r\n\r\nI can run our control catalog on my iOS device later this week.",
        "createdAt": "2024-08-20T18:59:19",
        "reactions": []
      },
      {
        "id": 2302345271,
        "author": "mattleibow",
        "body": "Woohoo! This is finally green and finally good to go. Merged and now time for that \u003Cbeverage of choice\u003E! \r\n\r\nThanks so much for this! This has been on the list since net7.0 started doing cool things.",
        "createdAt": "2024-08-21T15:17:04",
        "reactions": [
          {
            "user": "yowl",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.157893Z"
          },
          {
            "user": "SingleAccretion",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578936Z"
          },
          {
            "user": "filipnavara",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578936Z"
          },
          {
            "user": "charlesroddie",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578937Z"
          },
          {
            "user": "snickler",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578938Z"
          },
          {
            "user": "maxkatz6",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578938Z"
          },
          {
            "user": "latop2604",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.1578939Z"
          },
          {
            "user": "antonheryanto",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.157894Z"
          },
          {
            "user": "ScrubN",
            "content": "heart",
            "createdAt": "2026-02-06T12:51:55.157894Z"
          }
        ]
      }
    ]
  }
}