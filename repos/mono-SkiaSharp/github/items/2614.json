{
  "number": 2614,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] wasm-ld : error : --shared-memory is disallowed by libskia.SkOpts.o because it was not compiled with \u0027atomics\u0027 or \u0027bulk-memory\u0027 features.",
  "body": "### Description\r\n\r\nHey! Im trying to use SkiaSharp in combination with \u0060\u003CWasmEnableThreads\u003Etrue\u003C/WasmEnableThreads\u003E\u0060, but I get the following error(s):\r\n\u0060\u0060\u0060\r\nwasm-ld : error : --shared-memory is disallowed by libskia.SkOpts.o because it was not compiled with \u0027atomics\u0027 or \u0027bulk-memory\u0027 features.\r\nwasm-ld : error : \u003C....\u003E/obj/Debug/net8.0/wasm/for-build/pinvoke.o: undefined symbol: InterceptGLObject\r\n...\r\n\u0060\u0060\u0060\r\n\r\nI do get the \u0060-msimd128\u0060 flag passed way down the end though. \r\n\r\n\r\nIt seems like a similar issue has been solved previously (https://github.com/mono/SkiaSharp/pull/2286), although I have not been able to get it working either on net7 \u002B 2.88.4 or on the latest net8 RC1 and 2.88.6-preview, so Im not sure this is a regression. As it seems like others are also still running into this I\u0027m guessing this never worked completely in the first place? Is there some flag I need to pass in \u0060\u003CEmccExtraCFlags\u003E\u0060 or \u0060\u003CEmccExtraLDFlags\u003E\u0060?\r\n\r\nMy IDE is Rider.\r\n\r\n### Code\r\n\r\n\u0060\u0060\u0060xaml\r\n\u003CProject Sdk=\u0022Microsoft.NET.Sdk.BlazorWebAssembly\u0022\u003E\r\n\r\n  \u003CPropertyGroup\u003E\r\n    \u003CTargetFramework\u003Enet8.0\u003C/TargetFramework\u003E\r\n    \u003CNullable\u003Eenable\u003C/Nullable\u003E\r\n    \u003CImplicitUsings\u003Eenable\u003C/ImplicitUsings\u003E\r\n    \u003CWasmBuildNative\u003Etrue\u003C/WasmBuildNative\u003E\r\n    \u003CRunAOTCompilation\u003Etrue\u003C/RunAOTCompilation\u003E\r\n    \u003CWasmEnableThreads\u003Etrue\u003C/WasmEnableThreads\u003E\r\n  \u003C/PropertyGroup\u003E\r\n\r\n  \u003CItemGroup\u003E\r\n    \u003CPackageReference Include=\u0022Microsoft.AspNetCore.Components.WebAssembly\u0022 Version=\u00228.0.0-rc.1.23421.29\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022Microsoft.AspNetCore.Components.WebAssembly.DevServer\u0022 Version=\u00228.0.0-rc.1.23421.29\u0022 PrivateAssets=\u0022all\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022Microsoft.NET.WebAssembly.Threading\u0022 Version=\u00228.0.0-rc.1.23419.4\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.WebAssembly\u0022 Version=\u00222.88.6-preview.1.2\u0022 /\u003E\r\n    \u003CPackageReference Include=\u0022SkiaSharp.Views.Blazor\u0022 Version=\u00222.88.6-preview.1.2\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\r\n  \u003CItemGroup\u003E\r\n    \u003CProjectReference Include=\u0022..\\Shared\\Project.Shared.csproj\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\r\n\u003C/Project\u003E\r\n\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Expected Behavior\r\n\r\n_No response_\r\n\r\n### Actual Behavior\r\n\r\n_No response_\r\n\r\n### Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### IDE / Editor\r\n\r\nOther (Please indicate in the description)\r\n\r\n### Platform / Operating System\r\n\r\nmacOS\r\n\r\n### Platform / Operating System Version\r\n\r\n_No response_\r\n\r\n### Devices\r\n\r\n_No response_\r\n\r\n### Relevant Screenshots\r\n\r\n_No response_\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "Maxxen",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "area/SkiaSharp.Views.Blazor",
      "color": "0052cc"
    }
  ],
  "assignees": [],
  "createdAt": "2023-09-18T18:30:25",
  "updatedAt": "2024-10-28T11:48:40",
  "closedAt": "2024-10-28T11:48:40",
  "commentCount": 5,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:50:17.1768208Z",
    "reactions": [],
    "comments": [
      {
        "id": 1724439814,
        "author": "mattleibow",
        "body": "Thanks for reporting this. I believe it is because we are including the wrong build of libSkiaSharp in your multi-threading blazor app.\r\n\r\nI have some PRs to fix it, but for now, adding this to the csproj will/should fix it. I just typed this, so let me know:\r\n\r\n\u0060\u0060\u0060xml\r\n\u003CItemGroup\u003E\r\n  \u003C!-- remove all previous native files --\u003E\r\n  \u003CNativeFileReference Remove=\u0022@(SkiaSharpStaticLibrary)\u0022 /\u003E\r\n  \u003C!-- include the multi-threaded build if WasmEnableThreads=true --\u003E\r\n  \u003CNativeFileReference Include=\u0022$(SkiaSharpStaticLibraryPath)\\3.1.34\\mt\\*.a\u0022 Condition=\u0022\u0027$(WasmEnableThreads)\u0027 == \u0027True\u0027\u0022 /\u003E\r\n  \u003C!-- otherwise use the single threaded build --\u003E\r\n  \u003CNativeFileReference Include=\u0022$(SkiaSharpStaticLibraryPath)\\3.1.34\\st\\*.a\u0022 Condition=\u0022\u0027$(WasmEnableThreads)\u0027 != \u0027True\u0027\u0022 /\u003E\r\n\u003C/ItemGroup\u003E\r\n\u0060\u0060\u0060",
        "createdAt": "2023-09-18T21:14:09",
        "reactions": []
      },
      {
        "id": 1724498755,
        "author": "Maxxen",
        "body": "Thanks for the quick reply!\r\nThe workaround you posted seems to work - it compiles at least, so I\u0027m guessing its all good!\r\n\r\nAlso just want to say thanks for all the work you guys are doing on this, I\u0027ve tried to work with SKIA natively previously so I have a lot of respect for anybody capable to deal with it efficiently and Im super stoked for all the possibilities this enables. Kudos!",
        "createdAt": "2023-09-18T21:44:23",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "heart",
            "createdAt": "2026-02-06T12:50:16.5555736Z"
          },
          {
            "user": "jeromelaban",
            "content": "heart",
            "createdAt": "2026-02-06T12:50:16.5555739Z"
          }
        ]
      },
      {
        "id": 1732074877,
        "author": "ghost",
        "body": "This issue has been automatically marked as stale because it has been marked as requiring author feedback but has not had any activity for **4 days**. It will be closed if no further activity occurs **within 3 days of this comment**. If it *is* closed, feel free to comment when you are able to provide the additional information and we will re-investigate.",
        "createdAt": "2023-09-22T22:00:28",
        "reactions": []
      },
      {
        "id": 1973756049,
        "author": "mattleibow",
        "body": "How are you currently running things? I have a new project and added:\r\n\r\n\u0060\u0060\u0060xml\r\n\u003CWasmEnableThreads\u003Etrue\u003C/WasmEnableThreads\u003E\r\n\u003CWasmBuildNative\u003Etrue\u003C/WasmBuildNative\u003E\r\n\u0060\u0060\u0060\r\n\r\nBut I am getting errors:\r\n\r\n\u003E MONO_WASM: Assert failed: Expect to have one js-module-threads asset in resources\r\n",
        "createdAt": "2024-03-01T18:59:31",
        "reactions": []
      },
      {
        "id": 1973902172,
        "author": "mattleibow",
        "body": "Seems that most of this does not work in .NET 8 Blazor, and things are coming to .NET 9. I will fix this so we are ready for net9.0",
        "createdAt": "2024-03-01T20:51:35",
        "reactions": []
      }
    ]
  }
}