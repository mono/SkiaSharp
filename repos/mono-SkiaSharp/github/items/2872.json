{
  "number": 2872,
  "type": "issue",
  "state": "open",
  "title": "[BUG] SKGLElement on multiple threads",
  "body": "### Description\r\n\r\nUsing the new SKGLElement in SkiaSharp, I get an access violation at the following location in GLWPFControl when I try create an additional SKGLElement on a new Thread:\r\n\r\n\u0060\u0060\u0060csharp\r\n\tpublic unsafe static IntPtr DXRegisterObjectNV(IntPtr hDevice, IntPtr dxObject, uint name, uint type, WGL_NV_DX_interop access)\r\n\t{\r\n\t\treturn ((delegate* unmanaged[Stdcall]\u003CIntPtr, IntPtr, uint, uint, WGL_NV_DX_interop, IntPtr\u003E)EntryPoints[21])(hDevice, dxObject, name, type, access);\r\n\t}\r\n\u0060\u0060\u0060\r\n\r\n### Code\r\n\r\n\u0060\u0060\u0060csharp\r\n                var t = new Thread(() =\u003E\r\n                {\r\n                    var form = new MainWindow(); // Main Window has an SKGLElement defined in XAML\r\n                    form.Show();\r\n                    // Start the Dispatcher loop\r\n                    System.Windows.Threading.Dispatcher.Run();\r\n                });\r\n                t.SetApartmentState(ApartmentState.STA);\r\n                t.Start();\r\n\u0060\u0060\u0060\r\n\r\n### Expected Behavior\r\n\r\nAbility to create multiple controls (across multiple threads) in application like in SkiaSharp.Views.WindowsForms\r\n\r\n### Actual Behavior\r\n\r\nUnable to do this\r\n\r\n### Version of SkiaSharp\r\n\r\n3.x (Alpha)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nWindows\r\n\r\n### Platform / Operating System Version\r\n\r\nWindows 11 23H2 64 bit\r\n\r\n### Devices\r\n\r\n_No response_\r\n\r\n### Relevant Screenshots\r\n\r\n_No response_\r\n\r\n### Relevant Log Output\r\n\r\n\u0060\u0060\u0060shell\r\nCall stack:\r\n\r\n\r\n \t[Managed to Native Transition]\t\r\n\u003E\tOpenTK.Graphics.dll!OpenTK.Graphics.Wgl.Wgl.DXRegisterObjectNV(nint hDevice, nint dxObject, uint name, uint type, OpenTK.Platform.Windows.WGL_NV_DX_interop access) Line 533\tC#\r\n \tGLWpfControl.dll!OpenTK.Wpf.DxGLFramebuffer.DxGLFramebuffer(OpenTK.Wpf.DxGlContext context, int width, int height, double dpiScaleX, double dpiScaleY, OpenTK.Wpf.Interop.Format format)\tUnknown\r\n \tGLWpfControl.dll!OpenTK.Wpf.GLWpfControlRenderer.SetSize(int width, int height, double dpiScaleX, double dpiScaleY, OpenTK.Wpf.Interop.Format format)\tUnknown\r\n \tGLWpfControl.dll!OpenTK.Wpf.GLWpfControl.SetupRenderSize()\tUnknown\r\n \tGLWpfControl.dll!OpenTK.Wpf.GLWpfControl.OnRender(System.Windows.Media.DrawingContext drawingContext)\tUnknown\r\n \txxxxxx.dll!SkiaSharp.Views.WPF.SKGLElement.OnRender(System.Windows.Media.DrawingContext drawingContext)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!MS.Internal.Helper.ArrangeElementWithSingleChild(System.Windows.UIElement element, System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Border.ArrangeOverride(System.Windows.Size finalSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Control.ArrangeOverride(System.Windows.Size arrangeBounds)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!MS.Internal.Helper.ArrangeElementWithSingleChild(System.Windows.UIElement element, System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!MS.Internal.Helper.ArrangeElementWithSingleChild(System.Windows.UIElement element, System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Border.ArrangeOverride(System.Windows.Size finalSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Control.ArrangeOverride(System.Windows.Size arrangeBounds)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Border.ArrangeOverride(System.Windows.Size finalSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Control.ArrangeOverride(System.Windows.Size arrangeBounds)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!MS.Internal.Helper.ArrangeElementWithSingleChild(System.Windows.UIElement element, System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!MS.Internal.Helper.ArrangeElementWithSingleChild(System.Windows.UIElement element, System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Decorator.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Documents.AdornerDecorator.ArrangeOverride(System.Windows.Size finalSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Control.ArrangeOverride(System.Windows.Size arrangeBounds)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Decorator.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Documents.AdornerDecorator.ArrangeOverride(System.Windows.Size finalSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Controls.Grid.ArrangeOverride(System.Windows.Size arrangeSize)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.ArrangeOverride(System.Windows.Size arrangeBounds)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.FrameworkElement.ArrangeCore(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.UIElement.Arrange(System.Windows.Rect finalRect)\tUnknown\r\n \tPresentationCore.dll!System.Windows.Interop.HwndSource.SetLayoutSize()\tUnknown\r\n \tPresentationCore.dll!System.Windows.Interop.HwndSource.RootVisualInternal.set(System.Windows.Media.Visual value)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.SetRootVisualAndUpdateSTC()\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.SetupInitialState(double requestedTop, double requestedLeft, double requestedWidth, double requestedHeight)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.CreateSourceWindow(bool duringShow)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.ShowHelper(object booleanBox)\tUnknown\r\n \tPresentationFramework.dll!System.Windows.Window.Show()\tUnknown\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "ghost",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-05-27T17:59:05",
  "updatedAt": "2024-05-27T18:26:41",
  "commentCount": 3,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T12:54:09.918205Z",
    "reactions": [],
    "comments": [
      {
        "id": 2133890559,
        "author": "ghost",
        "body": "Not sure if related to https://github.com/opentk/GLWpfControl/issues/58",
        "createdAt": "2024-05-27T18:00:03",
        "reactions": []
      },
      {
        "id": 2133905460,
        "author": "NogginBops",
        "body": "Currently creating GLWPFControls on separate threads is likely not going to work as GLWPFControl is using a static shared OpenGL context which can only be current on one thread. This is a problem when creating controls from another thread as this will call functions that need to access the opengl context, but this context is not going to be current on the separate thread.\r\n\r\nThere might be some ways around this, I\u0027ve been slowly refactoring the GLWPFControl code to avoid some of these types of issues (more explicit handling of contexts), but I\u0027ve not finished that work, not sure when I\u0027ll have time to.",
        "createdAt": "2024-05-27T18:15:52",
        "reactions": []
      },
      {
        "id": 2133914815,
        "author": "ghost",
        "body": "\u003E Currently creating GLWPFControls on separate threads is likely not going to work as GLWPFControl is using a static shared OpenGL context which can only be current on one thread. This is a problem when creating controls from another thread as this will call functions that need to access the opengl context, but this context is not going to be current on the separate thread.\r\n\u003E \r\n\u003E There might be some ways around this, I\u0027ve been slowly refactoring the GLWPFControl code to avoid some of these types of issues (more explicit handling of contexts), but I\u0027ve not finished that work, not sure when I\u0027ll have time to.\r\n\r\nThanks for the quick response! I am going to hold off on my Winforms -\u003E WPF rewrite for the time being in that case... :grin:",
        "createdAt": "2024-05-27T18:26:40",
        "reactions": []
      }
    ]
  }
}