{
  "number": 1220,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Multithreaded Crash with SKShaper and SKTypeFace",
  "body": "**Description**\r\n\r\nWell, it may not necessarily be SKShaper related, but it\u0027s how I can make it happen. I can reproduce it by adding the below unit test code to the SKShaperTest class. Importantly, the typeface class has completely lost its Handle value! It\u0027ll do it whether I wrap the typeface in a using block or not. I think something is prematurely disposing and eliminating typefaces that might still be in play? Sometimes the unit test will complete, so be patient and try it a few times. In debug mode I had to remove the THROW_OBJECT_EXCEPTIONS compile flag to catch it.\r\n\r\nIt didn\u0027t happen with 1.68.0, but it\u0027s definitely happening with 1.68.1.1.\r\n\r\nSame code will reproduce it via a .NET Core Console app too. Started with that but figured I\u0027d get a little more info with the extra debug info from the test project instead of it killing the process outright.\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\n[SkippableFact]\r\n\t\tpublic void TestMultiThreadCrash()\r\n\t\t{\r\n\t\t\tconst int count = 20000;\r\n\t\t\tvar threads = new List\u003CThread\u003E();\r\n\r\n\t\t\tfor (var i = 0; i \u003C count; i\u002B\u002B)\r\n\t\t\t{\r\n\t\t\t\tvar t = new Thread(new ParameterizedThreadStart(Work));\r\n\t\t\t\tt.TrySetApartmentState(Thread.CurrentThread.GetApartmentState());\r\n\t\t\t\tt.Name = i.ToString();\r\n\t\t\t\tt.Start(i);\r\n\t\t\t\tthreads.Add(t);\r\n\t\t\t}\r\n\t\t\tfor (var i = 0; i \u003C count; i\u002B\u002B)\r\n\t\t\t{\r\n\t\t\t\tthreads[i].Join();\r\n\t\t\t}\r\n\t\t}\r\n\t\tprivate void Work(object state)\r\n\t\t{\r\n\t\t\tvar text = $\u0022Some wonderful text goes here {state}.\u0022;\r\n\t\t\tvar typeface = SkiaSharp.SKTypeface.FromFamilyName(\u0022Arial\u0022, SkiaSharp.SKFontStyle.Bold);\r\n\t\t\t//using (var typeface = SkiaSharp.SKTypeface.FromFamilyName(\u0022Arial\u0022, SkiaSharp.SKFontStyle.Bold))\r\n\t\t\t//{\r\n\t\t\tSkiaSharp.HarfBuzz.SKShaper.Result result;\r\n\r\n\t\t\tusing (var paint = new SkiaSharp.SKPaint())\r\n\t\t\t{\r\n\r\n\t\t\t\tusing (var shaper = new SkiaSharp.HarfBuzz.SKShaper(typeface))\r\n\t\t\t\t{\r\n\t\t\t\t\tresult = shaper.Shape(text, 75, 75, paint);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar imageInfo = new SkiaSharp.SKImageInfo(128, 128);\r\n\t\t\t\tusing (var bitmap = new SkiaSharp.SKBitmap(imageInfo))\r\n\t\t\t\tusing (var canvas = new SkiaSharp.SKCanvas(bitmap))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar bytes = result.Codepoints.Select(cp =\u003E BitConverter.GetBytes((ushort)cp)).SelectMany(b =\u003E b).ToArray();\r\n\t\t\t\t\tpaint.TextEncoding = SkiaSharp.SKTextEncoding.GlyphId;\r\n\t\t\t\t\tcanvas.DrawPositionedText(bytes, result.Points, paint);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//}\r\n\t\t}\r\n\u0060\u0060\u0060\r\n\r\nAs console app:\r\n\r\n\u0060\u0060\u0060\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Threading;\r\n\r\nnamespace ConsoleApp {\r\n\tclass Program {\r\n\r\n\t\tstatic void Main(string[] args) {\r\n\r\n\t\t\tConsole.WriteLine($\u0022IntPtr size: {IntPtr.Size}\u0022);\r\n\r\n\t\t\tconst int count = 100;\r\n\t\t\tvar threads = new List\u003CThread\u003E();\r\n\r\n\t\t\tfor (var i = 0; i \u003C count; i\u002B\u002B) {\r\n\t\t\t\tvar t = new Thread(new ParameterizedThreadStart(Work));\r\n\t\t\t\tt.TrySetApartmentState(ApartmentState.MTA);\r\n\t\t\t\tt.Name = i.ToString();\r\n\t\t\t\tt.Start(i);\r\n\t\t\t\tthreads.Add(t);\r\n\t\t\t}\r\n\t\t\tfor (var i = 0; i \u003C count; i\u002B\u002B) {\r\n\t\t\t\tthreads[i].Join();\r\n\t\t\t}\r\n\t\t\tConsole.WriteLine(\u0022Done.\u0022);\r\n\t\t}\r\n\r\n\t\tprivate static void Work(object state) {\r\n\t\t\tvar text = $\u0022Some wonderful text goes here {state}.\u0022;\r\n\t\t\tvar typeface = SkiaSharp.SKTypeface.FromFamilyName(\u0022Arial\u0022, SkiaSharp.SKFontStyle.Bold);\r\n\t\t\tSkiaSharp.HarfBuzz.SKShaper.Result result;\r\n\r\n\t\t\tusing var paint = new SkiaSharp.SKPaint();\r\n\r\n\t\t\tusing (var shaper = new SkiaSharp.HarfBuzz.SKShaper(typeface)) {\r\n\t\t\t\tresult = shaper.Shape(text, 75, 75, paint);\r\n\t\t\t}\r\n\r\n\t\t\tvar imageInfo = new SkiaSharp.SKImageInfo(128, 128);\r\n\t\t\tusing var bitmap = new SkiaSharp.SKBitmap(imageInfo);\r\n\t\t\tusing var canvas = new SkiaSharp.SKCanvas(bitmap);\r\n\r\n\t\t\tvar bytes = result.Codepoints.Select(cp =\u003E BitConverter.GetBytes((ushort)cp)).SelectMany(b =\u003E b).ToArray();\r\n\t\t\tpaint.TextEncoding = SkiaSharp.SKTextEncoding.GlyphId;\r\n\t\t\tcanvas.DrawPositionedText(bytes, result.Points, paint);\r\n\t\t}\r\n\r\n\t}\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nTypefaces shouldn\u0027t be disappearing?\r\n\r\n**Actual Behavior**\r\n\r\nTypefaces are disappearing!\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.1.1\r\n- Last known good version:  1.68.0\r\n- IDE:  VS2017/2019\r\n- Platform Target Frameworks: \r\n  - Windows Classic:  Win10 via xUnit x86 / .NET Core 3 x64\r\n\r\n**Screenshots**\r\n\r\n![DisappearingHandle](https://user-images.githubusercontent.com/38544371/78842088-b676a080-79c4-11ea-9dc0-20924906506a.png)\r\n\r\n![TypefaceCrashSideBySide](https://user-images.githubusercontent.com/38544371/78842395-77951a80-79c5-11ea-9d15-e3746b26e928.png)\r\n",
  "author": {
    "login": "mlptownsend",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "v1.68.2",
  "createdAt": "2020-04-08T23:20:38",
  "updatedAt": "2022-08-19T06:02:06",
  "closedAt": "2020-04-11T17:48:05",
  "commentCount": 3,
  "reactionCount": 0
}