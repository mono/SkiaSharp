{
  "number": 1728,
  "type": "issue",
  "state": "open",
  "title": "[BUG] XPS DrawBitMap is clipping?",
  "body": "**Description**\r\n\r\nIm using SkiaSharp to create an XPS (and/or PDF) document that includes images for printing. Images in PDF are correctly stretched to fit the required rect, but on XPS they seem to be clipped. My code and sample images are below.\r\n\r\nIs this a bug or am I doing something wrong? I would have thought that the code for PDF should be identical for XPS but maybe there\u0027s extra trick or hack I need to do?\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060\r\npublic void ToDocument(string inputPath, bool pdf = false)\r\n        {\r\n\r\n            SKDocument document = null;\r\n            var outputPath = Path.Combine(Path.GetDirectoryName(inputPath), Path.GetFileNameWithoutExtension(inputPath)) \u002B (pdf ? \u0022.pdf\u0022 : \u0022.xps\u0022);\r\n\r\n            using var input = File.OpenRead(inputPath);\r\n            using var inputStream = new SKManagedStream(input);\r\n            using var original = SKBitmap.Decode(inputStream);\r\n\r\n            // page a little bigger than source image\r\n            var pageRect = new SKRect(0, 0, original.Width \u002B 20, original.Height \u002B 100);\r\n\r\n            var renderRect = new SKRect(0, 0,\r\n                (float)original.Width, (float)original.Height);\r\n\r\n            using var outputStream = File.Create(outputPath);\r\n            using var managedStream = new SKManagedWStream(outputStream);\r\n\r\n            // null checking removed for readability\r\n\r\n            using var canvas = document.BeginPage(pageRect.Width, pageRect.Height);\r\n            canvas.Clear();\r\n\r\n            using var p = new SKPaint();\r\n\r\n            SKRect picRect;\r\n            float xFactor = 0.25F;\r\n            float yFactor = 0.25F;\r\n            if (pdf)\r\n            {\r\n                // stretch renderRect for pdf\r\n                picRect = new SKRect(renderRect.Left, renderRect.Top, renderRect.Left \u002B renderRect.Width * xFactor, renderRect.Top \u002B renderRect.Height * yFactor);\r\n            }\r\n            else\r\n            {\r\n                // stretch renderRect for xps\r\n                // xFactor = 1.25F;\r\n                // yFactor = 1.25F;\r\n                picRect = new SKRect(renderRect.Left, renderRect.Top, renderRect.Left \u002B renderRect.Width * xFactor, renderRect.Top \u002B renderRect.Height * yFactor);\r\n            }\r\n            canvas.DrawBitmap(original, original.Info.Rect, picRect, p);\r\n\r\n            p.StrokeWidth = 2;\r\n            p.Color = SKColors.Red;\r\n            p.Style = SKPaintStyle.Stroke;\r\n\r\n            // rect same size as original bitmap\r\n            canvas.DrawRect(renderRect, p);\r\n\r\n            p.Color = SKColors.Blue;\r\n            // rect same size as stretched bitmap\r\n            canvas.DrawRect(picRect, p);\r\n\r\n            using var tp = new SKPaint();\r\n            tp.TextSize = 10.0f;\r\n            tp.IsAntialias = true;\r\n            tp.IsStroke = false;\r\n            //canvas.DrawText($\u0022Page: {pageRect.Height}w {pageRect.Width}h\u0022, 10F, pageRect.Bottom - 55F, tp);\r\n            tp.Color = SKColors.Red;\r\n            canvas.DrawText($\u0022Source: {original.Width}w {original.Height}h\u0022, 10F, pageRect.Bottom - 40F, tp);\r\n            tp.Color = SKColors.Blue;\r\n            canvas.DrawText($\u0022Dest: {picRect.Width}w {picRect.Height}h\u0022, 10F, pageRect.Bottom - 25F, tp);\r\n            canvas.DrawText($\u0022Stretched: {xFactor}w {yFactor}h\u0022, 10F, pageRect.Bottom - 10F, tp);\r\n\r\n\r\n            // bitmap should fit to the background rect but fails with xps\r\n            //canvas.DrawBitmap(original, renderRect, p);\r\n\r\n            document.Close();\r\n        }\r\n\u0060\u0060\u0060\r\n\r\n\r\n**Expected Behavior**\r\n\r\n\u003C!-- a general description of what was the expected behavior or result --\u003E\r\n\r\n**Actual Behavior**\r\n\r\nSome images are clipped - it seems like small ones are ok.  Maybe there is a buffer size issue or ... ?\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.80.2\r\n- Last known good version:  ??\r\n- IDE:   Visual Studio, Visual Studio Code \r\n- Platform Target Frameworks: \r\n  - Linux:  Ubuntu 16.04 (AWS Linux)\r\n  - Windows Classic:  10\r\n- Target Devices:   \r\n  - n/a - printing the xps\r\n  \r\n\u003Cdetails\u003E\r\n  \u003Csummary\u003EDetailed IDE/OS information (click to expand)\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\n\r\nPASTE ANY DETAILED VERSION INFO HERE\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n\r\n**Screenshots**\r\nOriginal image:\r\n![Original](https://user-images.githubusercontent.com/3420249/123340079-c1086000-d59f-11eb-9ba1-c108e00f4e6c.png)\r\n\r\nPDF: \r\n![PDF](https://user-images.githubusercontent.com/3420249/123340085-c4035080-d59f-11eb-95fc-0d671bc63bad.png)\r\n\r\nXPS:\r\n![XPS](https://user-images.githubusercontent.com/3420249/123340093-c5cd1400-d59f-11eb-8b18-d5e03ca25409.png)\r\n\r\n\r\n\r\n",
  "author": {
    "login": "Jonesie",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2021-06-24T22:26:32",
  "updatedAt": "2024-08-19T10:13:56",
  "commentCount": 5,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-06T13:35:04.2364175Z",
    "reactions": [
      {
        "user": "wstaelens",
        "content": "\u002B1",
        "createdAt": "2026-02-06T13:35:04.2364224Z"
      }
    ],
    "comments": [
      {
        "id": 2178648773,
        "author": "AndreaLabeljoy",
        "body": "Hi @Jonesie, ran into this exact issue today on version 2.88.8.\r\nDid you ever find a way to  make it work?",
        "createdAt": "2024-06-19T12:52:38",
        "reactions": []
      },
      {
        "id": 2236562733,
        "author": "JonesieHexcom",
        "body": "@AndreaLabeljoy Sorry for the late reply.  No, we gave up on XPS and just use PDF.  Ive not tried again with later versions.",
        "createdAt": "2024-07-18T13:45:16",
        "reactions": []
      },
      {
        "id": 2291506180,
        "author": "oatkins",
        "body": "It turns out that this is a bug in the Google Skia code. It\u0027s even commented \uD83D\uDE06:\r\n* https://github.com/google/skia/blob/c30ba7bb38d6f368631db17d76628e89b0fe5004/src/xps/SkXPSDevice.cpp#L685\r\n* https://github.com/google/skia/blob/c30ba7bb38d6f368631db17d76628e89b0fe5004/src/xps/SkXPSDevice.cpp#L796\r\n\r\n![image](https://github.com/user-attachments/assets/c58f2786-a4f0-49de-b970-bdf8f1f99265)\r\n\r\nThe code alludes to \u0060SK_ScalarMax\u0060, which is large, but for some reason they ended up using 1000 instead. The result is that all images get cropped to a 1000 pixel square centred on the origin. Generally, that means that images get cropped to 500 pixels high and 500 pixels wide.\r\n\r\nIt looks as though Windows does *not* consider the \u0060VisualBrush.Viewport\u0060 to be a clipping rectangle, but WPF does. I had, but now can\u0027t find, a reference to that in the WPF docs; the XPS spec is vague about it, and doesn\u0027t mention clipping at all. The Windows XPS viewer (and probably the printer drivers) render content outside of the viewport, which is probably why the bug has gone unnoticed for so long. So, perhaps the WPF behaviour is wrong.\r\n\r\nIn any case, my workaround (in my own code) is going to be adding some code to find the \u0060Viewbox\u0060 and \u0060Viewport\u0060 values in XAML:\r\n![image](https://github.com/user-attachments/assets/05df24d5-9d57-4803-a6aa-d9866d8d3287)\r\n\r\nand replace them with a much, much larger box.\r\n\r\nIn short, I don\u0027t think there\u0027s much that can be done in this repo, but there is a potential workaround for those hitting this problem.",
        "createdAt": "2024-08-15T15:18:27",
        "reactions": []
      },
      {
        "id": 2293101671,
        "author": "Jonesie",
        "body": "Thats good to know.  Thank you !!!",
        "createdAt": "2024-08-16T08:48:09",
        "reactions": []
      },
      {
        "id": 2296208852,
        "author": "AndreaLabeljoy",
        "body": "Thanks @oatkins for the info.\r\nI\u0027ve created a bug report on the Skia group referring them to this post, let\u0027s see if someone addresses it.\r\n[https://issues.skia.org/issues/360641492](url)",
        "createdAt": "2024-08-19T10:13:55",
        "reactions": []
      }
    ]
  }
}