{
  "number": 2139,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] MAUI: SKCanvasView crash, unable to display SKBitmap directly",
  "body": "**Description**\r\n\r\nI try to render an \u0060SKBitmap\u0060 on the view directly. In a Xamarin multi target app I could use \u0060SKCanvasView\u0060 (from SkiaSharp.Views.Forms) and its \u0060OnPaintSurface\u0060 and it worked perfectly.\r\n\r\n**Failed attempt 1:**\r\n\r\nBut when I try the same in a MAUI app (this time \u0060SKCanvasView\u0060 is referenced from the SkiaSharp.Views.Maui.Controls package) the application crashes.\r\n\r\n\u0060\u0060\u0060xaml\r\n\u003CskiaCtrls:SKCanvasView x:Name=\u0022canvasView\u0022 PaintSurface=\u0022CanvasView_OnPaintSurface\u0022 HeightRequest=\u0022100\u0022/\u003E\r\n\u0060\u0060\u0060\r\n\u0060\u0060\u0060cs\r\nprivate SKBitmap bitmap;\r\n\r\nprivate void ButtonClicked(object sender, EventArgs e)\r\n{\r\n    bitmap = GenerateBitmap(); // some very standard premultiplied BGRA8888 bitmap\r\n    canvasView.InvalidateSurface(); // to invoke CanvasView_OnPaintSurface\r\n}\r\n\r\nprivate void CanvasView_OnPaintSurface(object sender, SKPaintSurfaceEventArgs e)\r\n{\r\n    if (bitmap == null)\r\n        return;\r\n    SKImageInfo info = e.Info;\r\n    SKSurface surface = e.Surface;\r\n    SKCanvas canvas = surface.Canvas;\r\n    canvas.DrawBitmap(bitmap, info.Rect);\r\n}\r\n\u0060\u0060\u0060\r\nWhereas this code worked in Xamarin, it crashes with MAUI:\r\n* Windows: \u0060Microsoft.UI.Xaml.Controls.Frame.NavigationFailed\u0060 was unhandled.\r\nThe \u0060Exception\u0060 property of the event argument is a \u0060COMException\u0060: Catastrophic failure (0x8000FFFF (E_UNEXPECTED))\r\n* Android: Microsoft.Maui.Platform.HandlerNotFoundException: \u0027Handler not found for view SkiaSharp.Views.Maui.Controls.SKCanvasView.\u0027\r\n\r\n**Failed attempt 2:**\r\n\r\nSkiaSharp.Views.Maui.Controls has an \u0060SKBitmapImageSource\u0060 class, which appears to be an elegant solution to expose an \u0060SKBitmap\u0060 as a regular \u0060ImageSource\u0060:\r\n\r\n\u0060\u0060\u0060xaml\r\n\u003CImage x:Name=\u0022imgTest\u0022 HeightRequest=\u0022100\u0022  HorizontalOptions=\u0022Center\u0022/\u003E\r\n\u0060\u0060\u0060\r\n\u0060\u0060\u0060cs\r\nprivate void ButtonClicked(object sender, EventArgs e) =\u003E\r\n    imgTest.Source = new SKBitmapImageSource { Bitmap = GenerateBitmap() };\r\n\u0060\u0060\u0060\r\n\r\n* Windows: Nothing happens (the bitmap is generated but the image does not appear)\r\n* Android: System.InvalidOperationException: \u0027Unable to find a image source service for SkiaSharp.Views.Maui.ISKBitmapImageSource.\u0027\r\n\r\n**Failed attempt 3:**\r\n\r\nI tried to use a \u0060GraphicsView\u0060 instead (from the Microsoft.Maui.Controls package):\r\n\u0060\u0060\u0060xaml\r\n\u003CGraphicsView x:Name=\u0022graphicsViewTest\u0022 HeightRequest=\u0022100\u0022/\u003E\r\n\u0060\u0060\u0060\r\n\u0060\u0060\u0060cs\r\nprivate void ButtonClicked(object sender, EventArgs e)\r\n{\r\n    graphicsViewTest.Drawable = new SkiaImage(GenerateBitmap());\r\n    graphicsViewTest.Invalidate();\r\n}\r\n\u0060\u0060\u0060\r\n* Windows: Nothing happens (the bitmap is generated but the image does not appear)\r\n* Android: NotSupportedException from SkiaImage.ToPlatformImage\r\n\r\n**Failed attempt 4:**\r\n\r\nAs per Microsoft\u0027s [guideline](https://docs.microsoft.com/en-us/dotnet/maui/user-interface/controls/graphicsview) I tried to create a custom \u0060IDrawable\u0060 implementation for a \u0060GraphicsView\u0060 and use the drawing operations of \u0060ICanvas\u0060:\r\n\u0060\u0060\u0060xaml\r\n\u003CGraphicsView x:Name=\u0022graphicsViewTest\u0022 HeightRequest=\u0022100\u0022/\u003E\r\n\u0060\u0060\u0060\r\n\u0060\u0060\u0060cs\r\nprivate SKBitmap bitmap;\r\n\r\npublic MainPage()\r\n{\r\n    InitializeComponent();\r\n    graphicsViewTest.Drawable = new MyDrawable(this);\r\n}\r\n\r\nprivate void ButtonClicked(object sender, EventArgs e)\r\n{\r\n    bitmap = GenerateBitmap();\r\n    graphicsViewTest.Invalidate();\r\n}\r\n\r\nprivate class MyDrawable : IDrawable\r\n{\r\n    private readonly MainPage owner;\r\n    public MyDrawable(MainPage owner) =\u003E this.owner = owner;\r\n\r\n    public void Draw(ICanvas canvas, RectF dirtyRect)\r\n    {\r\n        if (owner.bitmap == null)\r\n            return;\r\n        canvas.DrawImage(new SkiaImage(owner.bitmap), dirtyRect.X, dirtyRect.Y, dirtyRect.Width, dirtyRect.Height);\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n* Windows: Does nothing. Turns out, it\u0027s because \u0060canvas.DrawImage\u0060 just returns if the passed \u0060IImage\u0060 is not a \u0060W2DImage\u0060. (???!!!) Doesn\u0027t it violate a lot of design rules?\r\n* Android: Throws \u0060NotSupportedException\u0060. \u0060canvas\u0060 is now a \u0060ScalingCanvas\u0060, which wraps a \u0060PlatformCanvas\u0060, which wraps an \u0060Andorid.Graphics.RecordingCanvas\u0060\r\n \r\n**Expected Behavior**\r\n\r\nAll of the solutions above seem to be logical to me. Attempt 1 is clearly a bug and should work.\r\n\r\nAnd though attempts 2-4 also seem correct I cannot decide whether they are just not implemented yet or I misunderstood the design choices. Can you please clarify if they should work (maybe later on)?\r\n\r\n**Versions**\r\n* SkiaSharp: 2.88\r\n* Windows: Version 10.0.19044.1766\r\n* Android: Android 11.0 API 30 (emulated Pixel 5)\r\n* SkiaSharp.Views.Maui.Controls: 2.88.1-preview.79\r\n* Microsoft.Maui.Graphics.Skia: 6.0.403\r\n\r\n**Disclaimer**\r\n* I could not test MacOS and Linux\r\n* I know saving as .png \u002B \u0060PlatformImage.FromStream\u0060 would \u0022work\u0022 but unfortunately that is an unacceptable solution for me\r\n\r\n**Reproduction Link**\r\n\r\nSee the attachment. It now executes Attempt 1 but you can uncomment the other attempts, too.\r\n[MauiApp1.zip](https://github.com/mono/SkiaSharp/files/9029277/MauiApp1.zip)\r\n",
  "author": {
    "login": "koszeggy",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-07-01T13:55:51",
  "updatedAt": "2022-09-10T09:01:18",
  "closedAt": "2022-08-11T08:51:55",
  "commentCount": 6,
  "reactionCount": 0
}