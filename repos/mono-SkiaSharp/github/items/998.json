{
  "number": 998,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Xamarin.Forms (Android only) app freezing after GC spam",
  "body": "**Description**\r\n\r\nUsing a timer for 30fps on a device to update a SKCanvasView to draw a progress bar will cause the the app to freeze after some amount of time (devices and times listed below in target devices). There appears to be a bunch of garbage collection message being output in a loop. UI Is non responsive. If left long enough the UI may update so the timer does appear to still be running.\r\n\r\nExample of the GC spam: \r\n\u0060\u0060\u0060\r\n[Mono] GC_TAR_BRIDGE bridges 23085 objects 23085 opaque 0 colors 23085 colors-bridged 23085 colors-visible 23085 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 6.66ms tarjan 25.11ms scc-setup 12.90ms gather-xref 1.10ms xref-setup 0.27ms cleanup 7.48ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1644.92ms\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1856K\r\n[Mono] GC_MAJOR: (user request) time 60.52ms, stw 60.88ms los size: 1024K in use: 74K\r\n[monodroid-gc] 46303 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 11(480B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 991us total 11.365ms\r\n[Mono] GC_TAR_BRIDGE bridges 23087 objects 23087 opaque 0 colors 23087 colors-bridged 23087 colors-visible 23087 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 5.65ms tarjan 20.96ms scc-setup 12.04ms gather-xref 0.81ms xref-setup 0.15ms cleanup 7.25ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1559.15ms\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1857K\r\n[Mono] GC_MAJOR: (user request) time 50.82ms, stw 51.14ms los size: 1024K in use: 74K\r\n[monodroid-gc] 46304 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 4(128B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 945us total 10.922ms\r\n[Mono] GC_TAR_BRIDGE bridges 23086 objects 23086 opaque 0 colors 23086 colors-bridged 23086 colors-visible 23086 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 5.66ms tarjan 19.78ms scc-setup 11.79ms gather-xref 0.78ms xref-setup 0.14ms cleanup 7.25ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1537.47ms\r\n[Mono] GC_MAJOR: (user request) time 48.67ms, stw 49.34ms los size: 1024K in use: 74K\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1856K\r\n[monodroid-gc] 46305 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 3(96B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 942us total 10.872ms\r\n\u0060\u0060\u0060\r\n\r\nWe have tried both with the PaintSurface event and overriding OnPaintSurface with the same results. Tried various timers, tried flushing and not flushing the canvas. Appears to happen on Android 6, 8-10. Possibly 7 as well but I don\u0027t have a device to test on.\r\n\r\nNot calling InvalidateSurface will also prevent the issue, but then the display won\u0027t be update. \r\n\r\nWe believe we also have this issue in another app which isn\u0027t calling InvalidateSurface, but instead moving a small SKCanvasView up the screen. But this example is much more easier to reproduce. \r\n\r\nIssue only appears to effect Android. I have tried the nuget package of 1.60.0, 1.68.0 and  1.68.1-rc.153 and they all exhibit the same behaviour although the time to freeze varies a little depending on what nuget version I use. \r\n\r\nFrom memory we had profiled our production app which was giving us this problem. It wasn\u0027t using excessive CPU or memory when these freezes occurred.\r\n\r\n**Expected Behavior**\r\n\r\nTimer and display runs forever.\r\n\r\n**Actual Behavior**\r\n\r\nApp will freeze after a certain amount of time which changes per device.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue: 1.60.0 - 1.68.1-rc.153\r\n- Last known good version: Unsure if version below 1.60.0 works.\r\n- IDE:  Visual Studio for Mac\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Android: 9.0\r\n  - iOS:  11.2\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - Android Pixel 2 Emulator (Android 9.0, ~140sec)\r\n  - Galaxy Tab S 8.4 (Android 6, ~186sec)\r\n  - Pixel 3 XL (Android 10, ~122sec)\r\n  - HTC U11 (Android 9, ~223sec)\r\n  - HTC 10 (Android 8, ~213sec)\r\n  - HTC M8 (Android 6, ~140sec)\r\n\r\n**Reproduction Link**\r\n\r\n[SkiaSharpDebugTest.zip](https://github.com/mono/SkiaSharp/files/3812070/SkiaSharpDebugTest.zip)\r\n",
  "author": {
    "login": "beeradmoore",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2019-11-06T01:47:28",
  "updatedAt": "2022-08-19T09:02:09",
  "closedAt": "2019-11-06T05:46:21",
  "commentCount": 8,
  "reactionCount": 0
}