{
  "number": 998,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Xamarin.Forms (Android only) app freezing after GC spam",
  "body": "**Description**\r\n\r\nUsing a timer for 30fps on a device to update a SKCanvasView to draw a progress bar will cause the the app to freeze after some amount of time (devices and times listed below in target devices). There appears to be a bunch of garbage collection message being output in a loop. UI Is non responsive. If left long enough the UI may update so the timer does appear to still be running.\r\n\r\nExample of the GC spam: \r\n\u0060\u0060\u0060\r\n[Mono] GC_TAR_BRIDGE bridges 23085 objects 23085 opaque 0 colors 23085 colors-bridged 23085 colors-visible 23085 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 6.66ms tarjan 25.11ms scc-setup 12.90ms gather-xref 1.10ms xref-setup 0.27ms cleanup 7.48ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1644.92ms\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1856K\r\n[Mono] GC_MAJOR: (user request) time 60.52ms, stw 60.88ms los size: 1024K in use: 74K\r\n[monodroid-gc] 46303 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 11(480B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 991us total 11.365ms\r\n[Mono] GC_TAR_BRIDGE bridges 23087 objects 23087 opaque 0 colors 23087 colors-bridged 23087 colors-visible 23087 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 5.65ms tarjan 20.96ms scc-setup 12.04ms gather-xref 0.81ms xref-setup 0.15ms cleanup 7.25ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1559.15ms\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1857K\r\n[Mono] GC_MAJOR: (user request) time 50.82ms, stw 51.14ms los size: 1024K in use: 74K\r\n[monodroid-gc] 46304 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 4(128B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 945us total 10.922ms\r\n[Mono] GC_TAR_BRIDGE bridges 23086 objects 23086 opaque 0 colors 23086 colors-bridged 23086 colors-visible 23086 xref 0 cache-hit 0 cache-semihit 0 cache-miss 0 setup 5.66ms tarjan 19.78ms scc-setup 11.79ms gather-xref 0.78ms xref-setup 0.14ms cleanup 7.25ms\r\n[Mono] GC_BRIDGE: Complete, was running for 1537.47ms\r\n[Mono] GC_MAJOR: (user request) time 48.67ms, stw 49.34ms los size: 1024K in use: 74K\r\n[Mono] GC_MAJOR_SWEEP: major size: 2672K in use: 1856K\r\n[monodroid-gc] 46305 outstanding GREFs. Performing a full GC!\r\n[art] Starting a blocking GC Explicit\r\n[art] Explicit concurrent mark sweep GC freed 3(96B) AllocSpace objects, 0(0B) LOS objects, 46% free, 18MB/34MB, paused 942us total 10.872ms\r\n\u0060\u0060\u0060\r\n\r\nWe have tried both with the PaintSurface event and overriding OnPaintSurface with the same results. Tried various timers, tried flushing and not flushing the canvas. Appears to happen on Android 6, 8-10. Possibly 7 as well but I don\u0027t have a device to test on.\r\n\r\nNot calling InvalidateSurface will also prevent the issue, but then the display won\u0027t be update. \r\n\r\nWe believe we also have this issue in another app which isn\u0027t calling InvalidateSurface, but instead moving a small SKCanvasView up the screen. But this example is much more easier to reproduce. \r\n\r\nIssue only appears to effect Android. I have tried the nuget package of 1.60.0, 1.68.0 and  1.68.1-rc.153 and they all exhibit the same behaviour although the time to freeze varies a little depending on what nuget version I use. \r\n\r\nFrom memory we had profiled our production app which was giving us this problem. It wasn\u0027t using excessive CPU or memory when these freezes occurred.\r\n\r\n**Expected Behavior**\r\n\r\nTimer and display runs forever.\r\n\r\n**Actual Behavior**\r\n\r\nApp will freeze after a certain amount of time which changes per device.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue: 1.60.0 - 1.68.1-rc.153\r\n- Last known good version: Unsure if version below 1.60.0 works.\r\n- IDE:  Visual Studio for Mac\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Android: 9.0\r\n  - iOS:  11.2\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - Android Pixel 2 Emulator (Android 9.0, ~140sec)\r\n  - Galaxy Tab S 8.4 (Android 6, ~186sec)\r\n  - Pixel 3 XL (Android 10, ~122sec)\r\n  - HTC U11 (Android 9, ~223sec)\r\n  - HTC 10 (Android 8, ~213sec)\r\n  - HTC M8 (Android 6, ~140sec)\r\n\r\n**Reproduction Link**\r\n\r\n[SkiaSharpDebugTest.zip](https://github.com/mono/SkiaSharp/files/3812070/SkiaSharpDebugTest.zip)\r\n",
  "author": {
    "login": "beeradmoore",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2019-11-06T01:47:28",
  "updatedAt": "2022-08-19T09:02:09",
  "closedAt": "2019-11-06T05:46:21",
  "commentCount": 8,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:09:14.5027043Z",
    "reactions": [],
    "comments": [
      {
        "id": 550134228,
        "author": "daltonks",
        "body": "It looks like most of the garbage is coming from using Xamarin Essential\u0027s \u0060DeviceDisplay.MainDisplayInfo.Density\u0060 every draw.",
        "createdAt": "2019-11-06T04:08:29",
        "reactions": [
          {
            "user": "beeradmoore",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:09:12.9897426Z"
          }
        ]
      },
      {
        "id": 550154399,
        "author": "beeradmoore",
        "body": "Oh my goodness... Moving \u0060DeviceDisplay.MainDisplayInfo.Density\u0060 to be measured only once has allowed my emulator build to get up to 800 seconds. I feel this was most definitely the issue. Did you pick this up with profiling, or just by eyeing how regularly that was being called?",
        "createdAt": "2019-11-06T05:44:48",
        "reactions": []
      },
      {
        "id": 550155012,
        "author": "daltonks",
        "body": "Everything else looked legit in the draw call, and I didn\u0027t know that Xamarin Essentials had \u0060DeviceDisplay.MainDisplayInfo.Density\u0060, so I was curious about it. Changed it to 10 and saw the number of GCs go down a lot, hah.",
        "createdAt": "2019-11-06T05:47:28",
        "reactions": []
      },
      {
        "id": 550159848,
        "author": "beeradmoore",
        "body": "(sorry for the above close/open ticket, its been a long debugging filled day -_-)\r\n\r\nMy repro project is now up over 2,000 seconds. I am so sure that was the issue so I\u0027ll keep this closed and pass this on to one of the devs in our team to fix in our app and I\u0027ll check back to confirm it is indeed fixed. It makes perfect sense why we appeared to be the only people getting this issue in the last 2 years.\r\n\r\nThanks for the quick response!",
        "createdAt": "2019-11-06T06:06:50",
        "reactions": [
          {
            "user": "daltonks",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:09:13.6520503Z"
          }
        ]
      },
      {
        "id": 559229592,
        "author": "VieiraJP",
        "body": "I got exactly the same issue. \r\nMoving the DeviceDisplay.MainDisplayInfo.Density out of the Draw, sorted the issue.",
        "createdAt": "2019-11-27T19:51:19",
        "reactions": []
      },
      {
        "id": 559233346,
        "author": "mattleibow",
        "body": "I this on Android?",
        "createdAt": "2019-11-27T20:03:44",
        "reactions": []
      },
      {
        "id": 559248236,
        "author": "VieiraJP",
        "body": "\u003E I this on Android?\r\nYes, actually Android. IOS seems to not complain, at least in the emulator. \r\n\r\nIn short, Im working is a live chart library. \r\nAs the canvas needs to translate in order to offer the live moving effect, I had a need to redraw all visible the points, including text. \r\nI\u0027m using DeviceDisplay.MainDisplayInfo.Density to easier scale the text. By rush I was calling it within the OnDrawMethod, forcing the  DeviceDisplay.MainDisplayInfo.Density to be called very often. \r\nThe quick fix was removing it form there. \r\nThe Density value is constant is only necessary to call it once. I\u0027m using Xamarin.Essentials V1.3.1. \r\nPersonally I can not consider it a bug, as a simple change in the client architecture can avoid it. Still can be an interesting challenge for those who maintain the package.",
        "createdAt": "2019-11-27T20:56:36",
        "reactions": []
      },
      {
        "id": 559259650,
        "author": "beeradmoore",
        "body": "@mattleibow , yeah this was on Android. Wasn\u0027t an issue with SkiaSharp but just how I was using Xamarin.Essentials. ",
        "createdAt": "2019-11-27T21:38:34",
        "reactions": [
          {
            "user": "VieiraJP",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:09:14.4531857Z"
          },
          {
            "user": "SamsonMychael",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:09:14.4531861Z"
          }
        ]
      }
    ]
  }
}