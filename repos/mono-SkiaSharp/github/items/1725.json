{
  "number": 1725,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] [WASM] HarfBuzzSharp Linker Errors",
  "body": "**Description**\r\nI\u0027m using SkiaSharp \u002B HarfBuzzSharp in a WebAssembly application. I have disabled the linker to reduce the build time for the project which leads to various issues listed below. With the linker enabled the build works fine but takes significantly longer.\r\n\r\nThis is the setup i\u0027m using:\r\n\r\n- .net5.0\r\n- linker enabled\r\n- \u0060HarfBuzzSharp\u0060 Version 2.88.0-preview.7\r\n- \u0060SkiaSharp\u0060 Version 2.88.0-preview.7\r\n- \u0060HarfBuzzSharp.NativeAssets.WebAssembly\u0060 Version 2.6.1.8-preview.93\r\n\r\n\r\ni\u0027m inspecting the build logs with detailed verbosity and get the following output with \u0060System.Exception: Failed to generate AOT layout\u0060\r\n**Behavior**\r\n\r\n\u0060\u0060\u0060\r\n... linker-out \u003E pinvoke-table.h.tmp (TaskId:779)\r\n[00:01:57.7838172] Unhandled exception. System.Exception: Parameter types of pinvoke callback method \u0027System.IntPtr GetTableDelegateProxyImplementation(System.IntPtr, HarfBuzzSharp.Tag, System.IntPtr)\u0027 needs to be blittable. (TaskId:779)                 \r\n[00:01:57.7839076]    at PInvokeTableGenerator.Error(String msg) in D:\\a\\1\\s\\src\\Uno.Wasm.Tuner\\PInvokeTableGenerator.net5.cs:line 328 (TaskId:779)\r\n\r\n\r\nUnhandled exception. System.Exception: The return type \u0027HarfBuzzSharp.UnicodeCombiningClass\u0027 of pinvoke callback method \u0027HarfBuzzSharp.UnicodeCombiningClass CombiningClassProxyImplementation(System.IntPtr, System.UInt32, System.Void*)\u0027 needs to be blittable.\r\n\u0060\u0060\u0060\r\n\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.0-preview.7\r\n- Last known good version:  x\r\n- IDE:  Visual Studio 2019\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Uno WebAssembly Bootstrapper : 3.0.0-dev.95\r\n- Target Devices:\r\n  - Browser\r\n  \r\n\r\n**Reproduction Link**\r\n\r\n[https://github.com/nor0x/skiasharp-1720](https://github.com/nor0x/skiasharp-1720\r\n)",
  "author": {
    "login": "nor0x",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2021-06-23T08:07:29",
  "updatedAt": "2022-08-19T00:02:43",
  "closedAt": "2021-11-09T22:16:27",
  "commentCount": 20,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-06T14:17:25.3710174Z",
    "reactions": [],
    "comments": [
      {
        "id": 866809303,
        "author": "Gillibald",
        "body": "Do you have a working Ubuntu WSL environment?",
        "createdAt": "2021-06-23T12:53:42",
        "reactions": []
      },
      {
        "id": 866872901,
        "author": "nor0x",
        "body": "yes, i have WSL1 and WSL2 ready",
        "createdAt": "2021-06-23T14:13:50",
        "reactions": []
      },
      {
        "id": 948504142,
        "author": "nor0x",
        "body": "i have tried it with the latest preview versions \u0060.preview-150\u0060 and the issue is still present",
        "createdAt": "2021-10-21T11:10:24",
        "reactions": []
      },
      {
        "id": 948510174,
        "author": "Gillibald",
        "body": "Most likely an error in the tooling. We need to explicitly define how these enums are handled by p/invoke \r\nhttps://github.com/mono/SkiaSharp/blob/main/binding/HarfBuzzSharp.Shared/HarfBuzzApi.generated.cs#L5722\r\n\r\n@mattleibow ",
        "createdAt": "2021-10-21T11:18:05",
        "reactions": []
      },
      {
        "id": 954093097,
        "author": "martinaxure",
        "body": "I\u0027m running into the same issue with .preview-152 whether or not I turn on linking. I\u0027m using SkiaSharp.Views.Blazor",
        "createdAt": "2021-10-28T18:25:19",
        "reactions": []
      },
      {
        "id": 963321520,
        "author": "nor0x",
        "body": "@mattleibow sorry to ping again but are there any updates or plans on this? disabling the linker would really help us reducing our build times for web assembly. i would be happy to contribute myself but i\u0027m not that deep into \u0060HarfBuzzApi.generated\u0060 ",
        "createdAt": "2021-11-08T16:20:43",
        "reactions": []
      },
      {
        "id": 963367212,
        "author": "mattleibow",
        "body": "Oh golly. Let me see. That is generated and maybe something is funny. ",
        "createdAt": "2021-11-08T17:01:32",
        "reactions": []
      },
      {
        "id": 963793283,
        "author": "mattleibow",
        "body": "Seems to be a bug in .NET 6: https://github.com/dotnet/runtime/issues/61350\r\n\r\nI\u0027ll try get a workaround for now.",
        "createdAt": "2021-11-09T03:55:23",
        "reactions": []
      },
      {
        "id": 964595593,
        "author": "mattleibow",
        "body": "Merged a workaround for now",
        "createdAt": "2021-11-09T22:16:27",
        "reactions": [
          {
            "user": "nor0x",
            "content": "heart",
            "createdAt": "2026-02-06T14:17:23.0907533Z"
          },
          {
            "user": "martinaxure",
            "content": "heart",
            "createdAt": "2026-02-06T14:17:23.090754Z"
          }
        ]
      },
      {
        "id": 964822849,
        "author": "nor0x",
        "body": "thank you very much for the fast help! i will test it with my application, is it in the preview-feed already?",
        "createdAt": "2021-11-10T06:22:12",
        "reactions": []
      },
      {
        "id": 971865648,
        "author": "martinaxure",
        "body": "@nor0x, did you end up building it for yourself? It still hasn\u0027t been updated on the nuget feeds.",
        "createdAt": "2021-11-17T18:41:23",
        "reactions": []
      },
      {
        "id": 974574045,
        "author": "mattleibow",
        "body": "It should be on the \u0060https://aka.ms/skiasharp-eap/index.json\u0060 feeds. Check the latest 2.88.x previews.",
        "createdAt": "2021-11-20T02:01:28",
        "reactions": []
      },
      {
        "id": 975173086,
        "author": "nor0x",
        "body": "i have the \u0060skiasharp-eap\u0060 feed but the latest version seems to be 2.88.0-preview.155 from 29th of October and this one doesn\u0027t have the fix ",
        "createdAt": "2021-11-22T06:31:02",
        "reactions": []
      },
      {
        "id": 975744786,
        "author": "martinaxure",
        "body": "Thank you, @mattleibow! I didn\u0027t see the EAP feed on the README.md page \uD83E\uDD26 \r\n\r\nI\u0027m good to go and Harfbuzz is compiling in my Blazor project.",
        "createdAt": "2021-11-22T17:14:57",
        "reactions": []
      },
      {
        "id": 975823237,
        "author": "nor0x",
        "body": "latest .171 is available for me now. Thank you \uD83D\uDC4F\uD83D\uDC4F",
        "createdAt": "2021-11-22T18:54:42",
        "reactions": []
      },
      {
        "id": 978614551,
        "author": "martinaxure",
        "body": "While I added this to my project file: \r\n\r\n\u0060\u003CPackageReference Include=\u0022HarfBuzzSharp\u0022 Version=\u00222.8.2-preview.171\u0022 /\u003E\u0060\r\n\r\nI am not seeing \u0060libHarfBuzzSharp\u0060 included in the wasm build:\r\n\r\n\u0060\u0060\u0060\r\n22\u003E \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\bin\\wasm-ld.exe\u0022 -o C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\dotnet.wasm C:\\Users\\martin\\.nuget\\packages\\skiasharp.nativeassets.webassembly\\2.88.0-preview.171\\buildTransitive\\netstandard1.0\\..\\..\\build\\netstandard1.0\\libSkiaSharp.a\\2.0.23\\libSkiaSharp.a C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\pinvoke.o C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\driver.o C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\corebindings.o \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libicui18n.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libicuuc.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-component-debugger-static.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-component-diagnostics_tracing-stub-static.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-component-hot_reload-static.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-ee-interp.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-icall-table.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-ilgen.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmono-profiler-aot.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libmonosgen-2.0.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libSystem.IO.Compression.Native.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NETCore.App.Runtime.Mono.browser-wasm\\6.0.0\\runtimes\\browser-wasm\\native\\libSystem.Native.a\u0022 \u0022-LC:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libgl.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libal.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libhtml5.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libc.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libcompiler_rt.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libc\u002B\u002B.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libc\u002B\u002Babi.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libdlmalloc.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libc_rt_wasm.a\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\cache\\sysroot\\lib\\wasm32-emscripten\\libsockets.a\u0022 -mllvm -combiner-global-alias-analysis=false -mllvm -enable-emscripten-cxx-exceptions -mllvm -enable-emscripten-sjlj -mllvm -disable-lsr --allow-undefined --export putchar --export stackSave --export stackRestore --export stackAlloc --export __wasm_call_ctors --export __errno_location --export malloc --export free --export __cxa_is_pointer_type --export __cxa_can_catch --export setThrew --export memalign --export memset --export emscripten_main_thread_process_queued_calls --export _get_tzname --export _get_daylight --export _get_timezone --export ntohs --export htons --export htonl --export-if-defined=__start_em_asm --export-if-defined=__stop_em_asm --export-table -z stack-size=5242880 --initial-memory=536870912 --no-entry --max-memory=2147483648 --global-base=1024\r\n22\u003E \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\bin\\wasm-emscripten-finalize\u0022 --minimize-wasm-changes -g --dyncalls-i64 --dwarf C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\dotnet.wasm -o C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\dotnet.wasm --detect-features\r\n22\u003E \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Node.win-x64\\6.0.0\\tools\\bin\\node.exe\u0022 \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\emscripten\\src\\compiler.js\u0022 C:\\Users\\martin\\AppData\\Local\\Temp\\tmpf3nrw8za.txt\r\n22\u003E \u0022C:\\Program Files\\dotnet\\packs\\Microsoft.NET.Runtime.Emscripten.2.0.23.Sdk.win-x64\\6.0.0\\tools\\bin\\llvm-objcopy.exe\u0022 C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\dotnet.wasm C:\\Users\\martin\\git\\RP-web\\WebRP\\Client\\obj\\Debug\\net6.0\\wasm\\for-build\\dotnet.wasm --remove-section=producers\r\n22\u003EOptimizing dotnet.wasm ...\r\n\u0060\u0060\u0060\r\nAnd am accordingly seeing the following error:\r\n\u0060\u0060\u0060\r\ncrit: Microsoft.AspNetCore.Components.WebAssembly.Rendering.WebAssemblyRenderer[100]\r\n      Unhandled exception rendering component: libHarfBuzzSharp\r\nSystem.DllNotFoundException: libHarfBuzzSharp\r\n   at HarfBuzzSharp.Buffer..ctor()\r\n\u0060\u0060\u0060\r\n\r\nHow is SkiaSharp.Views.Blazor getting the files into the wasm build?\r\n\r\nThanks in advance.",
        "createdAt": "2021-11-25T00:44:58",
        "reactions": []
      },
      {
        "id": 978637294,
        "author": "martinaxure",
        "body": "I noticed that the packages aren\u0027t adding HarfBuzzSharp.NativeAssets.WebAssembly as a Compile time assembly. I tried adding them manually, but it didn\u0027t help much.\r\n\r\n![image](https://user-images.githubusercontent.com/47812393/143332184-c2a96d1d-c5b8-46cf-ab17-6fdb7efd6396.png)\r\n",
        "createdAt": "2021-11-25T00:50:03",
        "reactions": []
      },
      {
        "id": 978843629,
        "author": "Gillibald",
        "body": "Even adding the NativeAssets package didn\u0027t solve this for me.\r\n\r\nI had to add the library manually:\r\n\r\n\u0060\u0060\u0060\r\n \u003CItemGroup\u003E\r\n    \u003CNativeFileReference Include=\u0022libHarfBuzzSharp.a\u0022 /\u003E\r\n  \u003C/ItemGroup\u003E\r\n\u0060\u0060\u0060\r\n\r\nJust extract the library from the package. The Emscripten version should match.\r\n\u0060.nuget\\packages\\harfbuzzsharp.nativeassets.webassembly\\2.8.2-preview.171\\build\\netstandard1.0\\libHarfBuzzSharp.a\\2.0.23\u0060",
        "createdAt": "2021-11-25T05:16:56",
        "reactions": []
      },
      {
        "id": 984067852,
        "author": "martinaxure",
        "body": "@Gillibald, thank you, this worked! @mattleibow, would you like me to file a bug for this one?",
        "createdAt": "2021-12-01T21:25:00",
        "reactions": []
      },
      {
        "id": 988044531,
        "author": "JensKrumsieck",
        "body": "You do not have to extract the file from your .nuget-Folder.\r\nThe following worked for me (in an \u0060ItemGroup\u0060-Block):\r\n\u0060\u003CNativeFileReference Include=\u0022$(HarfBuzzSharpStaticLibraryPath)\\2.0.23\\*.a\u0022 /\u003E\u0060",
        "createdAt": "2021-12-07T15:41:25",
        "reactions": [
          {
            "user": "emorell96",
            "content": "\u002B1",
            "createdAt": "2026-02-06T14:17:25.3206906Z"
          }
        ]
      }
    ]
  }
}