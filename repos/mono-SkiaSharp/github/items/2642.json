{
  "number": 2642,
  "type": "issue",
  "state": "open",
  "title": "WGL window crash after switch window",
  "body": "### Description\n\nAfter creating a WGLContext and enabling OpenGL rendering on the Windows 10 operating system, if the window is switched to full screen and then to another window, the program crashes. It seems that this is due to the insufficient lifetime of wndClass. Persistently storing wndClass as a static field of the class resolved this issue.\n\n### Code\n\nsource code:\r\n\u0060\u0060\u0060\r\npublic class Win32Window : IDisposable\r\n\t{\r\n\t\tprivate ushort classRegistration;\r\n\r\n\t\tpublic string WindowClassName { get; }\r\n\r\n\t\tpublic IntPtr WindowHandle { get; private set; }\r\n\r\n\t\tpublic IntPtr DeviceContextHandle { get; private set; }\r\n\r\n\r\n              public Win32Window(string className)\r\n\t\t{\r\n\t\t\tWindowClassName = className;\r\n\r\n\t\t\tvar wc = new WNDCLASS\r\n\t\t\t{\r\n\t\t\t\tcbClsExtra = 0,\r\n\t\t\t\tcbWndExtra = 0,\r\n\t\t\t\thbrBackground = IntPtr.Zero,\r\n\t\t\t\thCursor = User32.LoadCursor(IntPtr.Zero, (int)User32.IDC_ARROW),\r\n\t\t\t\thIcon = User32.LoadIcon(IntPtr.Zero, (IntPtr)User32.IDI_APPLICATION),\r\n\t\t\t\thInstance = Kernel32.CurrentModuleHandle,\r\n\t\t\t\tlpfnWndProc = (WNDPROC)User32.DefWindowProc,\r\n\t\t\t\tlpszClassName = WindowClassName,\r\n\t\t\t\tlpszMenuName = null,\r\n\t\t\t\tstyle = User32.CS_HREDRAW | User32.CS_VREDRAW | User32.CS_OWNDC\r\n\t\t\t};\r\n\r\n\t\t\tclassRegistration = User32.RegisterClass(ref wc);\r\n\t\t\tif (classRegistration == 0)\r\n\t\t\t\tthrow new Exception($\u0022Could not register window class: {className}\u0022);\r\n\r\n\t\t\tWindowHandle = User32.CreateWindow(\r\n\t\t\t\tWindowClassName,\r\n\t\t\t\t$\u0022The Invisible Man ({className})\u0022,\r\n\t\t\t\tWindowStyles.WS_OVERLAPPEDWINDOW,\r\n\t\t\t\t0, 0,\r\n\t\t\t\t1, 1,\r\n\t\t\t\tIntPtr.Zero, IntPtr.Zero, Kernel32.CurrentModuleHandle, IntPtr.Zero);\r\n\t\t\tif (WindowHandle == IntPtr.Zero)\r\n\t\t\t\tthrow new Exception($\u0022Could not create window: {className}\u0022);\r\n\r\n\t\t\tDeviceContextHandle = User32.GetDC(WindowHandle);\r\n\t\t\tif (DeviceContextHandle == IntPtr.Zero)\r\n\t\t\t{\r\n\t\t\t\tDispose();\r\n\t\t\t\tthrow new Exception($\u0022Could not get device context: {className}\u0022);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpublic void Dispose()\r\n\t\t{\r\n\t\t\tif (WindowHandle != IntPtr.Zero)\r\n\t\t\t{\r\n\t\t\t\tif (DeviceContextHandle != IntPtr.Zero)\r\n\t\t\t\t{\r\n\t\t\t\t\tUser32.ReleaseDC(WindowHandle, DeviceContextHandle);\r\n\t\t\t\t\tDeviceContextHandle = IntPtr.Zero;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tUser32.DestroyWindow(WindowHandle);\r\n\t\t\t\tWindowHandle = IntPtr.Zero;\r\n\t\t\t}\r\n\r\n\t\t\tif (classRegistration != 0)\r\n\t\t\t{\r\n\t\t\t\tUser32.UnregisterClass(WindowClassName, Kernel32.CurrentModuleHandle);\r\n\t\t\t\tclassRegistration = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\u0060\u0060\u0060\r\npatch code:\r\n\u0060\u0060\u0060\r\npublic class Win32Window : IDisposable\r\n\t{\r\n\t\tprivate ushort classRegistration;\r\n\r\n\t\tpublic string WindowClassName { get; }\r\n\r\n\t\tpublic IntPtr WindowHandle { get; private set; }\r\n\r\n\t\tpublic IntPtr DeviceContextHandle { get; private set; }\r\n\r\n        private static WNDCLASS wc;\r\n\r\n        public Win32Window(string className)\r\n\t\t{\r\n\t\t\tWindowClassName = className;\r\n\r\n\t\t\twc = new WNDCLASS\r\n\t\t\t{\r\n\t\t\t\tcbClsExtra = 0,\r\n\t\t\t\tcbWndExtra = 0,\r\n\t\t\t\thbrBackground = IntPtr.Zero,\r\n\t\t\t\thCursor = User32.LoadCursor(IntPtr.Zero, (int)User32.IDC_ARROW),\r\n\t\t\t\thIcon = User32.LoadIcon(IntPtr.Zero, (IntPtr)User32.IDI_APPLICATION),\r\n\t\t\t\thInstance = Kernel32.CurrentModuleHandle,\r\n\t\t\t\tlpfnWndProc = (WNDPROC)User32.DefWindowProc,\r\n\t\t\t\tlpszClassName = WindowClassName,\r\n\t\t\t\tlpszMenuName = null,\r\n\t\t\t\tstyle = User32.CS_HREDRAW | User32.CS_VREDRAW | User32.CS_OWNDC\r\n\t\t\t};\r\n\r\n\t\t\tclassRegistration = User32.RegisterClass(ref wc);\r\n\t\t\tif (classRegistration == 0)\r\n\t\t\t\tthrow new Exception($\u0022Could not register window class: {className}\u0022);\r\n\r\n\t\t\tWindowHandle = User32.CreateWindow(\r\n\t\t\t\tWindowClassName,\r\n\t\t\t\t$\u0022The Invisible Man ({className})\u0022,\r\n\t\t\t\tWindowStyles.WS_OVERLAPPEDWINDOW,\r\n\t\t\t\t0, 0,\r\n\t\t\t\t1, 1,\r\n\t\t\t\tIntPtr.Zero, IntPtr.Zero, Kernel32.CurrentModuleHandle, IntPtr.Zero);\r\n\t\t\tif (WindowHandle == IntPtr.Zero)\r\n\t\t\t\tthrow new Exception($\u0022Could not create window: {className}\u0022);\r\n\r\n\t\t\tDeviceContextHandle = User32.GetDC(WindowHandle);\r\n\t\t\tif (DeviceContextHandle == IntPtr.Zero)\r\n\t\t\t{\r\n\t\t\t\tDispose();\r\n\t\t\t\tthrow new Exception($\u0022Could not get device context: {className}\u0022);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpublic void Dispose()\r\n\t\t{\r\n\t\t\tif (WindowHandle != IntPtr.Zero)\r\n\t\t\t{\r\n\t\t\t\tif (DeviceContextHandle != IntPtr.Zero)\r\n\t\t\t\t{\r\n\t\t\t\t\tUser32.ReleaseDC(WindowHandle, DeviceContextHandle);\r\n\t\t\t\t\tDeviceContextHandle = IntPtr.Zero;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tUser32.DestroyWindow(WindowHandle);\r\n\t\t\t\tWindowHandle = IntPtr.Zero;\r\n\t\t\t}\r\n\r\n\t\t\tif (classRegistration != 0)\r\n\t\t\t{\r\n\t\t\t\tUser32.UnregisterClass(WindowClassName, Kernel32.CurrentModuleHandle);\r\n\t\t\t\tclassRegistration = 0;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\u0060\u0060\u0060\r\n\n\n### Expected Behavior\n\ndon\u0027t crash\n\n### Actual Behavior\n\n![image](https://github.com/mono/SkiaSharp/assets/20983133/bbe78c18-2356-4ed1-b68e-a548217d56e6)\r\n\n\n### Version of SkiaSharp\n\n3.x (Alpha)\n\n### Last Known Good Version of SkiaSharp\n\nOther (Please indicate in the description)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nWindows\n\n### Platform / Operating System Version\n\n_No response_\n\n### Devices\n\n_No response_\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n_No response_\n\n### Code of Conduct\n\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "zhan2016",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2023-10-10T06:48:57",
  "updatedAt": "2023-10-10T06:48:57",
  "commentCount": 0,
  "reactionCount": 0
}