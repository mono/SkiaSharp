{
  "number": 2496,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Custom shader in SKCanvasView crashes .NET MAUI App",
  "body": "I am building a .NET MAUI app that\u0027s designed to run on iOS, specifically on an iPad Pro. In it I need to be be able to sample sections of an image based on a number of parameters and display that on screen, so I thought the best way to do that would be through a shader and the SkiaSharp SKRuntimeEffect and SKShader classes seemed like a good way to do it. I made a custom control that inherits from SKCanvasView and wrote an SkSL shader. However, whenever the code reaches the DrawRect() call in the OnPaintSurface method of the class, the app crashes immediately.\r\n\r\nI have made a bare bones app that has only a custom control that inherits from SKCanvasView with a trivial shader that just sets each pixel colour to red and the crash still happens, which can be found here: https://github.com/LFLumirithmic/SkiaShaderTest\r\n\r\nThe most relevant part of the code is this section in the OnSurfacePaint method:\r\n\r\n\u0060\u0060\u0060\r\nvar src = @\u0022\r\n    float4 main(float2 fragCoord) {\r\n        return float4(1,0,0,1);\r\n    }\u0022;\r\nusing var effect = SKRuntimeEffect.Create(src, out string error);\r\nusing var shader = effect.ToShader(true);\r\n\r\nusing (SKPaint paint = new SKPaint() { Shader = shader })\r\n{\r\n    try\r\n    {\r\n        canvas.DrawRect(info.Rect, paint);\r\n    }\r\n    catch (Exception e)\r\n    {\r\n        Debug.WriteLine($\u0022Exception {e.GetType()}: {e.Message}\u0022);\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThe call to canvas.DrawRect() instantly crashes the app. I ran it on an iPad Pro and in an iPad simulator, where it crashes with no exception thrown and no console output provided. I ran it on the Mac Mini used to build to the iPads and there it crashes without throwing an exception, but gives me the following output: https://github.com/LFLumirithmic/SkiaShaderTest/blob/main/mac-console-output.rtf\r\n\r\nI also ran it on a Windows 11 laptop, where it crashes in the same place, but throws the following exception:\r\n\r\n\u0060\u0060\u0060\r\nSystem.Runtime.InteropServices.SEHException\r\n  HResult=0x80004005\r\n  Message=External component has thrown an exception.\r\n  Source=\u003CCannot evaluate the exception source\u003E\r\n  StackTrace:\r\n\u003CCannot evaluate the exception stack trace\u003E\r\n\u0060\u0060\u0060\r\n\r\nIf I create one of the default shader effects as an SKShader object using the provided C# API, e.g.:\r\n\r\n\u0060\u0060\u0060\r\nusing (SKPaint paint = new SKPaint())\r\n{\r\n    SKShader shader = SKShader.CreateLinearGradient(\r\n        new SKPoint(0, 0),\r\n        new SKPoint(1000, 1000),\r\n        new SKColor[]\r\n        {\r\n            new SKColor(0,0,255),\r\n            new SKColor(0,255,0)\r\n         },\r\n         null,\r\n         SKShaderTileMode.Repeat\r\n     );\r\n     paint.Shader = shader;\r\n     canvas.DrawRect(info.Rect, paint);\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThat works perfectly. But even the trivial custom shader shown above doesn\u0027t work.\r\n\r\nI am using version 2.88.3 of SkiaSharp inside Visual Studio through the NuGet package manager, which is the latest as far as I can tell.\r\n\r\nI see that issue #2230 mentions the same problem, but it\u0027s phrased as a feature request suggesting a specific solution, so I figured I would open this as a broader question.\r\n\r\nAm I doing something wrong here and, if so, what? Or is this an issue in SkiaSharp with .NET MAUI? In a few other issues, I\u0027ve seen mentions of SKSL not being able to run on CPU in the current version of SkiaSharp, but I want it to run on GPU. Is there some sort of flag or setting or registration step I\u0027m missing?",
  "author": {
    "login": "LFLumirithmic",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-06-18T22:57:48",
  "updatedAt": "2023-08-31T03:00:30",
  "closedAt": "2023-07-31T16:32:07",
  "commentCount": 5,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T20:25:17.4417478Z",
    "reactions": [],
    "comments": [
      {
        "id": 1658735397,
        "author": "mattleibow",
        "createdAt": "2023-07-31T16:31:00",
        "reactions": []
      },
      {
        "id": 1658737045,
        "author": "mattleibow",
        "createdAt": "2023-07-31T16:32:02",
        "reactions": []
      },
      {
        "id": 1658957162,
        "author": "ggolda",
        "createdAt": "2023-07-31T18:48:33",
        "reactions": []
      },
      {
        "id": 1659265057,
        "author": "LFLumirithmic",
        "createdAt": "2023-07-31T22:17:54",
        "reactions": []
      },
      {
        "id": 1659412168,
        "author": "mattleibow",
        "createdAt": "2023-08-01T01:04:10",
        "reactions": []
      }
    ]
  }
}