{
  "number": 533,
  "type": "issue",
  "state": "open",
  "title": "[Android] Uncapped framerates (300fps) on SKGLView.PaintSurface after updating package",
  "body": "### Description\r\n\r\nApplication framerate went from a capped 60fps to a ~300fps.\r\n\r\nUpgrading to  SkiaSharp.Views.Forms version=\u00221.60.1\u0022 from version=\u00221.59.3\u0022\r\nUsing  SKGLView with  HasRenderLoop to true,\r\n\r\n### Expected behavior\r\n\r\nLike in version=\u00221.59.3\u0022 framerate should not go higher than 60fps\r\n\r\n### Actual behavior\r\n\r\nFramerate is not fixed, going from 60fps to 1000fps.\r\nIt modifies all the animations of the application that are frame based.\r\n\r\n### Basic Information\r\n\r\nFramerate is based on the elapsedTime between each PaintSurface event.\r\n\r\n- Version with issue:  1.60.1\r\n- Last known good version:  1.59.3\r\n- Xamarin Version :  Xamarin.Forms version=\u00223.0.0.446417\u0022\r\n- IDE:  Visual Studio Community 2017\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Android:  7 API 24\r\n- Target Devices:\r\n  -   Samsung galaxy S7 Edge\r\n",
  "author": {
    "login": "Suprndm",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "type/enhancement",
      "color": "84b6eb"
    },
    {
      "name": "status/help-wanted",
      "color": "B8EC4A"
    },
    {
      "name": "os/Android",
      "color": "fbca04"
    },
    {
      "name": "area/SkiaSharp.Views",
      "color": "0052cc"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    }
  ],
  "assignees": [],
  "createdAt": "2018-05-27T10:58:31",
  "updatedAt": "2026-02-11T13:47:57",
  "commentCount": 12,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-11T18:51:36.2408344Z",
    "reactions": [],
    "comments": [
      {
        "id": 392329785,
        "author": "mattleibow",
        "body": "This never was a feature. Maybe they changed something in Forms... Did you update to a newer forms version?\r\n\r\nSkiaSharp will always render as fast as possible, with as many frames as possible.\r\n\r\nDid you maybe change devices, OS versions or platform?\r\n\r\nI will have a look, but I don\u0027t think anything significant has changed.\r\n",
        "createdAt": "2018-05-27T13:07:21",
        "reactions": []
      },
      {
        "id": 392336322,
        "author": "mattleibow",
        "body": "I _see_ the change, and I think it has to do with the fact that we are no longer using the old \u0060GLSurfaceView\u0060 to render the content, but the new \u0060TextureView\u0060.\r\n\r\nUnfortunately, I can\u0027t seem to find where the original code limits the framerate. Also, I am not sure that we _want_ to limit the frame rate.\r\n\r\nI will look further and see what I can do.",
        "createdAt": "2018-05-27T14:44:08",
        "reactions": []
      },
      {
        "id": 392337391,
        "author": "Suprndm",
        "body": "Ok, I see\r\n\r\nI use Skiasharp as a game renderer. And the physical Engine of the game is based on the frame rate, which is wrong !\r\nIt should have a separated refresh rate based on time.\r\n\r\nI knew I had to make this change anytime soon. Now is just the perfect timing to do it =)\r\n\r\nI was curious about what produced this change. Thank you for the hints of answers. The current app impacted by this change makes a massive use of  \u0060SKCanvas.DrawBitmap(...)\u0060. It does mean that the perfomances of SkiaSharp have increased, which is very good !\r\n\r\nAs it is not really an issue, should I close now ?\r\n\r\n",
        "createdAt": "2018-05-27T14:58:35",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-11T18:51:34.4825621Z"
          },
          {
            "user": "entdark",
            "content": "\u002B1",
            "createdAt": "2026-02-11T18:51:34.4825628Z"
          }
        ]
      },
      {
        "id": 392337956,
        "author": "mattleibow",
        "body": "Let\u0027s leave it open, and I will try and find a real reason the \u0060GLSurfaceView\u0060 has a frame rate limit, but the \u0060TextureView\u0060 does not.\r\n\r\nJust for reference later on in life:\r\n\r\nThis is the code I used the measure the FPS:\r\n\r\n\u0060\u0060\u0060csharp\r\nStopwatch sw = Stopwatch.StartNew();\r\nTimeSpan last;\r\n\r\nprivate void OnPaint(object sender, SKPaintGLSurfaceEventArgs e)\r\n{\r\n    var c = sw.Elapsed;\r\n    var ts = c - last;\r\n    last = c;\r\n\r\n    var fps = 1.0 / (ts.TotalSeconds);\r\n    var fpsString = fps.ToString(\u00220,000.00\u0022);\r\n\r\n    Log.Debug(\u0022FPS\u0022, fpsString);\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2018-05-27T15:06:40",
        "reactions": []
      },
      {
        "id": 392338099,
        "author": "mattleibow",
        "body": "Also, with regards to the frame rate... It is never good to use a \u0022constant\u0022 frame rate - either an assumption or using some limiter API.\r\nThere is never a guarantee because another app may suddenly use the CPU/GPU, or particular logic in a particular frame may take longer to run, or even the time it takes to swap buffers may change between frames due to reasons.",
        "createdAt": "2018-05-27T15:08:49",
        "reactions": [
          {
            "user": "Suprndm",
            "content": "\u002B1",
            "createdAt": "2026-02-11T18:51:34.8690641Z"
          },
          {
            "user": "entdark",
            "content": "\u002B1",
            "createdAt": "2026-02-11T18:51:34.8690645Z"
          }
        ]
      },
      {
        "id": 664105794,
        "author": "mattleibow",
        "body": "I really need to look at this. Noticing 1.2K FPS in some emulators.\r\n\r\nA simple FPS snippet: https://gist.github.com/mattleibow/4eb9cd26bcaaaefd5b2f7499d21bf4bd",
        "createdAt": "2020-07-27T03:57:00",
        "reactions": []
      },
      {
        "id": 664335967,
        "author": "entdark",
        "body": "I mean, isn\u0027t that good to have the FPS uncapped. As a user of SkiaSharp for backend game renderer as well, I find it quiet good improvement.\r\nAlso if you are looking for the cause of capped vs uncapped FPS, then the explanation could be simple: GLSurfaceView probably uses V-Sync (*glSwapInterval call), when TextureView doesn\u0027t use that.",
        "createdAt": "2020-07-27T11:17:19",
        "reactions": []
      },
      {
        "id": 664339472,
        "author": "mattleibow",
        "body": "Having uncapped is nice, but a heavy drain. Also, it is no point having the updates faster than the screen - that wastes resources.\r\n\r\nIn the case of \u0022capping\u0022 it is usually with regards to the screen refresh rate.",
        "createdAt": "2020-07-27T11:25:15",
        "reactions": []
      },
      {
        "id": 664527988,
        "author": "mattleibow",
        "body": "We might be able to look at Choreographer: https://stackoverflow.com/questions/55028881/how-to-determine-device-screen-refresh-start-stop-on-mobile-devices \r\n\r\n\u0060\u0060\u0060java\r\nimport android.os.Handler;\r\nimport android.os.Looper;\r\nimport android.os.Message;\r\nimport android.view.Choreographer;\r\n\r\nprivate class DisplayFrameSync extends Thread implements Choreographer.FrameCallback {\r\n    private volatile Handler signal;\r\n    private Consumer\u003CLong\u003E update;\r\n\r\n    public DisplayFrameSync(Consumer\u003CLong\u003E update) {\r\n        super();\r\n\r\n        this.update = update;\r\n    }\r\n\r\n    @Override\r\n    public void run() {\r\n        setName(\u0022DisplayFrameSyncThread\u0022);\r\n\r\n        Looper.prepare();\r\n\r\n        signal = new Handler() {\r\n            public void handleMessage(Message msg) {\r\n                Looper.myLooper().quit();\r\n            }\r\n        };\r\n\r\n        Choreographer.getInstance().postFrameCallback(this);\r\n\r\n        Looper.loop();\r\n        Choreographer.getInstance().removeFrameCallback(this);\r\n    }\r\n\r\n    public void signal() {\r\n        if (this.signal != null) {\r\n            this.signal.sendEmptyMessage(0);\r\n            this.signal = null;\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void doFrame(long timeNano) {\r\n        if (this.update != null) {\r\n            this.update.accept(timeNano);\r\n        }\r\n\r\n        Choreographer.getInstance().postFrameCallback(this);\r\n    }\r\n}\r\n\u0060\u0060\u0060",
        "createdAt": "2020-07-27T17:19:35",
        "reactions": []
      },
      {
        "id": 927171666,
        "author": "kestlerio",
        "body": "I am getting \r\n\r\n* 140 fps on a Motorola Moto g6 (year 2018), API layer 28\r\nand even \r\n* 230 fps on a Galaxy Note 3 (year 2013), API layer 21 \uD83D\uDE1C\r\n\r\nMaybe this could also be useful:\r\nhttps://developer.android.com/games/sdk/frame-pacing\r\nIt mentions Choreographer as good but sub-optimal and suggests the Frame Pacing Library (which uses Choreographer but plus some additional optimizations).\r\n\r\nA little bit of a luxury problem, but as you said, it drains the battery unnecessarily.\r\n\r\nMatthew, can you point me into some code places in SkiaSharp where the Choreographer or even the Frame Pacing Library has to be put? I am quite unexperienced with this whole rendering thing and SkiaSharp, but would maybe have some time to experiment.\r\nOr would it have to be put into Xamarin.Forms even? \uD83D\uDE2E\r\n\r\nAnyway, this whole SkiaSharp is really an excelent piece of work! \uD83D\uDC31\u200D\uD83D\uDCBB",
        "createdAt": "2021-09-25T19:24:48",
        "reactions": []
      },
      {
        "id": 972706646,
        "author": "Oribow",
        "body": "Frame Pacing Library is going to be a headache to add to a Xamarin project, being a C\u002B\u002B library. Has anyone any experience with that? I know its possible, but probably not worth the hassle?\r\n\r\nI wonder how bad just using the choreographer is. Android calls it suboptimal, but what is suboptimal really? ;)\r\n\r\nI\u0027ve also looked at how monogame handles it frame pacing. \r\n[https://github.com/MonoGame/MonoGame/blob/fca271a296f0d2ebeec817a07c67dfd43139659f/MonoGame.Framework/Game.cs](Mono Game) They just use a timer setup. Could be enough?\r\n\r\nIts hard to find information on this. I guess not many people use skia with a renderloop.\r\n\r\n",
        "createdAt": "2021-11-18T09:52:31",
        "reactions": []
      },
      {
        "id": 2016494974,
        "author": "taublast",
        "body": "Would say Skiasharp not capping anything out-of-the box is rather a good thing. The more freedom we have the more we can create.\r\nFor capping FPS i could suggest the following code:\r\n\r\n\u0060\u0060\u0060\r\n// can exec this globally at app startup. \r\n// every canvas can subscribe then to \u0060OnFrame\u0060.\r\n\r\n protected static void SetupFrameLooper() \r\n {\r\n     Tasks.StartDelayed(TimeSpan.FromMilliseconds(1), async () =\u003E\r\n     {\r\n         await StartFrameLooperAsync(CancellationToken.None);\r\n     });\r\n }\r\n\r\n protected static async Task StartFrameLooperAsync(CancellationToken cancellationToken)\r\n {\r\n     var frameStopwatch = new Stopwatch();  \r\n     var loopStopwatch = Stopwatch.StartNew();  \r\n     long lastFrameEnd = loopStopwatch.ElapsedMilliseconds;\r\n     var targetIntervalMs = 1000.0 / 120.0; // target fps\r\n\r\n     while (!cancellationToken.IsCancellationRequested)\r\n     {\r\n         frameStopwatch.Restart(); // Start measuring frame execution time\r\n\r\n         // Render DrawnView\r\n         OnFrame?.Invoke(0);\r\n\r\n         frameStopwatch.Stop();  \r\n\r\n         var frameExecutionTimeMs = frameStopwatch.Elapsed.TotalMilliseconds;\r\n         var elapsedTimeSinceLastFrame = loopStopwatch.ElapsedMilliseconds - lastFrameEnd;\r\n         var timeToWait = targetIntervalMs - elapsedTimeSinceLastFrame - frameExecutionTimeMs;\r\n\r\n         if (timeToWait \u003E 0)\r\n             Thread.Sleep(TimeSpan.FromMilliseconds(timeToWait));\r\n\r\n         lastFrameEnd = loopStopwatch.ElapsedMilliseconds;\r\n     }\r\n }\r\n\u0060\u0060\u0060\r\n\r\nIn your callback you could check if the frame is dirty/other checks and invalidate the canvas in a proper way.  ",
        "createdAt": "2024-03-23T13:26:15",
        "reactions": []
      }
    ]
  }
}