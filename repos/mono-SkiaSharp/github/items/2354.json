{
  "number": 2354,
  "type": "issue",
  "state": "open",
  "title": "[BUG] SKBitmap.GetPixel ignores color space whereas SetPixel respects it",
  "body": "**Disclaimer**\r\n\r\nI know that \u0060GetPixel\u0060 is directly [exposed](https://github.com/mono/SkiaSharp/blob/1131738c9b89212ae53e6d33d994a9480d77a3c8/binding/Binding/SkiaApi.generated.cs#L1091) by the Skia API, whereas there is no \u0022official\u0022 \u0060SetPixel\u0060 and it uses \u0060SKCanvas.DrawPoint\u0060 in the background. Still, it would be desirable for \u0060GetPixel\u0060 to reverse the transformations that \u0060SetPixel\u0060 performs (if the color type/space allows it).\r\n\r\n**Description**\r\n\r\n\u0060SKBitmap.SetPixel\u0060 (and the drawing operations by \u0060SKCanvas\u0060 that use \u0060SKColor\u0060) always treat \u0060SKColor\u0060 as an unpremultiplied sRGB color and they perform every necessary transformation as per the color space, but \u0060SKBitmap.GetPixel\u0060 ignores the \u0060SKImageInfo.ColorSpace\u0060 property (respects only \u0060SKColorType\u0060 and \u0060SKAlphaType\u0060) and may return a completely invalid color.\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060cs\r\nprivate static object[] ColorSpaceTestSource { get; } =\r\n{\r\n    new object[] { SKColorType.Bgra8888, SKAlphaType.Unpremul, SKColorSpace.CreateSrgb() }, // OK\r\n    new object[] { SKColorType.Bgra8888, SKAlphaType.Premul, SKColorSpace.CreateSrgb() },   // OK\r\n    new object[] { SKColorType.RgbaF16, SKAlphaType.Premul, SKColorSpace.CreateSrgb() },    // OK\r\n    new object[] { SKColorType.Bgra8888, SKAlphaType.Unpremul, SKColorSpace.CreateSrgbLinear() }, // Fail\r\n    new object[] { SKColorType.Bgra8888, SKAlphaType.Premul, SKColorSpace.CreateRgb(SKColorSpaceTransferFn.Srgb, SKColorSpaceXyz.AdobeRgb) }, // Fail\r\n};\r\n\r\n[TestCaseSource(nameof(ColorSpaceTestSource))]\r\npublic void ColorSpaceTest(SKColorType colorType, SKAlphaType alphaType, SKColorSpace colorSpace)\r\n{\r\n    var testColor = new SKColor(red: 128, green: 255, blue: 64, alpha: 128);\r\n    using var bitmap = new SKBitmap(new SKImageInfo(1, 1, colorType, alphaType, colorSpace));\r\n    bitmap.SetPixel(0, 0, testColor);\r\n    Assert.AreEqual(testColor, bitmap.GetPixel(0, 0));\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\n\u0060GetPixel\u0060 should return an unpremultiplied sRGB color even if the color space transfer function or color space XYZ is not sRGB.\r\n\r\n**Actual Behavior**\r\n\r\n\u0060GetPixel\u0060 successfully unpremultiplies the color if needed but fails to convert linear gamma or any non-sRGB color space to sRGB.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.3\r\n- Last known good version:  Don\u0027t know, maybe never worked\r\n- IDE:  Visual Studio\r\n- Platform Target Frameworks:\r\n  - Windows Classic: Windows 10/11\r\n  - Linux:  Ubuntu 22.04\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - Google Pixel 5 (Android Emulator on Windows)\r\n  \r\n**Known workaround**\r\n\r\nA very inefficient workaround is to create a 1x1 pixel sRGB Bgra8888/Unpremul bitmap, wrap it into a new \u0060SKCanvas\u0060, copy that single pixel area into the temp bitmap, and then read the result by \u0060GetPixel\u0060 on the temp bitmap.\r\n\r\n**Possible solutions, API changes**\r\n\r\nI don\u0027t know if there is anyone who relies on the current behavior but maybe a new \u0060GetPixel(int x, int y, bool forceSrgb)\u0060 overload could be introduced. Or a new \u0060GetPixelSrgb(int x, int y)\u0060 method.\r\n\r\nAnd I also don\u0027t know if this could be solved by calling some trivial API exposed by Skia, or it should be implemented at the C# side. Maybe for the default linear color space I could use the formula [mentioned](https://learn.microsoft.com/en-us/dotnet/api/skiasharp.skcolorspacetransferfn?f1url=%3FappId%3DDev16IDEF1%26l%3DEN-US%26k%3Dk(SkiaSharp.SKColorSpaceTransferFn)%3Bk(SolutionItemsProject)%3Bk(DevLang-csharp)%26rd%3Dtrue\u0026view=skiasharp-2.88#remarks) in the documentation but I have no idea how I should use any custom \u0060SKColorSpaceXyz\u0060 coefficients (the [documentation](https://learn.microsoft.com/en-us/dotnet/api/skiasharp.skcolorspacexyz?view=skiasharp-2.88) literally does not say anything about this) or what I could do if \u0060SKColorSpace.IsNumericalTransferFunction\u0060 returns \u0060false\u0060.",
  "author": {
    "login": "koszeggy",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2023-01-05T15:47:26",
  "updatedAt": "2023-01-05T15:47:26",
  "commentCount": 0,
  "reactionCount": 1
}