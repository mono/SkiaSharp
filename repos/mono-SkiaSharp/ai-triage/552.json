{
  "meta": {
    "schemaVersion": "3.0",
    "number": 552,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-22T12:00:00Z"
  },
  "summary": "Investigate reusing SKSurface instances across draw calls in view implementations to improve performance",
  "classification": {
    "type": {
      "value": "type/enhancement",
      "confidence": 0.95
    },
    "area": {
      "value": "area/views",
      "confidence": 0.95
    }
  },
  "evidence": {
    "reproEvidence": {
      "codeSnippets": [
        "text: It appears the constructing a SKSurface is expensive, so we should see if we can reuse instances across draws."
      ]
    }
  },
  "analysis": {
    "summary": "This is a self-filed enhancement by the maintainer (mattleibow) to investigate reusing SKSurface instances across draw calls in SkiaSharp view implementations. The concern is that SKSurface.Create() has non-trivial cost per frame. Code investigation shows inconsistent patterns across platforms — GTK3 already reuses surfaces, while WPF, WinUI, Blazor, and Android create new ones per frame.",
    "rationale": "type: The issue explicitly asks to improve existing view implementations by reusing SKSurface instances. This is an optimization of existing functionality, not a new feature or a bug fix. The existing labels correctly classify this. area: The enhancement targets SKSurface usage in view implementations across platforms (WPF, Android, iOS, GTK, WinUI, Blazor). All affected code is in the SkiaSharp.Views package family. tenets: The core concern is rendering performance — reducing per-frame allocation cost of SKSurface.Create(). This is a pure performance optimization. fixStatus.likelyFixed: GTK3 SKDrawingArea already reuses surfaces (the desired pattern exists), but WPF, WinUI, Blazor, Apple, and Android views still create new SKSurface each frame. The enhancement is partially addressed but not systematically applied across all platforms. versionAnalysis.currentRelevance: The per-frame SKSurface.Create() pattern still exists in most view implementations. The performance concern about allocation cost is architecture-level and hasn't been obsoleted by any Skia or .NET changes. actionability.suggestedAction: This is a legitimate performance enhancement filed by the maintainer. The investigation is still valid — most view platforms haven't adopted the surface-reuse pattern that GTK3 already uses. No reason to close.",
    "codeInvestigation": [
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.Gtk3/SKDrawingArea.cs",
        "lines": "12-88",
        "finding": "GTK3 view ALREADY implements surface reuse — stores SKSurface as a field and only recreates when size changes (line 78-88). This is the target pattern the enhancement wants to adopt across all views.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Apple/SKCGSurfaceFactory.cs",
        "lines": "25-66",
        "finding": "Apple factory reuses backing NSMutableData buffer when size unchanged (line 42-46), but still calls SKSurface.Create() each frame (line 66). Partial reuse — buffer allocated once, surface object recreated.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SurfaceFactory.cs",
        "lines": "30-57",
        "finding": "Android factory reuses Bitmap but creates new SKSurface each frame (line 50) and explicitly disposes it in DrawSurface (line 57). No surface reuse.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WPF/SKElement.cs",
        "lines": "63-83",
        "finding": "WPF creates new SKSurface each frame with 'using' statement (line 73). Reuses WriteableBitmap but not the surface. No surface reuse.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/SKXamlCanvas.cs",
        "lines": "195",
        "finding": "WinUI creates new SKSurface each frame with 'using' statement. Same pattern as WPF — no surface reuse.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.Blazor/SKCanvasView.razor.cs",
        "lines": "95",
        "finding": "Blazor creates new SKSurface each frame with 'using' statement. No surface reuse.",
        "relevance": "related"
      }
    ],
    "nextQuestions": [
      "Whether SKSurface.Create() wrapping an existing memory buffer is actually expensive enough to warrant the complexity of caching the surface object (vs just caching the backing buffer)",
      "Whether reusing SKSurface has correctness implications — the surface's internal state (canvas, dirty regions) may need resetting between frames",
      "Whether modern Skia versions have optimized SKSurface creation enough to make this enhancement low-priority"
    ],
    "resolution": {
      "hypothesis": "SKSurface.Create() has non-trivial per-call overhead even when wrapping pre-allocated memory. Caching the surface object (as GTK3 does) and only recreating on size change would reduce per-frame allocation pressure across all view platforms.",
      "proposals": [
        {
          "description": "Refactor WPF, WinUI, Blazor, Apple, and Android view implementations to store SKSurface as a field and only recreate when the backing buffer size changes, matching the existing GTK3 SKDrawingArea pattern. Requires careful handling of surface disposal on size change and view teardown.",
          "confidence": 0.8,
          "effort": "medium"
        },
        {
          "description": "Before refactoring all views, profile SKSurface.Create() with pre-allocated memory to measure actual per-call cost. If the cost is negligible in current Skia, the enhancement may be deprioritized. Use BenchmarkDotNet with varying surface sizes.",
          "confidence": 0.85,
          "effort": "small"
        },
        {
          "description": "Create a shared internal SurfaceCache class (like SurfaceFactory but with surface reuse) that all view implementations can use. Centralizes the caching logic and ensures consistent behavior across platforms. Reduces per-platform maintenance.",
          "confidence": 0.7,
          "effort": "medium"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "keep-open",
      "confidence": 0.88,
      "reason": "Legitimate performance enhancement filed by maintainer. Most view platforms still use per-frame SKSurface creation. The enhancement is partially implemented (GTK3) but not systematically applied."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add tenet/performance label to reflect the performance optimization nature of this enhancement",
        "risk": "low",
        "confidence": 0.92,
        "labels": [
          "tenet/performance"
        ]
      }
    ]
  }
}
