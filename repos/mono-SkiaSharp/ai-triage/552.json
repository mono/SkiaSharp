{
  "meta": {
    "schemaVersion": "2.1",
    "number": 552,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-22T12:00:00Z",
    "currentLabels": ["type/enhancement", "area/SkiaSharp.Views"]
  },
  "summary": "Investigate reusing SKSurface instances across draw calls in view implementations to improve performance",
  "classification": {
    "type": { "value": "type/enhancement", "confidence": 0.95 },
    "area": { "value": "area/SkiaSharp.Views", "confidence": 0.95 },
    "backends": null,
    "platforms": null,
    "tenets": [{ "value": "tenet/performance", "confidence": 0.92 }],
    "partner": null
  },
  "evidence": {
    "bugSignals": null,
    "reproEvidence": {
      "relatedIssues": [534],
      "codeSnippets": [
        {
          "language": "text",
          "code": "It appears the constructing a SKSurface is expensive, so we should see if we can reuse instances across draws.",
          "context": "Issue description — the core observation motivating this enhancement"
        }
      ]
    },
    "versionAnalysis": {
      "reason": "Filed against SkiaSharp 1.x era (June 2018). The underlying performance concern about SKSurface construction cost remains relevant in current SkiaSharp — some views still create new SKSurface each frame (WPF, WinUI, Blazor, Android) while GTK3 already reuses surfaces. The enhancement is still applicable.",
      "currentRelevance": "likely"
    },
    "regression": null,
    "fixStatus": {
      "likelyFixed": false,
      "confidence": 0.80,
      "reason": "Partially addressed. GTK3 SKDrawingArea already reuses SKSurface across draws when size is unchanged. Apple SKCGSurfaceFactory reuses backing memory but still creates new SKSurface per draw. WPF SKElement, WinUI SKXamlCanvas, Blazor SKCanvasView, and Android SurfaceFactory all create new SKSurface each frame. The inconsistency across platforms means the enhancement is not fully implemented.",
      "verificationStatus": "inconclusive"
    }
  },
  "analysis": {
    "summary": "This is a self-filed enhancement by the maintainer (mattleibow) to investigate reusing SKSurface instances across draw calls in SkiaSharp view implementations. The concern is that SKSurface.Create() has non-trivial cost per frame. Code investigation shows inconsistent patterns across platforms — GTK3 already reuses surfaces, while WPF, WinUI, Blazor, and Android create new ones per frame.",
    "keySignals": [
      { "text": "It appears the constructing a SKSurface is expensive, so we should see if we can reuse instances across draws.", "source": "body", "interpretation": "Maintainer has profiled or observed that SKSurface construction is a hot path in view rendering." },
      { "text": "Here is PR that was created to improve drawing: #534", "source": "body", "interpretation": "References GTK rendering performance issue — suggests this enhancement was motivated by real-world slow rendering reports." },
      { "text": "Filed by mattleibow (maintainer)", "source": "labels", "interpretation": "Self-filed enhancement — high signal that this is a legitimate performance concern from someone who knows the codebase." }
    ],
    "codeInvestigation": [
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views.Gtk3/SKDrawingArea.cs", "lines": "12-88", "relevance": "GTK3 view ALREADY implements surface reuse — stores SKSurface as a field and only recreates when size changes (line 78-88). This is the target pattern the enhancement wants to adopt across all views." },
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Apple/SKCGSurfaceFactory.cs", "lines": "25-66", "relevance": "Apple factory reuses backing NSMutableData buffer when size unchanged (line 42-46), but still calls SKSurface.Create() each frame (line 66). Partial reuse — buffer allocated once, surface object recreated." },
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SurfaceFactory.cs", "lines": "30-57", "relevance": "Android factory reuses Bitmap but creates new SKSurface each frame (line 50) and explicitly disposes it in DrawSurface (line 57). No surface reuse." },
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views.WPF/SKElement.cs", "lines": "63-83", "relevance": "WPF creates new SKSurface each frame with 'using' statement (line 73). Reuses WriteableBitmap but not the surface. No surface reuse." },
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/SKXamlCanvas.cs", "lines": "195", "relevance": "WinUI creates new SKSurface each frame with 'using' statement. Same pattern as WPF — no surface reuse." },
      { "file": "source/SkiaSharp.Views/SkiaSharp.Views.Blazor/SKCanvasView.razor.cs", "lines": "95", "relevance": "Blazor creates new SKSurface each frame with 'using' statement. No surface reuse." }
    ],
    "fieldRationales": [
      { "field": "type", "chosen": "type/enhancement", "expandedReason": "The issue explicitly asks to improve existing view implementations by reusing SKSurface instances. This is an optimization of existing functionality, not a new feature or a bug fix. The existing labels correctly classify this.", "alternatives": [{ "value": "type/feature-request", "whyRejected": "Not requesting new functionality — the views already work, this is about making them faster." }] },
      { "field": "area", "chosen": "area/SkiaSharp.Views", "expandedReason": "The enhancement targets SKSurface usage in view implementations across platforms (WPF, Android, iOS, GTK, WinUI, Blazor). All affected code is in the SkiaSharp.Views package family." },
      { "field": "tenets", "chosen": "tenet/performance", "expandedReason": "The core concern is rendering performance — reducing per-frame allocation cost of SKSurface.Create(). This is a pure performance optimization." },
      { "field": "fixStatus.likelyFixed", "chosen": "false", "expandedReason": "GTK3 SKDrawingArea already reuses surfaces (the desired pattern exists), but WPF, WinUI, Blazor, Apple, and Android views still create new SKSurface each frame. The enhancement is partially addressed but not systematically applied across all platforms." },
      { "field": "versionAnalysis.currentRelevance", "chosen": "likely", "expandedReason": "The per-frame SKSurface.Create() pattern still exists in most view implementations. The performance concern about allocation cost is architecture-level and hasn't been obsoleted by any Skia or .NET changes." },
      { "field": "actionability.suggestedAction", "chosen": "keep-open", "expandedReason": "This is a legitimate performance enhancement filed by the maintainer. The investigation is still valid — most view platforms haven't adopted the surface-reuse pattern that GTK3 already uses. No reason to close." }
    ],
    "uncertainties": [
      "Whether SKSurface.Create() wrapping an existing memory buffer is actually expensive enough to warrant the complexity of caching the surface object (vs just caching the backing buffer)",
      "Whether reusing SKSurface has correctness implications — the surface's internal state (canvas, dirty regions) may need resetting between frames",
      "Whether modern Skia versions have optimized SKSurface creation enough to make this enhancement low-priority"
    ],
    "assumptions": [
      "Assumed the performance concern in the 2018 issue remains relevant since the same SKSurface.Create() pattern is still used in most views",
      "Assumed GTK3 SKDrawingArea's surface reuse pattern is the reference implementation since it's the only view that caches the SKSurface object"
    ],
    "resolution": {
      "hypothesis": "SKSurface.Create() has non-trivial per-call overhead even when wrapping pre-allocated memory. Caching the surface object (as GTK3 does) and only recreating on size change would reduce per-frame allocation pressure across all view platforms.",
      "proposals": [
        { "title": "Adopt GTK3 surface-reuse pattern across all views", "description": "Refactor WPF, WinUI, Blazor, Apple, and Android view implementations to store SKSurface as a field and only recreate when the backing buffer size changes, matching the existing GTK3 SKDrawingArea pattern. Requires careful handling of surface disposal on size change and view teardown.", "confidence": 0.80, "effort": "medium", "category": "fix", "validated": "untested" },
        { "title": "Benchmark SKSurface.Create() to quantify the gain", "description": "Before refactoring all views, profile SKSurface.Create() with pre-allocated memory to measure actual per-call cost. If the cost is negligible in current Skia, the enhancement may be deprioritized. Use BenchmarkDotNet with varying surface sizes.", "confidence": 0.85, "effort": "low", "category": "investigation", "validated": "untested" },
        { "title": "Extract shared SurfaceCache utility", "description": "Create a shared internal SurfaceCache class (like SurfaceFactory but with surface reuse) that all view implementations can use. Centralizes the caching logic and ensures consistent behavior across platforms. Reduces per-platform maintenance.", "confidence": 0.70, "effort": "medium", "category": "fix", "validated": "untested" }
      ],
      "recommendedProposal": "Benchmark SKSurface.Create() to quantify the gain",
      "recommendedReason": "Before investing effort in refactoring all platform views, a quick benchmark would confirm whether the optimization is still worthwhile with current Skia versions. If significant, proceed with the shared SurfaceCache approach."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "keep-open",
      "confidence": 0.88,
      "reason": "Legitimate performance enhancement filed by maintainer. Most view platforms still use per-frame SKSurface creation. The enhancement is partially implemented (GTK3) but not systematically applied."
    },
    "actions": [
      {
        "id": "labels-1",
        "type": "update-labels",
        "risk": "low",
        "description": "Add tenet/performance label to reflect the performance optimization nature of this enhancement",
        "reason": "Current labels correctly have type/enhancement and area/SkiaSharp.Views but miss the performance tenet which is the core concern",
        "confidence": 0.92,
        "dependsOn": null,
        "payload": {
          "labelsToAdd": ["tenet/performance"],
          "labelsToRemove": []
        }
      }
    ]
  }
}
