{
  "meta": {
    "schemaVersion": "2.0",
    "number": 2511,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-24T12:00:00Z",
    "currentLabels": []
  },
  "summary": "AccessViolationException in finalizer thread when closing WinForms app — duplicate of #2194, fixed in v2.88.1",
  "classification": {
    "type": { "value": "type/bug", "confidence": 0.95 },
    "area": { "value": "area/SkiaSharp", "confidence": 0.92 },
    "backends": null,
    "platforms": [{ "value": "os/Windows-Classic", "confidence": 0.93 }],
    "tenets": [{ "value": "tenet/reliability", "confidence": 0.95 }],
    "partner": null
  },
  "evidence": {
    "bugSignals": {
      "hasCrash": true,
      "hasStackTrace": true,
      "reproQuality": "none",
      "hasWorkaround": true,
      "workaroundSummary": "Explicitly dispose all SkiaSharp objects before application exit instead of relying on finalizers, or upgrade to SkiaSharp v2.88.1+ which includes the fix from PR #2195.",
      "severity": "high",
      "severityReason": "Uncatchable AccessViolationException crashes the application during shutdown. However, a fix already exists in v2.88.1."
    },
    "reproEvidence": {
      "relatedIssues": [2194, 1817],
      "stepsToReproduce": [
        "Use SkiaSharp in a WinForms application on Windows (version prior to v2.88.1)",
        "Create and use SKObject-derived instances without explicit disposal",
        "Close the application, allowing finalizers to run"
      ],
      "environmentDetails": "Windows, WinForms application. No SkiaSharp version specified by reporter."
    },
    "versionAnalysis": {
      "currentRelevance": "unlikely",
      "reason": "The exact crash (AccessViolationException in NonAlertableWin32Lock.EnterCriticalSection during finalization) was fixed in PR #2195, released in v2.88.1. The current code has null guards on the critical section pointer before calling EnterCriticalSection. Reporter did not specify a version, but the identical stack trace to #2194 strongly suggests they were running a version before the fix."
    },
    "regression": null,
    "fixStatus": {
      "likelyFixed": true,
      "confidence": 0.90,
      "reason": "PR #2195 added null checks to NonAlertableWin32Lock.Enter() and Leave() methods, preventing AccessViolationException when the critical section has already been finalized. This fix shipped in v2.88.1. The stack trace in #2511 is identical to #2194.",
      "relatedPRs": [2195],
      "fixedInVersion": "2.88.1",
      "verificationStatus": "unverified"
    }
  },
  "analysis": {
    "summary": "This is a duplicate of #2194. The crash occurs because .NET finalizer ordering is non-deterministic — during app shutdown, the NonAlertableWin32Lock's finalizer can destroy the Win32 CRITICAL_SECTION before other SKNativeObject finalizers finish deregistering their handles. PR #2195 fixed this by adding null guards on the critical section pointer. The reporter provided no version info but the stack trace is byte-for-byte identical to the fixed issue.",
    "keySignals": [
      { "text": "System.AccessViolationException at NonAlertableWin32Lock.EnterCriticalSection", "source": "stack-trace", "interpretation": "Identical crash signature to #2194 — critical section accessed after finalization" },
      { "text": "SKNativeObject.Finalize() at bottom of stack", "source": "stack-trace", "interpretation": "Crash happens during GC finalization, not during normal usage — classic finalizer ordering problem" },
      { "text": "When I close my winform program", "source": "body", "interpretation": "App shutdown triggers GC finalization of all remaining objects, exposing the race condition" },
      { "text": "what is the problem?", "source": "body", "interpretation": "Reporter is asking for diagnosis, not reporting a specific repro — minimal information provided" }
    ],
    "fieldRationales": [
      { "field": "type", "chosen": "type/bug", "expandedReason": "Reporter describes an AccessViolationException crash during normal app shutdown. This is clearly broken behavior — finalizer cleanup should not crash.", "alternatives": [{ "value": "type/question", "whyRejected": "While phrased as a question ('what is the problem?'), the core content is a crash report with a stack trace." }] },
      { "field": "area", "chosen": "area/SkiaSharp", "expandedReason": "The crash is in SkiaSharp's core HandleDictionary and PlatformLock infrastructure, not in any specific view or platform package.", "alternatives": [{ "value": "area/SkiaSharp.Views", "whyRejected": "Stack trace does not involve any Views components — the crash is in core object disposal." }] },
      { "field": "bugSignals.severity", "chosen": "high", "expandedReason": "AccessViolationException is uncatchable and terminates the process. However, it only occurs during app shutdown and a fix exists, which prevents it from being critical." },
      { "field": "actionability.suggestedAction", "chosen": "close-as-duplicate", "expandedReason": "The stack trace is identical to #2194. PR #2195 fixed this exact issue in v2.88.1. The issue was already closed with zero comments, confirming it was recognized as a known/fixed issue." }
    ],
    "uncertainties": ["Reporter did not specify SkiaSharp version — cannot confirm they were on a pre-fix version", "No .NET framework version specified — unclear if .NET Framework or .NET Core"],
    "assumptions": ["Reporter was using a SkiaSharp version prior to v2.88.1 based on the identical stack trace to the fixed issue #2194"],
    "resolution": null
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-as-duplicate",
      "confidence": 0.90,
      "reason": "Identical stack trace to #2194, which was fixed in PR #2195 (v2.88.1). Issue was already closed with no comments."
    },
    "actions": [
      {
        "id": "labels-1", "type": "update-labels", "risk": "low",
        "description": "Apply bug, core SkiaSharp, Windows, and reliability labels",
        "reason": "Matches classification — crash in core SkiaSharp on Windows during finalization",
        "confidence": 0.92, "dependsOn": null,
        "payload": {
          "labelsToAdd": ["type/bug", "area/SkiaSharp", "os/Windows-Classic", "tenet/reliability"],
          "labelsToRemove": []
        }
      },
      {
        "id": "dup-1", "type": "link-duplicate", "risk": "medium",
        "description": "Mark as duplicate of #2194",
        "reason": "Byte-for-byte identical stack trace — same finalizer ordering crash in NonAlertableWin32Lock",
        "confidence": 0.90, "dependsOn": null,
        "payload": { "duplicateOf": 2194, "comment": null }
      },
      {
        "id": "comment-1", "type": "add-comment", "risk": "high",
        "description": "Post duplicate notice with upgrade guidance",
        "reason": "Let reporter know the issue is tracked and fixed",
        "confidence": 0.85, "dependsOn": "dup-1",
        "payload": {
          "commentType": "duplicate-notice",
          "draftBody": "Thanks for the stack trace — this is a known finalizer ordering issue on Windows that was tracked in #2194 and fixed in PR #2195.\n\nThe crash happens because the Win32 critical section used by SkiaSharp's handle dictionary can be finalized before other SkiaSharp objects during app shutdown. This was fixed in SkiaSharp v2.88.1 by adding null guards on the critical section pointer.\n\nIf you're able to upgrade to v2.88.1 or later, this should be resolved. Closing as a duplicate of #2194.",
          "requiresHumanEdit": true,
          "finalBody": null,
          "dedupeToken": "triage-2511-comment-1"
        }
      },
      {
        "id": "close-1", "type": "close-issue", "risk": "medium",
        "description": "Close as duplicate of #2194",
        "reason": "Fixed in v2.88.1, identical to tracked issue",
        "confidence": 0.90, "dependsOn": "comment-1",
        "payload": { "reason": "not_planned", "comment": null }
      }
    ]
  }
}
