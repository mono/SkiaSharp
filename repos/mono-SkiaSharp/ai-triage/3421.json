{
  "meta": {
    "schemaVersion": "3.0",
    "number": 3421,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-25T12:00:00Z",
    "currentLabels": ["type/bug", "os/Windows-Classic", "area/SkiaSharp", "tenet/reliability"]
  },
  "summary": "User reports that loading a .lottie file via SkiaSharp.Skottie.Animation.Create() returns null silently. The .lottie format (dotLottie) is a ZIP archive containing Lottie JSON and associated assets, while Skottie's parser expects raw Lottie JSON data. The null return is expected behavior — the JSON parser fails because the input is a ZIP binary, not JSON text. The user needs to extract the Lottie JSON from the .lottie archive before passing it to the Skottie API.",
  "classification": {
    "type": {
      "value": "type/question",
      "confidence": 0.85
    },
    "area": {
      "value": "area/skottie",
      "confidence": 0.95
    },
    "platforms": ["os/Windows-Classic"]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Download a .lottie file from LottieFiles",
        "Call SkiaSharp.Skottie.Animation.Create(sourceFileAbsolute) with the .lottie file path",
        "Observe that the returned Animation is null"
      ],
      "codeSnippets": [
        "var animation = SkiaSharp.Skottie.Animation.Create(sourceFileAbsolute);"
      ],
      "screenshots": [
        {
          "url": "https://github.com/user-attachments/assets/9ca27c18-536b-4403-a41d-44e907329001",
          "description": "LottieFiles download page showing the .lottie file"
        },
        {
          "url": "https://github.com/user-attachments/assets/0fe1691c-82ee-462a-a110-f53b0682833f",
          "description": "Debugger showing Animation.Create returns null"
        }
      ],
      "environmentDetails": "Windows 11 Desktop, Visual Studio (Windows), SkiaSharp 3.116.0"
    },
    "versionAnalysis": {
      "mentionedVersions": ["3.116.0"]
    }
  },
  "analysis": {
    "summary": "The .lottie file format (dotLottie) is a ZIP archive that packages Lottie JSON animations along with embedded assets (images, fonts). Skottie's Animation.Create() reads the file bytes and passes them directly to the C++ JSON parser (skjson::DOM), which expectsraw JSON text. When given ZIP binary data, the JSON parser fails and returns nullptr, which surfaces as a null Animation in C#. This is working as designed — Skottie supports Lottie JSON format (.json), not the dotLottie container format (.lottie). The user needs to extract the Lottie JSON from the .lottie ZIP archive before loading.",
    "rationale": "Classified as type/question rather than type/bug because the API is working correctly — it returns null for unparseable input, which is the documented factory-method failure pattern. The .lottie format is a different container format that Skottie does not support, similar to how SKImage.FromEncodedData returns null for unsupported formats. Area is area/skottie since the issue is entirely within the Skottie animation parsing layer. Platform is Windows but the behavior is cross-platform — the .lottie format would fail identically on all platforms.",
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp.Skottie/Animation.cs",
        "lines": "91-102",
        "finding": "Animation.Create(string path) loads the file via SKData.Create(path) and delegates to TryCreate(SKData), which passes raw bytes to skottie_animation_make_from_data. No format detection or decompression is performed — the bytes are sent directly to the JSON parser.",
        "relevance": "direct"
      },
      {
        "file": "binding/SkiaSharp.Skottie/Animation.cs",
        "lines": "77-89",
        "finding": "TryCreate(SKData) strips any UTF BOM preamble then passes raw bytes to the native skottie_animation_make_from_data function. If the native call returns IntPtr.Zero (nullptr), the method returns null. This is the factory-null-on-failure pattern documented in SkiaSharp conventions.",
        "relevance": "direct"
      },
      {
        "file": "externals/skia/modules/skottie/src/Skottie.cpp",
        "lines": "349-370",
        "finding": "The C++ Builder::make() function creates a skjson::DOM from the raw data. If the JSON parse fails or the root is not an object, it logs 'Failed to parse JSON input' and returns nullptr. ZIP binary data would fail at this JSON parse step.",
        "relevance": "direct"
      },
      {
        "file": "externals/skia/modules/skottie/src/Skottie.cpp",
        "lines": "433-438",
        "finding": "makeFromFile reads the entire file into an SkData then calls make() with raw bytes. No file extension checking or format detection — purely JSON-based parsing.",
        "relevance": "related"
      },
      {
        "file": "tests/Tests/Skottie/AnimationTest.cs",
        "lines": "11-16",
        "finding": "All test files are .json format (LottieLogo1.json, LottieLogo1_bom.json). No .lottie format test files exist, confirming that dotLottie is not a supported format.",
        "relevance": "context"
      }
    ],
    "workarounds": [
      "Extract the Lottie JSON from the .lottie ZIP archive using System.IO.Compression.ZipArchive, then pass the JSON string to Animation.Parse() or the extracted stream to Animation.Create(Stream).",
      "Download the Lottie JSON format (.json) directly from LottieFiles instead of the .lottie (dotLottie) format — LottieFiles offers both formats on their download panel."
    ],
    "nextQuestions": [
      "Should SkiaSharp add built-in dotLottie (.lottie ZIP) support with automatic extraction?",
      "Would a clearer error message (instead of silent null) be valuable when non-JSON data is passed to Skottie?"
    ],
    "resolution": {
      "hypothesis": "The .lottie file is a ZIP archive, not raw JSON. Skottie's parser expects JSON and correctly returns null for non-JSON input. The user needs to either extract the JSON from the archive or download the JSON format directly.",
      "proposals": [
        {
          "description": "Extract the Lottie JSON from the .lottie ZIP archive programmatically using System.IO.Compression.ZipArchive. The JSON animation file is typically at 'animations/<id>.json' inside the archive. Pass the extracted JSON to Animation.Parse() or Animation.Create(Stream).",
          "confidence": 0.95,
          "effort": "trivial"
        },
        {
          "description": "Download the Lottie JSON format directly from LottieFiles instead of the .lottie format. The LottieFiles download panel offers both .json and .lottie options.",
          "confidence": 0.95,
          "effort": "trivial"
        },
        {
          "description": "Add dotLottie (.lottie) support to SkiaSharp.Skottie by detecting ZIP magic bytes and auto-extracting the JSON before parsing. This would be a feature enhancement for future versions.",
          "confidence": 0.6,
          "effort": "medium"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.85,
      "reason": "The API is working as designed. The .lottie format is a ZIP container not supported by Skottie, which expects raw Lottie JSON. A clear workaround exists (extract JSON from ZIP or download JSON format directly)."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Reclassify as question about .lottie format support, add skottie area label",
        "risk": "low",
        "confidence": 0.85,
        "labels": ["type/question", "area/SkiaSharp", "os/Windows-Classic"]
      },
      {
        "type": "add-comment",
        "description": "Explain .lottie vs .json format difference and provide extraction workaround",
        "risk": "high",
        "confidence": 0.85,
        "comment": "Thanks for the report.\n\nThe `.lottie` file format (also called dotLottie) is a ZIP archive that packages the Lottie JSON animation along with embedded assets. SkiaSharp's Skottie module expects raw Lottie JSON data, so passing a `.lottie` file directly will return `null` because the JSON parser can't read ZIP binary data.\n\nHere's a workaround — extract the JSON from the `.lottie` archive before loading:\n\n```csharp\nusing System.IO.Compression;\n\nusing var zip = ZipFile.OpenRead(\"animation.lottie\");\nvar entry = zip.Entries.FirstOrDefault(e => e.FullName.EndsWith(\".json\") && e.FullName.StartsWith(\"animations/\"));\nif (entry != null)\n{\n    using var stream = entry.Open();\n    var animation = SkiaSharp.Skottie.Animation.Create(stream);\n}\n```\n\nAlternatively, LottieFiles offers a direct JSON download option — choosing the `.json` format instead of `.lottie` on their download panel will give you a file that works directly with `Animation.Create()`.\n\nNote that embedded assets (images referenced by the animation) may not load when using the extracted JSON alone — you may need to set up a `ResourceProvider` via `AnimationBuilder` to resolve those."
      },
      {
        "type": "link-related",
        "description": "Cross-reference #3242 which is a related but different Skottie rendering issue",
        "risk": "low",
        "confidence": 0.7,
        "linkedIssue": 3242
      }
    ]
  }
}
