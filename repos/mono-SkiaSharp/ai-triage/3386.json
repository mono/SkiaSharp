{
  "meta": {
    "schemaVersion": "2.0",
    "number": 3386,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-25T12:00:00Z",
    "currentLabels": ["type/bug", "os/Linux", "area/libSkiaSharp.native", "tenet/compatibility"]
  },
  "summary": "DllNotFoundException for libSkiaSharp when deploying to Azure Container App via .NET Aspire — NoDependencies package binary not deployed, wrong variant loaded",
  "classification": {
    "type": { "value": "type/bug", "confidence": 0.92 },
    "area": { "value": "area/libSkiaSharp.native", "confidence": 0.95 },
    "backends": null,
    "platforms": [{ "value": "os/Linux", "confidence": 0.95 }],
    "tenets": [
      { "value": "tenet/compatibility", "confidence": 0.85 },
      { "value": "tenet/reliability", "confidence": 0.80 }
    ],
    "partner": null
  },
  "evidence": {
    "bugSignals": {
      "hasCrash": true,
      "hasStackTrace": true,
      "reproQuality": "partial",
      "hasWorkaround": true,
      "workaroundSummary": "Switch from NativeAssets.Linux.NoDependencies to NativeAssets.Linux and use a custom Docker image (ghcr.io/avantipoint/aspnet-skia) with fontconfig and other native dependencies pre-installed. Also add System.Memory.Data as a direct PackageReference to prevent trimming.",
      "targetFrameworks": ["net9.0"],
      "severity": "medium",
      "severityReason": "Application crashes on startup in container deployment, but a workaround exists using a custom Docker image with NativeAssets.Linux."
    },
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a .NET 9 Web API project using .NET Aspire",
        "Add SkiaSharp 3.116.0 and SkiaSharp.NativeAssets.Linux.NoDependencies package references",
        "Deploy to Azure Container App via Aspire",
        "Invoke an endpoint that uses SkiaSharp (e.g., SKBitmap.Decode)"
      ],
      "codeSnippets": [
        {
          "language": "xml",
          "code": "<PackageReference Include=\"SkiaSharp\" />\n<PackageReference Include=\"SkiaSharp.NativeAssets.Linux.NoDependencies\" />",
          "context": "Package references used in the project"
        }
      ],
      "repoLinks": [
        {
          "url": "https://github.com/AvantiPoint/aspnet-skia",
          "description": "Custom Docker image repo created by reporter as a workaround — based on mcr.microsoft.com/dotnet/aspnet with SkiaSharp native dependencies installed"
        }
      ],
      "environmentDetails": "Linux Azure Container App deployed via .NET Aspire, .NET 9.0.10 runtime, Visual Studio (Windows) IDE"
    },
    "versionAnalysis": {
      "mentionedVersions": ["3.116.0", "2.88.9"],
      "currentRelevance": "likely",
      "reason": "Issue reported on 3.116.0 (current at time of filing). The user reports 2.88.9 as the last known good version. This suggests a regression or packaging change between the 2.x and 3.x major versions that affects native asset deployment in containerized environments.",
      "migrationPath": null
    },
    "regression": {
      "isRegression": true,
      "confidence": 0.70,
      "reason": "User reports 2.88.9 as last known good version. However, the NoDependencies package may not have existed in 2.x, so this may be a new issue with the 3.x packaging rather than a true regression of previously-working functionality.",
      "workedInVersion": "2.88.9",
      "brokeInVersion": "3.116.0"
    },
    "fixStatus": null
  },
  "analysis": {
    "summary": "The user references SkiaSharp.NativeAssets.Linux.NoDependencies but the DllNotFoundException error shows libfontconfig.so.1 as the first missing dependency. NoDependencies has zero fontconfig dependency, so the deployed binary is NOT from the NoDependencies package — it is from NativeAssets.Linux or another source. This is a known failure mode documented in packages.md, likely caused by .NET Aspire's container deployment deploying the wrong native binary variant.",
    "keySignals": [
      {
        "text": "libfontconfig.so.1: cannot open shared object file: No such file or directory",
        "source": "stack-trace",
        "interpretation": "The NoDependencies variant has zero fontconfig dependency. Seeing this error means the deployed binary is NOT from NoDependencies — the wrong native binary variant was deployed."
      },
      {
        "text": "SkiaSharp.NativeAssets.Linux.NoDependencies",
        "source": "body",
        "interpretation": "User explicitly added NoDependencies package, but the deployed binary still requires fontconfig, indicating a package selection or deployment conflict."
      },
      {
        "text": "deployed with .NET Aspire",
        "source": "body",
        "interpretation": "Aspire uses container deployment which may interfere with NativeAssets resolution. The container build tooling may select or override the wrong RID variant."
      },
      {
        "text": "Last Known Good Version: 2.88.9",
        "source": "body",
        "interpretation": "Suggests something changed between 2.x and 3.x in how native assets are packaged or resolved in container scenarios."
      },
      {
        "text": "I switched to SkiaSharp.NativeAssets.Linux",
        "source": "comment 2",
        "interpretation": "User's workaround confirms the NoDependencies binary was not being deployed. Switching to the full Linux variant with fontconfig installed in a custom image resolved it."
      },
      {
        "text": "System.Memory.Data was not found... trimming is enabled",
        "source": "comment 2",
        "interpretation": "Secondary issue: Aspire's container deployment enables trimming which strips transitive dependencies. This compounds the native loading issue."
      }
    ],
    "fieldRationales": [
      {
        "field": "type",
        "chosen": "type/bug",
        "expandedReason": "The application crashes with a TypeInitializationException wrapping a DllNotFoundException. The user correctly added the NoDependencies package but the wrong native binary was deployed, causing a crash. This is broken deployment behavior, not a usage error.",
        "alternatives": [
          { "value": "type/question", "whyRejected": "User is not asking how to do something — the application crashes despite following documented package references." },
          { "value": "type/documentation", "whyRejected": "While the troubleshooting section of packages.md documents this exact scenario, the underlying issue is a real packaging/deployment bug, not a documentation gap." }
        ]
      },
      {
        "field": "area",
        "chosen": "area/libSkiaSharp.native",
        "expandedReason": "The error is a DllNotFoundException for libSkiaSharp, which is a native library loading failure. The root cause is in how native assets are packaged and deployed, making area/libSkiaSharp.native the correct classification.",
        "alternatives": [
          { "value": "area/SkiaSharp", "whyRejected": "Not a managed API issue — the failure is in native binary resolution/deployment." },
          { "value": "area/Build", "whyRejected": "Not a build issue per se — the project builds successfully. The failure is in runtime native binary selection during container deployment." }
        ]
      },
      {
        "field": "bugSignals.severity",
        "chosen": "medium",
        "expandedReason": "Application crashes on any SkiaSharp API call in the container, which is high impact. However, the user found a complete workaround (custom Docker image with fontconfig + NativeAssets.Linux), dropping severity from high to medium."
      },
      {
        "field": "tenets",
        "chosen": "tenet/compatibility, tenet/reliability",
        "expandedReason": "Compatibility: worked in 2.88.9 but not in 3.116.0 in container deployments. Reliability: results in a hard crash (TypeInitializationException) on the first SkiaSharp API call."
      },
      {
        "field": "actionability.suggestedAction",
        "chosen": "needs-investigation",
        "expandedReason": "The workaround exists but the root cause — why NoDependencies binary is not deployed in Aspire container builds — is undetermined and could be a SkiaSharp packaging issue or Aspire tooling bug.",
        "alternatives": [{ "value": "close-answered", "whyRejected": "While a workaround was found, the underlying packaging/deployment bug remains unfixed and affects other users." }]
      },
      {
        "field": "platforms",
        "chosen": "os/Linux",
        "expandedReason": "The issue occurs in Linux Azure Container Apps deployed via .NET Aspire. The DllNotFoundException for libSkiaSharp and missing libfontconfig are Linux-specific native dependency issues."
      },
      {
        "field": "regression.isRegression",
        "chosen": "true",
        "expandedReason": "User reports 2.88.9 as last known good version. However, the NoDependencies package may not have existed in 2.x, so this may be a new issue with 3.x packaging rather than a true regression of identical functionality."
      },
      {
        "field": "versionAnalysis.currentRelevance",
        "chosen": "likely",
        "expandedReason": "Issue reported on 3.116.0 with no indication the native asset selection behavior in container deployments has been fixed in later releases."
      }
    ],
    "uncertainties": [
      "Whether the user had a conflicting transitive NativeAssets.Linux reference that overrode NoDependencies",
      "Whether .NET Aspire specifically selects the wrong RID variant during container image build, or if this is a general dotnet publish issue",
      "Whether NoDependencies package existed in 2.88.9 or if the user used a different package configuration with the older version"
    ],
    "assumptions": [
      "Assumed the user correctly added NoDependencies to the executable project, not just a library project",
      "Assumed this is specific to .NET Aspire container deployment since local development works fine",
      "Assumed net9.0 target framework based on the .NET 9.0.10 runtime path in the stack trace"
    ],
    "resolution": {
      "hypothesis": ".NET Aspire's container deployment pipeline resolves or deploys the wrong native binary variant for SkiaSharp. The NoDependencies binary should have no fontconfig dependency, but the deployed binary does, indicating the standard NativeAssets.Linux binary (or none) ends up in the container instead.",
      "proposals": [
        {
          "title": "Use custom Docker image with NativeAssets.Linux",
          "description": "The reporter's own workaround: switch to NativeAssets.Linux, use a custom base image with fontconfig installed, and set ContainerBaseImage in the csproj. This is a complete workaround available now.",
          "confidence": 0.90,
          "effort": "low"
        },
        {
          "title": "Investigate NoDependencies package selection in Aspire",
          "description": "Determine why .NET Aspire's container build doesn't deploy the NoDependencies binary. May require adding MSBuild diagnostics to trace which native assets are selected during publish. Could result in documentation improvement or MSBuild targets fix.",
          "confidence": 0.65,
          "effort": "medium"
        },
        {
          "title": "Add Aspire-specific guidance to documentation",
          "description": "Document the .NET Aspire container deployment scenario in packages.md or a dedicated troubleshooting guide. Include the ContainerBaseImage workaround and the trimming fix for System.Memory.Data.",
          "confidence": 0.85,
          "effort": "low"
        }
      ],
      "recommendedProposal": "Add Aspire-specific guidance to documentation",
      "recommendedReason": "The reporter's workaround is already complete and shared in the issue. Adding this to official documentation prevents others from hitting the same problem. Investigation into the root MSBuild/Aspire interaction can proceed separately."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.75,
      "reason": "The workaround exists but the root cause — why NoDependencies binary isn't deployed in Aspire container builds — is not determined. This could be a SkiaSharp packaging issue or an Aspire tooling bug.",
      "requiresHumanReview": true
    },
    "actions": [
      {
        "id": "labels-1",
        "type": "update-labels",
        "risk": "low",
        "description": "Add tenet/reliability label to reflect the hard crash behavior",
        "reason": "The issue causes a TypeInitializationException crash. Current labels cover type/bug, area, os, and tenet/compatibility but miss tenet/reliability.",
        "confidence": 0.85,
        "dependsOn": null,
        "payload": {
          "labelsToAdd": ["tenet/reliability"],
          "labelsToRemove": []
        }
      },
      {
        "id": "comment-1",
        "type": "add-comment",
        "risk": "high",
        "description": "Post analysis acknowledging workaround and explaining the fontconfig diagnostic signal",
        "reason": "The reporter and future visitors would benefit from understanding why the fontconfig error appears with NoDependencies, and official acknowledgment of the Aspire deployment gap.",
        "confidence": 0.80,
        "dependsOn": "labels-1",
        "payload": {
          "commentType": "answer",
          "draftBody": "Thanks for the thorough write-up and the workaround — that custom image approach is solid and will help others hitting this.\n\nThe fontconfig error with `NoDependencies` is a tell: that package ships a binary with zero fontconfig dependency (only libc/libm/libpthread/libdl), so seeing `libfontconfig.so.1: cannot open` means the deployed binary isn't actually from the NoDependencies package. Something in the Aspire container build pipeline is either selecting the wrong variant or not deploying the NoDependencies binary at all.\n\nWe'll look into what's happening with native asset selection in Aspire container deployments. In the meantime, your approach of using `NativeAssets.Linux` with a custom base image that has fontconfig installed is the right call for this scenario.",
          "requiresHumanEdit": true,
          "finalBody": null,
          "dedupeToken": "triage-3386-comment-1"
        }
      }
    ]
  }
}
