{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3386,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-25T12:00:00Z"
  },
  "summary": "DllNotFoundException for libSkiaSharp when deploying to Azure Container App via .NET Aspire — NoDependencies package binary not deployed, wrong variant loaded",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.92
    },
    "area": {
      "value": "area/libSkiaSharp.native",
      "confidence": 0.95
    },
    "platforms": [
      "os/Linux"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a .NET 9 Web API project using .NET Aspire",
        "Add SkiaSharp 3.116.0 and SkiaSharp.NativeAssets.Linux.NoDependencies package references",
        "Deploy to Azure Container App via Aspire",
        "Invoke an endpoint that uses SkiaSharp (e.g., SKBitmap.Decode)"
      ],
      "environmentDetails": "Linux Azure Container App deployed via .NET Aspire, .NET 9.0.10 runtime, Visual Studio (Windows) IDE",
      "codeSnippets": [
        "xml: <PackageReference Include=\"SkiaSharp\" />\n<PackageReference Include=\"SkiaSharp.NativeAssets.Linux.NoDependencies\" />"
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "errorType": "crash",
      "isRegression": true
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "2.88.9"
      ]
    }
  },
  "analysis": {
    "summary": "The user references SkiaSharp.NativeAssets.Linux.NoDependencies but the DllNotFoundException error shows libfontconfig.so.1 as the first missing dependency. NoDependencies has zero fontconfig dependency, so the deployed binary is NOT from the NoDependencies package — it is from NativeAssets.Linux or another source. This is a known failure mode documented in packages.md, likely caused by .NET Aspire's container deployment deploying the wrong native binary variant.",
    "rationale": "type: The application crashes with a TypeInitializationException wrapping a DllNotFoundException. The user correctly added the NoDependencies package but the wrong native binary was deployed, causing a crash. This is broken deployment behavior, not a usage error. area: The error is a DllNotFoundException for libSkiaSharp, which is a native library loading failure. The root cause is in how native assets are packaged and deployed, making area/libSkiaSharp.native the correct classification. bugSignals.severity: Application crashes on any SkiaSharp API call in the container, which is high impact. However, the user found a complete workaround (custom Docker image with fontconfig + NativeAssets.Linux), dropping severity from high to medium. tenets: Compatibility: worked in 2.88.9 but not in 3.116.0 in container deployments. Reliability: results in a hard crash (TypeInitializationException) on the first SkiaSharp API call. actionability.suggestedAction: The workaround exists but the root cause — why NoDependencies binary is not deployed in Aspire container builds — is undetermined and could be a SkiaSharp packaging issue or Aspire tooling bug. platforms: The issue occurs in Linux Azure Container Apps deployed via .NET Aspire. The DllNotFoundException for libSkiaSharp and missing libfontconfig are Linux-specific native dependency issues. regression.isRegression: User reports 2.88.9 as last known good version. However, the NoDependencies package may not have existed in 2.x, so this may be a new issue with 3.x packaging rather than a true regression of identical functionality. versionAnalysis.currentRelevance: Issue reported on 3.116.0 with no indication the native asset selection behavior in container deployments has been fixed in later releases.",
    "codeInvestigation": [],
    "workarounds": [
      "Switch from NativeAssets.Linux.NoDependencies to NativeAssets.Linux and use a custom Docker image (ghcr.io/avantipoint/aspnet-skia) with fontconfig and other native dependencies pre-installed. Also add System.Memory.Data as a direct PackageReference to prevent trimming."
    ],
    "nextQuestions": [
      "Whether the user had a conflicting transitive NativeAssets.Linux reference that overrode NoDependencies",
      "Whether .NET Aspire specifically selects the wrong RID variant during container image build, or if this is a general dotnet publish issue",
      "Whether NoDependencies package existed in 2.88.9 or if the user used a different package configuration with the older version"
    ],
    "resolution": {
      "hypothesis": ".NET Aspire's container deployment pipeline resolves or deploys the wrong native binary variant for SkiaSharp. The NoDependencies binary should have no fontconfig dependency, but the deployed binary does, indicating the standard NativeAssets.Linux binary (or none) ends up in the container instead.",
      "proposals": [
        {
          "description": "The reporter's own workaround: switch to NativeAssets.Linux, use a custom base image with fontconfig installed, and set ContainerBaseImage in the csproj. This is a complete workaround available now.",
          "confidence": 0.9,
          "effort": "small"
        },
        {
          "description": "Determine why .NET Aspire's container build doesn't deploy the NoDependencies binary. May require adding MSBuild diagnostics to trace which native assets are selected during publish. Could result in documentation improvement or MSBuild targets fix.",
          "confidence": 0.65,
          "effort": "medium"
        },
        {
          "description": "Document the .NET Aspire container deployment scenario in packages.md or a dedicated troubleshooting guide. Include the ContainerBaseImage workaround and the trimming fix for System.Memory.Data.",
          "confidence": 0.85,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.75,
      "reason": "The workaround exists but the root cause — why NoDependencies binary isn't deployed in Aspire container builds — is not determined. This could be a SkiaSharp packaging issue or an Aspire tooling bug."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add tenet/reliability label to reflect the hard crash behavior",
        "risk": "low",
        "confidence": 0.85,
        "labels": [
          "tenet/reliability"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post analysis acknowledging workaround and explaining the fontconfig diagnostic signal",
        "risk": "high",
        "confidence": 0.8
      }
    ]
  }
}
