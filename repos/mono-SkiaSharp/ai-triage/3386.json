{
  "schemaVersion": "1.0",
  "number": 3386,
  "repo": "mono/SkiaSharp",
  "analyzedAt": "2026-02-09T09:42:02Z",
  "summary": "DllNotFoundException in Azure Container App via .NET Aspire — wrong NativeAssets binary deployed despite NoDependencies reference",
  "type": {
    "value": "bug",
    "confidence": 0.95,
    "reason": "TypeInitializationException/DllNotFoundException crash with stack trace. Application fails to function on deployment."
  },
  "area": {
    "value": "libSkiaSharp.native",
    "confidence": 0.95,
    "reason": "DllNotFoundException for libSkiaSharp is a native binary loading/deployment issue."
  },
  "backends": null,
  "platforms": [
    {
      "value": "Linux",
      "confidence": 0.97,
      "reason": "Explicitly running on Linux-based Azure Container App."
    }
  ],
  "tenets": [
    {
      "value": "compatibility",
      "confidence": 0.88,
      "reason": "Worked in 2.88.9 but fails in 3.116.0 — cross-version packaging/deployment behavior changed."
    },
    {
      "value": "reliability",
      "confidence": 0.85,
      "reason": "Complete failure to load native library causes crash at startup."
    }
  ],
  "partner": null,
  "regression": {
    "isRegression": true,
    "confidence": 0.70,
    "reason": "Author states 2.88.9 was last known good version and 3.116.0 fails. However, the root cause is likely a packaging/deployment difference in the 3.x era rather than a code regression. The NoDependencies package may have changed how it resolves in container scenarios.",
    "workedInVersion": "2.88.9",
    "brokeInVersion": "3.116.0"
  },
  "fixStatus": null,
  "bugSignals": {
    "hasCrash": true,
    "hasStackTrace": true,
    "reproQuality": "partial",
    "hasScreenshot": false,
    "hasWorkaround": true,
    "workaroundSummary": "Switch to SkiaSharp.NativeAssets.Linux (with deps), use custom Docker image (ghcr.io/avantipoint/aspnet-skia) with native deps installed, and add System.Memory.Data as direct dependency to prevent trimming.",
    "targetFrameworks": ["net9.0"],
    "severity": "medium",
    "severityReason": "Crash on deployment with no trivial fix, but a documented workaround exists. The workaround requires creating a custom Docker image which is non-trivial."
  },
  "reproEvidence": {
    "stepsToReproduce": [
      "Create a .NET 9 WebAPI project using .NET Aspire",
      "Add SkiaSharp 3.116.0 and SkiaSharp.NativeAssets.Linux.NoDependencies as PackageReferences",
      "Use SKBitmap.Decode() or similar API in the application",
      "Deploy to Azure Container App via Aspire (creates Linux-based container)",
      "Observe TypeInitializationException/DllNotFoundException at runtime"
    ],
    "codeSnippets": [
      {
        "language": "xml",
        "code": "<PackageReference Include=\"SkiaSharp\" />\n<PackageReference Include=\"SkiaSharp.NativeAssets.Linux.NoDependencies\" />",
        "context": "Package references used in the project that fails on deployment"
      },
      {
        "language": "xml",
        "code": "<PropertyGroup>\n  <OutputType>Exe</OutputType>\n  <TargetFramework>net9.0</TargetFramework>\n  <ContainerBaseImage>ghcr.io/avantipoint/aspnet-skia:9.0</ContainerBaseImage>\n</PropertyGroup>",
        "context": "Workaround: custom Docker base image with native dependencies"
      },
      {
        "language": "xml",
        "code": "<PackageReference Include=\"System.Memory.Data\" />",
        "context": "Additional workaround for trimming issue stripping System.Memory.Data"
      }
    ],
    "repoLinks": [
      {
        "url": "https://github.com/AvantiPoint/aspnet-skia",
        "description": "Custom Docker image created by the reporter as a workaround, based on mcr.microsoft.com/dotnet/aspnet:X.0-noble with SkiaSharp native dependencies installed."
      }
    ],
    "environmentDetails": "Linux Azure Container App, deployed via .NET Aspire, .NET 9.0.10 runtime, Visual Studio (Windows) for development"
  },
  "versionAnalysis": {
    "mentionedVersions": ["3.116.0", "2.88.9"],
    "era": "modern",
    "currentRelevance": "likely",
    "reason": "Issue is with 3.116.0 (current modern era). The NativeAssets deployment behavior in container scenarios via .NET Aspire is likely still present in latest versions."
  },
  "actionability": {
    "suggestedAction": "needs-investigation",
    "confidence": 0.82,
    "reason": "The fontconfig error with NoDependencies referenced proves the wrong binary was deployed (per native-loading-diagnostics.md). The root cause is likely .NET Aspire's container build deploying the wrong RID variant, or a transitive NativeAssets.Linux reference conflicting with NoDependencies. Needs investigation into whether this is a SkiaSharp packaging issue or an Aspire/dotnet-publish issue.",
    "requiresHumanReview": false,
    "closeable": false,
    "closeReason": null,
    "duplicateOf": null
  },
  "suggestedResponse": {
    "responseType": "documentation",
    "confidence": 0.80,
    "reason": "The diagnostic pattern is well-understood from native-loading-diagnostics. A response can explain the root cause and point to correct resolution.",
    "draft": "Thanks for the detailed report and workaround @dansiegel!\n\nThe key diagnostic clue is: the error shows `libfontconfig.so.1: cannot open shared object file`. Since `NativeAssets.Linux.NoDependencies` has **zero** external dependencies (no fontconfig), this proves the wrong `.so` was deployed — the fontconfig-dependent binary from `NativeAssets.Linux` was loaded instead of the NoDependencies variant.\n\nThis can happen when:\n1. A transitive dependency pulls in `SkiaSharp.NativeAssets.Linux`, which wins over `NoDependencies` at deploy time\n2. The container build tool (.NET Aspire SDK) resolves the wrong RID variant\n\nYour workaround (switching to `NativeAssets.Linux` + custom image with deps) is valid. An alternative would be to investigate why `NoDependencies` isn't being deployed — check `dotnet publish` output for which `libSkiaSharp.so` is in the output and run `ldd` on it to confirm which variant it is."
  }
}
