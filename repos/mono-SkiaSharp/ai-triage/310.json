{
  "meta": {
    "schemaVersion": "1.0",
    "number": 310,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-25T06:00:00Z"
  },
  "summary": "GDI+ error in SKControl.OnPaint when control is resized during PaintSurface event due to reentrant OnPaint and bitmap state corruption",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/SkiaSharp.Views",
      "confidence": 0.95
    },
    "platforms": [
      "os/Windows-Classic"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Place SKControl inside a scrollable container (e.g. DevExpress XtraScrollableControl)",
        "In the PaintSurface event handler, change the SKControl.Height based on content",
        "Scroll down so the bottom of SKControl is visible but top is offscreen",
        "Trigger a content change that resizes the SKControl smaller, causing the view to go offscreen"
      ],
      "environmentDetails": "Windows, WinForms (System.Windows.Forms), DevExpress XtraScrollableControl container",
      "codeSnippets": [
        "text: System.Runtime.InteropServices.ExternalException (0x80004005): A generic error occurred in GDI+.\n   at System.Drawing.Bitmap.UnlockBits(BitmapData bitmapdata)\n   at SkiaSharp.Views.Desktop.SKControl.OnPaint(PaintEventArgs e)\n   at System.Windows.Forms.Control.PaintWithErrorHandling(PaintEventArgs e, Int16 layer)\n   at System.Windows.Forms.Control.WmPaint(Message& m)\n   at System.Windows.Forms.Control.WndProc(Message& m)\n   at System.Windows.Forms.NativeWindow.Callback(IntPtr hWnd, Int32 msg, IntPtr wparam, IntPtr lparam)"
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "errorType": "crash"
    }
  },
  "analysis": {
    "summary": "The reporter triggers a reentrant OnPaint by resizing SKControl from within the PaintSurface event. The reentrant call to CreateBitmap() disposes and replaces the bitmap while the outer OnPaint still holds a LockBits handle on the old bitmap. When the outer OnPaint resumes and calls UnlockBits(data), the bitmap is already disposed/replaced, causing the GDI+ error.",
    "rationale": "type: The issue describes a crash (ExternalException) with a stack trace during normal operation. The reporter and maintainer both confirmed reentrant OnPaint as the root cause. Currently labeled type/enhancement but this is a defect — the control should handle reentrancy gracefully rather than crashing. area: The crash occurs in SKControl.OnPaint, which is in the SkiaSharp.Views.WindowsForms package under the SkiaSharp.Views.Desktop namespace. bugSignals.severity: GDI+ exception crashes the paint cycle, but a workaround exists (avoid resizing during paint). The pattern requires a specific trigger (resize from within PaintSurface) that is not the common usage path. platforms: SKControl is a WinForms control. WinForms is Windows-only, and the reentrancy behavior is specific to the WinForms message pump handling of WM_PAINT. tenets: Unhandled GDI+ exception during paint is a reliability issue — the control should not crash even if user code triggers reentrancy. versionAnalysis.currentRelevance: The SKControl.OnPaint code has not changed since the issue was filed. No reentrancy guard has been added. The bug is still present in current main. actionability.suggestedAction: The root cause is well understood (reentrant OnPaint corrupts bitmap state), but a proper fix needs design consideration — a simple boolean guard vs. queueing the resize vs. making CreateBitmap idempotent during locks. The issue label should be corrected from type/enhancement to type/bug.",
    "codeInvestigation": [
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WindowsForms/SKControl.cs",
        "lines": "30-57",
        "finding": "OnPaint has no reentrancy guard. LockBits on line 43 acquires a handle on the bitmap, then OnPaintSurface on line 49 fires user code. If user code resizes the control, a reentrant OnPaint call will run CreateBitmap() which disposes and replaces the bitmap field. When the original OnPaint resumes at line 55, UnlockBits(data) operates on a disposed/replaced bitmap.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WindowsForms/SKControl.cs",
        "lines": "72-85",
        "finding": "CreateBitmap() disposes the old bitmap via FreeBitmap() (line 78) and creates a new one (line 81) whenever Width/Height changes. This is the mutation that corrupts the outer OnPaint's LockBits handle.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WindowsForms/SKControl.cs",
        "lines": "17-20",
        "finding": "Constructor sets ControlStyles.ResizeRedraw = true (line 20), meaning any resize immediately triggers a repaint — enabling the reentrant OnPaint when the user resizes from within PaintSurface.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WPF/SKElement.cs",
        "lines": "45-89",
        "finding": "WPF SKElement.OnRender has same Lock/PaintSurface/Unlock pattern (lines 72-87) but WPF's rendering pipeline does not allow reentrant OnRender calls. WinForms' message pump does allow reentrant WM_PAINT handling, which is why only SKControl is affected.",
        "relevance": "related"
      }
    ],
    "workarounds": [
      "Avoid resizing the SKControl from within the PaintSurface event handler. Perform layout calculations and control resizing outside the paint cycle, e.g. in a BeginInvoke callback."
    ],
    "nextQuestions": [
      "Whether a simple boolean reentrancy guard (skip reentrant OnPaint) is sufficient, or if the resize should be deferred and replayed",
      "Whether other WinForms container controls besides DevExpress XtraScrollableControl can trigger this reentrancy"
    ],
    "resolution": {
      "hypothesis": "Reentrant OnPaint corrupts GDI+ bitmap state because CreateBitmap disposes the locked bitmap. A reentrancy guard would prevent the crash.",
      "proposals": [
        {
          "description": "Add a boolean field (e.g., isPainting) that skips reentrant OnPaint calls. Set it true before LockBits, false after UnlockBits. If already true when OnPaint is entered, call Invalidate() to schedule a deferred repaint and return early.",
          "confidence": 0.85,
          "effort": "small"
        },
        {
          "description": "Reporter's own workaround: perform control resizing outside the PaintSurface handler. Use BeginInvoke to defer the resize to after the paint cycle completes.",
          "confidence": 0.9,
          "effort": "small"
        },
        {
          "description": "Catch ExternalException from UnlockBits and schedule an Invalidate() to retry the paint. Defensive but does not prevent the underlying reentrancy — masks the symptom.",
          "confidence": 0.6,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.82,
      "reason": "Root cause is well understood from reporter's debugging and source analysis. Fix is straightforward (reentrancy guard) but needs testing and design review to ensure deferred repaints work correctly in all container scenarios."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Correct type label from enhancement to bug, add reliability tenet",
        "risk": "low",
        "confidence": 0.92,
        "labels": [
          "type/bug",
          "tenet/reliability"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post analysis with workaround and proposed fix",
        "risk": "high",
        "confidence": 0.82
      }
    ]
  }
}
