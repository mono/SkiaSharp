{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3467,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T00:20:00Z",
    "currentLabels": []
  },
  "summary": "Copilot-authored test-only PR adding 6 tests to SKShaperTest.cs validating that ToHarfBuzzBlob no longer disposes the caller's SKStreamAsset — tests are designed to fail before #3466 and pass after",
  "classification": {
    "type": { "value": "type/enhancement", "confidence": 0.95 },
    "area": { "value": "area/SkiaSharp.HarfBuzz", "confidence": 0.98 }
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Merge PR #3466 (behavioral change to ToHarfBuzzBlob)",
        "Apply PR #3467 tests to tests/Tests/SkiaSharp/SKShaperTest.cs",
        "Run: dotnet test tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj --filter SKShaperTest"
      ],
      "environmentDetails": "SkiaSharp main branch, .NET 8+, any OS",
      "relatedIssues": [3466, 3472, 2263]
    },
    "versionAnalysis": {
      "mentionedVersions": [],
      "currentRelevance": "likely",
      "relevanceReason": "ToHarfBuzzBlob on main still disposes the stream via the destroy callback (line 24 of BlobExtensions.cs). Tests verify the behavioral change in PR #3466 which has not yet been merged."
    }
  },
  "analysis": {
    "summary": "PR #3467 is a Copilot-authored test-only PR that adds 6 test methods to SKShaperTest.cs. The tests validate the behavioral change proposed in PR #3466, where ToHarfBuzzBlob stops taking disposal ownership of SKStreamAsset. The current code (BlobExtensions.cs:24) passes `() => asset.Dispose()` as the destroy callback to the Blob constructor, which incorrectly disposes the caller's stream when the blob is destroyed. PR #3466 removes this callback. PR #3467 tests that the stream survives blob creation/disposal.",
    "rationale": "Classified as enhancement because this is a test-only PR that improves test coverage for an existing behavioral fix (PR #3466). It is not a bug fix itself. Area is SkiaSharp.HarfBuzz because all tests exercise BlobExtensions.ToHarfBuzzBlob and SKShaper, both in the SkiaSharp.HarfBuzz package. No platform or backend specificity — disposal behavior is cross-platform.",
    "keySignals": [
      { "text": "Add test coverage for PR #3466's behavioral change", "source": "PR description", "interpretation": "Explicit dependency on PR #3466 — tests will FAIL on current main without that fix." },
      { "text": "blob = new Blob(memoryBase, size, MemoryMode.ReadOnly, () => asset.Dispose())", "source": "BlobExtensions.cs:24 (main branch)", "interpretation": "Current code disposes the caller's stream when the blob is destroyed — the bug that #3466 fixes and #3467 tests." },
      { "text": "ToHarfBuzzBlobDoesNotDisposeStream", "source": "PR #3467 diff + PR #3466 diff", "interpretation": "Both PRs add a test with this exact name — #3466 in BlobExtensionsTest.cs, #3467 in SKShaperTest.cs. Merge conflict on test name." },
      { "text": "Firewall rules blocked me from connecting", "source": "PR #3467 description", "interpretation": "Copilot agent could not build or run the tests due to network restrictions in the sandbox environment." },
      { "text": "using (var blob = Typeface.OpenStream(out index).ToHarfBuzzBlob())", "source": "SKShaper.cs:20 (main branch)", "interpretation": "SKShaper currently chains OpenStream().ToHarfBuzzBlob() without keeping a reference to the stream. PR #3466 splits this into separate using statements so the stream is properly disposed by the caller." }
    ],
    "codeInvestigation": [
      { "file": "source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz/BlobExtensions.cs", "lines": "10-37", "finding": "ToHarfBuzzBlob has two code paths: (1) memory-mapped: passes `() => asset.Dispose()` as destroy callback, incorrectly disposing the caller's stream; (2) non-memory-mapped: allocates CoTaskMem, reads data, passes `FreeCoTaskMem` as callback. PR #3466 removes the asset.Dispose() call in path 1 and adds try/catch for path 2.", "relevance": "direct" },
      { "file": "source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz/SKShaper.cs", "lines": "19-21", "finding": "SKShaper constructor chains OpenStream().ToHarfBuzzBlob() in a single using statement. Since ToHarfBuzzBlob currently disposes the stream, the stream gets disposed twice (once by blob callback, once by using). PR #3466 splits these into separate using statements.", "relevance": "direct" },
      { "file": "tests/Tests/SkiaSharp/SKShaperTest.cs", "lines": "10-150", "finding": "Existing SKShaperTest has 5 tests covering shaping text with different alignment options and the DrawShapedText extension method. PR #3467 adds 6 disposal-focused tests after line 150.", "relevance": "context" }
    ],
    "nextQuestions": [
      "Should tests live in SKShaperTest.cs or in a new BlobExtensionsTest.cs (as PR #3466 does)?",
      "How to resolve the duplicate test name ToHarfBuzzBlobDoesNotDisposeStream between PR #3466 and #3467?",
      "Should PR #3467 be merged into #3466 instead of being a separate PR?",
      "Were the tests actually validated (Copilot agent couldn't build due to firewall)?"
    ],
    "resolution": {
      "hypothesis": "PR #3467 provides useful test coverage but has organizational issues — duplicate test names with #3466, tests in the wrong class, and unverified execution.",
      "proposals": [
        {
          "title": "Consolidate into PR #3466",
          "description": "Move the additional tests from PR #3467 into PR #3466's BlobExtensionsTest.cs (or a separate test class), resolve the duplicate test name, and close #3467. This avoids merge ordering issues and keeps all related changes together.",
          "confidence": 0.85,
          "effort": "small"
        },
        {
          "title": "Merge #3466 first then rebase #3467",
          "description": "Merge PR #3466 first, then rebase #3467 and resolve the duplicate test name. This preserves the separate PR but requires coordination.",
          "confidence": 0.70,
          "effort": "small"
        },
        {
          "title": "Move tests to BlobExtensionsTest",
          "description": "The ToHarfBuzzBlob tests are about BlobExtensions, not SKShaper. Move them from SKShaperTest.cs to BlobExtensionsTest.cs (the file #3466 creates) for better test organization. Keep SKShaperConstructorSucceeds in SKShaperTest.cs.",
          "confidence": 0.80,
          "effort": "small"
        }
      ],
      "recommendedProposal": "Consolidate into PR #3466",
      "recommendedReason": "Avoids merge ordering complexity, resolves the duplicate test name in one place, and ensures all disposal-related changes (fix + tests) are reviewed together. The Copilot-authored tests provide good additional coverage that complements #3466's single test."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "Tests depend on unmerged PR #3466 and have organizational issues (duplicate test name, wrong test class). The fix PR (#3466) should be reviewed first, then decide whether to consolidate these tests into it or keep them separate."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Apply enhancement and HarfBuzz area labels",
        "risk": "low",
        "confidence": 0.95,
        "labels": ["type/enhancement", "area/SkiaSharp.HarfBuzz"]
      },
      {
        "type": "add-comment",
        "description": "Provide review feedback on test organization and dependency on #3466",
        "risk": "high",
        "confidence": 0.85,
        "comment": "Thanks for the additional test coverage.\n\nA few observations:\n\n1. **Dependency on #3466:** These tests are designed to fail on current `main` and will only pass after #3466 is merged. Merging this first would introduce known-failing tests.\n\n2. **Duplicate test name:** Both this PR and #3466 add a test named `ToHarfBuzzBlobDoesNotDisposeStream` — this PR puts it in `SKShaperTest`, while #3466 puts it in `BlobExtensionsTest`. These would conflict.\n\n3. **Test organization:** The `ToHarfBuzzBlob*` tests exercise `BlobExtensions`, not `SKShaper`. It might be cleaner to move them into `BlobExtensionsTest.cs` (the file #3466 creates) and keep only `SKShaperConstructorSucceeds` in `SKShaperTest`.\n\nWould it make sense to fold these additional tests into #3466 directly? That way the behavioral change and its full test suite ship together."
      },
      {
        "type": "link-related",
        "description": "Cross-reference parent PR #3466",
        "risk": "low",
        "confidence": 0.98,
        "linkedIssue": 3466
      },
      {
        "type": "link-related",
        "description": "Cross-reference related GC safety issue #3472 by same author",
        "risk": "low",
        "confidence": 0.75,
        "linkedIssue": 3472
      }
    ]
  }
}
