{
  "meta": {
    "schemaVersion": "3.0",
    "number": 425,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-11T17:00:00Z"
  },
  "summary": "SKCodec returns TopLeft origin for DNG files because Skia's SkRawCodec never reads EXIF orientation — hardcoded default in upstream.",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.85
    }
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "1. Open a DNG file with non-TopLeft EXIF orientation",
        "2. Create SKCodec from the file stream",
        "3. Read codec.EncodedOrigin (was codec.Origin in old API)",
        "4. Result: always TopLeft regardless of actual EXIF orientation"
      ],
      "attachments": [
        {
          "url": "https://github.com/mono/SkiaSharp/files/1616452/APC_0316.zip",
          "filename": "APC_0316.zip"
        },
        {
          "url": "https://github.com/mono/SkiaSharp/files/1616453/APC_0193.zip",
          "filename": "APC_0193.zip"
        }
      ],
      "codeSnippets": [
        "csharp: using (var codec = SKCodec.Create(stream)) { origin = codec.Origin; }"
      ]
    },
    "bugSignals": {
      "severity": "low"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "SkiaSharp (2018 era, pre-MAUI)"
      ]
    }
  },
  "analysis": {
    "summary": "Confirmed upstream Skia limitation. SkRawCodec (handles DNG files) constructs the base SkCodec without passing an SkEncodedOrigin parameter. The base constructor defaults to kTopLeft_SkEncodedOrigin (SkCodec.h:768). The raw codec uses PIEX to extract a JPEG preview from DNG files but never reads or propagates the EXIF orientation tag. Contrast with SkJpegCodec which properly reads EXIF orientation. The existing label status/skia-update-required is correct — this requires a fix in upstream Skia's SkRawCodec.",
    "rationale": "type: SKCodec.EncodedOrigin returns incorrect data for DNG files. The EXIF orientation exists in the file but is not read by Skia's raw codec. area: Core codec functionality in the SkiaSharp package. The root cause is in upstream Skia (SkRawCodec.cpp) but surfaces through SKCodec.EncodedOrigin. bugSignals.severity: Functional defect with no crash or data loss. Affects a niche use case (DNG files with non-TopLeft orientation). JPEG orientation works correctly. actionability.suggestedAction: Confirmed upstream Skia limitation with correct label (status/skia-update-required). The fix must happen in Skia's SkRawCodec. No SkiaSharp-side workaround is possible since EncodedOrigin is a direct pass-through to the native API. versionAnalysis.currentRelevance: Source inspection of current externals/skia/src/codec/SkRawCodec.cpp confirms no orientation handling exists. The constructor still omits the origin parameter.",
    "codeInvestigation": [
      {
        "file": "externals/skia/src/codec/SkRawCodec.cpp",
        "lines": "826-832",
        "finding": "SkRawCodec constructor calls INHERITED (SkCodec) WITHOUT passing an origin parameter — defaults to kTopLeft",
        "relevance": "related"
      },
      {
        "file": "externals/skia/include/codec/SkCodec.h",
        "lines": "765-768",
        "finding": "Base SkCodec constructor has default parameter SkEncodedOrigin = kTopLeft_SkEncodedOrigin — this is why DNG always reports TopLeft",
        "relevance": "related"
      },
      {
        "file": "externals/skia/src/codec/SkRawCodec.cpp",
        "lines": "584-687",
        "finding": "PIEX integration extracts JPEG preview from DNG but has zero references to orientation/origin — the EXIF tag is never read",
        "relevance": "related"
      },
      {
        "file": "binding/SkiaSharp/SKCodec.cs",
        "lines": "36-37",
        "finding": "Managed EncodedOrigin property directly calls native sk_codec_get_origin — no SkiaSharp-side workaround possible",
        "relevance": "related"
      },
      {
        "file": "tests/Tests/SkiaSharp/SKCodecTest.cs",
        "lines": "28-36",
        "finding": "Origin tests exist for JPEG (P8211052.JPG, PA010741.JPG) but no DNG test — the gap was never tested",
        "relevance": "related"
      }
    ],
    "nextQuestions": [
      "Whether upstream Skia has a tracking issue for DNG orientation support",
      "Whether PIEX's PreviewImageData struct contains orientation info that could be extracted",
      "Whether a SkiaSharp-side workaround could read DNG EXIF independently (e.g., via a third-party EXIF library) and apply rotation manually"
    ],
    "resolution": {
      "hypothesis": "Skia's SkRawCodec uses PIEX for DNG preview extraction but never reads the EXIF orientation tag. The base SkCodec constructor defaults origin to kTopLeft. The fix requires modifying SkRawCodec to extract and pass orientation from PIEX/EXIF data.",
      "proposals": [
        {
          "description": "Modify SkRawCodec::MakeFromStream to extract orientation from PIEX's PreviewImageData and pass it to the SkCodec constructor. This is the correct fix but requires an upstream Skia contribution.",
          "confidence": 0.85,
          "effort": "medium"
        },
        {
          "description": "Use a separate EXIF reading library (e.g., MetadataExtractor) to read orientation from the DNG file, then manually apply rotation after decode. Works around the Skia limitation at the application level.",
          "confidence": 0.8,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "keep-open",
      "confidence": 0.9,
      "reason": "Confirmed upstream Skia bug. SkRawCodec.cpp doesn't read EXIF orientation. Correctly labeled status/skia-update-required. No SkiaSharp-side fix possible."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add area label",
        "risk": "low",
        "confidence": 0.9,
        "labels": [
          "area/SkiaSharp"
        ]
      }
    ]
  }
}
