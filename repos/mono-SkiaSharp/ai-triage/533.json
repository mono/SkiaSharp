{
  "meta": {
    "schemaVersion": "3.0",
    "number": 533,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-24T12:00:00Z"
  },
  "summary": "SKGLView on Android runs at uncapped framerates (300-1000fps) after switch from GLSurfaceView to TextureView — no VSync or frame pacing in custom GL thread",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.82
    },
    "area": {
      "value": "area/views",
      "confidence": 0.95
    },
    "platforms": [
      "os/Android"
    ],
    "backends": [
      "backend/OpenGL"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a Xamarin.Forms or MAUI project with an SKGLView",
        "Set HasRenderLoop to true",
        "In PaintSurface, measure elapsed time between calls",
        "Observe FPS exceeds 60 (often 300-1000fps depending on device)"
      ],
      "environmentDetails": "Android 7+ API 24, Samsung Galaxy S7 Edge. Also confirmed on Motorola Moto g6 (API 28), Galaxy Note 3 (API 21), and emulators.",
      "codeSnippets": [
        "csharp: Stopwatch sw = Stopwatch.StartNew();\nTimeSpan last;\n\nprivate void OnPaint(object sender, SKPaintGLSurfaceEventArgs e)\n{\n    var c = sw.Elapsed;\n    var ts = c - last;\n    last = c;\n    var fps = 1.0 / (ts.TotalSeconds);\n    Log.Debug(\"FPS\", fps.ToString(\"0,000.00\"));\n}"
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "isRegression": true
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "1.59.3",
        "1.60.1"
      ]
    }
  },
  "analysis": {
    "summary": "The Android SKGLView renders at uncapped framerates because the custom GLTextureView implementation does not call eglSwapInterval to enable VSync. The old GLSurfaceView had VSync built-in. The maintainer acknowledged this is a real issue and investigated Choreographer as a potential fix, but no implementation was made.",
    "rationale": "type: This is a behavioral regression: FPS was capped at 60 in 1.59.3 (GLSurfaceView with VSync) and became uncapped in 1.60.1 (GLTextureView without VSync). The maintainer acknowledged it as a real problem worth fixing. Frame-based animations break and battery is wasted. area: The issue is in the Android platform view layer (GLTextureView, SKGLTextureView, SKGLViewHandler.Android), all part of SkiaSharp.Views. backends: The issue is specific to the OpenGL rendering path (GLTextureView, EGL). CPU-based SKCanvasView is not affected. platforms: The GLTextureView custom implementation is Android-specific. iOS and other platforms have their own rendering pipelines. tenets: Uncapped FPS wastes CPU/GPU cycles and drains battery. Rendering faster than the display refresh rate provides no visual benefit. bugSignals.severity: No crash or data loss. Animations based on frame count break, and battery drains faster than necessary. However, a time-based animation loop is the recommended pattern anyway, and multiple users note the higher FPS is actually beneficial for responsive rendering. regression.isRegression: Maintainer confirmed in comment 2 that the switch from GLSurfaceView to TextureView caused the behavior change. Version 1.59.3 was capped, 1.60.1 is not. versionAnalysis.currentRelevance: The GLTextureView.cs code still does not call eglSwapInterval. The same uncapped render loop exists in the current codebase. actionability.suggestedAction: The root cause is clear (missing eglSwapInterval/Choreographer), but the implementation approach needs investigation — adding eglSwapInterval(1) could cause issues with TextureView, and Choreographer integration is non-trivial. The maintainer explored options but never committed to an approach.",
    "codeInvestigation": [
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/GLTextureView.cs",
        "lines": "634-641",
        "finding": "The Swap() method calls EglSwapBuffers but does NOT call eglSwapInterval — this is the missing VSync. Android's GLSurfaceView sets eglSwapInterval(1) by default which caps FPS to display refresh rate.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/GLTextureView.cs",
        "lines": "1081-1083",
        "finding": "IsReadyToDraw() returns true continuously when renderMode == Rendermode.Continuously, causing the GL thread to loop as fast as possible with no throttle.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views.Maui/SkiaSharp.Views.Maui.Core/Handlers/SKGLView/SKGLViewHandler.Android.cs",
        "lines": "61-68",
        "finding": "MapHasRenderLoop sets RenderMode to Rendermode.Continuously when HasRenderLoop is true, triggering the uncapped render loop in GLTextureView.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SKGLTextureView.cs",
        "lines": "36-43",
        "finding": "SKGLTextureView extends GLTextureView — inherits the uncapped render loop. No frame pacing override.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SKGLSurfaceView.cs",
        "lines": "9-10",
        "finding": "SKGLSurfaceView extends Android's GLSurfaceView which has native VSync. This is the old implementation that capped FPS correctly.",
        "relevance": "related"
      }
    ],
    "workarounds": [
      "Use a time-based game loop instead of frame-based. Alternatively, use a Stopwatch-based frame limiter in the PaintSurface callback to throttle rendering to the desired FPS."
    ],
    "nextQuestions": [
      "Whether adding eglSwapInterval(1) to GLTextureView's EglHelper would work correctly with TextureView-based EGL surfaces",
      "Whether Choreographer-based frame pacing would introduce input latency or other side effects",
      "Whether some users depend on the uncapped behavior for non-display rendering (offscreen rendering, benchmarks)"
    ],
    "resolution": {
      "hypothesis": "The custom GLTextureView does not set eglSwapInterval(1) like Android's built-in GLSurfaceView does. This means eglSwapBuffers returns immediately instead of waiting for the next VSync, causing the render thread to loop as fast as possible.",
      "proposals": [
        {
          "description": "Add egl.EglSwapInterval(eglDisplay, 1) after creating the EGL surface in GLTextureView.EglHelper. This enables VSync, capping FPS to the display refresh rate. This is what Android's GLSurfaceView does internally.",
          "confidence": 0.7,
          "effort": "small"
        },
        {
          "description": "Use Android's Choreographer API to schedule frame callbacks at the display refresh rate. This is the approach the maintainer proposed in comment 9. More robust than raw eglSwapInterval but requires significant refactoring of the GL thread loop.",
          "confidence": 0.65,
          "effort": "large"
        },
        {
          "description": "Users can work around the issue by measuring elapsed time between frames and using delta-time for animations instead of assuming a fixed frame rate. This is the correct game loop pattern regardless of frame rate.",
          "confidence": 0.9,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.8,
      "reason": "Root cause is clear (missing VSync in GLTextureView) but the fix approach needs investigation. Adding eglSwapInterval may not work with TextureView surfaces. Choreographer integration is complex. Issue has been open since 2018 with maintainer acknowledgment."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Labels are already correct — no changes needed",
        "risk": "low",
        "confidence": 0.95,
        "labels": [
          "tenet/performance"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post workaround with time-based animation pattern",
        "risk": "high",
        "confidence": 0.8
      }
    ]
  }
}
