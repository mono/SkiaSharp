{
  "meta": {
    "schemaVersion": "3.0",
    "number": 3430,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-08T15:00:00Z"
  },
  "summary": "NullReferenceException in SKXamlCanvas.Skia when canvas resizes because FreeBitmap destroys the bitmap that CreateBitmap just allocated",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.97
    },
    "area": {
      "value": "area/views.uno",
      "confidence": 0.97
    },
    "platforms": [
      "os/WASM",
      "os/Windows-WinUI"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Use SKXamlCanvas in an Uno Platform Skia-based app",
        "Trigger a canvas size change (e.g. window resize)",
        "DoInvalidate is called, which calls CreateBitmap",
        "CreateBitmap calls FreeBitmap at line 87 (size changed), then creates new bitmap at line 91",
        "CreateBitmap calls FreeBitmap again at line 106 (pixels null), which sets bitmap=null",
        "Back in DoInvalidate, line 72 accesses bitmap.PixelBuffer — NRE"
      ],
      "environmentDetails": "SkiaSharp 3.116.0, Visual Studio (Windows), Uno Platform Skia targets"
    },
    "bugSignals": {
      "severity": "medium",
      "errorType": "crash"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "2.88.9"
      ]
    }
  },
  "analysis": {
    "summary": "The reporter identified a real race condition in SKXamlCanvas.Skia.cs where CreateBitmap calls FreeBitmap twice during a size change, destroying the WriteableBitmap before DoInvalidate can use it. The code path is clear from reading the source.",
    "rationale": "type: The reporter describes a NullReferenceException caused by a logic error in resource management code. The bitmap field is set to null by FreeBitmap and then accessed without a null check. This is clearly broken behavior. area: The bug is in SKXamlCanvas.Skia.cs, which is part of the SkiaSharp.Views.Uno.WinUI.Skia project. This is specific to the Uno Platform Skia rendering path. bugSignals.severity: NRE crash with no workaround, but the trigger is specific (canvas resize on Uno Skia targets). Not critical because it doesn't cause data loss and only affects one platform variant. partner: The bug is in the Uno Platform-specific view layer (SKXamlCanvas.Skia.cs). The reporter MartinZikmund is a well-known Uno Platform contributor. The fix may need coordination with Uno Platform. actionability.suggestedAction: The bug report identifies a clear logic error (double FreeBitmap) confirmed by source code inspection. The fix approach is known but needs verification with tests across all Uno Skia targets and size-change scenarios. platforms: The bug is in SKXamlCanvas.Skia.cs which targets all Uno Platform Skia backends. Reporter selected All platforms, and the code path affects both WASM and WinUI desktop Skia targets. tenets: NullReferenceException crash during canvas resize is a reliability issue — the application crashes during normal window resizing operations with no workaround. regression.isRegression: The SKXamlCanvas.Skia.cs file is relatively new and likely did not exist in 2.88.9. The reporter's last-known-good selection appears to be a form default rather than a tested version, making this a latent bug. versionAnalysis.currentRelevance: The bug is in current source code at a specific line (SKXamlCanvas.Skia.cs:72), confirmed by source inspection and not yet fixed.",
    "codeInvestigation": [],
    "nextQuestions": [
      "Whether this bug also exists in the non-Skia variants of SKXamlCanvas (UWP/WinUI native paths)",
      "Whether the 2.88.9 last-known-good version claim is accurate or just a form default selection",
      "Whether there are other callers or code paths that can trigger the same double-FreeBitmap issue"
    ],
    "resolution": {
      "hypothesis": "CreateBitmap calls FreeBitmap at line 106 to free the old pixel buffer, but this also nulls the bitmap that was just created at line 91. The second FreeBitmap destroys the bitmap unnecessarily because it conflates pixel buffer management with bitmap management.",
      "proposals": [
        {
          "description": "Guard line 72 with `if (bitmap != null)` before accessing bitmap.PixelBuffer. Simple defensive fix that prevents the NRE, but doesn't address the underlying logic issue where CreateBitmap returns with bitmap=null.",
          "confidence": 0.7,
          "effort": "small"
        },
        {
          "description": "Split FreeBitmap into two concerns: one that frees pixels/handle only, and one that frees the bitmap. The second FreeBitmap call at line 106 only needs to free the pixel buffer, not the bitmap. This addresses the root cause by ensuring the bitmap created at line 91 survives the pixel reallocation.",
          "confidence": 0.9,
          "effort": "small"
        },
        {
          "description": "Refactor CreateBitmap so that bitmap creation and pixel buffer allocation are managed separately with their own lifecycle. The bitmap should only be recreated when its dimensions change, and pixels should be reallocated independently. This is the cleanest fix but involves more refactoring.",
          "confidence": 0.85,
          "effort": "medium"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "The bug report identifies a real logic error confirmed by source code inspection. The fix approach is clear but should be verified with a test to ensure the bitmap lifecycle is correct across all size-change scenarios."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add partner/unoplatform label — existing labels are already correct",
        "risk": "low",
        "confidence": 0.92,
        "labels": [
          "partner/unoplatform"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post analysis confirming the bug and describing the root cause",
        "risk": "high",
        "confidence": 0.85
      }
    ]
  }
}
