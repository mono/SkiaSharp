{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3398,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-10T04:10:29Z"
  },
  "summary": "Intermittent crash in sk_canvas_draw_path called from Mapsui's GetMapInfo() during PointerMoved — likely a threading issue in Mapsui, not SkiaSharp",
  "classification": {
    "type": {
      "value": "type/question",
      "confidence": 0.75
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.8
    },
    "platforms": [
      "os/Windows-Classic"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "environmentDetails": "Windows 11, .NET 9.0.7, CoreCLR 9.0.725.31616, Avalonia 11.3.7, Visual Studio (Windows), FluentAvalonia",
      "screenshots": [
        {
          "url": "https://github.com/user-attachments/assets/cf361924-61d3-4773-9689-b4c36b927b71"
        },
        {
          "url": "https://github.com/user-attachments/assets/40e7de45-62b9-42bf-9c05-7073203d9258"
        }
      ]
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "2.88.8.0",
        "2.88.9"
      ]
    }
  },
  "analysis": {
    "summary": "Intermittent crash in native sk_canvas_draw_path called through Mapsui's rendering pipeline during a PointerMoved event. The crash occurs when Mapsui's GetMapInfo() performs rendering (drawing paths with cached SKPath/SKPaint via CacheTracker<T>) concurrently with the main render loop. Since Skia objects are NOT thread-safe, concurrent access causes intermittent native crashes. This is almost certainly a Mapsui threading bug, not a SkiaSharp defect.",
    "rationale": "type: The crash occurs entirely within Mapsui's rendering pipeline. SkiaSharp's DrawPath works correctly when called in a thread-safe manner. The reporter needs guidance that this is a Mapsui threading issue, not a SkiaSharp bug. Reclassifying from type/bug because SkiaSharp is functioning as designed — Skia is documented as not thread-safe. area: The crash site is in core SkiaSharp (SKCanvas.DrawPath → sk_canvas_draw_path), though the root cause is in the caller (Mapsui). No SkiaSharp.Views involvement. platforms: Reporter runs Avalonia desktop on Windows 11. Avalonia uses a non-MAUI, non-WPF windowing model, so Windows-Classic is the closest fit. tenets: Hard crash / process termination during normal usage. actionability.suggestedAction: Root cause is Mapsui's concurrent access to Skia objects. The explanation of Skia's threading contract and the recommendation to report upstream to Mapsui serves as the documentation-based closure. SkiaSharp cannot guard against callers violating threading contracts without unacceptable performance cost. versionAnalysis.currentRelevance: Reporter claims 3.116.0 but DLL shows 2.88.8.0. Cannot determine version relevance without knowing which is actually loaded. The threading issue would exist regardless of version.",
    "codeInvestigation": [],
    "nextQuestions": [
      "Actual SkiaSharp version in use — form says 3.116.0 but comment says DLL is 2.88.8.0",
      "Whether Mapsui has fixed this threading issue in a newer version",
      "Whether the crash could also occur with a single-threaded usage pattern (unlikely given intermittent nature)"
    ],
    "resolution": {
      "hypothesis": "Mapsui's GetMapInfo() renders features (calling SKCanvas.DrawPath with cached SKPath/SKPaint) from the PointerMoved UI event handler while the main render loop is also drawing on the same canvas/objects. Skia is not thread-safe, so concurrent access causes intermittent native crashes.",
      "proposals": [
        {
          "description": "File an issue on Mapsui's GitHub repo describing the concurrent GetMapInfo/render threading issue. The fix needs to be in Mapsui — either by synchronizing GetMapInfo with the render loop, or by using separate Skia objects for hit-testing.",
          "confidence": 0.85,
          "effort": "small"
        },
        {
          "description": "In the user's code, avoid calling GetMapInfo() directly in PointerMoved. Instead, debounce the call or queue it to run after the current render completes. This reduces but may not eliminate concurrent access.",
          "confidence": 0.65,
          "effort": "small"
        },
        {
          "description": "Add a lock in user code around both the render callback and the GetMapInfo call to prevent concurrent Skia access. May cause UI jank but will prevent crashes.",
          "confidence": 0.7,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.8,
      "reason": "Crash is caused by Mapsui's concurrent access to Skia objects from PointerMoved and the render loop. Not a SkiaSharp defect — closing with threading explanation."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Reclassify as question, keep Windows and reliability labels",
        "risk": "low",
        "confidence": 0.75,
        "labels": [
          "type/question"
        ]
      },
      {
        "type": "add-comment",
        "description": "Explain threading root cause and point to Mapsui as the responsible project",
        "risk": "high",
        "confidence": 0.8
      },
      {
        "type": "close-issue",
        "description": "Close as external — root cause is in Mapsui, not SkiaSharp",
        "risk": "medium",
        "confidence": 0.75
      }
    ]
  }
}
