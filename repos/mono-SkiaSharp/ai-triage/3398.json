{
  "meta": {
    "schemaVersion": "2.0",
    "number": 3398,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-08T15:00:00Z",
    "currentLabels": ["type/bug", "os/Windows-Classic", "tenet/reliability"]
  },
  "summary": "Intermittent crash in SKCanvas.DrawPath during Mapsui rendering in Avalonia desktop app on Windows 11, likely caused by threading violation in Mapsui",
  "classification": {
    "type": { "value": "type/bug", "confidence": 0.75 },
    "area": { "value": "area/SkiaSharp", "confidence": 0.85 },
    "backends": null,
    "platforms": [{ "value": "os/Windows-Classic", "confidence": 0.90 }],
    "tenets": [{ "value": "tenet/reliability", "confidence": 0.95 }],
    "partner": null
  },
  "evidence": {
    "bugSignals": {
      "hasCrash": true,
      "hasStackTrace": true,
      "reproQuality": "steps-only",
      "hasWorkaround": false,
      "workaroundSummary": null,
      "targetFrameworks": ["net9.0"],
      "severity": "medium",
      "severityReason": "Hard crash but intermittent, and strong evidence points to a threading violation in the third-party Mapsui library rather than a SkiaSharp defect."
    },
    "reproEvidence": {
      "screenshots": [
        {
          "url": "https://github.com/user-attachments/assets/cf361924-61d3-4773-9689-b4c36b927b71",
          "context": "Crash-related screenshot shown in description alongside text about crash when drawing graphics",
          "source": "description"
        },
        {
          "url": "https://github.com/user-attachments/assets/40e7de45-62b9-42bf-9c05-7073203d9258",
          "context": "Crash-related screenshot shown in description alongside text about crash when drawing graphics",
          "source": "description"
        }
      ],
      "stepsToReproduce": [
        "Create an Avalonia desktop application using Mapsui for map rendering (Avalonia 11.3.7, SkiaSharp 2.88.8.0)",
        "Subscribe to the PointerMoved event on the MapControl",
        "In the PointerMoved handler, call GetMapInfo() to query map features",
        "Interact with the map by moving the pointer — crash occurs intermittently but frequently"
      ],
      "codeSnippets": [
        {
          "language": "text",
          "code": "at SkiaSharp.SkiaApi.sk_canvas_draw_path(IntPtr, IntPtr, IntPtr)\n   at SkiaSharp.SKCanvas.DrawPath(SkiaSharp.SKPath, SkiaSharp.SKPaint)\n   at Mapsui.Rendering.Skia.Extensions.SkCanvasExtensions.DrawPath(...)\n   at Mapsui.Rendering.Skia.LineStringRenderer.Draw(...)\n   at Mapsui.Rendering.Skia.MapRenderer.GetMapInfo(...)\n   at Mapsui.UI.Avalonia.MapControl.GetMapInfo(...)\n   at AeroSpirit.ViewModels.TaskMonitor.FlightControlViewModel.MapControl_PointerMoved(...)",
          "context": "Stack trace from comment 3 showing crash in sk_canvas_draw_path called through Mapsui rendering pipeline during PointerMoved event"
        }
      ],
      "environmentDetails": "Windows 11, .NET 9.0.7, Avalonia 11.3.7, SkiaSharp DLL version 2.88.8.0 (form says 3.116.0 but comment corrects to 2.88.8), Visual Studio (Windows)"
    },
    "versionAnalysis": {
      "mentionedVersions": ["3.116.0", "2.88.9", "2.88.8"],
      "currentRelevance": "unknown",
      "reason": "Reporter selected 3.116.0 in the form but corrected to 2.88.8.0 in a comment. The threading crash pattern would likely occur in any SkiaSharp version since SkiaSharp objects are inherently not thread-safe."
    },
    "regression": {
      "isRegression": false,
      "confidence": 0.60,
      "reason": "Reporter selected 2.88.9 as last known good and 3.116.0 as current, but then stated the actual DLL version is 2.88.8.0. The version information is contradictory and unreliable. The intermittent threading crash pattern could exist in any version."
    },
    "fixStatus": null
  },
  "analysis": {
    "summary": "Intermittent crash in SKCanvas.DrawPath when Mapsui renders map features during concurrent GetMapInfo() queries triggered by PointerMoved. The crash pattern and stack trace strongly suggest a threading violation in Mapsui, not a SkiaSharp defect. SkiaSharp objects are not thread-safe and concurrent access causes exactly this type of intermittent native crash.",
    "keySignals": [
      {
        "text": "always collapse when drawing graphics, Occasionally, it does not necessarily appear, but it appears frequently",
        "source": "body",
        "interpretation": "Intermittent nature is a classic sign of a race condition or threading violation rather than a deterministic bug"
      },
      {
        "text": "The crash indeed occurred during the process of using MapInfo's query GetMapInfo(). It was retrieving MapInfo in the PointerMoved event.",
        "source": "body",
        "interpretation": "GetMapInfo() in PointerMoved likely triggers concurrent access to SkiaSharp objects while Mapsui is rendering, causing a threading violation"
      },
      {
        "text": "at SkiaSharp.SkiaApi.sk_canvas_draw_path(IntPtr, IntPtr, IntPtr) ... at Mapsui.Rendering.Skia.LineStringRenderer.Draw",
        "source": "comment 3",
        "interpretation": "Stack trace shows the crash path is entirely through Mapsui's rendering pipeline calling into SkiaSharp. No SkiaSharp-internal bug is evident."
      },
      {
        "text": "Looks more like a Mapsui issue? There's doesn't look like there's anything here that suggests that SkiaSharp is at fault...",
        "source": "comment 4",
        "interpretation": "Community member independently identified this as likely a Mapsui issue, corroborating the threading violation hypothesis"
      },
      {
        "text": "the SkiaSharp.dll version is 2.88.8.0",
        "source": "comment 2",
        "interpretation": "Contradicts the form selection of 3.116.0. Actual version is 2.88.8.0, making the regression claim unreliable."
      }
    ],
    "fieldRationales": [
      {
        "field": "type",
        "chosen": "type/bug",
        "expandedReason": "The reporter describes a hard crash (process termination) with a full stack trace. Even though the root cause is likely in Mapsui's threading, the crash manifests in SkiaSharp's native code, so classifying as bug is appropriate for tracking. Confidence is lower (0.75) because this is likely an upstream issue.",
        "alternatives": [{ "value": "type/question", "whyRejected": "This is a real crash with a stack trace, not a how-to question. Even if the root cause is usage, the symptom is broken behavior." }]
      },
      {
        "field": "area",
        "chosen": "area/SkiaSharp",
        "expandedReason": "The crash occurs in the core SKCanvas.DrawPath API (sk_canvas_draw_path P/Invoke). This is the core SkiaSharp library, not Views, HarfBuzz, or native loading. Avalonia manages its own Skia surface.",
        "alternatives": [{ "value": "area/SkiaSharp.Views", "whyRejected": "The crash is in the core SKCanvas API, not in any View control. Avalonia uses its own view layer." }]
      },
      {
        "field": "bugSignals.severity",
        "chosen": "medium",
        "expandedReason": "Hard crash is typically high/critical, but downgraded to medium because: (1) it's intermittent, (2) it's almost certainly caused by threading misuse in Mapsui rather than a SkiaSharp defect, and (3) throttling GetMapInfo calls is a viable workaround.",
        "alternatives": [{ "value": "high", "whyRejected": "Would be appropriate if this were a confirmed SkiaSharp defect, but evidence strongly points to upstream misuse." }]
      },
      {
        "field": "actionability.suggestedAction",
        "chosen": "request-info",
        "expandedReason": "Before closing, we should confirm the version confusion and gently redirect the reporter to Mapsui. Asking for a minimal reproduction without Mapsui would confirm whether SkiaSharp is at fault.",
        "alternatives": [
          { "value": "convert-to-discussion", "whyRejected": "There is a real crash occurring, which merits a proper issue response rather than a discussion redirect." },
          { "value": "needs-investigation", "whyRejected": "The stack trace is clear enough — investigation would just confirm the threading hypothesis. Better to request info and redirect upstream." }
        ]
      }
    ],
    "uncertainties": [
      "Cannot view the screenshots in the issue body — they may contain additional diagnostic information",
      "Exact SkiaSharp version is uncertain: form says 3.116.0, comment says 2.88.8.0",
      "Whether the crash can be reproduced without Mapsui (with just concurrent SKCanvas.DrawPath calls) is unknown",
      "Whether Mapsui has documented thread-safety requirements for GetMapInfo() is unknown"
    ],
    "assumptions": [
      "Assumed the crash is a threading violation based on the intermittent nature and the concurrent GetMapInfo/PointerMoved pattern",
      "Assumed SkiaSharp DLL version 2.88.8.0 (from comment) is more accurate than the 3.116.0 form selection",
      "Assumed .NET 9.0 based on the stack trace showing CoreCLR Version: 9.0.725.31616"
    ],
    "resolution": {
      "hypothesis": "Mapsui is accessing SkiaSharp objects (SKCanvas, SKPath, SKPaint) concurrently from its rendering thread and the UI thread handling GetMapInfo() in PointerMoved. SkiaSharp objects are not thread-safe, and this concurrent access causes an intermittent native crash in sk_canvas_draw_path.",
      "proposals": [
        {
          "title": "Redirect to Mapsui project",
          "description": "Guide the reporter to file this issue with the Mapsui project, as the threading violation is in their rendering code. Mapsui needs to add synchronization around their SkiaSharp calls.",
          "confidence": 0.80,
          "effort": "low"
        },
        {
          "title": "Suggest workaround: throttle GetMapInfo calls",
          "description": "Advise the reporter to debounce or throttle GetMapInfo() calls in PointerMoved to reduce concurrent access to SkiaSharp objects. This treats the symptom but provides an immediate fix.",
          "confidence": 0.70,
          "effort": "low"
        },
        {
          "title": "Request minimal reproduction without Mapsui",
          "description": "Ask the reporter to reproduce the crash with plain SkiaSharp code (concurrent DrawPath calls from two threads) to definitively confirm whether SkiaSharp itself has a bug or this is purely a Mapsui concurrency issue.",
          "confidence": 0.60,
          "effort": "medium"
        }
      ],
      "recommendedProposal": "Redirect to Mapsui project",
      "recommendedReason": "The stack trace clearly shows Mapsui's rendering pipeline as the call site, and the intermittent crash pattern matches a threading violation. The most effective resolution is for Mapsui to add proper synchronization. A workaround suggestion should also be included."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "request-info",
      "confidence": 0.80,
      "reason": "The stack trace shows the crash originates from Mapsui's rendering pipeline calling SkiaSharp, with the intermittent nature strongly suggesting a threading violation. A community member also flagged this as likely a Mapsui issue. Should confirm version confusion and redirect to Mapsui before closing.",
      "missingInfo": ["sample-project", "version-number"]
    },
    "actions": [
      {
        "id": "labels-1",
        "type": "update-labels",
        "risk": "low",
        "description": "Add area/SkiaSharp label to match classification",
        "reason": "Issue crashes in core SKCanvas.DrawPath API; area label is missing from current labels",
        "confidence": 0.85,
        "dependsOn": null,
        "payload": {
          "labelsToAdd": ["area/SkiaSharp"],
          "labelsToRemove": []
        }
      },
      {
        "id": "comment-1",
        "type": "add-comment",
        "risk": "high",
        "description": "Post analysis explaining likely threading violation and redirect to Mapsui",
        "reason": "Reporter needs version clarification, threading explanation, and upstream redirect to Mapsui project",
        "confidence": 0.80,
        "dependsOn": "labels-1",
        "payload": {
          "commentType": "request-info",
          "draftBody": "Thanks for the stack trace in your follow-up comment — that's really helpful for narrowing this down.\n\nLooking at the stack, the crash is inside `Mapsui.Rendering.Skia.LineStringRenderer.Draw` → `SKCanvas.DrawPath`. The intermittent nature combined with the fact that you're calling `GetMapInfo()` inside `PointerMoved` suggests this may be a concurrency issue — Mapsui's rendering and your query call may be accessing the same SkiaSharp objects (SKCanvas, SKPath, SKPaint) simultaneously. SkiaSharp objects are not thread-safe, and concurrent access causes exactly this kind of intermittent crash.\n\nA couple of things that would help clarify:\n\n1. **Version**: You selected 3.116.0 in the form but mentioned 2.88.8.0 in a comment — could you confirm which version you're actually using? (`dotnet list package` in your project directory would show the exact NuGet version.)\n\n2. **Mapsui**: This crash pattern is very likely a threading bug in Mapsui rather than in SkiaSharp itself. Would you be able to report this to the [Mapsui project](https://github.com/Mapsui/Mapsui/issues) as well? They would be best positioned to add the necessary synchronization.\n\nAs an immediate workaround, you could try debouncing or throttling your `GetMapInfo()` calls in `PointerMoved`, or ensuring they don't run concurrently with map rendering.",
          "requiresHumanEdit": true,
          "finalBody": null,
          "dedupeToken": "triage-3398-comment-1"
        }
      }
    ]
  }
}
