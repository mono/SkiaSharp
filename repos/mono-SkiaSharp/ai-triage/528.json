{
  "meta": {
    "schemaVersion": "2.0",
    "number": 528,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-11T13:49:00Z",
    "currentLabels": ["status/help-wanted", "os/Android"]
  },
  "summary": "HarfBuzz Shape() returns all-zero codepoints on Android; workaround is to use SKTypeface.FromData instead of SKTypeface.FromStream.",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.90
    },
    "area": {
      "value": "area/SkiaSharp.HarfBuzz",
      "confidence": 0.95
    },
    "backends": null,
    "platforms": [
      {
        "value": "os/Android",
        "confidence": 0.95
      }
    ],
    "tenets": null,
    "partner": null
  },
  "evidence": {
    "bugSignals": {
      "hasCrash": false,
      "hasStackTrace": false,
      "reproQuality": "partial",
      "hasWorkaround": true,
      "workaroundSummary": "Use SKTypeface.FromData(data) instead of SKTypeface.FromStream(stream) when loading fonts for HarfBuzz shaping on Android. This produces correct non-zero codepoints.",
      "severity": "medium",
      "severityReason": "HarfBuzz shaping is completely broken on Android when using FromStream, producing all-zero codepoints which renders text incorrectly. However, a reliable workaround exists using FromData instead of FromStream."
    },
    "reproEvidence": {
      "stepsToReproduce": [
        "Create an Android project using SkiaSharp.HarfBuzz",
        "Load a font using SKTypeface.FromStream(stream)",
        "Create an SKShaper and call Shape() with the loaded typeface",
        "Inspect the resulting codepoints — they are all zero on Android",
        "Compare with the same code on WPF or iOS where codepoints are correct"
      ],
      "codeSnippets": [
        {
          "language": "csharp",
          "code": "// Broken on Android:\nvar typeface = SKTypeface.FromStream(stream);\nvar shaper = new SKShaper(typeface);\nvar result = shaper.Shape(text, paint); // codepoints all 0\n\n// Workaround:\nvar data = SKData.Create(stream);\nvar typeface = SKTypeface.FromData(data);\nvar shaper = new SKShaper(typeface);\nvar result = shaper.Shape(text, paint); // codepoints correct",
          "context": "Demonstrates the bug and workaround: FromStream produces zeroed codepoints, FromData works correctly on Android."
        }
      ],
      "environmentDetails": "Android platform. Tested with multiple fonts including Arial, SF-UI-Display-Bold, and Roboto. Works correctly on WPF and iOS."
    },
    "versionAnalysis": {
      "currentRelevance": "unknown",
      "reason": "The issue was reported in 2018. HarfBuzz has been updated significantly since then, and the underlying cause may have been resolved in newer versions of both HarfBuzz and SkiaSharp."
    },
    "regression": null,
    "fixStatus": {
      "likelyFixed": false,
      "confidence": 0.35,
      "reason": "No explicit fix has been reported, but HarfBuzz and SkiaSharp have undergone major updates since 2018. The underlying stream handling on Android may have been fixed incidentally.",
      "verificationStatus": "unverified"
    }
  },
  "analysis": {
    "summary": "HarfBuzz Shape() returns all-zero codepoints on Android due to an issue with how SKTypeface.FromStream handles font data on that platform. The problem is traced to the hb_shape C++ call receiving invalid font data. Using FromData instead of FromStream is a confirmed workaround.",
    "keySignals": [
      {
        "text": "Shape() Codepoints all 0 on Android",
        "source": "title",
        "interpretation": "The core symptom: HarfBuzz shaping produces invalid zero codepoints, meaning text rendering will be completely wrong."
      },
      {
        "text": "Works on WPF/iOS but not Android",
        "source": "body",
        "interpretation": "Platform-specific bug on Android. The same code works on other platforms, pointing to an Android-specific issue in font loading or stream handling."
      },
      {
        "text": "Use SKTypeface.FromData(data) instead of SKTypeface.FromStream(stream)",
        "source": "comment 6",
        "interpretation": "A confirmed workaround found by the reporter. This suggests the bug is in how FromStream provides data to HarfBuzz on Android, not in HarfBuzz itself."
      },
      {
        "text": "Problem traced to hb_shape C++ call zeroing out codepoints",
        "source": "body",
        "interpretation": "The reporter debugged down to the native layer, confirming the issue is in the HarfBuzz native shaping call when fed a stream-based typeface on Android."
      },
      {
        "text": "Confirmed with multiple fonts (Arial, SF-UI-Display-Bold, Roboto)",
        "source": "body",
        "interpretation": "Not font-specific. The bug affects all fonts loaded via FromStream on Android, ruling out corrupt font data."
      }
    ],
    "fieldRationales": [
      {
        "field": "type",
        "chosen": "type/bug",
        "expandedReason": "HarfBuzz Shape() returns all-zero codepoints on Android, which is clearly broken behavior. The same code works correctly on WPF and iOS, confirming this is a platform-specific bug rather than a usage error.",
        "alternatives": [
          {
            "value": "type/question",
            "whyRejected": "This is not a usage question. The reporter demonstrated correct usage that works on other platforms but fails on Android."
          }
        ]
      },
      {
        "field": "area",
        "chosen": "area/SkiaSharp.HarfBuzz",
        "expandedReason": "The issue is in SKShaper.Shape() which is part of the SkiaSharp.HarfBuzz package. The bug manifests in the HarfBuzz shaping pipeline when using stream-loaded typefaces on Android.",
        "alternatives": [
          {
            "value": "area/SkiaSharp",
            "whyRejected": "While SKTypeface.FromStream is in core SkiaSharp, the bug only manifests through HarfBuzz shaping. The area/SkiaSharp.HarfBuzz label is more specific and accurate."
          }
        ]
      },
      {
        "field": "platforms",
        "chosen": "os/Android",
        "expandedReason": "The bug is Android-specific. The reporter confirmed the same code works on WPF and iOS. Multiple fonts were tested on Android and all produce zero codepoints."
      },
      {
        "field": "bugSignals.severity",
        "chosen": "medium",
        "expandedReason": "HarfBuzz shaping is completely non-functional on Android when using FromStream, which would be a high severity issue. However, a reliable workaround exists (using FromData instead of FromStream), bringing the effective severity down to medium.",
        "alternatives": [
          {
            "value": "high",
            "whyRejected": "A working workaround (FromData) is available and confirmed, so users are not fully blocked."
          },
          {
            "value": "low",
            "whyRejected": "The feature is completely broken without the workaround, and it's not obvious that FromData would fix it. This is more impactful than a cosmetic issue."
          }
        ]
      },
      {
        "field": "actionability.suggestedAction",
        "chosen": "needs-investigation",
        "expandedReason": "The issue is 7+ years old and HarfBuzz has been significantly updated since. It should be investigated whether this bug still exists with current SkiaSharp/HarfBuzz versions. If fixed, the issue can be closed. If not, the FromStream/FromData discrepancy on Android should be root-caused.",
        "alternatives": [
          {
            "value": "keep-open",
            "whyRejected": "Simply keeping it open without investigation is not productive given how old the issue is. Active investigation is needed to determine current status."
          }
        ]
      },
      {
        "field": "versionAnalysis.currentRelevance",
        "chosen": "unknown",
        "expandedReason": "The issue was reported in 2018 against an older version of SkiaSharp and HarfBuzz. Both libraries have been substantially updated since then. It is unknown whether the bug persists in current versions."
      },
      {
        "field": "fixStatus.likelyFixed",
        "chosen": "false",
        "expandedReason": "No explicit fix has been documented or referenced. While HarfBuzz updates may have incidentally resolved the issue, there is no evidence of this. The low confidence (0.35) reflects the high uncertainty."
      }
    ],
    "uncertainties": [
      "Whether the bug still reproduces with current versions of SkiaSharp and HarfBuzz, given significant updates to both libraries since 2018.",
      "The exact root cause of why FromStream and FromData behave differently for HarfBuzz on Android — whether it is a stream lifecycle issue, a memory mapping difference, or a platform-specific native code path."
    ],
    "assumptions": [
      "The reporter's workaround (FromData vs FromStream) was correctly identified and is reliable, as confirmed by the maintainer's acknowledgment.",
      "The issue is specific to Android's native handling of stream-based typefaces rather than a general HarfBuzz bug, since iOS and WPF work correctly."
    ],
    "resolution": {
      "hypothesis": "SKTypeface.FromStream on Android does not properly expose font data to HarfBuzz's native hb_shape function, causing it to receive invalid or empty data and produce all-zero codepoints. FromData works because it loads the entire font into memory upfront, ensuring HarfBuzz has access to the complete font data.",
      "proposals": [
        {
          "title": "Use FromData workaround",
          "description": "Users can work around the issue by loading font data into SKData first and then creating the typeface with SKTypeface.FromData instead of SKTypeface.FromStream.",
          "confidence": 0.90,
          "effort": "low",
          "category": "workaround",
          "codeSnippet": "// Instead of:\n// var typeface = SKTypeface.FromStream(stream);\n\n// Use:\nusing var data = SKData.Create(stream);\nvar typeface = SKTypeface.FromData(data);",
          "validated": "yes"
        },
        {
          "title": "Verify with current SkiaSharp version",
          "description": "Test the original reproduction case with the latest SkiaSharp and HarfBuzz packages to determine if the issue has been resolved by upstream updates.",
          "confidence": 0.50,
          "effort": "low",
          "category": "investigation",
          "validated": "untested"
        },
        {
          "title": "Fix FromStream to fully materialize data for HarfBuzz on Android",
          "description": "Investigate and fix the SKTypeface.FromStream code path on Android to ensure font data is fully available to HarfBuzz. This may involve ensuring the stream is fully read into memory before passing to the native layer.",
          "confidence": 0.65,
          "effort": "medium",
          "category": "fix",
          "validated": "untested"
        }
      ],
      "recommendedProposal": "Verify with current SkiaSharp version",
      "recommendedReason": "The issue is 7+ years old and both SkiaSharp and HarfBuzz have been significantly updated. Before investing in a fix, verify whether the bug still exists. If it does, the FromData workaround is available for users in the meantime."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.80,
      "reason": "The issue is 7+ years old with significant updates to HarfBuzz since then. Investigation is needed to determine if the bug persists in current versions before taking further action.",
      "requiresHumanReview": true
    },
    "actions": [
      {
        "id": "labels-1",
        "type": "update-labels",
        "risk": "low",
        "description": "Add type/bug and area/SkiaSharp.HarfBuzz labels to properly classify the issue",
        "reason": "The issue is a confirmed bug in HarfBuzz shaping on Android. Currently only has status/help-wanted and os/Android labels, missing the type and area classification.",
        "confidence": 0.90,
        "dependsOn": null,
        "payload": {
          "labelsToAdd": ["type/bug", "area/SkiaSharp.HarfBuzz"],
          "labelsToRemove": []
        }
      },
      {
        "id": "comment-1",
        "type": "add-comment",
        "risk": "high",
        "description": "Document the FromData workaround and note that HarfBuzz has been updated since this report",
        "reason": "The workaround should be clearly documented for users finding this issue. Additionally, the issue should note that HarfBuzz has been significantly updated and verification with current versions is needed.",
        "confidence": 0.80,
        "dependsOn": null,
        "payload": {
          "commentType": "workaround",
          "draftBody": "**Workaround:** Use `SKTypeface.FromData` instead of `SKTypeface.FromStream` when loading fonts for HarfBuzz shaping on Android:\n\n```csharp\n// Instead of:\n// var typeface = SKTypeface.FromStream(stream);\n\n// Use:\nusing var data = SKData.Create(stream);\nvar typeface = SKTypeface.FromData(data);\n```\n\nThis issue was reported in 2018 and HarfBuzz has been significantly updated since then. It would be worth verifying whether this bug still reproduces with the current version of SkiaSharp.",
          "requiresHumanEdit": true,
          "finalBody": null,
          "dedupeToken": "triage-528-workaround-fromdata"
        }
      }
    ]
  }
}
