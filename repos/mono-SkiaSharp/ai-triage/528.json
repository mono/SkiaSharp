{
  "meta": {
    "schemaVersion": "3.0",
    "number": 528,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-23T12:00:00Z"
  },
  "summary": "SKShaper.Shape() returns all-zero Codepoints on Android when typeface created via SKTypeface.FromStream — workaround is to use SKTypeface.FromData instead",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/harfbuzz",
      "confidence": 0.9
    },
    "platforms": [
      "os/Android"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Load a TTF/OTF font via SKTypeface.FromStream(stream) on Android",
        "Create an SKShaper with the typeface",
        "Call shaper.Shape(\"Hello world!\", x, y, paint)",
        "Observe that result.Codepoints are all 0"
      ],
      "attachments": [
        {
          "url": "https://github.com/mono/SkiaSharp/files/2035982/HarfBuzzDemo.zip",
          "filename": "HarfBuzzDemo.zip"
        }
      ],
      "environmentDetails": "Android (emulator x86 and LG G4 ARMv8); works on WPF and iOS",
      "codeSnippets": [
        "csharp: var shaper = new SKShaper(paint.Typeface);\nvar result = shaper.Shape(\"Hello world!\", 10, 300, paint); // result.Codepoints are all 0"
      ]
    },
    "bugSignals": {
      "severity": "medium"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "1.60.0"
      ]
    }
  },
  "analysis": {
    "summary": "Android-specific bug where SKShaper.Shape() returned all-zero Codepoints when the typeface was created via SKTypeface.FromStream(). The reporter found that using SKTypeface.FromData() as a workaround fixed the issue. Current code in SKTypeface.FromStream now converts managed streams to memory streams before passing to native Skia, which is functionally the same as the FromData path and likely resolves this issue.",
    "rationale": "type: Reporter describes a clear functional failure: Shape() returns all-zero codepoints on Android while working on iOS and WPF. This is broken behavior, not a usage question or feature request. area: The bug manifests in SKShaper.Shape() which is in the SkiaSharp.HarfBuzz package. The root cause involves the interaction between SKTypeface stream handling and HarfBuzz blob creation. bugSignals.severity: Functional breakage of text shaping on Android — HarfBuzz output is unusable. However, a clean workaround exists (FromData instead of FromStream) and the issue doesn't crash the app. platforms: Reporter explicitly states the issue only occurs on Android (emulator x86 and phone ARMv8), while iOS and WPF work correctly. tenets: Cross-platform inconsistency: the same code works on iOS and WPF but fails on Android, indicating a platform compatibility issue in stream handling. actionability.suggestedAction: SKTypeface.FromStream now converts managed streams to memory streams (equivalent to the FromData workaround). The issue is from 2018 and the root cause has been addressed in the current codebase. fixStatus.likelyFixed: The current FromStream implementation converts managed streams to memory streams before native handoff (SKTypeface.cs:105-108), matching the FromData workaround that resolved the issue. versionAnalysis.currentRelevance: Issue filed against 1.60.x era SkiaSharp. Current code has the managed-to-memory stream conversion in FromStream and an updated HarfBuzz, both of which address the likely root cause.",
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp/SKTypeface.cs",
        "lines": "100-113",
        "finding": "FromStream now converts SKManagedStream to memory stream (line 105-108) before passing to native code. This is functionally the same as the FromData workaround — the data is fully copied to memory. This change likely fixes the original bug.",
        "relevance": "related"
      },
      {
        "file": "binding/SkiaSharp/SKTypeface.cs",
        "lines": "115-121",
        "finding": "FromData calls sk_typeface_create_from_data directly with an SKData handle. This path always worked because SKData holds a contiguous memory buffer — confirming the workaround.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz/SKShaper.cs",
        "lines": "15-33",
        "finding": "SKShaper constructor calls Typeface.OpenStream() then ToHarfBuzzBlob(). If the typeface's internal stream data was incomplete (due to the old FromStream bug), HarfBuzz would receive garbled data and fail to resolve glyph codepoints.",
        "relevance": "related"
      },
      {
        "file": "source/SkiaSharp.HarfBuzz/SkiaSharp.HarfBuzz/BlobExtensions.cs",
        "lines": "10-38",
        "finding": "ToHarfBuzzBlob reads the stream's memory base or copies data. If the stream asset's backing memory was invalid on Android, HarfBuzz would get bad font data, explaining the all-zero codepoints.",
        "relevance": "related"
      }
    ],
    "workarounds": [
      "Use SKTypeface.FromData(SKData.Create(stream)) instead of SKTypeface.FromStream(stream). The FromData path produces a typeface whose OpenStream data is correctly read by HarfBuzz on Android."
    ],
    "nextQuestions": [
      "Cannot verify the fix on actual Android hardware from this environment",
      "The exact Skia/HarfBuzz version that introduced the memory stream conversion is unknown"
    ],
    "resolution": {
      "hypothesis": "SKTypeface.FromStream on Android did not fully materialize the font data in memory, causing HarfBuzz to receive invalid/incomplete blob data and fail to resolve glyph codepoints. The current code fixes this by converting managed streams to memory streams.",
      "proposals": [
        {
          "description": "The original workaround found by the reporter: create SKData from the stream first, then use SKTypeface.FromData(). This forces a full memory copy of the font data.",
          "confidence": 0.95,
          "effort": "small"
        },
        {
          "description": "Current SkiaSharp 3.x has the managed-to-memory stream conversion built into FromStream, making it functionally equivalent to the FromData workaround. Upgrading should resolve the issue without code changes.",
          "confidence": 0.8,
          "effort": "small"
        },
        {
          "description": "For system fonts like Arial or Roboto, use SKTypeface.FromFamilyName() which avoids the stream path entirely. Maintainer mattleibow confirmed this approach works on Android.",
          "confidence": 0.85,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-as-fixed",
      "confidence": 0.8,
      "reason": "SKTypeface.FromStream now converts managed streams to memory streams (equivalent to the FromData workaround). The issue is from 2018 and the root cause has been addressed in the current codebase."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Apply bug, HarfBuzz, Android, compatibility labels",
        "risk": "low",
        "confidence": 0.9,
        "labels": [
          "type/bug",
          "area/SkiaSharp.HarfBuzz",
          "os/Android",
          "tenet/compatibility"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post close message explaining the fix",
        "risk": "high",
        "confidence": 0.8
      },
      {
        "type": "close-issue",
        "description": "Close as fixed",
        "risk": "medium",
        "confidence": 0.8
      }
    ]
  }
}
