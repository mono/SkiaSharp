{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3423,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-07-17T18:00:00Z"
  },
  "summary": "ClickOnce deployment of .NET Framework 4.7.2 WinForms app fails to include libSkiaSharp.dll, causing DllNotFoundException",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.92
    },
    "area": {
      "value": "area/libSkiaSharp.native",
      "confidence": 0.95
    },
    "platforms": [
      "os/Windows-Classic"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a .NET Framework 4.7.2 WinForms application",
        "Add SkiaSharp and SkiaSharp.NativeAssets.Win32 NuGet packages",
        "Use SKBitmap.Decode() or any SkiaSharp API",
        "Publish the application using ClickOnce deployment from Visual Studio",
        "Run the published ClickOnce application — DllNotFoundException occurs"
      ],
      "environmentDetails": ".NET Framework 4.7.2, WinForms, Visual Studio 2022 (Windows), SkiaSharp 3.119.1 (description) / 3.116.0 (version dropdown), Windows 10 and Windows 11, Dell workstations, ClickOnce deployment",
      "codeSnippets": [
        "csharp: var image = SKBitmap.Decode(imageData ?? throw new ArgumentNullException(nameof(imageData)))"
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "errorType": "crash"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.119.1",
        "3.116.0"
      ]
    }
  },
  "analysis": {
    "summary": "ClickOnce deployment of a .NET Framework 4.7.2 WinForms app fails to include the native libSkiaSharp.dll from the NativeAssets.Win32 NuGet package, causing DllNotFoundException at runtime. This is a well-understood ClickOnce limitation with NuGet runtimes/ directory native assets, not a SkiaSharp code defect. A community workaround exists and is confirmed working by both the reporter and another user.",
    "rationale": "type: The native binary fails to deploy in ClickOnce, causing a DllNotFoundException crash. While this is arguably a ClickOnce tooling limitation rather than a SkiaSharp code defect, the user's app breaks when using SkiaSharp with ClickOnce, which qualifies as a bug from the user's perspective. area: DllNotFoundException for the native library. The issue is about native binary deployment, not the managed C# API. platforms: .NET Framework 4.7.2 WinForms is definitively Windows-Classic (Win32 APIs). ClickOnce is a Windows-Classic deployment mechanism. tenets: The application crashes with an unhandled TypeInitializationException/DllNotFoundException. The app fails to function at all when deployed via ClickOnce. bugSignals.severity: Hard crash (DllNotFoundException) but a workaround exists and is confirmed by multiple users. The issue is specific to one deployment method (ClickOnce) while others (MSIX) work. actionability.suggestedAction: The root cause is a ClickOnce limitation, not a SkiaSharp defect. A confirmed workaround exists. The issue could be closed with the documented workaround. However, human review is recommended because SkiaSharp might want to keep this open to track potential packaging improvements. versionAnalysis.currentRelevance: ClickOnce native asset deployment issue persists across SkiaSharp 3.x versions (3.116.0, 3.119.1) due to the runtimes/ folder convention used by NativeAssets packages. The root cause is a ClickOnce tooling limitation, not version-specific.",
    "codeInvestigation": [],
    "workarounds": [
      "Manually add libSkiaSharp.dll from the NativeAssets.Win32 NuGet package (runtimes/win-x64/native/) as an existing item in the VS project, set Build Action to Content and Copy to Output Directory to 'Copy if newer', then verify it appears in ClickOnce Application Files as Include/Required."
    ],
    "nextQuestions": [
      "Whether SkiaSharp's NuGet packaging could be improved to better support ClickOnce (e.g., including native DLLs outside the runtimes/ folder for .NET Framework targets)",
      "Whether the user's project uses packages.config or PackageReference — this affects how NuGet native assets are handled",
      "The user mentions libSkiaSharp.dylib (macOS binary name) in the description but is on Windows — likely a terminology confusion"
    ],
    "resolution": {
      "hypothesis": "ClickOnce deployment does not automatically include native binaries from NuGet packages that use the runtimes/{rid}/native/ directory convention. The SkiaSharp.NativeAssets.Win32 package places libSkiaSharp.dll in runtimes/win-x64/native/ (and win-x86), but ClickOnce's Application Files mechanism doesn't discover files in this path structure. MSIX handles this correctly because it processes the full output directory layout.",
      "proposals": [
        {
          "description": "Manually add libSkiaSharp.dll from the NativeAssets.Win32 package to the project as Content with 'Copy if newer'. This forces ClickOnce to include the native binary. Confirmed working by multiple users, but must be repeated when updating SkiaSharp version.",
          "confidence": 0.95,
          "effort": "small"
        },
        {
          "description": "Add MSBuild targets to SkiaSharp.NativeAssets.Win32 that detect ClickOnce/.NET Framework projects and copy native DLLs to the output directory as content files, bypassing the runtimes/ directory structure. Permanent fix but requires ClickOnce MSBuild integration work.",
          "confidence": 0.6,
          "effort": "medium"
        },
        {
          "description": "Migrate the application from ClickOnce to MSIX deployment, which correctly handles the runtimes/ native asset structure. User confirmed MSIX already works, but this is a significant deployment infrastructure change.",
          "confidence": 0.85,
          "effort": "large"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.75,
      "reason": "The root cause is a ClickOnce limitation with NuGet runtimes/ native assets, not a SkiaSharp defect. A community-confirmed workaround exists. However, human review is recommended — the team may want to keep this open to track packaging improvements."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Labels already match classification — no changes needed",
        "risk": "low",
        "confidence": 0.97
      },
      {
        "type": "add-comment",
        "description": "Post response acknowledging the workaround and explaining root cause",
        "risk": "high",
        "confidence": 0.8
      },
      {
        "type": "close-issue",
        "description": "Close as answered with workaround documented",
        "risk": "medium",
        "confidence": 0.7
      }
    ]
  }
}
