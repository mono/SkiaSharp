{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3423,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T16:41:26Z",
    "currentLabels": ["type/bug", "os/Windows-Classic", "area/libSkiaSharp.native", "tenet/reliability"]
  },
  "summary": "ClickOnce deployment on .NET Framework 4.7.2 fails to include libSkiaSharp.dll in the published application, causing DllNotFoundException at runtime. The MSIX version of the same app works fine. The NativeAssets.Win32 MSBuild .targets file copies native DLLs to the build output via <None> items with CopyToOutputDirectory, but ClickOnce does not pick up these files for its application manifest. A community workaround exists: manually add libSkiaSharp.dll as a Content item in the project.",
  "classification": {
    "type": { "value": "type/bug", "confidence": 0.90 },
    "area": { "value": "area/libSkiaSharp.native", "confidence": 0.95 },
    "platforms": ["os/Windows-Classic"],
    "tenets": ["tenet/compatibility", "tenet/reliability"]
  },
  "evidence": {
    "bugSignals": {
      "severity": "high",
      "errorType": "DllNotFoundException",
      "errorMessage": "Unable to load library 'libSkiaSharp'",
      "stackTrace": "System.TypeInitializationException: The type initializer for 'SkiaSharp.SKData' threw an exception. ---> System.DllNotFoundException: Unable to load library 'libSkiaSharp'.\n   at SkiaSharp.LibraryLoader.LoadLocalLibrary[T](String libraryName)\n   at System.Lazy`1.CreateValue()\n   at System.Lazy`1.LazyInitValue()\n   at SkiaSharp.SkiaApi.sk_data_new_empty()\n   at SkiaSharp.SKData..cctor()",
      "reproQuality": "complete",
      "targetFrameworks": ["net472"]
    },
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a .NET Framework 4.7.2 WinForms app",
        "Add SkiaSharp NuGet package (3.119.1 or 3.116.0)",
        "Use SKBitmap.Decode() in the app",
        "Publish with ClickOnce",
        "Run the ClickOnce-deployed app"
      ],
      "codeSnippets": [
        "var image = SKBitmap.Decode(imageData ?? throw new ArgumentNullException(nameof(imageData)))"
      ],
      "environmentDetails": "Windows 10/11, .NET Framework 4.7.2 WinForms, Visual Studio (Windows), ClickOnce deployment",
      "relatedIssues": [1327]
    },
    "versionAnalysis": {
      "mentionedVersions": ["3.119.1", "3.116.0"],
      "currentRelevance": "likely",
      "relevanceReason": "The NativeAssets.Win32 .targets file still uses <None> items with CopyToOutputDirectory which ClickOnce does not include in its application manifest. This packaging approach has not changed."
    }
  },
  "analysis": {
    "summary": "ClickOnce deployment ignores native DLLs added by the SkiaSharp.NativeAssets.Win32 .targets file because they use <None> with CopyToOutputDirectory=PreserveNewest. ClickOnce requires items to be project Content with explicit application manifest inclusion. The build output (bin/Debug) contains the DLLs correctly, so development works, but ClickOnce publish does not include them. This is a long-standing packaging limitation — issue #1327 reported the identical problem in 2020.",
    "rationale": "Classified as type/bug because the native DLLs should be deployed with the application but are silently omitted during ClickOnce publish, causing a runtime crash. Area is libSkiaSharp.native since the root cause is how the NativeAssets package delivers the native binary for ClickOnce scenarios. Severity is high because the app crashes on first use of any SkiaSharp API. The existing labels are already accurate.",
    "keySignals": [
      { "text": "DllNotFoundException: Unable to load library 'libSkiaSharp'", "source": "issue body", "interpretation": "The native DLL is missing from the deployment — not a loading-order or dependency issue." },
      { "text": "MSIX version of the app does not however [have this problem]", "source": "issue body", "interpretation": "MSIX handles runtimes/ folder content natively; ClickOnce does not. Confirms packaging mechanism difference is the root cause." },
      { "text": "libSkiaSharp.dylib is not being included in the ClickOnce publish", "source": "issue body", "interpretation": "Reporter correctly identified the missing file — though on Windows it's libSkiaSharp.dll, not .dylib." },
      { "text": "right click on the added dll file, Properties, select Build Action = Content and Copy to Output Directory = Copy if newer", "source": "comment #2 (ERPCG)", "interpretation": "Community-confirmed workaround: manually adding the DLL as Content forces ClickOnce to include it in the application manifest." },
      { "text": "That was how I fixed it too", "source": "comment #3 (OP)", "interpretation": "OP confirms the workaround resolves the issue. Two independent confirmations." }
    ],
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp.NativeAssets.Win32/buildTransitive/net4/SkiaSharp.targets",
        "lines": "10-27",
        "finding": "The .targets file adds native DLLs as <None> items with CopyToOutputDirectory=PreserveNewest. This copies DLLs to build output but ClickOnce does not include <None> items in its application manifest — only <Content> items are published.",
        "relevance": "direct"
      },
      {
        "file": "binding/Binding.Shared/LibraryLoader.cs",
        "lines": "34-86",
        "finding": "LibraryLoader searches assembly location, current directory, AppDomain paths, and architecture subdirectories (x86/x64/arm64). The loading logic itself is correct — the problem is the DLL never reaches the deployment directory.",
        "relevance": "related"
      },
      {
        "file": "binding/SkiaSharp.NativeAssets.Win32/SkiaSharp.NativeAssets.Win32.csproj",
        "finding": "Project defines NativeAssetPackageFile items for win-x64, win-x86, win-arm64 which are placed in runtimes/ folder. The buildTransitive/net4/ targets handle net462 deployment.",
        "relevance": "context"
      }
    ],
    "errorFingerprint": "DllNotFoundException-libSkiaSharp-ClickOnce-net4",
    "workarounds": [
      "Manually add libSkiaSharp.dll to the project as Content (Build Action=Content, Copy if newer). Find the DLL at packages/SkiaSharp.NativeAssets.Win32.{version}/runtimes/win-{arch}/native/libSkiaSharp.dll. Choose win-x64 for x64 or win-x86 for x86/AnyCPU.",
      "Use MSIX deployment instead of ClickOnce — MSIX correctly handles the runtimes/ native assets."
    ],
    "nextQuestions": [
      "Should the NativeAssets.Win32 .targets file use <Content> instead of <None> for ClickOnce compatibility, or would that have side effects for other project types?",
      "Is there a way to conditionally use <Content> only when ClickOnce publishing is detected?"
    ],
    "resolution": {
      "hypothesis": "ClickOnce deployment only publishes items with Build Action=Content in the application manifest. The NativeAssets.Win32 .targets file uses <None> with CopyToOutputDirectory, which works for MSBuild output but not ClickOnce manifests.",
      "proposals": [
        {
          "title": "Manual Content inclusion workaround",
          "description": "Manually add the architecture-specific libSkiaSharp.dll to the project as a Content item. This forces ClickOnce to include it in the application manifest and deploy it. Steps: (1) Copy libSkiaSharp.dll from the NuGet package cache (packages/SkiaSharp.NativeAssets.Win32.{version}/runtimes/win-{arch}/native/), (2) Add to project via 'Add Existing Item', (3) Set Build Action=Content and Copy to Output Directory=Copy if newer, (4) Verify it appears in Publish > Application Files with Action=Include.",
          "confidence": 0.95,
          "effort": "trivial"
        },
        {
          "title": "Fix .targets to use Content for ClickOnce",
          "description": "Modify the NativeAssets.Win32 buildTransitive/net4/SkiaSharp.targets to use <Content> instead of <None> for native DLL items, so ClickOnce includes them in the application manifest. This may need to be conditional to avoid side effects for non-ClickOnce projects.",
          "confidence": 0.60,
          "effort": "small"
        },
        {
          "title": "Switch to MSIX deployment",
          "description": "Use MSIX packaging instead of ClickOnce. MSIX correctly handles runtimes/ folder native assets from NuGet packages without manual intervention.",
          "confidence": 0.90,
          "effort": "medium"
        }
      ],
      "recommendedProposal": "Manual Content inclusion workaround",
      "recommendedReason": "Already confirmed working by both the community member and the OP. Trivial effort and no risk of side effects to other project types."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.80,
      "reason": "The OP confirmed the workaround resolves the issue. This is a known ClickOnce limitation with NuGet runtimes/ native assets. The workaround is well-documented in the comments. However, a packaging fix in the .targets file could prevent future occurrences."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add tenet/compatibility label (ClickOnce deployment compatibility issue)",
        "risk": "low",
        "confidence": 0.90,
        "labels": ["type/bug", "area/libSkiaSharp.native", "os/Windows-Classic", "tenet/compatibility", "tenet/reliability"]
      },
      {
        "type": "add-comment",
        "description": "Acknowledge the workaround and provide structured guidance",
        "risk": "high",
        "confidence": 0.85,
        "comment": "Thanks for reporting this, and thanks @ERPCG for the detailed workaround.\n\nThis is a known limitation with ClickOnce and NuGet packages that deliver native binaries via the `runtimes/` folder convention. ClickOnce only publishes items with `Build Action = Content` in its application manifest, but the SkiaSharp NativeAssets package adds the DLLs as `<None>` items — which copies them to build output but not to the ClickOnce deployment.\n\nHere's the workaround (confirmed working by both reporters):\n\n1. Locate `libSkiaSharp.dll` in your NuGet cache:\n   `packages\\SkiaSharp.NativeAssets.Win32.{version}\\runtimes\\win-x64\\native\\` (use `win-x86` for x86/AnyCPU)\n2. Add it to your project via **Add → Existing Item**\n3. Set **Build Action = Content** and **Copy to Output Directory = Copy if newer**\n4. Verify it appears in **Publish → Application Files** with **Action = Include**\n\nAlternatively, MSIX deployment handles native assets correctly without this manual step.\n\nRelated: #1327 (same issue reported in 2020)."
      },
      {
        "type": "link-related",
        "description": "Cross-reference #1327 (identical ClickOnce + libSkiaSharp issue)",
        "risk": "low",
        "confidence": 0.90,
        "linkedIssue": 1327
      }
    ]
  }
}
