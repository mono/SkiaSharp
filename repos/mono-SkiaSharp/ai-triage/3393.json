{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3393,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-08T15:00:00Z"
  },
  "summary": "All P/Invoke wrapper methods lack GC.KeepAlive calls, allowing premature collection of managed objects while native code is using their handles",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.95
    }
  },
  "evidence": {
    "reproEvidence": {
      "environmentDetails": "SkiaSharp 3.116.0, VS Code macOS, Android and all platforms affected",
      "codeSnippets": [
        "csharp: var canvas = …\nvar picture = …\ncanvas.DrawPicture(picture);\n// `picture` is not referenced after this point.",
        "csharp: public void DrawPicture (SKPicture picture, SKPaint paint = null)\n{\n\tif (picture == null)\n\t\tthrow new ArgumentNullException (nameof (picture));\n\tSkiaApi.sk_canvas_draw_picture (Handle, picture.Handle, null, paint == null ? IntPtr.Zero : paint.Handle);\n\tGC.KeepAlive (picture);\n\tGC.KeepAlive (paint);\n}"
      ]
    },
    "bugSignals": {
      "severity": "high",
      "errorType": "crash"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0"
      ]
    }
  },
  "analysis": {
    "summary": "Well-documented GC race condition bug. When a managed SkiaSharp object's Handle is passed to a P/Invoke method, the .NET GC can collect the managed object (and run its finalizer, freeing native memory) before the native call completes. The reporter provides authoritative Microsoft documentation, a concrete Uno Platform reproduction, and a clear fix pattern.",
    "rationale": "type: This is a real bug — a GC race condition that can cause use-after-free crashes. The reporter provides Microsoft documentation, a concrete reproduction scenario via Uno Platform, and a clear fix. This is not a feature request or question. area: The bug is in the core SkiaSharp binding layer where P/Invoke wrapper methods extract Handle properties without protecting the managed objects from GC. This spans all of binding/SkiaSharp/. classification.platforms: While Android is mentioned in the form, the reporter explicitly says 'All' platforms are affected. The GC race is a .NET runtime behavior, not platform-specific. Removing os/Android is appropriate since this is cross-platform. tenets: Use-after-free due to GC racing with native code causes crashes, data corruption, or undefined behavior. This is a reliability concern. partner: The Uno Platform team discovered this in practice (uno#21660) and the reporter (jonpryor) references their PR as evidence. Flagging for partner visibility. bugSignals.severity: Non-deterministic use-after-free crash affecting the entire public API surface. The race is hard to reproduce but real, as demonstrated by the Uno Platform team. No easy workaround for consumers. actionability.suggestedAction: Valid bug with a clear fix pattern (GC.KeepAlive), but requires a full audit of the binding surface to determine scope. The fix is well-understood technically but the effort is significant. regression.isRegression: This has always been the case — the GC race exists in every version of SkiaSharp. The P/Invoke wrappers were never systematically protected with GC.KeepAlive calls. versionAnalysis.currentRelevance: This is a latent bug present since the inception of the P/Invoke wrappers and has never been systematically addressed. Only a handful of methods currently have GC.KeepAlive calls.",
    "codeInvestigation": [],
    "workarounds": [
      "Callers can manually add GC.KeepAlive() after SkiaSharp API calls, but this is fragile and shifts the burden to every consumer."
    ],
    "nextQuestions": [
      "How many of the ~hundreds of P/Invoke wrapper methods need GC.KeepAlive added — a full audit is needed",
      "Whether the code generator (utils/generate.ps1) can be extended to automatically emit GC.KeepAlive calls, or if hand-written wrappers must be individually patched",
      "Whether GC.KeepAlive(this) should also be added to instance methods, or if callers are expected to keep `this` alive"
    ],
    "resolution": {
      "hypothesis": "The .NET GC can collect managed SkiaSharp objects after their Handle property is read but before the P/Invoke call completes, because the runtime cannot see into native code. If the finalizer runs during this window, it frees the native handle, causing use-after-free in Skia.",
      "proposals": [
        {
          "description": "Audit all public methods in binding/SkiaSharp/ that call SkiaApi.* and add GC.KeepAlive() for every reference-type parameter (including `this` for instance methods) after the P/Invoke call. This is the approach the reporter suggests and is the most thorough fix.",
          "confidence": 0.9,
          "effort": "large"
        },
        {
          "description": "Modify the binding generator (utils/generate.ps1 or the underlying tool) to automatically emit GC.KeepAlive calls in generated P/Invoke wrappers. This prevents future regressions and reduces manual effort, but requires understanding the generator's architecture.",
          "confidence": 0.8,
          "effort": "large"
        },
        {
          "description": "Add GC.KeepAlive to the most commonly used methods (SKCanvas.Draw*, SKPaint, SKPath operations) as an incremental first step, with a follow-up for the full audit. Lower effort but leaves long-tail risk.",
          "confidence": 0.85,
          "effort": "medium"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.9,
      "reason": "Valid bug with clear fix pattern, but requires a full audit of the binding surface to determine scope. The fix is well-understood technically but the effort is significant."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add partner/unoplatform label and remove os/Android since issue affects all platforms",
        "risk": "low",
        "confidence": 0.85,
        "labels": [
          "partner/unoplatform"
        ]
      },
      {
        "type": "add-comment",
        "description": "Acknowledge the bug report and outline investigation plan",
        "risk": "high",
        "confidence": 0.85
      }
    ]
  }
}
