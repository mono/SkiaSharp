{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3400,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-25T12:00:00Z"
  },
  "summary": "SKDocument.CreateXps() renders embedded SVG <image> elements at ~30-40% of correct size, while CreatePdf() renders them correctly",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.9
    },
    "platforms": [
      "os/Windows-Classic"
    ],
    "backends": [
      "backend/XPS",
      "backend/PDF"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Load an SVG document containing <image> elements with Base64-encoded images using SKSvg.Load()",
        "Generate XPS using SKDocument.CreateXps() with DPI scaling (72/96 = 0.75)",
        "Generate PDF using SKDocument.CreatePdf() with the same SVG and scaling",
        "Compare image dimensions in XPS vs PDF output"
      ],
      "environmentDetails": "Windows 10/11, .NET 9.0, Visual Studio, SkiaSharp 3.116.0 (form) / 3.119.1 (description), Svg.Skia 3.2.1",
      "codeSnippets": [
        "csharp: var skSvg = new SKSvg();\nvar picture = skSvg.Load(ms);\nconst float DPI = 72f;\nconst float SVG_DPI = 96f;\nconst float contentScale = DPI / SVG_DPI;\nvar pageWidth = bounds.Width * contentScale;\nvar pageHeight = bounds.Height * contentScale;\n\nusing (var xpsStream = File.OpenWrite(\"output.xps\"))\n{\n    using var document = SKDocument.CreateXps(xpsStream);\n    using var canvas = document.BeginPage(pageWidth, pageHeight);\n    canvas.Clear(SKColors.White);\n    canvas.Scale(contentScale);\n    canvas.DrawPicture(picture);\n    document.EndPage();\n    document.Close();\n}"
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "isRegression": true
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "3.119.1",
        "2.88.9"
      ]
    }
  },
  "analysis": {
    "summary": "Clear rendering bug in the XPS backend where embedded raster images in SVG are scaled incorrectly (~30-40% of expected size). The same SKPicture renders correctly to PDF and raster, isolating the problem to how the XPS document backend handles image drawing operations from recorded picture playback. The ~30-40% reduction is close to 0.75² = 0.5625, suggesting a DPI scale factor may be applied twice to images.",
    "rationale": "type: Reporter describes incorrect rendering output (images undersized by ~60%) in XPS compared to PDF. This is clearly broken behavior, not a usage question or feature request. The [BUG] prefix matches the content. area: SKDocument.CreateXps() is in the core SkiaSharp package (binding/SkiaSharp/SKDocument.cs). The bug is in document generation, not views or HarfBuzz. backends: XPS is the primary affected backend. PDF is included because the bug is defined by the discrepancy between the two backends rendering the same SKPicture. bugSignals.severity: Incorrect visual output with no XPS-specific workaround. PDF workaround exists but doesn't help XPS-dependent workflows. Not a crash or data loss, but renders XPS output unusable for the reporter's label printing use case. actionability.suggestedAction: Real rendering bug with partial reproduction code. The double-scaling hypothesis needs confirmation and the version discrepancy needs clarification before a fix can proceed. platforms: XPS is a Windows-specific document format and the reporter is using Windows 10/11. The XPS backend in Skia is only relevant on Windows. tenets: Embedded images render at incorrect size in XPS output, producing unreliable visual output. The same SKPicture renders correctly to PDF, confirming broken XPS backend behavior. regression.isRegression: Reporter states last known good version is 2.88.9 and the bug appeared in v3. The major version boundary makes this a plausible regression though the large version gap makes pinpointing difficult. versionAnalysis.currentRelevance: Reporter mentions both 3.116.0 and 3.119.1, both recent v3 releases. The XPS backend scaling issue is unlikely to have been fixed between these versions.",
    "codeInvestigation": [],
    "workarounds": [
      "Use SKDocument.CreatePdf() instead of CreateXps() for correct image rendering, though this does not help users who require XPS output for Windows print pipeline."
    ],
    "nextQuestions": [
      "Which exact version was tested — 3.116.0 or 3.119.1? The description and form field disagree.",
      "Whether the issue exists without the DPI scaling (contentScale = 0.75) — the scaling factor may be the trigger.",
      "Whether this is a Skia upstream XPS backend bug or specific to the SkiaSharp C API layer.",
      "Whether the 2.88.9 'last known good' means it was specifically tested with XPS or is just the previous version used."
    ],
    "resolution": {
      "hypothesis": "The Skia XPS backend applies an additional DPI-based scaling to raster images drawn from SKPicture playback that the PDF backend does not. When the canvas already has a scale transform (0.75 for 72/96 DPI conversion), images get double-scaled while vector primitives (text, shapes) are only scaled once. The ~30-40% size reduction aligns with 0.75² ≈ 0.5625.",
      "proposals": [
        {
          "description": "Examine how SkXPSDevice handles DrawImage vs DrawPath operations in picture playback. Compare with SkPDFDevice to find where the additional scale is applied to images. This is likely in upstream Skia's XPS device code.",
          "confidence": 0.7,
          "effort": "medium"
        },
        {
          "description": "Ask reporter to test with contentScale=1.0 (no DPI conversion) to confirm whether the scaling factor triggers the bug. If images render correctly at 1.0x, this confirms the double-scaling hypothesis.",
          "confidence": 0.65,
          "effort": "small"
        },
        {
          "description": "As a workaround, rasterize the SVG to an SKImage first, then draw the rasterized image to the XPS canvas. This bypasses the SKPicture playback path in the XPS backend.",
          "confidence": 0.5,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "Real rendering bug with partial reproduction code. Root cause likely in Skia's XPS backend DPI handling. Needs confirmation of the double-scaling hypothesis and version clarification."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Labels already match classification — no changes needed",
        "risk": "low",
        "confidence": 0.95
      },
      {
        "type": "add-comment",
        "description": "Acknowledge report and request diagnostic test without DPI scaling",
        "risk": "high",
        "confidence": 0.8
      }
    ]
  }
}
