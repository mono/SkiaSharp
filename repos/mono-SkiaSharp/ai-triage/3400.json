{
  "schemaVersion": "1.0",
  "number": 3400,
  "repo": "mono/SkiaSharp",
  "analyzedAt": "2025-07-25T12:00:00Z",
  "summary": "SKDocument.CreateXps() renders <image> elements from SVG at incorrect (smaller) size, while CreatePdf() renders correctly",
  "type": {
    "value": "bug",
    "confidence": 0.95,
    "reason": "Reporter describes broken rendering behavior: same SKPicture produces correct images in PDF but incorrectly scaled images (~30-40% of expected size) in XPS. Clear expected vs actual behavior described."
  },
  "area": {
    "value": "SkiaSharp",
    "confidence": 0.90,
    "reason": "The issue is in SKDocument.CreateXps() which is in the core SkiaSharp API. However the root cause is likely in Skia upstream XPS device implementation, not in the C# binding layer."
  },
  "backends": [
    {
      "value": "XPS",
      "confidence": 0.95,
      "reason": "Bug occurs specifically in XPS output. The reporter explicitly states XPS renders images incorrectly while PDF renders them correctly."
    },
    {
      "value": "PDF",
      "confidence": 0.85,
      "reason": "PDF is the comparison format that renders correctly. Included because the issue is about XPS vs PDF rendering discrepancy."
    }
  ],
  "platforms": [
    {
      "value": "Windows-Classic",
      "confidence": 0.92,
      "reason": "Reporter specifies Windows 10/11, .NET 9.0, Visual Studio. XPS is a Windows-specific document format."
    }
  ],
  "tenets": [
    {
      "value": "reliability",
      "confidence": 0.90,
      "reason": "Incorrect rendering output constitutes unexpected behavior. Images render at wrong dimensions."
    }
  ],
  "partner": null,
  "regression": {
    "isRegression": true,
    "confidence": 0.70,
    "reason": "Reporter states Last Known Good Version 2.88.9 and current broken version is 3.116.0. However, the version gap is very large (2.88.9 to 3.x is a major version jump with Skia upstream updates), so the regression may be in upstream Skia rather than SkiaSharp itself.",
    "workedInVersion": "2.88.9",
    "brokeInVersion": "3.116.0"
  },
  "fixStatus": null,
  "bugSignals": {
    "hasCrash": false,
    "hasStackTrace": false,
    "reproQuality": "partial",
    "hasScreenshot": false,
    "hasWorkaround": false,
    "workaroundSummary": null,
    "targetFrameworks": ["net9.0"],
    "severity": "medium",
    "severityReason": "Incorrect rendering output (images 30-40% of expected size in XPS) impacts label printing workflows that require XPS for Windows print pipeline. No crash, but produces unusable output. User can use PDF as alternative output format."
  },
  "reproEvidence": {
    "stepsToReproduce": [
      "Load an SVG document containing <image> elements with Base64-encoded images",
      "Parse the SVG using SKSvg.Load() from the Svg.Skia library",
      "Generate XPS using SKDocument.CreateXps() with canvas.Scale(72/96) applied",
      "Generate PDF using SKDocument.CreatePdf() with the same SVG and same scaling",
      "Compare the image dimensions in XPS vs PDF output - XPS images are ~30-40% of correct size"
    ],
    "codeSnippets": [
      {
        "language": "csharp",
        "code": "using SkiaSharp;\nusing Svg.Skia;\nusing System.IO;\nusing System.Text;\n\nvar svgContent = File.ReadAllText(\"sample.svg\");\nusing var ms = new MemoryStream(Encoding.UTF8.GetBytes(svgContent));\nvar skSvg = new SKSvg();\nvar picture = skSvg.Load(ms);\nvar bounds = picture.CullRect;\n\nconst float DPI = 72f;\nconst float SVG_DPI = 96f;\nconst float contentScale = DPI / SVG_DPI;\n\nvar pageWidth = bounds.Width * contentScale;\nvar pageHeight = bounds.Height * contentScale;\n\nusing (var xpsStream = File.OpenWrite(\"output.xps\"))\n{\n    using var document = SKDocument.CreateXps(xpsStream);\n    using var canvas = document.BeginPage(pageWidth, pageHeight);\n    canvas.Clear(SKColors.White);\n    canvas.Scale(contentScale);\n    canvas.DrawPicture(picture);\n    document.EndPage();\n    document.Close();\n}",
        "context": "Full reproduction code showing XPS generation with DPI-based scaling. Same code with CreatePdf works correctly."
      },
      {
        "language": "xml",
        "code": "<svg width=\"70mm\" height=\"50mm\" viewBox=\"0 0 265 189\" xmlns=\"http://www.w3.org/2000/svg\">\n  <image href=\"data:image/jpeg;base64,...\" x=\"10.388\" y=\"22.387\" width=\"39.99997292\" height=\"20.00001292\" preserveAspectRatio=\"xMidYMid meet\"/>\n</svg>",
        "context": "Sample SVG structure showing the <image> element that gets incorrectly scaled in XPS output."
      }
    ],
    "environmentDetails": "SkiaSharp 3.119.1 (also reported on 3.116.0), Svg.Skia 3.2.1, Windows 10/11, .NET 9.0, Visual Studio (Windows)"
  },
  "versionAnalysis": {
    "mentionedVersions": ["3.119.1", "3.116.0", "2.88.9"],
    "era": "modern",
    "currentRelevance": "likely",
    "reason": "Reporter tested on both 3.116.0 and 3.119.1 (latest). The XPS backend is still present in current builds. The issue is likely in Skia upstream XPS device implementation.",
    "migrationPath": null
  },
  "actionability": {
    "suggestedAction": "needs-investigation",
    "confidence": 0.85,
    "reason": "Genuine rendering bug in the XPS backend. Investigation should focus on whether Skia XPS device applies additional DPI scaling to raster images causing double-scaling. Root cause is likely in upstream Skia SkXPSDevice, not in the SkiaSharp C# binding.",
    "requiresHumanReview": false,
    "closeable": false,
    "closeReason": null,
    "duplicateOf": null,
    "abandoned": false,
    "abandonedReason": null
  },
  "suggestedResponse": null,
  "analysisNotes": {
    "summary": "XPS backend renders <image> elements from SVG at approximately 30-40% of their expected size, while PDF and raster output from the same SKPicture are correct. This is a rendering correctness bug likely rooted in how Skia XPS device handles DPI-dependent image scaling differently from the PDF device. The issue is a regression from 2.88.9 to 3.x, coinciding with significant Skia upstream updates.",
    "keySignals": [
      {
        "text": "Images are significantly smaller (approximately 30-40% of correct size)",
        "source": "body",
        "interpretation": "Quantifiable rendering error suggesting a DPI scaling factor is being applied incorrectly.",
        "supportedFields": ["type", "bugSignals.severity"]
      },
      {
        "text": "This issue only affects <image> elements within SVG. Other elements: Text, barcodes, shapes render correctly in both PDF and XPS",
        "source": "body",
        "interpretation": "Only raster images are affected, not vector elements. Points to DPI-based resolution handling specific to raster image embedding in XPS.",
        "supportedFields": ["type", "bugSignals"]
      },
      {
        "text": "The same SKPicture object produces correct output with CreatePdf() and CreateImage()",
        "source": "body",
        "interpretation": "Bug is isolated to XPS backend. The SKPicture and SVG parsing are correct.",
        "supportedFields": ["backends", "area"]
      },
      {
        "text": "Last Known Good Version: 2.88.9, Current: 3.116.0",
        "source": "body",
        "interpretation": "Regression across a major version boundary. SkiaSharp 3.x uses a significantly updated Skia upstream.",
        "supportedFields": ["regression"]
      },
      {
        "text": "This severely impacts label printing applications that require XPS output for Windows print pipeline",
        "source": "body",
        "interpretation": "Business impact - XPS is used for Windows print spooling.",
        "supportedFields": ["bugSignals.severity"]
      },
      {
        "text": "contentScale = DPI / SVG_DPI = 72/96 = 0.75",
        "source": "body",
        "interpretation": "User applies a 0.75 scaling factor. If XPS backend also internally applies DPI conversion for images, this could cause double-scaling.",
        "supportedFields": ["type", "bugSignals"]
      }
    ],
    "fieldRationales": [
      {
        "field": "type",
        "chosen": "bug",
        "expandedReason": "Reporter describes broken rendering: same input produces correct output in PDF but incorrect output in XPS. Clear expected vs actual behavior with quantifiable difference.",
        "alternatives": [
          {
            "value": "question",
            "whyRejected": "Reporter is not asking how to use XPS - they know how and it produces wrong output."
          }
        ]
      },
      {
        "field": "area",
        "chosen": "SkiaSharp",
        "expandedReason": "SKDocument.CreateXps() is in the core SkiaSharp binding. While the root cause is likely in Skia upstream SkXPSDevice, the area classification maps to the C# API surface.",
        "alternatives": [
          {
            "value": "libSkiaSharp.native",
            "whyRejected": "Not a loading/P-Invoke issue. It is a rendering logic issue better tracked under SkiaSharp area."
          }
        ]
      },
      {
        "field": "backends",
        "chosen": "XPS, PDF",
        "expandedReason": "XPS is the broken backend. PDF is included because the issue is specifically about the discrepancy between XPS and PDF rendering."
      },
      {
        "field": "platforms",
        "chosen": "Windows-Classic",
        "expandedReason": "XPS is a Windows-only format. Reporter confirms Windows 10/11 with Visual Studio."
      },
      {
        "field": "bugSignals.severity",
        "chosen": "medium",
        "expandedReason": "No crash or data loss, but produces unusable XPS output for label printing. User can use PDF as workaround for non-print scenarios. Medium because not a crash, partial workaround exists via PDF, but output is wrong.",
        "alternatives": [
          {
            "value": "high",
            "whyRejected": "A workaround exists (PDF output). Not a crash or data loss."
          },
          {
            "value": "low",
            "whyRejected": "Producing images at wrong size makes XPS output unusable for printing - not cosmetic."
          }
        ]
      },
      {
        "field": "actionability.suggestedAction",
        "chosen": "needs-investigation",
        "expandedReason": "Real rendering bug that needs engineering investigation into Skia XPS device image DPI scaling behavior."
      }
    ],
    "docsConsulted": [
      {
        "path": "references/skia-patterns.md",
        "relevance": "Checked for known XPS platform quirks or common traps. No XPS-specific patterns documented.",
        "usedFor": ["bugSignals"]
      },
      {
        "path": "binding/SkiaSharp/SKDocument.cs",
        "relevance": "Confirmed CreateXps defaults to 72 DPI (DefaultRasterDpi), same as CreatePdf. C# wrapper correctly passes DPI through to native call.",
        "usedFor": ["area", "bugSignals"]
      },
      {
        "path": "references/triage-schema.json",
        "relevance": "Schema reference for field definitions and allowed values.",
        "usedFor": ["type", "area", "backends", "platforms", "tenets", "bugSignals", "actionability"]
      }
    ],
    "docsNotConsulted": "Did not consult documentation/packages.md (no deployment/loading issue), .docs (no API misuse suspected), or mslearn (not a MAUI/Blazor/WPF issue).",
    "uncertainties": [
      "The ~30-40% size reduction does not cleanly map to a known DPI ratio - could be 72/96 * some other factor. Reproducing with a known SVG would clarify the exact scaling factor.",
      "Whether this is an upstream Skia XPS device bug vs a SkiaSharp DPI parameter issue - needs native code investigation.",
      "Whether the issue occurs without Svg.Skia (with a manually constructed SKPicture containing DrawImage calls) - would isolate whether Svg.Skia image handling contributes.",
      "Whether explicitly passing 96 DPI to CreateXps() (matching XPS native DPI) would resolve the issue as a workaround."
    ],
    "assumptions": [
      "Assumed the reporter observation of 30-40% size reduction is approximate - exact measurement would help identify the scaling factor.",
      "Assumed the bug is not in Svg.Skia SVG parsing since the reporter states PDF output from the same SKPicture is correct."
    ]
  },
  "resolutionAnalysis": {
    "hypothesis": "Skia XPS device (SkXPSDevice) handles raster image DPI resolution differently from the PDF device. When embedded images from SVG <image> elements are recorded into an SKPicture and then played back through the XPS device, the device applies DPI-based scaling to raster content that effectively double-scales images. Vector elements (text, shapes) are resolution-independent and unaffected.",
    "researchDone": [
      "Examined SKDocument.CreateXps() C# wrapper - correctly passes DPI to native sk_document_create_xps_from_stream",
      "Confirmed DefaultRasterDpi is 72.0f for both XPS and PDF",
      "Searched for existing XPS issues - found #422 (file lock), #463 (null on .NET Core), #1291 (null on Linux), but none about scaling",
      "Analyzed the DPI math: XPS uses 96 DPI, user applies 72/96=0.75 scale, compound scaling possible"
    ],
    "proposals": [
      {
        "title": "Try CreateXps with 96 DPI parameter",
        "description": "Pass 96 DPI to CreateXps() instead of using the default 72 DPI. Since XPS natively uses 96 DPI, this may prevent the XPS device from applying additional DPI-based image scaling.",
        "steps": [
          "Change CreateXps() call to: SKDocument.CreateXps(xpsStream, 96f)",
          "Adjust the contentScale calculation if needed to account for the higher DPI",
          "Compare image dimensions in the output with the PDF result"
        ],
        "pros": [
          "Simple configuration change - no code modification needed",
          "Addresses the likely root cause (DPI mismatch between SkiaSharp default and XPS native DPI)"
        ],
        "cons": [
          "May affect page dimensions and require recalculating the scaling factor",
          "May not be the complete fix if the scaling issue is more complex"
        ],
        "confidence": 0.60,
        "effort": "low"
      },
      {
        "title": "Pre-rasterize images before XPS rendering",
        "description": "Instead of relying on the XPS device to handle raster images from SKPicture playback, flatten the SVG content to a raster image first, then draw that image onto the XPS canvas.",
        "steps": [
          "Create an SKSurface at the target resolution",
          "Draw the SKPicture onto the surface to produce an SKImage",
          "Begin XPS page and draw the pre-rasterized SKImage at exact page dimensions"
        ],
        "pros": [
          "Completely avoids the XPS image scaling bug",
          "Produces pixel-identical output to PDF at a given resolution"
        ],
        "cons": [
          "Loses vector quality for text and shapes in XPS output",
          "Output file size increases significantly",
          "Not suitable for high-resolution printing where vector quality matters"
        ],
        "confidence": 0.85,
        "effort": "low"
      },
      {
        "title": "Investigate and fix Skia XPS device image scaling",
        "description": "Debug the native Skia XPS device (SkXPSDevice) to find where raster images get additional DPI-based scaling during SKPicture playback. Fix the scaling logic to match the PDF device behavior.",
        "steps": [
          "Create a minimal reproduction without Svg.Skia (pure SkiaSharp DrawImage into SKPicture, then replay to XPS)",
          "Build libSkiaSharp with debug symbols on Windows",
          "Trace the image drawing path through SkXPSDevice::drawImage and related methods",
          "Compare with SkPDFDevice::drawImage to identify where the scaling diverges",
          "Apply fix in the Skia fork and rebuild"
        ],
        "pros": [
          "Fixes the root cause for all users",
          "Preserves vector quality in XPS output"
        ],
        "cons": [
          "High effort - requires native Skia debugging on Windows",
          "Risk of unintended side effects in XPS device",
          "Fix would be in the Skia fork, requiring ongoing maintenance"
        ],
        "confidence": 0.70,
        "effort": "high"
      }
    ],
    "recommendedProposal": "Try CreateXps with 96 DPI parameter",
    "recommendedReason": "Lowest effort and can be tested immediately by the reporter. If it resolves the issue, it confirms the DPI mismatch hypothesis and informs whether the fix should be in SkiaSharp (change default DPI for XPS) or upstream Skia."
  }
}
