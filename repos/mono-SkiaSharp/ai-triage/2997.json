{
  "meta": {
    "schemaVersion": "1.0",
    "number": 2997,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-11T20:18:46Z"
  },
  "summary": "SKMatrix.MapRect normalizes output rect due to upstream Skia's sort_as_rect. Workaround: use MapPoint on corners.",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.6
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.95
    }
  },
  "evidence": {
    "reproEvidence": {
      "codeSnippets": [
        "csharp: var inputRect = new SKRect();\ninputRect.Left =25;\ninputRect.Right = 15;\ninputRect.Bottom = 2;\ninputRect.Top = 10;\nvar resultRect = SKMatrix.CreateIdentity().MapRect(inputRect);\nAssert.AreEqual(inputRect.Right,resultRect.Right);"
      ]
    },
    "bugSignals": {
      "severity": "low"
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "2.88.3",
        "2.88.2"
      ]
    }
  },
  "analysis": {
    "summary": "SKMatrix.MapRect calls Skia's SkMatrix::mapRect, which uses sort_as_rect to normalize the output rectangle so left<=right and top<=bottom. This is upstream Skia behavior, not a SkiaSharp bug. The C# binding simply passes through to the C API, which calls SkMatrix::mapRect. A community comment confirms this with a link to the Skia source.",
    "rationale": "type: While this is upstream Skia's intended behavior, the reporter's expectation is reasonable — an identity matrix should preserve the rect unchanged. Keeping as type/bug since it's a valid behavioral concern, but confidence is lower because it's Skia's design choice, not a SkiaSharp defect. area: SKMatrix is in the core SkiaSharp package. The behavior originates from upstream Skia but surfaces through the SkiaSharp API. bugSignals.severity: No crash, no data loss. Behavioral surprise with a clear workaround (MapPoint on corners). Affects niche use case of non-standard coordinate systems. actionability.suggestedAction: This is upstream Skia's intended behavior. SkiaSharp faithfully wraps it. A workaround using MapPoint exists. The community has already provided the explanation. regression.isRegression: sort_as_rect has been in Skia for many years. The claimed regression from 2.88.2 to 2.88.3 is likely a coincidence — the reporter may have changed their usage pattern. fixStatus.likelyFixed: This is Skia's design, not a bug. No fix expected or appropriate. versionAnalysis.currentRelevance: The behavior persists in all SkiaSharp versions since sort_as_rect has not been changed in Skia.",
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp/SKMatrix.cs",
        "lines": "299-306",
        "finding": "MapRect is a thin wrapper: calls SkiaApi.sk_matrix_map_rect, no C# normalization — the standardization happens entirely in Skia C++",
        "relevance": "related"
      },
      {
        "file": "externals/skia/src/c/sk_matrix.cpp",
        "lines": "47-49",
        "finding": "C API sk_matrix_map_rect passes directly through to AsMatrix(matrix).mapRect — no additional logic in the C shim",
        "relevance": "related"
      },
      {
        "file": "externals/skia/src/core/SkMatrix.cpp",
        "lines": "1120-1127",
        "finding": "sort_as_rect function: uses min/max on ltrb components to ensure left<=right and top<=bottom. This is the root cause of the normalization.",
        "relevance": "related"
      },
      {
        "file": "externals/skia/src/core/SkMatrix.cpp",
        "lines": "1142-1169",
        "finding": "SkMatrix::mapRect calls sort_as_rect in the translate-only path (line 1149) and mapRectScaleTranslate (which also calls sort_as_rect at line 1139) for scale+translate. All paths normalize the output rect.",
        "relevance": "related"
      },
      {
        "file": "binding/SkiaSharp/SKMatrix.cs",
        "lines": "310-320",
        "finding": "MapPoint transforms individual points via sk_matrix_map_xy without normalization — this is the workaround path for preserving corner ordering",
        "relevance": "related"
      },
      {
        "file": "binding/SkiaSharp/MathTypes.cs",
        "lines": "382-398",
        "finding": "SKRect.Standardized property already exists in SkiaSharp for explicit normalization, confirming the reporter's expectation that normalization should be opt-in",
        "relevance": "related"
      }
    ],
    "workarounds": [
      "Use MapPoint to transform the rect corners individually instead of MapRect, preserving the original left/right/top/bottom ordering."
    ],
    "nextQuestions": [
      "Whether there's demand for a SkiaSharp-level MapRect overload that preserves corner ordering",
      "Whether the reporter's claim of regression from 2.88.2 reflects a real behavior change or coincidence"
    ],
    "resolution": {
      "hypothesis": "Skia's SkMatrix::mapRect intentionally normalizes the output rect via sort_as_rect. This is by-design upstream behavior. SkiaSharp should document this and provide a workaround.",
      "proposals": [
        {
          "description": "Transform the four corners of the rect individually using MapPoint, then construct a new SKRect from the transformed corners. This preserves the original left/right/top/bottom ordering since MapPoint doesn't normalize.",
          "confidence": 0.95,
          "effort": "small"
        },
        {
          "description": "Add a new C# method SKMatrix.MapRectUnsorted that maps the rect corners via MapPoint instead of calling Skia's mapRect. This would be a SkiaSharp-level convenience that avoids the upstream normalization.",
          "confidence": 0.7,
          "effort": "small"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.8,
      "reason": "This is upstream Skia's intended behavior (sort_as_rect in mapRect). A community member has already explained this. A workaround using MapPoint exists."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Keep type/bug, add area/SkiaSharp",
        "risk": "low",
        "confidence": 0.85,
        "labels": [
          "area/SkiaSharp"
        ]
      },
      {
        "type": "add-comment",
        "description": "Acknowledge the report, explain the upstream cause, and provide a MapPoint workaround",
        "risk": "high",
        "confidence": 0.85
      },
      {
        "type": "close-issue",
        "description": "Close as upstream Skia behavior with workaround provided",
        "risk": "medium",
        "confidence": 0.78
      }
    ]
  }
}
