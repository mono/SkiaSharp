{
  "meta": {
    "schemaVersion": "3.0",
    "number": 3437,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-08T19:00:00Z"
  },
  "summary": "SKSvgCanvas produces <text> elements with missing text values and x/y attributes when used concurrently in parallel tasks on Windows — regression from 2.88.9",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.98
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.9
    },
    "platforms": [
      "os/Windows-Classic"
    ],
    "backends": [
      "backend/SVG"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create multiple parallel tasks using Task.Run()",
        "In each task, create an independent SKSvgCanvas writing to a MemoryStream",
        "Draw multiple text elements using canvas.DrawText()",
        "Dispose canvas to flush SVG output",
        "Inspect resulting SVG — <text> elements will have empty x/y attributes and missing text content"
      ],
      "environmentDetails": "Windows 11, Visual Studio Code, SkiaSharp 3.116.0 / 3.119.1 / 3.119.2-preview.1. Linux (Ubuntu 22.04.2 LTS via WSL) is unaffected.",
      "codeSnippets": [
        "csharp: await Task.WhenAll(\n    Enumerable.Range(0, 5)\n    .Select(i => Task.Run(() => drawSvgFunc(i)))\n    ).ConfigureAwait(false);"
      ]
    },
    "bugSignals": {
      "severity": "high",
      "isRegression": true
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "3.119.1",
        "3.119.2-preview.1",
        "2.88.9"
      ]
    }
  },
  "analysis": {
    "summary": "Thread-safety bug in the SVG canvas backend on Windows. Independent SKSvgCanvas instances used in parallel tasks produce corrupted <text> elements with missing content and attributes. This is a regression from 2.88.9, suggesting the Skia 3.x SVG module introduced shared mutable global state.",
    "rationale": "type: Clear broken behavior: SVG output data corruption where text elements lose their content and attributes. The reporter provides expected vs actual output showing the defect. area: SKSvgCanvas is part of the core SkiaSharp API surface (binding/SkiaSharp/). While it targets SVG output, the code path goes through the main SkiaSharp library. backends: The bug is specific to SKSvgCanvas — the SVG rendering backend. Standard raster canvas drawing is not affected. platforms: Reporter confirmed the bug only occurs on Windows 11. Ubuntu 22.04 via WSL is unaffected even with significantly more parallelism. bugSignals.severity: Silent data corruption in output — text elements lose their content without any error or warning. The only workaround is to serialize work or downgrade to 2.x. This is a regression affecting all 3.x versions. actionability.suggestedAction: Well-documented regression with a complete repro project. Needs native-level debugging to identify the shared global state in Skia's SVG module causing the Windows-specific race condition. tenets: tenet/reliability: Silent data corruption in SVG output with missing text values. tenet/compatibility: This is a regression from 2.88.9 to all 3.x versions, indicating a cross-version compatibility break. regression.isRegression: Reporter explicitly confirms 2.88.9 does not have the bug and all 3.x versions do. This aligns with the major Skia engine upgrade between 2.x and 3.x that likely changed SVG serialization internals. versionAnalysis.currentRelevance: Bug affects all SkiaSharp 3.x versions tested (3.116.0, 3.119.1, 3.119.2-preview.1) including the latest preview, confirming it remains unresolved.",
    "codeInvestigation": [],
    "workarounds": [
      "Avoid parallel usage of SKSvgCanvas — serialize SVG generation to a single thread, or downgrade to SkiaSharp 2.88.9."
    ],
    "nextQuestions": [
      "Whether the root cause is in Skia's C++ SVG module or in the C API/P/Invoke layer — needs native debugging",
      "Whether the issue affects other SVG element types beyond <text> or if it's specific to text rendering",
      "Whether Windows-specific locale or string formatting functions used in SVG serialization are the source of the race condition",
      "The exact shared mutable state causing the race — could be global buffers, static formatters, or locale-dependent number-to-string conversion"
    ],
    "resolution": {
      "hypothesis": "The Skia 3.x SVG serialization module likely uses shared global state (possibly a string formatting buffer or locale-dependent number conversion function) that is not thread-safe on Windows. Linux uses different formatting functions (e.g., POSIX locale-independent formatting) that happen to be thread-safe, explaining the platform difference.",
      "proposals": [
        {
          "description": "Document that Skia is not thread-safe and SKSvgCanvas instances should not be used concurrently, even if they are independent instances. This is the quickest mitigation but doesn't fix the underlying defect.",
          "confidence": 0.9,
          "effort": "small"
        },
        {
          "description": "Debug the native Skia SVG serialization to identify the shared mutable state causing the race condition on Windows. This likely involves SkSVGDevice or related classes. May require an upstream Skia fix or a SkiaSharp-specific patch in the fork.",
          "confidence": 0.65,
          "effort": "large"
        },
        {
          "description": "Add a global lock in the managed SKSvgCanvas wrapper to serialize access to the SVG backend. This would fix the corruption but eliminate parallelism benefits for SVG generation.",
          "confidence": 0.8,
          "effort": "medium"
        }
      ]
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.9,
      "reason": "Well-documented regression with complete repro project. Needs native-level debugging to identify the shared global state in Skia's SVG module causing the Windows-specific race condition."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add tenet/compatibility label to reflect this is a 2.x to 3.x regression",
        "risk": "low",
        "confidence": 0.85,
        "labels": [
          "tenet/compatibility"
        ]
      },
      {
        "type": "add-comment",
        "description": "Acknowledge the high-quality report and confirm investigation is needed",
        "risk": "high",
        "confidence": 0.85
      }
    ]
  }
}
