{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3433,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T00:19:39Z",
    "currentLabels": ["community ✨"]
  },
  "summary": "Community PR updating Microsoft.Windows.CsWinRT from 2.0.4 to 2.2.0 in SkiaSharp.Views.WinUI.Native.Projection to resolve trimming/AOT warnings (IL2026, IL2104) reported in #3327. Also adds CsWinRTWindowsMetadata property to work around a CsWinRT 2.2.0 code-generation bug (microsoft/CsWinRT#2214) where generated code references a non-existent IBufferMethods.IID when using .NET SDK 8.0.100's bundled Windows metadata. Build has not been verified by CI; the contributor confirmed it builds locally for externals-winui but has backward-compatibility concerns about pinning metadata version.",
  "classification": {
    "type": { "value": "type/bug", "confidence": 0.88 },
    "area": { "value": "area/SkiaSharp.Views", "confidence": 0.90 },
    "platforms": ["os/Windows-WinUI"],
    "tenets": ["tenet/compatibility"]
  },
  "evidence": {
    "bugSignals": {
      "severity": "medium",
      "errorType": "build-warning",
      "errorMessage": "Assembly 'SkiaSharp.Views.WinUI.Native.Projection' produced trim warnings (IL2104); IL2026: WinRT.WinrtModule.GetActivationFactory uses RequiresUnreferencedCode member",
      "reproQuality": "complete",
      "targetFrameworks": ["net8.0-windows10.0.19041.0"]
    },
    "reproEvidence": {
      "stepsToReproduce": [
        "Use SkiaSharp.Views.WinUI 3.119.0 in a WinUI3 app with PublishAot=true",
        "Build in Release mode",
        "Observe IL2104/IL2026 trimming warnings from SkiaSharp.Views.WinUI.Native.Projection.dll"
      ],
      "environmentDetails": "Windows, Visual Studio, SkiaSharp 3.119.0, .NET 8, WinUI3",
      "relatedIssues": [3327]
    },
    "versionAnalysis": {
      "mentionedVersions": ["3.119.0"],
      "currentRelevance": "likely",
      "relevanceReason": "The Projection csproj on main still uses CsWinRT 2.0.4, which has the trim-unsafe WinRT interop code. The bug persists."
    },
    "fixStatus": {
      "likelyFixed": false,
      "confidence": 0.95,
      "reason": "This PR is the proposed fix but has not been merged. CsWinRT 2.0.4 is still on main. CI has not run on this PR.",
      "relatedPRs": [3433]
    }
  },
  "analysis": {
    "summary": "PR #3433 addresses trimming warnings in SkiaSharp.Views.WinUI.Native.Projection by upgrading CsWinRT from 2.0.4 to 2.2.0 (which adds trimming/AOT safety). CsWinRT 2.2.0 has a code-generation change that references IBufferMethods.IID — a property that only exists in newer Windows SDK projections. The fix adds CsWinRTWindowsMetadata=10.0.17763.57 to force the correct metadata version. This is a valid workaround confirmed by CsWinRT maintainers in microsoft/CsWinRT#2214. However, there's an open concern: whether pinning CsWinRTWindowsMetadata affects end-users consuming the built NuGet package, and whether WindowsSdkPackageVersion would be a more appropriate approach.",
    "rationale": "Classified as type/bug because #3327 reports trimming warnings that may cause runtime crashes under NativeAOT — this is broken behavior, not a feature request. Area is SkiaSharp.Views because the affected file is the WinUI native projection used by SkiaSharp.Views.WinUI. Platform is WinUI-specific. Tenet is compatibility since trimming/AOT support is a compatibility concern.",
    "keySignals": [
      {
        "text": "CsWinRT version 2.0.4 → 2.2.0 in SkiaSharp.Views.WinUI.Native.Projection.csproj",
        "source": "PR diff",
        "interpretation": "Core change — CsWinRT 2.2.0 is the latest stable and adds trimming/AOT safety for WinRT interop."
      },
      {
        "text": "error CS0117: 'IBufferMethods' does not contain a definition for 'IID'",
        "source": "comment #2 (mattleibow)",
        "interpretation": "Build error from internal CI. CsWinRT 2.2.0 codegen references IBufferMethods.IID which doesn't exist in SDK 8.0.100's bundled Windows metadata."
      },
      {
        "text": "CsWinRTWindowsMetadata=10.0.17763.57 added to fix build",
        "source": "PR diff + comment #4 (wangfys)",
        "interpretation": "Forces a specific Windows metadata version so CsWinRT 2.2.0's codegen finds the IID property. Confirmed by CsWinRT maintainers as the correct approach."
      },
      {
        "text": "concerned about what if users of SkiaSharp use an old version",
        "source": "comment #4 (wangfys)",
        "interpretation": "Open question about backward compatibility. The CsWinRTWindowsMetadata property affects build-time codegen, not runtime — but needs maintainer review."
      },
      {
        "text": "In your case though, this means you're using an outdated version of the Windows SDK projections",
        "source": "CsWinRT issue #2214 comment (dongle-the-gadget)",
        "interpretation": "CsWinRT maintainer confirms the root cause is outdated SDK projections, and suggests WindowsSdkPackageVersion as the proper fix."
      }
    ],
    "codeInvestigation": [
      {
        "file": "native/winui/SkiaSharp.Views.WinUI.Native/SkiaSharp.Views.WinUI.Native.Projection/SkiaSharp.Views.WinUI.Native.Projection.csproj",
        "lines": "19",
        "finding": "Currently uses Microsoft.Windows.CsWinRT 2.0.4. CsWinRTIncludes is set to SkiaSharp.Views.WinUI.Native. No CsWinRTWindowsMetadata or WindowsSdkPackageVersion is set. TargetFramework is $(WindowsTargetFrameworksPrevious) — net8.0-windows10.0.19041.0.",
        "relevance": "direct"
      },
      {
        "file": "native/winui/SkiaSharp.Views.WinUI.Native/SkiaSharp.Views.WinUI.Native/BufferExtensions.h",
        "lines": "1-23",
        "finding": "The native WinUI component exposes BufferExtensions with GetByteBuffer(IBuffer), which is the IBuffer interface that triggers the CsWinRT codegen issue with IBufferMethods.IID.",
        "relevance": "direct"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/UWPExtensions.cs",
        "lines": "179-180",
        "finding": "C# code calls BufferExtensions.GetByteBuffer(buffer) — this is the consumer of the generated projection code that triggers the trim-unsafe paths.",
        "relevance": "related"
      },
      {
        "file": "global.json",
        "finding": "SDK pinned to 8.0.100 with rollForward: latestMinor. This SDK bundles older Windows metadata that lacks IBufferMethods.IID, which is why CsWinRTWindowsMetadata is needed.",
        "relevance": "context"
      },
      {
        "file": "source/SkiaSharp.Build.targets",
        "lines": "164-165",
        "finding": "Build targets reference CsWinRTReplaceForPatchedRuntime for assembly signing when CsWinRTIncludes is set — confirms CsWinRT is integrated into the broader build pipeline.",
        "relevance": "context"
      }
    ],
    "nextQuestions": [
      "Should WindowsSdkPackageVersion be used instead of CsWinRTWindowsMetadata for broader SDK compatibility?",
      "Does CsWinRTWindowsMetadata=10.0.17763.57 affect the runtime behavior of the built NuGet package for end-users on different Windows SDK versions?",
      "Should the PR also update global.json or SDK pinning to a newer .NET SDK that bundles compatible Windows metadata?",
      "Has the PR been rebased on main? The PR checklist shows 'Rebased on top of main' is unchecked.",
      "CI has not run — needs internal build trigger to verify the fix works end-to-end."
    ],
    "resolution": {
      "hypothesis": "CsWinRT 2.0.4 generates trim-unsafe WinRT interop code. Upgrading to 2.2.0 fixes the trimming warnings but requires pinning CsWinRTWindowsMetadata to provide compatible Windows SDK metadata for code generation.",
      "proposals": [
        {
          "title": "Merge PR with CsWinRTWindowsMetadata",
          "description": "Accept the PR as-is after CI passes. The CsWinRTWindowsMetadata property is a build-time-only setting that doesn't affect runtime. CsWinRT maintainers confirmed this approach in microsoft/CsWinRT#2214.",
          "confidence": 0.75,
          "effort": "trivial"
        },
        {
          "title": "Use WindowsSdkPackageVersion instead",
          "description": "Replace CsWinRTWindowsMetadata with WindowsSdkPackageVersion, which is the more standard MSBuild approach for pinning Windows SDK projection packages. This may be more forward-compatible.",
          "codeSnippet": "<WindowsSdkPackageVersion>10.0.17763.57</WindowsSdkPackageVersion>",
          "confidence": 0.70,
          "effort": "trivial"
        },
        {
          "title": "Bump .NET SDK to include newer metadata",
          "description": "Update global.json to a .NET SDK version that bundles Windows metadata compatible with CsWinRT 2.2.0, eliminating the need for CsWinRTWindowsMetadata entirely. More invasive but cleaner long-term.",
          "confidence": 0.60,
          "effort": "medium"
        }
      ],
      "recommendedProposal": "Merge PR with CsWinRTWindowsMetadata",
      "recommendedReason": "The PR's approach is confirmed correct by CsWinRT maintainers. CsWinRTWindowsMetadata is build-time only and doesn't impact end-users. Low risk, directly fixes #3327."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "PR looks correct based on CsWinRT maintainer guidance, but CI has not run. Needs build verification and maintainer review of backward-compatibility concern before merge."
    },
    "missingInfo": [
      "CI build results — build has not been triggered",
      "Confirmation that CsWinRTWindowsMetadata doesn't affect end-user NuGet package behavior",
      "Whether WindowsSdkPackageVersion is preferred over CsWinRTWindowsMetadata"
    ],
    "actions": [
      {
        "type": "update-labels",
        "description": "Apply bug, views, WinUI, and compatibility labels",
        "risk": "low",
        "confidence": 0.90,
        "labels": ["type/bug", "area/SkiaSharp.Views", "os/Windows-WinUI", "tenet/compatibility"]
      },
      {
        "type": "link-related",
        "description": "Cross-reference the bug this PR fixes",
        "risk": "low",
        "confidence": 0.95,
        "linkedIssue": 3327
      },
      {
        "type": "add-comment",
        "description": "Acknowledge PR, provide technical review feedback on the approach and next steps",
        "risk": "high",
        "confidence": 0.80,
        "comment": "Thanks for the fix and for tracking down the CsWinRT codegen issue — the analysis of microsoft/CsWinRT#2214 is helpful.\n\nThe approach looks sound: CsWinRT 2.2.0 adds trimming/AOT safety, and `CsWinRTWindowsMetadata` pins the Windows metadata version for build-time codegen. A few items to resolve before merge:\n\n1. **CI verification** — We'll need to run the internal build to confirm this passes end-to-end.\n2. **`WindowsSdkPackageVersion` vs `CsWinRTWindowsMetadata`** — The CsWinRT maintainer suggested `WindowsSdkPackageVersion` as the standard approach. Worth confirming whether `CsWinRTWindowsMetadata` is equivalent or if `WindowsSdkPackageVersion` is preferred.\n3. **Rebase** — Would you be able to rebase on top of the current `main` branch?\n\nRegarding your backward-compatibility concern: `CsWinRTWindowsMetadata` is a build-time property that controls code generation — it shouldn't affect consumers of the resulting NuGet package at runtime."
      }
    ]
  }
}
