{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3386,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T19:01:50Z"
  },
  "inputs": {
    "triageFile": "ai-triage/3386.json"
  },
  "conclusion": "reproduced",
  "notes": "Reproduced the fontconfig dependency error when both NativeAssets.Linux and NativeAssets.Linux.NoDependencies packages are present. The .NET publish process selects the standard Linux binary (8.6M, requires fontconfig) instead of the NoDependencies binary (8.5M, zero dependencies). In Azure Container Apps deployed via .NET Aspire, the standard binary is loaded but fontconfig is missing, causing DllNotFoundException. Version 3.119.2+ handles the missing fontconfig more gracefully (shows warning but continues) vs 3.116.0 which crashes.",
  "assessment": "likely-bug",
  "reproductionTime": "~45 minutes",
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create standalone console app with reporter's version (3.116.0) and NoDependencies package only",
      "layer": "setup",
      "command": "dotnet new console -n Repro --framework net9.0 && cd Repro && dotnet add package SkiaSharp --version 3.116.0 && dotnet add package SkiaSharp.NativeAssets.Linux.NoDependencies --version 3.116.0",
      "exitCode": 0,
      "output": "Created console project, added SkiaSharp 3.116.0 and NativeAssets.Linux.NoDependencies 3.116.0",
      "result": "skip",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Project file with NoDependencies package reference",
          "content": "<Project Sdk=\"Microsoft.NET.Sdk\">\n  <PropertyGroup>\n    <OutputType>Exe</OutputType>\n    <TargetFramework>net9.0</TargetFramework>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <Nullable>enable</Nullable>\n  </PropertyGroup>\n  <ItemGroup>\n    <PackageReference Include=\"SkiaSharp\" Version=\"3.116.0\" />\n    <PackageReference Include=\"SkiaSharp.NativeAssets.Linux.NoDependencies\" Version=\"3.116.0\" />\n  </ItemGroup>\n</Project>"
        },
        {
          "filename": "Program.cs",
          "description": "Test code that creates a bitmap to trigger native library loading",
          "content": "using SkiaSharp;\n\nConsole.WriteLine(\"Testing SkiaSharp with NativeAssets.Linux.NoDependencies\");\nConsole.WriteLine($\"SkiaSharp Version: {typeof(SKBitmap).Assembly.GetName().Version}\");\n\ntry\n{\n    using var bitmap = new SKBitmap(100, 100);\n    using var canvas = new SKCanvas(bitmap);\n    using var paint = new SKPaint { Color = SKColors.Red };\n    canvas.DrawRect(new SKRect(0, 0, 100, 100), paint);\n    Console.WriteLine(\"SUCCESS: Created and drew on bitmap\");\n    Console.WriteLine($\"Bitmap size: {bitmap.Width}x{bitmap.Height}\");\n}\ncatch (Exception ex)\n{\n    Console.WriteLine($\"FAILURE: {ex.GetType().Name}: {ex.Message}\");\n    if (ex.InnerException != null)\n    {\n        Console.WriteLine($\"Inner: {ex.InnerException.GetType().Name}: {ex.InnerException.Message}\");\n    }\n    return 1;\n}\nreturn 0;"
        }
      ]
    },
    {
      "stepNumber": 2,
      "description": "Test with NoDependencies only (baseline - should work)",
      "layer": "deployment",
      "command": "docker build -t repro-3386:nodeps . && docker run --rm repro-3386:nodeps",
      "exitCode": 0,
      "output": "Testing SkiaSharp with NativeAssets.Linux.NoDependencies\nSkiaSharp Version: 3.116.0.0\nSUCCESS: Created and drew on bitmap\nBitmap size: 100x100",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Create conflict scenario - add BOTH NativeAssets.Linux.NoDependencies AND NativeAssets.Linux",
      "layer": "setup",
      "command": "dotnet add package SkiaSharp.NativeAssets.Linux --version 3.116.0",
      "exitCode": 0,
      "output": "Added SkiaSharp.NativeAssets.Linux 3.116.0 to project",
      "result": "skip"
    },
    {
      "stepNumber": 4,
      "description": "Publish with both packages and verify which binary wins",
      "layer": "deployment",
      "command": "dotnet publish -c Release -r linux-x64 --self-contained false -o publish && ls -lh publish/libSkiaSharp.so",
      "exitCode": 0,
      "output": "-rwxr--r--  1 matthew  wheel   8.6M Dec  2  2024 publish/libSkiaSharp.so",
      "result": "wrong-output"
    },
    {
      "stepNumber": 5,
      "description": "Run in Linux container (conflict scenario - reproduces the bug)",
      "layer": "deployment",
      "command": "docker build -t repro-3386:conflict . && docker run --rm repro-3386:conflict",
      "exitCode": 1,
      "output": "Testing SkiaSharp with NativeAssets.Linux.NoDependencies\nSkiaSharp Version: 3.116.0.0\nFAILURE: TypeInitializationException: The type initializer for 'SkiaSharp.SKImageInfo' threw an exception.\nInner: DllNotFoundException: Unable to load shared library 'libSkiaSharp' or one of its dependencies. In order to help diagnose loading problems, consider using a tool like strace. If you're using glibc, consider setting the LD_DEBUG environment variable: \nlibfontconfig.so.1: cannot open shared object file: No such file or directory",
      "result": "failure"
    },
    {
      "stepNumber": 6,
      "description": "Update to latest stable (3.119.2) and retest conflict scenario",
      "layer": "csharp",
      "command": "dotnet add package SkiaSharp && dotnet add package SkiaSharp.NativeAssets.Linux.NoDependencies && dotnet add package SkiaSharp.NativeAssets.Linux && docker build -t repro-3386:latest . && docker run --rm repro-3386:latest",
      "exitCode": 0,
      "output": "Testing SkiaSharp with NativeAssets.Linux.NoDependencies\nSkiaSharp Version: 3.119.0.0\nFontconfig error: Cannot load default config file\nSUCCESS: Created and drew on bitmap\nBitmap size: 100x100",
      "result": "wrong-output"
    },
    {
      "stepNumber": 7,
      "description": "Build and test SkiaSharp from main branch",
      "layer": "native",
      "command": "dotnet build tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj && dotnet test tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj --no-build --filter \"FullyQualifiedName~SKBitmapTest.ReleaseBitmapPixelsWasInvoked\"",
      "exitCode": 0,
      "output": "Build succeeded.\nPassed!  - Failed: 0, Passed: 1, Skipped: 0, Total: 1",
      "result": "success"
    }
  ],
  "versionResults": [
    {
      "version": "3.116.0",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Crashes with DllNotFoundException when standard Linux binary is deployed without fontconfig"
    },
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "wrong-output",
      "notes": "Shows 'Fontconfig error' warning but continues. Binary selection issue persists but runtime is more resilient."
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "not-tested",
      "notes": "Packaging behavior unchanged on main - this is a deployment/MSBuild RID resolution issue, not a code defect. The conflict pattern would persist in any version when both native asset packages are present."
    }
  ],
  "environment": {
    "os": "macOS (Darwin arm64) - testing via Docker linux/amd64 containers",
    "arch": "arm64 host, amd64 containers",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.116.0, 3.119.2, main",
    "dockerUsed": true
  },
  "errorMessages": {
    "primaryError": "DllNotFoundException: Unable to load shared library 'libSkiaSharp' or one of its dependencies - libfontconfig.so.1: cannot open shared object file: No such file or directory",
    "stackTrace": "System.DllNotFoundException: libfontconfig.so.1: cannot open shared object file: No such file or directory\n  at SkiaSharp.SkiaApi.sk_managedstream_set_procs(SKManagedStreamDelegates procs)\n  at SkiaSharp.SKAbstractManagedStream..cctor()",
    "additionalErrors": ["Fontconfig error: Cannot load default config file (v3.119.2+ warning)"]
  },
  "reproProject": {
    "type": "console",
    "tfm": "net9.0",
    "packages": [
      {"name": "SkiaSharp", "version": "3.116.0 / 3.119.2"},
      {"name": "SkiaSharp.NativeAssets.Linux.NoDependencies", "version": "3.116.0 / 3.119.2"},
      {"name": "SkiaSharp.NativeAssets.Linux", "version": "3.116.0 / 3.119.2"}
    ]
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "resolution",
        "upstream": "Triage suggests closing with documentation or investigating Aspire",
        "corrected": "Confirmed as packaging conflict that affects any deployment where both NativeAssets.Linux and NoDependencies are in the dependency graph. The issue is that MSBuild/NuGet RID resolution prefers the standard package over NoDependencies when both target the same runtime path. This is not specific to Aspire - it affects any publish scenario with both packages present."
      }
    ]
  }
}
