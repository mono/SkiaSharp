{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3440,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T19:24:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/3440.json"
  },
  "conclusion": "needs-platform",
  "notes": "Cannot fully reproduce on macOS. The reported issue is a Windows-specific WinRT activation failure in SkiaSharp.Views.WinUI.Native.PropertySetExtensions. The crash occurs in the ANGLE/OpenGL rendering path when GlesContext.CreateSurface() tries to invoke PropertySetExtensions.AddSingle(). Triage analysis points to a deployment/WinRT registration issue similar to #2948 (resolved externally). SkiaSharp core library loads successfully on macOS, confirming the issue is WinUI-specific. Reproduction requires Windows with WinUI runtime to test the native C++/WinRT component activation.",
  "assessment": "likely-bug",
  "reproductionTime": "~15 minutes",
  "versionResults": [
    {
      "version": "3.119.1",
      "source": "nuget",
      "result": "not-tested",
      "notes": "SkiaSharp core library loaded successfully on macOS, but WinUI-specific components cannot be tested on this platform"
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.119.1"
      }
    ]
  },
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create standalone console project to test SkiaSharp 3.119.1 core library loading on macOS",
      "layer": "setup",
      "command": "mkdir -p /tmp/repro-3440 && cd /tmp/repro-3440 && dotnet new console -n Repro --framework net8.0",
      "exitCode": 0,
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Add SkiaSharp 3.119.1 package reference",
      "layer": "setup",
      "command": "cd /tmp/repro-3440/Repro && dotnet add package SkiaSharp --version 3.119.1",
      "exitCode": 0,
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Write test code to verify SkiaSharp core library loading and basic rendering",
      "layer": "setup",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Reproduction code that tests SkiaSharp core library loading (non-WinUI)",
          "content": "using System;\nusing System.Runtime.InteropServices;\nusing SkiaSharp;\n\nConsole.WriteLine(\"=== SkiaSharp 3.119.1 Native Load Test ===\");\nConsole.WriteLine($\"OS: {RuntimeInformation.OSDescription}\");\nConsole.WriteLine($\"Architecture: {RuntimeInformation.ProcessArchitecture}\");\nConsole.WriteLine($\".NET: {RuntimeInformation.FrameworkDescription}\");\nConsole.WriteLine();\n\ntry\n{\n    // Test basic SkiaSharp loading (non-WinUI)\n    using var bitmap = new SKBitmap(100, 100);\n    using var canvas = new SKCanvas(bitmap);\n    canvas.Clear(SKColors.White);\n    canvas.DrawRect(10, 10, 80, 80, new SKPaint { Color = SKColors.Blue });\n    \n    using var image = SKImage.FromBitmap(bitmap);\n    using var data = image.Encode(SKEncodedImageFormat.Png, 100);\n    \n    Console.WriteLine(\"✅ SkiaSharp core library loaded successfully\");\n    Console.WriteLine($\"   Created 100x100 bitmap and rendered blue rectangle\");\n    Console.WriteLine($\"   Encoded to PNG: {data.Size} bytes\");\n    Console.WriteLine();\n    \n    // Save to verify rendering\n    using var stream = File.OpenWrite(\"/tmp/repro-3440-test.png\");\n    data.SaveTo(stream);\n    Console.WriteLine($\"✅ Saved test image to /tmp/repro-3440-test.png\");\n    Console.WriteLine();\n    \n    Console.WriteLine(\"Note: This test verifies SkiaSharp core functionality on macOS.\");\n    Console.WriteLine(\"The reported issue is specific to WinUI native components on Windows,\");\n    Console.WriteLine(\"which cannot be tested on this platform.\");\n}\ncatch (Exception ex)\n{\n    Console.WriteLine($\"❌ Error: {ex.GetType().Name}: {ex.Message}\");\n    Console.WriteLine(ex.StackTrace);\n    return 1;\n}\n\nreturn 0;"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Run test to verify SkiaSharp core library loads successfully",
      "layer": "csharp",
      "command": "cd /tmp/repro-3440/Repro && dotnet run",
      "exitCode": 0,
      "output": "=== SkiaSharp 3.119.1 Native Load Test ===\nOS: Darwin 25.2.0 Darwin Kernel Version 25.2.0\nArchitecture: Arm64\n.NET: .NET 8.0.23\n\n✅ SkiaSharp core library loaded successfully\n   Created 100x100 bitmap and rendered blue rectangle\n   Encoded to PNG: 352 bytes\n\n✅ Saved test image to /tmp/repro-3440-test.png\n\nNote: This test verifies SkiaSharp core functionality on macOS.\nThe reported issue is specific to WinUI native components on Windows,\nwhich cannot be tested on this platform.",
      "result": "success"
    },
    {
      "stepNumber": 5,
      "description": "Inspect WinUI PropertySetExtensions code to understand the issue",
      "layer": "csharp",
      "output": "Examined source files:\n- source/SkiaSharp.Views/SkiaSharp.Views.WinUI/GlesInterop/GlesContext.cs: Lines 98-104 call PropertySetExtensions.AddSize() and AddSingle() during EGL surface creation\n- native/winui/.../PropertySetExtensions.idl: WinRT component definition\n- native/winui/.../PropertySetExtensions.cpp: C++/WinRT implementation (straightforward wrapper)\n\nThe crash location matches reporter's stack trace exactly. PropertySetExtensions is a native C++/WinRT component used only in the ANGLE/OpenGL rendering path (SKSwapChainPanel), not in CPU rendering (SKXamlCanvas).\n\nThe COMException 'Element not found' during BaseActivationFactory indicates WinRT runtime cannot locate the component registration. Similar to issue #2948 (resolved externally by Microsoft Store environment fix).",
      "result": "skip"
    }
  ],
  "errorMessages": {
    "primaryError": "System.Runtime.InteropServices.COMException: Element not found",
    "stackTrace": "System.Runtime.InteropServices.COMException: Element not found.\n  at void Marshal.ThrowExceptionForHR(int errorCode)() in Marshal.cs:line 856\n  at new BaseActivationFactory(string typeNamespace, string typeFullName)()\n  at static PropertySetExtensions()()\n\nSystem.TypeInitializationException: The type initializer for 'SkiaSharp.Views.WinUI.Native.PropertySetExtensions' threw an exception.\n  at IObjectReference PropertySetExtensions.get__objRef_global__SkiaSharp_Views_WinUI_Native_IPropertySetExtensionsStatics()()\n  at void PropertySetExtensions.AddSingle(PropertySet propertySet, string key, float value)()\n  at void GlesContext.CreateSurface(SwapChainPanel panel, Size? renderSurfaceSize, float? resolutionScale)()\n  at void AngleSwapChainPanel.EnsureRenderSurface()()\n  at void AngleSwapChainPanel.OnLoaded(object sender, RoutedEventArgs e)()\n  at int RoutedEventHandler.Do_Abi_Invoke(IntPtr thisPtr, IntPtr sender, IntPtr e)()"
  },
  "environment": {
    "os": "macOS 15.3 (Darwin 25.2.0)",
    "arch": "arm64",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.119.1",
    "dockerUsed": false
  },
  "blockers": [
    "Requires Windows OS with WinUI runtime to test native C++/WinRT component activation",
    "The PropertySetExtensions WinRT component is Windows-specific and cannot be loaded on macOS",
    "ANGLE/OpenGL rendering path (SKSwapChainPanel → GlesContext) only functions on Windows",
    "Cannot verify WinRT deployment/registration behavior on non-Windows platforms"
  ]
}
