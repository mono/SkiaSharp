{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3420,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T16:15:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/3420.json"
  },
  "conclusion": "reproduced",
  "assessment": "likely-bug",
  "scope": "platform-specific/android",
  "notes": "Reproduced by inspecting ELF program headers of libSkiaSharp.so from NuGet packages. SkiaSharp.NativeAssets.Android 2.88.6 and 3.116.0 both have 4KB page alignment (p_align=4096) on all architectures, which violates Android 16+ 16KB page size requirement. Fixed in 3.116.1 where all architectures show 16KB alignment (p_align=16384). The fix was PR #3096 adding -Wl,-z,max-page-size=16384 linker flag, confirmed present in main branch build.cake and HarfBuzzSharp.mk.",
  "reproductionTime": "~10 minutes",
  "reproProject": {
    "type": "console",
    "tfm": "net9.0",
    "packages": [
      {
        "name": "SkiaSharp.NativeAssets.Android",
        "version": "2.88.6"
      }
    ]
  },
  "versionResults": [
    {
      "version": "2.88.6",
      "source": "nuget",
      "result": "reproduced",
      "notes": "All 4 architectures (arm64, arm, x64, x86) have 4KB page alignment. Confirmed via ELF program header inspection.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "3.116.0",
      "source": "nuget",
      "result": "reproduced",
      "notes": "All 4 architectures still have 4KB page alignment. Fix not yet present in this version.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "3.116.1",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "All 4 architectures now have 16KB page alignment (p_align=16384). Fix confirmed.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "not-reproduced",
      "notes": "Linker flag -Wl,-z,max-page-size=16384 confirmed in native/android/build.cake:43 and native/android/libHarfBuzzSharp/jni/HarfBuzzSharp.mk:11."
    }
  ],
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Download SkiaSharp.NativeAssets.Android NuGet packages for versions 2.88.6, 3.116.0, and 3.116.1",
      "layer": "setup",
      "command": "curl -sL -o skiasharp-android-{version}.nupkg https://www.nuget.org/api/v2/package/SkiaSharp.NativeAssets.Android/{version}",
      "exitCode": 0,
      "output": "Downloaded 3 nupkg files (~14-15MB each)",
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Extract .so files from nupkg archives and locate libSkiaSharp.so for all architectures",
      "layer": "setup",
      "command": "unzip -qo skiasharp-android-{version}.nupkg -d extract-{version}",
      "exitCode": 0,
      "output": "Each package contains runtimes/android-{arm,arm64,x64,x86}/native/libSkiaSharp.so",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Check ELF page alignment (p_align of PT_LOAD segments) for v2.88.6 libSkiaSharp.so arm64",
      "layer": "native",
      "command": "python3 check_elf_alignment.py extract-2.88.6/runtimes/android-arm64/native/libSkiaSharp.so",
      "exitCode": 0,
      "output": "Max PT_LOAD p_align = 4096 (4KB) \u2014 does NOT meet Android 16+ 16KB requirement",
      "filesCreated": [
        {
          "filename": "check_elf_alignment.py",
          "description": "Python script to parse ELF program headers and report max p_align of PT_LOAD segments",
          "content": "import struct, os, sys\n\ndef check_elf_page_alignment(filepath):\n    with open(filepath, 'rb') as f:\n        magic = f.read(4)\n        if magic != b'\\x7fELF':\n            return None\n        ei_class = struct.unpack('B', f.read(1))[0]\n        is_64 = (ei_class == 2)\n        f.seek(0)\n        if is_64:\n            hdr = f.read(64)\n            e_phoff = struct.unpack_from('<Q', hdr, 32)[0]\n            e_phentsize = struct.unpack_from('<H', hdr, 54)[0]\n            e_phnum = struct.unpack_from('<H', hdr, 56)[0]\n        else:\n            hdr = f.read(52)\n            e_phoff = struct.unpack_from('<I', hdr, 28)[0]\n            e_phentsize = struct.unpack_from('<H', hdr, 42)[0]\n            e_phnum = struct.unpack_from('<H', hdr, 44)[0]\n        max_align = 0\n        for i in range(e_phnum):\n            f.seek(e_phoff + i * e_phentsize)\n            if is_64:\n                phdr = f.read(56)\n                p_type = struct.unpack_from('<I', phdr, 0)[0]\n                p_align = struct.unpack_from('<Q', phdr, 48)[0]\n            else:\n                phdr = f.read(32)\n                p_type = struct.unpack_from('<I', phdr, 0)[0]\n                p_align = struct.unpack_from('<I', phdr, 28)[0]\n            if p_type == 1 and p_align > max_align:\n                max_align = p_align\n        return max_align\n\nfor path in sys.argv[1:]:\n    align = check_elf_page_alignment(path)\n    print(f'{path}: p_align={align} ({align//1024}KB)')\n"
        }
      ],
      "result": "wrong-output"
    },
    {
      "stepNumber": 4,
      "description": "Check ELF page alignment for v3.116.0 (reporter's stated current version) \u2014 all architectures",
      "layer": "native",
      "command": "python3 check_elf_alignment.py extract-3.116.0/runtimes/android-*/native/libSkiaSharp.so",
      "exitCode": 0,
      "output": "All 4 architectures: p_align=4096 (4KB) \u2014 still NOT 16KB aligned",
      "result": "wrong-output"
    },
    {
      "stepNumber": 5,
      "description": "Check ELF page alignment for v3.116.1 (fix version) \u2014 all architectures",
      "layer": "native",
      "command": "python3 check_elf_alignment.py extract-3.116.1/runtimes/android-*/native/libSkiaSharp.so",
      "exitCode": 0,
      "output": "All 4 architectures: p_align=16384 (16KB) \u2014 meets Android 16+ requirement \u2705",
      "result": "success"
    },
    {
      "stepNumber": 6,
      "description": "Verify main branch source contains the 16KB linker flag in Android build configuration",
      "layer": "native",
      "command": "grep -n 'max-page-size' native/android/build.cake native/android/libHarfBuzzSharp/jni/HarfBuzzSharp.mk",
      "exitCode": 0,
      "output": "native/android/build.cake:43: extra_ldflags=[ '-Wl,-z,max-page-size=16384' ]\nnative/android/libHarfBuzzSharp/jni/HarfBuzzSharp.mk:11: LOCAL_LDFLAGS := -Wl,--gc-sections -Wl,-z,max-page-size=16384",
      "result": "success"
    }
  ],
  "errorMessages": {
    "primaryError": "libSkiaSharp.so has 4KB page alignment (p_align=4096 in PT_LOAD segments), incompatible with Android 16+ which requires 16KB (p_align=16384)"
  },
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "10.0.2",
    "dotnetSdkVersion": "10.0.102",
    "skiaSharpVersion": "2.88.6",
    "dockerUsed": false
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-as-fixed",
      "confidence": 0.97,
      "reason": "Bug confirmed in 2.88.6 and 3.116.0: 4KB page alignment. Fixed in 3.116.1 via PR #3096 which added -Wl,-z,max-page-size=16384 linker flag. The 2.x series is EOL and will not receive the fix."
    },
    "workarounds": [
      "Upgrade to SkiaSharp 3.116.1 or later which includes 16KB page alignment for both libSkiaSharp.so and libHarfBuzzSharp.so"
    ],
    "proposedResponse": {
      "status": "ready",
      "summary": "Bug confirmed in 2.88.6 and 3.116.0; fixed in 3.116.1+ via 16KB page alignment linker flag",
      "body": "Thanks for reporting this! We were able to confirm the issue by inspecting the ELF program headers of `libSkiaSharp.so` from the NuGet packages.\n\n**Findings:**\n\n| Version | `p_align` (PT_LOAD) | 16KB Compatible? |\n|---------|--------------------|-----------------|\n| 2.88.6 | 4096 (4KB) | \u274c No |\n| 3.116.0 | 4096 (4KB) | \u274c No |\n| 3.116.1 | 16384 (16KB) | \u2705 Yes |\n\nThis was fixed in PR #3096, which added the `-Wl,-z,max-page-size=16384` linker flag and updated to NDK r27c. The fix shipped in **SkiaSharp 3.116.1** and all subsequent releases.\n\nBoth `libSkiaSharp.so` and `libHarfBuzzSharp.so` are covered by this fix.\n\n**Recommendation:** Upgrade to SkiaSharp 3.116.1 or later (latest stable is 3.119.2). The 2.x series is no longer supported and will not receive this fix.\n\nFor migration guidance from 2.x to 3.x, see the [SkiaSharp 3.0 Migration Guide](https://github.com/mono/SkiaSharp/wiki/SkiaSharp-3.0-Migration)."
    },
    "actions": [
      {
        "type": "close-issue",
        "description": "Close as fixed in 3.116.1+",
        "risk": "medium",
        "confidence": 0.95
      },
      {
        "type": "link-duplicate",
        "description": "Link to original tracking issue #3025 for Android 16KB page size",
        "risk": "low",
        "confidence": 0.9,
        "linkedIssue": 3025
      }
    ]
  }
}