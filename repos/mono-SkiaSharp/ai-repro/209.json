{
  "meta": {
    "schemaVersion": "2.0",
    "number": 209,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-22T20:00:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/209.json"
  },
  "conclusion": "not-reproduced",
  "notes": "Attempted to reproduce AccessViolationException during concurrent SKBitmap.Decode operations as described in issue #209. Tested with 100 threads × 200 iterations (20,000 total decodes) using both byte array and stream-based decode paths. All operations completed successfully with zero errors on SkiaSharp 3.119.2 and main branch source. The original issue was reported in 2016 with SkiaSharp ~1.x and appears to have been fixed in subsequent releases. Multiple commenters also noted the issue was resolved by updating versions or fixing disposal patterns.",
  "assessment": "likely-bug",
  "reproductionTime": "~12 minutes",
  "versionResults": [
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "All 20,000 concurrent decode operations (100 threads × 200 iterations) completed successfully with zero errors. Tested with byte array, stream, and file path decode paths."
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "not-reproduced",
      "notes": "Wrote targeted xUnit test ConcurrentDecodeDoesNotCrash with 50 threads × 100 iterations. Test passed on main branch source build."
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.119.2"
      }
    ]
  },
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create standalone console project for concurrent decode reproduction",
      "layer": "setup",
      "command": "dotnet new console -n Repro --framework net8.0 && cd Repro && dotnet add package SkiaSharp --version 3.119.2",
      "exitCode": 0,
      "output": "The template \"Console App\" was created successfully.\nPackageReference for package 'SkiaSharp' version '3.119.2' added.",
      "result": "success",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Concurrent SKBitmap.Decode stress test — 100 threads × 200 iterations of decode + resize + encode, using file path decode (matching mattleibow's repro code from issue comments).",
          "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Threading.Tasks;\nusing SkiaSharp;\n\nclass Program\n{\n    static void Main(string[] args)\n    {\n        const int numThreads = 100;\n        const int numIterationsPerThread = 200;\n\n        var referenceFile = Path.Combine(AppContext.BaseDirectory, \"baboon.jpg\");\n        if (!File.Exists(referenceFile))\n            referenceFile = \"baboon.jpg\";\n        if (!File.Exists(referenceFile))\n        {\n            Console.WriteLine(\"ERROR: baboon.jpg not found\");\n            return;\n        }\n\n        Console.WriteLine($\"SkiaSharp version: {typeof(SKBitmap).Assembly.GetName().Version}\");\n        Console.WriteLine($\"Threads: {numThreads}, Iterations: {numIterationsPerThread}\");\n\n        int successCount = 0;\n        int errorCount = 0;\n        var errors = new List<string>();\n        var tasks = new List<Task>();\n\n        for (int i = 0; i < numThreads; i++)\n        {\n            int threadId = i;\n            tasks.Add(Task.Run(() =>\n            {\n                for (int j = 0; j < numIterationsPerThread; j++)\n                {\n                    try\n                    {\n                        var imageData = ComputeThumbnail(referenceFile);\n                        if (imageData != null && imageData.Length > 0)\n                            System.Threading.Interlocked.Increment(ref successCount);\n                        else\n                        {\n                            System.Threading.Interlocked.Increment(ref errorCount);\n                            lock (errors) { if (errors.Count < 10) errors.Add($\"Thread {threadId}, iter {j}: null/empty\"); }\n                        }\n                    }\n                    catch (Exception ex)\n                    {\n                        System.Threading.Interlocked.Increment(ref errorCount);\n                        lock (errors) { if (errors.Count < 10) errors.Add($\"Thread {threadId}, iter {j}: {ex.GetType().Name}: {ex.Message}\"); }\n                    }\n                }\n            }));\n        }\n\n        Task.WaitAll(tasks.ToArray());\n        Console.WriteLine($\"Success: {successCount}, Errors: {errorCount}\");\n        foreach (var err in errors) Console.WriteLine($\"  {err}\");\n    }\n\n    static byte[] ComputeThumbnail(string fileName)\n    {\n        using var ms = new MemoryStream();\n        using var bitmap = SKBitmap.Decode(fileName);\n        if (bitmap == null) return null;\n        var info = new SKImageInfo(60, 40, bitmap.ColorType, bitmap.AlphaType);\n        using var scaled = bitmap.Resize(info, SKSamplingOptions.Default);\n        if (scaled == null) return null;\n        using var image = SKImage.FromBitmap(scaled);\n        using var data = image.Encode(SKEncodedImageFormat.Png, 80);\n        data.SaveTo(ms);\n        return ms.ToArray();\n    }\n}"
        },
        {
          "filename": "Repro.csproj",
          "description": "Console project targeting net8.0 with SkiaSharp 3.119.2 and baboon.jpg content file.",
          "content": "<Project Sdk=\"Microsoft.NET.Sdk\">\n  <PropertyGroup>\n    <OutputType>Exe</OutputType>\n    <TargetFramework>net8.0</TargetFramework>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <Nullable>enable</Nullable>\n  </PropertyGroup>\n  <ItemGroup>\n    <PackageReference Include=\"SkiaSharp\" Version=\"3.119.2\" />\n  </ItemGroup>\n  <ItemGroup>\n    <None Include=\"baboon.jpg\" CopyToOutputDirectory=\"PreserveNewest\" />\n  </ItemGroup>\n</Project>"
        }
      ]
    },
    {
      "stepNumber": 2,
      "description": "Build the reproduction project",
      "layer": "setup",
      "command": "dotnet build",
      "exitCode": 0,
      "output": "Build succeeded.\n    4 Warning(s)\n    0 Error(s)",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Run concurrent decode stress test with byte array decode (50 threads × 100 iterations = 5000 decodes)",
      "layer": "csharp",
      "command": "dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nReference file: baboon.jpg\nThreads: 50, Iterations per thread: 100\nStarting concurrent decode test...\n\nResults:\n  Success: 5000\n  Errors:  0\n\nAll concurrent decode operations completed successfully.",
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Run concurrent decode stress test with stream-based decode (50 threads × 100 iterations)",
      "layer": "csharp",
      "command": "dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nReference file: baboon.jpg\nThreads: 50, Iterations per thread: 100\nStarting concurrent decode test...\n\nResults:\n  Success: 5000\n  Errors:  0\n\nAll concurrent decode operations completed successfully.",
      "result": "success"
    },
    {
      "stepNumber": 5,
      "description": "Run higher-concurrency stress test with file path decode (100 threads × 200 iterations = 20,000 decodes, matching original repro scale)",
      "layer": "csharp",
      "command": "dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nReference file: baboon.jpg\nThreads: 100, Iterations per thread: 200\nStarting concurrent decode test...\n\nResults:\n  Success: 20000\n  Errors:  0\n\nAll concurrent decode operations completed successfully.",
      "result": "success"
    },
    {
      "stepNumber": 6,
      "description": "Build SkiaSharp test project from main branch source",
      "layer": "csharp",
      "command": "dotnet build tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj",
      "exitCode": 0,
      "output": "Build succeeded.\n    13 Warning(s)\n    0 Error(s)",
      "result": "success"
    },
    {
      "stepNumber": 7,
      "description": "Run concurrent decode xUnit test on main branch source (50 threads × 100 iterations = 5000 decodes)",
      "layer": "csharp",
      "command": "dotnet test tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj --no-build --filter \"FullyQualifiedName~ConcurrentDecodeDoesNotCrash\"",
      "exitCode": 0,
      "output": "Passed!  - Failed: 0, Passed: 1, Skipped: 0, Total: 1",
      "result": "success"
    }
  ],
  "artifacts": [
    {
      "filename": "baboon.jpg",
      "description": "Test image used for concurrent decode stress test, from SkiaSharp test content.",
      "source": "test-data",
      "available": true
    }
  ],
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.119.2",
    "dockerUsed": false
  }
}
