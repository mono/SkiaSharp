{
  "meta": {
    "schemaVersion": "1.0",
    "number": 648,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T00:15:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/648.json"
  },
  "conclusion": "not-reproduced",
  "notes": "Large image resize (14034x9921, 139M pixels, ~531MB RGBA) works correctly on macOS arm64 with both SkiaSharp 2.88.9 and 3.116.1 and main (source). All outputs contain expected pixel data with no blank images. SKBitmap allocation, SKSurface.Create, SKCodec.GetPixels, and the full encode-decode-resize flow all succeed at reporter's dimensions. Allocation failure ('Unable to allocate pixels') only occurs at much larger sizes (~30000x20000, ~2.3GB RGBA). The original issue from 2018 was likely caused by 32-bit process memory constraints or older Skia limits that have since been lifted. The maintainer noted this was an upstream Skia issue (labeled status/skia-update-required).",
  "assessment": "likely-bug",
  "reproductionTime": "~12 minutes",
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      { "name": "SkiaSharp", "version": "3.116.1" }
    ]
  },
  "versionResults": [
    {
      "version": "2.88.9",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "14034x9921 allocation, surface creation, encode/decode/resize all succeed with correct non-blank output."
    },
    {
      "version": "3.116.1",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "All operations succeed up to 24000x18000. Reporter's 14034x9921 works perfectly. Allocation failure only at 28000x20000+."
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "not-reproduced",
      "notes": "Test LargeImageResizeProducesNonBlankOutput passed: 14034x9921 encode-decode-resize produces non-blank output."
    }
  ],
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project with SkiaSharp 3.116.1",
      "layer": "setup",
      "command": "dotnet new console -n Repro --framework net8.0 && dotnet add package SkiaSharp --version 3.116.1",
      "exitCode": 0,
      "output": "The template \"Console App\" was created successfully.\nPackageReference for package 'SkiaSharp' version '3.116.1' added.",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Console project targeting net8.0 with SkiaSharp 3.116.1",
          "content": "<Project Sdk=\"Microsoft.NET.Sdk\">\n  <PropertyGroup>\n    <OutputType>Exe</OutputType>\n    <TargetFramework>net8.0</TargetFramework>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <Nullable>enable</Nullable>\n  </PropertyGroup>\n  <ItemGroup>\n    <PackageReference Include=\"SkiaSharp\" Version=\"3.116.1\" />\n  </ItemGroup>\n</Project>"
        },
        {
          "filename": "Program.cs",
          "description": "Reproduction code that tests large image allocation, surface creation, encode/decode/resize flow, and pixel verification at reporter's dimensions and larger sizes",
          "content": "using SkiaSharp;\n\nConsole.WriteLine(\"Testing blank-output-after-resize (Issue #648)\");\nConsole.WriteLine($\"Platform: {Environment.OSVersion}, 64-bit={Environment.Is64BitProcess}\");\n\nvoid TestEncodedResize(int w, int h, string label)\n{\n    Console.WriteLine($\"\\n=== {label}: {w}x{h} ===\");\n    Console.Write(\"  Creating source surface... \");\n    using var srcSurface = SKSurface.Create(new SKImageInfo(w, h));\n    if (srcSurface == null)\n    {\n        Console.WriteLine(\"FAIL (null surface - too large to allocate)\");\n        return;\n    }\n    srcSurface.Canvas.Clear(SKColors.Blue);\n    using var paint = new SKPaint { Color = SKColors.Red };\n    srcSurface.Canvas.DrawCircle(w / 2f, h / 2f, Math.Min(w, h) / 3f, paint);\n    srcSurface.Canvas.Flush();\n    using var srcSnap = srcSurface.Snapshot();\n    using var encodedData = srcSnap.Encode(SKEncodedImageFormat.Jpeg, 80);\n    Console.WriteLine($\"OK, encoded={encodedData.Size / 1024} KB\");\n\n    Console.Write(\"  Decoding... \");\n    using var decoded = SKImage.FromEncodedData(encodedData);\n    if (decoded == null) { Console.WriteLine(\"FAIL\"); return; }\n    Console.WriteLine($\"OK ({decoded.Width}x{decoded.Height})\");\n\n    Console.Write(\"  SKCodec... \");\n    using var codecData = SKData.CreateCopy(encodedData.ToArray());\n    using var codec = SKCodec.Create(codecData);\n    if (codec == null) { Console.WriteLine(\"FAIL\"); }\n    else\n    {\n        Console.WriteLine($\"OK (info={codec.Info.Width}x{codec.Info.Height})\");\n        using var bmpFromCodec = new SKBitmap(codec.Info);\n        var codecResult = codec.GetPixels(bmpFromCodec.Info, bmpFromCodec.GetPixels());\n        Console.WriteLine($\"  Codec.GetPixels: {codecResult}\");\n    }\n\n    int maxWidth = 1024, maxHeight = 768;\n    double scale = Math.Min((double)maxWidth / decoded.Width, (double)maxHeight / decoded.Height);\n    int newW = (int)(decoded.Width * scale);\n    int newH = (int)(decoded.Height * scale);\n    Console.Write($\"  Resizing to {newW}x{newH}... \");\n    using var dstSurface = SKSurface.Create(new SKImageInfo(newW, newH));\n    if (dstSurface == null) { Console.WriteLine(\"FAIL\"); return; }\n    dstSurface.Canvas.Clear(SKColors.White);\n    dstSurface.Canvas.DrawImage(decoded, new SKRect(0, 0, newW, newH));\n    dstSurface.Canvas.Flush();\n    using var result = dstSurface.Snapshot();\n    using var resultData = result.Encode(SKEncodedImageFormat.Jpeg, 85);\n    if (resultData == null || resultData.Size == 0) { Console.WriteLine(\"FAIL\"); return; }\n    using var checkBmp = SKBitmap.Decode(resultData);\n    int nonWhite = 0;\n    var rng = new Random(42);\n    for (int i = 0; i < 100; i++)\n    {\n        var px = checkBmp.GetPixel(rng.Next(checkBmp.Width), rng.Next(checkBmp.Height));\n        if (px.Red < 240 || px.Green < 240 || px.Blue < 240) nonWhite++;\n    }\n    bool isBlank = nonWhite < 5;\n    Console.WriteLine($\"{resultData.Size} bytes, nonWhite={nonWhite}/100, BLANK={isBlank}\");\n}\n\nTestEncodedResize(14034, 9921, \"Reporter (14034x9921)\");\nTestEncodedResize(16000, 12000, \"16Kx12K\");\nTestEncodedResize(20000, 15000, \"20Kx15K\");\nTestEncodedResize(24000, 18000, \"24Kx18K\");\nTestEncodedResize(28000, 20000, \"28Kx20K\");\nConsole.WriteLine(\"\\nDone.\");"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Run reproduction at reporter's dimensions (14034x9921) with SkiaSharp 3.116.1 — test full encode-decode-resize flow",
      "layer": "csharp",
      "command": "dotnet run",
      "exitCode": 0,
      "output": "Reporter (14034x9921): SKBitmap OK, SKSurface OK, SKCodec OK, Codec.GetPixels: Success, Resize: 13516 bytes, nonWhite=100/100, BLANK=False\n16Kx12K: OK, BLANK=False\n20Kx15K: OK, BLANK=False\n24Kx18K: OK, BLANK=False\n28Kx20K: FAIL (null surface - too large to allocate)",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Re-test with SkiaSharp 2.88.9 (last 2.x release) at reporter's dimensions",
      "layer": "csharp",
      "command": "dotnet remove package SkiaSharp && dotnet add package SkiaSharp --version 2.88.9 && dotnet run",
      "exitCode": 0,
      "output": "All operations succeed identically: 14034x9921 surface created, encoded/decoded/resized, center pixel=#fffe0000, blank=False. Same results through 24000x18000.",
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Test allocation failure boundary — SKBitmap and SKSurface at 30000x20000",
      "layer": "csharp",
      "command": "dotnet run (with 30000x20000 test)",
      "exitCode": 0,
      "output": "30000x20000: SKBitmap: Exception: Unable to allocate pixels for the bitmap.\nSKSurface.Create: returned null\nSKImage.Create: returned null",
      "result": "success"
    },
    {
      "stepNumber": 5,
      "description": "Build and run targeted test on main (source) — LargeImageResizeProducesNonBlankOutput",
      "layer": "csharp",
      "command": "dotnet build tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj && dotnet test --no-build --filter LargeImageResize",
      "exitCode": 0,
      "output": "Passed! - Failed: 0, Passed: 1, Skipped: 0, Total: 1",
      "result": "success"
    }
  ],
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.116.1",
    "dockerUsed": false
  }
}
