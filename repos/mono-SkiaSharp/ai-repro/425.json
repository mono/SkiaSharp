{
  "meta": {
    "schemaVersion": "2.0",
    "number": 425,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-02-12T02:30:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/425.json"
  },
  "conclusion": "reproduced",
  "notes": "Reproduced: SKCodec.EncodedOrigin returns TopLeft for DNG and CR2 raw camera files that have non-TopLeft EXIF orientation tags (RightTop=6 for DNG, LeftBottom=8 for CR2). Verified using Python EXIF parsing that the orientation tags exist in the files. Bug exists on latest NuGet release (3.119.2) and on main branch. Root cause is in upstream Skia's SkRawCodec which never reads EXIF orientation — the base SkCodec constructor defaults to kTopLeft_SkEncodedOrigin.",
  "assessment": "likely-bug",
  "reproductionTime": "~12 minutes",
  "versionResults": [
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "All three test files (2 DNG, 1 CR2) return TopLeft instead of correct orientation."
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "reproduced",
      "notes": "Both DNG (expected RightTop) and CR2 (expected LeftBottom) return TopLeft on main branch build."
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.119.2"
      }
    ]
  },
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create standalone console project with SkiaSharp 3.119.2",
      "layer": "setup",
      "command": "dotnet new console -n Repro --framework net8.0 && cd Repro && dotnet add package SkiaSharp --version 3.119.2",
      "exitCode": 0,
      "output": "Restore succeeded. PackageReference for package 'SkiaSharp' version '3.119.2' added.",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Console project targeting net8.0 with SkiaSharp 3.119.2"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Download test DNG and CR2 files from issue #425 attachments and verify their EXIF orientation tags using Python TIFF parser",
      "layer": "setup",
      "command": "curl -sLo APC_0316.zip 'https://github.com/mono/SkiaSharp/files/1616452/APC_0316.zip' && unzip -o APC_0316.zip && curl -sLo APC_0193.zip 'https://github.com/mono/SkiaSharp/files/1616453/APC_0193.zip' && unzip -o APC_0193.zip && curl -sLo IMG_1361.zip 'https://github.com/mono/SkiaSharp/files/1645431/IMG_1361.zip' && unzip -o IMG_1361.zip",
      "exitCode": 0,
      "output": "APC_0316.dng: EXIF orientation=6 (RightTop)\nAPC_0193.dng: EXIF orientation=6 (RightTop)\nIMG_1361.CR2: EXIF orientation=8 (LeftBottom)",
      "filesCreated": [
        {
          "filename": "APC_0316.dng",
          "description": "DNG raw camera file with EXIF orientation=6 (RightTop), 12.8MB"
        },
        {
          "filename": "APC_0193.dng",
          "description": "DNG raw camera file with EXIF orientation=6 (RightTop), 14.5MB"
        },
        {
          "filename": "IMG_1361.CR2",
          "description": "Canon CR2 raw camera file with EXIF orientation=8 (LeftBottom), 7.2MB"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Write reproduction code that reads EncodedOrigin from DNG and CR2 files using SKCodec",
      "layer": "csharp",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Reproduction code that opens DNG/CR2 files with SKCodec and checks EncodedOrigin",
          "content": "using SkiaSharp;\n\nstring[] testFiles = {\n    \"../APC_0316.dng\",  // Expected: RightTop (6)\n    \"../APC_0193.dng\",  // Expected: RightTop (6)\n    \"../IMG_1361.CR2\",  // Expected: LeftBottom (8)\n};\n\nConsole.WriteLine($\"SkiaSharp Version: {typeof(SKBitmap).Assembly.GetName().Version}\");\nConsole.WriteLine($\"Runtime: {System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription}\");\nConsole.WriteLine($\"OS: {System.Runtime.InteropServices.RuntimeInformation.OSDescription}\");\nConsole.WriteLine($\"Arch: {System.Runtime.InteropServices.RuntimeInformation.ProcessArchitecture}\");\nConsole.WriteLine();\n\nbool anyFailed = false;\n\nforeach (var file in testFiles)\n{\n    string fullPath = Path.GetFullPath(file);\n    if (!File.Exists(fullPath))\n    {\n        Console.WriteLine($\"SKIP: {Path.GetFileName(file)} - file not found\");\n        continue;\n    }\n\n    Console.Write($\"{Path.GetFileName(file)}: \");\n\n    using var stream = new SKFileStream(fullPath);\n    using var codec = SKCodec.Create(stream);\n\n    if (codec == null)\n    {\n        Console.WriteLine(\"FAIL - codec is null (format not supported)\");\n        anyFailed = true;\n        continue;\n    }\n\n    var origin = codec.EncodedOrigin;\n    var format = codec.EncodedFormat;\n    Console.WriteLine($\"Format={format}, EncodedOrigin={origin}, Size={codec.Info.Width}x{codec.Info.Height}\");\n\n    if (origin == SKEncodedOrigin.TopLeft)\n    {\n        Console.WriteLine($\"  *** BUG: Origin is TopLeft - likely ignoring EXIF orientation tag\");\n        anyFailed = true;\n    }\n    else\n    {\n        Console.WriteLine($\"  OK: Non-default orientation detected\");\n    }\n}\n\nConsole.WriteLine();\nConsole.WriteLine(anyFailed ? \"RESULT: Bug reproduced - orientation not read correctly\" : \"RESULT: All orientations read correctly\");"
        }
      ]
    },
    {
      "stepNumber": 4,
      "description": "Run reproduction with SkiaSharp 3.119.2 — all three files return TopLeft instead of correct orientation",
      "layer": "csharp",
      "command": "cd Repro && dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp Version: 3.119.0.0\nRuntime: .NET 8.0.23\nOS: Darwin 25.2.0 Darwin Kernel Version 25.2.0\nArch: Arm64\n\nAPC_0316.dng: Format=Jpeg, EncodedOrigin=TopLeft, Size=4032x3024\n  *** BUG: Origin is TopLeft - likely ignoring EXIF orientation tag\nAPC_0193.dng: Format=Jpeg, EncodedOrigin=TopLeft, Size=4032x3024\n  *** BUG: Origin is TopLeft - likely ignoring EXIF orientation tag\nIMG_1361.CR2: Format=Jpeg, EncodedOrigin=TopLeft, Size=1536x1024\n  *** BUG: Origin is TopLeft - likely ignoring EXIF orientation tag\n\nRESULT: Bug reproduced - orientation not read correctly",
      "result": "wrong-output"
    },
    {
      "stepNumber": 5,
      "description": "Test on main branch source build — added temporary xUnit test RawCodecCanLoadCorrectOrigin to SKCodecTest.cs with DNG and CR2 files",
      "layer": "csharp",
      "command": "dotnet test tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj --no-build --filter \"FullyQualifiedName~RawCodecCanLoadCorrectOrigin\"",
      "exitCode": 1,
      "output": "Failed SkiaSharp.Tests.SKCodecTest.RawCodecCanLoadCorrectOrigin(image: \"IMG_1361.CR2\", origin: LeftBottom)\n  Assert.Equal() Failure\n  Expected: LeftBottom\n  Actual:   TopLeft\n\nFailed SkiaSharp.Tests.SKCodecTest.RawCodecCanLoadCorrectOrigin(image: \"APC_0316.dng\", origin: RightTop)\n  Assert.Equal() Failure\n  Expected: RightTop\n  Actual:   TopLeft\n\nFailed!  - Failed: 2, Passed: 0, Skipped: 0, Total: 2",
      "result": "failure"
    }
  ],
  "artifacts": [
    {
      "filename": "APC_0316.dng",
      "description": "DNG raw camera file from issue reporter. EXIF orientation=6 (RightTop). 12.8MB.",
      "source": "issue-attachment",
      "url": "https://github.com/mono/SkiaSharp/files/1616452/APC_0316.zip",
      "available": true
    },
    {
      "filename": "APC_0193.dng",
      "description": "DNG raw camera file from issue reporter. EXIF orientation=6 (RightTop). 14.5MB.",
      "source": "issue-attachment",
      "url": "https://github.com/mono/SkiaSharp/files/1616453/APC_0193.zip",
      "available": true
    },
    {
      "filename": "IMG_1361.CR2",
      "description": "Canon CR2 raw camera file from issue reporter's comment. EXIF orientation=8 (LeftBottom). 7.2MB.",
      "source": "issue-attachment",
      "url": "https://github.com/mono/SkiaSharp/files/1645431/IMG_1361.zip",
      "available": true
    }
  ],
  "errorMessages": {
    "primaryError": "SKCodec.EncodedOrigin returns TopLeft for DNG and CR2 files that have non-TopLeft EXIF orientation tags",
    "additionalErrors": [
      "Assert.Equal() Failure — Expected: RightTop, Actual: TopLeft (APC_0316.dng)",
      "Assert.Equal() Failure — Expected: LeftBottom, Actual: TopLeft (IMG_1361.CR2)"
    ]
  },
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.119.2",
    "dockerUsed": false
  }
}
