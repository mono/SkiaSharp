{
  "meta": {
    "schemaVersion": "1.0",
    "number": 2997,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T16:00:00Z"
  },
  "inputs": {
    "triageFile": "ai-triage/2997.json"
  },
  "conclusion": "reproduced",
  "assessment": "working-as-designed",
  "notes": "Reproduced on SkiaSharp 2.88.3, 3.119.2, and main (source). SKMatrix.MapRect always normalizes the output rectangle (sorts left≤right, top≤bottom) because upstream Skia's SkMatrix::mapRect calls sort_as_rect(). This is upstream Skia behavior, not a SkiaSharp wrapper issue. The workaround is to use SKMatrix.MapPoint on individual corners to preserve coordinate ordering.",
  "scope": "universal",
  "reproductionTime": "~15 minutes",
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      { "name": "SkiaSharp", "version": "2.88.3" }
    ]
  },
  "versionResults": [
    {
      "version": "2.88.3",
      "source": "nuget",
      "result": "reproduced",
      "notes": "MapRect normalizes inverted rect through identity matrix. Left/Right and Top/Bottom swapped in output.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Same normalization behavior on latest stable release.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "reproduced",
      "notes": "Same behavior on main branch source build.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "2.88.3",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Same normalization behavior confirmed on Docker Linux x64.",
      "platform": "docker-linux-x64"
    }
  ],
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project and add SkiaSharp 2.88.3",
      "layer": "setup",
      "command": "mkdir -p /tmp/repro-2997 && cd /tmp/repro-2997 && dotnet new console -n Repro --framework net8.0 && cd Repro && dotnet add package SkiaSharp --version 2.88.3",
      "exitCode": 0,
      "output": "The template \"Console App\" was created successfully.\nPackageReference for package 'SkiaSharp' version '2.88.3' added.",
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Write reproduction code using reporter's exact scenario: SKRect with inverted coordinates (Left>Right, Top>Bottom) mapped through identity matrix",
      "layer": "csharp",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Reproduction code that creates an SKRect with inverted coordinates and maps it through an identity matrix, checking if coordinates are preserved",
          "content": "using SkiaSharp;\n\nConsole.WriteLine($\"SkiaSharp version: {typeof(SKMatrix).Assembly.GetName().Version}\");\nConsole.WriteLine($\"Runtime: {System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription}\");\nConsole.WriteLine($\"OS: {System.Runtime.InteropServices.RuntimeInformation.OSDescription}\");\nConsole.WriteLine($\"Arch: {System.Runtime.InteropServices.RuntimeInformation.ProcessArchitecture}\");\n\nvar inputRect = new SKRect();\ninputRect.Left = 25;\ninputRect.Right = 15;\ninputRect.Bottom = 2;\ninputRect.Top = 10;\n\nConsole.WriteLine($\"\\nInput rect: Left={inputRect.Left}, Top={inputRect.Top}, Right={inputRect.Right}, Bottom={inputRect.Bottom}\");\n\nvar matrix = SKMatrix.CreateIdentity();\nvar resultRect = matrix.MapRect(inputRect);\n\nConsole.WriteLine($\"Result rect: Left={resultRect.Left}, Top={resultRect.Top}, Right={resultRect.Right}, Bottom={resultRect.Bottom}\");\n\nbool leftMatch = inputRect.Left == resultRect.Left;\nbool rightMatch = inputRect.Right == resultRect.Right;\nbool topMatch = inputRect.Top == resultRect.Top;\nbool bottomMatch = inputRect.Bottom == resultRect.Bottom;\n\nConsole.WriteLine($\"\\nLeft preserved: {leftMatch} (input={inputRect.Left}, result={resultRect.Left})\");\nConsole.WriteLine($\"Right preserved: {rightMatch} (input={inputRect.Right}, result={resultRect.Right})\");\nConsole.WriteLine($\"Top preserved: {topMatch} (input={inputRect.Top}, result={resultRect.Top})\");\nConsole.WriteLine($\"Bottom preserved: {bottomMatch} (input={inputRect.Bottom}, result={resultRect.Bottom})\");\n\nif (leftMatch && rightMatch && topMatch && bottomMatch)\n    Console.WriteLine(\"\\nPASS: MapRect preserved coordinate ordering through identity matrix\");\nelse\n{\n    Console.WriteLine(\"\\nFAIL: MapRect normalized/sorted the rectangle coordinates\");\n    Console.WriteLine(\"BUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\");\n}\n\nvar topLeft = matrix.MapPoint(inputRect.Left, inputRect.Top);\nvar bottomRight = matrix.MapPoint(inputRect.Right, inputRect.Bottom);\nConsole.WriteLine($\"\\nMapPoint workaround: Left={topLeft.X}, Top={topLeft.Y}, Right={bottomRight.X}, Bottom={bottomRight.Y}\");\n\nConsole.WriteLine(\"\\nSUCCESS: test completed\");"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Build and run with SkiaSharp 2.88.3 — verify MapRect normalizes inverted rect",
      "layer": "csharp",
      "command": "cd /tmp/repro-2997/Repro && dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 2.88.0.0\nRuntime: .NET 8.0.23\nOS: Darwin 25.2.0\nArch: Arm64\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nLeft preserved: False (input=25, result=15)\nRight preserved: False (input=15, result=25)\nTop preserved: False (input=10, result=2)\nBottom preserved: False (input=2, result=10)\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\nBUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\n\nMapPoint workaround: Left=25, Top=10, Right=15, Bottom=2\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 4,
      "description": "Test with latest stable SkiaSharp 3.119.2 in fresh project directory",
      "layer": "csharp",
      "command": "cd /tmp/repro-2997-latest/Repro && dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nRuntime: .NET 8.0.23\nArch: Arm64\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\nBUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\n\nMapPoint workaround: Left=25, Top=10, Right=15, Bottom=2\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 5,
      "description": "Test on main branch source using console sample with project reference",
      "layer": "csharp",
      "command": "dotnet run --project samples/Basic/Console/SkiaSharpSample/SkiaSharpSample.csproj",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nRuntime: .NET 8.0.23\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 6,
      "description": "Cross-platform verification: Docker Linux x64 with SkiaSharp 2.88.3",
      "layer": "csharp",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:8.0 bash -c '...'",
      "exitCode": 0,
      "output": "SkiaSharp version: 2.88.0.0\nRuntime: .NET 8.0.24\nArch: X64\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\nFAIL: MapRect normalized/sorted the rectangle coordinates\nSUCCESS: test completed",
      "result": "wrong-output"
    }
  ],
  "errorMessages": {
    "primaryError": "SKMatrix.MapRect normalizes (sorts) output rectangle coordinates: input Left=25,Top=10,Right=15,Bottom=2 becomes output Left=15,Top=2,Right=25,Bottom=10 even through identity matrix"
  },
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.23",
    "dotnetSdkVersion": "10.0.102",
    "skiaSharpVersion": "2.88.3",
    "dockerUsed": true
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "classification",
        "upstream": "type/bug with confidence 0.35 — triage was uncertain if this is a real bug",
        "corrected": "Behavior confirmed as reproduced. It is upstream Skia behavior (working-as-designed), but the reported behavior factually occurs."
      }
    ]
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.85,
      "reason": "Reproduced on all tested versions including main. This is upstream Skia behavior — SkMatrix::mapRect intentionally calls sort_as_rect() to normalize output. A MapPoint workaround exists. The reporter's regression claim (2.88.2→2.88.3) is likely inaccurate — this behavior has been in Skia for years."
    },
    "workarounds": [
      "Use SKMatrix.MapPoint to transform the rect corners individually, then construct a new SKRect preserving the original coordinate ordering: var tl = matrix.MapPoint(rect.Left, rect.Top); var br = matrix.MapPoint(rect.Right, rect.Bottom); var result = new SKRect(tl.X, tl.Y, br.X, br.Y);"
    ],
    "proposedResponse": {
      "status": "needs-human-edit",
      "summary": "Reproduced — upstream Skia behavior with MapPoint workaround",
      "body": "Thanks for the detailed report and repro code!\n\nWe've confirmed the behavior — `SKMatrix.MapRect` normalizes (sorts) the output rectangle so that `Left ≤ Right` and `Top ≤ Bottom`, even through an identity matrix. This was reproduced on:\n\n| Version | Platform | Result |\n|---------|----------|--------|\n| 2.88.3 | macOS arm64 | ❌ Normalized |\n| 3.119.2 | macOS arm64 | ❌ Normalized |\n| main (source) | macOS arm64 | ❌ Normalized |\n| 2.88.3 | Docker Linux x64 | ❌ Normalized |\n\nThis is upstream Skia behavior — `SkMatrix::mapRect` intentionally calls `sort_as_rect()` to normalize the output rectangle. The SkiaSharp C API and C# wrapper are thin pass-throughs with no additional normalization.\n\n**Workaround:** Transform the corners individually using `MapPoint` to preserve coordinate ordering:\n\n```csharp\nvar topLeft = matrix.MapPoint(inputRect.Left, inputRect.Top);\nvar bottomRight = matrix.MapPoint(inputRect.Right, inputRect.Bottom);\nvar resultRect = new SKRect(topLeft.X, topLeft.Y, bottomRight.X, bottomRight.Y);\n```\n\nThis avoids the `sort_as_rect` normalization step and preserves your original coordinate ordering.\n\nRegarding the regression from 2.88.2 → 2.88.3: we weren't able to identify any changes to `SKMatrix.MapRect` or `sk_matrix_map_rect` between those versions. The normalization behavior appears to have been present in Skia for many years. It's possible the difference was in a different code path in your application."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Add area label for SkiaSharp core",
        "risk": "low",
        "confidence": 0.95,
        "labels": ["type/bug", "area/SkiaSharp"]
      }
    ]
  }
}
