{
  "meta": {
    "schemaVersion": "1.0",
    "number": 754,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T00:07:25Z"
  },
  "inputs": {
    "triageFile": "ai-triage/754.json"
  },
  "conclusion": "reproduced",
  "assessment": "likely-bug",
  "notes": "Reproduced: SKBitmap.Decode(codec, imageInfo) returns null when requesting SKColorType.Gray8 for an indexed (palette) PNG, even with explicit SKAlphaType.Opaque. The codec reports ColorType=Rgba8888 for indexed PNGs, and Skia's codec cannot convert Rgba8888 to Gray8 during decode. True grayscale PNGs (ColorType=Gray8 natively) decode correctly. Bug confirmed on SkiaSharp 3.119.2 (latest stable) and main (source). The triage analysis correctly identified the alpha type issue, but the deeper cause is that Skia's codec path rejects the Rgba8888 to Gray8 color conversion entirely — specifying Opaque alpha alone does not fix it.",
  "reproductionTime": "~8 minutes",
  "versionResults": [
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "SKBitmap.Decode returns null for indexed PNG with Gray8+Premul and Gray8+Opaque. True grayscale PNG works fine."
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "reproduced",
      "notes": "xUnit test Assert.NotNull() failed — SKBitmap.Decode(codec, info) returns null for index8.png with Gray8+Opaque."
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.119.2"
      }
    ]
  },
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create standalone console project with SkiaSharp 3.119.2",
      "layer": "setup",
      "command": "dotnet new console -n Repro --framework net8.0 && cd Repro && dotnet add package SkiaSharp --version 3.119.2",
      "exitCode": 0,
      "result": "success",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Console project referencing SkiaSharp 3.119.2",
          "content": "<Project Sdk=\"Microsoft.NET.Sdk\">\n\n  <PropertyGroup>\n    <OutputType>Exe</OutputType>\n    <TargetFramework>net8.0</TargetFramework>\n    <ImplicitUsings>enable</ImplicitUsings>\n    <Nullable>enable</Nullable>\n  </PropertyGroup>\n\n  <ItemGroup>\n    <PackageReference Include=\"SkiaSharp\" Version=\"3.119.2\" />\n  </ItemGroup>\n\n</Project>"
        }
      ]
    },
    {
      "stepNumber": 2,
      "description": "Download reporter's test image (8-bit indexed/colormap PNG) and create a true 8-bit grayscale PNG for comparison",
      "layer": "setup",
      "command": "curl -sLo gray8-test.png 'https://user-images.githubusercontent.com/5593825/51076794-aecf2b80-169d-11e9-9b9b-1c01eeb20467.png'",
      "exitCode": 0,
      "output": "gray8-test.png: PNG image data, 960 x 960, 8-bit colormap, non-interlaced\ntrue-gray8.png: PNG image data, 4 x 4, 8-bit grayscale, non-interlaced",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Write reproduction program testing Gray8 decode with both indexed PNG and true grayscale PNG",
      "layer": "csharp",
      "result": "success",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Reproduction code testing SKBitmap.Decode with Gray8 on indexed and grayscale PNGs",
          "content": "using SkiaSharp;\n\nint failures = 0;\n\nvoid TestDecode(string label, string filename)\n{\n    Console.WriteLine($\"\\n=== {label} ({filename}) ===\");\n    var bytes = File.ReadAllBytes(filename);\n\n    var stream1 = new MemoryStream(bytes);\n    var codec1 = SKCodec.Create(stream1);\n    if (codec1 == null) { Console.WriteLine(\"ERROR: codec is null\"); return; }\n    Console.WriteLine($\"Codec: {codec1.Info.Width}x{codec1.Info.Height}, ColorType={codec1.Info.ColorType}, AlphaType={codec1.Info.AlphaType}\");\n\n    Console.WriteLine(\"\\n  Test 1: Gray8 + default alpha (3-param SKImageInfo)\");\n    var info1 = new SKImageInfo(codec1.Info.Width, codec1.Info.Height, SKColorType.Gray8);\n    Console.WriteLine($\"  -> ImageInfo: ColorType={info1.ColorType}, AlphaType={info1.AlphaType}\");\n    var s1 = new MemoryStream(bytes);\n    var c1 = SKCodec.Create(s1);\n    var bmp1 = SKBitmap.Decode(c1, info1);\n    Console.WriteLine($\"  -> bitmap is null: {bmp1 == null}\");\n    if (bmp1 != null) { Console.WriteLine($\"  -> {bmp1.Width}x{bmp1.Height}, BytesPerPixel={bmp1.BytesPerPixel}\"); bmp1.Dispose(); }\n    else { failures++; }\n\n    Console.WriteLine(\"\\n  Test 2: Gray8 + explicit Opaque\");\n    var info2 = new SKImageInfo(codec1.Info.Width, codec1.Info.Height, SKColorType.Gray8, SKAlphaType.Opaque);\n    Console.WriteLine($\"  -> ImageInfo: ColorType={info2.ColorType}, AlphaType={info2.AlphaType}\");\n    var s2 = new MemoryStream(bytes);\n    var c2 = SKCodec.Create(s2);\n    var bmp2 = SKBitmap.Decode(c2, info2);\n    Console.WriteLine($\"  -> bitmap is null: {bmp2 == null}\");\n    if (bmp2 != null) { Console.WriteLine($\"  -> {bmp2.Width}x{bmp2.Height}, BytesPerPixel={bmp2.BytesPerPixel}\"); bmp2.Dispose(); }\n    else { failures++; }\n\n    Console.WriteLine(\"\\n  Test 3: Default decode (no imageInfo override)\");\n    var s3 = new MemoryStream(bytes);\n    var c3 = SKCodec.Create(s3);\n    var bmp3 = SKBitmap.Decode(c3);\n    Console.WriteLine($\"  -> bitmap is null: {bmp3 == null}\");\n    if (bmp3 != null) { Console.WriteLine($\"  -> {bmp3.Width}x{bmp3.Height}, BytesPerPixel={bmp3.BytesPerPixel}, ColorType={bmp3.ColorType}, AlphaType={bmp3.AlphaType}\"); bmp3.Dispose(); }\n\n    codec1.Dispose();\n}\n\nTestDecode(\"Indexed PNG from issue (8-bit colormap)\", \"gray8-test.png\");\nTestDecode(\"True Grayscale PNG (8-bit grayscale)\", \"true-gray8.png\");\n\nConsole.WriteLine($\"\\n{'=',-60}\");\nif (failures > 0)\n    Console.WriteLine($\"*** BUG CONFIRMED: {failures} decode(s) returned null with Gray8 ***\");\nelse\n    Console.WriteLine(\"All decodes succeeded -- bug NOT reproduced\");\n\nreturn failures > 0 ? 1 : 0;"
        }
      ]
    },
    {
      "stepNumber": 4,
      "description": "Run reproduction with SkiaSharp 3.119.2 — indexed PNG fails to decode as Gray8 even with explicit Opaque alpha",
      "layer": "csharp",
      "command": "cd /tmp/repro-754/Repro && dotnet run",
      "exitCode": 1,
      "output": "=== Indexed PNG from issue (8-bit colormap) (gray8-test.png) ===\nCodec: 960x960, ColorType=Rgba8888, AlphaType=Opaque\n\n  Test 1: Gray8 + default alpha (3-param SKImageInfo)\n  -> ImageInfo: ColorType=Gray8, AlphaType=Premul\n  -> bitmap is null: True\n\n  Test 2: Gray8 + explicit Opaque\n  -> ImageInfo: ColorType=Gray8, AlphaType=Opaque\n  -> bitmap is null: True\n\n  Test 3: Default decode (no imageInfo override)\n  -> bitmap is null: False\n  -> 960x960, BytesPerPixel=4, ColorType=Rgba8888, AlphaType=Opaque\n\n=== True Grayscale PNG (8-bit grayscale) (true-gray8.png) ===\nCodec: 4x4, ColorType=Gray8, AlphaType=Opaque\n\n  Test 1: Gray8 + default alpha (3-param SKImageInfo)\n  -> ImageInfo: ColorType=Gray8, AlphaType=Premul\n  -> bitmap is null: False\n  -> 4x4, BytesPerPixel=1\n\n  Test 2: Gray8 + explicit Opaque\n  -> ImageInfo: ColorType=Gray8, AlphaType=Opaque\n  -> bitmap is null: False\n  -> 4x4, BytesPerPixel=1\n\n  Test 3: Default decode (no imageInfo override)\n  -> bitmap is null: False\n  -> 4x4, BytesPerPixel=1, ColorType=Gray8, AlphaType=Opaque\n\n*** BUG CONFIRMED: 2 decode(s) returned null with Gray8 ***",
      "result": "failure"
    },
    {
      "stepNumber": 5,
      "description": "Build SkiaSharp from source (main branch) and run targeted xUnit test for Gray8 decode of indexed PNG",
      "layer": "csharp",
      "command": "dotnet build tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj && dotnet test tests/SkiaSharp.Tests.Console/SkiaSharp.Tests.Console.csproj --no-build --filter DecodeIndexedPngAsGray8",
      "exitCode": 1,
      "output": "Failed SkiaSharp.Tests.SKBitmapTest.DecodeIndexedPngAsGray8ReturnsNonNull [49 ms]\nError Message:\n Assert.NotNull() Failure\nStack Trace:\n  at SkiaSharp.Tests.SKBitmapTest.DecodeIndexedPngAsGray8ReturnsNonNull() in tests/Tests/SkiaSharp/SKBitmapTest.cs:line 695\n\nFailed! - Failed: 1, Passed: 0, Skipped: 0, Total: 1",
      "result": "failure"
    }
  ],
  "artifacts": [
    {
      "filename": "gray8-test.png",
      "description": "Reporter's test image — 960x960 8-bit indexed (colormap) PNG that cannot be decoded as Gray8",
      "source": "issue-attachment",
      "url": "https://user-images.githubusercontent.com/5593825/51076794-aecf2b80-169d-11e9-9b9b-1c01eeb20467.png",
      "available": true
    }
  ],
  "errorMessages": {
    "primaryError": "SKBitmap.Decode(codec, imageInfo) returns null when requesting SKColorType.Gray8 for an indexed (palette) PNG. Skia's codec cannot convert Rgba8888 to Gray8.",
    "additionalErrors": [
      "The 3-param SKImageInfo constructor defaults AlphaType to Premul, which is invalid for Gray8 — but fixing alpha alone does NOT resolve the issue for indexed PNGs",
      "True grayscale PNGs (native ColorType=Gray8) decode correctly with both Premul and Opaque alpha types"
    ]
  },
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.417",
    "skiaSharpVersion": "3.119.2",
    "dockerUsed": false
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "root-cause",
        "upstream": "Triage identified the 3-param SKImageInfo constructor defaulting AlphaType to Premul as the root cause, with GetAlphaType() containing the fix",
        "corrected": "The alpha type default is a contributing factor but NOT the root cause. Even with explicit SKAlphaType.Opaque, indexed PNGs fail to decode as Gray8. The real issue is Skia's codec path rejects the Rgba8888 to Gray8 color type conversion entirely. True grayscale PNGs work fine with either alpha type."
      }
    ]
  }
}
