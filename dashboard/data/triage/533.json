{
  "meta": {
    "schemaVersion": "2.1",
    "number": 533,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2025-07-24T12:00:00Z",
    "currentLabels": [
      "type/bug",
      "status/help-wanted",
      "os/Android",
      "area/SkiaSharp.Views",
      "backend/OpenGL"
    ],
    "state": "open"
  },
  "summary": "SKGLView on Android runs at uncapped framerates (300-1000fps) after switch from GLSurfaceView to TextureView \u2014 no VSync or frame pacing in custom GL thread",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.82
    },
    "area": {
      "value": "area/SkiaSharp.Views",
      "confidence": 0.95
    },
    "backends": [
      {
        "value": "backend/OpenGL",
        "confidence": 0.95
      }
    ],
    "platforms": [
      {
        "value": "os/Android",
        "confidence": 0.95
      }
    ],
    "tenets": [
      {
        "value": "tenet/performance",
        "confidence": 0.9
      }
    ]
  },
  "evidence": {
    "bugSignals": {
      "hasCrash": false,
      "hasStackTrace": false,
      "reproQuality": "steps-only",
      "severity": "medium",
      "severityReason": "Uncapped FPS wastes battery and CPU/GPU resources but does not crash. Frame-based animations break, but a time-based approach is the correct pattern anyway. Workaround exists.",
      "hasWorkaround": true,
      "workaroundSummary": "Use a time-based game loop instead of frame-based. Alternatively, use a Stopwatch-based frame limiter in the PaintSurface callback to throttle rendering to the desired FPS.",
      "targetFrameworks": [
        "net8.0-android"
      ]
    },
    "reproEvidence": {
      "relatedIssues": [
        2112,
        2555
      ],
      "stepsToReproduce": [
        "Create a Xamarin.Forms or MAUI project with an SKGLView",
        "Set HasRenderLoop to true",
        "In PaintSurface, measure elapsed time between calls",
        "Observe FPS exceeds 60 (often 300-1000fps depending on device)"
      ],
      "codeSnippets": [
        {
          "code": "Stopwatch sw = Stopwatch.StartNew();\nTimeSpan last;\n\nprivate void OnPaint(object sender, SKPaintGLSurfaceEventArgs e)\n{\n    var c = sw.Elapsed;\n    var ts = c - last;\n    last = c;\n    var fps = 1.0 / (ts.TotalSeconds);\n    Log.Debug(\u0022FPS\u0022, fps.ToString(\u00220,000.00\u0022));\n}",
          "language": "csharp",
          "context": "FPS measurement code from maintainer comment"
        }
      ],
      "environmentDetails": "Android 7\u002B API 24, Samsung Galaxy S7 Edge. Also confirmed on Motorola Moto g6 (API 28), Galaxy Note 3 (API 21), and emulators."
    },
    "versionAnalysis": {
      "reason": "The root cause (GLTextureView lacks eglSwapInterval/VSync) is still present in the current codebase. The GLTextureView.cs custom GL thread has no frame pacing mechanism.",
      "mentionedVersions": [
        "1.59.3",
        "1.60.1"
      ],
      "currentRelevance": "likely"
    },
    "regression": {
      "isRegression": true,
      "confidence": 0.9,
      "reason": "Behavior changed when SkiaSharp switched from Android\u0027s GLSurfaceView (which has built-in VSync via eglSwapInterval) to a custom GLTextureView (which does not set eglSwapInterval). Maintainer confirmed this in comment 2.",
      "workedInVersion": "1.59.3",
      "brokeInVersion": "1.60.1"
    }
  },
  "analysis": {
    "summary": "The Android SKGLView renders at uncapped framerates because the custom GLTextureView implementation does not call eglSwapInterval to enable VSync. The old GLSurfaceView had VSync built-in. The maintainer acknowledged this is a real issue and investigated Choreographer as a potential fix, but no implementation was made.",
    "keySignals": [
      {
        "text": "Application framerate went from a capped 60fps to a ~300fps",
        "source": "body",
        "interpretation": "Clear regression in frame pacing after version upgrade"
      },
      {
        "text": "we are no longer using the old GLSurfaceView to render the content, but the new TextureView",
        "source": "comment 2",
        "interpretation": "Maintainer identifies root cause as the GLSurfaceView\u2192TextureView migration"
      },
      {
        "text": "Having uncapped is nice, but a heavy drain. Also, it is no point having the updates faster than the screen - that wastes resources.",
        "source": "comment 8",
        "interpretation": "Maintainer confirms uncapped FPS is a problem worth fixing"
      },
      {
        "text": "We might be able to look at Choreographer",
        "source": "comment 9",
        "interpretation": "Maintainer proposed Choreographer as potential solution but never implemented it"
      },
      {
        "text": "I really need to look at this. Noticing 1.2K FPS in some emulators.",
        "source": "comment 6",
        "interpretation": "Maintainer re-confirmed the problem persists 2 years later"
      }
    ],
    "fieldRationales": [
      {
        "field": "type",
        "chosen": "type/bug",
        "expandedReason": "This is a behavioral regression: FPS was capped at 60 in 1.59.3 (GLSurfaceView with VSync) and became uncapped in 1.60.1 (GLTextureView without VSync). The maintainer acknowledged it as a real problem worth fixing. Frame-based animations break and battery is wasted.",
        "alternatives": [
          {
            "value": "type/enhancement",
            "whyRejected": "While adding Choreographer support would be an enhancement, the core issue is a regression \u2014 VSync was removed when switching to TextureView. Existing behavior broke."
          }
        ]
      },
      {
        "field": "area",
        "chosen": "area/SkiaSharp.Views",
        "expandedReason": "The issue is in the Android platform view layer (GLTextureView, SKGLTextureView, SKGLViewHandler.Android), all part of SkiaSharp.Views."
      },
      {
        "field": "backends",
        "chosen": "backend/OpenGL",
        "expandedReason": "The issue is specific to the OpenGL rendering path (GLTextureView, EGL). CPU-based SKCanvasView is not affected."
      },
      {
        "field": "platforms",
        "chosen": "os/Android",
        "expandedReason": "The GLTextureView custom implementation is Android-specific. iOS and other platforms have their own rendering pipelines."
      },
      {
        "field": "tenets",
        "chosen": "tenet/performance",
        "expandedReason": "Uncapped FPS wastes CPU/GPU cycles and drains battery. Rendering faster than the display refresh rate provides no visual benefit."
      },
      {
        "field": "bugSignals.severity",
        "chosen": "medium",
        "expandedReason": "No crash or data loss. Animations based on frame count break, and battery drains faster than necessary. However, a time-based animation loop is the recommended pattern anyway, and multiple users note the higher FPS is actually beneficial for responsive rendering."
      },
      {
        "field": "regression.isRegression",
        "chosen": "true",
        "expandedReason": "Maintainer confirmed in comment 2 that the switch from GLSurfaceView to TextureView caused the behavior change. Version 1.59.3 was capped, 1.60.1 is not."
      },
      {
        "field": "versionAnalysis.currentRelevance",
        "chosen": "likely",
        "expandedReason": "The GLTextureView.cs code still does not call eglSwapInterval. The same uncapped render loop exists in the current codebase."
      },
      {
        "field": "actionability.suggestedAction",
        "chosen": "needs-investigation",
        "expandedReason": "The root cause is clear (missing eglSwapInterval/Choreographer), but the implementation approach needs investigation \u2014 adding eglSwapInterval(1) could cause issues with TextureView, and Choreographer integration is non-trivial. The maintainer explored options but never committed to an approach."
      }
    ],
    "uncertainties": [
      "Whether adding eglSwapInterval(1) to GLTextureView\u0027s EglHelper would work correctly with TextureView-based EGL surfaces",
      "Whether Choreographer-based frame pacing would introduce input latency or other side effects",
      "Whether some users depend on the uncapped behavior for non-display rendering (offscreen rendering, benchmarks)"
    ],
    "assumptions": [
      "Assumed the issue still reproduces on current SkiaSharp since the GLTextureView code has not added any frame pacing",
      "Assumed the reporter\u0027s target framework equivalent today would be net8.0-android since original was Xamarin.Android"
    ],
    "resolution": {
      "hypothesis": "The custom GLTextureView does not set eglSwapInterval(1) like Android\u0027s built-in GLSurfaceView does. This means eglSwapBuffers returns immediately instead of waiting for the next VSync, causing the render thread to loop as fast as possible.",
      "proposals": [
        {
          "title": "Add eglSwapInterval(1) to EglHelper",
          "description": "Add egl.EglSwapInterval(eglDisplay, 1) after creating the EGL surface in GLTextureView.EglHelper. This enables VSync, capping FPS to the display refresh rate. This is what Android\u0027s GLSurfaceView does internally.",
          "confidence": 0.7,
          "effort": "low",
          "category": "fix",
          "validated": "untested"
        },
        {
          "title": "Integrate Android Choreographer for frame pacing",
          "description": "Use Android\u0027s Choreographer API to schedule frame callbacks at the display refresh rate. This is the approach the maintainer proposed in comment 9. More robust than raw eglSwapInterval but requires significant refactoring of the GL thread loop.",
          "confidence": 0.65,
          "effort": "high",
          "category": "fix",
          "validated": "untested"
        },
        {
          "title": "Use time-based animation instead of frame-based",
          "description": "Users can work around the issue by measuring elapsed time between frames and using delta-time for animations instead of assuming a fixed frame rate. This is the correct game loop pattern regardless of frame rate.",
          "confidence": 0.9,
          "effort": "low",
          "category": "workaround",
          "codeSnippet": "private readonly Stopwatch _sw = Stopwatch.StartNew();\nprivate TimeSpan _last;\n\nprivate void OnPaintSurface(object sender, SKPaintGLSurfaceEventArgs e)\n{\n    var now = _sw.Elapsed;\n    var deltaTime = (now - _last).TotalSeconds;\n    _last = now;\n\n    // Use deltaTime for all animations instead of assuming fixed FPS\n    var speed = 100.0; // pixels per second\n    position \u002B= speed * deltaTime;\n}",
          "validated": "untested"
        }
      ],
      "recommendedProposal": "Use time-based animation instead of frame-based",
      "recommendedReason": "Immediate workaround for the reporter. Time-based animation is the correct pattern for any frame rate. The underlying fix (eglSwapInterval or Choreographer) should be implemented in SkiaSharp but requires investigation."
    },
    "codeInvestigation": [
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/GLTextureView.cs",
        "lines": "634-641",
        "relevance": "The Swap() method calls EglSwapBuffers but does NOT call eglSwapInterval \u2014 this is the missing VSync. Android\u0027s GLSurfaceView sets eglSwapInterval(1) by default which caps FPS to display refresh rate."
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/GLTextureView.cs",
        "lines": "1081-1083",
        "relevance": "IsReadyToDraw() returns true continuously when renderMode == Rendermode.Continuously, causing the GL thread to loop as fast as possible with no throttle."
      },
      {
        "file": "source/SkiaSharp.Views.Maui/SkiaSharp.Views.Maui.Core/Handlers/SKGLView/SKGLViewHandler.Android.cs",
        "lines": "61-68",
        "relevance": "MapHasRenderLoop sets RenderMode to Rendermode.Continuously when HasRenderLoop is true, triggering the uncapped render loop in GLTextureView."
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SKGLTextureView.cs",
        "lines": "36-43",
        "relevance": "SKGLTextureView extends GLTextureView \u2014 inherits the uncapped render loop. No frame pacing override."
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views/Platform/Android/SKGLSurfaceView.cs",
        "lines": "9-10",
        "relevance": "SKGLSurfaceView extends Android\u0027s GLSurfaceView which has native VSync. This is the old implementation that capped FPS correctly."
      }
    ]
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.8,
      "reason": "Root cause is clear (missing VSync in GLTextureView) but the fix approach needs investigation. Adding eglSwapInterval may not work with TextureView surfaces. Choreographer integration is complex. Issue has been open since 2018 with maintainer acknowledgment.",
      "requiresHumanReview": true
    },
    "actions": [
      {
        "id": "labels-1",
        "type": "update-labels",
        "risk": "low",
        "description": "Labels are already correct \u2014 no changes needed",
        "reason": "Current labels (type/bug, area/SkiaSharp.Views, os/Android, backend/OpenGL) match classification exactly. Adding tenet/performance.",
        "confidence": 0.95,
        "payload": {
          "labelsToAdd": [
            "tenet/performance"
          ],
          "labelsToRemove": []
        }
      },
      {
        "id": "comment-1",
        "type": "add-comment",
        "risk": "high",
        "description": "Post workaround with time-based animation pattern",
        "reason": "Issue has been open 6\u002B years with no fix. Providing a concrete workaround helps affected users.",
        "confidence": 0.8,
        "dependsOn": "labels-1",
        "payload": {
          "commentType": "workaround",
          "draftBody": "Thanks for the report \u2014 this is a known issue caused by the switch from \u0060GLSurfaceView\u0060 (which has built-in VSync) to a custom \u0060GLTextureView\u0060 that doesn\u0027t call \u0060eglSwapInterval\u0060.\n\nHere\u0027s a workaround you can use now: switch to time-based animation instead of frame-based. This is the correct pattern regardless of frame rate:\n\n\u0060\u0060\u0060csharp\nprivate readonly Stopwatch _sw = Stopwatch.StartNew();\nprivate TimeSpan _last;\n\nprivate void OnPaintSurface(object sender, SKPaintGLSurfaceEventArgs e)\n{\n    var now = _sw.Elapsed;\n    var deltaTime = (now - _last).TotalSeconds;\n    _last = now;\n\n    // Use deltaTime for all animations\n    var speed = 100.0; // pixels per second\n    position \u002B= speed * deltaTime;\n}\n\u0060\u0060\u0060\n\nThe underlying issue (adding \u0060eglSwapInterval\u0060 or Choreographer-based frame pacing to the TextureView render loop) is still open for investigation.",
          "requiresHumanEdit": true,
          "finalBody": null,
          "dedupeToken": "triage-533-comment-1"
        }
      }
    ]
  },
  "url": "https://github.com/mono/SkiaSharp/issues/533"
}