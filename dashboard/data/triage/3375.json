{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3375,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T16:20:00Z",
    "currentLabels": [
      "type/bug",
      "os/Windows-Classic",
      "area/SkiaSharp",
      "tenet/reliability"
    ]
  },
  "summary": "Stack overflow crash on Windows x86 with .NET 8/9 due to missing Cdecl calling convention on LibraryImport P/Invoke declarations",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.98
    },
    "area": {
      "value": "area/SkiaSharp",
      "confidence": 0.95
    },
    "platforms": [
      "os/Windows-Classic"
    ],
    "tenets": [
      "tenet/reliability",
      "tenet/compatibility"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a .NET 8 or .NET 9 project referencing SkiaSharp 3.116\u002B",
        "Target x86 (win-x86) platform",
        "Call any SkiaSharp API that P/Invokes into the native library (e.g., SKBitmap.GetPixel)",
        "Observe stack overflow crash"
      ],
      "environmentDetails": "Windows 11, .NET 8.0/9.0, x86 target, SkiaSharp 3.116\u002B / 3.119.1",
      "relatedIssues": []
    },
    "bugSignals": {
      "severity": "critical",
      "isRegression": true,
      "errorType": "crash",
      "errorMessage": "Stack overflow at SkiaSharp.SkiaApi.sk_bitmap_get_pixel_color(IntPtr, Int32, Int32)",
      "stackTrace": "at SkiaSharp.SkiaApi.sk_bitmap_get_pixel_color(IntPtr, Int32, Int32)",
      "reproQuality": "partial",
      "targetFrameworks": [
        "net8.0",
        "net9.0"
      ]
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.116.0",
        "3.119.1",
        "2.88.9"
      ],
      "workedIn": "2.88.9",
      "brokeIn": "3.116.0",
      "currentRelevance": "likely",
      "relevanceReason": "The code generator (Generator.cs line 546) still emits [LibraryImport] without Cdecl calling convention. The generated file SkiaApi.generated.cs still lacks the necessary [UnmanagedCallConv] attribute. The bug is present on the main branch."
    },
    "regression": {
      "isRegression": true,
      "confidence": 0.95,
      "reason": "SkiaSharp 2.88.x used DllImport with CallingConvention.Cdecl exclusively. SkiaSharp 3.x introduced LibraryImport for .NET 7\u002B but omitted the Cdecl calling convention. On x64 this is invisible (one calling convention), on x86 it causes stack corruption.",
      "workedInVersion": "2.88.9",
      "brokeInVersion": "3.116.0"
    }
  },
  "analysis": {
    "summary": "The P/Invoke code generator emits [LibraryImport(SKIA)] without specifying a calling convention. On .NET 7\u002B x86 Windows, LibraryImport defaults to CallingConvention.Winapi which resolves to StdCall. The native C API functions use Cdecl (the C default). This calling convention mismatch causes stack corruption on x86, manifesting as a stack overflow. On x64, there is only one calling convention, so the mismatch is invisible.",
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp/SkiaApi.generated.cs",
        "finding": "[LibraryImport(SKIA)] at line 1647 does not specify calling convention. The [DllImport] fallback at line 1650 correctly specifies CallingConvention.Cdecl. This pattern repeats for ALL P/Invoke declarations in the file.",
        "relevance": "direct",
        "lines": "1644-1660"
      },
      {
        "file": "utils/SkiaSharpGenerator/Generate/Generator.cs",
        "finding": "Line 546 emits \u0060[LibraryImport ({config.DllName})]\u0060 without calling convention. Line 552 emits \u0060[DllImport ({config.DllName}, CallingConvention = CallingConvention.Cdecl)]\u0060. The LibraryImport path should also specify Cdecl via [UnmanagedCallConv(CallConvs = new[] { typeof(CallConvCdecl) })].",
        "relevance": "direct",
        "lines": "545-555"
      },
      {
        "file": "binding/SkiaSharp/SkiaSharp.csproj",
        "finding": "USE_DELEGATES is defined for net4x (Framework), USE_LIBRARY_IMPORT for net7.0\u002B. This confirms .NET Framework uses correct Cdecl delegates while .NET 7\u002B uses the broken LibraryImport path.",
        "relevance": "direct",
        "lines": "12-17"
      },
      {
        "file": "externals/skia/include/c/sk_types.h",
        "finding": "SK_C_API macro only specifies dllexport/dllimport visibility, NOT a calling convention. Native functions default to __cdecl (C default on Windows).",
        "relevance": "direct",
        "lines": "25-38"
      },
      {
        "file": "externals/skia/src/c/sk_bitmap.cpp",
        "finding": "sk_bitmap_get_pixel_color is a plain C function with no explicit calling convention \u2014 uses default __cdecl.",
        "relevance": "context",
        "lines": "87-89"
      }
    ],
    "rationale": "Both reporters describe x86-only crashes with .NET 8/9 that work fine on x64. The second reporter provides a clear stack overflow trace at sk_bitmap_get_pixel_color. Code investigation confirms the generated [LibraryImport] declarations lack Cdecl specification while the [DllImport] fallback correctly specifies it. The native SK_C_API macro contains no calling convention specifier, defaulting to Cdecl. This is clearly a code-generation bug, not a usage issue. Severity is critical because ALL P/Invoke calls on x86 .NET 7\u002B are affected \u2014 the library is fundamentally broken on this platform.",
    "keySignals": [
      {
        "text": "x86 crash, x64 works",
        "source": "issue body \u002B comment 2",
        "interpretation": "Classic calling convention mismatch symptom \u2014 only matters on x86 where StdCall and Cdecl differ."
      },
      {
        "text": "Stack overflow at SkiaSharp.SkiaApi.sk_bitmap_get_pixel_color",
        "source": "comment 2 (TomPMoleman)",
        "interpretation": "Stack corruption from calling convention mismatch causes stack overflow at the P/Invoke boundary."
      },
      {
        "text": "x86 \u002B net472: working, x86 \u002B Net8.0: ISSUE",
        "source": "comment 2 (TomPMoleman)",
        "interpretation": ".NET Framework uses USE_DELEGATES path with correct Cdecl convention; .NET 8 uses USE_LIBRARY_IMPORT path missing Cdecl."
      },
      {
        "text": "Rollback to 2.88.9 fixes it",
        "source": "issue body",
        "interpretation": "SkiaSharp 2.88.x didn\u0027t have LibraryImport \u2014 used DllImport with CallingConvention.Cdecl only."
      },
      {
        "text": "[LibraryImport(SKIA)] without calling convention in generated code",
        "source": "SkiaApi.generated.cs:1647-1648, Generator.cs:546",
        "interpretation": "Root cause \u2014 generator emits LibraryImport without Cdecl, defaulting to StdCall on x86 Windows."
      }
    ],
    "errorFingerprint": "stack-overflow::sk_*::x86::net7\u002B::libraryimport-missing-cdecl",
    "workarounds": [
      "Target x64 instead of x86 (x64 has a single calling convention, so the bug is invisible)",
      "Downgrade to SkiaSharp 2.88.x which uses DllImport with correct Cdecl convention"
    ],
    "nextQuestions": [
      "Confirm that adding [UnmanagedCallConv(CallConvs = new[] { typeof(CallConvCdecl) })] to the generator output fixes x86 .NET 8/9",
      "Check if HarfBuzzSharp has the same LibraryImport calling convention issue"
    ],
    "resolution": {
      "hypothesis": "LibraryImport without Cdecl calling convention defaults to StdCall on x86 Windows, causing stack corruption on every P/Invoke call into the native Cdecl library.",
      "proposals": [
        {
          "description": "Update Generator.cs line 546 to also emit [UnmanagedCallConv(CallConvs = new[] { typeof(CallConvCdecl) })] after the [LibraryImport] attribute. Then regenerate SkiaApi.generated.cs with \u0060pwsh ./utils/generate.ps1\u0060.",
          "title": "Fix code generator to emit Cdecl for LibraryImport",
          "confidence": 0.95,
          "effort": "small"
        },
        {
          "description": "As a workaround, compile for x64 or AnyCPU (prefer 64-bit) instead of x86. On x64 Windows there is only one calling convention, so the mismatch is invisible.",
          "title": "Target x64 instead of x86",
          "confidence": 0.95,
          "effort": "trivial"
        },
        {
          "description": "Downgrade to SkiaSharp 2.88.9 which uses DllImport with CallingConvention.Cdecl exclusively. This avoids the LibraryImport path entirely.",
          "title": "Downgrade to SkiaSharp 2.88.x",
          "confidence": 0.9,
          "effort": "trivial"
        }
      ],
      "recommendedProposal": "Fix code generator to emit Cdecl for LibraryImport",
      "recommendedReason": "This is a straightforward code generator fix. The DllImport path already has the correct pattern. Adding the equivalent attribute for LibraryImport is a small, low-risk change that fixes the platform entirely."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.9,
      "reason": "Root cause identified with high confidence (calling convention mismatch in generated code). Needs a fix in the code generator and regeneration of bindings. Should be verified on x86 .NET 8/9 before shipping."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Labels are already correct \u2014 type/bug, area/SkiaSharp, os/Windows-Classic, tenet/reliability are all accurate",
        "risk": "low",
        "confidence": 0.98,
        "labels": [
          "type/bug",
          "area/SkiaSharp",
          "os/Windows-Classic",
          "tenet/reliability"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post analysis confirming root cause and providing workaround",
        "risk": "high",
        "confidence": 0.9,
        "comment": "Thanks for the detailed stack trace \u2014 that confirmed this.\n\nThe root cause is a calling convention mismatch in the P/Invoke bindings. SkiaSharp 3.x uses \u0060[LibraryImport]\u0060 for .NET 7\u002B, but the generated declarations don\u0027t specify \u0060Cdecl\u0060 calling convention. On x86 Windows, \u0060LibraryImport\u0060 defaults to \u0060StdCall\u0060, while the native C API uses \u0060Cdecl\u0060. This stack corruption manifests as a stack overflow. On x64 there\u0027s only one calling convention, which is why it works there. On .NET Framework, SkiaSharp uses a different code path (\u0060DllImport\u0060) that correctly specifies \u0060Cdecl\u0060.\n\nWorkaround: target x64 instead of x86 if possible \u2014 the calling convention mismatch is invisible on x64.\n\nThe fix is to update the code generator to emit \u0060[UnmanagedCallConv(CallConvs = new[] { typeof(CallConvCdecl) })]\u0060 alongside the \u0060[LibraryImport]\u0060 attribute."
      }
    ]
  }
}