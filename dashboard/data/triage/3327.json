{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3327,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T00:36:37Z",
    "currentLabels": [
      "type/bug"
    ]
  },
  "summary": "SkiaSharp.Views.WinUI.Native.Projection produces IL2026/IL2104 trim warnings due to outdated CsWinRT 2.0.4 dependency, breaking NativeAOT/trimmed WinUI apps",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.92
    },
    "area": {
      "value": "area/SkiaSharp.Views",
      "confidence": 0.9
    },
    "platforms": [
      "os/Windows-WinUI"
    ],
    "tenets": [
      "tenet/compatibility"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a WinUI3 app referencing SkiaSharp.Views.WinUI 3.119.0",
        "Set PublishAot=true in the project file",
        "Build in Release mode",
        "Observe IL2104 warning from SkiaSharp.Views.WinUI.Native.Projection.dll",
        "Optionally set TrimmerSingleWarn=false for detailed IL2026 breakdown"
      ],
      "environmentDetails": "WinUI 3, SkiaSharp 3.119.0, PublishAot=true, Visual Studio (Windows)",
      "relatedIssues": [
        3042,
        3238,
        3433
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "isRegression": false,
      "errorType": "build-warning",
      "errorMessage": "Assembly \u0027SkiaSharp.Views.WinUI.Native.Projection\u0027 produced trim warnings (IL2104); IL2026: WinRT.WinrtModule.GetActivationFactory using RequiresUnreferencedCode member",
      "reproQuality": "complete",
      "targetFrameworks": [
        "net8.0-windows10.0.19041.0"
      ]
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.119.0"
      ],
      "currentRelevance": "likely",
      "relevanceReason": "CsWinRT is still at 2.0.4 on main branch. No changes have been merged to update it."
    },
    "fixStatus": {
      "likelyFixed": false,
      "confidence": 0.85,
      "reason": "PR #3433 proposes updating CsWinRT from 2.0.4 to 2.2.0 which would resolve the trim warnings, but it is still open and not merged. The fix is straightforward but has an open concern about CsWinRTWindowsMetadata side effects.",
      "relatedPRs": [
        3433
      ]
    }
  },
  "analysis": {
    "summary": "The WinUI native projection assembly uses CsWinRT 2.0.4, which contains non-trimming-safe code paths (WinRT.WinrtModule.GetActivationFactory and WinRT.DllModule.GetActivationFactory call RequiresUnreferencedCode members). Updating CsWinRT to \u22652.1.x resolves these warnings. A community PR (#3433) exists to bump to 2.2.0 but is pending review.",
    "codeInvestigation": [
      {
        "file": "native/winui/SkiaSharp.Views.WinUI.Native/SkiaSharp.Views.WinUI.Native.Projection/SkiaSharp.Views.WinUI.Native.Projection.csproj",
        "finding": "PackageReference to Microsoft.Windows.CsWinRT is pinned at Version=\u00222.0.4\u0022. This is the direct cause of the trim warnings.",
        "relevance": "direct",
        "lines": "19"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/SkiaSharp.Views.WinUI.csproj",
        "finding": "The main WinUI views project also sets CsWinRTIncludes=SkiaSharp.Views.WinUI.Native and references CsWinRT 2.0.4. Both projects need the version bump.",
        "relevance": "direct",
        "lines": "15-19"
      },
      {
        "file": "binding/SkiaSharp/Properties/SkiaSharpAssemblyInfo.cs",
        "finding": "Core SkiaSharp assembly already declares IsTrimmable=True, confirming trimming support is intended for the overall library. The WinUI projection is the outlier.",
        "relevance": "context",
        "lines": "55"
      }
    ],
    "rationale": "This is clearly a bug (not a question or feature request): the reporter describes build warnings that indicate SkiaSharp is not safe for trimming/AOT scenarios, and reports crash telemetry that may be related. The root cause is a pinned dependency version (CsWinRT 2.0.4) in the WinUI native projection project. The area is SkiaSharp.Views because the warnings come from the WinUI view layer\u0027s projection assembly, not core SkiaSharp. Severity is medium: the warnings don\u0027t always cause runtime failures, but the reporter sees production crashes that may be attributable to trimming unsafety.",
    "keySignals": [
      {
        "text": "Assembly \u0027SkiaSharp.Views.WinUI.Native.Projection\u0027 produced trim warnings",
        "source": "issue body",
        "interpretation": "The Projection assembly \u2014 generated by CsWinRT \u2014 contains non-trim-safe code. This is a CsWinRT version problem, not a SkiaSharp code problem."
      },
      {
        "text": "IL2026: WinRT.WinrtModule.GetActivationFactory ... RequiresUnreferencedCodeAttribute",
        "source": "issue body (TrimmerSingleWarn=false output)",
        "interpretation": "CsWinRT 2.0.4 uses reflection-based activation that the trimmer cannot prove safe. Newer CsWinRT versions have source generators that eliminate this."
      },
      {
        "text": "This is because SkiaSharp is relying on an outdated version of CsWinRT (specifically, 2.0.4)",
        "source": "comment by dongle-the-gadget",
        "interpretation": "Community confirms root cause. CsWinRT 2.1\u002B added trim/AOT safety."
      },
      {
        "text": "I am seeing a lot of crash reports that might be related to these warnings",
        "source": "issue body",
        "interpretation": "Reporter sees production crashes \u2014 trimming may actually be removing code needed at runtime, not just producing warnings."
      }
    ],
    "workarounds": [
      "No user-side workaround exists because the trim warnings originate from the pre-built SkiaSharp.Views.WinUI.Native.Projection.dll shipped in the NuGet package. Users cannot override the CsWinRT version used to generate that assembly."
    ],
    "nextQuestions": [
      "Does updating CsWinRT to 2.2.0 require CsWinRTWindowsMetadata pinning to avoid the IBufferMethods.IID build error (microsoft/CsWinRT#2214)?",
      "Are the production crashes the reporter mentions actually caused by the trim warnings, or unrelated?",
      "Should the SkiaSharp.Views.WinUI csproj also be updated in the same change?"
    ],
    "resolution": {
      "hypothesis": "CsWinRT 2.0.4 generates WinRT interop code that uses reflection-based activation (RequiresUnreferencedCode). Updating to CsWinRT \u22652.1.x, which uses source generators for trim-safe interop, eliminates the warnings.",
      "proposals": [
        {
          "description": "Community PR #3433 by @wangfys updates CsWinRT from 2.0.4 to 2.2.0 in the Projection csproj and adds CsWinRTWindowsMetadata=10.0.17763.57 to work around a CsWinRT 2.2.0 code-gen issue. This is the correct fix.",
          "title": "Merge PR #3433 (update CsWinRT to 2.2.0)",
          "confidence": 0.8,
          "effort": "small"
        },
        {
          "description": "As a stopgap, users could add \u003CNoWarn\u003EIL2026;IL2104\u003C/NoWarn\u003E to suppress the warnings. This hides the symptom but does not fix potential runtime failures from trimmed code.",
          "title": "Suppress warnings with NoWarn",
          "confidence": 0.6,
          "effort": "trivial"
        }
      ],
      "recommendedProposal": "Merge PR #3433 (update CsWinRT to 2.2.0)",
      "recommendedReason": "Directly addresses the root cause. The PR already exists, has been confirmed as the right approach by a community member, and the CsWinRT maintainers have documented the metadata workaround."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.8,
      "reason": "A community PR (#3433) exists but needs review and CI verification. The CsWinRTWindowsMetadata workaround needs validation for side effects on end-user packages."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Apply bug, views, WinUI, compatibility labels",
        "risk": "low",
        "confidence": 0.95,
        "labels": [
          "type/bug",
          "area/SkiaSharp.Views",
          "os/Windows-WinUI",
          "tenet/compatibility"
        ]
      },
      {
        "type": "link-related",
        "description": "Cross-reference PR #3433 which directly addresses this issue",
        "risk": "low",
        "confidence": 0.95,
        "linkedIssue": 3433
      },
      {
        "type": "add-comment",
        "description": "Acknowledge the report, confirm root cause, point to PR #3433",
        "risk": "high",
        "confidence": 0.85,
        "comment": "Thanks for the detailed warning breakdown. The root cause is confirmed: the WinUI native projection assembly is built with CsWinRT 2.0.4, which predates trimming/AOT safety improvements added in CsWinRT 2.1\u002B.\n\nThere\u0027s no user-side workaround for this since the warnings come from a pre-built assembly in the NuGet package. Suppressing with \u0060\u003CNoWarn\u003EIL2026;IL2104\u003C/NoWarn\u003E\u0060 hides the warnings but doesn\u0027t eliminate the underlying risk for trimmed/AOT apps.\n\nPR #3433 updates CsWinRT to 2.2.0, which should resolve this. We\u0027ll review and validate that PR."
      }
    ]
  }
}