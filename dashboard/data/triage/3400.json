{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3400,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T16:30:00Z",
    "currentLabels": [
      "type/bug",
      "os/Windows-Classic",
      "area/SkiaSharp",
      "backend/PDF",
      "tenet/reliability",
      "backend/Xps"
    ]
  },
  "summary": "SKDocument.CreateXps() renders embedded SVG \u003Cimage\u003E elements at incorrect (smaller) dimensions, while CreatePdf() renders them correctly \u2014 upstream Skia XPS backend bug in SkXPSDevice image handling",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.97
    },
    "area": {
      "value": "area/libSkiaSharp.native",
      "confidence": 0.92
    },
    "platforms": [
      "os/Windows-Classic"
    ],
    "backends": [
      "backend/XPS"
    ],
    "tenets": [
      "tenet/reliability"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Load an SVG containing \u003Cimage\u003E elements with Base64-encoded images using SKSvg.Load()",
        "Generate XPS using SKDocument.CreateXps() with canvas.Scale(72/96) and canvas.DrawPicture()",
        "Generate PDF using SKDocument.CreatePdf() with the same code",
        "Compare: PDF images are correct, XPS images are ~30-40% of expected size"
      ],
      "environmentDetails": "Windows 10/11, .NET 9.0, SkiaSharp 3.119.1 (also reproducible on 3.116.0), Svg.Skia 3.2.1",
      "relatedIssues": [
        1728
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "isRegression": false,
      "errorType": "wrong-output",
      "errorMessage": "Images are significantly smaller (approximately 30-40% of correct size) in XPS output",
      "reproQuality": "complete",
      "targetFrameworks": [
        "net9.0"
      ]
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "3.119.1",
        "3.116.0",
        "2.88.9"
      ],
      "workedIn": "2.88.9",
      "brokeIn": "3.116.0",
      "currentRelevance": "likely",
      "relevanceReason": "The upstream Skia XPS device code (SkXPSDevice::drawImageRect, SkXPSDevice::createXpsImageBrush) has not been fixed. The bug exists in the Skia C\u002B\u002B layer and the code path is unchanged."
    }
  },
  "analysis": {
    "summary": "XPS image scaling bug in the upstream Skia XPS backend. The SkXPSDevice::drawImageRect method converts images to bitmap shaders and draws them via createXpsImageBrush, which sets image brush viewbox/viewport in pixel coordinates. The XPS DPI conversion in endSheet() (96 DPI target vs user-specified DPI) correctly scales vector geometry but image brushes don\u0027t scale proportionally, producing undersized images. This is the same root cause as #1728 (XPS DrawBitmap clipping). A commenter on #1728 identified specific Skia source lines and filed upstream Skia bug https://issues.skia.org/issues/360641492.",
    "codeInvestigation": [
      {
        "file": "binding/SkiaSharp/SKDocument.cs",
        "finding": "CreateXps(SKWStream, float dpi) passes through to sk_document_create_xps_from_stream \u2014 C# wrapper is correct, no transformation or modification of parameters.",
        "relevance": "context",
        "lines": "67-73"
      },
      {
        "file": "externals/skia/src/c/sk_document.cpp",
        "finding": "C API sk_document_create_xps_from_stream calls SkXPS::MakeDocument(AsWStream(stream), dpi) directly \u2014 no bug at C shim layer.",
        "relevance": "context",
        "lines": "30-31"
      },
      {
        "file": "externals/skia/src/xps/SkXPSDocument.cpp",
        "finding": "XPS document constructor computes fUnitsPerMeter (points-based at 72pt/inch) and fPixelsPerMeter (DPI-based). When DPI=72 (default), both equal ~2834.645. These are passed to beginSheet().",
        "relevance": "related",
        "lines": "37-50"
      },
      {
        "file": "externals/skia/src/xps/SkXPSDevice.cpp",
        "finding": "endSheet() applies a scale of 96/fCurrentUnitsPerMeter to convert from geometry units to XPS\u0027s native 96 DPI. This correctly scales vector content but the image brush viewbox/viewport (set in pixel space in createXpsImageBrush) doesn\u0027t account for this transform.",
        "relevance": "direct",
        "lines": "265-298"
      },
      {
        "file": "externals/skia/src/xps/SkXPSDevice.cpp",
        "finding": "drawImageRect converts image to bitmap, creates a bitmap shader with RectToRect matrix, then calls drawRect. The image dimensions in pixel space flow into createXpsImageBrush where bitmapRect uses raw pixel width/height for the XPS viewbox.",
        "relevance": "direct",
        "lines": "1997-2031"
      },
      {
        "file": "externals/skia/src/xps/SkXPSDevice.cpp",
        "finding": "createXpsImageBrush sets XPS_RECT viewbox using bitmap pixel dimensions directly. The localMatrix from the shader maps these to geometry coordinates, but the endSheet DPI transform creates a mismatch for the image brush sizing.",
        "relevance": "direct",
        "lines": "635-822"
      }
    ],
    "rationale": "Classified as type/bug because the same code produces correct output with CreatePdf() but incorrect output with CreateXps() \u2014 this is broken behavior, not user error. Area changed to area/libSkiaSharp.native because the bug is in the Skia C\u002B\u002B XPS backend (SkXPSDevice), not in the C# wrapper. The C# SKDocument.CreateXps() correctly passes parameters through to the C API. Severity is medium: it affects a real use case (label printing via Windows XPS pipeline) but XPS usage is niche and PDF is a viable workaround.",
    "keySignals": [
      {
        "text": "PDF Output: \u2705 Images render correctly; XPS Output: \u274C Images are significantly smaller (approximately 30-40% of correct size)",
        "source": "issue body",
        "interpretation": "Same SKPicture object, different backends \u2014 isolates the bug to the XPS backend specifically."
      },
      {
        "text": "All other SVG elements (text, barcodes, rectangles, shapes) render correctly in both formats",
        "source": "issue body",
        "interpretation": "Vector geometry is scaled correctly by endSheet(); only rasterized image content is affected \u2014 points to SkXPSDevice::drawImageRect/createXpsImageBrush."
      },
      {
        "text": "It turns out that this is a bug in the Google Skia code. It\u0027s even commented",
        "source": "#1728 comment by oatkins",
        "interpretation": "Independently confirmed as upstream Skia bug. Filed as https://issues.skia.org/issues/360641492."
      },
      {
        "text": "Last Known Good Version: 2.88.9",
        "source": "issue body",
        "interpretation": "Reporter claims it worked in 2.88.x, but #1728 reports the same issue on 2.88.8 \u2014 the regression claim may be incorrect or the symptom manifests differently."
      }
    ],
    "workarounds": [
      "Use SKDocument.CreatePdf() instead of CreateXps() \u2014 PDF backend handles images correctly",
      "Convert PDF to XPS using a separate tool (e.g., Windows print-to-XPS from PDF) if XPS output is required for the print pipeline"
    ],
    "nextQuestions": [
      "Has upstream Skia bug https://issues.skia.org/issues/360641492 received any response or fix?",
      "Is the reporter\u0027s claim of working in 2.88.9 accurate, given #1728 reports the same issue on 2.88.8?",
      "Could the DPI parameter to CreateXps() be adjusted to partially compensate for the scaling issue?"
    ],
    "resolution": {
      "hypothesis": "The Skia XPS backend (SkXPSDevice) has a long-standing bug in image rendering where the image brush viewbox/viewport is set in pixel coordinates that don\u0027t correctly account for the DPI scaling applied by endSheet(). This causes images to appear smaller than expected while vector geometry renders correctly.",
      "proposals": [
        {
          "description": "Replace SKDocument.CreateXps() with SKDocument.CreatePdf(). If XPS is required for the Windows print pipeline, generate PDF first and convert to XPS using the Windows print subsystem (e.g., Microsoft Print to XPS from a PDF viewer, or programmatic conversion via Windows.Graphics.Printing).",
          "title": "Use PDF instead of XPS",
          "confidence": 0.95,
          "effort": "small"
        },
        {
          "description": "Fix SkXPSDevice::createXpsImageBrush to account for the DPI conversion that endSheet() applies. The image brush viewbox/viewport dimensions need to be adjusted by the same scale factor (targetUnitsPerMeter / fCurrentUnitsPerMeter) that endSheet uses for geometry. This is an upstream Skia fix.",
          "title": "Fix upstream Skia XPS image scaling",
          "confidence": 0.6,
          "effort": "large"
        },
        {
          "description": "Rasterize the SVG to an SKImage at the target resolution first, then draw the raster image into the XPS document at 1:1 scale (no canvas.Scale). This avoids the image-vs-geometry scaling mismatch.",
          "title": "Pre-scale images before XPS rendering",
          "confidence": 0.55,
          "effort": "medium"
        }
      ],
      "recommendedProposal": "Use PDF instead of XPS",
      "recommendedReason": "PDF backend is proven to render images correctly. XPS-specific output can be obtained by converting from PDF if needed. The XPS image bug is in upstream Skia and a proper fix requires changes to Skia\u0027s XPS device code."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "Confirmed upstream Skia XPS bug. Root cause is identified but fix requires upstream Skia changes. Related to open issue #1728 and upstream Skia bug report."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Update area to libSkiaSharp.native (bug is in Skia C\u002B\u002B XPS backend), remove backend/PDF (PDF works correctly, it\u0027s not the bug area)",
        "risk": "low",
        "confidence": 0.9,
        "labels": [
          "type/bug",
          "area/libSkiaSharp.native",
          "os/Windows-Classic",
          "backend/XPS",
          "tenet/reliability"
        ]
      },
      {
        "type": "link-related",
        "description": "Cross-reference #1728 \u2014 same root cause (XPS image rendering bug in SkXPSDevice)",
        "risk": "low",
        "confidence": 0.92,
        "linkedIssue": 1728
      },
      {
        "type": "add-comment",
        "description": "Post analysis linking to #1728 and upstream Skia bug, suggest PDF workaround",
        "risk": "high",
        "confidence": 0.85,
        "comment": "Thanks for the detailed reproduction steps.\n\nThis is a known bug in the upstream Skia XPS backend \u2014 the same root cause as #1728. The issue is in \u0060SkXPSDevice::createXpsImageBrush\u0060 where image brush dimensions aren\u0027t correctly adjusted for the DPI scaling that the XPS output applies to geometry. Vector content (text, shapes, paths) scales correctly through \u0060endSheet()\u0060, but rasterized image content does not.\n\nThis has been reported upstream to Google Skia as https://issues.skia.org/issues/360641492.\n\nHere\u0027s a workaround you can use while we investigate: use \u0060SKDocument.CreatePdf()\u0060 instead of \u0060CreateXps()\u0060. If you specifically need XPS output for the Windows print pipeline, you can generate PDF first and convert to XPS using the system\u0027s Microsoft Print to XPS printer driver, or use \u0060System.Drawing.Printing\u0060 / \u0060Windows.Graphics.Printing\u0060 APIs to print the PDF through the XPS spool path.\n\nWe\u0027ll track the upstream Skia fix and apply it when available."
      }
    ]
  }
}