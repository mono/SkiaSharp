{
  "meta": {
    "schemaVersion": "1.0",
    "number": 730,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-12T23:50:00Z",
    "currentLabels": [
      "type/bug",
      "os/Windows-Universal-UWP",
      "area/SkiaSharp.Views",
      "area/SkiaSharp.Views.Forms",
      "backend/OpenGL"
    ]
  },
  "summary": "SKGLView crashes with \u0027Failed to create EGL surface\u0027 when RotateYTo is applied to parent view in Xamarin Forms UWP",
  "classification": {
    "type": {
      "value": "type/bug",
      "confidence": 0.95
    },
    "area": {
      "value": "area/SkiaSharp.Views",
      "confidence": 0.92
    },
    "platforms": [
      "os/Windows-Universal-UWP"
    ],
    "backends": [
      "backend/OpenGL"
    ]
  },
  "evidence": {
    "reproEvidence": {
      "stepsToReproduce": [
        "Create a Xamarin Forms UWP app with a Grid containing an SKGLView",
        "Call ViewExtensions.RotateYTo on the Grid from 180 to 0 with 300ms duration",
        "Repeat several times \u2014 usually crashes on first try"
      ],
      "environmentDetails": "SkiaSharp 1.68.0-preview28, VS2017, UWP",
      "relatedIssues": [
        1573,
        1155,
        1377
      ]
    },
    "bugSignals": {
      "severity": "medium",
      "errorType": "crash",
      "errorMessage": "System.Exception: Failed to create EGL surface",
      "stackTrace": "System.Exception: Failed to create EGL surface\n   at SkiaSharp.Views.GlesInterop.GlesContext.CreateSurface(SwapChainPanel panel, Nullable\u00601 renderSurfaceSize, Nullable\u00601 resolutionScale)\n   at SkiaSharp.Views.UWP.AngleSwapChainPanel.EnsureRenderSurface()\n   at SkiaSharp.Views.UWP.AngleSwapChainPanel.OnCompositionChanged(SwapChainPanel sender, Object args)",
      "reproQuality": "partial",
      "targetFrameworks": [
        "uap10.0"
      ]
    },
    "versionAnalysis": {
      "mentionedVersions": [
        "1.68.0-preview28"
      ],
      "currentRelevance": "unlikely",
      "relevanceReason": "PR #1642 (merged 2021-03-30) addressed the root cause by making the EGL display static/shared with initialize-once semantics and adding composition scale change deduplication. Additionally, UWP and Xamarin.Forms are now deprecated platforms."
    },
    "fixStatus": {
      "likelyFixed": true,
      "confidence": 0.8,
      "reason": "PR #1642 by gmurray81 addressed the EGL display lifecycle issue. The static eglDisplay with initialize-once pattern prevents termination of the shared display when one panel is destroyed. The composition scale deduplication in OnCompositionChanged prevents unnecessary surface recreation. SKSwapChainPanel.OnDestroyingContext now uses AbandonContext(false) instead of true. However, the PR author noted the fix was partial \u2014 the GRContext cleanup was deliberately weakened.",
      "relatedPRs": [
        1642
      ]
    }
  },
  "analysis": {
    "summary": "EGL surface creation fails when a 3D CSS-like transform (RotateYTo) is applied to the parent view of an SKGLView in UWP. The CompositionScaleChanged event fires during the rotation, triggering EnsureRenderSurface(), which fails because the EGL display state is corrupted by interleaved panel lifecycle operations.",
    "codeInvestigation": [
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/GlesInterop/GlesContext.cs",
        "finding": "eglDisplay is now static (shared across all instances) with initialize-once guard in InitializeDisplay(). CreateSurface throws on line 110 when eglCreateWindowSurface fails. No eglTerminate call exists \u2014 display is never destroyed once initialized. This was the fix from PR #1642.",
        "relevance": "direct",
        "lines": "29, 107-113, 155-157"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/AngleSwapChainPanel.cs",
        "finding": "OnCompositionChanged now deduplicates by checking lastCompositionScaleX/Y before destroying and recreating the surface (PR #1642 fix). EnsureRenderSurface creates the surface only when glesContext.HasSurface is false and the panel has positive dimensions.",
        "relevance": "direct",
        "lines": "163-181, 191-205"
      },
      {
        "file": "source/SkiaSharp.Views/SkiaSharp.Views.WinUI/SKSwapChainPanel.cs",
        "finding": "OnDestroyingContext now calls AbandonContext(false) instead of AbandonContext(true) \u2014 prevents premature destruction of shared GL resources. This was changed in PR #1642.",
        "relevance": "direct",
        "lines": "100-123"
      }
    ],
    "rationale": "This is clearly a bug \u2014 the reporter describes a crash with a stack trace during a legitimate UI operation (3D rotation on a parent view). Classified as area/SkiaSharp.Views because the crash is in the ANGLE/EGL surface management layer (GlesContext and AngleSwapChainPanel), not in core SkiaSharp or Xamarin.Forms itself. Severity is medium because there\u0027s a workaround (use SKCanvasView instead of SKGLView) and a partial fix was merged. The OpenGL backend label is appropriate since this is specific to the ANGLE-based GL rendering path on UWP.",
    "keySignals": [
      {
        "text": "System.Exception: Failed to create EGL surface",
        "source": "issue body",
        "interpretation": "eglCreateWindowSurface returned EGL_NO_SURFACE \u2014 ANGLE\u0027s D3D11 backend failed to create the surface, likely due to the SwapChainPanel being in an invalid state during the 3D transform."
      },
      {
        "text": "CompositionScaleChanged fires during RotateYTo",
        "source": "stack trace",
        "interpretation": "The 3D rotation triggers XAML composition scale changes, which cause the panel to destroy and recreate the EGL surface mid-animation."
      },
      {
        "text": "gmurray81 opened #1573 for the same root cause (navigation between pages)",
        "source": "comment 2",
        "interpretation": "Same underlying issue \u2014 interleaved EGL display lifecycle when multiple SKSwapChainPanels exist or when panel is destroyed/recreated."
      },
      {
        "text": "PR #1642 merged with static eglDisplay, composition scale dedup, AbandonContext(false)",
        "source": "PR #1642",
        "interpretation": "Partial fix applied: prevents eglTerminate race and unnecessary surface recreation. PR author noted it was not complete \u2014 GRContext cleanup was weakened."
      }
    ],
    "workarounds": [
      "Use SKCanvasView (CPU rendering) instead of SKGLView to avoid the ANGLE/EGL surface management entirely",
      "Upgrade to SkiaSharp 2.80\u002B which includes PR #1642\u0027s fixes for the EGL display lifecycle"
    ],
    "nextQuestions": [
      "Is the GRContext cleanup in OnDestroyingContext still too aggressive even after the AbandonContext(false) change?",
      "Does WinUI 3 (the successor to UWP XAML) exhibit the same issue with SwapChainPanel composition changes?"
    ],
    "resolution": {
      "hypothesis": "The 3D rotation (RotateYTo) triggers XAML CompositionScaleChanged events, which cause the ANGLE swap chain panel to destroy and recreate the EGL surface. When the EGL display was instance-scoped, interleaved lifecycle operations (or mid-animation state) corrupted the display, causing surface creation to fail.",
      "proposals": [
        {
          "description": "Upgrade to SkiaSharp 2.80 or later which includes PR #1642\u0027s fixes: static shared EGL display, composition scale deduplication, and safer GRContext cleanup.",
          "title": "Upgrade to 2.80\u002B",
          "confidence": 0.8,
          "effort": "small"
        },
        {
          "description": "Replace SKGLView with SKCanvasView to use CPU rendering instead of the ANGLE-based GL path. This avoids the EGL surface management entirely at the cost of GPU acceleration.",
          "title": "Use SKCanvasView instead",
          "confidence": 0.9,
          "effort": "small"
        }
      ],
      "recommendedProposal": "Upgrade to 2.80\u002B",
      "recommendedReason": "PR #1642\u0027s fixes directly address the root cause. Upgrading is the lowest-effort solution and retains GPU acceleration."
    }
  },
  "output": {
    "actionability": {
      "suggestedAction": "close-as-fixed",
      "confidence": 0.75,
      "reason": "PR #1642 (merged 2021-03-30) addressed the core EGL display lifecycle issue. The fix is in all releases since 2.80. UWP and Xamarin.Forms are also now deprecated platforms. Issue has had no activity since 2021."
    },
    "actions": [
      {
        "type": "update-labels",
        "description": "Keep existing labels, remove duplicate area label (should have single area)",
        "risk": "low",
        "confidence": 0.9,
        "labels": [
          "type/bug",
          "area/SkiaSharp.Views",
          "os/Windows-Universal-UWP",
          "backend/OpenGL"
        ]
      },
      {
        "type": "add-comment",
        "description": "Post analysis explaining the fix in PR #1642 and suggest closing",
        "risk": "high",
        "confidence": 0.75,
        "comment": "Thanks for reporting this. The root cause was in the EGL display lifecycle management in \u0060AngleSwapChainPanel\u0060 / \u0060GlesContext\u0060 \u2014 the 3D rotation triggered \u0060CompositionScaleChanged\u0060 events that caused surface recreation to fail due to interleaved panel lifecycle operations.\n\nThis was addressed in PR #1642 (merged into 2.80), which:\n- Made the EGL display static and shared across all panel instances (initialize-once)\n- Added composition scale deduplication to prevent unnecessary surface recreation\n- Changed \u0060GRContext.AbandonContext(true)\u0060 to \u0060AbandonContext(false)\u0060 to avoid destroying shared GL resources\n\nUpgrading to SkiaSharp 2.80 or later should resolve this. If you\u0027re still experiencing issues on a newer version, please open a new issue with updated details.\n\nNote: UWP and Xamarin.Forms are now deprecated \u2014 the equivalent in modern SkiaSharp is \u0060SKSwapChainPanel\u0060 in SkiaSharp.Views.WinUI with .NET MAUI."
      },
      {
        "type": "link-related",
        "description": "Cross-reference #1573 (same root cause, navigation scenario)",
        "risk": "low",
        "confidence": 0.9,
        "linkedIssue": 1573
      },
      {
        "type": "close-issue",
        "description": "Close as fixed by PR #1642 in SkiaSharp 2.80\u002B",
        "risk": "medium",
        "confidence": 0.75
      }
    ]
  }
}