{
  "meta": {
    "schemaVersion": "1.0",
    "number": 2997,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T16:00:00Z"
  },
  "conclusion": "reproduced",
  "notes": "Reproduced on SkiaSharp 2.88.3, 3.119.2, and main (source). SKMatrix.MapRect always normalizes the output rectangle (sorts left\u2264right, top\u2264bottom) because upstream Skia\u0027s SkMatrix::mapRect calls sort_as_rect(). This is upstream Skia behavior, not a SkiaSharp wrapper issue. The workaround is to use SKMatrix.MapPoint on individual corners to preserve coordinate ordering.",
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project and add SkiaSharp 2.88.3",
      "layer": "setup",
      "command": "mkdir -p /tmp/repro-2997 \u0026\u0026 cd /tmp/repro-2997 \u0026\u0026 dotnet new console -n Repro --framework net8.0 \u0026\u0026 cd Repro \u0026\u0026 dotnet add package SkiaSharp --version 2.88.3",
      "exitCode": 0,
      "output": "The template \u0022Console App\u0022 was created successfully.\nPackageReference for package \u0027SkiaSharp\u0027 version \u00272.88.3\u0027 added.",
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Write reproduction code using reporter\u0027s exact scenario: SKRect with inverted coordinates (Left\u003ERight, Top\u003EBottom) mapped through identity matrix",
      "layer": "csharp",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Reproduction code that creates an SKRect with inverted coordinates and maps it through an identity matrix, checking if coordinates are preserved",
          "content": "using SkiaSharp;\n\nConsole.WriteLine($\u0022SkiaSharp version: {typeof(SKMatrix).Assembly.GetName().Version}\u0022);\nConsole.WriteLine($\u0022Runtime: {System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription}\u0022);\nConsole.WriteLine($\u0022OS: {System.Runtime.InteropServices.RuntimeInformation.OSDescription}\u0022);\nConsole.WriteLine($\u0022Arch: {System.Runtime.InteropServices.RuntimeInformation.ProcessArchitecture}\u0022);\n\nvar inputRect = new SKRect();\ninputRect.Left = 25;\ninputRect.Right = 15;\ninputRect.Bottom = 2;\ninputRect.Top = 10;\n\nConsole.WriteLine($\u0022\\nInput rect: Left={inputRect.Left}, Top={inputRect.Top}, Right={inputRect.Right}, Bottom={inputRect.Bottom}\u0022);\n\nvar matrix = SKMatrix.CreateIdentity();\nvar resultRect = matrix.MapRect(inputRect);\n\nConsole.WriteLine($\u0022Result rect: Left={resultRect.Left}, Top={resultRect.Top}, Right={resultRect.Right}, Bottom={resultRect.Bottom}\u0022);\n\nbool leftMatch = inputRect.Left == resultRect.Left;\nbool rightMatch = inputRect.Right == resultRect.Right;\nbool topMatch = inputRect.Top == resultRect.Top;\nbool bottomMatch = inputRect.Bottom == resultRect.Bottom;\n\nConsole.WriteLine($\u0022\\nLeft preserved: {leftMatch} (input={inputRect.Left}, result={resultRect.Left})\u0022);\nConsole.WriteLine($\u0022Right preserved: {rightMatch} (input={inputRect.Right}, result={resultRect.Right})\u0022);\nConsole.WriteLine($\u0022Top preserved: {topMatch} (input={inputRect.Top}, result={resultRect.Top})\u0022);\nConsole.WriteLine($\u0022Bottom preserved: {bottomMatch} (input={inputRect.Bottom}, result={resultRect.Bottom})\u0022);\n\nif (leftMatch \u0026\u0026 rightMatch \u0026\u0026 topMatch \u0026\u0026 bottomMatch)\n    Console.WriteLine(\u0022\\nPASS: MapRect preserved coordinate ordering through identity matrix\u0022);\nelse\n{\n    Console.WriteLine(\u0022\\nFAIL: MapRect normalized/sorted the rectangle coordinates\u0022);\n    Console.WriteLine(\u0022BUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\u0022);\n}\n\nvar topLeft = matrix.MapPoint(inputRect.Left, inputRect.Top);\nvar bottomRight = matrix.MapPoint(inputRect.Right, inputRect.Bottom);\nConsole.WriteLine($\u0022\\nMapPoint workaround: Left={topLeft.X}, Top={topLeft.Y}, Right={bottomRight.X}, Bottom={bottomRight.Y}\u0022);\n\nConsole.WriteLine(\u0022\\nSUCCESS: test completed\u0022);"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Build and run with SkiaSharp 2.88.3 \u2014 verify MapRect normalizes inverted rect",
      "layer": "csharp",
      "command": "cd /tmp/repro-2997/Repro \u0026\u0026 dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 2.88.0.0\nRuntime: .NET 8.0.23\nOS: Darwin 25.2.0\nArch: Arm64\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nLeft preserved: False (input=25, result=15)\nRight preserved: False (input=15, result=25)\nTop preserved: False (input=10, result=2)\nBottom preserved: False (input=2, result=10)\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\nBUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\n\nMapPoint workaround: Left=25, Top=10, Right=15, Bottom=2\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 4,
      "description": "Test with latest stable SkiaSharp 3.119.2 in fresh project directory",
      "layer": "csharp",
      "command": "cd /tmp/repro-2997-latest/Repro \u0026\u0026 dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nRuntime: .NET 8.0.23\nArch: Arm64\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\nBUG REPRODUCED: Identity matrix should preserve coordinates, but MapRect sorted them\n\nMapPoint workaround: Left=25, Top=10, Right=15, Bottom=2\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 5,
      "description": "Test on main branch source using console sample with project reference",
      "layer": "csharp",
      "command": "dotnet run --project samples/Basic/Console/SkiaSharpSample/SkiaSharpSample.csproj",
      "exitCode": 0,
      "output": "SkiaSharp version: 3.119.0.0\nRuntime: .NET 8.0.23\n\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\n\nFAIL: MapRect normalized/sorted the rectangle coordinates\n\nSUCCESS: test completed",
      "result": "wrong-output"
    },
    {
      "stepNumber": 6,
      "description": "Cross-platform verification: Docker Linux x64 with SkiaSharp 2.88.3",
      "layer": "csharp",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:8.0 bash -c \u0027...\u0027",
      "exitCode": 0,
      "output": "SkiaSharp version: 2.88.0.0\nRuntime: .NET 8.0.24\nArch: X64\nInput rect: Left=25, Top=10, Right=15, Bottom=2\nResult rect: Left=15, Top=2, Right=25, Bottom=10\nFAIL: MapRect normalized/sorted the rectangle coordinates\nSUCCESS: test completed",
      "result": "wrong-output"
    }
  ],
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.23",
    "skiaSharpVersion": "2.88.3",
    "dockerUsed": true,
    "dotnetSdkVersion": "10.0.102"
  },
  "inputs": {
    "triageFile": "ai-triage/2997.json"
  },
  "assessment": "working-as-designed",
  "scope": "universal",
  "reproductionTime": "~15 minutes",
  "versionResults": [
    {
      "version": "2.88.3",
      "source": "nuget",
      "result": "reproduced",
      "notes": "MapRect normalizes inverted rect through identity matrix. Left/Right and Top/Bottom swapped in output.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Same normalization behavior on latest stable release.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "reproduced",
      "notes": "Same behavior on main branch source build.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "2.88.3",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Same normalization behavior confirmed on Docker Linux x64.",
      "platform": "docker-linux-x64"
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "2.88.3"
      }
    ]
  },
  "errorMessages": {
    "primaryError": "SKMatrix.MapRect normalizes (sorts) output rectangle coordinates: input Left=25,Top=10,Right=15,Bottom=2 becomes output Left=15,Top=2,Right=25,Bottom=10 even through identity matrix"
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "classification",
        "upstream": "type/bug with confidence 0.35 \u2014 triage was uncertain if this is a real bug",
        "corrected": "Behavior confirmed as reproduced. It is upstream Skia behavior (working-as-designed), but the reported behavior factually occurs."
      }
    ]
  },
  "output": {
    "proposedResponse": {
      "status": "needs-human-edit",
      "body": "Thanks for the detailed report and repro code!\n\nWe\u0027ve confirmed the behavior \u2014 \u0060SKMatrix.MapRect\u0060 normalizes (sorts) the output rectangle so that \u0060Left \u2264 Right\u0060 and \u0060Top \u2264 Bottom\u0060, even through an identity matrix. This was reproduced on:\n\n| Version | Platform | Result |\n|---------|----------|--------|\n| 2.88.3 | macOS arm64 | \u274C Normalized |\n| 3.119.2 | macOS arm64 | \u274C Normalized |\n| main (source) | macOS arm64 | \u274C Normalized |\n| 2.88.3 | Docker Linux x64 | \u274C Normalized |\n\nThis is upstream Skia behavior \u2014 \u0060SkMatrix::mapRect\u0060 intentionally calls \u0060sort_as_rect()\u0060 to normalize the output rectangle. The SkiaSharp C API and C# wrapper are thin pass-throughs with no additional normalization.\n\n**Workaround:** Transform the corners individually using \u0060MapPoint\u0060 to preserve coordinate ordering:\n\n\u0060\u0060\u0060csharp\nvar topLeft = matrix.MapPoint(inputRect.Left, inputRect.Top);\nvar bottomRight = matrix.MapPoint(inputRect.Right, inputRect.Bottom);\nvar resultRect = new SKRect(topLeft.X, topLeft.Y, bottomRight.X, bottomRight.Y);\n\u0060\u0060\u0060\n\nThis avoids the \u0060sort_as_rect\u0060 normalization step and preserves your original coordinate ordering.\n\nRegarding the regression from 2.88.2 \u2192 2.88.3: we weren\u0027t able to identify any changes to \u0060SKMatrix.MapRect\u0060 or \u0060sk_matrix_map_rect\u0060 between those versions. The normalization behavior appears to have been present in Skia for many years. It\u0027s possible the difference was in a different code path in your application.",
      "summary": "Reproduced \u2014 upstream Skia behavior with MapPoint workaround"
    },
    "actionability": {
      "suggestedAction": "close-with-docs",
      "confidence": 0.85,
      "reason": "Reproduced on all tested versions including main. This is upstream Skia behavior \u2014 SkMatrix::mapRect intentionally calls sort_as_rect() to normalize output. A MapPoint workaround exists. The reporter\u0027s regression claim (2.88.2\u21922.88.3) is likely inaccurate \u2014 this behavior has been in Skia for years."
    },
    "workarounds": [
      "Use SKMatrix.MapPoint to transform the rect corners individually, then construct a new SKRect preserving the original coordinate ordering: var tl = matrix.MapPoint(rect.Left, rect.Top); var br = matrix.MapPoint(rect.Right, rect.Bottom); var result = new SKRect(tl.X, tl.Y, br.X, br.Y);"
    ],
    "actions": [
      {
        "type": "update-labels",
        "description": "Add area label for SkiaSharp core",
        "risk": "low",
        "confidence": 0.95,
        "labels": [
          "type/bug",
          "area/SkiaSharp"
        ]
      }
    ]
  }
}