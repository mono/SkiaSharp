{
  "meta": {
    "schemaVersion": "1.0",
    "number": 754,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T15:55:00Z"
  },
  "conclusion": "reproduced",
  "notes": "Confirmed: SKBitmap.Decode(codec, imageInfo) returns null when the source PNG is not natively Gray8 (e.g., indexed-color/colormap or RGBA) and the requested SKImageInfo specifies SKColorType.Gray8. Both Premul and Opaque alpha types fail \u2014 the issue is that Skia\u0027s codec does not support the RGBA\u2192Gray8 color type conversion, not an AlphaType mismatch as the triage hypothesized. True Gray8 source PNGs decode fine with Gray8 target. Bug reproduced on SkiaSharp 3.119.2 (latest stable), main branch source, and Docker Linux x64. This is a universal bug across all platforms and versions since 1.68.0.",
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project with SkiaSharp 3.119.2 and download reporter\u0027s 8-bit colormap PNG test image.",
      "layer": "setup",
      "command": "mkdir -p /tmp/repro-754-latest \u0026\u0026 cd /tmp/repro-754-latest \u0026\u0026 dotnet new console -n Repro --framework net8.0 \u0026\u0026 cd Repro \u0026\u0026 dotnet add package SkiaSharp --version 3.119.2 \u0026\u0026 curl -sL -o ../gray8test.png \u0027https://user-images.githubusercontent.com/5593825/51076794-aecf2b80-169d-11e9-9b9b-1c01eeb20467.png\u0027",
      "exitCode": 0,
      "output": "The template \u0022Console App\u0022 was created successfully.\nPackageReference for package \u0027SkiaSharp\u0027 version \u00273.119.2\u0027 added.\nRestored Repro.csproj.",
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Write reproduction code matching reporter\u0027s pattern: create SKCodec from PNG, create SKImageInfo with Gray8, call SKBitmap.Decode. Also test with explicit Opaque alpha, true Gray8 source, and default decode.",
      "layer": "csharp",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Console app reproducing issue #754. Tests Gray8 decode with reporter\u0027s indexed-color PNG (both Premul and Opaque alpha), a synthetic true Gray8 PNG, and default decode.",
          "content": "using System;\nusing System.IO;\nusing SkiaSharp;\n\nConsole.WriteLine($\u0022SkiaSharp Version: {typeof(SKBitmap).Assembly.GetName().Version}\u0022);\nConsole.WriteLine($\u0022Runtime: {System.Runtime.InteropServices.RuntimeInformation.FrameworkDescription}\u0022);\nConsole.WriteLine();\n\nvar imagePath = Path.Combine(AppContext.BaseDirectory, \u0022..\u0022, \u0022..\u0022, \u0022..\u0022, \u0022..\u0022, \u0022gray8test.png\u0022);\nbool bugReproduced = false;\n\nif (File.Exists(imagePath))\n{\n    Console.WriteLine(\u0022=== Test A: Reporter\u0027s 8-bit colormap PNG ===\u0022);\n    var bytes = File.ReadAllBytes(imagePath);\n\n    using var stream = new MemoryStream(bytes);\n    using var codec = SKCodec.Create(stream);\n    Console.WriteLine($\u0022Codec info: {codec.Info.Width}x{codec.Info.Height}, ColorType={codec.Info.ColorType}, AlphaType={codec.Info.AlphaType}\u0022);\n\n    // A1: 3-param constructor (Premul default)\n    var info1 = new SKImageInfo(codec.Info.Width, codec.Info.Height, SKColorType.Gray8);\n    Console.WriteLine($\u0022\\n  A1: Gray8 \u002B Premul (default): AlphaType={info1.AlphaType}\u0022);\n    using var bmp1 = SKBitmap.Decode(codec, info1);\n    Console.WriteLine($\u0022      Result: {(bmp1 == null ? \u0022NULL\u0022 : $\u0022OK, BPP={bmp1.BytesPerPixel}\u0022)}\u0022);\n    if (bmp1 == null) bugReproduced = true;\n\n    // A2: 4-param constructor (Opaque)\n    stream.Position = 0;\n    using var codec2 = SKCodec.Create(stream);\n    var info2 = new SKImageInfo(codec2.Info.Width, codec2.Info.Height, SKColorType.Gray8, SKAlphaType.Opaque);\n    Console.WriteLine($\u0022\\n  A2: Gray8 \u002B Opaque: AlphaType={info2.AlphaType}\u0022);\n    using var bmp2 = SKBitmap.Decode(codec2, info2);\n    Console.WriteLine($\u0022      Result: {(bmp2 == null ? \u0022NULL\u0022 : $\u0022OK, BPP={bmp2.BytesPerPixel}\u0022)}\u0022);\n}\n\n// Test B: True Gray8 source\nConsole.WriteLine(\u0022\\n=== Test B: Programmatic grayscale PNG ===\u0022);\nvar grayInfo = new SKImageInfo(100, 100, SKColorType.Gray8, SKAlphaType.Opaque);\nusing var grayBmp = new SKBitmap(grayInfo);\nusing var canvas = new SKCanvas(grayBmp);\ncanvas.Clear(SKColors.Gray);\nusing var img = SKImage.FromBitmap(grayBmp);\nusing var encoded = img.Encode(SKEncodedImageFormat.Png, 100);\nusing var decodeStream = new MemoryStream(encoded.ToArray());\nusing var decodeCodec = SKCodec.Create(decodeStream);\nConsole.WriteLine($\u0022Codec info: ColorType={decodeCodec.Info.ColorType}\u0022);\nvar bInfo = new SKImageInfo(100, 100, SKColorType.Gray8);\nusing var bBmp = SKBitmap.Decode(decodeCodec, bInfo);\nConsole.WriteLine($\u0022  Result: {(bBmp == null ? \u0022NULL\u0022 : $\u0022OK, BPP={bBmp.BytesPerPixel}\u0022)}\u0022);\n\nConsole.WriteLine($\u0022\\nBUG REPRODUCED: {bugReproduced}\u0022);\nreturn bugReproduced ? 1 : 0;"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Build the project.",
      "layer": "csharp",
      "command": "cd /tmp/repro-754-latest/Repro \u0026\u0026 dotnet build",
      "exitCode": 0,
      "output": "Build succeeded. 0 Warning(s) 0 Error(s)",
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Run the reproduction. Reporter\u0027s 8-bit colormap PNG decoded as Gray8 returns null (both Premul and Opaque). True Gray8 PNG works fine.",
      "layer": "csharp",
      "command": "cd /tmp/repro-754-latest/Repro \u0026\u0026 dotnet run --no-build",
      "exitCode": 1,
      "output": "SkiaSharp Version: 3.119.0.0\nRuntime: .NET 8.0.23\n\n=== Test A: Reporter\u0027s 8-bit colormap PNG ===\nImage file size: 375023 bytes\nCodec info: 960x960, ColorType=Rgba8888, AlphaType=Opaque\n\n  A1: Gray8 \u002B Premul (default): AlphaType=Premul\n      Result: NULL\n\n  A2: Gray8 \u002B Opaque: AlphaType=Opaque\n      Result: NULL\n\n=== Test B: Programmatic grayscale PNG ===\nCreated gray PNG: 133 bytes\nCodec info: 100x100, ColorType=Gray8, AlphaType=Opaque\n\n  B1: Gray8 \u002B Premul (default): AlphaType=Premul\n      Result: OK, BPP=1\n\n  B2: Gray8 \u002B Opaque: AlphaType=Opaque\n      Result: OK, BPP=1\n\n=== Test C: SKBitmap.Decode from bytes (no codec) ===\n  Direct decode: OK, ColorType=Rgba8888, BPP=4\n\nBUG REPRODUCED: True",
      "result": "failure"
    },
    {
      "stepNumber": 5,
      "description": "Test on main branch source by modifying the console sample project. Same behavior \u2014 RGBA source cannot be decoded as Gray8.",
      "layer": "csharp",
      "command": "dotnet run --project samples/Basic/Console/SkiaSharpSample/SkiaSharpSample.csproj --no-build",
      "exitCode": 0,
      "output": "SkiaSharp Version: 3.119.0.0\nRuntime: .NET 8.0.23\n\nTest 1: Decode RGBA-\u003EGray8 \u002B Premul: AlphaType=Premul\n  Result: NULL (BUG)\n\nTest 2: Decode RGBA-\u003EGray8 \u002B Opaque: AlphaType=Opaque\n  Result: NULL (BUG)\n\nTest 3: True Gray8 PNG, Codec info: ColorType=Gray8\n  Result: OK, BPP=1\n\nBUG REPRODUCED: True",
      "result": "wrong-output"
    },
    {
      "stepNumber": 6,
      "description": "Cross-platform verification: Docker Linux x64 with SkiaSharp 3.119.2. Same bug \u2014 codec returns null for RGBA\u2192Gray8 conversion.",
      "layer": "csharp",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:8.0 bash -c \u0027...\u0027",
      "exitCode": 1,
      "output": "SkiaSharp Version: 3.119.0.0\nRuntime: .NET 8.0.24\nOS: Debian GNU/Linux 12 (bookworm)\nArch: X64\n\nCreated RGBA PNG: 304 bytes\nCodec info: 100x100, ColorType=Bgra8888, AlphaType=Opaque\n\nTest 1: Decode RGBA-\u003EGray8 \u002B Premul: AlphaType=Premul\n  Result: NULL (BUG)\n\nTest 2: Decode RGBA-\u003EGray8 \u002B Opaque: AlphaType=Opaque\n  Result: NULL (BUG)\n\nTest 3: True Gray8 PNG, Codec: ColorType=Gray8\n  Result: OK, BPP=1\n\nBUG REPRODUCED: True",
      "result": "failure"
    }
  ],
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "8.0.23",
    "skiaSharpVersion": "3.119.2",
    "dockerUsed": true,
    "dotnetSdkVersion": "10.0.102"
  },
  "inputs": {
    "triageFile": "ai-triage/754.json"
  },
  "assessment": "likely-bug",
  "scope": "universal",
  "reproductionTime": "~15 minutes",
  "versionResults": [
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Latest stable. Decode returns null for non-Gray8 source decoded as Gray8. Both Premul and Opaque fail.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "main (source)",
      "source": "source",
      "result": "reproduced",
      "notes": "Main branch. Same behavior \u2014 codec cannot convert RGBA to Gray8.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Docker Linux x64 cross-platform verification. Same behavior.",
      "platform": "docker-linux-x64"
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net8.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.119.2"
      }
    ]
  },
  "artifacts": [
    {
      "filename": "gray8test.png",
      "description": "Reporter\u0027s 8-bit colormap PNG (960x960, indexed color). Skia codec sees as Rgba8888/Opaque.",
      "source": "issue-attachment",
      "available": true,
      "url": "https://user-images.githubusercontent.com/5593825/51076794-aecf2b80-169d-11e9-9b9b-1c01eeb20467.png"
    }
  ],
  "errorMessages": {
    "primaryError": "SKBitmap.Decode(codec, imageInfo) returns null when requesting SKColorType.Gray8 for a non-Gray8 source image (indexed-color or RGBA). Skia\u0027s codec cannot perform the RGBA\u2192Gray8 color type conversion.",
    "additionalErrors": [
      "Both SKAlphaType.Premul (default) and SKAlphaType.Opaque produce the same null result",
      "True Gray8 source PNGs decode successfully \u2014 the issue is limited to cross-color-type conversion"
    ]
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "root-cause",
        "upstream": "Triage concluded: SKImageInfo 3-param constructor defaults AlphaType to Premul, which is invalid for Gray8. Workaround: use 4-param constructor with Opaque.",
        "corrected": "AlphaType is NOT the root cause. Both Premul and Opaque fail for non-Gray8 source images. The real issue is that Skia\u0027s codec does not support RGBA\u2192Gray8 color type conversion during decode. The triage workaround (use Opaque alpha) does not fix the problem. True Gray8 source PNGs decode fine even with Premul alpha."
      }
    ]
  },
  "output": {
    "proposedResponse": {
      "status": "ready",
      "body": "Thanks for reporting this \u2014 we\u0027ve confirmed the issue is still present in the latest version (3.119.2) and on the main branch.\n\n**Root cause:** When the source PNG is not natively Gray8 (e.g., indexed-color/colormap or RGBA), Skia\u0027s codec cannot perform the color type conversion to Gray8 during decode. This causes \u0060SKBitmap.Decode(codec, imageInfo)\u0060 to return \u0060null\u0060.\n\nNotably, this is **not** just an AlphaType issue \u2014 both \u0060SKAlphaType.Premul\u0060 and \u0060SKAlphaType.Opaque\u0060 produce the same \u0060null\u0060 result. However, true Gray8 source PNGs decode correctly.\n\n**Tested versions:**\n| Version | Platform | Result |\n|---------|----------|--------|\n| 3.119.2 | macOS arm64 | \u274C Reproduced |\n| 3.119.2 | Linux x64 (Docker) | \u274C Reproduced |\n| main (source) | macOS arm64 | \u274C Reproduced |\n\n**Workaround:** Decode the image with the default color type, then convert to grayscale manually:\n\n\u0060\u0060\u0060csharp\nusing var stream = new MemoryStream(bytes);\nusing var codec = SKCodec.Create(stream);\n// Decode with default color type (RGBA)\nusing var bitmap = SKBitmap.Decode(codec);\nif (bitmap == null) return;\n\n// Convert to Gray8 manually\nvar grayInfo = new SKImageInfo(bitmap.Width, bitmap.Height, SKColorType.Gray8, SKAlphaType.Opaque);\nusing var grayBitmap = new SKBitmap(grayInfo);\nusing var canvas = new SKCanvas(grayBitmap);\ncanvas.DrawBitmap(bitmap, 0, 0);\n// grayBitmap now has BytesPerPixel == 1\n\u0060\u0060\u0060\n\nThe proper fix would be for \u0060SKBitmap.Decode\u0060 to handle this conversion internally when the codec doesn\u0027t support it natively.",
      "summary": "Bug confirmed: SKBitmap.Decode returns null when converting non-Gray8 source to Gray8"
    },
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.92,
      "reason": "Bug reproduced on all versions (3.119.2, main) and all platforms (macOS arm64, Linux x64). Skia\u0027s codec does not support cross-color-type conversion to Gray8. SkiaSharp should either handle this conversion in managed code (decode to RGBA then convert), or document the limitation clearly."
    },
    "workarounds": [
      "Decode the image normally (without specifying Gray8), then manually convert to Gray8: decode with default color type, then create a new Gray8 bitmap and copy/convert pixel data",
      "Ensure source images are saved as true grayscale PNGs (not indexed-color/colormap) before decoding with Gray8"
    ],
    "actions": [
      {
        "type": "update-labels",
        "description": "Add area label for SkiaSharp core",
        "risk": "low",
        "confidence": 0.95,
        "labels": [
          "type/bug",
          "area/SkiaSharp"
        ]
      },
      {
        "type": "link-related",
        "description": "Cross-reference related Gray8 decode issue",
        "risk": "low",
        "confidence": 0.85,
        "linkedIssue": 2787
      },
      {
        "type": "link-related",
        "description": "Cross-reference original Gray8/Index8 removal discussion",
        "risk": "low",
        "confidence": 0.8,
        "linkedIssue": 694
      }
    ]
  }
}