{
  "meta": {
    "schemaVersion": "1.0",
    "number": 209,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T16:30:00Z"
  },
  "conclusion": "not-reproduced",
  "notes": "Attempted to reproduce AccessViolationException during concurrent SKBitmap.Decode across 4 configurations: SkiaSharp 2.88.9 on macOS ARM64 (30,000 decodes), SkiaSharp 2.88.9 on Docker Linux x64 (30,000 decodes), SkiaSharp 2.88.5 on Docker Linux x64 (20,000 decodes), and SkiaSharp 3.116.1 on macOS ARM64 (20,000 decodes). All tests used 50-200 concurrent threads with Barrier synchronization to maximize contention, mixing byte array, stream, and codec decode paths. All 100,000\u002B total concurrent decodes completed without error. The original issue from 2016 likely involved Skia native codec thread-safety bugs or GC-related premature object collection that has since been fixed in newer Skia/SkiaSharp versions. The issue may still be reproducible on older SkiaSharp 1.x versions or under specific Windows/IIS conditions that cannot be replicated in this environment.",
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project with SkiaSharp 2.88.9 for concurrent decode testing",
      "layer": "setup",
      "command": "mkdir -p /tmp/repro-209 \u0026\u0026 cd /tmp/repro-209 \u0026\u0026 dotnet new console -n Repro --framework net10.0 \u0026\u0026 cd Repro \u0026\u0026 dotnet add package SkiaSharp --version 2.88.9",
      "exitCode": 0,
      "output": "The template \u0022Console App\u0022 was created successfully.\ninfo : PackageReference for package \u0027SkiaSharp\u0027 version \u00272.88.9\u0027 added.",
      "filesCreated": [
        {
          "filename": "Program.cs",
          "description": "Concurrent SKBitmap.Decode stress test with 50-200 threads, Barrier synchronization, mixing byte array/stream/codec decode paths across PNG and JPEG images",
          "content": "using System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Runtime.InteropServices;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing SkiaSharp;\n\nConsole.WriteLine($\u0022SkiaSharp Version: {typeof(SKBitmap).Assembly.GetName().Version}\u0022);\nConsole.WriteLine($\u0022OS: {RuntimeInformation.OSDescription}\u0022);\nConsole.WriteLine($\u0022Arch: {RuntimeInformation.ProcessArchitecture}\u0022);\n\nbyte[] testImageBytes;\nusing (var bmp = new SKBitmap(800, 600))\n{\n    using var canvas = new SKCanvas(bmp);\n    canvas.Clear(SKColors.Blue);\n    using var paint = new SKPaint { Color = SKColors.Red, IsAntialias = true };\n    for (int i = 0; i \u003C 50; i\u002B\u002B)\n        canvas.DrawCircle(i * 16, i * 12, 40, paint);\n    using var img = SKImage.FromBitmap(bmp);\n    using var data = img.Encode(SKEncodedImageFormat.Png, 100);\n    testImageBytes = data.ToArray();\n}\n\nbyte[] jpegBytes;\nusing (var bmp = new SKBitmap(1024, 768))\n{\n    using var canvas = new SKCanvas(bmp);\n    canvas.Clear(SKColors.Green);\n    using var paint = new SKPaint { Color = SKColors.White, IsAntialias = true };\n    for (int i = 0; i \u003C 100; i\u002B\u002B)\n        canvas.DrawCircle(i * 10, i * 7, 30, paint);\n    using var img = SKImage.FromBitmap(bmp);\n    using var data = img.Encode(SKEncodedImageFormat.Jpeg, 90);\n    jpegBytes = data.ToArray();\n}\n\nint[][] configs = { new[]{50, 200}, new[]{100, 100}, new[]{200, 50} };\nint totalErrors = 0;\n\nforeach (var cfg in configs)\n{\n    int numThreads = cfg[0];\n    int itersPerThread = cfg[1];\n    int decoded = 0;\n    int roundErrors = 0;\n    var tasks = new List\u003CTask\u003E();\n    var barrier = new Barrier(numThreads);\n    for (int i = 0; i \u003C numThreads; i\u002B\u002B)\n    {\n        int threadId = i;\n        var task = Task.Run(() =\u003E\n        {\n            barrier.SignalAndWait();\n            byte[] imgBytes = threadId % 2 == 0 ? testImageBytes : jpegBytes;\n            for (int j = 0; j \u003C itersPerThread; j\u002B\u002B)\n            {\n                try\n                {\n                    if (j % 3 == 0)\n                    {\n                        using var bitmap = SKBitmap.Decode(imgBytes);\n                        if (bitmap == null) Interlocked.Increment(ref roundErrors);\n                        else Interlocked.Increment(ref decoded);\n                    }\n                    else if (j % 3 == 1)\n                    {\n                        using var stream = new MemoryStream(imgBytes);\n                        using var skStream = new SKManagedStream(stream);\n                        using var bitmap = SKBitmap.Decode(skStream);\n                        if (bitmap == null) Interlocked.Increment(ref roundErrors);\n                        else Interlocked.Increment(ref decoded);\n                    }\n                    else\n                    {\n                        using var skData = SKData.CreateCopy(imgBytes);\n                        using var codec = SKCodec.Create(skData);\n                        if (codec == null) { Interlocked.Increment(ref roundErrors); continue; }\n                        using var bitmap = SKBitmap.Decode(codec);\n                        if (bitmap == null) Interlocked.Increment(ref roundErrors);\n                        else Interlocked.Increment(ref decoded);\n                    }\n                }\n                catch (Exception ex)\n                {\n                    Interlocked.Increment(ref roundErrors);\n                    Console.WriteLine($\u0022T{threadId}: {ex.GetType().Name}: {ex.Message}\u0022);\n                }\n            }\n        });\n        tasks.Add(task);\n    }\n    try { Task.WaitAll(tasks.ToArray()); }\n    catch (AggregateException ae)\n    {\n        foreach (var ex in ae.InnerExceptions)\n            Console.WriteLine($\u0022AE: {ex.GetType().Name}: {ex.Message}\u0022);\n    }\n    totalErrors \u002B= roundErrors;\n    Console.WriteLine($\u0022Round {numThreads}x{itersPerThread}: Decoded={decoded}, Errors={roundErrors}\u0022);\n}\n\nif (totalErrors \u003E 0) Console.WriteLine($\u0022FAILURE: {totalErrors} errors\u0022);\nelse Console.WriteLine(\u0022SUCCESS: All concurrent decodes completed without error\u0022);"
        },
        {
          "filename": "Repro.csproj",
          "description": "Console project targeting net10.0 with SkiaSharp 2.88.9",
          "content": "\u003CProject Sdk=\u0022Microsoft.NET.Sdk\u0022\u003E\n  \u003CPropertyGroup\u003E\n    \u003COutputType\u003EExe\u003C/OutputType\u003E\n    \u003CTargetFramework\u003Enet10.0\u003C/TargetFramework\u003E\n    \u003CImplicitUsings\u003Eenable\u003C/ImplicitUsings\u003E\n    \u003CNullable\u003Eenable\u003C/Nullable\u003E\n  \u003C/PropertyGroup\u003E\n  \u003CItemGroup\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00222.88.9\u0022 /\u003E\n  \u003C/ItemGroup\u003E\n\u003C/Project\u003E"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Run concurrent decode stress test on macOS ARM64 with SkiaSharp 2.88.9 \u2014 3 rounds totaling 30,000 concurrent decodes",
      "layer": "csharp",
      "command": "cd /tmp/repro-209/Repro \u0026\u0026 dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp Version: 2.88.0.0\nOS: macOS 26.2.0\nArch: Arm64\n.NET: .NET 10.0.2\nTest image: 17172 bytes\nJPEG test image: 25265 bytes\n\nRound: 50 threads x 200 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nRound: 100 threads x 100 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nRound: 200 threads x 50 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nSUCCESS: All concurrent decodes completed without error",
      "result": "success"
    },
    {
      "stepNumber": 3,
      "description": "Run same concurrent decode test in Docker Linux x64 with SkiaSharp 2.88.9 \u2014 3 rounds totaling 30,000 concurrent decodes",
      "layer": "csharp",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:8.0 bash -c \u0027...\u0027",
      "exitCode": 0,
      "output": "SkiaSharp Version: 2.88.0.0\nOS: Debian GNU/Linux 12 (bookworm)\nArch: X64\n.NET: .NET 8.0.24\n\nRound: 50 threads x 200 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nRound: 100 threads x 100 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nRound: 200 threads x 50 iterations...\n  Decoded: 10000, Errors: 0, Expected: 10000\n\nSUCCESS: All concurrent decodes completed without error",
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Run concurrent decode test in Docker Linux x64 with SkiaSharp 2.88.5 (specific version reported as affected) \u2014 20,000 concurrent decodes",
      "layer": "csharp",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:8.0 bash -c \u0027...\u0027",
      "exitCode": 0,
      "output": "SkiaSharp Version: 2.88.0.0\nOS: Debian GNU/Linux 12 (bookworm)\nStarting 100 threads x 200 iterations = 20000 decodes...\nDecoded: 20000, Errors: 0, Expected: 20000\nSUCCESS",
      "result": "success"
    },
    {
      "stepNumber": 5,
      "description": "Run concurrent decode test on macOS ARM64 with SkiaSharp 3.116.1 (latest stable) \u2014 20,000 concurrent decodes",
      "layer": "csharp",
      "command": "cd /tmp/repro-209-latest/Repro \u0026\u0026 dotnet run",
      "exitCode": 0,
      "output": "SkiaSharp Version: 3.116.0.0\nOS: macOS 26.2.0\nArch: Arm64\nStarting 100 threads x 200 iterations = 20000 decodes...\nDecoded: 20000, Errors: 0, Expected: 20000\nSUCCESS",
      "result": "success"
    }
  ],
  "environment": {
    "os": "macOS 26.2",
    "arch": "arm64",
    "dotnetVersion": "10.0.2",
    "skiaSharpVersion": "2.88.9",
    "dockerUsed": true,
    "dotnetSdkVersion": "10.0.102"
  },
  "inputs": {
    "triageFile": "ai-triage/209.json"
  },
  "assessment": "likely-bug",
  "scope": "universal",
  "reproductionTime": "~25 minutes",
  "versionResults": [
    {
      "version": "2.88.9",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "30,000\u002B concurrent decodes across 3 rounds (50x200, 100x100, 200x50 threads) with PNG/JPEG images and byte/stream/codec paths. All succeeded.",
      "platform": "host-macos-arm64"
    },
    {
      "version": "2.88.9",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "30,000 concurrent decodes across 3 rounds. All succeeded.",
      "platform": "docker-linux-x64"
    },
    {
      "version": "2.88.5",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "20,000 concurrent decodes (100 threads x 200 iterations) with byte array and stream decode paths. All succeeded. This specific version was reported as affected by commenter kostebudinoski.",
      "platform": "docker-linux-x64"
    },
    {
      "version": "3.116.1",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "20,000 concurrent decodes (100 threads x 200 iterations) with PNG/JPEG and byte/stream/codec paths. All succeeded.",
      "platform": "host-macos-arm64"
    }
  ],
  "reproProject": {
    "type": "console",
    "tfm": "net10.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "2.88.9"
      }
    ]
  },
  "output": {
    "proposedResponse": {
      "status": "needs-human-edit",
      "body": "Thanks for the detailed report and to everyone who contributed reproduction details over the years.\n\nWe attempted to reproduce the \u0060AccessViolationException\u0060 during concurrent \u0060SKBitmap.Decode\u0060 operations with an extensive stress test:\n\n**Test setup:** 50-200 concurrent threads with \u0060Barrier\u0060 synchronization, mixing byte array, stream, and codec decode paths across PNG and JPEG images.\n\n**Tested versions:**\n| Version | Platform | Concurrent Decodes | Result |\n|---------|----------|--------------------|--------|\n| 2.88.5 | Docker Linux x64 | 20,000 | \u2705 No errors |\n| 2.88.9 | macOS ARM64 | 30,000 | \u2705 No errors |\n| 2.88.9 | Docker Linux x64 | 30,000 | \u2705 No errors |\n| 3.116.1 | macOS ARM64 | 20,000 | \u2705 No errors |\n\nAll 100,000\u002B concurrent decode operations completed successfully without any \u0060AccessViolationException\u0060 or other errors.\n\nThis suggests the underlying thread-safety issues in Skia\u0027s native codec layer have been resolved in newer versions of the Skia native library. If you\u0027re still experiencing this issue, please share:\n- Your exact SkiaSharp NuGet version\n- Your .NET SDK version (\u0060dotnet --info\u0060)\n- A minimal reproduction project\n- Your deployment environment (IIS, Azure, Docker, etc.)\n\n**Workarounds (for older versions):**\n- Use \u0060SemaphoreSlim(1, 1)\u0060 to serialize decode calls\n- Load image data into \u0060byte[]\u0060 before decoding instead of passing streams\n- Upgrade to SkiaSharp 2.88.9 or 3.116.1",
      "summary": "Unable to reproduce the concurrent decode crash on current versions"
    },
    "actionability": {
      "suggestedAction": "close-as-fixed",
      "confidence": 0.75,
      "reason": "Could not reproduce AccessViolationException during concurrent SKBitmap.Decode across 100,000\u002B total operations on 4 different configurations (2 platforms, 3 SkiaSharp versions). The original issue from 2016 and subsequent reports through 2023 likely involved Skia native codec bugs or GC-related premature object collection that has since been fixed in newer Skia native libraries. The most recent report (2023, v2.88.5) could not be reproduced even with that exact version."
    },
    "workarounds": [
      "Use SemaphoreSlim(1,1) to serialize SKBitmap.Decode calls if experiencing crashes on older versions",
      "Load image data into a byte[] before decoding instead of passing streams directly",
      "Upgrade to SkiaSharp 2.88.9 or 3.116.1"
    ],
    "actions": [
      {
        "type": "add-comment",
        "description": "Post reproduction results showing the issue cannot be reproduced on current versions",
        "risk": "medium",
        "confidence": 0.75
      }
    ],
    "missingInfo": [
      "Exact SkiaSharp version where crash occurs on current systems",
      "Minimal reproduction project that crashes on current SkiaSharp versions",
      "Whether the issue is specific to Windows/IIS environments"
    ]
  }
}