{
  "meta": {
    "schemaVersion": "1.0",
    "number": 3386,
    "repo": "mono/SkiaSharp",
    "analyzedAt": "2026-02-13T16:20:00Z"
  },
  "conclusion": "reproduced",
  "notes": "Reproduced the DllNotFoundException with libfontconfig.so.1 error. Root cause: when both SkiaSharp.NativeAssets.Linux and SkiaSharp.NativeAssets.Linux.NoDependencies are referenced (directly or transitively), both packages deploy to the same runtimes/linux-x64/native/libSkiaSharp.so path. NuGet/MSBuild conflict resolution picks the standard (fontconfig-dependent) binary over the NoDependencies variant. MD5 verification confirmed the deployed binary matches the standard package, not NoDependencies. When only NoDependencies is referenced, the correct binary is deployed and works without fontconfig. The reporter\u0027s .NET Aspire deployment likely pulls in NativeAssets.Linux transitively, triggering the conflict. Issue persists on latest 3.119.2. Phase 3C skipped \u2014 this is a NuGet packaging conflict, not a runtime code bug; building from source doesn\u0027t test package binary resolution.",
  "reproductionSteps": [
    {
      "stepNumber": 1,
      "description": "Create console project with SkiaSharp \u002B NoDependencies ONLY (no NativeAssets.Linux) and run in Docker without fontconfig \u2014 baseline test",
      "layer": "setup",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:9.0 bash -c \u0027dotnet new console -n Repro --framework net9.0 \u0026\u0026 cd Repro \u0026\u0026 dotnet add package SkiaSharp --version 3.116.0 \u0026\u0026 dotnet add package SkiaSharp.NativeAssets.Linux.NoDependencies --version 3.116.0 \u0026\u0026 dotnet publish -c Release -o /tmp/pub \u0026\u0026 cd /tmp/pub \u0026\u0026 dotnet Repro.dll\u0027",
      "exitCode": 0,
      "output": "Arch: X64\nOS: Debian GNU/Linux 12 (bookworm)\nBitmap: 100x100\nSUCCESS: NoDependencies-only publish works",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Console project with SkiaSharp \u002B NoDependencies only",
          "content": "\u003CProject Sdk=\u0022Microsoft.NET.Sdk\u0022\u003E\n  \u003CPropertyGroup\u003E\n    \u003COutputType\u003EExe\u003C/OutputType\u003E\n    \u003CTargetFramework\u003Enet9.0\u003C/TargetFramework\u003E\n  \u003C/PropertyGroup\u003E\n  \u003CItemGroup\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.116.0\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.116.0\u0022 /\u003E\n  \u003C/ItemGroup\u003E\n\u003C/Project\u003E"
        },
        {
          "filename": "Program.cs",
          "description": "Minimal SkiaSharp usage to test native loading",
          "content": "using System;\nusing System.Runtime.InteropServices;\nusing SkiaSharp;\n\nConsole.WriteLine($\u0022Arch: {RuntimeInformation.ProcessArchitecture}\u0022);\nConsole.WriteLine($\u0022OS: {RuntimeInformation.OSDescription}\u0022);\n\ntry\n{\n    using var bitmap = new SKBitmap(100, 100);\n    using var canvas = new SKCanvas(bitmap);\n    canvas.Clear(SKColors.Red);\n    Console.WriteLine($\u0022Bitmap: {bitmap.Width}x{bitmap.Height}\u0022);\n    Console.WriteLine(\u0022SUCCESS: SkiaSharp loaded and drew successfully\u0022);\n}\ncatch (Exception ex)\n{\n    Console.Error.WriteLine($\u0022FAILED: {ex.GetType().Name}: {ex.Message}\u0022);\n    if (ex.InnerException != null)\n        Console.Error.WriteLine($\u0022Inner: {ex.InnerException.GetType().Name}: {ex.InnerException.Message}\u0022);\n    Environment.Exit(1);\n}"
        }
      ],
      "result": "success"
    },
    {
      "stepNumber": 2,
      "description": "Create console project with BOTH NativeAssets.Linux AND NoDependencies (simulating transitive conflict), publish, and run in Docker without fontconfig",
      "layer": "deployment",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:9.0 bash -c \u0027dotnet new console -n Repro --framework net9.0 \u0026\u0026 cd Repro \u0026\u0026 dotnet add package SkiaSharp --version 3.116.0 \u0026\u0026 dotnet add package SkiaSharp.NativeAssets.Linux --version 3.116.0 \u0026\u0026 dotnet add package SkiaSharp.NativeAssets.Linux.NoDependencies --version 3.116.0 \u0026\u0026 dotnet publish -c Release -o /tmp/pub \u0026\u0026 cd /tmp/pub \u0026\u0026 dotnet Repro.dll\u0027",
      "exitCode": 1,
      "output": "FAILED: TypeInitializationException: The type initializer for \u0027SkiaSharp.SKImageInfo\u0027 threw an exception.\nInner: DllNotFoundException: Unable to load shared library \u0027libSkiaSharp\u0027 or one of its dependencies. In order to help diagnose loading problems, consider using a tool like strace. If you\u0027re using glibc, consider setting the LD_DEBUG environment variable: \nlibfontconfig.so.1: cannot open shared object file: No such file or directory\n/usr/share/dotnet/shared/Microsoft.NETCore.App/9.0.12/libSkiaSharp.so: cannot open shared object file: No such file or directory\n/tmp/pub2/libSkiaSharp.so: cannot open shared object file: No such file or directory",
      "filesCreated": [
        {
          "filename": "Repro.csproj",
          "description": "Console project with BOTH NativeAssets.Linux and NoDependencies (conflict scenario)",
          "content": "\u003CProject Sdk=\u0022Microsoft.NET.Sdk\u0022\u003E\n  \u003CPropertyGroup\u003E\n    \u003COutputType\u003EExe\u003C/OutputType\u003E\n    \u003CTargetFramework\u003Enet9.0\u003C/TargetFramework\u003E\n  \u003C/PropertyGroup\u003E\n  \u003CItemGroup\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp\u0022 Version=\u00223.116.0\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux\u0022 Version=\u00223.116.0\u0022 /\u003E\n    \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux.NoDependencies\u0022 Version=\u00223.116.0\u0022 /\u003E\n  \u003C/ItemGroup\u003E\n\u003C/Project\u003E"
        }
      ],
      "result": "failure"
    },
    {
      "stepNumber": 3,
      "description": "Verify which binary was deployed by comparing MD5 hashes of deployed vs package binaries",
      "layer": "deployment",
      "command": "md5sum comparison of deployed libSkiaSharp.so vs NuGet cache copies",
      "exitCode": 0,
      "output": "Deployed:       683aadb006ab0e899c38437e8c91a2db (matches Standard)\nNoDependencies: cfa254a44a2674ad456704264f6a422f\nStandard:       683aadb006ab0e899c38437e8c91a2db\nRESULT: Standard (fontconfig-dependent) binary WINS\n\nFile sizes:\n  NoDependencies: 8,956,592 bytes (no fontconfig dep)\n  Standard:       8,977,424 bytes (depends on fontconfig)\n\nldd output: libfontconfig.so.1 =\u003E not found",
      "result": "success"
    },
    {
      "stepNumber": 4,
      "description": "Phase 3B: Test same conflict scenario with latest SkiaSharp 3.119.2",
      "layer": "deployment",
      "command": "docker run --rm --platform linux/amd64 mcr.microsoft.com/dotnet/sdk:9.0 bash -c \u0027... dotnet add package SkiaSharp --version 3.119.2 \u0026\u0026 dotnet add package SkiaSharp.NativeAssets.Linux --version 3.119.2 \u0026\u0026 dotnet add package SkiaSharp.NativeAssets.Linux.NoDependencies --version 3.119.2 \u0026\u0026 dotnet publish -c Release -o /tmp/pub \u0026\u0026 cd /tmp/pub \u0026\u0026 dotnet Repro.dll\u0027",
      "exitCode": 1,
      "output": "FAILED: TypeInitializationException: The type initializer for \u0027SkiaSharp.SKImageInfo\u0027 threw an exception.\nInner: DllNotFoundException: Unable to load shared library \u0027libSkiaSharp\u0027 or one of its dependencies.\nlibfontconfig.so.1: cannot open shared object file: No such file or directory\n\nMD5 verification: Standard binary wins over NoDependencies on 3.119.2 as well.",
      "result": "failure"
    },
    {
      "stepNumber": 5,
      "description": "Verify no transitive NativeAssets.Linux from SkiaSharp alone \u2014 confirm the conflict requires external package or Aspire to bring it in",
      "layer": "deployment",
      "command": "dotnet list package --include-transitive (with SkiaSharp \u002B NoDependencies only)",
      "exitCode": 0,
      "output": "Top-level:\n  SkiaSharp 3.116.0\n  SkiaSharp.NativeAssets.Linux.NoDependencies 3.116.0\nTransitive:\n  SkiaSharp.NativeAssets.macOS 3.116.0\n  SkiaSharp.NativeAssets.Win32 3.116.0\n\nNo transitive NativeAssets.Linux \u2014 conflict must come from another source (Aspire or another package).",
      "result": "success"
    }
  ],
  "environment": {
    "os": "Linux (Docker, Debian 12 bookworm)",
    "arch": "x64",
    "dotnetVersion": "9.0.12",
    "skiaSharpVersion": "3.116.0",
    "dockerUsed": true,
    "dotnetSdkVersion": "9.0.310"
  },
  "inputs": {
    "triageFile": "ai-triage/3386.json"
  },
  "assessment": "likely-bug",
  "scope": "platform-specific/linux",
  "reproductionTime": "~20 minutes",
  "versionResults": [
    {
      "version": "3.116.0",
      "source": "nuget",
      "result": "not-reproduced",
      "notes": "NoDependencies-only: works without fontconfig. Correct binary deployed.",
      "platform": "docker-linux-x64"
    },
    {
      "version": "3.116.0",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Both NativeAssets.Linux \u002B NoDependencies: standard binary wins, fails without fontconfig. MD5 confirmed wrong binary deployed.",
      "platform": "docker-linux-x64"
    },
    {
      "version": "3.119.2",
      "source": "nuget",
      "result": "reproduced",
      "notes": "Same conflict on latest version. Standard binary still wins over NoDependencies.",
      "platform": "docker-linux-x64"
    }
  ],
  "reproProject": {
    "type": "docker",
    "tfm": "net9.0",
    "packages": [
      {
        "name": "SkiaSharp",
        "version": "3.116.0"
      },
      {
        "name": "SkiaSharp.NativeAssets.Linux",
        "version": "3.116.0"
      },
      {
        "name": "SkiaSharp.NativeAssets.Linux.NoDependencies",
        "version": "3.116.0"
      }
    ]
  },
  "errorMessages": {
    "primaryError": "DllNotFoundException: Unable to load shared library \u0027libSkiaSharp\u0027 or one of its dependencies. libfontconfig.so.1: cannot open shared object file: No such file or directory",
    "stackTrace": "System.TypeInitializationException: The type initializer for \u0027SkiaSharp.SKImageInfo\u0027 threw an exception.\n ---\u003E System.DllNotFoundException: Unable to load shared library \u0027libSkiaSharp\u0027 or one of its dependencies.\nlibfontconfig.so.1: cannot open shared object file: No such file or directory",
    "additionalErrors": [
      "When both NativeAssets.Linux and NoDependencies are referenced, NuGet deploys the standard (fontconfig-dependent) binary at runtimes/linux-x64/native/libSkiaSharp.so, overwriting the NoDependencies variant"
    ]
  },
  "feedback": {
    "triageCorrections": [
      {
        "topic": "classification",
        "upstream": "Triage classified as isRegression: false",
        "corrected": "Confirmed not a regression \u2014 this is a NuGet binary conflict resolution issue when both NativeAssets.Linux and NoDependencies target the same runtimes/ path."
      }
    ]
  },
  "output": {
    "proposedResponse": {
      "status": "needs-human-edit",
      "body": "Thanks for the detailed report and workaround!\n\nWe\u0027ve confirmed the underlying issue. When both \u0060SkiaSharp.NativeAssets.Linux\u0060 and \u0060SkiaSharp.NativeAssets.Linux.NoDependencies\u0060 are present in the dependency graph (even transitively), both packages deploy to the same \u0060runtimes/linux-x64/native/libSkiaSharp.so\u0060 path. NuGet/MSBuild conflict resolution picks the standard (fontconfig-dependent) binary over the NoDependencies variant.\n\n**Evidence:**\n- MD5 hash of the deployed binary matches the standard \u0060NativeAssets.Linux\u0060 package, NOT the \u0060NoDependencies\u0060 package\n- \u0060ldd\u0060 confirms the deployed binary requires \u0060libfontconfig.so.1\u0060\n- When only \u0060NoDependencies\u0060 is referenced (no \u0060NativeAssets.Linux\u0060), the correct binary IS deployed and works without fontconfig\n\n**Tested versions:**\n\n| Version | NoDependencies Only | Both Packages |\n|---------|-------------------|---------------|\n| 3.116.0 | \u2705 Works | \u274C Wrong binary deployed |\n| 3.119.2 | \u2705 Works | \u274C Wrong binary deployed |\n\nThe .NET Aspire deployment likely introduces \u0060NativeAssets.Linux\u0060 as a transitive dependency, triggering this conflict.\n\n**Workarounds:**\n1. Switch to \u0060SkiaSharp.NativeAssets.Linux\u0060 \u002B install fontconfig in the container (\u0060apt-get install -y libfontconfig1\u0060)\n2. Use a custom base image: \u0060ghcr.io/avantipoint/aspnet-skia:9.0\u0060\n3. Exclude the conflicting package: \u0060\u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux\u0022 ExcludeAssets=\u0022all\u0022 /\u003E\u0060",
      "summary": "Reproduced: NuGet binary conflict when both NativeAssets.Linux and NoDependencies are referenced"
    },
    "actionability": {
      "suggestedAction": "needs-investigation",
      "confidence": 0.85,
      "reason": "Reproduced on both 3.116.0 and 3.119.2 (latest). The binary conflict when both NativeAssets.Linux and NoDependencies are referenced is a packaging issue in SkiaSharp \u2014 both packages deploy to the same runtimes/linux-x64/native/ path and MSBuild picks the standard binary. While the reporter\u0027s direct references don\u0027t cause a conflict, .NET Aspire or transitive dependencies may introduce NativeAssets.Linux. SkiaSharp should investigate making the packages mutually exclusive or ensuring NoDependencies wins in conflict."
    },
    "workarounds": [
      "Use SkiaSharp.NativeAssets.Linux (not NoDependencies) and install fontconfig in the container: apt-get install -y libfontconfig1",
      "Use a custom base image with native deps pre-installed: ghcr.io/avantipoint/aspnet-skia:9.0",
      "Exclude NativeAssets.Linux if it\u0027s a transitive dependency: \u003CPackageReference Include=\u0022SkiaSharp.NativeAssets.Linux\u0022 ExcludeAssets=\u0022all\u0022 /\u003E"
    ],
    "actions": [
      {
        "type": "update-labels",
        "description": "Labels are already correct \u2014 type/bug, os/Linux, area/libSkiaSharp.native, tenet/compatibility",
        "risk": "low",
        "confidence": 0.95,
        "labels": [
          "type/bug",
          "os/Linux",
          "area/libSkiaSharp.native",
          "tenet/compatibility"
        ]
      },
      {
        "type": "link-related",
        "description": "Cross-reference similar container/binary deployment issue #2438",
        "risk": "low",
        "confidence": 0.75,
        "linkedIssue": 2438
      }
    ]
  }
}