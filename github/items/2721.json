{
  "number": 2721,
  "type": "issue",
  "state": "open",
  "title": "ArgumentException: \u0022Cannot pass a GCHandle across AppDomains\u0022 while running ASP.NET MVC application in the IIS Server.",
  "body": "### Description\r\n\r\nWe are using the SkiaSharp library to generate an image using SKData in an ASP.NET MVC application. When running the MVC application as multiple sites(Use same folder for all the sites) in the local IIS Server under one application pool (using the same pool name for all the site), we encounter an ArgumentException while browsing in IIS.\r\n\r\n**Note:** Initially build the MVC application locally in Visual studio, then run in local IIS server.  This exception \u0022**Cannot pass a GCHandle across AppDomains\u0022 occurs randomly** while browsing it in the IIS server.\r\n\r\n\r\n**Reproduction sample Link**\r\nDownload the [MVCSample.zip](https://github.com/mono/SkiaSharp/files/13989281/MVCSample.zip) to replicate the problem.\r\n\r\n\r\n**Reference link for how to setup or install IIS server locally.** \r\nhttps://learn.microsoft.com/en-us/aspnet/web-forms/overview/deployment/visual-studio-web-deployment/deploying-to-iis#install-iis \r\n\r\n**Reference link for how to add the ASP .NET MVC application as website on the IIS server by using the UI. Then create more sites like this with single MVC application.**\r\nhttps://learn.microsoft.com/en-us/iis/application-frameworks/scenario-build-an-aspnet-website-on-iis/configuring-step-1-install-iis-and-asp-net-modules#to-add-an-aspnet-application-by-using-the-ui\r\n\r\n### Code\r\n\r\n\r\n\u0060\u0060\u0060cs\r\npublic ActionResult CreateImage()\r\n{\r\n    //Open the file as Stream\r\n    FileStream imageData = new FileStream(Server.MapPath(\u0022~/App_Data/AdventureCycle.png\u0022), FileMode.Open, FileAccess.Read);\r\n    MemoryStream outputStream = new MemoryStream();\r\n    using (SKData skImgData = SKData.Create(imageData))\r\n    {\r\n        skImgData.SaveTo(outputStream);\r\n    }\r\n    outputStream.Position = 0;\r\n    imageData.Close();\r\n    //Download Image file in the browser.\r\n    return File(outputStream, \u0022image/png\u0022, \u0022Output_Image.png\u0022);\r\n}\r\n\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Expected Behavior\r\n\r\nSkiaSharp should create images properly without any errors when running an MVC application in multiple sites under one application pool in local IIS.\r\n\r\n### Actual Behavior\r\n\r\nThe following error we were faced randomly in the IIS server.\r\n**Exception Details:** System.ArgumentException: Cannot pass a GCHandle across AppDomains.\r\n\u0060\u0060\u0060cs\r\nStack Trace:\r\n[ArgumentException: Cannot pass a GCHandle across AppDomains.\r\nParameter name: handle]\r\n   SkiaSharp.SKAbstractManagedStream.DisposeNative() in D:\\a\\1\\s\\binding\\Binding\\SKAbstractManagedStream.cs:52\r\n   SkiaSharp.SKNativeObject.Dispose(Boolean disposing) in D:\\a\\1\\s\\binding\\Binding\\SKObject.cs:287\r\n   SkiaSharp.SKManagedStream.Dispose(Boolean disposing) in D:\\a\\1\\s\\binding\\Binding\\SKManagedStream.cs:53\r\n   SkiaSharp.SKNativeObject.Dispose() in D:\\a\\1\\s\\binding\\Binding\\SKObject.cs:298\r\n   SkiaSharp.SKData.Create(Stream stream, Int64 length) in D:\\a\\1\\s\\binding\\Binding\\SKData.cs:141\r\n   MVCSample.Controllers.HomeController.CreateImage() in D:\\SkiaSharpSample\\MVCSample\\MVCSample\\Controllers\\HomeController.cs:30\r\n\u0060\u0060\u0060\r\n\r\n### Version of SkiaSharp\r\n\r\n2.88.3 (Current)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\n2.88.2 (Previous)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nWindows\r\n\r\n### Platform / Operating System Version\r\n\r\n_No response_\r\n\r\n### Devices\r\n\r\n**Basic Information:**\r\n\u2022\t**SkiaSharp** Version with issue: 2.88.7\r\n\u2022\t**IDE:** Visual Studio Professional 2022 Preview 17.9.0 Preview 1.0\r\n\u2022\t**Platform:** Windows (Windows 11 Enterprise) version: 23H2\r\n\u2022\t**Target Frameworks:** ASP .NET MVC Application of .NET Framework 4.8\r\n\r\n### Relevant Screenshots\r\n\r\n\u003Cimg width=\u0022521\u0022 alt=\u0022image\u0022 src=\u0022https://github.com/mono/SkiaSharp/assets/92841936/b2dd677b-ae5d-42f0-923e-dd8babdddbf0\u0022\u003E\r\n\r\n\r\n### Relevant Log Output\r\n\r\n\u0060\u0060\u0060shell\r\n[ArgumentException: Cannot pass a GCHandle across AppDomains.\r\nParameter name: handle]\r\n   SkiaSharp.SKAbstractManagedStream.DisposeNative() in D:\\a\\1\\s\\binding\\Binding\\SKAbstractManagedStream.cs:52\r\n   SkiaSharp.SKNativeObject.Dispose(Boolean disposing) in D:\\a\\1\\s\\binding\\Binding\\SKObject.cs:287\r\n   SkiaSharp.SKManagedStream.Dispose(Boolean disposing) in D:\\a\\1\\s\\binding\\Binding\\SKManagedStream.cs:53\r\n   SkiaSharp.SKNativeObject.Dispose() in D:\\a\\1\\s\\binding\\Binding\\SKObject.cs:298\r\n   SkiaSharp.SKData.Create(Stream stream, Int64 length) in D:\\a\\1\\s\\binding\\Binding\\SKData.cs:141\r\n   MVCSample.Controllers.HomeController.CreateImage() in D:\\SkiaSharpSample\\MVCSample\\MVCSample\\Controllers\\HomeController.cs:30\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "LokeshBaskar",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "status/help-wanted",
      "color": "B8EC4A"
    }
  ],
  "assignees": [],
  "createdAt": "2024-01-19T13:02:09",
  "updatedAt": "2025-04-16T06:54:36",
  "commentCount": 9,
  "reactionCount": 0
}