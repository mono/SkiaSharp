{
  "number": 936,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKPictureRecorder Canvas / Dispose Not Thread Safe?",
  "body": "**Description**\r\n\r\nI\u0027ve discovered a way to cause SkiaSharp 1.68 to consistently crash in a multi-threaded environment with a System.AccessViolationException: \u0027Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\u0027 The stack trace shows the crash is occuring when SKPictureRecorder is disposed. It\u0027s easy to reproduce using SkiaSharp.Extended.Svg, since it\u0027s powered by the picture recorder underneath the hood.\r\n\r\n\u0060\u0060\u0060\r\n \t[Managed to Native Transition]\t\r\n \tSkiaSharp.dll!SkiaSharp.SKPictureRecorder.Dispose(bool disposing)\tUnknown\r\n \tSkiaSharp.dll!SkiaSharp.SKNativeObject.Dispose()\tUnknown\r\n SkiaSharp.Extended.Svg.dll!SkiaSharp.Extended.Svg.SKSvg.Load(System.Xml.Linq.XDocument xdoc)\tUnknown\r\n\u0060\u0060\u0060\r\n\r\n**Code**\r\n\r\nCreate a new .NET Core or .NET Framework Console application. I reproduced it with both Core 2.1 and Framework 4.7.2. Add SkiaSharp 1.68 and SkiaSharp.Extended.Svg 1.60 from NuGet. You\u0027ll need a valid SVG of some sort; I just grabbed a free sample from w3.org. Then just paste in this main function to run a bunch of threads at once. Run it and it will crash immediately.\r\n\r\nIf you don\u0027t actually create a canvas right afterward, it won\u0027t crash either. Something terrible is happening behind the scenes with the SKPictureRecorder disposal and the SKCanvas disposal. Unfortunately, if you want to actually do something with the SVG afterwards in a real program you kinda need to make a canvas eventually.\r\n\r\nLuckily, if you wrap the svg.Load in a lock, the program appears to complete successfully. Ideally though this wouldn\u0027t be necessary....\r\n\r\n\u0060\u0060\u0060\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Xml;\r\nusing SkiaSharp;\r\n\r\nnamespace TestApp {\r\n\tclass Program {\r\n\r\n\t\tprivate static object _skSvgLock = new object();\r\n\r\n\t\tstatic void Main(string[] args) {\r\n\t\t\tConsole.WriteLine($\u0022Framework App {(IntPtr.Size == 8 ? \u0022x64\u0022 : \u0022x86\u0022)}\u0022);\r\n\t\t\tconst int maxThreads = 100;\r\n\t\t\tconst int maxRuns = 1000;\r\n\r\n\t\t\tAction targetRun = SvgRun;\r\n\r\n\t\t\tvar sw = System.Diagnostics.Stopwatch.StartNew();\r\n\r\n\t\t\tvar l = new List\u003CSystem.Threading.Thread\u003E();\r\n\t\t\tfor (var i = 0; i \u003C maxThreads; i\u002B\u002B) {\r\n\t\t\t\tvar t = new System.Threading.Thread((threadId) =\u003E {\r\n\t\t\t\t\tfor (var j = 0; j \u003C maxRuns; j\u002B\u002B) {\r\n\t\t\t\t\t\ttargetRun();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tt.Name = $\u0022Thread #{i}\u0022;\r\n\t\t\t\tt.Start(i);\r\n\t\t\t\tl.Add(t);\r\n\t\t\t}\r\n\t\t\tfor (var i = 0; i \u003C maxThreads; i\u002B\u002B) {\r\n\t\t\t\tl[i].Join();\r\n\t\t\t}\r\n\r\n\t\t\tsw.Stop();\r\n\t\t\tConsole.WriteLine($\u0022{sw.Elapsed:c}\u0022);\r\n\t\t}\r\n\r\n\t\tprivate static void SvgRun() {\r\n\r\n\t\t\tvar bmp = ToBitmap(24, 24);\r\n\t\t\tbmp?.Dispose();\r\n\r\n\t\t\tSkiaSharp.SKBitmap ToBitmap(int width, int height) {\r\n\t\t\t\tSkiaSharp.SKPicture picture = null;\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar xDoc = ToXmlDocument(GetSvgText());\r\n\r\n\t\t\t\t\t//lock (_skSvgLock) {\r\n\t\t\t\t\tvar svg = new SkiaSharp.Extended.Svg.SKSvg();\r\n\t\t\t\t\tusing (var xr = new System.Xml.XmlNodeReader(xDoc)) {\r\n\t\t\t\t\t\tpicture = svg.Load(xr);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//}\r\n\r\n\t\t\t\t\tvar info = new SkiaSharp.SKImageInfo(width, height, SkiaSharp.SKColorType.Bgra8888, SKAlphaType.Premul);\r\n\t\t\t\t\tvar bitmap = new SkiaSharp.SKBitmap(info);\r\n\r\n\t\t\t\t\t//The important line that causes the crash:\r\n\t\t\t\t\tusing (var canvas = new SkiaSharp.SKCanvas(bitmap)) { }\r\n\r\n\t\t\t\t\treturn bitmap;\r\n\t\t\t\t} finally {\r\n\t\t\t\t\tpicture?.Dispose();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tXmlDocument ToXmlDocument(string svg) {\r\n\t\t\t\tvar xDoc = new XmlDocument();\r\n\t\t\t\tusing (var sr = new System.IO.StringReader(svg)) {\r\n\t\t\t\t\txDoc.Load(sr);\r\n\t\t\t\t}\r\n\t\t\t\treturn xDoc;\r\n\t\t\t}\r\n\t\t\tstring GetSvgText() {\r\n\t\t\t\treturn \u0022\u003Csvg xmlns=\u0027http://www.w3.org/2000/svg\u0027 viewBox=\\\u00220 0 131 76\\\u0022\u003E\u003Cpath d=\\\u0022M36,5l12,41l12-41h33v4l-13,21c30,10,2,69-21,28l7-2c15,27,33,-22,3,-19v-4l12-20h-15l-17,59h-1l-13-42l-12,42h-1l-20-67h9l12,41l8-28l-4-13h9\\\u0022 fill=\u0027#005A9C\u0027/\u003E\u003Cpath d=\\\u0022M94,53c15,32,30,14,35,7l-1-7c-16,26-32,3-34,0M122,16c-10-21-34,0-21,30c-5-30 16,-38 23,-21l5-10l-2-9\\\u0022/\u003E\u003C/svg\u003E\u0022;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nExpected no unmanaged memory corruption.\r\n\r\n**Actual Behavior**\r\n\r\nGot unmanaged memory error and potential process teardown.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.0\r\n- Last known good version:  Unknown\r\n- IDE:  VS2019\r\n- Platform Target Frameworks: \r\n- Windows Classic:  Core 2.1 \u0026 Framework 4.7.2\r\n- Target Devices:   Windows 10 1903\r\n\r\n**Screenshots**\r\n\r\n![SvgAccessViolation](https://user-images.githubusercontent.com/38544371/63966728-80059a00-ca61-11e9-9da9-5cc366c3b63e.png)",
  "author": {
    "login": "mlptownsend",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2019-08-29T18:35:20",
  "updatedAt": "2022-08-19T09:02:32",
  "closedAt": "2020-04-29T10:14:30",
  "commentCount": 2,
  "reactionCount": 1
}