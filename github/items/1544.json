{
  "number": 1544,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Segmentation fault in SKSurface finalizer using the GL backend in macOS",
  "body": "**Description**\r\n\r\nIn macOS using the GL backend, the SKSurface finalizer causes a segfault in the native code.\r\nI am able to reproduce the issue consistently on every run with the following sample application https://github.com/ylatuya/OpenTKSkiaGtk2\r\n\r\n1. Run the application\r\n2. Close the window clicking the top-left red cross icon\r\n\r\n\u003Cdetails\u003E\r\n  \u003Csummary\u003EStacktrace\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\nLoaded assembly: /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/OpenTKSkia.exe\r\nLoaded assembly: /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/SkiaSharp.dll [External]\r\nLoaded assembly: /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/OpenTK.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/gtk-sharp/2.12.0.0__35e10195dab3c99f/gtk-sharp.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/glib-sharp/2.12.0.0__35e10195dab3c99f/glib-sharp.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/atk-sharp/2.12.0.0__35e10195dab3c99f/atk-sharp.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/System/4.0.0.0__b77a5c561934e089/System.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/gdk-sharp/2.12.0.0__35e10195dab3c99f/gdk-sharp.dll [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/Mono.Posix/4.0.0.0__0738eb9f132ed756/Mono.Posix.dll [External]\r\n\r\n(OpenTKSkia:46523): Gtk-WARNING **: Locale not supported by C library.\r\n\tUsing the fallback \u0027C\u0027 locale.\r\nOpenTK running on OSX\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/gac/System.Core/4.0.0.0__b77a5c561934e089/System.Core.dll [External]\r\nLoaded assembly: Anonymously Hosted DynamicMethods Assembly [External]\r\nLoaded assembly: /Library/Frameworks/Mono.framework/Versions/6.12.0/lib/mono/4.5/Facades/System.Runtime.InteropServices.RuntimeInformation.dll [External]\r\n\r\n=================================================================\r\n\tNative Crash Reporting\r\n=================================================================\r\nGot a segv while executing native code. This usually indicates\r\na fatal error in the mono runtime or one of the native libraries \r\nused by your application.\r\n=================================================================\r\n\r\n=================================================================\r\n\tNative stacktrace:\r\n=================================================================\r\n\t0x10028a779 - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : mono_dump_native_crash_info\r\n\t0x1002225be - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : mono_handle_native_crash\r\n\t0x1002848f8 - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : altstack_handle_and_restore\r\n\t0x7fff3764f8ac - /System/Library/Frameworks/OpenGL.framework/Versions/A/Libraries/libGL.dylib : glDeleteBuffers\r\n\t0x109d83f1c - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c27a8f - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c4f2fa - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c32e1b - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c4d976 - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c1cdb9 - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109c291eb - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109d03688 - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109a022af - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109a01e95 - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109a022ee - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x109d0e550 - /Users/andoni/Projects/OpenTKSkia/OpenTKSkiaGtk2/bin/Debug/libSkiaSharp.dylib : gr_backendrendertarget_get_gl_framebufferinfo\r\n\t0x10a31ba8c - Unknown\r\n\t0x10a31b945 - Unknown\r\n\t0x10a31b7ab - Unknown\r\n\t0x10a31b583 - Unknown\r\n\t0x10a31a29a - Unknown\r\n\t0x10a31a01b - Unknown\r\n\t0x10a3240cb - Unknown\r\n\t0x10a319d6f - Unknown\r\n\t0x10a319b82 - Unknown\r\n\t0x1003f9939 - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : mono_gc_run_finalize\r\n\t0x100418a6c - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : sgen_gc_invoke_finalizers\r\n\t0x1003fb829 - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : finalizer_thread\r\n\t0x1003b9d3d - /Library/Frameworks/Mono.framework/Versions/6.12.0/bin/mono64 : start_wrapper\r\n\t0x7fff679cd109 - /usr/lib/system/libsystem_pthread.dylib : _pthread_start\r\n\t0x7fff679c8b8b - /usr/lib/system/libsystem_pthread.dylib : thread_start\r\n\r\n=================================================================\r\n\tTelemetry Dumper:\r\n=================================================================\r\nPkilling 0x4429610432x from 0x123145405673472x\r\nPkilling 0x123145407782912x from 0x123145405673472x\r\nEntering thread summarizer pause from 0x123145405673472x\r\nFinished thread summarizer pause from 0x123145405673472x.\r\nFailed to create breadcrumb file (null)/crash_hash_0xef678eeec\r\n\r\nWaiting for dumping threads to resume\r\n\r\n=================================================================\r\n\tExternal Debugger Dump:\r\n=================================================================\r\n\r\n=================================================================\r\n\tBasic Fault Address Reporting\r\n=================================================================\r\nMemory around native instruction pointer (0x7fff3764f8ac):0x7fff3764f89c  89 e5 48 89 f2 89 fe 65 48 8b 04 25 f0 00 00 00  ..H....eH..%....\r\n0x7fff3764f8ac  48 8b 88 20 14 00 00 48 8b 38 5d ff e1 55 48 89  H.. ...H.8]..UH.\r\n0x7fff3764f8bc  e5 48 89 f2 89 fe 65 48 8b 04 25 f0 00 00 00 48  .H....eH..%....H\r\n0x7fff3764f8cc  8b 88 28 14 00 00 48 8b 38 5d ff e1 55 48 89 e5  ..(...H.8]..UH..\r\n\r\n=================================================================\r\n\tManaged Stacktrace:\r\n=================================================================\r\n\t  at \u003Cunknown\u003E \u003C0xffffffff\u003E\r\n\t  at System.Object:wrapper_native_0x1099d8640 \u003C0x000eb\u003E\r\n\t  at SkiaSharp.SkiaApi:sk_refcnt_safe_unref \u003C0x00124\u003E\r\n\t  at SkiaSharp.SKObjectExtensions:SafeUnRef \u003C0x001ca\u003E\r\n\t  at SkiaSharp.SKObject:DisposeNative \u003C0x00142\u003E\r\n\t  at SkiaSharp.SKNativeObject:Dispose \u003C0x00229\u003E\r\n\t  at SkiaSharp.SKObject:Dispose \u003C0x0009a\u003E\r\n\t  at SkiaSharp.SKSurface:Dispose \u003C0x0009a\u003E\r\n\t  at SkiaSharp.SKNativeObject:Finalize \u003C0x000ae\u003E\r\n\t  at System.Object:runtime_invoke_virtual_void__this__ \u003C0x00111\u003E\r\n=================================================================\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E\r\n\r\n\r\n**Code**\r\n\r\n\r\n**Expected Behavior**\r\n\r\nThe application is closed correctly, finalizers are run and no segfault happen\r\n\r\n**Actual Behavior**\r\n\r\nThere is a native segfault calling the finalizers\r\n\r\n**Basic Information**\r\n\r\n- Version with issue: 2.80.2\r\n- Last known good version: unknown\r\n- IDE:  Visual Studio for Mac\r\n- Platform Target Frameworks: \r\n  - macOS:  10.15.5\r\n  \r\n\r\n\r\n**Screenshots**\r\n\r\n\r\n**Reproduction Link**\r\n\r\nhttps://github.com/ylatuya/OpenTKSkiaGtk2\r\n\r\n",
  "author": {
    "login": "ylatuya",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2020-10-30T17:23:28",
  "updatedAt": "2020-10-30T18:06:50",
  "commentCount": 1,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T21:03:58.9131742Z",
    "reactions": [],
    "comments": [
      {
        "id": 719708882,
        "author": "ylatuya",
        "createdAt": "2020-10-30T17:59:26",
        "reactions": []
      }
    ]
  }
}