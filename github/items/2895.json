{
  "number": 2895,
  "type": "issue",
  "state": "open",
  "title": "[BUG] SKElement of SkiaSharp.Views.WPF renders blurred content when applying a ScalingTransform",
  "body": "### Description\n\nWhen I use the SKElement to draw content, it looks good at normal scaling.\r\nHowever, when I apply a RenderTransform as shown below to scale the entire app, the content becomes blurred. \r\n\u0060\u0060\u0060\r\n\u003CGrid Width=\u0022400\u0022 Height=\u0022500\u0022\u003E\r\n    \u003CGrid.RenderTransform\u003E\r\n        \u003CScaleTransform CenterX=\u0022200\u0022 CenterY=\u0022250\u0022 ScaleX=\u00222\u0022 ScaleY=\u00222\u0022/\u003E\r\n    \u003C/Grid.RenderTransform\u003E\r\n    \r\n    \u003Cskia:SKElement PaintSurface=\u0022OnPaintSurface\u0022 /\u003E\r\n\u003C/Grid\u003E\r\n\u0060\u0060\u0060\r\nI discovered that the \u0060CreateSize\u0060 method in \u0060SKElement\u0060 should multiply with the current transform. It should be modified something like this:\r\n\u0060\u0060\u0060cs\r\nvar renderScale = this.GetRenderScale();\r\nMatrix transformToDevice = PresentationSource.FromVisual(this).CompositionTarget.TransformToDevice;\r\nscaleX = (float)renderScale.m11 * (float)transformToDevice.M11;\r\nscaleY = (float)renderScale.m22 * (float)transformToDevice.M22;\r\n\u0060\u0060\u0060\r\n\r\nHere is the full version:\r\n\u0060\u0060\u0060cs\r\nprivate SKSizeI CreateSize(out SKSizeI unscaledSize, out float scaleX, out float scaleY)\r\n{\r\n    unscaledSize = SKSizeI.Empty;\r\n    scaleX = 1f;\r\n    scaleY = 1f;\r\n    double actualWidth = base.ActualWidth;\r\n    double actualHeight = base.ActualHeight;\r\n    if (!IsPositive(actualWidth) || !IsPositive(actualHeight))\r\n    {\r\n        return SKSizeI.Empty;\r\n    }\r\n\r\n    unscaledSize = new SKSizeI((int)actualWidth, (int)actualHeight);\r\n\r\n    var renderScale = this.GetRenderScale();\r\n    Matrix transformToDevice = PresentationSource.FromVisual(this).CompositionTarget.TransformToDevice;\r\n    scaleX = (float)renderScale.m11 * (float)transformToDevice.M11;\r\n    scaleY = (float)renderScale.m22 * (float)transformToDevice.M22;\r\n\r\n    return new SKSizeI((int)(actualWidth * (double)scaleX), (int)(actualHeight * (double)scaleY));\r\n    static bool IsPositive(double value)\r\n    {\r\n        if (!double.IsNaN(value) \u0026\u0026 !double.IsInfinity(value))\r\n        {\r\n            return value \u003E 0.0;\r\n        }\r\n\r\n        return false;\r\n    }\r\n}\r\n\r\nprivate (double m11, double m22) GetRenderScale()\r\n{\r\n    var transform = VisualTreeHelper.GetTransform(this)?.Value ?? Matrix.Identity;\r\n    DependencyObject control = VisualTreeHelper.GetParent(this);\r\n    while (control != null)\r\n    {\r\n        if (control is Visual v \u0026\u0026 VisualTreeHelper.GetTransform(v) is Transform vt)\r\n        {\r\n            transform *= vt.Value;\r\n        }\r\n        control = VisualTreeHelper.GetParent(control);\r\n    }\r\n\r\n    return (transform.M11, transform.M22);\r\n}\r\n\r\n\u0060\u0060\u0060\n\n### Code\n\ndemo code: \r\n\u0060\u0060\u0060cs\r\nusing SkiaSharp;\r\nusing SkiaSharp.Views.Desktop;\r\nusing System.Windows;\r\n\r\nnamespace SkiaSharpDemo\r\n{\r\n    /// \u003Csummary\u003E\r\n    /// Interaction logic for MainWindow.xaml\r\n    /// \u003C/summary\u003E\r\n    public partial class MainWindow : Window\r\n    {\r\n        public MainWindow()\r\n        {\r\n\r\n        }\r\n\r\n        private void OnPaintSurface(object sender, SKPaintSurfaceEventArgs e)\r\n        {\r\n            // the the canvas and properties\r\n            var canvas = e.Surface.Canvas;\r\n\r\n            // make sure the canvas is blank\r\n            canvas.Clear(SKColors.White);\r\n\r\n            using var font = new SKFont\r\n            {\r\n                Size = 100\r\n            };\r\n\r\n            // draw some text\r\n            using var paint = new SKPaint(font)\r\n            {\r\n                Color = SKColors.Black,\r\n                IsAntialias = true,\r\n                Style = SKPaintStyle.Fill\r\n            };\r\n\r\n\r\n            var coord = new SKPoint(e.Info.Width / 2, (e.Info.Height \u002B font.Size) / 2);\r\n            //canvas.DrawText(\u0022SkiaSharp\u0022, coord, SKTextAlign.Center, font, paint);\r\n            canvas.DrawText(\u0022SkiaSharp\u0022, coord, paint);\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\nYou can also share some XAML:\r\n\u0060\u0060\u0060xaml\r\n\u003CWindow x:Class=\u0022SkiaSharpDemo.MainWindow\u0022\r\n        xmlns=\u0022http://schemas.microsoft.com/winfx/2006/xaml/presentation\u0022\r\n        xmlns:x=\u0022http://schemas.microsoft.com/winfx/2006/xaml\u0022\r\n        xmlns:d=\u0022http://schemas.microsoft.com/expression/blend/2008\u0022\r\n        xmlns:mc=\u0022http://schemas.openxmlformats.org/markup-compatibility/2006\u0022\r\n        xmlns:local=\u0022clr-namespace:SkiaSharpDemo\u0022\r\n        mc:Ignorable=\u0022d\u0022\r\n         xmlns:skia=\u0022clr-namespace:SkiaSharp.Views.WPF;assembly=SkiaSharp.Views.WPF\u0022\r\n        Title=\u0022MainWindow\u0022 Height=\u0022600\u0022 Width=\u0022800\u0022 WindowStartupLocation=\u0022CenterScreen\u0022\u003E\r\n    \u003CGrid Width=\u0022400\u0022 Height=\u0022500\u0022\u003E\r\n        \u003CGrid.RenderTransform\u003E\r\n            \u003CScaleTransform CenterX=\u0022200\u0022 CenterY=\u0022250\u0022 ScaleX=\u00222\u0022 ScaleY=\u00222\u0022/\u003E\r\n        \u003C/Grid.RenderTransform\u003E\r\n        \r\n        \u003Cskia:SKElement PaintSurface=\u0022OnPaintSurface\u0022 /\u003E\r\n    \u003C/Grid\u003E\r\n\u003C/Window\u003E\r\n\r\n\u0060\u0060\u0060\r\n\n\n### Expected Behavior\n\nThe content does not become blurred.\n\n### Actual Behavior\n\nThe content blurred.\n\n### Version of SkiaSharp\n\n2.88.3 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.2 (Previous)\n\n### IDE / Editor\n\nVisual Studio (Windows)\n\n### Platform / Operating System\n\nWindows\n\n### Platform / Operating System Version\n\n_No response_\n\n### Devices\n\n_No response_\n\n### Relevant Screenshots\n\n![image](https://github.com/mono/SkiaSharp/assets/24811783/e6d95fda-a2d9-47ae-a0f3-b284fa10bf25)\r\n\n\n### Relevant Log Output\n\n_No response_\n\n### Code of Conduct\n\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "LuanPham97",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-06-11T09:36:06",
  "updatedAt": "2024-06-11T09:36:06",
  "commentCount": 0,
  "reactionCount": 0
}