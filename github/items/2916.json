{
  "number": 2916,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Delegate proxies crash with NRE when user delegate is null (only if rewrite to function pointers)",
  "body": "### Description\r\n\r\n~This is a weird issue, as I wasn\u0027t able to reproduce it with a WASM Mono runtime or normal desktop application. But only with NativeAOT-LLVM.~\r\nIt seems this issue is only reproducible after I replaced managed delegates with function pointers as part of https://github.com/mono/SkiaSharp/issues/2615\r\n\r\nBut I decided to open this issue here instead, as it actually looks like a bug in SkiaSharp code, and exception is somehow swallowed outside of it.\r\n\r\n\r\n### Code\r\n\r\nSkiaSharp has many methods accepting callbacks. Like:\r\n\u0060\u0060\u0060\r\npublic bool InstallPixels (SKImageInfo info, IntPtr pixels, int rowBytes, SKBitmapReleaseDelegate releaseProc, object context)\r\n{\r\n\tvar cinfo = SKImageInfoNative.FromManaged (ref info);\r\n\tvar del = releaseProc != null \u0026\u0026 context != null\r\n\t\t? new SKBitmapReleaseDelegate ((addr, _) =\u003E releaseProc (addr, context))\r\n\t\t: releaseProc;\r\n\tDelegateProxies.Create (del, out _, out var ctx);\r\n\treturn SkiaApi.sk_bitmap_install_pixels (Handle, \u0026cinfo, (void*)pixels, (IntPtr)rowBytes, DelegateProxies.SKBitmapReleaseDelegateProxy, (void*)ctx);\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThe problem with this callback, that it passes proxy function to the DllImport even when releaseProc is null.\r\n\r\nAnd from proxy implementation, it will always crash with NRE, as \u0060context\u0060 is an empty pointer.\r\n\u0060\u0060\u0060\r\nprivate static void SKSurfaceReleaseDelegateProxyImplementation (void* address, void* context)\r\n{\r\n\tvar del = Get\u003CSKSurfaceReleaseDelegate\u003E ((IntPtr)context, out var gch);\r\n\ttry {\r\n\t\tdel.Invoke ((IntPtr)address, null);\r\n\t} finally {\r\n\t\tgch.Free ();\r\n\t}\r\n}\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Expected Behavior\r\n\r\nNo exception.\r\n\r\n### Actual Behavior\r\n\r\nException.\r\n\r\n### Version of SkiaSharp\r\n\r\n3.x (Alpha)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nOther (Please indicate in the description)\r\n\r\n### Platform / Operating System Version\r\n\r\nReproduced on WASM (both Mono and NativeAOT)\r\n_\r\n\r\n### Relevant Log Output\r\n\r\n\u003C!--StartFragment--\u003E\u003Cdiv aria-expanded=\u0022true\u0022 tabindex=\u0022-1\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; flex: 0 0 auto; color: rgb(255, 255, 255); font-family: consolas, \u0026quot;lucida console\u0026quot;, \u0026quot;courier new\u0026quot;, monospace; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(0, 74, 119); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\u0022\u003E\u003Cspan class=\u0022source-code\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; font-family: var(--source-code-font-family); white-space: pre-wrap; font-size: var(--source-code-font-size) !important; line-height: 1.2;\u0022\u003E\u003Cspan class=\u0022console-message-anchor\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; float: right; text-align: right; max-width: 100%; margin-left: 4px;\u0022\u003E\u003Cbutton class=\u0022devtools-link text-button link-style\u0022 jslog=\u0022Link; track: click\u0022 role=\u0022link\u0022 tabindex=\u0022-1\u0022 title=\u0022http://localhost:49512/dotnet.native.js:1553\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; font: inherit; color: var(--sys-color-primary); border: none; border-radius: 2px; background: none; margin: 0px; height: unset; padding: 0px !important; flex: 0 0 auto; white-space: nowrap; text-decoration: underline; outline-offset: 2px; cursor: pointer; outline: none; max-width: 100%; overflow: hidden; text-overflow: ellipsis; word-break: break-all;\u0022\u003E\u003Cbr class=\u0022Apple-interchange-newline\u0022\u003Edotnet.native.js:1553\u003C/button\u003E \u003Cdevtools-icon role=\u0022button\u0022 class=\u0022resource-links console-search-icon\u0022 name=\u0022edge-search-info\u0022 title=\u0022Search for this message on the Web\u0022 aria-label=\u0022Unhandled exception. System.NullReferenceException: Object reference not set to an instance of an object.\u0022 tabindex=\u00220\u0022 style=\u0022flex-grow: 0; flex-shrink: 0; display: inline-block; width: 16px; height: 16px; color: var(--color-link); vertical-align: sub; position: relative; box-sizing: border-box; min-width: 0px; min-height: 0px; margin-top: -1px; margin-bottom: -4px; cursor: pointer;\u0022\u003E\u003Cspan style=\u0022display: block; width: 16px; height: 16px; background-color: currentcolor; mask: var(--icon-url) center / contain no-repeat; --icon-url: var(--image-file-edge-search-info);\u0022\u003E\u003C/span\u003E\u003C/devtools-icon\u003E \u003C/span\u003E\u003Cspan class=\u0022console-message-text\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; color: var(--override-error-text-color) !important;\u0022\u003EUnhandled exception. System.NullReferenceException: Object reference not set to an instance of an object.\u003C/span\u003E\u003C/span\u003E\u003C/div\u003E\u003Cdiv class=\u0022\u0022 role=\u0022group\u0022 style=\u0022box-sizing: border-box; min-width: 0px; min-height: 0px; flex: 0 0 auto; color: rgb(255, 255, 255); font-family: consolas, \u0026quot;lucida console\u0026quot;, \u0026quot;courier new\u0026quot;, monospace; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(0, 74, 119); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\u0022\u003E\u003Cspan class=\u0022monospace stack-preview-container width-constrained\u0022 style=\u0022display: inline-block; --monospace-font-size: 12px; --monospace-font-family: consolas, lucida console, courier new, monospace; --source-code-font-size: 12px; --source-code-font-family: consolas, lucida console, courier new, monospace; width: 768px; box-sizing: border-box; min-width: 0px; min-height: 0px; font-family: var(--monospace-font-family); font-size: var(--monospace-font-size) !important;\u0022\u003E\r\n\u00A0 | put_char | @ | dotnet.native.js:1553\r\n-- | -- | -- | --\r\n\u00A0 | $SystemNative_LogError | @ | dotnet.native.wasm:0x14219fc\r\n\u00A0 | $S_P_CoreLib_Internal_Console_Error__Write | @ | dotnet.native.wasm:0x6a6783\r\n\u00A0 | $S_P_CoreLib_System_RuntimeExceptionHelpers__FailFast | @ | dotnet.native.wasm:0xd0c2d8\r\n\u00A0 | $S_P_CoreLib_System_RuntimeExceptionHelpers__RuntimeFailFast | @ | dotnet.native.wasm:0x10b8b5b\r\n\u00A0 | $S_P_CoreLib_System_Runtime_EH__HandleUnhandledException | @ | dotnet.native.wasm:0x10b6dfa\r\n\u00A0 | $SkiaSharp_SkiaSharp_DelegateProxies__SKBitmapReleaseDelegateProxyImplementation$F1_Filter | @ | dotnet.native.wasm:0xed436a\r\n\u00A0 | $S_P_CoreLib_System_Runtime_EH__CallFilterFunclet | @ | dotnet.native.wasm:0x114210f\r\n\u00A0 | $S_P_CoreLib_System_Runtime_EH__DispatchException | @ | dotnet.native.wasm:0xd903c\r\n\u00A0 | $S_P_CoreLib_System_Runtime_EH__RhpThrowEx | @ | dotnet.native.wasm:0x108ba01\r\n\u00A0 | $S_P_CoreLib_Internal_Runtime_CompilerHelpers_ThrowHelpers__ThrowNullReferenceException | @ | dotnet.native.wasm:0x108b96d\r\n\u00A0 | $SkiaSharp_SkiaSharp_DelegateProxies__SKBitmapReleaseDelegateProxyImplementation | @ | dotnet.native.wasm:0xed4317\r\n\u00A0 | $SkMakePixelRefWithProc(int, int, unsigned long, void*, void (*)(void*, void*), void*)::PixelRef::~PixelRef() | @ | dotnet.native.wasm:0x185b3e4\r\n\u00A0 | $SkRefCntBase::internal_dispose() const | @ | dotnet.native.wasm:0x18765ed\r\n\u00A0 | $SkBitmap::~SkBitmap() | @ | dotnet.native.wasm:0x185b791\r\n\u00A0 | $sk_bitmap_destructor | @ | dotnet.native.wasm:0x1943b5e\r\n\u00A0 | $SkiaSharp_SkiaSharp_SKBitmap__DisposeNative | @ | dotnet.native.wasm:0xdbe66c\r\n\u00A0 | $SkiaSharp_SkiaSharp_SKNativeObject__Dispose | @ | dotnet.native.wasm:0xa68216\r\n\u00A0 | $SkiaSharp_SkiaSharp_SKBitmap__Dispose | @ | dotnet.native.wasm:0xdbe69d\r\n\u00A0 | $SkiaSharp_SkiaSharp_SKNativeObject__Dispose_0 | @ | dotnet.native.wasm:0xc74915\r\n\u00A0 | $Avalonia_Skia_Avalonia_Skia_ImmutableBitmap___ctor_3\r\n\r\n\u003C/span\u003E\u003C/div\u003E\u003C!--EndFragment--\u003E\r\n\u003C/body\u003E\r\n\u003C/html\u003E\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "maxkatz6",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-02T23:29:42",
  "updatedAt": "2024-07-03T06:43:53",
  "closedAt": "2024-07-03T06:43:53",
  "commentCount": 1,
  "reactionCount": 0
}