{
  "number": 260,
  "type": "issue",
  "state": "closed",
  "title": "Improvements for SKCanvasViewRenderer",
  "body": "Hi!\r\n\r\nI\u0027ts been a while that we touched our SVG project, but now we\u0027re on the go again and it is amazing to see how SkiaSharp has evolved so far. Congratulations - you\u0027re doing a great job!\r\n\r\nThat said, we recently came across a problem when inheriting the SKCanvasViewRenderer as described in: https://github.com/mattleibow/SkiaSharpFormsRendererDemo\r\n\r\nThe problem is, that we need to create our own view on Android and iOS, as we need to override their \u0022public override void TouchesBegan(NSSet touches, UIEvent evt)\u0022 and or \u0022public override bool OnTouchEvent(MotionEvent ev)\u0022 methods.\r\n\r\nProblem: when inheriting your SKCanvasViewRenderer, that viewtype is basically fixed.\r\nSo we refactored it a bit and created a \u0022SKCanvasViewRendererBase\u003CTFormsView, TNativeView\u003E\u0022\r\n\r\nNote: I would love to create a PR for this, but it is sooooo cumbersome to get skia to build on my windows machine. If there was a script that did not only update the submodule but also build it, that would be soooooo great! (and bring a lot of contributors to your project)\r\n\r\nIn order to create our own renderer, we copied your SkiaSharp.Views.Forms.SKCanvasView (because its  interface ISKCanvasViewController is internal)\r\nThe only thing we changed is the \u0022X\u0022 at the end of the classname and that the interface is now public\r\n\u0060\u0060\u0060\r\n\r\nusing System;\r\nusing Xamarin.Forms;\r\n\r\nnamespace SkiaSharp.Views.Forms\r\n{\r\n    public class SKCanvasViewX : View, ISKCanvasViewController\r\n    {\r\n        public static readonly BindableProperty IgnorePixelScalingProperty =\r\n            BindableProperty.Create(nameof(IgnorePixelScaling), typeof(bool), typeof(SKCanvasViewX), default(bool));\r\n\r\n        // the user can subscribe to repaint\r\n        public event EventHandler\u003CSKPaintSurfaceEventArgs\u003E PaintSurface;\r\n\r\n        // the native listens to this event\r\n        private event EventHandler SurfaceInvalidated;\r\n        private event EventHandler\u003CGetCanvasSizeEventArgs\u003E GetCanvasSize;\r\n\r\n        // the user asks the for the size\r\n        public SKSize CanvasSize\r\n        {\r\n            get\r\n            {\r\n                // send a mesage to the native view\r\n                var args = new GetCanvasSizeEventArgs();\r\n                GetCanvasSize?.Invoke(this, args);\r\n                return args.CanvasSize;\r\n            }\r\n        }\r\n\r\n        public bool IgnorePixelScaling\r\n        {\r\n            get { return (bool)GetValue(IgnorePixelScalingProperty); }\r\n            set { SetValue(IgnorePixelScalingProperty, value); }\r\n        }\r\n\r\n        // the user asks to repaint\r\n        public void InvalidateSurface()\r\n        {\r\n            // send a mesage to the native view\r\n            SurfaceInvalidated?.Invoke(this, EventArgs.Empty);\r\n        }\r\n\r\n        // the native view tells the user to repaint\r\n        protected virtual void OnPaintSurface(SKPaintSurfaceEventArgs e)\r\n        {\r\n            PaintSurface?.Invoke(this, e);\r\n        }\r\n\r\n        // ISKViewController implementation\r\n\r\n        event EventHandler ISKCanvasViewController.SurfaceInvalidated\r\n        {\r\n            add { SurfaceInvalidated \u002B= value; }\r\n            remove { SurfaceInvalidated -= value; }\r\n        }\r\n\r\n        event EventHandler\u003CGetCanvasSizeEventArgs\u003E ISKCanvasViewController.GetCanvasSize\r\n        {\r\n            add { GetCanvasSize \u002B= value; }\r\n            remove { GetCanvasSize -= value; }\r\n        }\r\n\r\n        void ISKCanvasViewController.OnPaintSurface(SKPaintSurfaceEventArgs e)\r\n        {\r\n            OnPaintSurface(e);\r\n        }\r\n    }\r\n\r\n    public interface ISKCanvasViewController : IViewController\r\n    {\r\n        // the native listens to this event\r\n        event EventHandler SurfaceInvalidated;\r\n        event EventHandler\u003CGetCanvasSizeEventArgs\u003E GetCanvasSize;\r\n\r\n        // the native view tells the user to repaint\r\n        void OnPaintSurface(SKPaintSurfaceEventArgs e);\r\n    }\r\n    public class GetCanvasSizeEventArgs : EventArgs\r\n    {\r\n        public SKSize CanvasSize { get; set; }\r\n    }\r\n}\r\n\r\n\u0060\u0060\u0060\r\n\r\nwith that, we could e.g. create a SKCanvasViewRendererBase for Android (iOS looks the same):\r\n\u0060\u0060\u0060\r\n\r\nusing System;\r\nusing System.ComponentModel;\r\nusing Xamarin.Forms.Platform.Android;\r\n\r\nusing SKFormsView = SkiaSharp.Views.Forms.SKCanvasViewX;\r\nusing SKNativeView = SkiaSharp.Views.Android.SKCanvasView;\r\n\r\nnamespace SkiaSharp.Views.Forms\r\n{\r\n    public class SKCanvasViewRendererBase\u003CTFormsView, TNativeView\u003E : ViewRenderer\u003CTFormsView, TNativeView\u003E\r\n        where TNativeView : SKNativeView, IPaintSurface\r\n        where TFormsView : SKFormsView\r\n    {\r\n        protected override void OnElementChanged(ElementChangedEventArgs\u003CTFormsView\u003E e)\r\n        {\r\n            if (e.OldElement != null)\r\n            {\r\n                var oldController = (ISKCanvasViewController)e.OldElement;\r\n\r\n                // unsubscribe from events\r\n                oldController.SurfaceInvalidated -= OnSurfaceInvalidated;\r\n                oldController.GetCanvasSize -= OnGetCanvasSize;\r\n            }\r\n            if (Control != null)\r\n            {\r\n                Control.PaintSurface -= OnPaintSurface;\r\n            }\r\n\r\n            if (e.NewElement != null)\r\n            {\r\n                var newController = (ISKCanvasViewController)e.NewElement;\r\n\r\n                // create the native view\r\n                var view = CreateNativeView();\r\n                view.IgnorePixelScaling = e.NewElement.IgnorePixelScaling;\r\n                view.PaintSurface \u002B= OnPaintSurface;\r\n                SetNativeControl(view);\r\n\r\n                // subscribe to events from the user\r\n                newController.SurfaceInvalidated \u002B= OnSurfaceInvalidated;\r\n                newController.GetCanvasSize \u002B= OnGetCanvasSize;\r\n\r\n                // paint for the first time\r\n                Control.Invalidate();\r\n            }\r\n\r\n            base.OnElementChanged(e);\r\n        }\r\n\r\n        protected virtual TNativeView CreateNativeView()\r\n        {\r\n            var view = (TNativeView)Activator.CreateInstance(typeof(TNativeView), new object[] {Context, null});\r\n            return view;\r\n        }\r\n\r\n        protected override void OnElementPropertyChanged(object sender, PropertyChangedEventArgs e)\r\n        {\r\n            base.OnElementPropertyChanged(sender, e);\r\n\r\n            if (e.PropertyName == nameof(SKFormsView.IgnorePixelScaling))\r\n            {\r\n                Control.IgnorePixelScaling = Element.IgnorePixelScaling;\r\n            }\r\n        }\r\n\r\n        protected override void Dispose(bool disposing)\r\n        {\r\n            // detach all events before disposing\r\n            var controller = (ISKCanvasViewController)Element;\r\n            if (controller != null)\r\n            {\r\n                controller.SurfaceInvalidated -= OnSurfaceInvalidated;\r\n            }\r\n\r\n            base.Dispose(disposing);\r\n        }\r\n\r\n        private void OnSurfaceInvalidated(object sender, EventArgs eventArgs)\r\n        {\r\n            // repaint the native control\r\n            Control.Invalidate();\r\n        }\r\n\r\n        // the user asked for the size\r\n        private void OnGetCanvasSize(object sender, GetCanvasSizeEventArgs e)\r\n        {\r\n            e.CanvasSize = Control?.CanvasSize ?? SKSize.Empty;\r\n        }\r\n\r\n        private void OnPaintSurface(object sender, Android.SKPaintSurfaceEventArgs e)\r\n        {\r\n            var controller = this.Element as ISKCanvasViewController;\r\n            \r\n            // the control is being repainted, let the user know\r\n            controller?.OnPaintSurface(new SKPaintSurfaceEventArgs(e.Surface, e.Info));\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n =\u003E thanks to \u0022protected virtual TNativeView CreateNativeView()\u0022 we can now create our very own view - yay!!\r\n\r\nNow the problem you tried to solve by the internal class was to call the \u0022SKCanvasView.OnPaintSurface\u0022 method once the native view was rendered, so skia could work its magic.\r\n\r\nWe solved that by simply creating an interface (which is basically already implemented by all your SkiaSharp views)\r\n\u0060\u0060\u0060\r\n\r\nusing System;\r\nusing SkiaSharp;\r\n#if WINDOWS_UWP\r\nusing SkiaSharp.Views.UWP;\r\n#elif PLATFORM_ANDROID\r\nusing SkiaSharp.Views.Android;\r\n#else\r\nusing SkiaSharp.Views.iOS;\r\n#endif\r\n\r\nnamespace SkiaSharp.Views\r\n{\r\n    public interface IPaintSurface\r\n    {\r\n        event EventHandler\u003CSKPaintSurfaceEventArgs\u003E PaintSurface;\r\n    }\r\n}\r\n\r\n\u0060\u0060\u0060\r\n\r\nso the renderer can forward the rendering using that interface. This is the reason for the generic definition: \r\npublic class SKCanvasViewRendererBase\u003CTFormsView, TNativeView\u003E : ViewRenderer\u003CTFormsView, TNativeView\u003E\r\n        where TNativeView : SKNativeView, **IPaintSurface**\r\n        where TFormsView : SKFormsView\r\n\r\nNow using this base renderer, we can easily create our own one, which uses it own tailor-made native view:\r\n\u0060\u0060\u0060\r\n\r\n[assembly: ExportRenderer(typeof( Svg.Editor.Forms.SvgCanvasEditorView), typeof(SvgCanvasEditorViewRenderer))]\r\nnamespace Svg.Editor.Forms.Droid\r\n{\r\n    public class SvgCanvasEditorViewRenderer : SKCanvasViewRendererBase\u003C Svg.Editor.Forms.SvgCanvasEditorView, Svg.Editor.Views.Droid.SvgCanvasEditorView\u003E\r\n    {\r\n     }\r\n}\r\n\r\n\u0060\u0060\u0060\r\n\r\nFor a running example, look at our \u0022uwp_ios\u0022 branch: https://github.com/gentledepp/SVG/tree/uwp_ios\r\n\r\n;-)",
  "author": {
    "login": "gentledepp",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "milestone": "1.57.1",
  "createdAt": "2017-03-08T09:26:34",
  "updatedAt": "2022-08-19T21:02:22",
  "closedAt": "2017-04-23T18:05:35",
  "commentCount": 8,
  "reactionCount": 1,
  "engagement": {
    "syncedAt": "2026-02-04T20:36:33.7512992Z",
    "reactions": [
      {
        "user": "pnp0a03",
        "content": "\u002B1",
        "createdAt": "2026-02-04T20:36:33.7517419Z"
      }
    ],
    "comments": [
      {
        "id": 285007510,
        "author": "mattleibow",
        "createdAt": "2017-03-08T10:40:33",
        "reactions": []
      },
      {
        "id": 285008331,
        "author": "gentledepp",
        "createdAt": "2017-03-08T10:44:04",
        "reactions": []
      },
      {
        "id": 285009503,
        "author": "mattleibow",
        "createdAt": "2017-03-08T10:49:41",
        "reactions": []
      },
      {
        "id": 285009671,
        "author": "gentledepp",
        "createdAt": "2017-03-08T10:50:34",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:36:32.9030876Z"
          }
        ]
      },
      {
        "id": 285051930,
        "author": "gentledepp",
        "createdAt": "2017-03-08T14:17:20",
        "reactions": []
      },
      {
        "id": 288550490,
        "author": "mattleibow",
        "createdAt": "2017-03-22T21:48:05",
        "reactions": []
      },
      {
        "id": 288927892,
        "author": "mattleibow",
        "createdAt": "2017-03-24T04:02:55",
        "reactions": [
          {
            "user": "gentledepp",
            "content": "hooray",
            "createdAt": "2026-02-04T20:36:33.5099322Z"
          },
          {
            "user": "gentledepp",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:36:33.5099325Z"
          },
          {
            "user": "pnp0a03",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:36:33.5099326Z"
          },
          {
            "user": "pnp0a03",
            "content": "hooray",
            "createdAt": "2026-02-04T20:36:33.5099327Z"
          }
        ]
      },
      {
        "id": 296469238,
        "author": "mattleibow",
        "createdAt": "2017-04-23T18:05:35",
        "reactions": []
      }
    ]
  }
}