{
  "number": 3388,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKGLView High Memory Usage and Memory Issues on iOS",
  "body": "\u003C!-- Failed to upload \u0022Memgraphs.zip\u0022 --\u003E\n\n### Description\n\nI have a simple page that is just a SKGLView with a black background and a filled red circle in the center.  I realize this isn\u0027t a proper use case for an SKGLView.  This is just to illustrate what I am seeing in as simple of a way as possible.  On iOS, each time we open an SKGLView memory usage of the application goes up over 100 MB.  Per the attached memgraphs, there are 3 memory allocations IOAccelerator (graphics) ( 1 page ).  2 are 42.05 MB, and the 3rd is 11.69 MB.  The first issue is that this seems like a bunch of memory for such a simple use of SKGLView.  Is there a way to significantly reduce this foot print?  Based on what is being done, 11 or 22 seems more appropriate for this view and possible a second buffer.\n\n The first time we instantiate a SKGLView, that 100 MB never seems to be cleaned up.  We forced GCs, and the memory sticks around.  How do we clean that memory up?\n\nFinally, it looks like IDisposable is implemented on these classes, but I don\u0027t see Dispose ever being called.  It looks like cleanup is based on finalizers running.  This presents a problem because a very large majority of the over 100 MB allocated is native memroy.  The managed memory is negligible, so the garbage collector never sees the pressure, and thus, doesn\u0027t run.  Therefore, the finalizers aren\u0027t run, and the native memory continue to take up space looking like a memory leak.  Or, the objects holding references to these native objects survive collections promoting them to higher generations causing them to stick around quite a bit longer than we desire since higher generations may not be cleaned as much.  Each time we leave the page with the SKGLView and re-enter it, another allocation of over 100 MB is made.  It doesn\u0027t take many times of going into the page and backing out for memory to get into the GB range and eventually crash the application.  We do see cleanup if iOS gives us a memory warning spawning a GC or if we force a GC, but I don\u0027t want to force a GC every time I back out of a page with a SKGLView.  Is there a way this native memory can be cleaned up as soon as the view is no longer needed?\n\nTo resolve our problem, we switched to an SKCanvasView\n\n\n\n### Code\n\n\n# App\n\n## App.xaml.cs\n\n\u0060\u0060\u0060csharp\nnamespace SkiaSharpPlayground;\n\npublic partial class App : Application\n{\n    public App()\n    {\n        InitializeComponent();\n    }\n\n    protected override Window CreateWindow(IActivationState? activationState)\n    {\n        var page = new NavigationPage(new MainPage());\n        return new Window(page);\n    }\n}\n\u0060\u0060\u0060\n\n# MauiProgram\n\n## MauiProgram.cs\n\n\u0060\u0060\u0060csharp\nusing Microsoft.Extensions.Logging;\nusing SkiaSharp.Views.Maui.Controls.Hosting;\n\nnamespace SkiaSharpPlayground;\n\npublic static class MauiProgram\n{\n    public static MauiApp CreateMauiApp()\n    {\n        var builder = MauiApp.CreateBuilder();\n        builder\n            .UseMauiApp\u003CApp\u003E()\n            .ConfigureFonts(fonts =\u003E\n            {\n                fonts.AddFont(\u0022OpenSans-Regular.ttf\u0022, \u0022OpenSansRegular\u0022);\n                fonts.AddFont(\u0022OpenSans-Semibold.ttf\u0022, \u0022OpenSansSemibold\u0022);\n            })\n            .UseSkiaSharp();\n\n#if DEBUG\n        builder.Logging.AddDebug();\n#endif\n\n        return builder.Build();\n    }\n}\n\u0060\u0060\u0060\n\n# MainPage\n\n## MainPage.xaml\n\n\u0060\u0060\u0060xml\n\u003C?xml version=\u00221.0\u0022 encoding=\u0022utf-8\u0022 ?\u003E\n\u003CContentPage xmlns=\u0022http://schemas.microsoft.com/dotnet/2021/maui\u0022\n             xmlns:x=\u0022http://schemas.microsoft.com/winfx/2009/xaml\u0022\n             x:Class=\u0022SkiaSharpPlayground.MainPage\u0022\u003E\n    \u003CGrid Margin=\u002210, 20,10, 0\u0022\n          ColumnDefinitions=\u0022*\u0022\n          RowDefinitions=\u0022Auto, Auto, Auto\u0022\n          RowSpacing=\u002210\u0022\u003E\n        \u003CButton Grid.Row=\u00220\u0022\n                Grid.Column=\u00220\u0022\n                Text=\u0022Open Canvas View\u0022 \n                Clicked=\u0022OnOpenCanvasViewClicked\u0022/\u003E\n        \u003CButton Grid.Row=\u00221\u0022\n                Grid.Column=\u00220\u0022\n                Text=\u0022Open GL View\u0022 \n                Clicked=\u0022OnOpenGLViewClicked\u0022/\u003E\n        \u003CButton Grid.Row=\u00222\u0022\n                Grid.Column=\u00220\u0022\n                Text=\u0022Force GC.Collect()\u0022 \n                Clicked=\u0022OnForceGCClicked\u0022/\u003E\n    \u003C/Grid\u003E\n\u003C/ContentPage\u003E\n\u0060\u0060\u0060\n\n## MainPage.xaml.cs\n\n\u0060\u0060\u0060csharp\nusing Microsoft.Maui.Controls.PlatformConfiguration;\nusing Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;\nusing SkiaSharp;\nusing SkiaSharp.Views.Maui;\nusing SkiaSharp.Views.Maui.Controls;\nusing SkiaSharp.Views.Maui.Controls.Hosting;\n\nnamespace SkiaSharpPlayground;\n\npublic partial class MainPage\n{\n    public MainPage()\n    {\n        On\u003CiOS\u003E().SetUseSafeArea(true);\n        InitializeComponent();\n    }\n\n    private async void OnOpenCanvasViewClicked(object sender, EventArgs e)\n    {\n        \n        await Navigation.PushAsync(new CanvasViewTest());\n    }\n\n    private async void OnOpenGLViewClicked(object sender, EventArgs e)\n    {\n        // TODO: Implement GL View navigation or logic\n        await Navigation.PushAsync(new GLViewTest());\n    }\n\n    private void OnForceGCClicked(object sender, EventArgs e)\n    {\n        Console.WriteLine(\u0022MJF - Forcing GC.Collect()\u0022);\n        GC.Collect();\n        GC.WaitForPendingFinalizers();\n        GC.Collect();\n        Console.WriteLine(\u0022MJF - GC.Collect() completed\u0022);\n    }\n}\n\u0060\u0060\u0060\n\n# GLViewTest\n\n## GLViewTest.xaml\n\n\u0060\u0060\u0060xml\n\u003C?xml version=\u00221.0\u0022 encoding=\u0022utf-8\u0022?\u003E\n\u003CContentPage xmlns=\u0022http://schemas.microsoft.com/dotnet/2021/maui\u0022\n             xmlns:x=\u0022http://schemas.microsoft.com/winfx/2009/xaml\u0022\n             xmlns:skia=\u0022clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls\u0022\n             x:Class=\u0022SkiaSharpPlayground.GLViewTest\u0022\u003E\n    \u003Cskia:SKGLView x:Name=\u0022glView\u0022 PaintSurface=\u0022OnGLViewPaintSurface\u0022 \n                   HasRenderLoop=\u0022false\u0022/\u003E\n\u003C/ContentPage\u003E\n\u0060\u0060\u0060\n\n## GLViewTest.xaml.cs\n\n\u0060\u0060\u0060csharp\nusing System;\nusing SkiaSharp;\nusing SkiaSharp.Views.Maui;\nusing SkiaSharp.Views.Maui.Controls;\n\nnamespace SkiaSharpPlayground;\n\npublic partial class GLViewTest : ContentPage\n{\n    public GLViewTest() =\u003E InitializeComponent();\n    \n    private void OnGLViewPaintSurface(object sender, SKPaintGLSurfaceEventArgs e)\n    {\n        var canvas = e.Surface.Canvas;\n        canvas.Clear(SKColors.Black);\n        using var paint = new SKPaint\n        {\n            Color = SKColors.Red,\n            IsAntialias = true\n        };\n        float cx = e.BackendRenderTarget.Width / 2f;\n        float cy = e.BackendRenderTarget.Height / 2f;\n        float radius = Math.Min(e.BackendRenderTarget.Width, e.BackendRenderTarget.Height) / 4f;\n        canvas.DrawCircle(cx, cy, radius, paint);\n    }\n}\n\u0060\u0060\u0060\n\n\n\n### Expected Behavior\n\nMemory usage for an SKGLView should be down around the 10 to 20 MB range.\n\nThe native memory used by the SKGLView should be cleaned up when the view is disconnected from the handler.\n\n### Actual Behavior\n\nMemory usage is over 100 MB per SKGLView\n\nMemory isn\u0027t cleaned up until a GC is run, and the memory allocated by the first SKGLView is never clean dup.\n\n### Version of SkiaSharp\n\n3.116.0 (Current)\n\n### Last Known Good Version of SkiaSharp\n\n2.88.9 (Previous)\n\n### IDE / Editor\n\nOther (Please indicate in the description)\n\n### Platform / Operating System\n\niOS\n\n### Platform / Operating System Version\n\niOS 18.5\nSkia Sharp for Maui 3.119.0\nMaui version 9.0.10\nXcode 16.4\n\n### Devices\n\niPhone 14 Pro\niPhone 16\n\n### Relevant Screenshots\n\n_No response_\n\n### Relevant Log Output\n\n\u0060\u0060\u0060shell\n\n\u0060\u0060\u0060\n\n### Code of Conduct\n\n- [x] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "mongosr2",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "os/iOS",
      "color": "fbca04"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    },
    {
      "name": "area/SkiaSharp.Views.Maui",
      "color": "0052cc"
    },
    {
      "name": "tenet/performance",
      "color": "BFD4F2"
    }
  ],
  "assignees": [],
  "createdAt": "2025-10-20T19:01:22",
  "updatedAt": "2025-10-22T01:10:01",
  "closedAt": "2025-10-22T01:10:01",
  "commentCount": 1,
  "reactionCount": 0
}