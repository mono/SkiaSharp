{
  "number": 1502,
  "type": "issue",
  "state": "closed",
  "title": "[QUESTION] Creating a SKSurface from a VkImage backed GRBackendRenderTarget.",
  "body": "\u003C!--\r\n\r\nYou can ask questions here, but there might be better places to do that as well:\r\n\r\n - If you have questions on how to use SkiaSharp with .NET, this is the best place.\r\n - If you have questions on how to draw a picture, but need some suggestions, there is the community to help:\r\n    - StackOverflow: https://stackoverflow.com/questions/tagged/skiasharp\r\n    - Xamarin Forums: https://forums.xamarin.com\r\n    - Gitter.im Chat: https://gitter.im/xamarin/XamarinComponents\r\n - If you have questions on skia, or need to ask more advanced questions about the native API, the skia Group is the place to go: https://groups.google.com/forum/#!forum/skia-discuss\r\n\r\nBut... If you still aren\u0027t sure about where to ask your question, then go ahead and ask here! We will try and answer you, but if we can\u0027t, then we will help you get the answers you want.\r\n\r\n--\u003E\r\nHello. I\u0027ve been trying to create a sksurface from a vkimage, but I always get \u0060null\u0060 when I call \u0060SKSurface.Create(GRContext context, GRBackendRenderTarget renderTarget, GRSurfaceOrigin origin, SKColorType colorType)\u0060. I\u0027ve already set up the vulkan pipeline and objects, and I have created a rendertarget to use as surface, with the following code\r\n\u0060\u0060\u0060\r\n _skiaTextureMemory?.Free();\r\n                _skiaTexture?.Dispose();\r\n\r\n                _skiaTexture = device.CreateImage(\r\n                    ImageType.Image2d,\r\n                    Format.R8G8B8A8Srgb,\r\n                    new Extent3D((uint)size.Width, (uint)size.Height, 1),\r\n                    9,\r\n                    1,\r\n                    SampleCountFlags.SampleCount1,\r\n                    ImageTiling.Optimal,\r\n                    ImageUsageFlags.ColorAttachment | ImageUsageFlags.TransferDestination | ImageUsageFlags.Sampled,\r\n                    SharingMode.Exclusive,\r\n                    new[] { _queueFamilies.GraphicsFamily.Value },\r\n                    ImageLayout.Undefined\r\n                    );\r\n\r\n                MemoryRequirements memoryRequirements = _skiaTexture.GetMemoryRequirements();\r\n\r\n                _skiaTextureMemory = device.AllocateMemory(memoryRequirements.Size,\r\n                    FindMemoryType(memoryRequirements.MemoryTypeBits, MemoryPropertyFlags.DeviceLocal));\r\n\r\n                _skiaTexture.BindMemory(_skiaTextureMemory, 0);\r\n\r\n                var transitCmdb = device.AllocateCommandBuffer(commandPool, CommandBufferLevel.Primary);\r\n\r\n                transitCmdb.Begin(CommandBufferUsageFlags.OneTimeSubmit);\r\n\r\n                var subresourceRange = new ImageSubresourceRange(ImageAspectFlags.Color, 0, 9, 0, 1);\r\n\r\n                var barrier = new ImageMemoryBarrier()\r\n                {\r\n                    SourceAccessMask = 0,\r\n                    DestinationAccessMask = 0,\r\n                    OldLayout = ImageLayout.Undefined,\r\n                    NewLayout = ImageLayout.ColorAttachmentOptimal,\r\n                    SourceQueueFamilyIndex = SharpVk.Constants.QueueFamilyIgnored,\r\n                    DestinationQueueFamilyIndex = SharpVk.Constants.QueueFamilyIgnored,\r\n                    Image = _skiaTexture,\r\n                    SubresourceRange = subresourceRange\r\n                };\r\n\r\n                transitCmdb.PipelineBarrier(PipelineStageFlags.TopOfPipe, PipelineStageFlags.AllCommands, null, null, new[] { barrier });\r\n\r\n                transitCmdb.End();\r\n\r\n                graphicsQueue.Submit(new[] { new SubmitInfo() { CommandBuffers = new[] { transitCmdb }, } }, null);\r\n                graphicsQueue.WaitIdle();\r\n\r\n                commandPool.FreeCommandBuffers(new[] { transitCmdb });\r\n\r\n                GRVkImageInfo imageInfo = new GRVkImageInfo()\r\n                {\r\n                    CurrentQueueFamily = _queueFamilies.GraphicsFamily.Value,\r\n                    Format = (uint)surfaceFormat.Format,\r\n                    Image = _skiaTexture.RawHandle.ToUInt64(),\r\n                    ImageLayout = (uint)ImageLayout.ColorAttachmentOptimal,\r\n                    ImageTiling = (uint)ImageTiling.Optimal,\r\n                    LevelCount = 9,\r\n                    Protected = false,\r\n                    Alloc = new GRVkAlloc()\r\n                    {\r\n                        Memory = _skiaTextureMemory.RawHandle.ToUInt64(),\r\n                        Flags = 0,\r\n                        Offset = 0,\r\n                        Size = memoryRequirements.Size\r\n                    }\r\n                };\r\n\r\n                _renderTarget = new GRBackendRenderTarget((int)size.Width, (int)size.Height, 1, imageInfo)\r\n\u0060\u0060\u0060\r\nMy rendertarget returns \u0060true\u0060 for \u0060IsValid\u0060, but it still doesn\u0027t create a surface.\r\nI can create a surface with \u0060SKSurface.Create(GRContext context, bool budgeted, SKImageInfo imageInfo)\u0060, but I have no way to get the image handle to submit it for presentation.",
  "author": {
    "login": "emmauss",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2020-09-18T22:12:37",
  "updatedAt": "2022-08-19T03:01:51",
  "closedAt": "2020-09-19T11:09:09",
  "commentCount": 2,
  "reactionCount": 0
}