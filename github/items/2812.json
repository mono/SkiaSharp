{
  "number": 2812,
  "type": "issue",
  "state": "closed",
  "title": "[CRASH]  System.NullReferenceException when Invalidating an SKGLView after porting Xamarin.Forms app to MAUI",
  "body": "### Description\r\n\r\nI\u0027m seeing crashes on Production when manually invalidating a SKGLView (HasRenderLoop is false) on a timer (every 16.7 ms) on an app that was ported from Xamarin.Forms to MAUI. I\u0027ve never seen this crash once on Forms and did not make any code change on this control when porting to MAUI. I cannot reproduce the issue myself either.\r\n\r\nThe stack trace looks like this:\r\n\r\n\u0060\u0060\u0060\r\nSkiaSharp.Views.Maui.Controls.Compatibility.SKGLViewRendererBase\u00602[[SkiaSharp.Views.Maui.Controls.SKGLView, SkiaSharp.Views.Maui.Controls, Version=2.88.0.0, Culture=neutral, PublicKeyToken=null],[SkiaSharp.Views.Android.SKGLTextureView, SkiaSharp.Views.Android, Version=2.88.0.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756]].OnSurfaceInvalidated(Object sender, EventArgs eventArgs)\r\nSkiaSharp.Views.Maui.Controls.SKGLView.InvalidateSurface()\r\nSueca.Forms.FormsPages.GamePage.\u003CTimer_Elapsed\u003Eb__16_0()\r\nMicrosoft.Maui.Dispatching.Dispatcher.\u003C\u003Ec__DisplayClass4_0.\u003CDispatchImplementation\u003Eb__0()\r\nJava.Lang.Thread.RunnableImplementor.Run()\r\nJava.Lang.IRunnableInvoker.n_Run(IntPtr jnienv, IntPtr native__this)\r\nAndroid.Runtime.JNINativeWrapper.Wrap_JniMarshal_PP_V(_JniMarshal_PP_V callback, IntPtr jnienv, IntPtr klazz)\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Code\r\n\u0060\u0060\u0060cs\r\n  protected override void OnPaintSurface(SKPaintGLSurfaceEventArgs e)\r\n  {\r\n    \r\n      if (drawing)\r\n          return;\r\n\r\n      try\r\n      {\r\n         \r\n\r\n          drawing = true;\r\n\r\n\r\n              if(e.Surface == null)\r\n              {\r\n                  Analytics.TrackEvent(\u0022Surface is null\u0022);\r\n                  return;\r\n              }\r\n              \r\n\r\n              var canvas = e.Surface.Canvas;\r\n\r\n              if (canvas == null)\r\n              {\r\n                  Analytics.TrackEvent(\u0022Canvas is null\u0022);\r\n                  return;\r\n              }\r\n\r\n              canvas.Clear();\r\n\r\n              if ((Cards == null || Cards.Count == 0) \u0026\u0026 (PlayedCards == null || PlayedCards.Count == 0) || (UserCards == null || UserCards.Count == 0))\r\n                  return;\r\n\r\n\r\n          try\r\n          {\r\n              AllButPlayedCards = Cards?.Where(x =\u003E !PlayedCards.Contains(x)).ToList();\r\n          }\r\n          catch(Exception ex)\r\n          {\r\n              Crashes.TrackError(ex, null, ErrorAttachmentLog.AttachmentWithText(\u0022Cards is Null\u0022, string.Empty));\r\n              return;\r\n          }\r\n\r\n              for (int index = 0; index \u003C AllButPlayedCards.Count; index\u002B\u002B)\r\n              {\r\n                  if (index \u003C AllButPlayedCards.Count \u0026\u0026 AllButPlayedCards[index] != null)\r\n                  {\r\n\r\n\r\n                      using (new SKAutoCanvasRestore(canvas, true))\r\n                      {\r\n                          try\r\n                          {\r\n                              AllButPlayedCards[index].DrawCard(canvas);\r\n                          }\r\n\r\n                          catch (Exception ex)\r\n                          {\r\n\r\n                              Crashes.TrackError(ex, null, ErrorAttachmentLog.AttachmentWithText(\u0022Error on AllButPlayedCards\u0022, \u0022TableCanvas\u0022));\r\n\r\n                          }\r\n                      }\r\n                  }       \r\n              }\r\n\r\n              for (int index = 0; index \u003C PlayedCards.Count; index\u002B\u002B)\r\n              {\r\n                  if (index \u003C PlayedCards.Count \u0026\u0026 PlayedCards[index] != null)\r\n                  {\r\n\r\n                      using (new SKAutoCanvasRestore(canvas, true))\r\n                      {\r\n                          try\r\n                          {\r\n                              if (drawPlayedCards)\r\n                              {\r\n                                  PlayedCards[index].DrawCard(canvas);\r\n                              }\r\n\r\n                          }\r\n                          catch (Exception ex)\r\n                          {\r\n                              Crashes.TrackError(ex, null, ErrorAttachmentLog.AttachmentWithText(\u0022Error on PlayedCards\u0022, \u0022TableCanvas\u0022));\r\n                          }\r\n                      }\r\n                  }\r\n              }\r\n         \r\n      }\r\n\r\n      catch (Exception ex)\r\n      {\r\n          Crashes.TrackError(ex, null, ErrorAttachmentLog.AttachmentWithText(\u0022Error when drawing\u0022, \u0022TableCanvas\u0022));\r\n      }\r\n      finally\r\n      {\r\n          drawing = false;\r\n      }\r\n\r\n  }\r\n\u0060\u0060\u0060\r\n\r\n### Expected Behavior\r\n\r\nThere should not be a a null pointer exception.\r\n\r\n### Actual Behavior\r\n\r\n0.05% of users are experiencing this crash.\r\n\r\n### Version of SkiaSharp\r\n\r\n2.88.3 (Current)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\n2.88.2 (Previous)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nAndroid\r\n\r\n### Platform / Operating System Version\r\n\r\nAndroid 14 \u0026 Android 13\r\n\r\n### Devices\r\n\r\nSamsung Galaxy A13, Samsung Galaxy A34 5G, Samsung Galaxy A54 5G, Samsung Galaxy S20 FE 5G  \r\n\r\n### Relevant Screenshots\r\n\r\n_No response_\r\n\r\n### Relevant Log Output\r\n\r\n\u0060\u0060\u0060shell\r\nSkiaSharp.Views.Maui.Controls.Compatibility.SKGLViewRendererBase\u00602[[SkiaSharp.Views.Maui.Controls.SKGLView, SkiaSharp.Views.Maui.Controls, Version=2.88.0.0, Culture=neutral, PublicKeyToken=null],[SkiaSharp.Views.Android.SKGLTextureView, SkiaSharp.Views.Android, Version=2.88.0.0, Culture=neutral, PublicKeyToken=0738eb9f132ed756]].OnSurfaceInvalidated(Object sender, EventArgs eventArgs)\r\nSkiaSharp.Views.Maui.Controls.SKGLView.InvalidateSurface()\r\nSueca.Forms.FormsPages.GamePage.\u003CTimer_Elapsed\u003Eb__16_0()\r\nMicrosoft.Maui.Dispatching.Dispatcher.\u003C\u003Ec__DisplayClass4_0.\u003CDispatchImplementation\u003Eb__0()\r\nJava.Lang.Thread.RunnableImplementor.Run()\r\nJava.Lang.IRunnableInvoker.n_Run(IntPtr jnienv, IntPtr native__this)\r\nAndroid.Runtime.JNINativeWrapper.Wrap_JniMarshal_PP_V(_JniMarshal_PP_V callback, IntPtr jnienv, IntPtr klazz)\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "Picao84",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-03-28T10:55:17",
  "updatedAt": "2024-04-24T09:02:54",
  "closedAt": "2024-04-24T09:02:54",
  "commentCount": 4,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T20:14:53.1978388Z",
    "reactions": [],
    "comments": [
      {
        "id": 2025319370,
        "author": "mattleibow",
        "createdAt": "2024-03-28T14:22:56",
        "reactions": []
      },
      {
        "id": 2025323065,
        "author": "mattleibow",
        "createdAt": "2024-03-28T14:23:57",
        "reactions": []
      },
      {
        "id": 2074441278,
        "author": "taublast",
        "createdAt": "2024-04-24T08:56:28",
        "reactions": []
      },
      {
        "id": 2074453920,
        "author": "Picao84",
        "createdAt": "2024-04-24T09:02:36",
        "reactions": []
      }
    ]
  }
}