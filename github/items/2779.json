{
  "number": 2779,
  "type": "issue",
  "state": "open",
  "title": "Remove the native interop in SKMatrix",
  "body": "### Description\r\n\r\nCurrently the \u0060SKMatrix\u0060 type is a semi-C# semi-interop type where the main 9 values are in C#, but to do anything meaningful it has to go ask C\u002B\u002B - and this is expensive..\r\n\r\nFor example, this benchmark:\r\n\r\n\u0060\u0060\u0060cs\r\nSKMatrix TheSKMatrix = SKMatrix.CreateRotation(0.7f, 10, 20);\r\nMatrix4x4 TheMatrix4x4 = Matrix4x4.CreateFromAxisAngle(new Vector3(10, 20, 30), 0.7f);\r\nSKMatrix44 TheSKMatrix44 = SKMatrix44.CreateRotation(10, 20, 30, 0.7f);\r\n\r\n[Benchmark(Baseline = true)]\r\npublic SKMatrix InvertUsingSKMatrix()\r\n{\r\n\tvar inverted = TheSKMatrix.Invert();\r\n\treturn inverted;\r\n}\r\n\r\n[Benchmark]\r\npublic Matrix4x4 InvertUsingMatrix4x4()\r\n{\r\n\tMatrix4x4.Invert(TheMatrix4x4, out var inverted);\r\n\treturn inverted;\r\n}\r\n\r\n[Benchmark]\r\npublic SKMatrix44 InvertUsingSKMatrix44()\r\n{\r\n\tvar inverted = TheSKMatrix44.Invert();\r\n\treturn inverted;\r\n}\r\n\u0060\u0060\u0060\r\n\r\nWe can see the massive difference just calculating the invert:\r\n\r\n\u0060\u0060\u0060\r\n// * Summary *\r\n\r\n|                Method |     Mean |    Error |   StdDev | Ratio | Allocated | Alloc Ratio |\r\n|---------------------- |---------:|---------:|---------:|------:|----------:|------------:|\r\n|   InvertUsingSKMatrix | 45.30 ns | 0.902 ns | 1.482 ns |  1.00 |         - |          NA |\r\n|  InvertUsingMatrix4x4 | 19.20 ns | 0.409 ns | 0.573 ns |  0.42 |         - |          NA |\r\n| InvertUsingSKMatrix44 | 22.52 ns | 0.334 ns | 0.279 ns |  0.49 |         - |          NA |\r\n\r\n// * Hints *\r\nOutliers\r\n  TheBenchmark.InvertUsingSKMatrix: .NET 7.0   -\u003E 2 outliers were removed (50.70 ns, 52.08 ns)\r\n  TheBenchmark.InvertUsingSKMatrix44: .NET 7.0 -\u003E 2 outliers were removed (26.43 ns, 27.48 ns)\r\n\u0060\u0060\u0060\r\n\r\nBasically half the time - and \u0060SKMatrix44\u0060 is converting from \u0060SKMatrix44\u0060 to \u0060Matrix4x4\u0060, then running the invert, and then converting back to \u0060SKMatrix44\u0060. It is slower than raw \u0060Matrix4x4\u0060, but still 49% of the time.\r\n\r\nCompared to a simple C# operation benchmark:\r\n\r\n\u0060\u0060\u0060cs\r\n[Benchmark(Baseline = true)]\r\npublic SKMatrix CreateUsingSKMatrix()\r\n{\r\n\treturn SKMatrix.CreateRotation(0.7f, 10, 20);\r\n}\r\n\r\n[Benchmark]\r\npublic Matrix4x4 CreateUsingMatrix4x4()\r\n{\r\n\treturn Matrix4x4.CreateFromAxisAngle(new Vector3(10, 20, 30), 0.7f);\r\n}\r\n\r\n[Benchmark]\r\npublic SKMatrix44 CreateUsingSKMatrix44()\r\n{\r\n\treturn SKMatrix44.CreateRotation(10, 20, 30, 0.7f);\r\n}\r\n\u0060\u0060\u0060\r\n\r\nThis has very similar results:\r\n\r\n\u0060\u0060\u0060\r\n// * Summary *\r\n\r\n|                Method |     Mean |    Error |   StdDev | Ratio | RatioSD | Allocated | Alloc Ratio |\r\n|---------------------- |---------:|---------:|---------:|------:|--------:|----------:|------------:|\r\n|   CreateUsingSKMatrix | 15.17 ns | 0.318 ns | 0.282 ns |  1.00 |    0.00 |         - |          NA |\r\n|  CreateUsingMatrix4x4 | 17.99 ns | 0.385 ns | 0.361 ns |  1.19 |    0.03 |         - |          NA |\r\n| CreateUsingSKMatrix44 | 18.40 ns | 0.389 ns | 0.463 ns |  1.22 |    0.04 |         - |          NA |\r\n\r\n// * Hints *\r\nOutliers\r\n  TheBenchmark.CreateUsingSKMatrix: .NET 7.0   -\u003E 1 outlier  was  removed (17.91 ns)\r\n  TheBenchmark.CreateUsingSKMatrix44: .NET 7.0 -\u003E 1 outlier  was  detected (18.98 ns)\r\n\u0060\u0060\u0060\r\n\r\n\u0060\u0060\u0060\r\nBenchmarkDotNet=v0.13.5, OS=Windows 11 (10.0.22631.3155)\r\nIntel Core i9-9980HK CPU 2.40GHz, 1 CPU, 16 logical and 8 physical cores\r\n.NET SDK=8.0.200\r\n  [Host]   : .NET 7.0.16 (7.0.1624.6629), X64 RyuJIT AVX2\r\n  .NET 7.0 : .NET 7.0.16 (7.0.1624.6629), X64 RyuJIT AVX2\r\n\r\nJob=.NET 7.0  Runtime=.NET 7.0\r\n\u0060\u0060\u0060",
  "author": {
    "login": "mattleibow",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2024-03-02T19:54:59",
  "updatedAt": "2024-03-10T11:26:34",
  "commentCount": 4,
  "reactionCount": 0
}