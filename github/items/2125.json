{
  "number": 2125,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] \u0060System.AccessViolationException\u0060 thrown when flushing canvas or swapping buffers",
  "body": "**Description**\r\n\r\nI am using GLFW for creating a window and SkiaSharp to draw to that window\u0027s OpenGL context. SkiaSharp suddenly throws \u0060System.AccessViolationException\u0060 exceptions, often without an indication of where it occurred, but it seems to occur either at \u0060SKCanvas.flush()\u0060 or when instructing [GLFW to swap buffers](https://www.glfw.org/docs/latest/group__window.html#ga15a5a1ee5b3c2ca6b15ca209a12efd14).\r\n\r\nThe exception is thrown every run, but it is indeterminate how long it takes for the exception to be thrown.\r\n\r\nThe exception message in the Visual Studio \u0022Exception Unhandled\u0022 window that pops up:\r\n\r\n\u003E System.AccessViolationException: \u0027Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\u0027\r\n\r\nDetails after selecting \u0022Copy Details\u0022 in this window:\r\n\r\n\u0060\u0060\u0060\r\nSystem.AccessViolationException\r\n  HResult=0x80004003\r\n  Message=Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\n  Source=\u003CCannot evaluate the exception source\u003E\r\n  StackTrace:\r\n\u003CCannot evaluate the exception stack trace\u003E\r\n\u0060\u0060\u0060\r\n\r\nError message printed to console:\r\n\r\n\u0060\u0060\u0060\r\nFatal error. System.AccessViolationException: Attempted to read or write protected memory. This is often an indication that other memory is corrupt.\r\nRepeat 2 times:\r\n--------------------------------\r\n   at SkiaSharp.SkiaApi.sk_refcnt_safe_unref(IntPtr)\r\n--------------------------------\r\n   at SkiaSharp.SKObjectExtensions.SafeUnRef(SkiaSharp.ISKReferenceCounted)\r\n   at SkiaSharp.SKNativeObject.Dispose(Boolean)\r\n   at SkiaSharp.SKNativeObject.Finalize()\r\n\u0060\u0060\u0060\r\n\r\n**Code**\r\n\r\nI have written my own GLFW bindings in F#, which are used below, but the wrappers below are almost one-to-one with the GLFW functions invoked.\r\n\r\n\u0060\u0060\u0060fsharp\r\nlet mutable width, height = 500, 500\r\nlet mutable framebufferWidth, framebufferHeight = width, height\r\n\r\nlet init = glfwInit()\r\n\r\nglfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3)\r\nglfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3)\r\nglfwWindowHint(GLFW_OPENGL_FORWARD_COMPAT, GLFW_TRUE)\r\nglfwWindowHint(GLFW_OPENGL_PROFILE, 0x00032001)\r\n\r\nlet window = glfwCreateWindow(width, height, \u0022Test Window\u0022, NULL_MONITOR, NULL_WINDOW)\r\n\r\nglfwMakeContextCurrent(window)\r\n\r\nlet grGlInterface = GRGlInterface.Create(getProcAddress)\r\n\r\nif not(grGlInterface.Validate())\r\nthen raise (System.Exception(\u0022Invalid GRGlInterface\u0022))\r\n\r\nlet grContext = GRContext.CreateGl(grGlInterface)\r\n\r\nlet draw(window, width, height) =\r\n    pollEvents()\r\n    grContext.ResetContext()\r\n    let grGlFramebufferInfo = new GRGlFramebufferInfo(0u, uint32(0x8058))\r\n    use grBackendRenderTarget = new GRBackendRenderTarget(width, height, 1, 0, grGlFramebufferInfo)\r\n    let surface = SKSurface.Create(grContext, grBackendRenderTarget, GRSurfaceOrigin.BottomLeft, SKColorType.Rgba8888)\r\n    let canvas = surface.Canvas\r\n    canvas.Clear(SKColors.Cyan)\r\n    use red = new SKPaint(Color = SKColor(byte(255), byte(0), byte(0), byte(255)))\r\n    canvas.DrawCircle(float32(width)/2.0f, float32(height)/2.0f, float32(100), red)\r\n    canvas.Flush()\r\n    glfwSwapBuffers(window)\r\n\r\nwhile not (glfwWindowShouldClose window = 1) do\r\n    glfwGetFramebufferSize(window, \u0026framebufferWidth, \u0026framebufferHeight)\r\n    draw(window, framebufferWidth, framebufferHeight)\r\n    \r\nglfwDestroyWindow(window)\r\nterminate()\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nNo exception.\r\n\r\n**Actual Behavior**\r\n\r\nA \u0060System.AccessViolationException\u0060 exception is thrown, often with no stack trace.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  2.88.0\r\n- Last known good version:  unknown\r\n- IDE:  Visual Studio Community 2022, version 17.2.3\r\n- Platform Target Frameworks: \u003C!-- all that apply, remove the platforms that aren\u0027t broken or haven\u0027t had any testing --\u003E\r\n  - Linux:  I will eventually be targeting Linux, but I have not ran this code at all on Linux yet.\r\n  - macOS:  I will also eventually be targeting macOS, but I have not ran a recent version of my bindings and code on macOS.\r\n  - Windows Classic: Windows 11, OS Build 22000.739. This is where the exception is currently being thrown.\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - PC\r\n  \r\n\u003C!--\u003Cdetails\u003E\r\n  \u003Csummary\u003EDetailed IDE/OS information (click to expand)\u003C/summary\u003E\r\n  \r\n\u0060\u0060\u0060\r\n\r\nPASTE ANY DETAILED VERSION INFO HERE\r\n\r\n\u0060\u0060\u0060\r\n\u003C/details\u003E--\u003E\r\n\r\n\r\n**Screenshots**\r\n\r\nThis is a screenshot of the window and image that\u0027s being drawn:\r\n\r\n![image](https://user-images.githubusercontent.com/65685447/175195589-b7039396-6065-4ec1-9480-00dc5f1afca1.png)\r\n\r\n**Reproduction Link**\r\n\r\n\u003C!-- please upload or provide a link to a reproduction case --\u003E\r\n\r\n~~Unavailable at the moment since the code is in a private repository.~~ [A reproduction is linked here.](https://github.com/mono/SkiaSharp/issues/2125#issuecomment-1170666517)",
  "author": {
    "login": "bmitc",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-06-23T02:44:11",
  "updatedAt": "2024-04-25T03:14:42",
  "closedAt": "2024-04-17T13:13:07",
  "commentCount": 13,
  "reactionCount": 0
}