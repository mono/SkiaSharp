{
  "number": 920,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] Weird crosstalk between multiple canvas when using GPU-accelerated WPF with WindowsFormsHost ",
  "body": "**Description**\r\n\r\nI have a WPF application and I am using SkiaSharp to render my graphics.\r\nThis app creates multiple windows with several layers of big bitmaps and I was hitting a CPU bottleneck that was lowering my framerate down to 8 FPS.\r\nI decided to look into ways to accelerate the rendering by using the GPU.\r\nI tried to adapt the code from the \u0060SkiaSharpSample\u0060 examples that uses a \u0060WindowsFormsHost\u0060 to do the GPU accelerated rendering and, it works for a single window but it starts breaking when I have multiple windows.\r\n\r\nIn my original app, I have my bitmap data stored as \u0060byte[]\u0060 and I thought that there might be some weird pointer-related voodoo going on there, so I decided to simplify my code to the point that all the windows have to do now is to fill the canvas with a solid color.\r\nNonetheless, it still fails to display so the bug must be on SkiaSharp\u0027s side.\r\n\r\nI have looked into issues #665 #688 #745 #755 #764 and I could not find any solution there.\r\nI have also changed the code from https://github.com/freezy/wpf-skia-opengl to work the way I need and it fails in similar ways so it might not be related to the \u0060WindowsFormsHost\u0060 but with \u0060SKGLContext\u0060 or \u0060SKGLControl\u0060 instead, maybe \uD83E\uDD14? .\r\n\r\n\r\n**Code**\r\nThis is the Window that is being rendered in the GPU\r\n\r\n\u0060\u0060\u0060csharp\r\nusing SkiaSharp;\r\nusing SkiaSharp.Views.Desktop;\r\n\r\nusing System;\r\nusing System.ComponentModel;\r\nusing System.Diagnostics;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\nusing System.Windows;\r\nusing System.Windows.Forms.Integration;\r\n\r\nnamespace SkiaSharpGPU\r\n{\r\n    public partial class SkiaSharpSampleWindow : Window\r\n    {\r\n        const int FPS = 10;\r\n\r\n        long previousTicks = 0, currentTicks = 0;\r\n        int interFrameInterval = (int)(1000.0 / FPS);\r\n        double framerate = 0;\r\n        Stopwatch framerateStopwatch = new Stopwatch();\r\n\r\n\r\n        SKPaint paint = new SKPaint()\r\n        {\r\n            TextSize = 20f,\r\n            IsAntialias = true,\r\n            Color = SKColors.White,\r\n            IsStroke = false,\r\n        };\r\n\r\n        int windowID;\r\n        static int lastID = 0;\r\n\r\n        SKColor color;\r\n\r\n\r\n        bool windowIsClosing = false;\r\n\r\n        public SkiaSharpSampleWindow(SKColor windowColor)\r\n        {\r\n            InitializeComponent();\r\n\r\n            windowID = lastID\u002B\u002B;\r\n            Title = windowID.ToString();\r\n            color = windowColor;\r\n\r\n            framerateStopwatch.Start();\r\n        }\r\n\r\n\r\n        private void Window_Loaded(object sender, RoutedEventArgs e) =\u003E new Task(UpdateLoop).Start();\r\n\r\n        private void Window_Closing(object sender, CancelEventArgs e) =\u003E windowIsClosing = true;\r\n\r\n\r\n        private void UpdateLoop()\r\n        {\r\n            Thread.CurrentThread.Name = windowID.ToString();\r\n\r\n            while (!windowIsClosing)\r\n            {\r\n                Thread.Sleep(interFrameInterval);\r\n                Dispatcher.Invoke(glhost.Child.Invalidate);\r\n                //Dispatcher.Invoke(skelement.InvalidateVisual);\r\n            }\r\n\r\n            Console.WriteLine($\u0022Window {windowID} terminated.\u0022);\r\n        }\r\n\r\n\r\n        private void OnGLControlHost(object sender, EventArgs e)\r\n        {\r\n            var glControl = new SKGLControl();\r\n            glControl.PaintSurface \u002B= OpenGL_PaintSurface;\r\n            glControl.Dock = System.Windows.Forms.DockStyle.Fill;\r\n            glControl.Name = \u0022glControl \u0022 \u002B windowID.ToString();\r\n\r\n            var host = (WindowsFormsHost)sender;\r\n            host.Child = glControl;\r\n        }\r\n\r\n        private void OpenGL_PaintSurface(object sender, SKPaintGLSurfaceEventArgs e)\r\n        {\r\n            PaintCanvas(e.Surface.Canvas, e.BackendRenderTarget.Width, e.BackendRenderTarget.Height);\r\n        }\r\n\r\n        private void Skelement_PaintSurface(object sender, SKPaintSurfaceEventArgs e)\r\n        {\r\n            PaintCanvas(e.Surface.Canvas, e.Info.Width, e.Info.Height);\r\n        }\r\n\r\n        private void PaintCanvas(SKCanvas canvas, int width, int height)\r\n        {\r\n            canvas.Clear();\r\n\r\n            // Draw color\r\n            canvas.DrawColor(color);\r\n\r\n            // Draw window ID\r\n            canvas.DrawText($\u0022ID {windowID}\u0022, 50, 50, paint);\r\n\r\n            //Draw simple FPS counter\r\n            currentTicks = framerateStopwatch.ElapsedTicks;\r\n            framerate = 1000.0 / ((currentTicks - previousTicks) * 1000.0 / Stopwatch.Frequency);\r\n            previousTicks = currentTicks;\r\n            canvas.DrawText($\u0022FPS {framerate:F2}\u0022, 50, 100, paint);\r\n\r\n            //Draw canvas handle\r\n            canvas.DrawText($\u0022Canvas {canvas.Handle}\u0022, 50, 150, paint);\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nI have created a new Window that uses a Task that invalidates the visual elements at a specific frequency.\r\nWhen redrawing the element, it uses a predefined SKColor to fill the SKCanvas and then draws some text with the window ID, current framerate and canvas handle(just for debugging purposes).\r\nThere is a main Window with a button that when pressed creates one these GPU accelerated windows with a given color.\r\nThe expected behavior would be that each window is independent from each other and they are all able to update their color and text info.\r\n\r\n**Actual Behavior**\r\n\r\nWhen opening multiple windows simultaneously, only the last window will display any information the remaining being black.\r\nHorizontally resizing the blacked windows trims the texts on the window that is working as if it was being resized but the background stays colored.\r\nVertically resizing the blacked windows causes the texts on the window that is working to move up and down.\r\n\r\nWhen opening multiple windows taking some time in between, the first two windows open fine, from the third window on, all the windows became corrupted except the first and the most recent ones.\r\nIn this corrupted images, the color and text change randomly between then causing the windows to flicker and the text to be broken.\r\nOnce again resizing the corrupted windows causes the same resizing effects on the most recent window, but this time it blanks the broken window that was resized. \r\n\r\nMy guess is that there is some OpenGL buffer that is being shared across the windows or the canvases but I don\u0027t think there is any way for me to test this unless I go way deeper into the SkiaSharp\u0027s source code which I don\u0027t feel comfortable doing.\r\n\r\n**_I have also tried the same rendering pipeline but using just the standard \u0060SKElement\u0060 with \u0060SKPaintSurfaceEventArgs\u0060  and all the windows work with no problem.\r\nI am not sure if this is related but, when using the \u0060SKElement\u0060 I noticed that the canvas handle changed every frame which does not happen when using the GPU accelerated version._**\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.0\r\n- IDE:  Visual Studio 2019 Community\r\n- Platform Target Frameworks:\r\n  - Windows Classic:  Windows 10 Pro 64bit 1903 \r\n\r\n\r\n**Screenshots**\r\n\r\n_When opening multiple windows simultaneously, only the last one is working even tough the tasks are still requesting the update._\r\n_0 should be red_\r\n_1 should be green_\r\n![multiple_simultaneous_windows](https://user-images.githubusercontent.com/3045079/61976551-030b7e80-afe4-11e9-84ea-6b6301dc5630.png)\r\n\r\n\r\n_By opening one window at a time it is possible to have several windows open._\r\n![2isok](https://user-images.githubusercontent.com/3045079/61976694-5d0c4400-afe4-11e9-8734-4861b9b79ec9.png)\r\n\r\n_Having more than three windows open causes random glitches in the windows._\r\n_Window 5 keeps changing between the correct form (green) and a abnormal version (red)_\r\n![glitches_and_swap](https://user-images.githubusercontent.com/3045079/61976731-7614f500-afe4-11e9-822b-980f11d5b9e2.png)\r\n\r\n\r\n_Resizing broken windows affects the content of other windows_\r\n![resize_issue](https://user-images.githubusercontent.com/3045079/61976832-b3798280-afe4-11e9-910d-5e2ea44a5dd4.png)\r\n\r\n\r\n**Reproduction Link**\r\n\r\n_Code for the classes used in the test project_\r\n[code.zip](https://github.com/mono/SkiaSharp/files/3437138/code.zip)\r\n",
  "author": {
    "login": "AlexandreLaborde",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    },
    {
      "name": "os/Windows-Classic",
      "color": "fbca04"
    },
    {
      "name": "area/SkiaSharp.Views",
      "color": "0052cc"
    },
    {
      "name": "backend/OpenGL",
      "color": "1acea7"
    }
  ],
  "assignees": [],
  "milestone": "v1.68.2",
  "createdAt": "2019-07-26T19:46:48",
  "updatedAt": "2022-08-19T09:02:41",
  "closedAt": "2020-02-11T23:42:25",
  "commentCount": 13,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T20:46:50.9023548Z",
    "reactions": [],
    "comments": [
      {
        "id": 516370704,
        "author": "AlexandreLaborde",
        "createdAt": "2019-07-30T10:58:14",
        "reactions": [
          {
            "user": "Gillibald",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:48.4688623Z"
          },
          {
            "user": "idotta",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:48.468863Z"
          },
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:48.4688631Z"
          }
        ]
      },
      {
        "id": 543890497,
        "author": "idotta",
        "createdAt": "2019-10-18T19:03:12",
        "reactions": []
      },
      {
        "id": 546891793,
        "author": "AlexandreLaborde",
        "createdAt": "2019-10-28T10:48:47",
        "reactions": [
          {
            "user": "FoggyFinder",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:48.9246908Z"
          }
        ]
      },
      {
        "id": 546898875,
        "author": "Gillibald",
        "createdAt": "2019-10-28T11:09:58",
        "reactions": []
      },
      {
        "id": 546905194,
        "author": "AlexandreLaborde",
        "createdAt": "2019-10-28T11:29:19",
        "reactions": []
      },
      {
        "id": 546910792,
        "author": "Gillibald",
        "createdAt": "2019-10-28T11:47:49",
        "reactions": []
      },
      {
        "id": 546914117,
        "author": "AlexandreLaborde",
        "createdAt": "2019-10-28T11:58:21",
        "reactions": []
      },
      {
        "id": 546915949,
        "author": "Gillibald",
        "createdAt": "2019-10-28T12:03:30",
        "reactions": []
      },
      {
        "id": 556387666,
        "author": "mattleibow",
        "createdAt": "2019-11-20T20:59:20",
        "reactions": []
      },
      {
        "id": 583346099,
        "author": "jensbrak",
        "createdAt": "2020-02-07T11:12:54",
        "reactions": []
      },
      {
        "id": 584784939,
        "author": "mattleibow",
        "createdAt": "2020-02-11T18:33:55",
        "reactions": []
      },
      {
        "id": 584813908,
        "author": "AlexandreLaborde",
        "createdAt": "2020-02-11T19:38:54",
        "reactions": []
      },
      {
        "id": 584922313,
        "author": "mattleibow",
        "createdAt": "2020-02-11T23:48:45",
        "reactions": [
          {
            "user": "tebjan",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:50.8520876Z"
          },
          {
            "user": "jensbrak",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:46:50.8520882Z"
          }
        ]
      }
    ]
  }
}