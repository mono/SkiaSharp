{
  "number": 844,
  "type": "issue",
  "state": "open",
  "title": "[BUG] AppKitThreadAccessException thrown on macOS when using SKGLView with HasRenderLoop enabled with Xamarin.Forms.",
  "body": "**Description**\r\n\r\nOn macOS (Mojave 10.14.4 (18E226)), when I use an SKGLView with its HasRenderLoop property enabled with Xamarin.Forms, the following exception is thrown:\r\n\r\n\u0060\u0060\u0060\r\nAppKit.AppKitThreadAccessException has been thrown\r\nAppKit Consistency error: you are calling a method that can only be invoked from the UI thread.\r\n\u0060\u0060\u0060\r\n\r\n**Code**\r\n\r\nThis is happening in [SKGLViewRenderer.cs](https://github.com/mono/SkiaSharp/blob/master/source/SkiaSharp.Views.Forms/SkiaSharp.Views.Forms.Mac/SKGLViewRenderer.cs) when nativeView?.Display() is called inside the displayLink callback because the callback happens from another thread  (i.e., [CVDisplayLink uses another thread](https://developer.apple.com/documentation/corevideo/cvdisplaylink-k0k)). NSView.Display() internally calls NSApplication.EnsureUIThread(), which throws if the thread is not the NSApplication.mainThread.\r\n\r\n\u0060\u0060\u0060\r\n\tprotected override void SetupRenderLoop(bool oneShot)\r\n\t{\r\n\t\t// only start if we haven\u0027t already\r\n\t\tif (displayLink != null)\r\n\t\t\treturn;\r\n\r\n\t\t// bail out if we are requesting something that the view doesn\u0027t want to\r\n\t\tif (!oneShot \u0026\u0026 !Element.HasRenderLoop)\r\n\t\t\treturn;\r\n\r\n\t\t// if this is a one shot request, don\u0027t bother with the display link\r\n\t\tif (oneShot)\r\n\t\t{\r\n\t\t\tvar nativeView = Control;\r\n\t\t\tnativeView?.Display();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// create the loop\r\n\t\tdisplayLink = new CVDisplayLink();\r\n\t\tdisplayLink.SetOutputCallback(delegate\r\n\t\t{\r\n\t\t\t// *** This code here is being called from another thread ***.\r\n\r\n\t\t\tvar nativeView = Control;\r\n\t\t\tvar formsView = Element;\r\n\r\n\t\t\t// redraw the view\r\n\t\t\tnativeView?.Display();\r\n\r\n\t\t\t// stop the render loop if this was a one-shot, or the views are disposed\r\n\t\t\tif (nativeView == null || formsView == null || !formsView.HasRenderLoop)\r\n\t\t\t{\r\n\t\t\t\tdisplayLink.Stop();\r\n\t\t\t\tdisplayLink.Dispose();\r\n\t\t\t\tdisplayLink = null;\r\n\t\t\t}\r\n\r\n\t\t\treturn CVReturn.Success;\r\n\t\t});\r\n\t\tdisplayLink.Start();\r\n\t}\r\n\r\n\u0060\u0060\u0060\r\n**Expected Behavior**\r\n\r\nThe callback should not throw an exception.\r\n\r\n**Actual Behavior**\r\n\r\nThe following exception is thrown during the callback:\r\n\u0060\u0060\u0060\r\nAppKit.AppKitThreadAccessException has been thrown\r\nAppKit Consistency error: you are calling a method that can only be invoked from the UI thread.\r\n\u0060\u0060\u0060\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.1\r\n- IDE:  Visual Studio for Mac 2019 v8.0.5 (Build 9)\r\n- Platform Target Frameworks: \r\n  - macOS:  Mojave 10.14.4\r\n\r\n**Reproduction Link**\r\n\r\nI forked SkiaSharp [here](https://github.com/danien/SkiaSharp/tree/dev/issue-844_SKGLView) and modified the samples/Basic/Xamarin.Forms/SkiaSharpSample\u0027s MainPage.xaml.* files to use SKGLView instead of SKCanvasView.\r\n\r\nYou can open [SkiaSample.Mac.sln](https://github.com/danien/SkiaSharp/tree/master/samples/Basic/Xamarin.Forms), then build and run just the SkiaSharpSample.macOS project.\r\n",
  "author": {
    "login": "danien",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2019-05-18T08:53:48",
  "updatedAt": "2019-06-24T11:41:09",
  "commentCount": 1,
  "reactionCount": 0
}