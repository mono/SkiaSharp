{
  "number": 39,
  "type": "issue",
  "state": "closed",
  "title": "NullReferenceException when creating SkCanvas backed by a WriteableBitmap",
  "body": "The [following code](https://github.com/impsnldavid/skiasharpwpfextensions/blob/master/src/Imp.SkiaSharpWpfExtensions/SkiaControl.cs#L72-L92) from https://github.com/impsnldavid/skiasharpwpfextensions fails randomly with a \u0060NullReferenceException\u0060 when the \u0060SkCanvas\u0060 is constructed.\n\nThe member variable \u0060_bitmap\u0060 is a [WriteableBitmap](https://msdn.microsoft.com/en-us/library/system.windows.media.imaging.writeablebitmap%28v=vs.110%29.aspx)\n\n\u0060\u0060\u0060\n        protected override void OnRender(DrawingContext dc)\n        {\n            if (_bitmap == null)\n                return;\n\n            _bitmap.Lock();\n\n            using (var surface = SKSurface.Create((int)_bitmap.Width, (int)_bitmap.Height, \n                SKColorType.N_32, SKAlphaType.Premul, _bitmap.BackBuffer, _bitmap.BackBufferStride))\n            {\n                if (IsClearCanvas)\n                    surface.Canvas.Clear(_canvasClearColor);\n\n                Draw(surface.Canvas, (int)_bitmap.Width, (int)_bitmap.Height);\n            }\n\n            _bitmap.AddDirtyRect(new Int32Rect(0, 0, (int)_bitmap.Width, (int)_bitmap.Height));\n            _bitmap.Unlock();\n\n            dc.DrawImage(_bitmap, new Rect(0, 0, ActualWidth, ActualHeight));\n                }\n\u0060\u0060\u0060\n\nThe exception randomly occurs on calls to [surface.Canvas.Clear(_canvasClearColor);](https://github.com/impsnldavid/skiasharpwpfextensions/blob/master/src/Imp.SkiaSharpWpfExtensions/SkiaControl.cs#L83)\n\nThe \u0060NullReferenceException\u0060 is wrapped in a \u0060TargetInvocationException\u0060. Here are the call stacks:\n## Inner NullReferenceException Stack Trace\n\n\u0060\u0060\u0060\n   at SkiaSharp.SKObject.RegisterHandle(IntPtr handle, SKObject instance)\n   at SkiaSharp.SKCanvas..ctor(IntPtr handle)\n\u0060\u0060\u0060\n## TargetInvocationException Stack Trace\n\n\u0060\u0060\u0060\n   at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor)\n   at System.Reflection.RuntimeConstructorInfo.Invoke(BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)\n   at SkiaSharp.SKObject.GetObject[TSkiaObject](IntPtr handle)\n   at SkiaSharp.WpfExtensions.SkiaControl.OnRender(DrawingContext dc) in C:\\Users\\_\\Documents\\GitHub\\skiasharpwpfextensions\\src\\Imp.SkiaSharpWpfExtensions\\SkiaControl.cs:line 83\n   at System.Windows.UIElement.Arrange(Rect finalRect)\n   at System.Windows.ContextLayoutManager.UpdateLayout()\n   at System.Windows.ContextLayoutManager.UpdateLayoutCallback(Object arg)\n   at System.Windows.Media.MediaContext.FireInvokeOnRenderCallbacks()\n   at System.Windows.Media.MediaContext.RenderMessageHandlerCore(Object resizedCompositionTarget)\n   at System.Windows.Media.MediaContext.RenderMessageHandler(Object resizedCompositionTarget)\n   at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Int32 numArgs)\n   at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Int32 numArgs, Delegate catchHandler)\n   at System.Windows.Threading.DispatcherOperation.InvokeImpl()\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)\n   at System.Windows.Threading.DispatcherOperation.Invoke()\n   at System.Windows.Threading.Dispatcher.ProcessQueue()\n   at System.Windows.Threading.Dispatcher.WndProcHook(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean\u0026 handled)\n   at MS.Win32.HwndWrapper.WndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam, Boolean\u0026 handled)\n   at MS.Win32.HwndSubclass.DispatcherCallbackOperation(Object o)\n   at System.Windows.Threading.ExceptionWrapper.InternalRealCall(Delegate callback, Object args, Int32 numArgs)\n   at System.Windows.Threading.ExceptionWrapper.TryCatchWhen(Object source, Delegate callback, Object args, Int32 numArgs, Delegate catchHandler)\n   at System.Windows.Threading.Dispatcher.LegacyInvokeImpl(DispatcherPriority priority, TimeSpan timeout, Delegate method, Object args, Int32 numArgs)\n   at MS.Win32.HwndSubclass.SubclassWndProc(IntPtr hwnd, Int32 msg, IntPtr wParam, IntPtr lParam)\n   at MS.Win32.UnsafeNativeMethods.DispatchMessage(MSG\u0026 msg)\n   at System.Windows.Threading.Dispatcher.PushFrameImpl(DispatcherFrame frame)\n   at System.Windows.Application.RunDispatcher(Object ignore)\n   at System.Windows.Application.RunInternal(Window window)\n   at Imp.SkiaSharpWpfExtensions.Example.App.Main() in C:\\Users\\magnu_000\\Documents\\GitHub\\skiasharpwpfextensions\\src\\Imp.SkiaSharpWpfExtensions.Example\\obj\\x64\\Debug\\App.g.cs:line 0\n   at System.AppDomain._nExecuteAssembly(RuntimeAssembly assembly, String[] args)\n   at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)\n   at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()\n   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean preserveSyncCtx)\n   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)\n   at System.Threading.ThreadHelper.ThreadStart()\n\u0060\u0060\u0060\n\nMy guess is that the reason this is happening is the following [lines of code](https://github.com/mono/SkiaSharp/blob/master/binding/Binding/SKObject.cs#L116-L117) in \u0060SKObject\u0060:\n\n\u0060\u0060\u0060\nvar shouldReplace =\n              reference == null ||\n              reference.Target != null ||\n              ((SKObject)reference.Target).Handle == IntPtr.Zero;\n\u0060\u0060\u0060\n\nLets assume that \u0060reference\u0060 is not \u0060null\u0060 but the \u0060Target\u0060 property is. \n- \u0060reference == null\u0060 would be \u0060false\u0060.\n- \u0060reference.Target != null\u0060 would be \u0060false\u0060\n\nSince both the above expressions evaluate to \u0060false\u0060 it is necessary to evaluate the last expression as well. But in this case \u0060Target\u0060 is \u0060null\u0060 and this is what is causing the exception.\n",
  "author": {
    "login": "mgnslndh",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2016-03-05T19:05:07",
  "updatedAt": "2022-08-20T06:01:49",
  "closedAt": "2016-03-07T08:18:09",
  "commentCount": 4,
  "reactionCount": 0
}