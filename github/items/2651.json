{
  "number": 2651,
  "type": "issue",
  "state": "open",
  "title": "Exception when doing snapshot in OnPaintSurface",
  "body": "### Description\r\n\r\nHi there\r\n\r\nI am currently working on a Proof Of Concept project with SkiaSharp. I am very happy with the library, especially that you can use the powerful Skia library with C#. Unfortunately I now get an unhandle exception when using snapshots (mouse move). For the final goal I need a canvas of 8000x2000 pixels. When the canvas is smaller (300x400) the exception is not occuring. I hope someone knows what causes it. It could also be that I don\u0027t really understand the concept yet.\r\n\r\nAlso try to use SaveLayer but was not working as expected!\r\n\r\nPurpose\r\nWant to implement a Drag and drop function with SkiaSharp. \r\n\r\nWhen the mouse moves, a snapshot is taken; then draw what has changed. When the OnPaintSurface has been called 80 times or so, the exception occurs.\r\n\r\n\r\n### Code\r\n\r\n\tprivate void OnPaintSurface(SKPaintSurfaceEventArgs e)\r\n\t{\r\n\t\tvar canvas = e.Surface.Canvas; // 8000x2000\r\n\t\tSKRect rect1 = new SKRect(0, 0, e.Info.Rect.Width, e.Info.Rect.Height);\r\n\r\n\t\tif (firstRun)\r\n\t\t{\r\n\t\t\tDrawBackground(e);\r\n\t\t\tlayerBackGround = e.Surface.Snapshot();\r\n\r\n\t\t\tfirstRun = false;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tcanvas.DrawImage(layerBackGround, rect1);\r\n\r\n\t\t\t// Draw something permanent\r\n\r\n\t\t\tlayerBackGround = e.Surface.Snapshot(); // Here the exception is raised\r\n\r\n\t\t\t// Draw something temporary\r\n\t\t\tusing (SKPaint paint = new SKPaint { Style = SKPaintStyle.Stroke, Color = SKColors.Red })\r\n\t\t\t{\r\n\t\t\t\tcanvas.DrawCircle(mouseLocation, 100, paint);\r\n\t\t\t}\r\n\r\n\t\t\tConsole.WriteLine($\u0022Restore Snapshot Number Restore {counterSnapshots\u002B\u002B}\u0022);\r\n\t\t}\r\n\t}\r\n\r\n\tprivate void OnMouseMove(MouseEventArgs e)\r\n\t{\r\n\t\tmouseLocation = new SKPoint((float)e.OffsetX, (float)e.OffsetY);\r\n\r\n\t\tskiaView.Invalidate();\r\n\t}\r\n\r\n\r\n### Expected Behavior\r\n\r\nNo exception!\r\n\r\npropose a different approach so that the Exception no longer occurs\r\nIt may also be that there is a bug in the SkiaSharp;SkiaSharp.Views.Blazor library \r\n\r\n\r\n### Actual Behavior\r\n\r\n_No response_\r\n\r\n### Version of SkiaSharp\r\n\r\n2.88.3 (Current)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\nOther (Please indicate in the description)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio (Windows)\r\n\r\n### Platform / Operating System\r\n\r\nWindows 11 \r\nChrome\r\n\r\n\r\n### Platform / Operating System Version\r\n\r\n.Net Core 7.0\r\n.Net Core 6.0 Same issue\r\n\r\nPackage\r\nSkiaSharp;\r\nSkiaSharp.Views.Blazor\r\n\r\n### Devices\r\n\r\nBrowser\r\n\r\n### Relevant Screenshots\r\n\r\n_No response_\r\n\r\n### Relevant Log Output\r\n\r\n\u0060\u0060\u0060shell\r\nRestore Snapshot Number Restore 32\r\nRestore Snapshot Number Restore 33\r\nRestore Snapshot Number Restore 34\r\nUncaught Error 63124824\r\n    at ___cxa_throw (localhost\uA7897040/_framework/dotnet.7.0.12.y6rpn8jldv.js:1897:7)\r\n    at $operator new(unsigned long) (wasm/05035f22:1:7760148)\r\n    at $SkData::PrivateNewWithCopy(void const*, unsigned long) (wasm/05035f22:1:253631)\r\n    at $SkData::MakeWithCopy(void const*, unsigned long) (wasm/05035f22:1:253980)\r\n    at $MakeRasterCopyPriv(SkPixmap const\u0026, unsigned int) (wasm/05035f22:1:3344311)\r\n    at $SkMakeImageFromRasterBitmapPriv(SkBitmap const\u0026, SkCopyPixelsMode, unsigned int) (wasm/05035f22:1:3345209)\r\n    at $SkMakeImageFromRasterBitmap(SkBitmap const\u0026, SkCopyPixelsMode) (wasm/05035f22:1:3345552)\r\n    at $SkSurface_Raster::onNewImageSnapshot(SkIRect const*) (wasm/05035f22:1:3347489)\r\n    at $SkSurface::makeImageSnapshot() (wasm/05035f22:1:3351341)\r\n    at $sk_surface_new_image_snapshot (wasm/05035f22:1:5273126)\r\n    at $do_icall (wasm/05035f22:1:5366088)\r\n    at $do_icall_wrapper (wasm/05035f22:1:5361988)\r\n    at $interp_exec_method (wasm/05035f22:1:5299397)\r\n    at $interp_runtime_invoke (wasm/05035f22:1:5294797)\r\n    at $mono_jit_runtime_invoke (wasm/05035f22:1:7352181)\r\n    at $do_runtime_invoke (wasm/05035f22:1:5907916)\r\n    at $mono_runtime_invoke_checked (wasm/05035f22:1:5907796)\r\n    at $mono_runtime_try_invoke_span (wasm/05035f22:1:5927157)\r\n    at $mono_runtime_invoke_span_checked (wasm/05035f22:1:5927774)\r\n    at $ves_icall_InternalInvoke (wasm/05035f22:1:5729477)\r\n    at $ves_icall_InternalInvoke_raw (wasm/05035f22:1:5759520)\r\n    at $do_icall (wasm/05035f22:1:5366277)\r\n    at $do_icall_wrapper (wasm/05035f22:1:5361988)\r\n    at $interp_exec_method (wasm/05035f22:1:5299397)\r\n    at $interp_runtime_invoke (wasm/05035f22:1:5294797)\r\n    at $mono_jit_runtime_invoke (wasm/05035f22:1:7352181)\r\n    at $do_runtime_invoke (wasm/05035f22:1:5907916)\r\n    at $mono_runtime_try_invoke (wasm/05035f22:1:5909851)\r\n    at $mono_runtime_invoke (wasm/05035f22:1:5918698)\r\n    at $mono_wasm_invoke_method_ref (wasm/05035f22:1:7777494)\r\n    at Module._mono_wasm_invoke_method_ref (localhost\uA7897040/_framework/dotnet.7.0.12.y6rpn8jldv.js:8654:129)\r\n    at _Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_InvokeDotNet (dotnet.generated.invalid/_Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_InvokeDotNet:29:5)\r\n    at invokeDotNetFromJS (localhost\uA7897040/_framework/blazor.webassembly.js:1:45224)\r\n    at g (localhost\uA7897040/_framework/blazor.webassembly.js:1:1621)\r\n    at invokeMethod (localhost\uA7897040/_framework/blazor.webassembly.js:1:3812)\r\n    at \u003Canonymous\u003E (C:\\Users\\r.gombert\\.nuget\\packages\\skiasharp.views.blazor\\2.88.6\\staticwebassets\\SKHtmlCanvas.js:104:38)\r\n    --- requestAnimationFrame ---\r\n    at requestAnimationFrame (C:\\Users\\r.gombert\\.nuget\\packages\\skiasharp.views.blazor\\2.88.6\\staticwebassets\\SKHtmlCanvas.js:98:41)\r\n    at requestAnimationFrame (C:\\Users\\r.gombert\\.nuget\\packages\\skiasharp.views.blazor\\2.88.6\\staticwebassets\\SKHtmlCanvas.js:68:33)\r\n    at invokeJSFromDotNet (localhost\uA7897040/_framework/blazor.webassembly.js:1:3219)\r\n    at Gt (localhost\uA7897040/_framework/blazor.webassembly.js:1:62634)\r\n    at Ii (localhost\uA7897040/_framework/dotnet.7.0.12.y6rpn8jldv.js:5:71974)\r\n    at _mono_wasm_invoke_js_blazor (localhost\uA7897040/_framework/dotnet.7.0.12.y6rpn8jldv.js:7677:71)\r\n    at $do_icall (wasm/05035f22:1:5366372)\r\n    at $do_icall_wrapper (wasm/05035f22:1:5361988)\r\n    at $interp_exec_method (wasm/05035f22:1:5299397)\r\n    at $interp_runtime_invoke (wasm/05035f22:1:5294797)\r\n    at $mono_jit_runtime_invoke (wasm/05035f22:1:7352181)\r\n    at $do_runtime_invoke (wasm/05035f22:1:5907916)\r\n    at $mono_runtime_invoke_checked (wasm/05035f22:1:5907796)\r\n    at $mono_runtime_try_invoke_span (wasm/05035f22:1:5927157)\r\n    at $mono_runtime_invoke_span_checked (wasm/05035f22:1:5927774)\r\n    at $ves_icall_InternalInvoke (wasm/05035f22:1:5729477)\r\n    at $ves_icall_InternalInvoke_raw (wasm/05035f22:1:5759520)\r\n    at $do_icall (wasm/05035f22:1:5366277)\r\n    at $do_icall_wrapper (wasm/05035f22:1:5361988)\r\n    at $interp_exec_method (wasm/05035f22:1:5299397)\r\n    at $interp_runtime_invoke (wasm/05035f22:1:5294797)\r\n    at $mono_jit_runtime_invoke (wasm/05035f22:1:7352181)\r\n    at $do_runtime_invoke (wasm/05035f22:1:5907916)\r\n    at $mono_runtime_invoke_checked (wasm/05035f22:1:5907796)\r\n    at $mono_runtime_try_invoke_span (wasm/05035f22:1:5927157)\r\n    at $mono_runtime_invoke_span_checked (wasm/05035f22:1:5927774)\r\n    at $ves_icall_InternalInvoke (wasm/05035f22:1:5729477)\r\n    at $ves_icall_InternalInvoke_raw (wasm/05035f22:1:5759520)\r\n    at $do_icall (wasm/05035f22:1:5366277)\r\n    at $do_icall_wrapper (wasm/05035f22:1:5361988)\r\n    at $interp_exec_method (wasm/05035f22:1:5299397)\r\n    at $interp_runtime_invoke (wasm/05035f22:1:5294797)\r\n    at $mono_jit_runtime_invoke (wasm/05035f22:1:7352181)\r\n    at $do_runtime_invoke (wasm/05035f22:1:5907916)\r\n    at $mono_runtime_try_invoke (wasm/05035f22:1:5909851)\r\n    at $mono_runtime_invoke (wasm/05035f22:1:5918698)\r\n    at $mono_wasm_invoke_method_ref (wasm/05035f22:1:7777494)\r\n    at Module._mono_wasm_invoke_method_ref (localhost\uA7897040/_framework/dotnet.7.0.12.y6rpn8jldv.js:8654:129)\r\n    at _Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_BeginInvokeDotNet (dotnet.generated.invalid/_Microsoft_AspNetCore_Components_WebAssembly__Microsoft_AspNetCore_Components_WebAssembly_Services_DefaultWebAssemblyJSRuntime_BeginInvokeDotNet:29:5)\r\n    at beginInvokeDotNetFromJS (localhost\uA7897040/_framework/blazor.webassembly.js:1:45087)\r\n    at b (localhost\uA7897040/_framework/blazor.webassembly.js:1:1998)\r\n    at invokeMethodAsync (localhost\uA7897040/_framework/blazor.webassembly.js:1:3866)\r\n    at \u003Canonymous\u003E (localhost\uA7897040/_framework/blazor.webassembly.js:1:11414)\r\n    at invokeWhenHeapUnlocked (localhost\uA7897040/_framework/blazor.webassembly.js:1:47333)\r\n    at S (localhost\uA7897040/_framework/blazor.webassembly.js:1:58698)\r\n    at A (localhost\uA7897040/_framework/blazor.webassembly.js:1:11383)\r\n    at dispatchGlobalEventToAllElements (localhost\uA7897040/_framework/blazor.webassembly.js:1:13968)\r\n    at onGlobalEvent (localhost\uA7897040/_framework/blazor.webassembly.js:1:13161)\r\nThe thread \u0027[Thread Destroyed]\u0027 (0x9c38) has exited with code 0 (0x0).\r\nThe thread \u0027[Thread Destroyed]\u0027 (0x6960) has exited with code 0 (0x0).\r\nThe thread \u0027[Thread Destroyed]\u0027 (0x18f4) has exited with code 0 (0x0).\r\nThe thread 0x880 has exited with code 0 (0x0).\r\n\u0060\u0060\u0060\r\n\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "ronaldIndigo",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2023-10-18T08:47:21",
  "updatedAt": "2023-10-23T09:09:21",
  "commentCount": 2,
  "reactionCount": 0
}