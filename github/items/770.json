{
  "number": 770,
  "type": "issue",
  "state": "closed",
  "title": "[BUG] SKRegion.Intersects() causes Access Violation and instantly crashes program",
  "body": "**Description**\r\n\r\nI haven\u0027t been able to pin down the _exact_ cause, but from stepping through my code I can see that the instant the code hits a call to SKRegion\u0027s \u0060Intersects()\u0060 method, having been passed an SKRectI to check intersection against, an access violation is reported and the entire program crashes.\r\n\r\n**Code**\r\n\r\n\u0060\u0060\u0060csharp\r\nusing System;\r\nusing SkiaSharp;\r\n\r\nnamespace Test\r\n{\r\n    static class Extensions\r\n    {\r\n        public static SKRectI ToSKRectI(this SKRect rect)\r\n        {\r\n            return new SKRectI(\r\n                (int)Math.Round(rect.Left),\r\n                (int)Math.Round(rect.Top),\r\n                (int)Math.Round(rect.Right),\r\n                (int)Math.Round(rect.Bottom));\r\n        }\r\n    }\r\n\r\n    class Program\r\n    {\r\n        private static SKSizeI _imageSize { get; } = new SKSizeI(4096, 2304);\r\n        private static string[] _wordList { get; } = new[] { \u0022hello\u0022, \u0022darkness\u0022, \u0022my\u0022, \u0022old\u0022, \u0022friend\u0022 };\r\n        private static Random _random = new Random();\r\n        private static string _filePath = @\u0022C:\\Test\\output.svg\u0022;\r\n\r\n        static void Main(string[] args)\r\n        {\r\n            SKPath wordPath = null;\r\n            Console.WriteLine(\u0022Image size is {0}\u0022, _imageSize.ToString());\r\n\r\n            try\r\n            {\r\n                using (SKRegion occupiedSpace = new SKRegion())\r\n                using (SKPaint brush = new SKPaint())\r\n                using (SKFileWStream streamWriter = new SKFileWStream(_filePath))\r\n                using (SKXmlStreamWriter xmlWriter = new SKXmlStreamWriter(streamWriter))\r\n                using (SKCanvas canvas = SKSvgCanvas.Create(SKRect.Create(_imageSize), xmlWriter))\r\n                {\r\n                    brush.Color = SKColors.Black;\r\n                    foreach (string word in _wordList)\r\n                    {\r\n                        bool next = false;\r\n\r\n                        brush.TextSize = _imageSize.Height / (10 * (Array.IndexOf(_wordList, word) \u002B 1));\r\n                        for (float x = 0; x \u003C= _imageSize.Width; x \u002B= (float)_random.NextDouble() * _imageSize.Width / 100)\r\n                        {\r\n                            for (float y = 0; y \u003C= _imageSize.Width; y \u002B= (float)_random.NextDouble() * _imageSize.Width / 100)\r\n                            {\r\n                                wordPath = brush.GetTextPath(word, x, y);\r\n                                if (!occupiedSpace.Intersects(wordPath.Bounds.ToSKRectI()))\r\n                                {\r\n                                    Console.WriteLine(\u0022Found space for word {0} at {1}\u0022, word, wordPath.Bounds.Location);\r\n                                    canvas.DrawPath(wordPath, brush);\r\n                                    using (SKRegion wordRegion = new SKRegion())\r\n                                    {\r\n                                        wordRegion.SetRect(SKRectI.Create(_imageSize));\r\n                                        wordRegion.SetPath(wordPath);\r\n                                        occupiedSpace.Op(wordRegion, SKRegionOperation.Union);\r\n                                        next = true;\r\n                                    }\r\n                                }\r\n\r\n                                if (next) break;\r\n                            }\r\n\r\n                            if (next) break;\r\n                        }\r\n                    }\r\n\r\n                    // All words written, tidy and ensure file is saved\r\n                    canvas.Flush();\r\n                    streamWriter.Flush();\r\n                }\r\n            }\r\n            finally\r\n            {\r\n                wordPath?.Dispose();\r\n            }\r\n\r\n            Console.WriteLine(\u0022Drawing complete; press Enter to exit\u0022);\r\n            // Wait for exit\r\n            Console.ReadLine();\r\n            Environment.Exit(0);\r\n        }\r\n    }\r\n}\r\n\u0060\u0060\u0060\r\n\r\n**Expected Behavior**\r\n\r\nProgram will loop through the word list, attempting to draw each in turn. Console should output found positions as it progresses, and eventually an SVG file would be output at the specified location.\r\n\r\n**Actual Behavior**\r\n\r\nProgram progresses through the first loop and then instantly closes silently. If the application is debugged, an access violation will be reported when the \u0060Intersects()\u0060 method is called.\r\n\r\n**Basic Information**\r\n\r\n- Version with issue:  1.68.0\r\n- Last known good version:  unknown if this ever worked\r\n- IDE:  Visual Studio Code\r\n- Platform Target Frameworks: \r\n  - Windows Classic:  Windows 10\r\n- Target Devices:   \u003C!-- the devices that you noticed this on, e.g. iPhone X --\u003E\r\n  - PC\r\n\r\n**Reproduction Link**\r\n\r\nhttps://github.com/vexx32/PSWordCloud/tree/Cmdlet/Cmdlet\r\n\r\nThe following PowerShell module attempts to use SkiaSharp to draw a word cloud. \r\n\r\n1. Use \u0060dotnet publish\u0060 to compile the module DLL\r\n2. Open a PowerShell or PowerShell Core console\r\n3. Execute \u0060Import-Module .\\PSWordCloud.psm1\u0060 from a PowerShell console with current location at this folder in the repo: https://github.com/vexx32/PSWordCloud/tree/Cmdlet/Cmdlet\r\n4. Execute the following command in PowerShell and watch it _burn_ :wink:\r\n\r\n\u0060\u0060\u0060powershell\r\n\u0022Hello darkness my old friend\u0022,\u0022I\u0027ve come to talk with you again\u0022 | New-WordCloud -Path $env:TEMP\\test.svg\r\n\u0060\u0060\u0060\r\n\r\n5. Observe the _entire PowerShell application_ crash due to the access violation without warning.\r\n\r\nElsewhere in the repo you can find working code (check the latest release) written in PowerShell utilising System.Drawing for the same task and example pictures and commands to do the same with the published version of the module.\r\n",
  "author": {
    "login": "vexx32",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "milestone": "v1.68.1",
  "createdAt": "2019-01-29T17:50:54",
  "updatedAt": "2022-08-19T12:01:55",
  "closedAt": "2019-01-31T03:10:24",
  "commentCount": 8,
  "reactionCount": 0
}