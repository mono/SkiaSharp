{
  "number": 2752,
  "type": "issue",
  "state": "open",
  "title": "[BUG] Encode SVG to PNG with multiple clipPath produces wrong result",
  "body": "### Description\r\n\r\n1. Source SVG:\r\n\r\n\u0060\u0060\u0060\r\n\u003Csvg width=\u0022130\u0022 height=\u002234\u0022 viewBox=\u00220 0 130 34\u0022 fill=\u0022none\u0022 xmlns=\u0022http://www.w3.org/2000/svg\u0022\u003E\r\n\u003Cg clip-path=\u0022url(#clip0)\u0022\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M32.1669 7.57512C32.1669 11.5058 24.2254 19.6879 20.2948 19.6879C16.3642 19.6879 13.1555 16.4792 13.1555 12.5486C13.1956 8.61794 16.4043 5.40927 20.3349 5.40927C24.2656 5.40927 32.1669 3.60439 32.1669 7.57512Z\u0022 fill=\u0022#EC008C\u0022/\u003E\r\n\u003Cpath opacity=\u00220.75\u0022 d=\u0022M0.120241 12.9097C1.48393 9.21968 12.9549 8.49773 16.6449 9.86142C20.3349 11.2251 23.4232 12.2679 22.0595 15.9579C20.6959 19.6479 16.6048 21.533 12.9148 20.1693C9.22485 18.8056 -1.24344 16.5996 0.120241 12.9097Z\u0022 fill=\u0022#DA1C5C\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M34.4932 15.276C34.4932 19.2066 26.5918 27.3887 22.6211 27.3887C18.6905 27.3887 15.4818 24.18 15.4818 20.2494C15.4818 16.3188 18.6905 13.1101 22.6211 13.1101C26.5517 13.1101 34.4932 11.3453 34.4932 15.276Z\u0022 fill=\u0022#F15A29\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M22.7414 16.8803C22.7414 20.8109 14.7999 28.9931 10.8693 28.9931C6.93865 28.9931 3.72998 25.7844 3.72998 21.8538C3.72998 17.9231 6.93865 14.7145 10.8693 14.7145C14.84 14.7546 22.7414 12.9497 22.7414 16.8803Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003C/g\u003E\r\n\u003Cg clip-path=\u0022url(#clip1)\u0022\u003E\r\n\u003Cpath opacity=\u00220.75\u0022 d=\u0022M47.8579 8.93049H50.826V19.0378C50.826 21.0432 50.4249 22.4871 49.6227 23.4497C48.5398 24.7332 46.9354 25.3749 44.7295 25.3749C43.5663 25.3749 42.6037 25.2145 41.8016 24.9337C40.9994 24.653 40.3577 24.2118 39.7961 23.6503C39.2346 23.0888 38.8335 22.4069 38.5929 21.6048H41.8818C42.1625 21.9256 42.5636 22.2064 43.0048 22.3668C43.446 22.5272 44.0075 22.6075 44.6092 22.6075C45.4113 22.6075 46.0531 22.4871 46.5344 22.2465C47.0157 22.0058 47.3766 21.685 47.5772 21.2839C47.7777 20.8828 47.8579 20.201 47.8579 19.2785C47.3365 19.7999 46.775 20.1608 46.2135 20.4015C45.652 20.6421 45.0102 20.7625 44.2883 20.7625C42.684 20.7625 41.3604 20.201 40.2774 19.0378C39.1544 17.8747 38.5929 16.4308 38.5929 14.666C38.5929 12.7809 39.1544 11.2969 40.3176 10.1337C41.4005 9.13103 42.6438 8.60962 44.0877 8.60962C44.7696 8.60962 45.4113 8.72994 46.013 8.97059C46.6146 9.21125 47.2162 9.61233 47.8178 10.214V8.93049H47.8579ZM44.7696 11.3771C43.8471 11.3771 43.0449 11.698 42.4433 12.2996C41.8417 12.9413 41.5208 13.7034 41.5208 14.666C41.5208 15.6687 41.8417 16.4709 42.4433 17.0725C43.085 17.7142 43.8471 18.0351 44.7696 18.0351C45.6921 18.0351 46.4541 17.7142 47.0558 17.1126C47.6574 16.511 47.9382 15.7088 47.9382 14.7061C47.9382 13.7034 47.6173 12.9012 47.0558 12.2996C46.4943 11.698 45.7322 11.3771 44.7696 11.3771Z\u0022 fill=\u0022#DA1C5C\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M52.3099 8.93049V10.214C52.8314 9.69255 53.433 9.29146 54.0346 9.0107C54.6763 8.72994 55.3181 8.60962 56.04 8.60962C57.5641 8.60962 58.8877 9.21125 59.9707 10.3744C61.0536 11.5375 61.575 13.0215 61.575 14.8665C61.575 16.6313 61.0135 18.1153 59.8904 19.2785C58.7674 20.4817 57.4438 21.0432 55.9197 21.0432C55.2379 21.0432 54.5961 20.9229 54.0346 20.6823C53.433 20.4416 52.8715 20.0405 52.2698 19.479V25.0541H49.3419V8.93049H52.3099ZM55.3983 11.337C54.4758 11.337 53.6736 11.6579 53.072 12.2996C52.4704 12.9413 52.1495 13.7836 52.1495 14.7863C52.1495 15.8291 52.4704 16.6714 53.072 17.3131C53.6736 17.9549 54.4758 18.2758 55.3983 18.2758C56.3208 18.2758 57.0828 17.9549 57.6845 17.273C58.2861 16.6313 58.607 15.789 58.607 14.7462C58.607 13.7435 58.2861 12.9012 57.6845 12.2595C57.123 11.6579 56.3208 11.337 55.3983 11.337Z\u0022 fill=\u0022#EC008C\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M66.8292 10.5749L64.9842 12.4199C64.2222 11.698 63.5804 11.2969 62.9387 11.2969C62.6178 11.2969 62.3371 11.3771 62.1766 11.4974C61.9761 11.6579 61.8959 11.8183 61.8959 12.0188C61.8959 12.1793 61.9761 12.3397 62.0563 12.46C62.1766 12.5804 62.4574 12.7809 62.9387 13.0215L64.0216 13.5831C65.1848 14.1446 65.9468 14.7061 66.388 15.3077C66.8292 15.9094 67.0298 16.5912 67.0298 17.3533C67.0298 18.3961 66.6287 19.2785 65.8666 20.0004C65.1046 20.7224 64.0617 21.0432 62.7783 21.0432C61.0536 21.0432 59.6899 20.3614 58.6471 19.0378L60.452 17.0324C60.8129 17.4335 61.214 17.7543 61.6552 18.0351C62.1365 18.2757 62.5376 18.3961 62.8986 18.3961C63.2997 18.3961 63.6205 18.3159 63.8612 18.1153C64.1018 17.9148 64.2222 17.7142 64.2222 17.4736C64.2222 17.0324 63.781 16.5912 62.9387 16.15L61.936 15.6687C60.0108 14.7061 59.0482 13.5028 59.0482 12.0589C59.0482 11.1365 59.4092 10.3343 60.1311 9.65244C60.8932 8.93049 61.8157 8.60962 62.9387 8.60962C63.7008 8.60962 64.4227 8.77005 65.1045 9.13103C65.7864 9.4519 66.3479 9.9332 66.8292 10.5749Z\u0022 fill=\u0022#F15A29\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M73.6476 8.93049H76.6156V19.0378C76.6156 21.0432 76.2146 22.4871 75.4124 23.4497C74.3295 24.7332 72.7251 25.3749 70.5192 25.3749C69.356 25.3749 68.3934 25.2145 67.5912 24.9337C66.7891 24.653 66.1473 24.2118 65.5858 23.6503C65.0243 23.0888 64.6232 22.4069 64.3826 21.6048H67.6715C67.9522 21.9256 68.3533 22.2064 68.7945 22.3668C69.2357 22.5272 69.7972 22.6075 70.3988 22.6075C71.201 22.6075 71.8427 22.4871 72.324 22.2465C72.8053 22.0058 73.1663 21.685 73.3669 21.2839C73.5674 20.8828 73.6476 20.201 73.6476 19.2785C73.1262 19.7999 72.5647 20.1608 72.0032 20.4015C71.4417 20.6421 70.7999 20.7625 70.078 20.7625C68.4736 20.7625 67.15 20.201 66.0671 19.0378C64.9842 17.8747 64.4227 16.4308 64.4227 14.7061C64.4227 12.821 64.9842 11.337 66.1473 10.1738C67.1902 9.13103 68.4335 8.60962 69.9175 8.60962C70.5994 8.60962 71.2411 8.72994 71.8427 8.97059C72.4444 9.21125 73.046 9.61233 73.6476 10.214V8.93049V8.93049ZM70.5994 11.3771C69.6769 11.3771 68.8747 11.698 68.2731 12.2996C67.6715 12.9413 67.3506 13.7034 67.3506 14.666C67.3506 15.6687 67.6715 16.4709 68.2731 17.0725C68.9148 17.7142 69.6769 18.0351 70.5994 18.0351C71.5219 18.0351 72.2839 17.7142 72.8856 17.1126C73.4872 16.511 73.7679 15.7088 73.7679 14.7061C73.7679 13.7034 73.4872 12.9012 72.8856 12.2996C72.2839 11.698 71.5219 11.3771 70.5994 11.3771Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M83.8753 8.93042H86.8433V20.7624H83.8753V19.519C83.3138 20.0806 82.7121 20.4816 82.1506 20.7223C81.549 20.9629 80.9474 21.0833 80.2655 21.0833C78.7414 21.0833 77.4178 20.4816 76.2948 19.3185C75.1717 18.1152 74.6102 16.6713 74.6102 14.9066C74.6102 13.1017 75.1316 11.5776 76.2146 10.4144C77.2975 9.25128 78.6211 8.64966 80.1452 8.64966C80.8671 8.64966 81.5089 8.76998 82.1506 9.05074C82.7923 9.3315 83.3539 9.73259 83.8753 10.254V8.93042V8.93042ZM80.7468 11.3369C79.8243 11.3369 79.0623 11.6578 78.4606 12.2995C77.859 12.9413 77.5381 13.7835 77.5381 14.7862C77.5381 15.789 77.859 16.6312 78.4606 17.3131C79.0623 17.9548 79.8243 18.3158 80.7468 18.3158C81.6693 18.3158 82.4314 17.9949 83.0731 17.3532C83.6747 16.7115 83.9956 15.8692 83.9956 14.8264C83.9956 13.7835 83.6747 12.9814 83.0731 12.3396C82.4715 11.6578 81.7094 11.3369 80.7468 11.3369Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M85.3593 8.93042H88.3273V10.2941C88.8487 9.73259 89.4102 9.3315 90.0118 9.05074C90.6135 8.76998 91.2953 8.64966 92.0574 8.64966C92.7793 8.64966 93.4612 8.8502 94.0628 9.21118C94.6644 9.57215 95.1457 10.0936 95.5067 10.8155C95.988 10.1337 96.5495 9.57215 97.2313 9.21118C97.9132 8.8502 98.6753 8.64966 99.4774 8.64966C100.32 8.64966 101.042 8.8502 101.683 9.25128C102.325 9.65237 102.766 10.1337 103.047 10.7754C103.328 11.4171 103.448 12.4199 103.448 13.8638V20.8025H100.48V14.7461C100.48 13.4226 100.32 12.5001 99.9988 12.0188C99.678 11.5375 99.1566 11.2968 98.5148 11.2968C97.9934 11.2968 97.5522 11.4572 97.1511 11.738C96.75 12.0188 96.4693 12.4199 96.2687 12.9413C96.0682 13.4627 95.988 14.2648 95.988 15.3879V20.7223H93.02V14.9868C93.02 13.944 92.9397 13.1819 92.7793 12.7006C92.6189 12.2193 92.3782 11.8583 92.0574 11.6578C91.7365 11.4171 91.3755 11.2968 90.9343 11.2968C90.453 11.2968 90.0118 11.4572 89.5706 11.738C89.1696 12.0188 88.8487 12.46 88.6481 12.9814C88.4476 13.5028 88.3674 14.3451 88.3674 15.4681V20.7223H85.3994V8.93042H85.3593Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M101.162 8.93042H104.13V10.2941C104.652 9.73259 105.213 9.3315 105.815 9.05074C106.416 8.76998 107.098 8.64966 107.86 8.64966C108.582 8.64966 109.264 8.8502 109.866 9.21118C110.467 9.57215 110.949 10.0936 111.31 10.8155C111.791 10.1337 112.352 9.57215 113.034 9.21118C113.716 8.8502 114.478 8.64966 115.28 8.64966C116.123 8.64966 116.845 8.8502 117.486 9.25128C118.128 9.65237 118.569 10.1337 118.85 10.7754C119.131 11.4171 119.251 12.4199 119.251 13.8638V20.8025H116.283V14.7461C116.283 13.4226 116.123 12.5001 115.802 12.0188C115.481 11.5375 114.959 11.2968 114.318 11.2968C113.796 11.2968 113.355 11.4572 112.954 11.738C112.553 12.0188 112.272 12.4199 112.072 12.9413C111.871 13.4627 111.791 14.2648 111.791 15.3879V20.7223H108.823V14.9868C108.823 13.944 108.743 13.1819 108.582 12.7006C108.422 12.2193 108.181 11.8583 107.86 11.6578C107.539 11.4171 107.178 11.2968 106.737 11.2968C106.256 11.2968 105.815 11.4572 105.373 11.738C104.972 12.0188 104.652 12.46 104.451 12.9814C104.25 13.5028 104.17 14.3451 104.17 15.4681V20.7223H101.162V8.93042Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003Cpath opacity=\u00220.5\u0022 d=\u0022M127.032 8.93042H130V20.7624H127.032V19.519C126.47 20.0806 125.869 20.4816 125.307 20.7223C124.706 20.9629 124.104 21.0833 123.422 21.0833C121.898 21.0833 120.574 20.4816 119.451 19.3185C118.328 18.1152 117.767 16.6713 117.767 14.9066C117.767 13.1017 118.288 11.5776 119.371 10.4144C120.454 9.25128 121.738 8.64966 123.302 8.64966C124.024 8.64966 124.665 8.76998 125.307 9.05074C125.949 9.3315 126.51 9.73259 127.032 10.254V8.93042V8.93042ZM123.903 11.3369C122.981 11.3369 122.219 11.6578 121.617 12.2995C121.016 12.9413 120.695 13.7835 120.695 14.7862C120.695 15.789 121.016 16.6312 121.617 17.3131C122.219 17.9548 122.981 18.3158 123.903 18.3158C124.826 18.3158 125.588 17.9949 126.23 17.3532C126.831 16.7115 127.152 15.8692 127.152 14.8264C127.152 13.7835 126.831 12.9814 126.23 12.3396C125.628 11.6578 124.866 11.3369 123.903 11.3369Z\u0022 fill=\u0022#9B8579\u0022/\u003E\r\n\u003C/g\u003E\r\n\u003Cdefs\u003E\r\n\u003CclipPath id=\u0022clip0\u0022\u003E\r\n\u003Crect width=\u002234.4932\u0022 height=\u002223.9848\u0022 fill=\u0022white\u0022 transform=\u0022translate(0 5)\u0022/\u003E\r\n\u003C/clipPath\u003E\r\n\u003CclipPath id=\u0022clip1\u0022\u003E\r\n\u003Crect width=\u002291.4071\u0022 height=\u002216.7653\u0022 fill=\u0022white\u0022 transform=\u0022translate(38.5929 8.60962)\u0022/\u003E\r\n\u003C/clipPath\u003E\r\n\u003C/defs\u003E\r\n\u003C/svg\u003E\r\n\r\n\u0060\u0060\u0060\r\n2. Code:\r\n\r\n\u0060\u0060\u0060\r\nvar svg = new SkiaSharp.Extended.Svg.SKSvg();\r\nvar pict = svg.Load(stream);\r\nvar dimen = new SKSizeI((int)Math.Ceiling(pict.CullRect.Width), (int)Math.Ceiling(pict.CullRect.Height));\r\nvar matrix = SKMatrix.CreateScale(1, 1);\r\nvar img = SKImage.FromPicture(pict, dimen, matrix);\r\n// convert to PNG\r\nvar skdata = img.Encode(SKEncodedImageFormat.Png, 100);\r\n\r\nvar memoryStream = new MemoryStream();\r\nskdata.SaveTo(memoryStream);\r\n\r\n\u0060\u0060\u0060\r\n\r\n3. Result png is wrong (clipped). If I change SVG to use one \u0026lt;clipPath\u0026gt; - result are perfect.\r\n\r\nAny issues?\r\n\r\n### Code\r\n\r\nvar svg = new SkiaSharp.Extended.Svg.SKSvg();\r\nvar pict = svg.Load(stream);\r\nvar dimen = new SKSizeI((int)Math.Ceiling(pict.CullRect.Width), (int)Math.Ceiling(pict.CullRect.Height));\r\nvar matrix = SKMatrix.CreateScale(1, 1);\r\nvar img = SKImage.FromPicture(pict, dimen, matrix);\r\n// convert to PNG\r\nvar skdata = img.Encode(SKEncodedImageFormat.Png, 100);\r\n\r\nvar memoryStream = new MemoryStream();\r\nskdata.SaveTo(memoryStream);\r\n\r\n\r\n### Expected Behavior\r\n\r\nPNG that rendered correctly (taking into account all **clipPath** info in SVG file)\r\n\r\n### Actual Behavior\r\n\r\nResult PNG is clipped.\r\n\r\n### Version of SkiaSharp\r\n\r\n2.88.3 (Current)\r\n\r\n### Last Known Good Version of SkiaSharp\r\n\r\n2.88.2 (Previous)\r\n\r\n### IDE / Editor\r\n\r\nVisual Studio Code (Linux)\r\n\r\n### Platform / Operating System\r\n\r\nLinux\r\n\r\n### Platform / Operating System Version\r\n\r\n_No response_\r\n\r\n### Devices\r\n\r\n_No response_\r\n\r\n### Relevant Screenshots\r\n\r\nWRONG: ![image](https://github.com/mono/SkiaSharp/assets/16744990/d856580e-f19c-4281-97c8-2b84f59a100c)\r\n\r\nGOOD: \r\n![image](https://github.com/mono/SkiaSharp/assets/16744990/f7ec741d-fd73-47af-be6c-e19a435a4852)\r\n\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### Code of Conduct\r\n\r\n- [X] I agree to follow this project\u0027s Code of Conduct",
  "author": {
    "login": "Porokhnya",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [],
  "createdAt": "2024-02-12T14:53:45",
  "updatedAt": "2024-02-17T16:23:14",
  "commentCount": 1,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T20:22:16.3475765Z",
    "reactions": [],
    "comments": [
      {
        "id": 1950248519,
        "author": "charlesroddie",
        "createdAt": "2024-02-17T16:23:13",
        "reactions": []
      }
    ]
  }
}