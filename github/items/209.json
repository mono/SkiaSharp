{
  "number": 209,
  "type": "issue",
  "state": "open",
  "title": "Thread Safety in SKBitmap.Decode?",
  "body": "Hi! I\u0027m using SkiaSharp for server side image generation and have run into an issue when Decoding many bitmaps at once on IIS. \r\n\r\nHere\u0027s the error: \r\n\u0060\u0060\u0060\r\nApplication: w3wp.exe\r\nFramework Version: v4.0.30319\r\nDescription: The process was terminated due to an unhandled exception.\r\nException Info: System.AccessViolationException\r\n   at SkiaSharp.SkiaApi.sk_codec_get_info(IntPtr, SkiaSharp.SKImageInfo ByRef)\r\n   at SkiaSharp.SKBitmap.Decode(SkiaSharp.SKCodec)\r\n   at SkiaSharp.SKBitmap.Decode(SkiaSharp.SKStream)\r\n\u0060\u0060\u0060\r\n\r\nI\u0027m not sure if this is because of memory constraints, because of thread safety or another reason I\u0027m unaware of. \r\n\r\nThe code I have is this:\r\n\r\n\u0060\u0060\u0060c#\r\npublic static async Task LoadBitmap(RenderContext context, ILayoutElementHasUri element, Action\u003CSKBitmap\u003E handleBitmapAction) {\r\n    \r\n    var uri = element.GetUriWithReplacements();\r\n\r\n    var bytes = await new LoadImage(uri, context).Execute();\r\n\r\n    // Limit the number of bitmaps decoding concurrently\r\n    await decodeBitmapThrottler.WaitAsync();\r\n\r\n    try\r\n    {\r\n        var bitmap = SKBitmap.Decode(bytes);\r\n        handleBitmapAction(bitmap);\r\n        if (bitmap != null)\r\n        {\r\n            bitmap.Dispose();\r\n        }\r\n        \r\n    }\r\n    finally\r\n    {\r\n        decodeBitmapThrottler.Release();\r\n    }\r\n}\r\n\u0060\u0060\u0060     \r\n\r\nMy workaround has been to add a SemaphoreSlim, \u0060decodeBitmapThrottler\u0060, with a max count of 1, which increases the stability but sacrifices speed. As soon as I increase the count, I start getting System.AccessViolationException errors. \r\n\r\nAny help or insight is appreciated! I also understand if this case is outside the goals of the project.\n\n\u003E VS bug [#735689](https://devdiv.visualstudio.com/DevDiv/_workitems/edit/735689)",
  "author": {
    "login": "abezydar",
    "type": "User"
  },
  "labels": [
    {
      "name": "type/bug",
      "color": "fc2929"
    }
  ],
  "assignees": [
    {
      "login": "mattleibow",
      "type": "User"
    }
  ],
  "createdAt": "2016-12-06T21:24:19",
  "updatedAt": "2024-02-06T09:41:07",
  "commentCount": 28,
  "reactionCount": 0,
  "engagement": {
    "syncedAt": "2026-02-04T20:22:56.2760306Z",
    "reactions": [],
    "comments": [
      {
        "id": 270152176,
        "author": "mattleibow",
        "createdAt": "2017-01-03T16:15:29",
        "reactions": []
      },
      {
        "id": 270393769,
        "author": "abezydar",
        "createdAt": "2017-01-04T15:12:05",
        "reactions": []
      },
      {
        "id": 276704698,
        "author": "mattleibow",
        "createdAt": "2017-02-01T16:26:45",
        "reactions": []
      },
      {
        "id": 276707299,
        "author": "mattleibow",
        "createdAt": "2017-02-01T16:35:20",
        "reactions": []
      },
      {
        "id": 276711663,
        "author": "abezydar",
        "createdAt": "2017-02-01T16:49:47",
        "reactions": []
      },
      {
        "id": 282979908,
        "author": "groege",
        "createdAt": "2017-02-28T08:53:01",
        "reactions": []
      },
      {
        "id": 283193498,
        "author": "mattleibow",
        "createdAt": "2017-02-28T23:20:03",
        "reactions": []
      },
      {
        "id": 283821209,
        "author": "abezydar",
        "createdAt": "2017-03-02T23:53:46",
        "reactions": []
      },
      {
        "id": 287527691,
        "author": "ncthbrt",
        "createdAt": "2017-03-18T09:04:54",
        "reactions": []
      },
      {
        "id": 288927993,
        "author": "mattleibow",
        "createdAt": "2017-03-24T04:03:53",
        "reactions": []
      },
      {
        "id": 290292062,
        "author": "tdoneal",
        "createdAt": "2017-03-30T03:28:54",
        "reactions": []
      },
      {
        "id": 290297806,
        "author": "tdoneal",
        "createdAt": "2017-03-30T04:16:02",
        "reactions": []
      },
      {
        "id": 290604269,
        "author": "tdoneal",
        "createdAt": "2017-03-31T03:11:55",
        "reactions": []
      },
      {
        "id": 290773425,
        "author": "mattleibow",
        "createdAt": "2017-03-31T17:16:36",
        "reactions": []
      },
      {
        "id": 290913856,
        "author": "ncthbrt",
        "createdAt": "2017-04-01T11:18:35",
        "reactions": []
      },
      {
        "id": 297422490,
        "author": "samirchakour-crossover",
        "createdAt": "2017-04-26T14:16:39",
        "reactions": []
      },
      {
        "id": 297509478,
        "author": "samirchakour-crossover",
        "createdAt": "2017-04-26T19:01:57",
        "reactions": []
      },
      {
        "id": 297925938,
        "author": "ncthbrt",
        "createdAt": "2017-04-28T07:15:02",
        "reactions": []
      },
      {
        "id": 298932047,
        "author": "irv",
        "createdAt": "2017-05-03T14:43:53",
        "reactions": []
      },
      {
        "id": 444176010,
        "author": "mattleibow",
        "createdAt": "2018-12-04T17:02:23",
        "reactions": []
      },
      {
        "id": 952471047,
        "author": "christian289",
        "createdAt": "2021-10-27T02:00:18",
        "reactions": []
      },
      {
        "id": 952498853,
        "author": "christian289",
        "createdAt": "2021-10-27T03:11:23",
        "reactions": [
          {
            "user": "evan-choi",
            "content": "heart",
            "createdAt": "2026-02-04T20:22:55.098513Z"
          }
        ]
      },
      {
        "id": 1729664646,
        "author": "kostebudinoski",
        "createdAt": "2023-09-21T14:10:29",
        "reactions": []
      },
      {
        "id": 1743048146,
        "author": "kostebudinoski",
        "createdAt": "2023-10-02T13:46:05",
        "reactions": []
      },
      {
        "id": 1743200410,
        "author": "kostebudinoski",
        "createdAt": "2023-10-02T15:09:35",
        "reactions": []
      },
      {
        "id": 1769173002,
        "author": "gktval",
        "createdAt": "2023-10-18T19:18:40",
        "reactions": []
      },
      {
        "id": 1854872133,
        "author": "Proektsoftbg",
        "createdAt": "2023-12-13T23:54:55",
        "reactions": [
          {
            "user": "kostebudinoski",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:22:56.0411359Z"
          }
        ]
      },
      {
        "id": 1929129328,
        "author": "kostebudinoski",
        "createdAt": "2024-02-06T09:41:07",
        "reactions": []
      }
    ]
  }
}