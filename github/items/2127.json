{
  "number": 2127,
  "type": "pr",
  "state": "closed",
  "title": "Improving SKData performance",
  "body": "**Description of Change**\r\n\r\nWhen trying to make Skottie work better, I noticed a few places where there was a less than ideal code path.\r\n\r\nOne performance improvement that can be applied to specific instances is to skip the object registration with the handler dictionary. Some objects are never returned from an API - such as \u0060SKPaint\u0060 - because they are user objects and are always given to the native APIs and never stored. \r\n\r\nOther objects differ in that they are sometimes _not_ stored in native code. In these cases we can skip the registration for specific methods - such as with the \u0060SKUnregisteredDynamicMemoryWStream\u0060 used in the construction of the \u0060SKData\u0060 instance. This stream is only alive for the duration of the \u0060Create\u0060 method, so we do not need to register the stream with the handle dictionary. These special objects can be created by implementing the \u0060ISKSkipObjectRegistration\u0060 interface on a private class.\r\n\r\n\u003E The handler dictionary is required because some APIs will return a native object that we already have a binding instance for in managed code. To prevent multiple C# objects from sharing a single C\u002B\u002B object, we register the C\u002B\u002B handle and the C# object in a dictionary for lookups later.\r\n\r\n**Changes**\r\n\r\n - \u0060SKData.AsStream()\u0060 now is a writeable stream and can be used to copy from another stream\r\n\r\n**SKData Performance**\r\n\r\n\u003E The benchmarks can be run by opening the \u0060benchmarks\\SkiaSharp.Benchmarks\\SkiaSharp.Benchmarks.sln\u0060 in the IDE or running with \u0060dotnet run -c Release -f net6.0\u0060 from the \u0060benchmarks\\SkiaSharp.Benchmarks\u0060 directory.\r\n\r\nThis PR has a few changes that make creating SKData a faster and slimmer implementation.\r\n\r\nMy benchmark for the construction of SKData is below. There are 3 benchmarks:\r\n\r\n - **CreatePrevious** - the previous implementation of the SKData construction\r\n - **Create** - the new, default implementation of SKData construction using .NET \u0060Stream\u0060 objects\r\n - **CreateUnregistered** - a high-performance construction that bypasses all the typical object registration making it only suitable for cases where the data instance is read and then disposed of without the callee keeping a reference (such as loading a file and then deserializing it)\r\n - **CreateRaw** - an even higher-performance construction that bypasses everything managed and just is calling the native code via p/invoke\r\n\r\nSource for benchmarks: https://github.com/mono/SkiaSharp/pull/2127/files#diff-85b6258ec115fee242f199220e54c7eb66db621306f800eebeee85fb054aa36c\r\n\r\n\u0060\u0060\u0060\r\n// * Summary *\r\n\r\nBenchmarkDotNet=v0.13.1, OS=Windows 10.0.22000\r\nIntel Core i9-9980HK CPU 2.40GHz, 1 CPU, 16 logical and 8 physical cores\r\n.NET SDK=6.0.400-preview.22301.10\r\n  [Host]   : .NET 6.0.6 (6.0.622.26707), X64 RyuJIT\r\n  .NET 6.0 : .NET 6.0.6 (6.0.622.26707), X64 RyuJIT\r\n\r\nJob=.NET 6.0  Runtime=.NET 6.0  InvocationCount=1\r\nUnrollFactor=1\r\n\r\n|             Method | SizeMB | IsSeekable |     Mean |   Error |   StdDev | Ratio | RatioSD | Allocated |\r\n|------------------- |------- |----------- |---------:|--------:|---------:|------:|--------:|----------:|\r\n|     CreatePrevious |      1 |      False | 376.0 ms | 4.02 ms |  3.35 ms |  1.00 |    0.00 | 457,008 B |\r\n|             Create |      1 |      False | 363.0 ms | 7.01 ms |  8.35 ms |  0.98 |    0.02 | 184,816 B |\r\n| CreateUnregistered |      1 |      False | 390.2 ms | 5.53 ms |  5.17 ms |  1.04 |    0.02 | 160,816 B |\r\n|          CreateRaw |      1 |      False | 356.5 ms | 3.56 ms |  2.98 ms |  0.95 |    0.01 |     816 B |\r\n|                    |        |            |          |         |          |       |         |           |\r\n|     CreatePrevious |      1 |       True | 300.1 ms | 2.95 ms |  2.76 ms |  1.00 |    0.00 | 352,816 B |\r\n|             Create |      1 |       True | 275.4 ms | 5.45 ms |  7.08 ms |  0.93 |    0.03 | 200,816 B |\r\n| CreateUnregistered |      1 |       True | 261.9 ms | 4.03 ms |  3.77 ms |  0.87 |    0.01 | 176,816 B |\r\n|          CreateRaw |      1 |       True | 378.2 ms | 5.92 ms |  5.53 ms |  1.26 |    0.02 |     816 B |\r\n|                    |        |            |          |         |          |       |         |           |\r\n|     CreatePrevious |     10 |      False | 464.9 ms | 8.93 ms |  8.77 ms |  1.00 |    0.00 |  46,456 B |\r\n|             Create |     10 |      False | 458.2 ms | 8.96 ms | 15.92 ms |  0.99 |    0.04 |  19,216 B |\r\n| CreateUnregistered |     10 |      False | 461.2 ms | 8.70 ms |  8.94 ms |  0.99 |    0.03 |  17,008 B |\r\n|          CreateRaw |     10 |      False | 426.4 ms | 8.43 ms |  8.28 ms |  0.92 |    0.02 |     856 B |\r\n|                    |        |            |          |         |          |       |         |           |\r\n|     CreatePrevious |     10 |       True | 302.5 ms | 5.96 ms |  7.95 ms |  1.00 |    0.00 |  36,016 B |\r\n|             Create |     10 |       True | 217.6 ms | 4.22 ms |  3.74 ms |  0.72 |    0.03 |  20,816 B |\r\n| CreateUnregistered |     10 |       True | 210.6 ms | 3.57 ms |  3.16 ms |  0.70 |    0.02 |  18,416 B |\r\n|          CreateRaw |     10 |       True | 425.8 ms | 5.80 ms |  5.43 ms |  1.41 |    0.05 |     816 B |\r\n\r\n// * Hints *\r\nOutliers\r\n  SkDataCreateBenchmark.CreatePrevious: .NET 6.0     -\u003E 4 outliers were removed (392.43 ms..414.06 ms)\r\n  SkDataCreateBenchmark.Create: .NET 6.0             -\u003E 1 outlier  was  removed (399.04 ms)\r\n  SkDataCreateBenchmark.CreateRaw: .NET 6.0          -\u003E 2 outliers were removed (374.71 ms, 376.22 ms)\r\n  SkDataCreateBenchmark.CreateRaw: .NET 6.0          -\u003E 1 outlier  was  detected (366.11 ms)\r\n  SkDataCreateBenchmark.CreatePrevious: .NET 6.0     -\u003E 1 outlier  was  detected (434.34 ms)\r\n  SkDataCreateBenchmark.CreateUnregistered: .NET 6.0 -\u003E 2 outliers were detected (445.68 ms, 446.14 ms)\r\n  SkDataCreateBenchmark.CreatePrevious: .NET 6.0     -\u003E 2 outliers were removed, 3 outliers were detected (279.98 ms, 336.67 ms, 339.74 ms)\r\n  SkDataCreateBenchmark.Create: .NET 6.0             -\u003E 1 outlier  was  removed (228.25 ms)\r\n  SkDataCreateBenchmark.CreateUnregistered: .NET 6.0 -\u003E 1 outlier  was  removed (226.38 ms)\r\n  SkDataCreateBenchmark.CreateRaw: .NET 6.0          -\u003E 1 outlier  was  detected (410.67 ms)\r\n\r\n// * Legends *\r\n  SizeMB     : Value of the \u0027SizeMB\u0027 parameter\r\n  IsSeekable : Value of the \u0027IsSeekable\u0027 parameter\r\n  Mean       : Arithmetic mean of all measurements\r\n  Error      : Half of 99.9% confidence interval\r\n  StdDev     : Standard deviation of all measurements\r\n  Ratio      : Mean of the ratio distribution ([Current]/[Baseline])\r\n  RatioSD    : Standard deviation of the ratio distribution ([Current]/[Baseline])\r\n  Allocated  : Allocated memory per single operation (managed only, inclusive, 1KB = 1024B)\r\n  1 ms       : 1 Millisecond (0.001 sec)\r\n\u0060\u0060\u0060",
  "author": {
    "login": "mattleibow",
    "type": "User"
  },
  "labels": [],
  "assignees": [],
  "createdAt": "2022-06-26T03:25:46",
  "updatedAt": "2024-02-08T23:53:38",
  "closedAt": "2024-02-08T23:53:37",
  "commentCount": 2,
  "reactionCount": 0,
  "draft": true,
  "mergeable": false,
  "mergeableState": "dirty",
  "baseBranch": "main",
  "headBranch": "dev/data-perf",
  "additions": 7681,
  "deletions": 21,
  "changedFiles": 10,
  "commits": 11,
  "reviews": [],
  "engagement": {
    "syncedAt": "2026-02-04T20:22:46.2660196Z",
    "reactions": [],
    "comments": [
      {
        "id": 1167640532,
        "author": "mattleibow",
        "createdAt": "2022-06-27T17:20:55",
        "reactions": []
      },
      {
        "id": 1935111518,
        "author": "mattleibow",
        "createdAt": "2024-02-08T23:53:37",
        "reactions": []
      }
    ]
  }
}