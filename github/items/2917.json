{
  "number": 2917,
  "type": "pr",
  "state": "closed",
  "title": "Function pointers and LibraryImport",
  "body": "**Description of Change**\r\n\r\nThis PR is pretty big. If necessary, I can split HarfBuzz and Skia changes on two PRs. In theory, generated code can be be extracted into a separated PR as well, since all changes should be under conditional compilation.\r\n\r\nWhat was changed step by step:\r\n- Generator was updated to emit LibraryImport instead of DllImport, when USE_LIBRARY_IMPORT is set.\r\n- Generator was updated to emit function pointers instead of managed delegates, when USE_LIBRARY_IMPORT is used.\r\n- Since function pointers can\u0027t be used as generics, every \u0060DelegateProxies.Create\u003CT\u003E\u0060 usage was replaced without generics.\r\n- Since Skia expects \u0060bool\u0060 as 1 byte, and function pointers by default marshal it as 4 bytes, I had to disable runtime marshalling. This change required to replace remaining DllImports with LibraryImport as well. As a bonus - final app size should be smaller without runtime marshalling (assuming other dependencies don\u0027t use it too).\r\n\r\nNote:\r\n- Due to older Mono bug, LibraryImport were defined with \u0060void*\u0060 instead of full function pointer, but it doesn\u0027t seem to cause other issues\r\n- Generated file diffs only have additions and no removals, tried to keep this way to keep less impact.\r\n- For HarfBuss I used 2.8.2 native baseline version, as it seems latest when it was regenerated (to keep diff smaller).\r\n- Tested on Windows and WASM (only .NET 9, but both Mono and LLVM). Will test on mobile and mac once there is any nightly build.\r\n\r\n**Bugs Fixed**\r\n\r\n- Fixes #2615\r\n- Fixes #2916 (only reproducible with function pointers)\r\n\r\nNot sure if this PR fixed them, or some another, but these two issues are not reproducible anymore:\r\n- Fixes #1928\r\n- Fixes #1931\r\n\r\n**API Changes**\r\n\r\nNone. Unless I missed any.\r\n\r\n**Behavioral Changes**\r\n\r\nNone. Hopefully.\r\n\r\n**Required skia PR**\r\n\r\nNone.\r\n\r\n**PR Checklist**\r\n\r\n- [ ] Has tests (if omitted, state reason in description)\r\n- [x] Rebased on top of main at time of PR\r\n- [ ] Merged related skia PRs\r\n- [x] Changes adhere to coding standard\r\n- [ ] Updated documentation\r\n",
  "author": {
    "login": "maxkatz6",
    "type": "User"
  },
  "labels": [
    {
      "name": "community \u2728",
      "color": "ededed"
    }
  ],
  "assignees": [],
  "createdAt": "2024-07-03T07:03:10",
  "updatedAt": "2024-08-21T15:17:05",
  "closedAt": "2024-08-21T15:16:05",
  "commentCount": 30,
  "reactionCount": 10,
  "draft": false,
  "mergeableState": "unknown",
  "baseBranch": "main",
  "headBranch": "function-pointers-and-library-import",
  "additions": 7937,
  "deletions": 536,
  "changedFiles": 62,
  "commits": 30,
  "reviews": [
    {
      "author": "filipnavara",
      "state": "COMMENTED",
      "submittedAt": "2024-08-20T14:23:39"
    },
    {
      "author": "maxkatz6",
      "state": "COMMENTED",
      "submittedAt": "2024-08-20T18:53:09"
    },
    {
      "author": "mattleibow",
      "state": "COMMENTED",
      "submittedAt": "2024-08-21T05:04:19"
    },
    {
      "author": "filipnavara",
      "state": "COMMENTED",
      "submittedAt": "2024-08-21T06:55:45"
    }
  ],
  "engagement": {
    "syncedAt": "2026-02-04T20:12:11.5620958Z",
    "reactions": [
      {
        "user": "angelofb",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621011Z"
      },
      {
        "user": "mattleibow",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621017Z"
      },
      {
        "user": "charlesroddie",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621152Z"
      },
      {
        "user": "ptasev",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621157Z"
      },
      {
        "user": "inforithmics",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.562116Z"
      },
      {
        "user": "hez2010",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621162Z"
      },
      {
        "user": "latop2604",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621163Z"
      },
      {
        "user": "ScrubN",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621168Z"
      },
      {
        "user": "FoggyFinder",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.562117Z"
      },
      {
        "user": "myd7349",
        "content": "rocket",
        "createdAt": "2026-02-04T20:12:11.5621171Z"
      }
    ],
    "comments": [
      {
        "id": 2207122422,
        "author": "mattleibow",
        "createdAt": "2024-07-03T19:59:09",
        "reactions": [
          {
            "user": "angelofb",
            "content": "laugh",
            "createdAt": "2026-02-04T20:12:04.3482144Z"
          }
        ]
      },
      {
        "id": 2207125066,
        "author": "mattleibow",
        "createdAt": "2024-07-03T20:00:05",
        "reactions": []
      },
      {
        "id": 2207275965,
        "author": "mattleibow",
        "createdAt": "2024-07-03T20:57:53",
        "reactions": []
      },
      {
        "id": 2207289889,
        "author": "mattleibow",
        "createdAt": "2024-07-03T21:02:47",
        "reactions": []
      },
      {
        "id": 2207356609,
        "author": "mattleibow",
        "createdAt": "2024-07-03T21:39:02",
        "reactions": []
      },
      {
        "id": 2207400642,
        "author": "maxkatz6",
        "createdAt": "2024-07-03T22:18:27",
        "reactions": []
      },
      {
        "id": 2207419547,
        "author": "maxkatz6",
        "createdAt": "2024-07-03T22:31:29",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:12:05.8505339Z"
          }
        ]
      },
      {
        "id": 2208088882,
        "author": "maxkatz6",
        "createdAt": "2024-07-04T04:16:01",
        "reactions": []
      },
      {
        "id": 2208657911,
        "author": "mattleibow",
        "createdAt": "2024-07-04T10:38:10",
        "reactions": []
      },
      {
        "id": 2219922015,
        "author": "maxkatz6",
        "createdAt": "2024-07-10T08:46:07",
        "reactions": []
      },
      {
        "id": 2219933282,
        "author": "filipnavara",
        "createdAt": "2024-07-10T08:51:21",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:12:06.788144Z"
          }
        ]
      },
      {
        "id": 2219950808,
        "author": "maxkatz6",
        "createdAt": "2024-07-10T09:00:14",
        "reactions": []
      },
      {
        "id": 2220001502,
        "author": "mattleibow",
        "createdAt": "2024-07-10T09:25:35",
        "reactions": []
      },
      {
        "id": 2220050328,
        "author": "mattleibow",
        "createdAt": "2024-07-10T09:49:34",
        "reactions": [
          {
            "user": "maxkatz6",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:12:07.5000726Z"
          }
        ]
      },
      {
        "id": 2220079394,
        "author": "maxkatz6",
        "createdAt": "2024-07-10T10:04:03",
        "reactions": []
      },
      {
        "id": 2220118981,
        "author": "mattleibow",
        "createdAt": "2024-07-10T10:22:50",
        "reactions": []
      },
      {
        "id": 2234394492,
        "author": "maxkatz6",
        "createdAt": "2024-07-17T21:59:11",
        "reactions": []
      },
      {
        "id": 2237455592,
        "author": "mattleibow",
        "createdAt": "2024-07-18T19:55:10",
        "reactions": []
      },
      {
        "id": 2237739325,
        "author": "maxkatz6",
        "createdAt": "2024-07-18T22:41:30",
        "reactions": []
      },
      {
        "id": 2237740109,
        "author": "maxkatz6",
        "createdAt": "2024-07-18T22:42:35",
        "reactions": [
          {
            "user": "mattleibow",
            "content": "\u002B1",
            "createdAt": "2026-02-04T20:12:09.0062169Z"
          }
        ]
      },
      {
        "id": 2237740933,
        "author": "maxkatz6",
        "createdAt": "2024-07-18T22:43:33",
        "reactions": []
      },
      {
        "id": 2237828348,
        "author": "maxkatz6",
        "createdAt": "2024-07-19T01:00:05",
        "reactions": []
      },
      {
        "id": 2237952994,
        "author": "mattleibow",
        "createdAt": "2024-07-19T02:35:37",
        "reactions": []
      },
      {
        "id": 2292423976,
        "author": "maxkatz6",
        "createdAt": "2024-08-15T22:57:45",
        "reactions": []
      },
      {
        "id": 2298784576,
        "author": "mattleibow",
        "createdAt": "2024-08-20T12:50:56",
        "reactions": []
      },
      {
        "id": 2298924121,
        "author": "mattleibow",
        "createdAt": "2024-08-20T13:54:42",
        "reactions": []
      },
      {
        "id": 2298981884,
        "author": "filipnavara",
        "createdAt": "2024-08-20T14:19:16",
        "reactions": []
      },
      {
        "id": 2299163765,
        "author": "mattleibow",
        "createdAt": "2024-08-20T15:39:59",
        "reactions": []
      },
      {
        "id": 2299553872,
        "author": "maxkatz6",
        "createdAt": "2024-08-20T18:59:19",
        "reactions": []
      },
      {
        "id": 2302345271,
        "author": "mattleibow",
        "createdAt": "2024-08-21T15:17:04",
        "reactions": [
          {
            "user": "yowl",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117817Z"
          },
          {
            "user": "SingleAccretion",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117822Z"
          },
          {
            "user": "filipnavara",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117823Z"
          },
          {
            "user": "charlesroddie",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117826Z"
          },
          {
            "user": "snickler",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117828Z"
          },
          {
            "user": "maxkatz6",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117844Z"
          },
          {
            "user": "latop2604",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117845Z"
          },
          {
            "user": "antonheryanto",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117846Z"
          },
          {
            "user": "ScrubN",
            "content": "heart",
            "createdAt": "2026-02-04T20:12:11.5117848Z"
          }
        ]
      }
    ]
  }
}