@page "/triage/{Number:int}"
@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>@(_issueTitle ?? _issue?.Summary ?? $"Issue #{Number}") - SkiaSharp Dashboard</PageTitle>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_issue is null && _repro is null && _fix is null)
{
    <h1>Issue Not Found</h1>
    <p>No triage or reproduction data for issue #@Number.</p>
    <a href="triage" class="btn-back">‚Üê Back to Triage</a>
}
else
{
    <!-- Navigation Bar -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" />

    <!-- Header -->
    <div class="triage-detail-header">
        <div class="detail-title-row">
            @if (_issue is not null)
            {
                <a href="https://github.com/@_issue.Meta.Repo/issues/@_issue.Meta.Number" target="_blank" class="issue-link-lg">#@_issue.Meta.Number</a>
                <h1>@(_issueTitle ?? _issue.Summary)</h1>
            }
            else
            {
                <a href="https://github.com/@_repro!.Meta.Repo/issues/@Number" target="_blank" class="issue-link-lg">#@Number</a>
                <h1>Issue #@Number</h1>
            }
        </div>
        <div class="detail-badges">
            @if (_issue is not null)
            {
                <span class="badge-type badge-@StripPrefix(_issue.Classification.Type.Value)">
                    @FormatLabel(_issue.Classification.Type.Value)
                </span>
                @if (_issue.Evidence.BugSignals?.Severity is not null)
                {
                    <span class="badge-severity badge-sev-@_issue.Evidence.BugSignals.Severity.Value.ToJsonString()">
                        @FormatLabel(_issue.Evidence.BugSignals.Severity.Value.ToJsonString())
                    </span>
                }
                <span class="badge-action badge-act-@_issue.Output.Actionability.SuggestedAction.ToJsonString()">
                    @FormatLabel(_issue.Output.Actionability.SuggestedAction.ToJsonString())
                </span>
                <span class="confidence-pill-lg" title="Overall confidence in the suggested action. 95%+ = explicit evidence, 80-94% = strong inference, 60-79% = ambiguous">
                    <span class="confidence-bar @GetConfidenceClass(_issue.Output.Actionability.Confidence)" style="width: @((int)(_issue.Output.Actionability.Confidence * 100))%"></span>
                    <span class="confidence-text">@_issue.Output.Actionability.Confidence.ToString("P0")</span>
                </span>
                @if (_issue.Output.Actions.Any(a => a.Type == ActionType.CloseIssue))
                {
                    <span class="badge-closeable" title="Has a close-issue action ‚Äî AI believes this can be closed">‚úì Closeable</span>
                }
            }
            @if (_repro is not null)
            {
                <span class="badge-repro-conclusion badge-repro-@_repro.Conclusion.ToJsonString()">üß™ @FormatLabel(_repro.Conclusion.ToJsonString())</span>
            }
        </div>
        @if (_issue is not null)
        {
            <p class="detail-meta">
                Analyzed: @_issue.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")
                ¬∑ Repo: <a href="https://github.com/@_issue.Meta.Repo" target="_blank">@_issue.Meta.Repo</a>
            </p>
        }
    </div>

    <!-- Pipeline Stepper -->
    <PipelineStepper HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" />

    <!-- Tabs -->
    <DetailTabs HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" 
                ActiveTab="@_activeTab" OnTabChanged="@(tab => _activeTab = tab)" />

    @* ‚ïê‚ïê‚ïê Tab 1: Triage ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <TriageTabPanel Issue="@_issue" ActiveTab="@_activeTab" />
    }

    @* ‚ïê‚ïê‚ïê Tab 2: Reproduction ‚ïê‚ïê‚ïê *@
    @if (_repro is not null)
    {
        <ReproTabPanel Repro="@_repro" ActiveTab="@_activeTab" />
    }

    @* ‚ïê‚ïê‚ïê Tab 3: Actions ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <ActionsTabPanel Issue="@_issue" ActiveTab="@_activeTab" />
    }

    @* ‚ïê‚ïê‚ïê Tab 4: Analysis ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <AnalysisTabPanel Issue="@_issue" ActiveTab="@_activeTab" />
    }

    @* ‚ïê‚ïê‚ïê Tab 5: Fix ‚ïê‚ïê‚ïê *@
    @if (_fix is not null)
    {
        <div class="tab-panel @(_activeTab == "fix" ? "active" : "")">
            <section class="fix-section">
                <!-- Status & Summary -->
                <div class="fix-header">
                    <span class="badge-fix-status badge-fix-@_fix.Status.ToJsonString()">@FormatLabel(_fix.Status.ToJsonString())</span>
                    <p class="fix-summary">@_fix.Summary</p>
                </div>

                <!-- Root Cause -->
                <div class="detail-card">
                    <h3>Root Cause</h3>
                    <div class="field-row">
                        <span class="label">@FormatLabel(_fix.RootCause.Category.ToJsonString())</span>
                        <span class="label">@FormatLabel(_fix.RootCause.Area.ToJsonString())</span>
                    </div>
                    <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(_fix.RootCause.Description)</div>
                    @if (_fix.RootCause.AffectedFiles is { Count: > 0 })
                    {
                        <div class="field-row" style="margin-top: 0.5rem">
                            <span class="field-label">Affected:</span>
                            @foreach (var f in _fix.RootCause.AffectedFiles)
                            {
                                <code style="margin-right: 0.25rem;">@f</code>
                            }
                        </div>
                    }
                </div>

                <!-- Changes -->
                <div class="detail-card">
                    <h3>Changes</h3>
                    <div class="field-row">
                        <span class="badge-risk badge-risk-@_fix.Changes.Risk.ToJsonString()" style="@GetRiskStyle(_fix.Changes.Risk)">@FormatLabel(_fix.Changes.Risk.ToJsonString()) risk</span>
                        @if (_fix.Changes.BreakingChange)
                        {
                            <span class="label" style="background: #dc3545; color: white;">‚ö† Breaking Change</span>
                        }
                    </div>
                    @if (_fix.Changes.Files is { Count: > 0 })
                    {
                        <table class="repro-version-table" style="margin-top: 0.5rem">
                            <thead><tr><th>File</th><th>Change</th><th>Summary</th></tr></thead>
                            <tbody>
                                @foreach (var fc in _fix.Changes.Files)
                                {
                                    <tr>
                                        <td><code>@fc.Path</code></td>
                                        <td><span class="label">@FormatLabel(fc.ChangeType.ToJsonString())</span></td>
                                        <td>@fc.Summary</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <!-- Tests -->
                <div class="detail-card">
                    <h3>Tests</h3>
                    <div class="field-row">
                        <span class="label">Result: @FormatLabel(_fix.Tests.Result.ToJsonString())</span>
                        <span class="signal @(_fix.Tests.RegressionTestAdded ? "signal-yes" : "signal-no")">
                            @(_fix.Tests.RegressionTestAdded ? "‚úì Regression test added" : "‚úó No regression test")
                        </span>
                    </div>
                    @if (_fix.Tests.TestsAdded is { Count: > 0 })
                    {
                        <ul style="margin-top: 0.5rem">
                            @foreach (var t in _fix.Tests.TestsAdded)
                            {
                                <li><code>@t.File</code> ‚Äî @t.Name</li>
                            }
                        </ul>
                    }
                    @if (_fix.Tests.Command is not null)
                    {
                        <pre class="file-content" style="margin-top: 0.5rem"><code>@_fix.Tests.Command</code></pre>
                    }
                </div>

                <!-- Verification -->
                <div class="detail-card">
                    <h3>Verification</h3>
                    <div class="field-row">
                        <span class="label">Repro scenario: @FormatLabel(_fix.Verification.ReproScenario.ToJsonString())</span>
                    </div>
                    @if (_fix.Verification.Notes is not null)
                    {
                        <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(_fix.Verification.Notes)</div>
                    }
                </div>

                <!-- PR -->
                @if (_fix.Pr is not null)
                {
                    <div class="detail-card">
                        <h3>Pull Request</h3>
                        <div class="field-row">
                            <a href="@_fix.Pr.Url" target="_blank">
                                @if (_fix.Pr.Number is not null) { <span>PR #@_fix.Pr.Number</span> } else { <span>@_fix.Pr.Url</span> }
                            </a>
                            <span class="label">@FormatLabel(_fix.Pr.Status.ToJsonString())</span>
                        </div>
                    </div>
                }

                <!-- Feedback Corrections -->
                @if (_fix.Feedback?.Corrections is { Count: > 0 })
                {
                    <div class="detail-card">
                        <h3>Upstream Corrections</h3>
                        @foreach (var c in _fix.Feedback.Corrections)
                        {
                            <div class="correction-item" style="margin-bottom: 0.75rem; padding: 0.5rem; border-left: 3px solid #ffc107; background: rgba(255, 193, 7, 0.05);">
                                <span class="label">@FormatLabel(c.Source.ToJsonString())</span>
                                <span class="label">@c.Topic</span>
                                <div style="margin-top: 0.25rem;">
                                    <span style="text-decoration: line-through; opacity: 0.6;">@c.Upstream</span>
                                    ‚Üí <strong>@c.Corrected</strong>
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Related Issues -->
                @if (_fix.RelatedIssues is { Count: > 0 })
                {
                    <div class="field-row" style="margin-top: 0.5rem">
                        <span class="field-label">Related issues:</span>
                        @foreach (var num in _fix.RelatedIssues)
                        {
                            <a href="triage/@num" class="related-issue-link">#@num</a>
                        }
                    </div>
                }

                @if (_fix.Inputs is not null && (_fix.Inputs.TriageFile is not null || _fix.Inputs.ReproFile is not null))
                {
                    <div class="field-row" style="margin-top: 0.5rem; opacity: 0.7;">
                        @if (_fix.Inputs.TriageFile is not null)
                        {
                            <span class="field-label">Triage:</span> <code>@_fix.Inputs.TriageFile</code>
                        }
                        @if (_fix.Inputs.ReproFile is not null)
                        {
                            <span class="field-label" style="margin-left: 0.5rem;">Repro:</span> <code>@_fix.Inputs.ReproFile</code>
                        }
                    </div>
                }

                <p class="last-updated">Fix analyzed: @_fix.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
            </section>
        </div>
    }

    <!-- Bottom Navigation -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" IsBottom="true" />
}

@code {
    [Parameter] public int Number { get; set; }

    [SupplyParameterFromQuery] public string? Action { get; set; }
    [SupplyParameterFromQuery] public string? Type { get; set; }
    [SupplyParameterFromQuery] public string? Area { get; set; }
    [SupplyParameterFromQuery] public string? Severity { get; set; }
    [SupplyParameterFromQuery] public string? Repro { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }
    [SupplyParameterFromQuery] public string? Card { get; set; }

    private TriageIndex? _index;
    private TriagedIssue? _issue;
    private ReproResult? _repro;
    private FixResult? _fix;
    private string? _issueTitle;
    private int? _prevNumber;
    private int? _nextNumber;
    private int _currentIndex;
    private int _totalCount;
    private bool _loading = true;
    private string _activeTab = "triage";

    protected override async Task OnInitializedAsync()
    {
        var indexTask = DataService.GetTriageIndexAsync();
        var triageTask = DataService.GetTriageDetailAsync(Number);
        var reproTask = DataService.GetReproDetailAsync(Number);
        var fixTask = DataService.GetFixDetailAsync(Number);

        await Task.WhenAll(indexTask, triageTask, reproTask, fixTask);

        _index = indexTask.Result;
        _issue = triageTask.Result;
        _repro = reproTask.Result;
        _fix = fixTask.Result;
        _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
        _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
        LoadNavigation();
        _loading = false;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_loading)
        {
            _issue = await DataService.GetTriageDetailAsync(Number);
            _repro = await DataService.GetReproDetailAsync(Number);
            _fix = await DataService.GetFixDetailAsync(Number);
            _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
            _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
            LoadNavigation();
        }
    }

    private void LoadNavigation()
    {
        if (_index is null) return;

        var filtered = ApplyFilters(_index.Issues);
        _totalCount = filtered.Count;
        _currentIndex = filtered.FindIndex(i => i.Number == Number);

        if (_currentIndex >= 0)
        {
            _prevNumber = _currentIndex > 0 ? filtered[_currentIndex - 1].Number : null;
            _nextNumber = _currentIndex < filtered.Count - 1 ? filtered[_currentIndex + 1].Number : null;
        }
        else
        {
            _prevNumber = null;
            _nextNumber = null;
            _totalCount = _index.Issues.Count;
            _currentIndex = _index.Issues.FindIndex(i => i.Number == Number);
        }
    }

    private List<TriageIndexEntry> ApplyFilters(List<TriageIndexEntry> issues)
    {
        var query = issues.AsEnumerable();

        if (!string.IsNullOrEmpty(Card))
        {
            query = Card switch
            {
                "needs-investigation" => query.Where(i => i.Action == "needs-investigation"),
                "closeable" => query.Where(i => i.Closeable),
                "quick-wins" => query.Where(i => i.Closeable),
                "regressions" => query.Where(i => i.IsRegression),
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(Action))
            query = query.Where(i => i.Action == Action);
        if (!string.IsNullOrEmpty(Type))
            query = query.Where(i => i.Type == Type);
        if (!string.IsNullOrEmpty(Area))
            query = query.Where(i => i.Area == Area);
        if (!string.IsNullOrEmpty(Severity))
            query = query.Where(i => i.Severity == Severity);
        if (!string.IsNullOrEmpty(Repro))
        {
            query = Repro switch
            {
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query.Where(i => i.ReproConclusion == Repro)
            };
        }

        var sort = Sort ?? "newest";
        query = sort switch
        {
            "confidence" => query.OrderByDescending(i => i.Confidence ?? 0),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Severity)),
            _ => query.OrderByDescending(i => i.Number)
        };

        return query.ToList();
    }

    private string BackUrl
    {
        get
        {
            var parts = new List<string>();
            if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
            if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
            if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
            if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
            if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
            if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
            if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
            return parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        }
    }

    private string DetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
        if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
        if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
        if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
        if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
        if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
        if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(string? severity) => TriageFormatHelper.SeverityOrder(severity);

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch { }
    }

    private string GetFileUrl(CodeInvestigationEntry entry) =>
        TriageFormatHelper.GetFileUrl(_issue?.Meta.Repo ?? "mono/SkiaSharp", entry);

    [Inject] private Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; } = default!;
}
