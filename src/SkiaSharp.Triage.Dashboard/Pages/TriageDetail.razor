@page "/triage/{Number:int}"
@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>@(_issueTitle ?? _issue?.Summary ?? $"Issue #{Number}") - SkiaSharp Dashboard</PageTitle>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_issue is null && _repro is null && _fix is null)
{
    <h1>Issue Not Found</h1>
    <p>No triage or reproduction data for issue #@Number.</p>
    <a href="triage" class="btn-back">â† Back to Triage</a>
}
else
{
    <!-- Navigation Bar -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" />

    <!-- Header -->
    <div class="triage-detail-header">
        <div class="detail-title-row">
            @if (_issue is not null)
            {
                <a href="https://github.com/@_issue.Meta.Repo/issues/@_issue.Meta.Number" target="_blank" class="issue-link-lg">#@_issue.Meta.Number</a>
                <h1>@(_issueTitle ?? _issue.Summary)</h1>
            }
            else
            {
                <a href="https://github.com/@_repro!.Meta.Repo/issues/@Number" target="_blank" class="issue-link-lg">#@Number</a>
                <h1>Issue #@Number</h1>
            }
        </div>
        <div class="detail-badges">
            @if (_issue is not null)
            {
                <span class="badge-type badge-@StripPrefix(_issue.Classification.Type.Value)">
                    @FormatLabel(_issue.Classification.Type.Value)
                </span>
                @if (_issue.Evidence.BugSignals?.Severity is not null)
                {
                    <span class="badge-severity badge-sev-@_issue.Evidence.BugSignals.Severity.Value.ToJsonString()">
                        @FormatLabel(_issue.Evidence.BugSignals.Severity.Value.ToJsonString())
                    </span>
                }
                <span class="badge-action badge-act-@_issue.Output.Actionability.SuggestedAction.ToJsonString()">
                    @FormatLabel(_issue.Output.Actionability.SuggestedAction.ToJsonString())
                </span>
                <span class="confidence-pill-lg" title="Overall confidence in the suggested action. 95%+ = explicit evidence, 80-94% = strong inference, 60-79% = ambiguous">
                    <span class="confidence-bar @GetConfidenceClass(_issue.Output.Actionability.Confidence)" style="width: @((int)(_issue.Output.Actionability.Confidence * 100))%"></span>
                    <span class="confidence-text">@_issue.Output.Actionability.Confidence.ToString("P0")</span>
                </span>
                @if (_issue.Output.Actions.Any(a => a.Type == ActionType.CloseIssue))
                {
                    <span class="badge-closeable" title="Has a close-issue action â€” AI believes this can be closed">âœ“ Closeable</span>
                }
            }
            @if (_repro is not null)
            {
                <span class="badge-repro-conclusion badge-repro-@_repro.Conclusion.ToJsonString()">ğŸ§ª @FormatLabel(_repro.Conclusion.ToJsonString())</span>
            }
        </div>
        @if (_issue is not null)
        {
            <p class="detail-meta">
                Analyzed: @_issue.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")
                Â· Repo: <a href="https://github.com/@_issue.Meta.Repo" target="_blank">@_issue.Meta.Repo</a>
            </p>
        }
    </div>

    <!-- Pipeline Stepper -->
    <PipelineStepper HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" />

    <!-- Tabs -->
    <DetailTabs HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" 
                ActiveTab="@_activeTab" OnTabChanged="@(tab => _activeTab = tab)" />

    @* â•â•â• Tab 1: Triage â•â•â• *@
    @if (_issue is not null)
    {
        <TriageTabPanel Issue="@_issue" ActiveTab="@_activeTab" />
    }

    @* â•â•â• Tab 2: Reproduction â•â•â• *@
    @if (_repro is not null)
    {
        <ReproTabPanel Repro="@_repro" ActiveTab="@_activeTab" />
    }

    @* â•â•â• Tab 3: Response â•â•â• *@
    @if (_issue is not null || _repro is not null)
    {
        <ResponseTabPanel Issue="@_issue" Repro="@_repro" ActiveTab="@_activeTab" />
    }

    @* â•â•â• Tab 4: Analysis (includes Fix) â•â•â• *@
    @if (_issue is not null)
    {
        <AnalysisTabPanel Issue="@_issue" Fix="@_fix" ActiveTab="@_activeTab" />
    }

    <!-- Bottom Navigation -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" IsBottom="true" />
}

@code {
    [Parameter] public int Number { get; set; }

    [SupplyParameterFromQuery] public string? Action { get; set; }
    [SupplyParameterFromQuery] public string? Type { get; set; }
    [SupplyParameterFromQuery] public string? Area { get; set; }
    [SupplyParameterFromQuery] public string? Severity { get; set; }
    [SupplyParameterFromQuery] public string? Repro { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }
    [SupplyParameterFromQuery] public string? Card { get; set; }

    private TriageIndex? _index;
    private TriagedIssue? _issue;
    private ReproResult? _repro;
    private FixResult? _fix;
    private string? _issueTitle;
    private int? _prevNumber;
    private int? _nextNumber;
    private int _currentIndex;
    private int _totalCount;
    private bool _loading = true;
    private string _activeTab = "triage";

    protected override async Task OnInitializedAsync()
    {
        var indexTask = DataService.GetTriageIndexAsync();
        var triageTask = DataService.GetTriageDetailAsync(Number);
        var reproTask = DataService.GetReproDetailAsync(Number);
        var fixTask = DataService.GetFixDetailAsync(Number);

        await Task.WhenAll(indexTask, triageTask, reproTask, fixTask);

        _index = indexTask.Result;
        _issue = triageTask.Result;
        _repro = reproTask.Result;
        _fix = fixTask.Result;
        _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
        _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
        LoadNavigation();
        _loading = false;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_loading)
        {
            _issue = await DataService.GetTriageDetailAsync(Number);
            _repro = await DataService.GetReproDetailAsync(Number);
            _fix = await DataService.GetFixDetailAsync(Number);
            _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
            _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
            LoadNavigation();
        }
    }

    private void LoadNavigation()
    {
        if (_index is null) return;

        var filtered = ApplyFilters(_index.Issues);
        _totalCount = filtered.Count;
        _currentIndex = filtered.FindIndex(i => i.Number == Number);

        if (_currentIndex >= 0)
        {
            _prevNumber = _currentIndex > 0 ? filtered[_currentIndex - 1].Number : null;
            _nextNumber = _currentIndex < filtered.Count - 1 ? filtered[_currentIndex + 1].Number : null;
        }
        else
        {
            _prevNumber = null;
            _nextNumber = null;
            _totalCount = _index.Issues.Count;
            _currentIndex = _index.Issues.FindIndex(i => i.Number == Number);
        }
    }

    private List<TriageIndexEntry> ApplyFilters(List<TriageIndexEntry> issues)
    {
        var query = issues.AsEnumerable();

        if (!string.IsNullOrEmpty(Card))
        {
            query = Card switch
            {
                "needs-investigation" => query.Where(i => i.Action == "needs-investigation"),
                "closeable" => query.Where(i => i.Closeable),
                "quick-wins" => query.Where(i => i.Closeable),
                "regressions" => query.Where(i => i.IsRegression),
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(Action))
            query = query.Where(i => i.Action == Action);
        if (!string.IsNullOrEmpty(Type))
            query = query.Where(i => i.Type == Type);
        if (!string.IsNullOrEmpty(Area))
            query = query.Where(i => i.Area == Area);
        if (!string.IsNullOrEmpty(Severity))
            query = query.Where(i => i.Severity == Severity);
        if (!string.IsNullOrEmpty(Repro))
        {
            query = Repro switch
            {
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query.Where(i => i.ReproConclusion == Repro)
            };
        }

        var sort = Sort ?? "newest";
        query = sort switch
        {
            "confidence" => query.OrderByDescending(i => i.Confidence ?? 0),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Severity)),
            _ => query.OrderByDescending(i => i.Number)
        };

        return query.ToList();
    }

    private string BackUrl
    {
        get
        {
            var parts = new List<string>();
            if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
            if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
            if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
            if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
            if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
            if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
            if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
            return parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        }
    }

    private string DetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
        if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
        if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
        if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
        if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
        if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
        if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(string? severity) => TriageFormatHelper.SeverityOrder(severity);

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch { }
    }

    private string GetFileUrl(CodeInvestigationEntry entry) =>
        TriageFormatHelper.GetFileUrl(_issue?.Meta.Repo ?? "mono/SkiaSharp", entry);

    [Inject] private Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; } = default!;
}
