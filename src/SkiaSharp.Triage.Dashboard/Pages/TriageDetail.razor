@page "/triage/{Number:int}"
@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>@(_issueTitle ?? _issue?.Summary ?? $"Issue #{Number}") - SkiaSharp Dashboard</PageTitle>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_issue is null && _repro is null && _fix is null)
{
    <h1>Issue Not Found</h1>
    <p>No triage or reproduction data for issue #@Number.</p>
    <a href="triage" class="btn-back">‚Üê Back to Triage</a>
}
else
{
    <!-- Navigation Bar -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" />

    <!-- Header -->
    <div class="triage-detail-header">
        <div class="detail-title-row">
            @if (_issue is not null)
            {
                <a href="https://github.com/@_issue.Meta.Repo/issues/@_issue.Meta.Number" target="_blank" class="issue-link-lg">#@_issue.Meta.Number</a>
                <h1>@(_issueTitle ?? _issue.Summary)</h1>
            }
            else
            {
                <a href="https://github.com/@_repro!.Meta.Repo/issues/@Number" target="_blank" class="issue-link-lg">#@Number</a>
                <h1>Issue #@Number</h1>
            }
        </div>
        <div class="detail-badges">
            @if (_issue is not null)
            {
                <span class="badge-type badge-@StripPrefix(_issue.Classification.Type.Value)">
                    @FormatLabel(_issue.Classification.Type.Value)
                </span>
                @if (_issue.Evidence.BugSignals?.Severity is not null)
                {
                    <span class="badge-severity badge-sev-@_issue.Evidence.BugSignals.Severity.Value.ToJsonString()">
                        @FormatLabel(_issue.Evidence.BugSignals.Severity.Value.ToJsonString())
                    </span>
                }
                <span class="badge-action badge-act-@_issue.Output.Actionability.SuggestedAction.ToJsonString()">
                    @FormatLabel(_issue.Output.Actionability.SuggestedAction.ToJsonString())
                </span>
                <span class="confidence-pill-lg" title="Overall confidence in the suggested action. 95%+ = explicit evidence, 80-94% = strong inference, 60-79% = ambiguous">
                    <span class="confidence-bar @GetConfidenceClass(_issue.Output.Actionability.Confidence)" style="width: @((int)(_issue.Output.Actionability.Confidence * 100))%"></span>
                    <span class="confidence-text">@_issue.Output.Actionability.Confidence.ToString("P0")</span>
                </span>
                @if (_issue.Output.Actions.Any(a => a.Type == ActionType.CloseIssue))
                {
                    <span class="badge-closeable" title="Has a close-issue action ‚Äî AI believes this can be closed">‚úì Closeable</span>
                }
            }
            @if (_repro is not null)
            {
                <span class="badge-repro-conclusion badge-repro-@_repro.Conclusion.ToJsonString()">üß™ @FormatLabel(_repro.Conclusion.ToJsonString())</span>
            }
        </div>
        @if (_issue is not null)
        {
            <p class="detail-meta">
                Analyzed: @_issue.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")
                ¬∑ Repo: <a href="https://github.com/@_issue.Meta.Repo" target="_blank">@_issue.Meta.Repo</a>
            </p>
        }
    </div>

    <!-- Pipeline Stepper -->
    <PipelineStepper HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" />

    <!-- Tabs -->
    <DetailTabs HasTriage="@(_issue is not null)" HasRepro="@(_repro is not null)" HasFix="@(_fix is not null)" 
                ActiveTab="@_activeTab" OnTabChanged="@(tab => _activeTab = tab)" />

    @* ‚ïê‚ïê‚ïê Tab 1: Triage ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <TriageTabPanel Issue="@_issue" ActiveTab="@_activeTab" />
    }

    @* ‚ïê‚ïê‚ïê Tab 2: Reproduction ‚ïê‚ïê‚ïê *@
    @if (_repro is not null)
    {
        <div class="tab-panel @(_activeTab == "repro" ? "active" : "")">
            <section class="repro-section">
                <!-- Conclusion Badge -->
                <div class="repro-conclusion">
                    <span class="badge-repro-conclusion badge-repro-@_repro.Conclusion.ToJsonString()">@FormatLabel(_repro.Conclusion.ToJsonString())</span>
                    @if (!string.IsNullOrEmpty(_repro.Assessment))
                    {
                        <span class="badge-assessment">@FormatLabel(_repro.Assessment)</span>
                    }
                    @if (!string.IsNullOrEmpty(_repro.Notes))
                    {
                        <p class="repro-notes">@_repro.Notes</p>
                    }
                </div>

                <!-- Version Results -->
                @if (_repro.VersionResults is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Version Test Results</h3>
                        <table class="repro-version-table">
                            <thead>
                                <tr><th>Version</th><th>Source</th><th>Result</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var vr in _repro.VersionResults)
                                {
                                    <tr class="version-result-@vr.Result.ToJsonString()">
                                        <td><code>@vr.Version</code></td>
                                        <td>@FormatLabel(vr.Source.ToJsonString())</td>
                                        <td><span class="badge-version-result badge-vr-@vr.Result.ToJsonString()">@FormatLabel(vr.Result.ToJsonString())</span></td>
                                        <td>@(vr.Notes ?? "‚Äî")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <!-- Environment -->
                <div class="repro-card">
                    <h3>Environment</h3>
                    <div class="repro-env-grid">
                        <div class="env-item"><span class="env-label">OS</span><span class="env-value">@_repro.Environment.Os</span></div>
                        <div class="env-item"><span class="env-label">Arch</span><span class="env-value">@_repro.Environment.Arch</span></div>
                        <div class="env-item"><span class="env-label">.NET</span><span class="env-value">@_repro.Environment.DotnetVersion</span></div>
                        <div class="env-item"><span class="env-label">SkiaSharp</span><span class="env-value">@_repro.Environment.SkiaSharpVersion</span></div>
                        <div class="env-item"><span class="env-label">Docker</span><span class="env-value">@(_repro.Environment.DockerUsed ? "Yes" : "No")</span></div>
                        @if (_repro.Environment.Gpu is not null)
                        {
                            <div class="env-item"><span class="env-label">GPU</span><span class="env-value">@(_repro.Environment.Gpu.Available ? (_repro.Environment.Gpu.Backend ?? "Available") : "Not Available")</span></div>
                        }
                    </div>
                </div>

                <!-- Repro Project -->
                @if (_repro.ReproProject is not null)
                {
                    <div class="repro-card">
                        <h3>Reproduction Project</h3>
                        <div class="repro-env-grid">
                            <div class="env-item"><span class="env-label">Type</span><span class="env-value">@FormatLabel(_repro.ReproProject.Type.ToJsonString())</span></div>
                            <div class="env-item"><span class="env-label">TFM</span><span class="env-value"><code>@_repro.ReproProject.Tfm</code></span></div>
                        </div>
                        @if (_repro.ReproProject.Packages is { Count: > 0 })
                        {
                            <h4>Packages</h4>
                            <ul class="repro-packages">
                                @foreach (var pkg in _repro.ReproProject.Packages)
                                {
                                    <li><code>@pkg.Name</code> <span class="pkg-version">@pkg.Version</span></li>
                                }
                            </ul>
                        }
                    </div>
                }

                <!-- Error Messages -->
                @if (_repro.ErrorMessages is not null)
                {
                    <div class="repro-card repro-errors">
                        <h3>Error Messages</h3>
                        @if (!string.IsNullOrEmpty(_repro.ErrorMessages.PrimaryError))
                        {
                            <div class="error-primary">
                                <strong>Primary Error:</strong>
                                <pre><code>@_repro.ErrorMessages.PrimaryError</code></pre>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(_repro.ErrorMessages.StackTrace))
                        {
                            <details>
                                <summary>Stack Trace</summary>
                                <pre class="stack-trace"><code>@_repro.ErrorMessages.StackTrace</code></pre>
                            </details>
                        }
                        @if (_repro.ErrorMessages.AdditionalErrors is { Count: > 0 })
                        {
                            <details>
                                <summary>Additional Errors (@_repro.ErrorMessages.AdditionalErrors.Count)</summary>
                                <ul>
                                    @foreach (var err in _repro.ErrorMessages.AdditionalErrors)
                                    {
                                        <li><code>@err</code></li>
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                }

                <!-- Artifacts -->
                @if (_repro.Artifacts is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Artifacts</h3>
                        <div class="repro-artifacts">
                            @foreach (var artifact in _repro.Artifacts)
                            {
                                <div class="artifact-item">
                                    <span class="artifact-name">@artifact.Filename</span>
                                    <span class="artifact-desc">@artifact.Description</span>
                                    <span class="artifact-source badge-layer-@artifact.Source.ToJsonString()">@FormatLabel(artifact.Source.ToJsonString())</span>
                                    @if (artifact.Available && !string.IsNullOrEmpty(artifact.Url))
                                    {
                                        <a href="@artifact.Url" target="_blank" class="artifact-link">View</a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Blockers -->
                @if (_repro.Blockers is { Count: > 0 })
                {
                    <div class="repro-card repro-blockers">
                        <h3>Blockers</h3>
                        <ul>
                            @foreach (var b in _repro.Blockers)
                            {
                                <li>@b</li>
                            }
                        </ul>
                    </div>
                }

                <!-- Reproduction Steps (last ‚Äî these are long) -->
                @if (_repro.ReproductionSteps is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Reproduction Steps</h3>
                        <div class="repro-steps">
                            @foreach (var step in _repro.ReproductionSteps)
                            {
                                <div class="repro-step">
                                    <div class="step-header">
                                        <span class="step-number">@step.StepNumber</span>
                                        <span class="step-layer badge-layer-@step.Layer.ToJsonString()">@FormatLabel(step.Layer.ToJsonString())</span>
                                        @if (step.Result is not null)
                                        {
                                            <span class="badge-step-result badge-sr-@step.Result.Value.ToJsonString()">@FormatLabel(step.Result.Value.ToJsonString())</span>
                                        }
                                        @if (step.ExitCode is not null && step.ExitCode != 0)
                                        {
                                            <span class="badge-exit-code">exit @step.ExitCode</span>
                                        }
                                    </div>
                                    <p class="step-description">@step.Description</p>
                                    @if (!string.IsNullOrEmpty(step.Command))
                                    {
                                        <pre class="step-command"><code>@step.Command</code></pre>
                                    }
                                    @if (!string.IsNullOrEmpty(step.Output))
                                    {
                                        <details class="step-output-details">
                                            <summary>Output</summary>
                                            <pre class="step-output"><code>@step.Output</code></pre>
                                        </details>
                                    }
                                    @if (step.FilesCreated is { Count: > 0 })
                                    {
                                        <details class="step-files-details">
                                            <summary>Files Created (@step.FilesCreated.Count)</summary>
                                            @foreach (var file in step.FilesCreated)
                                            {
                                                <div class="step-file">
                                                    <strong>@file.Filename</strong>
                                                    @if (!string.IsNullOrEmpty(file.Description))
                                                    {
                                                        <span class="file-purpose"> ‚Äî @file.Description</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(file.Content))
                                                    {
                                                        <pre class="file-content"><code>@file.Content</code></pre>
                                                    }
                                                </div>
                                            }
                                        </details>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (_repro.Feedback?.TriageCorrections is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Triage Corrections</h3>
                        @foreach (var correction in _repro.Feedback.TriageCorrections)
                        {
                            <div class="correction-item" style="margin-bottom: 0.75rem; padding: 0.5rem; border-left: 3px solid #ffc107; background: rgba(255, 193, 7, 0.05);">
                                <span class="label">@correction.Topic</span>
                                <div style="margin-top: 0.25rem;">
                                    <span style="text-decoration: line-through; opacity: 0.6;">@correction.Upstream</span>
                                    ‚Üí <strong>@correction.Corrected</strong>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (_repro.Inputs?.TriageFile is not null)
                {
                    <div class="field-row" style="margin-top: 0.5rem; opacity: 0.7;">
                        <span class="field-label">Triage input:</span>
                        <code>@_repro.Inputs.TriageFile</code>
                    </div>
                }

                <p class="last-updated">Reproduction analyzed: @_repro.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
            </section>
        </div>
    }

    @* ‚ïê‚ïê‚ïê Tab 3: Actions ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <div class="tab-panel @(_activeTab == "actions" ? "active" : "")">
            @if (_issue.Output.Actions is { Count: > 0 })
            {
                <div class="detail-card card-response">
                    <h3 title="Proposed actions the AI recommends ‚Äî each has a risk level and confidence">Actions</h3>
                    @foreach (var action in _issue.Output.Actions)
                    {
                        <div class="action-item" style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid var(--border-color, #dee2e6); border-radius: 0.5rem;">
                            <div class="response-header">
                                <span class="badge-action badge-act-@action.Type.ToJsonString()" title="@GetActionTypeTooltip(action.Type)">@FormatLabel(action.Type.ToJsonString())</span>
                                @if (action.Risk is not null)
                                {
                                    <span class="badge-risk badge-risk-@action.Risk.Value.ToJsonString()" style="@GetRiskStyle(action.Risk.Value)" title="@GetRiskTooltip(action.Risk.Value)">@FormatLabel(action.Risk.Value.ToJsonString()) risk</span>
                                }
                                @if (action.Confidence is not null)
                                {
                                    <span class="field-confidence" title="How confident the AI is in this action">@action.Confidence.Value.ToString("P0")</span>
                                }
                            </div>
                            <div class="reason-text md-content">@MarkdownHelper.ToHtml(action.Description)</div>

                            @if (action.Labels is { Count: > 0 })
                            {
                                <div style="margin-top: 0.5rem;">
                                    <span class="field-label">Labels:</span>
                                    @foreach (var lbl in action.Labels)
                                    {
                                        <span class="label" style="margin-right: 0.25rem;">@lbl</span>
                                    }
                                </div>
                            }
                            @if (action.Comment is not null)
                            {
                                <div class="response-draft" style="margin-top: 0.5rem;">
                                    <div class="draft-header">
                                        <strong>Comment</strong>
                                        <button class="btn-copy" @onclick="() => CopyToClipboard(action.Comment)">üìã Copy</button>
                                    </div>
                                    <div class="draft-content md-content">
                                        @MarkdownHelper.ToHtml(action.Comment)
                                    </div>
                                </div>
                            }
                            @if (action.LinkedIssue is not null)
                            {
                                <p style="margin-top: 0.5rem;">Linked issue: <a href="https://github.com/@_issue.Meta.Repo/issues/@action.LinkedIssue" target="_blank">#@action.LinkedIssue</a></p>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p><em>No actions suggested for this issue.</em></p>
            }

            <!-- Resolution (paired with actions) -->
            @if (_issue.Analysis.Resolution is not null)
            {
                var res = _issue.Analysis.Resolution;
                <div class="detail-card card-resolution">
                    <h3>Resolution</h3>
                    @if (res.Hypothesis is not null)
                    {
                        <div class="resolution-hypothesis">
                            <h4>Hypothesis</h4>
                            <div class="md-content">@MarkdownHelper.ToHtml(res.Hypothesis)</div>
                        </div>
                    }

                    @if (res.Proposals is { Count: > 0 })
                    {
                        <div class="proposals-header">
                            <h4>Proposals</h4>
                            <span class="carousel-hint">‚Üê scroll ‚Üí</span>
                        </div>
                        <div class="proposals-carousel">
                            @{ var sortedProposals = res.Proposals.OrderByDescending(p => p.Title == res.RecommendedProposal).ToList(); }
                            @foreach (var proposal in sortedProposals)
                            {
                                var isRecommended = proposal.Title == res.RecommendedProposal;
                                <div class="proposal-card @(isRecommended ? "proposal-recommended" : "")">
                                    @if (isRecommended)
                                    {
                                        <span class="badge-recommended">‚òÖ Recommended</span>
                                    }
                                    @if (proposal.Title is not null)
                                    {
                                        <h5>@proposal.Title</h5>
                                    }
                                    <div class="md-content">@MarkdownHelper.ToHtml(proposal.Description)</div>
                                    <div class="proposal-meta">
                                        @if (proposal.Effort is not null)
                                        {
                                            <span class="label">Effort: @FormatLabel(proposal.Effort.Value.ToJsonString())</span>
                                        }
                                        @if (proposal.Confidence is not null)
                                        {
                                            <span class="field-confidence">@proposal.Confidence.Value.ToString("P0")</span>
                                        }
                                    </div>
                                    @if (proposal.CodeSnippet is not null)
                                    {
                                        <details class="proposal-code">
                                            <summary>Code Snippet</summary>
                                            <pre class="code-block"><code>@proposal.CodeSnippet</code></pre>
                                        </details>
                                    }
                                    @if (isRecommended && res.RecommendedReason is not null)
                                    {
                                        <div class="recommended-reason">
                                            <strong>Why:</strong> @res.RecommendedReason
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }

    @* ‚ïê‚ïê‚ïê Tab 4: Analysis ‚ïê‚ïê‚ïê *@
    @if (_issue is not null)
    {
        <div class="tab-panel @(_activeTab == "analysis" ? "active" : "")">
            <!-- Analysis -->
            <section class="triage-section analysis-section">
                <h3>üî¨ Analysis</h3>
                <div class="analysis-summary md-content">
                    @MarkdownHelper.ToHtml(_issue.Analysis.Summary)
                </div>

                @if (_issue.Analysis.KeySignals is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-signals">
                        <h4 title="Direct quotes from the issue that drove triage decisions">Key Signals</h4>
                        @foreach (var signal in _issue.Analysis.KeySignals)
                        {
                            <div class="signal-card">
                                <blockquote class="signal-quote">"@signal.Text"</blockquote>
                                <span class="evidence-source">‚Äî @signal.Source</span>
                                <div class="signal-interp md-content">@MarkdownHelper.ToHtml(signal.Interpretation)</div>
                            </div>
                        }
                    </div>
                }

                @if (_issue.Analysis.CodeInvestigation is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-code-investigation">
                        <h4 title="Source code files examined during investigation">Code Investigation</h4>
                        @foreach (var entry in _issue.Analysis.CodeInvestigation)
                        {
                            <div class="code-investigation-card">
                                <div class="code-file-ref">
                                    <a href="@GetFileUrl(entry)" target="_blank" rel="noopener" title="View on GitHub">
                                        <code>@entry.File</code>
                                        @if (!string.IsNullOrEmpty(entry.Lines) && entry.Lines != "N/A")
                                        {
                                            <span class="code-lines">L@(entry.Lines)</span>
                                        }
                                    </a>
                                    <span class="label label-relevance-@entry.Relevance.ToJsonString()">@FormatLabel(entry.Relevance.ToJsonString())</span>
                                </div>
                                <div class="code-relevance md-content">@MarkdownHelper.ToHtml(entry.Finding)</div>
                            </div>
                        }
                    </div>
                }

                @if (_issue.Analysis.Rationale is not null)
                {
                    <div class="sidebar-section sidebar-rationales">
                        <h4 title="Key reasoning behind classification decisions">Rationale</h4>
                        <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Analysis.Rationale)</div>
                    </div>
                }

                @if (_issue.Analysis.ErrorFingerprint is not null)
                {
                    <div class="field-row" style="margin-top: 0.5rem">
                        <span class="field-label">Error Fingerprint:</span>
                        <code>@_issue.Analysis.ErrorFingerprint</code>
                    </div>
                }

                @if (_issue.Analysis.Workarounds is { Count: > 0 })
                {
                    <div class="sidebar-section">
                        <h4>Workarounds</h4>
                        <ul>
                            @foreach (var w in _issue.Analysis.Workarounds)
                            {
                                <li class="md-content">@MarkdownHelper.ToHtml(w)</li>
                            }
                        </ul>
                    </div>
                }

                @if (_issue.Analysis.NextQuestions is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-uncertainties">
                        <h4 title="Open questions for investigation">Next Questions</h4>
                        <ul class="uncertainty-list">
                            @foreach (var q in _issue.Analysis.NextQuestions)
                            {
                                <li>@q</li>
                            }
                        </ul>
                    </div>
                }
            </section>
        </div>
    }

    @* ‚ïê‚ïê‚ïê Tab 5: Fix ‚ïê‚ïê‚ïê *@
    @if (_fix is not null)
    {
        <div class="tab-panel @(_activeTab == "fix" ? "active" : "")">
            <section class="fix-section">
                <!-- Status & Summary -->
                <div class="fix-header">
                    <span class="badge-fix-status badge-fix-@_fix.Status.ToJsonString()">@FormatLabel(_fix.Status.ToJsonString())</span>
                    <p class="fix-summary">@_fix.Summary</p>
                </div>

                <!-- Root Cause -->
                <div class="detail-card">
                    <h3>Root Cause</h3>
                    <div class="field-row">
                        <span class="label">@FormatLabel(_fix.RootCause.Category.ToJsonString())</span>
                        <span class="label">@FormatLabel(_fix.RootCause.Area.ToJsonString())</span>
                    </div>
                    <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(_fix.RootCause.Description)</div>
                    @if (_fix.RootCause.AffectedFiles is { Count: > 0 })
                    {
                        <div class="field-row" style="margin-top: 0.5rem">
                            <span class="field-label">Affected:</span>
                            @foreach (var f in _fix.RootCause.AffectedFiles)
                            {
                                <code style="margin-right: 0.25rem;">@f</code>
                            }
                        </div>
                    }
                </div>

                <!-- Changes -->
                <div class="detail-card">
                    <h3>Changes</h3>
                    <div class="field-row">
                        <span class="badge-risk badge-risk-@_fix.Changes.Risk.ToJsonString()" style="@GetRiskStyle(_fix.Changes.Risk)">@FormatLabel(_fix.Changes.Risk.ToJsonString()) risk</span>
                        @if (_fix.Changes.BreakingChange)
                        {
                            <span class="label" style="background: #dc3545; color: white;">‚ö† Breaking Change</span>
                        }
                    </div>
                    @if (_fix.Changes.Files is { Count: > 0 })
                    {
                        <table class="repro-version-table" style="margin-top: 0.5rem">
                            <thead><tr><th>File</th><th>Change</th><th>Summary</th></tr></thead>
                            <tbody>
                                @foreach (var fc in _fix.Changes.Files)
                                {
                                    <tr>
                                        <td><code>@fc.Path</code></td>
                                        <td><span class="label">@FormatLabel(fc.ChangeType.ToJsonString())</span></td>
                                        <td>@fc.Summary</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <!-- Tests -->
                <div class="detail-card">
                    <h3>Tests</h3>
                    <div class="field-row">
                        <span class="label">Result: @FormatLabel(_fix.Tests.Result.ToJsonString())</span>
                        <span class="signal @(_fix.Tests.RegressionTestAdded ? "signal-yes" : "signal-no")">
                            @(_fix.Tests.RegressionTestAdded ? "‚úì Regression test added" : "‚úó No regression test")
                        </span>
                    </div>
                    @if (_fix.Tests.TestsAdded is { Count: > 0 })
                    {
                        <ul style="margin-top: 0.5rem">
                            @foreach (var t in _fix.Tests.TestsAdded)
                            {
                                <li><code>@t.File</code> ‚Äî @t.Name</li>
                            }
                        </ul>
                    }
                    @if (_fix.Tests.Command is not null)
                    {
                        <pre class="file-content" style="margin-top: 0.5rem"><code>@_fix.Tests.Command</code></pre>
                    }
                </div>

                <!-- Verification -->
                <div class="detail-card">
                    <h3>Verification</h3>
                    <div class="field-row">
                        <span class="label">Repro scenario: @FormatLabel(_fix.Verification.ReproScenario.ToJsonString())</span>
                    </div>
                    @if (_fix.Verification.Notes is not null)
                    {
                        <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(_fix.Verification.Notes)</div>
                    }
                </div>

                <!-- PR -->
                @if (_fix.Pr is not null)
                {
                    <div class="detail-card">
                        <h3>Pull Request</h3>
                        <div class="field-row">
                            <a href="@_fix.Pr.Url" target="_blank">
                                @if (_fix.Pr.Number is not null) { <span>PR #@_fix.Pr.Number</span> } else { <span>@_fix.Pr.Url</span> }
                            </a>
                            <span class="label">@FormatLabel(_fix.Pr.Status.ToJsonString())</span>
                        </div>
                    </div>
                }

                <!-- Feedback Corrections -->
                @if (_fix.Feedback?.Corrections is { Count: > 0 })
                {
                    <div class="detail-card">
                        <h3>Upstream Corrections</h3>
                        @foreach (var c in _fix.Feedback.Corrections)
                        {
                            <div class="correction-item" style="margin-bottom: 0.75rem; padding: 0.5rem; border-left: 3px solid #ffc107; background: rgba(255, 193, 7, 0.05);">
                                <span class="label">@FormatLabel(c.Source.ToJsonString())</span>
                                <span class="label">@c.Topic</span>
                                <div style="margin-top: 0.25rem;">
                                    <span style="text-decoration: line-through; opacity: 0.6;">@c.Upstream</span>
                                    ‚Üí <strong>@c.Corrected</strong>
                                </div>
                            </div>
                        }
                    </div>
                }

                <!-- Related Issues -->
                @if (_fix.RelatedIssues is { Count: > 0 })
                {
                    <div class="field-row" style="margin-top: 0.5rem">
                        <span class="field-label">Related issues:</span>
                        @foreach (var num in _fix.RelatedIssues)
                        {
                            <a href="triage/@num" class="related-issue-link">#@num</a>
                        }
                    </div>
                }

                @if (_fix.Inputs is not null && (_fix.Inputs.TriageFile is not null || _fix.Inputs.ReproFile is not null))
                {
                    <div class="field-row" style="margin-top: 0.5rem; opacity: 0.7;">
                        @if (_fix.Inputs.TriageFile is not null)
                        {
                            <span class="field-label">Triage:</span> <code>@_fix.Inputs.TriageFile</code>
                        }
                        @if (_fix.Inputs.ReproFile is not null)
                        {
                            <span class="field-label" style="margin-left: 0.5rem;">Repro:</span> <code>@_fix.Inputs.ReproFile</code>
                        }
                    </div>
                }

                <p class="last-updated">Fix analyzed: @_fix.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
            </section>
        </div>
    }

    <!-- Bottom Navigation -->
    <TriageDetailNav BackUrl="@BackUrl" PrevNumber="@_prevNumber" NextNumber="@_nextNumber" 
                     CurrentIndex="@_currentIndex" TotalCount="@_totalCount" DetailUrl="@DetailUrl" IsBottom="true" />
}

@code {
    [Parameter] public int Number { get; set; }

    [SupplyParameterFromQuery] public string? Action { get; set; }
    [SupplyParameterFromQuery] public string? Type { get; set; }
    [SupplyParameterFromQuery] public string? Area { get; set; }
    [SupplyParameterFromQuery] public string? Severity { get; set; }
    [SupplyParameterFromQuery] public string? Repro { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }
    [SupplyParameterFromQuery] public string? Card { get; set; }

    private TriageIndex? _index;
    private TriagedIssue? _issue;
    private ReproResult? _repro;
    private FixResult? _fix;
    private string? _issueTitle;
    private int? _prevNumber;
    private int? _nextNumber;
    private int _currentIndex;
    private int _totalCount;
    private bool _loading = true;
    private string _activeTab = "triage";

    protected override async Task OnInitializedAsync()
    {
        var indexTask = DataService.GetTriageIndexAsync();
        var triageTask = DataService.GetTriageDetailAsync(Number);
        var reproTask = DataService.GetReproDetailAsync(Number);
        var fixTask = DataService.GetFixDetailAsync(Number);

        await Task.WhenAll(indexTask, triageTask, reproTask, fixTask);

        _index = indexTask.Result;
        _issue = triageTask.Result;
        _repro = reproTask.Result;
        _fix = fixTask.Result;
        _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
        _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
        LoadNavigation();
        _loading = false;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_loading)
        {
            _issue = await DataService.GetTriageDetailAsync(Number);
            _repro = await DataService.GetReproDetailAsync(Number);
            _fix = await DataService.GetFixDetailAsync(Number);
            _issueTitle = _index?.Issues.FirstOrDefault(i => i.Number == Number)?.IssueTitle;
            _activeTab = _issue is not null ? "triage" : _repro is not null ? "repro" : "fix";
            LoadNavigation();
        }
    }

    private void LoadNavigation()
    {
        if (_index is null) return;

        var filtered = ApplyFilters(_index.Issues);
        _totalCount = filtered.Count;
        _currentIndex = filtered.FindIndex(i => i.Number == Number);

        if (_currentIndex >= 0)
        {
            _prevNumber = _currentIndex > 0 ? filtered[_currentIndex - 1].Number : null;
            _nextNumber = _currentIndex < filtered.Count - 1 ? filtered[_currentIndex + 1].Number : null;
        }
        else
        {
            _prevNumber = null;
            _nextNumber = null;
            _totalCount = _index.Issues.Count;
            _currentIndex = _index.Issues.FindIndex(i => i.Number == Number);
        }
    }

    private List<TriageIndexEntry> ApplyFilters(List<TriageIndexEntry> issues)
    {
        var query = issues.AsEnumerable();

        if (!string.IsNullOrEmpty(Card))
        {
            query = Card switch
            {
                "needs-investigation" => query.Where(i => i.Action == "needs-investigation"),
                "closeable" => query.Where(i => i.Closeable),
                "quick-wins" => query.Where(i => i.Closeable),
                "regressions" => query.Where(i => i.IsRegression),
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(Action))
            query = query.Where(i => i.Action == Action);
        if (!string.IsNullOrEmpty(Type))
            query = query.Where(i => i.Type == Type);
        if (!string.IsNullOrEmpty(Area))
            query = query.Where(i => i.Area == Area);
        if (!string.IsNullOrEmpty(Severity))
            query = query.Where(i => i.Severity == Severity);
        if (!string.IsNullOrEmpty(Repro))
        {
            query = Repro switch
            {
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query.Where(i => i.ReproConclusion == Repro)
            };
        }

        var sort = Sort ?? "newest";
        query = sort switch
        {
            "confidence" => query.OrderByDescending(i => i.Confidence ?? 0),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Severity)),
            _ => query.OrderByDescending(i => i.Number)
        };

        return query.ToList();
    }

    private string BackUrl
    {
        get
        {
            var parts = new List<string>();
            if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
            if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
            if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
            if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
            if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
            if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
            if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
            return parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        }
    }

    private string DetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
        if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
        if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
        if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
        if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
        if (!string.IsNullOrEmpty(Repro)) parts.Add($"repro={Repro}");
        if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(string? severity) => TriageFormatHelper.SeverityOrder(severity);

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch { }
    }

    private string GetFileUrl(CodeInvestigationEntry entry) =>
        TriageFormatHelper.GetFileUrl(_issue?.Meta.Repo ?? "mono/SkiaSharp", entry);

    [Inject] private Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; } = default!;
}
