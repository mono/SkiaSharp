@page "/triage"
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>AI Triage - SkiaSharp Dashboard</PageTitle>

<h1>AI Triage</h1>
<p class="subtitle">AI-powered issue classification, resolution proposals, and bug reproduction</p>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_data is null)
{
    <p>No triage data available.</p>
}
else
{
    <!-- Summary Cards -->
    <div class="triage-summary">
        <div class="triage-card triage-warning @(SelectedCard == "needs-investigation" ? "selected" : "")" @onclick='() => FilterByCard("needs-investigation")'>
            <span class="triage-count">@_openIssues.Count(i => i.Action == "needs-investigation")</span>
            <span class="triage-label">Needs Investigation</span>
        </div>
        <div class="triage-card triage-success @(SelectedCard == "closeable" ? "selected" : "")" @onclick='() => FilterByCard("closeable")'>
            <span class="triage-count">@_openIssues.Count(i => i.Closeable)</span>
            <span class="triage-label">Closeable</span>
        </div>
        <div class="triage-card triage-info @(SelectedCard == "quick-wins" ? "selected" : "")" @onclick='() => FilterByCard("quick-wins")'>
            <span class="triage-count">@_openIssues.Count(i => i.Closeable && !i.HumanReview)</span>
            <span class="triage-label">Quick Wins</span>
        </div>
        <div class="triage-card triage-danger @(SelectedCard == "regressions" ? "selected" : "")" @onclick='() => FilterByCard("regressions")'>
            <span class="triage-count">@_openIssues.Count(i => i.IsRegression)</span>
            <span class="triage-label">Regressions</span>
        </div>
        <div class="triage-card triage-author @(SelectedCard == "human-review" ? "selected" : "")" @onclick='() => FilterByCard("human-review")'>
            <span class="triage-count">@_openIssues.Count(i => i.HumanReview)</span>
            <span class="triage-label">Needs Human Review</span>
        </div>
        <div class="triage-card triage-repro @(SelectedCard == "has-repro" ? "selected" : "")" @onclick='() => FilterByCard("has-repro")'>
            <span class="triage-count">@_openIssues.Count(i => i.HasRepro)</span>
            <span class="triage-label">Has Reproduction</span>
        </div>
    </div>

    <!-- Filter Row -->
    <div class="filter-row">
        <div class="filter-group">
            <label>Action</label>
            <select @bind="SelectedAction" @bind:after="ApplyFilters">
                <option value="">All Actions</option>
                @foreach (var a in _data.ByAction)
                {
                    <option value="@a.Label">@FormatLabel(a.Label) (@a.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Type</label>
            <select @bind="SelectedType" @bind:after="ApplyFilters">
                <option value="">All Types</option>
                @foreach (var t in _data.ByType)
                {
                    <option value="@t.Label">@FormatLabel(t.Label) (@t.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Area</label>
            <select @bind="SelectedArea" @bind:after="ApplyFilters">
                <option value="">All Areas</option>
                @foreach (var a in _data.ByArea)
                {
                    <option value="@a.Label">@FormatLabel(a.Label) (@a.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Severity</label>
            <select @bind="SelectedSeverity" @bind:after="ApplyFilters">
                <option value="">All Severities</option>
                @foreach (var s in _data.BySeverity)
                {
                    <option value="@s.Label">@FormatLabel(s.Label) (@s.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Repro</label>
            <select @bind="SelectedRepro" @bind:after="ApplyFilters">
                <option value="">All</option>
                <option value="has-repro">Has Reproduction</option>
                <option value="reproduced">Reproduced</option>
                <option value="not-reproduced">Not Reproduced</option>
                <option value="wrong-output">Wrong Output</option>
                <option value="partial">Partial</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select @bind="SelectedSort" @bind:after="ApplyFilters">
                <option value="newest">Newest First</option>
                <option value="confidence">Highest Confidence</option>
                <option value="severity">By Severity</option>
            </select>
        </div>
        @if (HasFilters)
        {
            <button class="btn-clear" @onclick="ClearFilters">Clear Filters</button>
        }
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <span>Showing <strong>@_filtered.Count</strong> of @_openCount open issues</span>
    </div>

    <!-- Issue List (compact rows, click to navigate) -->
    <div class="ai-triage-list">
        @foreach (var issue in _filtered)
        {
            <a href="@GetDetailUrl(issue.Number)" class="ai-triage-row @GetActionClass(issue.Action)">

                <span class="issue-link">#@issue.Number</span>
                <span class="ai-triage-title">@issue.Title</span>
                @if (issue.Type is not null)
                {
                    <span class="badge-type badge-@StripPrefix(issue.Type)">@FormatLabel(issue.Type)</span>
                }
                @if (issue.Area is not null)
                {
                    <span class="label label-sm">@FormatLabel(issue.Area)</span>
                }
                @if (issue.Severity is not null)
                {
                    <span class="badge-severity badge-sev-@issue.Severity">@FormatLabel(issue.Severity)</span>
                }
                @if (issue.Action is not null)
                {
                    <span class="badge-action badge-act-@issue.Action">@FormatLabel(issue.Action)</span>
                }
                @if (issue.Confidence is not null)
                {
                    <span class="confidence-pill" title="Confidence: @issue.Confidence.Value.ToString("P0")">
                        <span class="confidence-bar @GetConfidenceClass(issue.Confidence.Value)" style="width: @((int)(issue.Confidence.Value * 100))%"></span>
                    </span>
                }
                @if (issue.HumanReview)
                {
                    <span class="badge-human-review-sm" title="Needs human review">âš </span>
                }
                @if (issue.IsRegression)
                {
                    <span class="badge-regression-sm" title="Regression">âš¡</span>
                }
                @if (issue.HasRepro)
                {
                    <span class="badge-repro badge-repro-@(issue.ReproConclusion ?? "unknown")" title="Reproduction: @FormatLabel(issue.ReproConclusion ?? "unknown")">ðŸ§ª</span>
                }
            </a>
        }
    </div>

    <p class="last-updated">Last updated: @_data.GeneratedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
}

@code {
    [SupplyParameterFromQuery(Name = "card")] public string? QCard { get; set; }
    [SupplyParameterFromQuery(Name = "action")] public string? QAction { get; set; }
    [SupplyParameterFromQuery(Name = "type")] public string? QType { get; set; }
    [SupplyParameterFromQuery(Name = "area")] public string? QArea { get; set; }
    [SupplyParameterFromQuery(Name = "severity")] public string? QSeverity { get; set; }
    [SupplyParameterFromQuery(Name = "repro")] public string? QRepro { get; set; }
    [SupplyParameterFromQuery(Name = "sort")] public string? QSort { get; set; }

    private TriageIndex? _data;
    private List<TriageIndexEntry> _filtered = [];
    private List<TriageIndexEntry> _openIssues = [];
    private bool _loading = true;
    private int _openCount;

    private string SelectedCard { get; set; } = "";
    private string SelectedAction { get; set; } = "";
    private string SelectedType { get; set; } = "";
    private string SelectedArea { get; set; } = "";
    private string SelectedSeverity { get; set; } = "";
    private string SelectedRepro { get; set; } = "";
    private string SelectedSort { get; set; } = "newest";

    private bool HasFilters =>
        !string.IsNullOrEmpty(SelectedCard) ||
        !string.IsNullOrEmpty(SelectedAction) ||
        !string.IsNullOrEmpty(SelectedType) ||
        !string.IsNullOrEmpty(SelectedArea) ||
        !string.IsNullOrEmpty(SelectedSeverity) ||
        !string.IsNullOrEmpty(SelectedRepro);

    protected override async Task OnInitializedAsync()
    {
        SelectedCard = QCard ?? "";
        SelectedAction = QAction ?? "";
        SelectedType = QType ?? "";
        SelectedArea = QArea ?? "";
        SelectedSeverity = QSeverity ?? "";
        SelectedRepro = QRepro ?? "";
        SelectedSort = QSort ?? "newest";

        _data = await DataService.GetTriageIndexAsync();
        _openIssues = _data?.Issues.Where(i => i.State is "open").ToList() ?? [];
        _openCount = _openIssues.Count;
        ApplyFiltersInternal();
        _loading = false;
    }

    private void FilterByCard(string card)
    {
        SelectedCard = SelectedCard == card ? "" : card;
        SelectedAction = "";
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private void ApplyFilters()
    {
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private void ApplyFiltersInternal()
    {
        if (_data is null) return;

        var query = _openIssues.AsEnumerable();

        if (!string.IsNullOrEmpty(SelectedCard))
        {
            query = SelectedCard switch
            {
                "needs-investigation" => query.Where(i => i.Action == "needs-investigation"),
                "closeable" => query.Where(i => i.Closeable),
                "quick-wins" => query.Where(i => i.Closeable && !i.HumanReview),
                "regressions" => query.Where(i => i.IsRegression),
                "human-review" => query.Where(i => i.HumanReview),
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(SelectedAction))
            query = query.Where(i => i.Action == SelectedAction);
        if (!string.IsNullOrEmpty(SelectedType))
            query = query.Where(i => i.Type == SelectedType);
        if (!string.IsNullOrEmpty(SelectedArea))
            query = query.Where(i => i.Area == SelectedArea);
        if (!string.IsNullOrEmpty(SelectedSeverity))
            query = query.Where(i => i.Severity == SelectedSeverity);
        if (!string.IsNullOrEmpty(SelectedRepro))
        {
            query = SelectedRepro switch
            {
                "has-repro" => query.Where(i => i.HasRepro),
                _ => query.Where(i => i.ReproConclusion == SelectedRepro)
            };
        }

        query = SelectedSort switch
        {
            "confidence" => query.OrderByDescending(i => i.Confidence ?? 0),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Severity)),
            _ => query.OrderByDescending(i => i.Number)
        };

        _filtered = query.ToList();
    }

    private void UpdateUrl()
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(SelectedCard)) parts.Add($"card={SelectedCard}");
        if (!string.IsNullOrEmpty(SelectedAction)) parts.Add($"action={SelectedAction}");
        if (!string.IsNullOrEmpty(SelectedType)) parts.Add($"type={SelectedType}");
        if (!string.IsNullOrEmpty(SelectedArea)) parts.Add($"area={SelectedArea}");
        if (!string.IsNullOrEmpty(SelectedSeverity)) parts.Add($"severity={SelectedSeverity}");
        if (!string.IsNullOrEmpty(SelectedRepro)) parts.Add($"repro={SelectedRepro}");
        if (!string.IsNullOrEmpty(SelectedSort) && SelectedSort != "newest") parts.Add($"sort={SelectedSort}");
        var url = parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        Navigation.NavigateTo(url, replace: true);
    }

    private string GetDetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(SelectedCard)) parts.Add($"card={SelectedCard}");
        if (!string.IsNullOrEmpty(SelectedAction)) parts.Add($"action={SelectedAction}");
        if (!string.IsNullOrEmpty(SelectedType)) parts.Add($"type={SelectedType}");
        if (!string.IsNullOrEmpty(SelectedArea)) parts.Add($"area={SelectedArea}");
        if (!string.IsNullOrEmpty(SelectedSeverity)) parts.Add($"severity={SelectedSeverity}");
        if (!string.IsNullOrEmpty(SelectedRepro)) parts.Add($"repro={SelectedRepro}");
        if (!string.IsNullOrEmpty(SelectedSort) && SelectedSort != "newest") parts.Add($"sort={SelectedSort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(string? severity) => severity switch
    {
        "critical" => 4, "high" => 3, "medium" => 2, "low" => 1, _ => 0
    };

    private void ClearFilters()
    {
        SelectedCard = "";
        SelectedAction = "";
        SelectedType = "";
        SelectedArea = "";
        SelectedSeverity = "";
        SelectedRepro = "";
        SelectedSort = "newest";
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private static string FormatLabel(string value)
    {
        var stripped = StripPrefix(value);
        return string.Join(' ', stripped.Split('-').Select(w =>
            w.Length > 0 ? char.ToUpper(w[0]) + w[1..] : w));
    }

    private static string StripPrefix(string value) =>
        value.Contains('/') ? value[(value.IndexOf('/') + 1)..] : value;

    private static string GetActionClass(string? action) => action switch
    {
        "needs-investigation" => "action-investigate",
        "close-as-fixed" or "close-with-docs" or "close-as-duplicate" => "action-close",
        "convert-to-discussion" => "action-discuss",
        "request-info" => "action-info",
        "keep-open" => "action-keep",
        _ => ""
    };

    private static string GetConfidenceClass(double c) => c switch
    {
        >= 0.85 => "confidence-high",
        >= 0.70 => "confidence-medium",
        _ => "confidence-low"
    };
}
