@page "/triage"
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>AI Triage - SkiaSharp Dashboard</PageTitle>

<h1>AI Triage</h1>
<p class="subtitle">AI-powered issue classification and resolution proposals</p>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_data is null)
{
    <p>No triage data available.</p>
}
else
{
    <!-- Summary Cards -->
    <div class="triage-summary">
        <div class="triage-card triage-warning @(SelectedCard == "needs-investigation" ? "selected" : "")" @onclick='() => FilterByCard("needs-investigation")'>
            <span class="triage-count">@_openIssues.Count(i => i.Output.Actionability.SuggestedAction == SuggestedAction.NeedsInvestigation)</span>
            <span class="triage-label">Needs Investigation</span>
        </div>
        <div class="triage-card triage-success @(SelectedCard == "closeable" ? "selected" : "")" @onclick='() => FilterByCard("closeable")'>
            <span class="triage-count">@_openIssues.Count(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true)</span>
            <span class="triage-label">Closeable</span>
        </div>
        <div class="triage-card triage-info @(SelectedCard == "quick-wins" ? "selected" : "")" @onclick='() => FilterByCard("quick-wins")'>
            <span class="triage-count">@_openIssues.Count(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true && i.Output.Actionability.RequiresHumanReview != true)</span>
            <span class="triage-label">Quick Wins</span>
        </div>
        <div class="triage-card triage-danger @(SelectedCard == "regressions" ? "selected" : "")" @onclick='() => FilterByCard("regressions")'>
            <span class="triage-count">@_openIssues.Count(i => i.Evidence.Regression?.IsRegression == true)</span>
            <span class="triage-label">Regressions</span>
        </div>
        <div class="triage-card triage-author @(SelectedCard == "human-review" ? "selected" : "")" @onclick='() => FilterByCard("human-review")'>
            <span class="triage-count">@_openIssues.Count(i => i.Output.Actionability.RequiresHumanReview == true)</span>
            <span class="triage-label">Needs Human Review</span>
        </div>
    </div>

    <!-- Filter Row -->
    <div class="filter-row">
        <div class="filter-group">
            <label>Action</label>
            <select @bind="SelectedAction" @bind:after="ApplyFilters">
                <option value="">All Actions</option>
                @foreach (var a in _data.ByAction)
                {
                    <option value="@a.Label">@FormatLabel(a.Label) (@a.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Type</label>
            <select @bind="SelectedType" @bind:after="ApplyFilters">
                <option value="">All Types</option>
                @foreach (var t in _data.ByType)
                {
                    <option value="@t.Label">@FormatLabel(t.Label) (@t.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Area</label>
            <select @bind="SelectedArea" @bind:after="ApplyFilters">
                <option value="">All Areas</option>
                @foreach (var a in _data.ByArea)
                {
                    <option value="@a.Label">@FormatLabel(a.Label) (@a.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Severity</label>
            <select @bind="SelectedSeverity" @bind:after="ApplyFilters">
                <option value="">All Severities</option>
                @foreach (var s in _data.BySeverity)
                {
                    <option value="@s.Label">@FormatLabel(s.Label) (@s.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select @bind="SelectedSort" @bind:after="ApplyFilters">
                <option value="newest">Newest First</option>
                <option value="confidence">Highest Confidence</option>
                <option value="severity">By Severity</option>
            </select>
        </div>
        @if (HasFilters)
        {
            <button class="btn-clear" @onclick="ClearFilters">Clear Filters</button>
        }
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <span>Showing <strong>@_filtered.Count</strong> of @_openCount open triaged issues</span>
    </div>

    <!-- Issue List (compact rows, click to navigate) -->
    <div class="ai-triage-list">
        @foreach (var issue in _filtered)
        {
            <a href="@GetDetailUrl(issue.Meta.Number)" class="ai-triage-row @GetActionClass(issue.Output.Actionability.SuggestedAction)">

                <span class="issue-link">#@issue.Meta.Number</span>
                <span class="ai-triage-title">@issue.Summary</span>
                <span class="badge-type badge-@StripPrefix(issue.Classification.Type.Value)">@FormatLabel(issue.Classification.Type.Value)</span>
                @if (issue.Classification.Area is not null)
                {
                    <span class="label label-sm">@FormatLabel(issue.Classification.Area.Value)</span>
                }
                @if (issue.Evidence.BugSignals?.Severity is not null)
                {
                    <span class="badge-severity badge-sev-@issue.Evidence.BugSignals.Severity.ToJsonString()">@FormatLabel(issue.Evidence.BugSignals.Severity.ToJsonString())</span>
                }
                <span class="badge-action badge-act-@issue.Output.Actionability.SuggestedAction.ToJsonString()">@FormatLabel(issue.Output.Actionability.SuggestedAction.ToJsonString())</span>
                <span class="confidence-pill" title="Confidence: @issue.Output.Actionability.Confidence.ToString("P0")">
                    <span class="confidence-bar @GetConfidenceClass(issue.Output.Actionability.Confidence)" style="width: @((int)(issue.Output.Actionability.Confidence * 100))%"></span>
                </span>
                @if (issue.Output.Actionability.RequiresHumanReview == true)
                {
                    <span class="badge-human-review-sm" title="Needs human review">⚠</span>
                }
                @if (issue.Evidence.Regression?.IsRegression == true)
                {
                    <span class="badge-regression-sm" title="Regression">⚡</span>
                }
            </a>
        }
    </div>

    <p class="last-updated">Last updated: @_data.GeneratedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
}

@code {
    [SupplyParameterFromQuery(Name = "card")] public string? QCard { get; set; }
    [SupplyParameterFromQuery(Name = "action")] public string? QAction { get; set; }
    [SupplyParameterFromQuery(Name = "type")] public string? QType { get; set; }
    [SupplyParameterFromQuery(Name = "area")] public string? QArea { get; set; }
    [SupplyParameterFromQuery(Name = "severity")] public string? QSeverity { get; set; }
    [SupplyParameterFromQuery(Name = "sort")] public string? QSort { get; set; }

    private TriageData? _data;
    private List<TriagedIssue> _filtered = [];
    private List<TriagedIssue> _openIssues = [];
    private bool _loading = true;
    private int _openCount;

    private string SelectedCard { get; set; } = "";
    private string SelectedAction { get; set; } = "";
    private string SelectedType { get; set; } = "";
    private string SelectedArea { get; set; } = "";
    private string SelectedSeverity { get; set; } = "";
    private string SelectedSort { get; set; } = "newest";

    private bool HasFilters =>
        !string.IsNullOrEmpty(SelectedCard) ||
        !string.IsNullOrEmpty(SelectedAction) ||
        !string.IsNullOrEmpty(SelectedType) ||
        !string.IsNullOrEmpty(SelectedArea) ||
        !string.IsNullOrEmpty(SelectedSeverity);

    protected override async Task OnInitializedAsync()
    {
        // Restore filters from URL
        SelectedCard = QCard ?? "";
        SelectedAction = QAction ?? "";
        SelectedType = QType ?? "";
        SelectedArea = QArea ?? "";
        SelectedSeverity = QSeverity ?? "";
        SelectedSort = QSort ?? "newest";

        _data = await DataService.GetTriageDataAsync();
        _openIssues = _data?.Issues.Where(i => i.Meta.State is null or "open").ToList() ?? [];
        _openCount = _openIssues.Count;
        ApplyFiltersInternal();
        _loading = false;
    }

    private void FilterByCard(string card)
    {
        SelectedCard = SelectedCard == card ? "" : card;
        SelectedAction = "";
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private void ApplyFilters()
    {
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private void ApplyFiltersInternal()
    {
        if (_data is null) return;

        var query = _openIssues.AsEnumerable();

        if (!string.IsNullOrEmpty(SelectedCard))
        {
            query = SelectedCard switch
            {
                "needs-investigation" => query.Where(i => i.Output.Actionability.SuggestedAction == SuggestedAction.NeedsInvestigation),
                "closeable" => query.Where(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true),
                "quick-wins" => query.Where(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true && i.Output.Actionability.RequiresHumanReview != true),
                "regressions" => query.Where(i => i.Evidence.Regression?.IsRegression == true),
                "human-review" => query.Where(i => i.Output.Actionability.RequiresHumanReview == true),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(SelectedAction))
            query = query.Where(i => i.Output.Actionability.SuggestedAction.ToJsonString() == SelectedAction);
        if (!string.IsNullOrEmpty(SelectedType))
            query = query.Where(i => i.Classification.Type.Value == SelectedType);
        if (!string.IsNullOrEmpty(SelectedArea))
            query = query.Where(i => i.Classification.Area.Value == SelectedArea);
        if (!string.IsNullOrEmpty(SelectedSeverity))
            query = query.Where(i => i.Evidence.BugSignals?.Severity.ToJsonString() == SelectedSeverity);

        query = SelectedSort switch
        {
            "confidence" => query.OrderByDescending(i => i.Output.Actionability.Confidence),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Evidence.BugSignals?.Severity)),
            _ => query.OrderByDescending(i => i.Meta.Number)
        };

        _filtered = query.ToList();
    }

    private void UpdateUrl()
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(SelectedCard)) parts.Add($"card={SelectedCard}");
        if (!string.IsNullOrEmpty(SelectedAction)) parts.Add($"action={SelectedAction}");
        if (!string.IsNullOrEmpty(SelectedType)) parts.Add($"type={SelectedType}");
        if (!string.IsNullOrEmpty(SelectedArea)) parts.Add($"area={SelectedArea}");
        if (!string.IsNullOrEmpty(SelectedSeverity)) parts.Add($"severity={SelectedSeverity}");
        if (!string.IsNullOrEmpty(SelectedSort) && SelectedSort != "newest") parts.Add($"sort={SelectedSort}");
        var url = parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        Navigation.NavigateTo(url, replace: true);
    }

    private string GetDetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(SelectedCard)) parts.Add($"card={SelectedCard}");
        if (!string.IsNullOrEmpty(SelectedAction)) parts.Add($"action={SelectedAction}");
        if (!string.IsNullOrEmpty(SelectedType)) parts.Add($"type={SelectedType}");
        if (!string.IsNullOrEmpty(SelectedArea)) parts.Add($"area={SelectedArea}");
        if (!string.IsNullOrEmpty(SelectedSeverity)) parts.Add($"severity={SelectedSeverity}");
        if (!string.IsNullOrEmpty(SelectedSort) && SelectedSort != "newest") parts.Add($"sort={SelectedSort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(BugSeverity? severity) => severity switch
    {
        BugSeverity.Critical => 4, BugSeverity.High => 3, BugSeverity.Medium => 2, BugSeverity.Low => 1, _ => 0
    };

    private void ClearFilters()
    {
        SelectedCard = "";
        SelectedAction = "";
        SelectedType = "";
        SelectedArea = "";
        SelectedSeverity = "";
        SelectedSort = "newest";
        ApplyFiltersInternal();
        UpdateUrl();
    }

    private static string FormatLabel(string value)
    {
        var stripped = StripPrefix(value);
        return string.Join(' ', stripped.Split('-').Select(w =>
            w.Length > 0 ? char.ToUpper(w[0]) + w[1..] : w));
    }

    private static string StripPrefix(string value) =>
        value.Contains('/') ? value[(value.IndexOf('/') + 1)..] : value;

    private static string GetActionClass(SuggestedAction action) => action switch
    {
        SuggestedAction.NeedsInvestigation => "action-investigate",
        SuggestedAction.CloseAsFixed or SuggestedAction.CloseWithDocs or SuggestedAction.CloseAsDuplicate => "action-close",
        SuggestedAction.ConvertToDiscussion => "action-discuss",
        SuggestedAction.RequestInfo => "action-info",
        SuggestedAction.KeepOpen => "action-keep",
        _ => ""
    };

    private static string GetConfidenceClass(double c) => c switch
    {
        >= 0.85 => "confidence-high",
        >= 0.70 => "confidence-medium",
        _ => "confidence-low"
    };
}
