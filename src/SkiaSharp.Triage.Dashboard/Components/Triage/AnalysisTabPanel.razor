@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper

        <div class="tab-panel @(ActiveTab == "analysis" ? "active" : "")">
            <!-- Analysis -->
            <section class="triage-section analysis-section">
                <h3>ðŸ”¬ Analysis</h3>
                <div class="analysis-summary md-content">
                    @MarkdownHelper.ToHtml(Issue.Analysis.Summary)
                </div>

                @if (Issue.Analysis.KeySignals is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-signals">
                        <h4 title="Direct quotes from the issue that drove triage decisions">Key Signals</h4>
                        @foreach (var signal in Issue.Analysis.KeySignals)
                        {
                            <div class="signal-card">
                                <blockquote class="signal-quote">"@signal.Text"</blockquote>
                                <span class="evidence-source">â€” @signal.Source</span>
                                <div class="signal-interp md-content">@MarkdownHelper.ToHtml(signal.Interpretation)</div>
                            </div>
                        }
                    </div>
                }

                @if (Issue.Analysis.CodeInvestigation is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-code-investigation">
                        <h4 title="Source code files examined during investigation">Code Investigation</h4>
                        @foreach (var entry in Issue.Analysis.CodeInvestigation)
                        {
                            <div class="code-investigation-card">
                                <div class="code-file-ref">
                                    <a href="@GetFileUrl(entry)" target="_blank" rel="noopener" title="View on GitHub">
                                        <code>@entry.File</code>
                                        @if (!string.IsNullOrEmpty(entry.Lines) && entry.Lines != "N/A")
                                        {
                                            <span class="code-lines">L@(entry.Lines)</span>
                                        }
                                    </a>
                                    <span class="label label-relevance-@entry.Relevance.ToJsonString()">@FormatLabel(entry.Relevance.ToJsonString())</span>
                                </div>
                                <div class="code-relevance md-content">@MarkdownHelper.ToHtml(entry.Finding)</div>
                            </div>
                        }
                    </div>
                }

                @if (Issue.Analysis.Rationale is not null)
                {
                    <div class="sidebar-section sidebar-rationales">
                        <h4 title="Key reasoning behind classification decisions">Rationale</h4>
                        <div class="reason-text md-content">@MarkdownHelper.ToHtml(Issue.Analysis.Rationale)</div>
                    </div>
                }

                @if (Issue.Analysis.ErrorFingerprint is not null)
                {
                    <div class="field-row" style="margin-top: 0.5rem">
                        <span class="field-label">Error Fingerprint:</span>
                        <code>@Issue.Analysis.ErrorFingerprint</code>
                    </div>
                }

                @if (Issue.Analysis.Workarounds is { Count: > 0 })
                {
                    <div class="sidebar-section">
                        <h4>Workarounds</h4>
                        <ul>
                            @foreach (var w in Issue.Analysis.Workarounds)
                            {
                                <li class="md-content">@MarkdownHelper.ToHtml(w)</li>
                            }
                        </ul>
                    </div>
                }

                @if (Issue.Analysis.NextQuestions is { Count: > 0 })
                {
                    <div class="sidebar-section sidebar-uncertainties">
                        <h4 title="Open questions for investigation">Next Questions</h4>
                        <ul class="uncertainty-list">
                            @foreach (var q in Issue.Analysis.NextQuestions)
                            {
                                <li>@q</li>
                            }
                        </ul>
                    </div>
                }
            </section>

            @* â”€â”€ Fix Section (merged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ *@
            @if (Fix is not null)
            {
                <section class="triage-section fix-section">
                    <h3>ðŸ”§ Fix</h3>
                    <div class="fix-header">
                        <span class="badge-fix-status badge-fix-@Fix.Status.ToJsonString()">@FormatLabel(Fix.Status.ToJsonString())</span>
                        <p class="fix-summary">@Fix.Summary</p>
                    </div>

                    <div class="detail-card">
                        <h4>Root Cause</h4>
                        <div class="field-row">
                            <span class="label">@FormatLabel(Fix.RootCause.Category.ToJsonString())</span>
                            <span class="label">@FormatLabel(Fix.RootCause.Area.ToJsonString())</span>
                        </div>
                        <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(Fix.RootCause.Description)</div>
                        @if (Fix.RootCause.AffectedFiles is { Count: > 0 })
                        {
                            <div class="field-row" style="margin-top: 0.5rem">
                                <span class="field-label">Affected:</span>
                                @foreach (var f in Fix.RootCause.AffectedFiles)
                                {
                                    <code style="margin-right: 0.25rem;">@f</code>
                                }
                            </div>
                        }
                    </div>

                    <div class="detail-card">
                        <h4>Changes</h4>
                        <div class="field-row">
                            <span class="badge-risk badge-risk-@Fix.Changes.Risk.ToJsonString()" style="@GetRiskStyle(Fix.Changes.Risk)">@FormatLabel(Fix.Changes.Risk.ToJsonString()) risk</span>
                            @if (Fix.Changes.BreakingChange)
                            {
                                <span class="label" style="background: #dc3545; color: white;">âš  Breaking Change</span>
                            }
                        </div>
                        @if (Fix.Changes.Files is { Count: > 0 })
                        {
                            <table class="repro-version-table" style="margin-top: 0.5rem">
                                <thead><tr><th>File</th><th>Change</th><th>Summary</th></tr></thead>
                                <tbody>
                                    @foreach (var fc in Fix.Changes.Files)
                                    {
                                        <tr>
                                            <td><code>@fc.Path</code></td>
                                            <td><span class="label">@FormatLabel(fc.ChangeType.ToJsonString())</span></td>
                                            <td>@fc.Summary</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>

                    <div class="detail-card">
                        <h4>Tests</h4>
                        <div class="field-row">
                            <span class="label">Result: @FormatLabel(Fix.Tests.Result.ToJsonString())</span>
                            <span class="signal @(Fix.Tests.RegressionTestAdded ? "signal-yes" : "signal-no")">
                                @(Fix.Tests.RegressionTestAdded ? "âœ“ Regression test added" : "âœ— No regression test")
                            </span>
                        </div>
                        @if (Fix.Tests.TestsAdded is { Count: > 0 })
                        {
                            <ul style="margin-top: 0.5rem">
                                @foreach (var t in Fix.Tests.TestsAdded)
                                {
                                    <li><code>@t.File</code> â€” @t.Name</li>
                                }
                            </ul>
                        }
                        @if (Fix.Tests.Command is not null)
                        {
                            <pre class="file-content" style="margin-top: 0.5rem"><code>@Fix.Tests.Command</code></pre>
                        }
                    </div>

                    <div class="detail-card">
                        <h4>Verification</h4>
                        <div class="field-row">
                            <span class="label">Repro scenario: @FormatLabel(Fix.Verification.ReproScenario.ToJsonString())</span>
                        </div>
                        @if (Fix.Verification.Notes is not null)
                        {
                            <div class="reason-text md-content" style="margin-top: 0.5rem">@MarkdownHelper.ToHtml(Fix.Verification.Notes)</div>
                        }
                    </div>

                    @if (Fix.Pr is not null)
                    {
                        <div class="detail-card">
                            <h4>Pull Request</h4>
                            <div class="field-row">
                                <a href="@Fix.Pr.Url" target="_blank">
                                    @if (Fix.Pr.Number is not null) { <span>PR #@Fix.Pr.Number</span> } else { <span>@Fix.Pr.Url</span> }
                                </a>
                                <span class="label">@FormatLabel(Fix.Pr.Status.ToJsonString())</span>
                            </div>
                        </div>
                    }

                    @if (Fix.RelatedIssues is { Count: > 0 })
                    {
                        <div class="field-row" style="margin-top: 0.5rem">
                            <span class="field-label">Related issues:</span>
                            @foreach (var num in Fix.RelatedIssues)
                            {
                                <a href="triage/@num" class="related-issue-link">#@num</a>
                            }
                        </div>
                    }

                    <p class="last-updated">Fix analyzed: @Fix.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
                </section>
            }
        </div>

@code {
    [Parameter, EditorRequired] public TriagedIssue Issue { get; set; } = default!;
    [Parameter] public FixResult? Fix { get; set; }
    [Parameter] public string ActiveTab { get; set; } = "analysis";

    private string GetFileUrl(CodeInvestigationEntry entry) =>
        TriageFormatHelper.GetFileUrl(Issue.Meta.Repo, entry);
}
