@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

        <div class="tab-panel @(ActiveTab == "actions" ? "active" : "")">
            @if (Issue.Output.Actions is { Count: > 0 })
            {
                <div class="detail-card card-response">
                    <h3 title="Proposed actions the AI recommends ‚Äî each has a risk level and confidence">Actions</h3>
                    @foreach (var action in Issue.Output.Actions)
                    {
                        <div class="action-item" style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid var(--border-color, #dee2e6); border-radius: 0.5rem;">
                            <div class="response-header">
                                <span class="badge-action badge-act-@action.Type.ToJsonString()" title="@GetActionTypeTooltip(action.Type)">@FormatLabel(action.Type.ToJsonString())</span>
                                @if (action.Risk is not null)
                                {
                                    <span class="badge-risk badge-risk-@action.Risk.Value.ToJsonString()" style="@GetRiskStyle(action.Risk.Value)" title="@GetRiskTooltip(action.Risk.Value)">@FormatLabel(action.Risk.Value.ToJsonString()) risk</span>
                                }
                                @if (action.Confidence is not null)
                                {
                                    <span class="field-confidence" title="How confident the AI is in this action">@action.Confidence.Value.ToString("P0")</span>
                                }
                            </div>
                            <div class="reason-text md-content">@MarkdownHelper.ToHtml(action.Description)</div>

                            @if (action.Labels is { Count: > 0 })
                            {
                                <div style="margin-top: 0.5rem;">
                                    <span class="field-label">Labels:</span>
                                    @foreach (var lbl in action.Labels)
                                    {
                                        <span class="label" style="margin-right: 0.25rem;">@lbl</span>
                                    }
                                </div>
                            }
                            @if (action.Comment is not null)
                            {
                                <div class="response-draft" style="margin-top: 0.5rem;">
                                    <div class="draft-header">
                                        <strong>Comment</strong>
                                        <button class="btn-copy" @onclick="() => CopyToClipboard(action.Comment)">üìã Copy</button>
                                    </div>
                                    <div class="draft-content md-content">
                                        @MarkdownHelper.ToHtml(action.Comment)
                                    </div>
                                </div>
                            }
                            @if (action.LinkedIssue is not null)
                            {
                                <p style="margin-top: 0.5rem;">Linked issue: <a href="https://github.com/@Issue.Meta.Repo/issues/@action.LinkedIssue" target="_blank">#@action.LinkedIssue</a></p>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p><em>No actions suggested for this issue.</em></p>
            }

            <!-- Resolution (paired with actions) -->
            @if (Issue.Analysis.Resolution is not null)
            {
                var res = Issue.Analysis.Resolution;
                <div class="detail-card card-resolution">
                    <h3>Resolution</h3>
                    @if (res.Hypothesis is not null)
                    {
                        <div class="resolution-hypothesis">
                            <h4>Hypothesis</h4>
                            <div class="md-content">@MarkdownHelper.ToHtml(res.Hypothesis)</div>
                        </div>
                    }

                    @if (res.Proposals is { Count: > 0 })
                    {
                        <div class="proposals-header">
                            <h4>Proposals</h4>
                            <span class="carousel-hint">‚Üê scroll ‚Üí</span>
                        </div>
                        <div class="proposals-carousel">
                            @{ var sortedProposals = res.Proposals.OrderByDescending(p => p.Title == res.RecommendedProposal).ToList(); }
                            @foreach (var proposal in sortedProposals)
                            {
                                var isRecommended = proposal.Title == res.RecommendedProposal;
                                <div class="proposal-card @(isRecommended ? "proposal-recommended" : "")">
                                    @if (isRecommended)
                                    {
                                        <span class="badge-recommended">‚òÖ Recommended</span>
                                    }
                                    @if (proposal.Title is not null)
                                    {
                                        <h5>@proposal.Title</h5>
                                    }
                                    <div class="md-content">@MarkdownHelper.ToHtml(proposal.Description)</div>
                                    <div class="proposal-meta">
                                        @if (proposal.Effort is not null)
                                        {
                                            <span class="label">Effort: @FormatLabel(proposal.Effort.Value.ToJsonString())</span>
                                        }
                                        @if (proposal.Confidence is not null)
                                        {
                                            <span class="field-confidence">@proposal.Confidence.Value.ToString("P0")</span>
                                        }
                                    </div>
                                    @if (proposal.CodeSnippet is not null)
                                    {
                                        <details class="proposal-code">
                                            <summary>Code Snippet</summary>
                                            <pre class="code-block"><code>@proposal.CodeSnippet</code></pre>
                                        </details>
                                    }
                                    @if (isRecommended && res.RecommendedReason is not null)
                                    {
                                        <div class="recommended-reason">
                                            <strong>Why:</strong> @res.RecommendedReason
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

@code {
    [Parameter, EditorRequired] public TriagedIssue Issue { get; set; } = default!;
    [Parameter] public string ActiveTab { get; set; } = "actions";

    private async Task CopyToClipboard(string? text)
    {
        if (string.IsNullOrEmpty(text)) return;
        try { await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text); }
        catch { }
    }
}
