@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper

        <div class="tab-panel @(ActiveTab == "repro" ? "active" : "")">
            <section class="repro-section">
                <!-- Missing Info -->
                @if (Repro.Output?.MissingInfo is { Count: > 0 })
                {
                     <div class="detail-card card-missing-info" style="border-left: 4px solid #dc3545; background: rgba(220, 53, 69, 0.05);">
                        <h3 style="color: #dc3545;">Missing Information</h3>
                        <ul>
                            @foreach (var info in Repro.Output.MissingInfo)
                            {
                                <li>@info</li>
                            }
                        </ul>
                    </div>
                }

                <!-- Workarounds -->
                @if (Repro.Output?.Workarounds is { Count: > 0 })
                {
                    <div class="detail-card card-workarounds" style="border-left: 4px solid #198754; background: rgba(25, 135, 84, 0.05);">
                        <h3 style="color: #198754;">Workarounds Available</h3>
                        <ul style="margin-bottom: 0;">
                            @foreach (var workaround in Repro.Output.Workarounds)
                            {
                                <li>@workaround</li>
                            }
                        </ul>
                    </div>
                }

                <!-- Version Results -->
                @if (Repro.VersionResults is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Version Test Results</h3>
                        <table class="repro-version-table">
                            <thead>
                                <tr><th>Version</th><th>Source</th><th>Result</th><th>Notes</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var vr in Repro.VersionResults)
                                {
                                    <tr class="version-result-@vr.Result.ToJsonString()">
                                        <td><code>@vr.Version</code></td>
                                        <td>@FormatLabel(vr.Source.ToJsonString())</td>
                                        <td><span class="badge-version-result badge-vr-@vr.Result.ToJsonString()">@FormatLabel(vr.Result.ToJsonString())</span></td>
                                        <td>@(vr.Notes ?? "—")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                <!-- Environment -->
                <div class="repro-card">
                    <h3>Environment</h3>
                    <div class="repro-env-grid">
                        <div class="env-item"><span class="env-label">OS</span><span class="env-value">@Repro.Environment.Os</span></div>
                        <div class="env-item"><span class="env-label">Arch</span><span class="env-value">@Repro.Environment.Arch</span></div>
                        <div class="env-item"><span class="env-label">.NET</span><span class="env-value">@Repro.Environment.DotnetVersion</span></div>
                        <div class="env-item"><span class="env-label">SkiaSharp</span><span class="env-value">@Repro.Environment.SkiaSharpVersion</span></div>
                        <div class="env-item"><span class="env-label">Docker</span><span class="env-value">@(Repro.Environment.DockerUsed ? "Yes" : "No")</span></div>
                        @if (Repro.Environment.Gpu is not null)
                        {
                            <div class="env-item"><span class="env-label">GPU</span><span class="env-value">@(Repro.Environment.Gpu.Available ? (Repro.Environment.Gpu.Backend ?? "Available") : "Not Available")</span></div>
                        }
                    </div>
                </div>

                <!-- Repro Project -->
                @if (Repro.ReproProject is not null)
                {
                    <div class="repro-card">
                        <h3>Reproduction Project</h3>
                        <div class="repro-env-grid">
                            <div class="env-item"><span class="env-label">Type</span><span class="env-value">@FormatLabel(Repro.ReproProject.Type.ToJsonString())</span></div>
                            <div class="env-item"><span class="env-label">TFM</span><span class="env-value"><code>@Repro.ReproProject.Tfm</code></span></div>
                        </div>
                        @if (Repro.ReproProject.Packages is { Count: > 0 })
                        {
                            <h4>Packages</h4>
                            <ul class="repro-packages">
                                @foreach (var pkg in Repro.ReproProject.Packages)
                                {
                                    <li><code>@pkg.Name</code> <span class="pkg-version">@pkg.Version</span></li>
                                }
                            </ul>
                        }
                    </div>
                }

                <!-- Error Messages -->
                @if (Repro.ErrorMessages is not null)
                {
                    <div class="repro-card repro-errors">
                        <h3>Error Messages</h3>
                        @if (!string.IsNullOrEmpty(Repro.ErrorMessages.PrimaryError))
                        {
                            <div class="error-primary">
                                <strong>Primary Error:</strong>
                                <pre><code>@Repro.ErrorMessages.PrimaryError</code></pre>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Repro.ErrorMessages.StackTrace))
                        {
                            <details>
                                <summary>Stack Trace</summary>
                                <pre class="stack-trace"><code>@Repro.ErrorMessages.StackTrace</code></pre>
                            </details>
                        }
                        @if (Repro.ErrorMessages.AdditionalErrors is { Count: > 0 })
                        {
                            <details>
                                <summary>Additional Errors (@Repro.ErrorMessages.AdditionalErrors.Count)</summary>
                                <ul>
                                    @foreach (var err in Repro.ErrorMessages.AdditionalErrors)
                                    {
                                        <li><code>@err</code></li>
                                    }
                                </ul>
                            </details>
                        }
                    </div>
                }

                <!-- Artifacts -->
                @if (Repro.Artifacts is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Artifacts</h3>
                        <div class="repro-artifacts">
                            @foreach (var artifact in Repro.Artifacts)
                            {
                                <div class="artifact-item">
                                    <span class="artifact-name">@artifact.Filename</span>
                                    <span class="artifact-desc">@artifact.Description</span>
                                    <span class="artifact-source badge-layer-@artifact.Source.ToJsonString()">@FormatLabel(artifact.Source.ToJsonString())</span>
                                    @if (artifact.Available && !string.IsNullOrEmpty(artifact.Url))
                                    {
                                        <a href="@artifact.Url" target="_blank" rel="noopener noreferrer" class="artifact-link">View</a>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Blockers -->
                @if (Repro.Blockers is { Count: > 0 })
                {
                    <div class="repro-card repro-blockers">
                        <h3>Blockers</h3>
                        <ul>
                            @foreach (var b in Repro.Blockers)
                            {
                                <li>@b</li>
                            }
                        </ul>
                    </div>
                }

                <!-- Reproduction Steps (last — these are long) -->
                @if (Repro.ReproductionSteps is { Count: > 0 })
                {
                    <div class="repro-card">
                        <h3>Reproduction Steps</h3>
                        <div class="repro-steps">
                            @foreach (var step in Repro.ReproductionSteps)
                            {
                                <div class="repro-step">
                                    <div class="step-header">
                                        <span class="step-number">@step.StepNumber</span>
                                        <span class="step-layer badge-layer-@step.Layer.ToJsonString()">@FormatLabel(step.Layer.ToJsonString())</span>
                                        @if (step.Result is not null)
                                        {
                                            <span class="badge-step-result badge-sr-@step.Result.Value.ToJsonString()">@FormatLabel(step.Result.Value.ToJsonString())</span>
                                        }
                                        @if (step.ExitCode is not null && step.ExitCode != 0)
                                        {
                                            <span class="badge-exit-code">exit @step.ExitCode</span>
                                        }
                                    </div>
                                    <p class="step-description">@step.Description</p>
                                    @if (!string.IsNullOrEmpty(step.Command))
                                    {
                                        <pre class="step-command"><code>@step.Command</code></pre>
                                    }
                                    @if (!string.IsNullOrEmpty(step.Output))
                                    {
                                        <details class="step-output-details">
                                            <summary>Output</summary>
                                            <pre class="step-output"><code>@step.Output</code></pre>
                                        </details>
                                    }
                                    @if (step.FilesCreated is { Count: > 0 })
                                    {
                                        <details class="step-files-details">
                                            <summary>Files Created (@step.FilesCreated.Count)</summary>
                                            @foreach (var file in step.FilesCreated)
                                            {
                                                <div class="step-file">
                                                    <strong>@file.Filename</strong>
                                                    @if (!string.IsNullOrEmpty(file.Description))
                                                    {
                                                        <span class="file-purpose"> — @file.Description</span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(file.Content))
                                                    {
                                                        <pre class="file-content"><code>@file.Content</code></pre>
                                                    }
                                                </div>
                                            }
                                        </details>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (Repro.Inputs?.TriageFile is not null)
                {
                    <div class="field-row" style="margin-top: 0.5rem; opacity: 0.7;">
                        <span class="field-label">Triage input:</span>
                        <code>@Repro.Inputs.TriageFile</code>
                    </div>
                }

                <p class="last-updated">Reproduction analyzed: @Repro.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
            </section>
        </div>

@code {
    [Parameter, EditorRequired] public ReproResult Repro { get; set; } = default!;
    [Parameter] public string ActiveTab { get; set; } = "repro";
}
