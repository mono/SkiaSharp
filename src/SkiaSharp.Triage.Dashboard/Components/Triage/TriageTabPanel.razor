@using SkiaSharp.Triage.Dashboard.Helpers
@using static SkiaSharp.Triage.Dashboard.Helpers.TriageFormatHelper

        <div class="tab-panel @(ActiveTab == "triage" ? "active" : "")">
            <!-- AI Summary -->
            <div class="detail-card card-summary">
                <h3>Summary</h3>
                <p>@Issue.Summary</p>
            </div>

            <!-- Classification & Action (side by side) -->
            <div class="detail-section-grid">
                <div class="detail-card card-classification">
                    <h3>Classification</h3>
                    <div class="field-row">
                        <span class="field-label">Type:</span>
                        <span class="badge-type badge-@StripPrefix(Issue.Classification.Type.Value)">@FormatLabel(Issue.Classification.Type.Value)</span>
                        <span class="field-confidence">@Issue.Classification.Type.Confidence.ToString("P0")</span>
                    </div>
                    @if (Issue.Classification.Area is not null)
                    {
                        <div class="field-row">
                            <span class="field-label">Area:</span>
                            <span class="label label-area">@FormatLabel(Issue.Classification.Area.Value)</span>
                            <span class="field-confidence">@Issue.Classification.Area.Confidence.ToString("P0")</span>
                        </div>
                    }
                    @if (Issue.Classification.Platforms is { Count: > 0 })
                    {
                        <div class="field-row">
                            <span class="field-label">Platforms:</span>
                            @foreach (var p in Issue.Classification.Platforms)
                            {
                                <span class="label label-os">@FormatLabel(p)</span>
                            }
                        </div>
                    }
                    @if (Issue.Classification.Backends is { Count: > 0 })
                    {
                        <div class="field-row">
                            <span class="field-label">Backends:</span>
                            @foreach (var b in Issue.Classification.Backends)
                            {
                                <span class="label label-backend">@FormatLabel(b)</span>
                            }
                        </div>
                    }
                    @if (Issue.Classification.Tenets is { Count: > 0 })
                    {
                        <div class="field-row">
                            <span class="field-label">Tenets:</span>
                            @foreach (var t in Issue.Classification.Tenets)
                            {
                                <span class="label label-tenet">@FormatLabel(t)</span>
                            }
                        </div>
                    }
                    @if (Issue.Classification.Partner is not null)
                    {
                        <div class="field-row">
                            <span class="field-label">Partner:</span>
                            <span class="label label-partner">@FormatLabel(Issue.Classification.Partner)</span>
                        </div>
                    }
                </div>

                <div class="detail-card card-action">
                    <h3>Suggested Action</h3>
                    <div class="action-detail">
                        <span class="badge-action badge-act-@Issue.Output.Actionability.SuggestedAction.ToJsonString()">
                            @FormatLabel(Issue.Output.Actionability.SuggestedAction.ToJsonString())
                        </span>
                        <span class="field-confidence">@Issue.Output.Actionability.Confidence.ToString("P0")</span>
                    </div>
                    <div class="reason-text md-content">@MarkdownHelper.ToHtml(Issue.Output.Actionability.Reason)</div>
                    @if (Issue.Output.MissingInfo is { Count: > 0 })
                    {
                        <div class="missing-info">
                            <strong>Missing:</strong>
                            @foreach (var mi in Issue.Output.MissingInfo)
                            {
                                <span class="label label-missing">@FormatLabel(mi)</span>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Bug Signals -->
            @if (Issue.Evidence.BugSignals is not null)
            {
                <div class="detail-card card-bug-signals">
                    <h3 title="Bug indicators extracted from the issue">Bug Signals</h3>
                    <div class="bug-signals-grid">
                        @if (Issue.Evidence.BugSignals.Severity is not null)
                        {
                            <span class="badge-severity badge-sev-@Issue.Evidence.BugSignals.Severity.Value.ToJsonString()">
                                @FormatLabel(Issue.Evidence.BugSignals.Severity.Value.ToJsonString())
                            </span>
                        }
                        @if (Issue.Evidence.BugSignals.ReproQuality is not null)
                        {
                            <span class="label" title="How complete the reproduction steps are">Repro: @FormatLabel(Issue.Evidence.BugSignals.ReproQuality.Value.ToJsonString())</span>
                        }
                        @if (Issue.Evidence.BugSignals.IsRegression == true)
                        {
                            <span class="signal signal-yes">ðŸ”„ Regression</span>
                        }
                    </div>
                    @if (Issue.Evidence.BugSignals.ErrorType is not null)
                    {
                        <div class="field-row" style="margin-top: 0.5rem">
                            <span class="field-label">Error:</span>
                            <code>@Issue.Evidence.BugSignals.ErrorType</code>
                        </div>
                    }
                    @if (Issue.Evidence.BugSignals.ErrorMessage is not null)
                    {
                        <div class="reason-text" style="margin-top: 0.25rem">@Issue.Evidence.BugSignals.ErrorMessage</div>
                    }
                    @if (Issue.Evidence.BugSignals.StackTrace is not null)
                    {
                        <details style="margin-top: 0.5rem">
                            <summary>Stack Trace</summary>
                            <pre class="file-content"><code>@Issue.Evidence.BugSignals.StackTrace</code></pre>
                        </details>
                    }
                    @if (Issue.Evidence.BugSignals.TargetFrameworks is { Count: > 0 })
                    {
                        <div class="field-row" style="margin-top: 0.5rem">
                            <span class="field-label">Frameworks:</span>
                            @foreach (var fw in Issue.Evidence.BugSignals.TargetFrameworks)
                            {
                                <span class="label">@fw</span>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Regression & Fix Status -->
            @if (Issue.Evidence.Regression is not null || Issue.Evidence.FixStatus is not null)
            {
                <div class="detail-section-grid">
                    @if (Issue.Evidence.Regression is not null)
                    {
                        <div class="detail-card card-regression">
                            <h3>Regression</h3>
                            @if (Issue.Evidence.Regression.IsRegression)
                            {
                                <span class="badge-regression">
                                    âš¡ Regression
                                </span>
                                <span class="field-confidence">@Issue.Evidence.Regression.Confidence.ToString("P0")</span>
                                @if (Issue.Evidence.Regression.WorkedInVersion is not null)
                                {
                                    <div class="field-row">
                                        <span class="field-label">Worked in:</span>
                                        <strong>@Issue.Evidence.Regression.WorkedInVersion</strong>
                                    </div>
                                }
                                @if (Issue.Evidence.Regression.BrokeInVersion is not null)
                                {
                                    <div class="field-row">
                                        <span class="field-label">Broke in:</span>
                                        <strong>@Issue.Evidence.Regression.BrokeInVersion</strong>
                                    </div>
                                }
                            }
                            else
                            {
                                <span>Not a regression</span>
                            }
                            <div class="reason-text md-content">@MarkdownHelper.ToHtml(Issue.Evidence.Regression.Reason)</div>
                        </div>
                    }
                    @if (Issue.Evidence.FixStatus is not null)
                    {
                        <div class="detail-card card-fix-status">
                            <h3>Fix Status</h3>
                            <span class="@(Issue.Evidence.FixStatus.LikelyFixed ? "badge-fixed" : "badge-unfixed")">
                                @(Issue.Evidence.FixStatus.LikelyFixed ? "âœ“ Likely Fixed" : "âœ— Not Fixed")
                            </span>
                            <span class="field-confidence">@Issue.Evidence.FixStatus.Confidence.ToString("P0")</span>
                            <div class="reason-text md-content">@MarkdownHelper.ToHtml(Issue.Evidence.FixStatus.Reason)</div>
                            @if (Issue.Evidence.FixStatus.FixedInVersion is not null)
                            {
                                <p>Fixed in: <strong>@Issue.Evidence.FixStatus.FixedInVersion</strong></p>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Version Analysis -->
            @if (Issue.Evidence.VersionAnalysis is not null)
            {
                <div class="detail-card card-version">
                    <h3>Version Analysis</h3>
                    @if (Issue.Evidence.VersionAnalysis.MentionedVersions is { Count: > 0 })
                    {
                        <div class="field-row">
                            <span class="field-label">Versions:</span>
                            @foreach (var v in Issue.Evidence.VersionAnalysis.MentionedVersions)
                            {
                                <span class="label">@v</span>
                            }
                        </div>
                    }
                    @if (Issue.Evidence.VersionAnalysis.CurrentRelevance is not null)
                    {
                        <div class="field-row">
                            <span class="field-label">Still relevant:</span>
                            <span class="label label-relevance-@Issue.Evidence.VersionAnalysis.CurrentRelevance.Value.ToJsonString()">@FormatLabel(Issue.Evidence.VersionAnalysis.CurrentRelevance.Value.ToJsonString())</span>
                        </div>
                    }
                    @if (Issue.Evidence.VersionAnalysis.WorkedIn is not null)
                    {
                        <div class="field-row">
                            <span class="field-label">Worked in:</span>
                            <span class="label">@Issue.Evidence.VersionAnalysis.WorkedIn</span>
                        </div>
                    }
                    @if (Issue.Evidence.VersionAnalysis.BrokeIn is not null)
                    {
                        <div class="field-row">
                            <span class="field-label">Broke in:</span>
                            <span class="label">@Issue.Evidence.VersionAnalysis.BrokeIn</span>
                        </div>
                    }
                    @if (Issue.Evidence.VersionAnalysis.RelevanceReason is not null)
                    {
                        <div class="reason-text md-content">@MarkdownHelper.ToHtml(Issue.Evidence.VersionAnalysis.RelevanceReason)</div>
                    }
                </div>
            }

            <!-- Evidence -->
            @if (Issue.Evidence.ReproEvidence is not null)
            {
                var evidence = Issue.Evidence.ReproEvidence;
                <div class="detail-card card-evidence">
                    <h3>Evidence</h3>
                    @if (evidence.StepsToReproduce is { Count: > 0 })
                    {
                        <h4>Steps to Reproduce</h4>
                        <ol class="repro-steps">
                            @foreach (var step in evidence.StepsToReproduce)
                            {
                                <li>@step</li>
                            }
                        </ol>
                    }
                    @if (evidence.CodeSnippets is { Count: > 0 })
                    {
                        <h4>Code Snippets</h4>
                        @foreach (var snippet in evidence.CodeSnippets)
                        {
                            <pre class="code-block"><code>@snippet</code></pre>
                        }
                    }
                    @if (evidence.Screenshots is { Count: > 0 })
                    {
                        <h4>Screenshots (@evidence.Screenshots.Count)</h4>
                        @foreach (var ss in evidence.Screenshots)
                        {
                            <div class="screenshot-item">
                                <a href="@ss.Url" target="_blank" class="screenshot-link">ðŸ“¸ @(ss.Description ?? ss.Url)</a>
                            </div>
                        }
                    }
                    @if (evidence.Attachments is { Count: > 0 })
                    {
                        <h4>Attachments</h4>
                        @foreach (var att in evidence.Attachments)
                        {
                            <div class="attachment-item">
                                <a href="@att.Url" target="_blank">ðŸ“Ž @att.Filename</a>
                                @if (att.Description is not null)
                                {
                                    <span class="evidence-source">@att.Description</span>
                                }
                            </div>
                        }
                    }
                    @if (evidence.RepoLinks is { Count: > 0 })
                    {
                        <h4>Repository Links</h4>
                        @foreach (var link in evidence.RepoLinks)
                        {
                            <div class="repo-link-item">
                                <a href="@link.Url" target="_blank">ðŸ”— @(link.Description ?? link.Url)</a>
                            </div>
                        }
                    }
                    @if (evidence.RelatedIssues is { Count: > 0 })
                    {
                        <h4>Related Issues</h4>
                        <div class="related-issues">
                            @foreach (var num in evidence.RelatedIssues)
                            {
                                <a href="https://github.com/@Issue.Meta.Repo/issues/@num" target="_blank" class="related-issue-link">#@num</a>
                            }
                        </div>
                    }
                    @if (evidence.EnvironmentDetails is not null)
                    {
                        <h4>Environment</h4>
                        <p>@evidence.EnvironmentDetails</p>
                    }
                </div>
            }
        </div>

@code {
    [Parameter, EditorRequired] public TriagedIssue Issue { get; set; } = default!;
    [Parameter] public string ActiveTab { get; set; } = "triage";
}
