@page "/nuget"
@using ApexCharts
@inject DashboardDataService DataService

<PageTitle>NuGet Stats - SkiaSharp Dashboard</PageTitle>

<h1>NuGet Downloads</h1>

@if (_loading)
{
    <p><em>Loading NuGet data...</em></p>
}
else if (_stats is null)
{
    <p>No data available.</p>
}
else
{
    <!-- Total Downloads Hero -->
    <div class="nuget-hero">
        <div class="hero-stat">
            <span class="hero-value">@_stats.TotalDownloads.ToString("N0")</span>
            <span class="hero-label">Total Downloads</span>
        </div>
        <div class="hero-meta">
            <span>@_stats.Packages.Count(p => !p.IsLegacy) supported packages</span>
            <label class="legacy-toggle">
                <input type="checkbox" @bind="_showLegacy" />
                Show @_stats.Packages.Count(p => p.IsLegacy) legacy packages
            </label>
        </div>
    </div>

    <!-- Download Trend Charts -->
    @if (_chartsData?.Charts?.Any() == true)
    {
        <h2>Download Trends</h2>
        <div class="nuget-charts">
            @foreach (var chart in _chartsData.Charts)
            {
                <div class="chart-card">
                    <h4>@chart.Title</h4>
                    @if (chart.Series.Any())
                    {
                        <ApexChart TItem="ChartDataPoint"
                                   Options="GetChartOptions(chart.Title)"
                                   Height="200">
                            @foreach (var series in chart.Series)
                            {
                                <ApexPointSeries TItem="ChartDataPoint"
                                                Items="@series.DataPoints"
                                                Name="@GetShortPackageName(series.PackageId)"
                                                SeriesType="SeriesType.Area"
                                                XValue="@(e => e.Date)"
                                                YValue="@(e => (decimal)e.CumulativeDownloads)"
                                                OrderBy="@(e => e.X)" />
                            }
                        </ApexChart>
                    }
                    else
                    {
                        <p class="no-data">No version history available</p>
                    }
                </div>
            }
        </div>
    }

    <!-- Package Groups -->
    <h2>All Packages</h2>
    <div class="nuget-groups">
        @foreach (var group in GetPackageGroups())
        {
            var groupPackages = GetPackagesForGroup(group.Key);
            var visiblePackages = groupPackages.Where(p => _showLegacy || !p.IsLegacy).ToList();
            
            @if (visiblePackages.Any())
            {
                <div class="nuget-group @(IsGroupExpanded(group.Key) ? "expanded" : "")">
                    <div class="group-header" @onclick="() => ToggleGroup(group.Key)">
                        <span class="group-toggle">@(IsGroupExpanded(group.Key) ? "▼" : "▶")</span>
                        <span class="group-name">@group.Key</span>
                        <span class="group-stats">
                            <span class="group-downloads">@groupPackages.Sum(p => p.TotalDownloads).ToString("N0")</span>
                            <span class="group-count">@visiblePackages.Count packages</span>
                        </span>
                    </div>
                    
                    @if (IsGroupExpanded(group.Key))
                    {
                        <div class="group-content">
                            @if (group.Value.Any())
                            {
                                @* Has subgroups *@
                                @foreach (var subgroup in group.Value)
                                {
                                    var subPackages = GetPackagesForSubGroup(group.Key, subgroup);
                                    var visibleSubPackages = subPackages.Where(p => _showLegacy || !p.IsLegacy).ToList();
                                    
                                    @if (visibleSubPackages.Any())
                                    {
                                        <div class="nuget-subgroup">
                                            <div class="subgroup-header">
                                                <span class="subgroup-name">@subgroup</span>
                                                <span class="subgroup-downloads">@subPackages.Sum(p => p.TotalDownloads).ToString("N0")</span>
                                            </div>
                                            <div class="package-list">
                                                @foreach (var pkg in visibleSubPackages.OrderByDescending(p => p.TotalDownloads))
                                                {
                                                    <div class="package-item @(pkg.IsLegacy ? "legacy" : "")">
                                                        <a href="https://www.nuget.org/packages/@pkg.Id" target="_blank" class="package-name">
                                                            @GetShortName(pkg.Id)
                                                            @if (pkg.IsLegacy) { <span class="legacy-badge">legacy</span> }
                                                        </a>
                                                        <span class="package-downloads">@pkg.TotalDownloads.ToString("N0")</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            }
                            else
                            {
                                @* No subgroups - show packages directly *@
                                <div class="package-list">
                                    @foreach (var pkg in visiblePackages.OrderByDescending(p => p.TotalDownloads))
                                    {
                                        <div class="package-item @(pkg.IsLegacy ? "legacy" : "")">
                                            <a href="https://www.nuget.org/packages/@pkg.Id" target="_blank" class="package-name">
                                                @GetShortName(pkg.Id)
                                                @if (pkg.IsLegacy) { <span class="legacy-badge">legacy</span> }
                                            </a>
                                            <span class="package-downloads">@pkg.TotalDownloads.ToString("N0")</span>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        }
    </div>

    <p class="last-updated">Last updated: @_stats.GeneratedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
}

@code {
    private bool _loading = true;
    private bool _showLegacy = false;
    private NuGetStats? _stats;
    private NuGetChartsData? _chartsData;
    private HashSet<string> _expandedGroups = ["SkiaSharp", "SkiaSharp Views", "SkiaSharp Extensions", "HarfBuzzSharp"];

    protected override async Task OnInitializedAsync()
    {
        try 
        { 
            _stats = await DataService.GetNuGetStatsAsync();
            _chartsData = await DataService.GetNuGetChartsDataAsync();
        }
        catch { /* Data not yet available */ }
        _loading = false;
    }

    private static ApexChartOptions<ChartDataPoint> GetChartOptions(string title) => new()
    {
        Chart = new Chart
        {
            Toolbar = new Toolbar { Show = false },
            Animations = new Animations { Enabled = false },
            Zoom = new Zoom { Enabled = false }
        },
        Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
        Fill = new Fill 
        { 
            Type = FillType.Gradient,
            Gradient = new FillGradient
            {
                ShadeIntensity = 1,
                OpacityFrom = 0.4,
                OpacityTo = 0.1,
                Stops = [0, 90, 100]
            }
        },
        Xaxis = new XAxis
        {
            Type = XAxisType.Datetime,
            Labels = new XAxisLabels { Format = "yyyy" }
        },
        Yaxis =
        [
            new YAxis
            {
                Labels = new YAxisLabels
                {
                    Formatter = "function(val) { return val >= 1000000 ? (val/1000000).toFixed(1) + 'M' : val >= 1000 ? (val/1000).toFixed(0) + 'K' : val; }"
                }
            }
        ],
        Tooltip = new Tooltip
        {
            X = new TooltipX { Format = "MMM yyyy" }
        },
        Legend = new Legend { Show = true, Position = LegendPosition.Bottom }
    };

    private static string GetShortPackageName(string id)
    {
        // For chart legends, show short names
        if (id.Contains(".Direct3D.")) return "Direct3D";
        if (id.Contains(".Vulkan.")) return "Vulkan";
        if (id.Contains(".Maui.")) return id.Replace("SkiaSharp.Views.Maui.", "");
        if (id.StartsWith("SkiaSharp.Views.")) return id.Replace("SkiaSharp.Views.", "");
        if (id.StartsWith("SkiaSharp.")) return id.Replace("SkiaSharp.", "");
        return id;
    }

    private void ToggleGroup(string group)
    {
        if (_expandedGroups.Contains(group))
            _expandedGroups.Remove(group);
        else
            _expandedGroups.Add(group);
    }

    private bool IsGroupExpanded(string group) => _expandedGroups.Contains(group);

    // Package grouping structure based on user's tree
    private static Dictionary<string, List<string>> GetPackageGroups() => new()
    {
        ["SkiaSharp"] = ["Core", "Native Assets"],
        ["SkiaSharp Views"] = ["Native Platform", ".NET MAUI", "Xamarin.Forms", "Uno Platform", "Web"],
        ["SkiaSharp Extensions"] = ["Text", "Animation", "GPU Backends"],
        ["HarfBuzzSharp"] = ["Core", "Native Assets"]
    };

    private List<PackageStats> GetPackagesForGroup(string group)
    {
        if (_stats is null) return [];
        
        return group switch
        {
            "SkiaSharp" => _stats.Packages.Where(p => 
                p.Id == "SkiaSharp" || p.Id.StartsWith("SkiaSharp.NativeAssets.")).ToList(),
            "SkiaSharp Views" => _stats.Packages.Where(p => 
                p.Id.StartsWith("SkiaSharp.Views")).ToList(),
            "SkiaSharp Extensions" => _stats.Packages.Where(p => 
                p.Id is "SkiaSharp.HarfBuzz" or "SkiaSharp.Skottie" or "SkiaSharp.SceneGraph" 
                     or "SkiaSharp.Resources" or "SkiaSharp.Vulkan.SharpVk" or "SkiaSharp.Direct3D.Vortice").ToList(),
            "HarfBuzzSharp" => _stats.Packages.Where(p => 
                p.Id.StartsWith("HarfBuzzSharp")).ToList(),
            _ => []
        };
    }

    private List<PackageStats> GetPackagesForSubGroup(string group, string subgroup)
    {
        if (_stats is null) return [];

        return (group, subgroup) switch
        {
            ("SkiaSharp", "Core") => _stats.Packages.Where(p => 
                p.Id == "SkiaSharp").ToList(),
            ("SkiaSharp", "Native Assets") => _stats.Packages.Where(p => 
                p.Id.StartsWith("SkiaSharp.NativeAssets.")).ToList(),
            ("SkiaSharp Views", "Native Platform") => _stats.Packages.Where(p => 
                p.Id is "SkiaSharp.Views" or "SkiaSharp.Views.Desktop.Common" 
                     or "SkiaSharp.Views.WPF" or "SkiaSharp.Views.WindowsForms"
                     or "SkiaSharp.Views.WinUI" or "SkiaSharp.Views.NativeAssets.UWP"
                     or "SkiaSharp.Views.Gtk2" or "SkiaSharp.Views.Gtk3").ToList(),
            ("SkiaSharp Views", ".NET MAUI") => _stats.Packages.Where(p => 
                p.Id.StartsWith("SkiaSharp.Views.Maui")).ToList(),
            ("SkiaSharp Views", "Xamarin.Forms") => _stats.Packages.Where(p => 
                p.Id.StartsWith("SkiaSharp.Views.Forms")).ToList(),
            ("SkiaSharp Views", "Uno Platform") => _stats.Packages.Where(p => 
                p.Id.StartsWith("SkiaSharp.Views.Uno")).ToList(),
            ("SkiaSharp Views", "Web") => _stats.Packages.Where(p => 
                p.Id == "SkiaSharp.Views.Blazor").ToList(),
            ("SkiaSharp Extensions", "Text") => _stats.Packages.Where(p => 
                p.Id == "SkiaSharp.HarfBuzz").ToList(),
            ("SkiaSharp Extensions", "Animation") => _stats.Packages.Where(p => 
                p.Id is "SkiaSharp.Skottie" or "SkiaSharp.SceneGraph" or "SkiaSharp.Resources").ToList(),
            ("SkiaSharp Extensions", "GPU Backends") => _stats.Packages.Where(p => 
                p.Id is "SkiaSharp.Vulkan.SharpVk" or "SkiaSharp.Direct3D.Vortice").ToList(),
            ("HarfBuzzSharp", "Core") => _stats.Packages.Where(p => 
                p.Id == "HarfBuzzSharp").ToList(),
            ("HarfBuzzSharp", "Native Assets") => _stats.Packages.Where(p => 
                p.Id.StartsWith("HarfBuzzSharp.NativeAssets.")).ToList(),
            _ => []
        };
    }

    private static string GetShortName(string id)
    {
        // Remove common prefixes for cleaner display
        if (id == "SkiaSharp" || id == "HarfBuzzSharp") return id;
        if (id.StartsWith("SkiaSharp.NativeAssets.")) return id.Replace("SkiaSharp.NativeAssets.", "");
        if (id.StartsWith("SkiaSharp.Views.")) return id.Replace("SkiaSharp.Views.", "");
        if (id.StartsWith("SkiaSharp.")) return id.Replace("SkiaSharp.", "");
        if (id.StartsWith("HarfBuzzSharp.NativeAssets.")) return id.Replace("HarfBuzzSharp.NativeAssets.", "");
        if (id.StartsWith("HarfBuzzSharp.")) return id.Replace("HarfBuzzSharp.", "");
        return id;
    }
}
