@page "/pr-triage"
@page "/pull-requests"
@using ApexCharts
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>Pull Requests - SkiaSharp Dashboard</PageTitle>

<h1>Pull Requests</h1>
<p class="subtitle">Review queue with triage categories and filters</p>

@if (_loading)
{
    <p><em>Loading PR data...</em></p>
}
else if (_data is null)
{
    <p>No data available.</p>
}
else
{
    <!-- Trend Stats Cards -->
    @if (_trendData is not null)
    {
        <div class="trend-stats-row">
            <div class="trend-stat-card">
                <div class="trend-stat-value">@_trendData.PullRequests.TotalCreated.ToString("N0")</div>
                <div class="trend-stat-label">Total Opened</div>
            </div>
            @if (_trendData.PullRequests.TotalMerged.HasValue)
            {
                <div class="trend-stat-card">
                    <div class="trend-stat-value">@_trendData.PullRequests.TotalMerged.Value.ToString("N0")</div>
                    <div class="trend-stat-label">Total Merged</div>
                </div>
            }
            <div class="trend-stat-card">
                <div class="trend-stat-value">@_trendData.PullRequests.TotalClosed.ToString("N0")</div>
                <div class="trend-stat-label">Total Closed</div>
            </div>
            <div class="trend-stat-card">
                <div class="trend-stat-value">@_trendData.PullRequests.CurrentlyOpen.ToString("N0")</div>
                <div class="trend-stat-label">Currently Open</div>
            </div>
            @if (_trendData.PullRequests.MergeRate.HasValue)
            {
                <div class="trend-stat-card">
                    <div class="trend-stat-value">@_trendData.PullRequests.MergeRate.Value%</div>
                    <div class="trend-stat-label">Merge Rate</div>
                </div>
            }
            @if (_trendData.PullRequests.AvgDaysToMerge.HasValue)
            {
                <div class="trend-stat-card">
                    <div class="trend-stat-value">@_trendData.PullRequests.AvgDaysToMerge.Value.ToString("N0")</div>
                    <div class="trend-stat-label">Avg Days to Merge</div>
                </div>
            }
        </div>

        <!-- Monthly Activity Chart -->
        @if (_trendData?.MonthlyTrends.Count > 0)
        {
            <div class="trend-chart-section">
                <div class="trend-chart-header">
                    <h3>PR Activity Over Time</h3>
                    <select class="time-range-select" @bind="SelectedTimeRange" @bind:after="UpdateChartData">
                        <option value="6">Last 6 Months</option>
                        <option value="12">Last Year</option>
                        <option value="24">Last 2 Years</option>
                        <option value="60">Last 5 Years</option>
                        <option value="0">All Time</option>
                    </select>
                </div>
                <ApexChart @ref="_chart" TItem="ChartPoint"
                           Options="_chartOptions"
                           Height="300">
                    <ApexPointSeries TItem="ChartPoint"
                                     Items="_chartData"
                                     Name="Opened"
                                     SeriesType="SeriesType.Line"
                                     XValue="@(p => p.Month)"
                                     YValue="@(p => p.Opened)" />
                    <ApexPointSeries TItem="ChartPoint"
                                     Items="_chartData"
                                     Name="Merged"
                                     SeriesType="SeriesType.Line"
                                     XValue="@(p => p.Month)"
                                     YValue="@(p => p.Merged)" />
                </ApexChart>
            </div>
        }
    }

    <!-- Summary Cards -->
    <div class="triage-summary">
        <div class="triage-card triage-success @(SelectedCategory == "ready" ? "selected" : "")" @onclick='() => FilterByCategory("ready")'>
            <span class="triage-count">@_data.Summary.ReadyToMerge</span>
            <span class="triage-label">Ready to Merge</span>
        </div>
        <div class="triage-card triage-info @(SelectedCategory == "quick" ? "selected" : "")" @onclick='() => FilterByCategory("quick")'>
            <span class="triage-count">@_data.Summary.QuickReview</span>
            <span class="triage-label">Quick Review</span>
        </div>
        <div class="triage-card triage-warning @(SelectedCategory == "review" ? "selected" : "")" @onclick='() => FilterByCategory("review")'>
            <span class="triage-count">@_data.Summary.NeedsReview</span>
            <span class="triage-label">Needs Review</span>
        </div>
        <div class="triage-card triage-author @(SelectedCategory == "author" ? "selected" : "")" @onclick='() => FilterByCategory("author")'>
            <span class="triage-count">@_data.Summary.NeedsAuthor</span>
            <span class="triage-label">Needs Author</span>
        </div>
        <div class="triage-card triage-danger @(SelectedCategory == "close" ? "selected" : "")" @onclick='() => FilterByCategory("close")'>
            <span class="triage-count">@_data.Summary.ConsiderClosing</span>
            <span class="triage-label">Consider Closing</span>
        </div>
    </div>

    <!-- Filter Row -->
    <div class="filter-row">
        <div class="filter-group">
            <label>Repository</label>
            <select @bind="SelectedRepo" @bind:after="ApplyFilters">
                <option value="">All Repos</option>
                @foreach (var repo in _data.ByRepo)
                {
                    <option value="@repo.RepoId">@repo.DisplayName (@repo.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Size</label>
            <select @bind="SelectedSize" @bind:after="ApplyFilters">
                <option value="">All Sizes</option>
                @foreach (var size in _data.BySize)
                {
                    <option value="@size.Label">@size.Display (@size.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Age</label>
            <select @bind="SelectedAge" @bind:after="ApplyFilters">
                <option value="">All Ages</option>
                @foreach (var age in _data.ByAge)
                {
                    <option value="@age.Label">@age.Display (@age.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Author Type</label>
            <select @bind="SelectedAuthor" @bind:after="ApplyFilters">
                <option value="">All Authors</option>
                <option value="microsoft">Microsoft</option>
                <option value="community">Community</option>
                <option value="bot">Bot</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Draft</label>
            <select @bind="SelectedDraft" @bind:after="ApplyFilters">
                <option value="">All</option>
                <option value="ready">Ready for Review</option>
                <option value="draft">Draft</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select @bind="SelectedSort" @bind:after="ApplyFilters">
                <option value="triage">By Triage Category</option>
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="updated">Recently Updated</option>
                <option value="smallest">Smallest First</option>
                <option value="largest">Largest First</option>
                <option value="files">Most Files</option>
            </select>
        </div>
        @if (HasFilters)
        {
            <button class="btn-clear" @onclick="ClearFilters">Clear Filters</button>
        }
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <span>Showing <strong>@_filteredPRs.Count</strong> of @_data.TotalCount pull requests</span>
    </div>

    <!-- PR List -->
    <div class="pr-list">
        @foreach (var pr in _filteredPRs)
        {
            <div class="pr-card @GetCategoryClass(pr.Category)">
                <div class="pr-header">
                    <img src="@pr.AuthorAvatarUrl" alt="@pr.Author" class="avatar-small" />
                    <a href="@pr.Url" target="_blank" class="pr-title">
                        #@pr.Number: @pr.Title
                    </a>
                    @if (pr.IsDraft)
                    {
                        <span class="badge-draft">Draft</span>
                    }
                    <span class="badge-category badge-@pr.Category.ToString().ToLower()">@GetCategoryShort(pr.Category)</span>
                </div>
                <div class="pr-meta">
                    <span class="author-badge author-@pr.AuthorType">@pr.Author</span>
                    <span class="@GetAgeClass(pr.AgeCategory)">@((int)pr.DaysOpen) days old</span>
                    <span class="size-badge size-@pr.SizeCategory">@pr.SizeCategory.ToUpper() (@pr.TotalChanges lines)</span>
                    <span>@pr.FilesChanged files</span>
                </div>
                @{
                    var allLabels = new List<string>();
                    if (pr.Type != null) allLabels.Add(pr.Type);
                    allLabels.AddRange(pr.Areas);
                    allLabels.AddRange(pr.Backends);
                    allLabels.AddRange(pr.Oses);
                }
                @if (allLabels.Count > 0)
                {
                    <div class="pr-labels">
                        @foreach (var label in allLabels.Take(5))
                        {
                            <span class="label">@label</span>
                        }
                        @if (allLabels.Count > 5)
                        {
                            <span class="label-more">+@(allLabels.Count - 5) more</span>
                        }
                    </div>
                }
                <div class="pr-reasoning">
                    @pr.Reasoning
                </div>
            </div>
        }
    </div>

    <p class="last-updated">Last updated: @_data.GeneratedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
}

@code {
    [SupplyParameterFromQuery] public string? Repo { get; set; }
    [SupplyParameterFromQuery] public string? Category { get; set; }
    [SupplyParameterFromQuery] public string? Size { get; set; }
    [SupplyParameterFromQuery] public string? Age { get; set; }
    [SupplyParameterFromQuery] public string? Author { get; set; }
    [SupplyParameterFromQuery] public string? Draft { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }

    private bool _loading = true;
    private PrTriageStats? _data;
    private TrendData? _trendData;
    private List<TriagedPullRequest> _filteredPRs = [];

    // Chart data
    private ApexChart<ChartPoint>? _chart;
    private List<ChartPoint> _chartData = [];
    private int SelectedTimeRange { get; set; } = 24; // Default: 2 years
    private ApexChartOptions<ChartPoint> _chartOptions = new()
    {
        Chart = new Chart { Toolbar = new Toolbar { Show = false } },
        Stroke = new Stroke { Curve = Curve.Smooth, Width = 2 },
        Colors = ["#0d6efd", "#198754"],
        Xaxis = new XAxis { TickAmount = 12 }
    };

    private record ChartPoint(string Month, int Opened, int Merged);

    private string SelectedRepo { get; set; } = "";
    private string SelectedCategory { get; set; } = "";
    private string SelectedSize { get; set; } = "";
    private string SelectedAge { get; set; } = "";
    private string SelectedAuthor { get; set; } = "";
    private string SelectedDraft { get; set; } = "";
    private string SelectedSort { get; set; } = "triage";

    private bool HasFilters => !string.IsNullOrEmpty(SelectedRepo) ||
                               !string.IsNullOrEmpty(SelectedCategory) ||
                               !string.IsNullOrEmpty(SelectedSize) ||
                               !string.IsNullOrEmpty(SelectedAge) ||
                               !string.IsNullOrEmpty(SelectedAuthor) ||
                               !string.IsNullOrEmpty(SelectedDraft);

    protected override async Task OnInitializedAsync()
    {
        SelectedRepo = Repo ?? "";
        SelectedCategory = Category ?? "";
        SelectedSize = Size ?? "";
        SelectedAge = Age ?? "";
        SelectedAuthor = Author ?? "";
        SelectedDraft = Draft ?? "";
        SelectedSort = Sort ?? "triage";

        try { _data = await DataService.GetPrTriageStatsAsync(); }
        catch { /* Data not yet available */ }

        try 
        { 
            _trendData = await DataService.GetTrendDataAsync();
            await UpdateChartData();
        }
        catch { /* Trend data not yet available */ }

        ApplyFiltersInternal(updateUrl: false); // Don't update URL on initial load
        _loading = false;
    }

    private async Task UpdateChartData()
    {
        if (_trendData is null) return;
        
        var trends = SelectedTimeRange == 0 
            ? _trendData.MonthlyTrends 
            : _trendData.MonthlyTrends.TakeLast(SelectedTimeRange);
            
        _chartData = trends
            .Select(t => new ChartPoint(t.Month, t.PrsCreated, t.PrsMerged))
            .ToList();
        
        if (_chart is not null)
            await _chart.UpdateSeriesAsync(true);
    }

    private void FilterByCategory(string category)
    {
        SelectedCategory = SelectedCategory == category ? "" : category;
        ApplyFilters();
    }

    private void ApplyFilters() => ApplyFiltersInternal(updateUrl: true);

    private void ApplyFiltersInternal(bool updateUrl)
    {
        if (_data is null) return;

        var filtered = _data.PullRequests.Where(pr =>
            (string.IsNullOrEmpty(SelectedRepo) || pr.Repo == SelectedRepo) &&
            (string.IsNullOrEmpty(SelectedCategory) || GetCategoryKey(pr.Category) == SelectedCategory) &&
            (string.IsNullOrEmpty(SelectedSize) || pr.SizeCategory == SelectedSize) &&
            (string.IsNullOrEmpty(SelectedAge) || pr.AgeCategory == SelectedAge) &&
            (string.IsNullOrEmpty(SelectedAuthor) || pr.AuthorType == SelectedAuthor) &&
            (string.IsNullOrEmpty(SelectedDraft) || 
                (SelectedDraft == "draft" && pr.IsDraft) || 
                (SelectedDraft == "ready" && !pr.IsDraft))
        );

        // Apply sorting
        _filteredPRs = SelectedSort switch
        {
            "newest" => filtered.OrderByDescending(pr => pr.CreatedAt).ToList(),
            "oldest" => filtered.OrderBy(pr => pr.CreatedAt).ToList(),
            "updated" => filtered.OrderByDescending(pr => pr.UpdatedAt).ToList(),
            "smallest" => filtered.OrderBy(pr => pr.TotalChanges).ToList(),
            "largest" => filtered.OrderByDescending(pr => pr.TotalChanges).ToList(),
            "files" => filtered.OrderByDescending(pr => pr.FilesChanged).ToList(),
            _ => filtered.OrderBy(pr => GetCategoryOrder(pr.Category)).ThenBy(pr => pr.DaysOpen).ToList() // triage (default)
        };

        if (updateUrl) UpdateUrl();
    }

    private void UpdateUrl()
    {
        var query = new List<string>();
        if (!string.IsNullOrEmpty(SelectedRepo)) query.Add($"repo={Uri.EscapeDataString(SelectedRepo)}");
        if (!string.IsNullOrEmpty(SelectedCategory)) query.Add($"category={SelectedCategory}");
        if (!string.IsNullOrEmpty(SelectedSize)) query.Add($"size={SelectedSize}");
        if (!string.IsNullOrEmpty(SelectedAge)) query.Add($"age={SelectedAge}");
        if (!string.IsNullOrEmpty(SelectedAuthor)) query.Add($"author={SelectedAuthor}");
        if (!string.IsNullOrEmpty(SelectedDraft)) query.Add($"draft={SelectedDraft}");
        if (SelectedSort != "triage") query.Add($"sort={SelectedSort}");

        var url = "pull-requests" + (query.Count > 0 ? "?" + string.Join("&", query) : "");
        Navigation.NavigateTo(url, replace: true);
    }

    private void ClearFilters()
    {
        SelectedRepo = "";
        SelectedCategory = "";
        SelectedSize = "";
        SelectedAge = "";
        SelectedAuthor = "";
        SelectedDraft = "";
        SelectedSort = "triage";
        ApplyFilters();
    }

    private static string GetCategoryKey(TriageCategory category) => category switch
    {
        TriageCategory.ReadyToMerge => "ready",
        TriageCategory.QuickReview => "quick",
        TriageCategory.NeedsReview => "review",
        TriageCategory.NeedsAuthor => "author",
        TriageCategory.ConsiderClosing => "close",
        _ => ""
    };

    private static int GetCategoryOrder(TriageCategory category) => category switch
    {
        TriageCategory.ReadyToMerge => 1,
        TriageCategory.QuickReview => 2,
        TriageCategory.NeedsReview => 3,
        TriageCategory.NeedsAuthor => 4,
        TriageCategory.ConsiderClosing => 5,
        _ => 99
    };

    private static string GetCategoryShort(TriageCategory category) => category switch
    {
        TriageCategory.ReadyToMerge => "âœ… Ready",
        TriageCategory.QuickReview => "âš¡ Quick",
        TriageCategory.NeedsReview => "ðŸ” Review",
        TriageCategory.NeedsAuthor => "âœï¸ Author",
        TriageCategory.ConsiderClosing => "âŒ Stale",
        _ => ""
    };

    private static string GetCategoryClass(TriageCategory category) => category switch
    {
        TriageCategory.ReadyToMerge => "category-success",
        TriageCategory.QuickReview => "category-info",
        TriageCategory.NeedsReview => "category-warning",
        TriageCategory.NeedsAuthor => "category-author",
        TriageCategory.ConsiderClosing => "category-danger",
        _ => ""
    };

    private static string GetAgeClass(string ageCategory) => ageCategory switch
    {
        "fresh" => "age-fresh",
        "recent" => "age-recent",
        "aging" => "age-aging",
        "stale" => "age-stale",
        "ancient" => "age-ancient",
        _ => ""
    };
}
