@page "/issues"
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>Issues - SkiaSharp Dashboard</PageTitle>

<h1>Issues</h1>
<p class="subtitle">Browse and filter open issues</p>

@if (_loading)
{
    <p><em>Loading issues data...</em></p>
}
else if (_data is null)
{
    <p>No data available.</p>
}
else
{
    <!-- Hot Issues Section -->
    @if (_data.HotIssues?.Count > 0)
    {
        <div class="hot-issues-section">
            <h2>ðŸ”¥ Hot Issues</h2>
            <p class="hot-issues-subtitle">Trending issues with recent activity</p>
            <div class="hot-issues-grid">
                @foreach (var issue in _data.HotIssues.Take(5))
                {
                    <a href="@issue.Url" target="_blank" class="hot-issue-card">
                        <div class="hot-issue-header">
                            <span class="hot-issue-number">#@issue.Number</span>
                            @if (issue.Engagement != null)
                            {
                                <span class="hot-score" title="Engagement score: @issue.Engagement.CurrentScore.ToString("F1")">
                                    ðŸ”¥ @issue.Engagement.CurrentScore.ToString("F0")
                                </span>
                            }
                        </div>
                        <div class="hot-issue-title">@Truncate(issue.Title, 80)</div>
                        <div class="hot-issue-meta">
                            <span>ðŸ’¬ @issue.CommentCount</span>
                            <span>@((int)issue.DaysOpen) days old</span>
                        </div>
                    </a>
                }
            </div>
        </div>
    }

    <!-- Filter Row -->
    <div class="filter-row">
        <div class="filter-group">
            <label>Type</label>
            <select @bind="SelectedType" @bind:after="ApplyFilters">
                <option value="">All Types</option>
                @foreach (var type in _data.ByType)
                {
                    <option value="@type.Label">@type.Label (@type.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Area</label>
            <select @bind="SelectedArea" @bind:after="ApplyFilters">
                <option value="">All Areas</option>
                @foreach (var area in _data.ByArea.Take(20))
                {
                    <option value="@area.Label">@area.Label (@area.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Age</label>
            <select @bind="SelectedAge" @bind:after="ApplyFilters">
                <option value="">All Ages</option>
                @foreach (var age in _data.ByAge)
                {
                    <option value="@age.Label">@age.Display (@age.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Backend</label>
            <select @bind="SelectedBackend" @bind:after="ApplyFilters">
                <option value="">All Backends</option>
                @foreach (var backend in _data.ByBackend)
                {
                    <option value="@backend.Label">@backend.Label (@backend.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>OS</label>
            <select @bind="SelectedOs" @bind:after="ApplyFilters">
                <option value="">All OS</option>
                @foreach (var os in _data.ByOs)
                {
                    <option value="@os.Label">@os.Label (@os.Count)</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Sort By</label>
            <select @bind="SelectedSort" @bind:after="ApplyFilters">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="updated">Recently Updated</option>
                <option value="comments">Most Comments</option>
                <option value="engagement">Highest Engagement</option>
                <option value="longest">Longest Open</option>
            </select>
        </div>
        @if (HasFilters)
        {
            <button class="btn-clear" @onclick="ClearFilters">Clear Filters</button>
        }
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <span>Showing <strong>@_filteredIssues.Count</strong> of @_data.TotalCount issues</span>
        @if (_filteredIssues.Count > 0)
        {
            <span>Oldest: @GetOldest() | Newest: @GetNewest()</span>
        }
    </div>

    <!-- Issue Table -->
    <div class="issue-table-container">
        <table class="issue-table">
            <thead>
                <tr>
                    <th class="col-number">#</th>
                    <th class="col-title">Title</th>
                    <th class="col-type">Type</th>
                    <th class="col-area">Area</th>
                    <th class="col-age">Age</th>
                    <th class="col-comments">ðŸ’¬</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var issue in _filteredIssues.Take(100))
                {
                    <tr @onclick="() => ExpandIssue(issue.Number)" class="@(ExpandedIssue == issue.Number ? "expanded" : "")">
                        <td class="col-number">
                            @issue.Number
                            @if (issue.Engagement?.IsHot == true)
                            {
                                <span class="hot-badge" title="Trending">ðŸ”¥</span>
                            }
                        </td>
                        <td class="col-title">
                            <a href="@issue.Url" target="_blank" @onclick:stopPropagation="true">@issue.Title</a>
                        </td>
                        <td class="col-type">
                            @if (issue.Type != null)
                            {
                                <span class="label label-type">@issue.Type</span>
                            }
                        </td>
                        <td class="col-area">
                            @foreach (var area in issue.Areas.Take(2))
                            {
                                <span class="label label-area">@area</span>
                            }
                            @if (issue.Areas.Count > 2)
                            {
                                <span class="label-more">+@(issue.Areas.Count - 2)</span>
                            }
                        </td>
                        <td class="col-age @GetAgeClass(issue.AgeCategory)">@((int)issue.DaysOpen) days</td>
                        <td class="col-comments">@issue.CommentCount</td>
                    </tr>
                    @if (ExpandedIssue == issue.Number)
                    {
                        <tr class="expanded-row">
                            <td colspan="6">
                                <div class="issue-details">
                                    <div class="issue-meta">
                                        <img src="@issue.AuthorAvatarUrl" alt="@issue.Author" class="avatar-small" />
                                        <span>Opened by <strong>@issue.Author</strong> on @issue.CreatedAt.ToString("MMM dd, yyyy")</span>
                                        <span>Last activity: @issue.DaysSinceActivity days ago</span>
                                        @if (issue.Engagement != null)
                                        {
                                            <span class="engagement-info">
                                                Engagement: <strong>@issue.Engagement.CurrentScore.ToString("F1")</strong>
                                                @if (issue.Engagement.IsHot)
                                                {
                                                    <span class="trending-up" title="Score increased from @issue.Engagement.PreviousScore.ToString("F1")">ðŸ“ˆ</span>
                                                }
                                            </span>
                                        }
                                    </div>
                                    <div class="issue-labels">
                                        @if (issue.Type != null) { <span class="label label-type">@issue.Type</span> }
                                        @foreach (var area in issue.Areas) { <span class="label label-area">@area</span> }
                                        @foreach (var backend in issue.Backends) { <span class="label label-backend">@backend</span> }
                                        @foreach (var os in issue.Oses) { <span class="label label-os">@os</span> }
                                        @foreach (var other in issue.OtherLabels) { <span class="label">@other</span> }
                                    </div>
                                    <a href="@issue.Url" target="_blank" class="btn-view">View on GitHub â†’</a>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (_filteredIssues.Count > 100)
    {
        <p class="showing-limit">Showing first 100 of @_filteredIssues.Count filtered issues</p>
    }

    <p class="last-updated">Last updated: @_data.GeneratedAt.ToString("yyyy-MM-dd HH:mm UTC")</p>
}

@code {
    [SupplyParameterFromQuery] public string? Type { get; set; }
    [SupplyParameterFromQuery] public string? Area { get; set; }
    [SupplyParameterFromQuery] public string? Age { get; set; }
    [SupplyParameterFromQuery] public string? Backend { get; set; }
    [SupplyParameterFromQuery] public string? Os { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }

    private bool _loading = true;
    private IssuesData? _data;
    private List<IssueInfo> _filteredIssues = [];
    private int? ExpandedIssue;

    private string SelectedType { get; set; } = "";
    private string SelectedArea { get; set; } = "";
    private string SelectedAge { get; set; } = "";
    private string SelectedBackend { get; set; } = "";
    private string SelectedOs { get; set; } = "";
    private string SelectedSort { get; set; } = "newest";

    private bool HasFilters => !string.IsNullOrEmpty(SelectedType) || 
                               !string.IsNullOrEmpty(SelectedArea) || 
                               !string.IsNullOrEmpty(SelectedAge) ||
                               !string.IsNullOrEmpty(SelectedBackend) ||
                               !string.IsNullOrEmpty(SelectedOs);

    protected override async Task OnInitializedAsync()
    {
        // Read initial filters from URL
        SelectedType = Type ?? "";
        SelectedArea = Area ?? "";
        SelectedAge = Age ?? "";
        SelectedBackend = Backend ?? "";
        SelectedOs = Os ?? "";
        SelectedSort = Sort ?? "newest";

        try { _data = await DataService.GetIssuesDataAsync(); }
        catch { /* Data not yet available */ }
        
        ApplyFiltersInternal(updateUrl: false); // Don't update URL on initial load
        _loading = false;
    }

    private void ApplyFilters() => ApplyFiltersInternal(updateUrl: true);

    private void ApplyFiltersInternal(bool updateUrl)
    {
        if (_data is null) return;

        var filtered = _data.Issues.Where(i =>
            (string.IsNullOrEmpty(SelectedType) || i.Type == SelectedType) &&
            (string.IsNullOrEmpty(SelectedArea) || i.Areas.Contains(SelectedArea)) &&
            (string.IsNullOrEmpty(SelectedAge) || i.AgeCategory == SelectedAge) &&
            (string.IsNullOrEmpty(SelectedBackend) || i.Backends.Contains(SelectedBackend)) &&
            (string.IsNullOrEmpty(SelectedOs) || i.Oses.Contains(SelectedOs))
        );

        // Apply sorting
        _filteredIssues = SelectedSort switch
        {
            "oldest" => filtered.OrderBy(i => i.CreatedAt).ToList(),
            "updated" => filtered.OrderByDescending(i => i.UpdatedAt).ToList(),
            "comments" => filtered.OrderByDescending(i => i.CommentCount).ToList(),
            "engagement" => filtered.OrderByDescending(i => i.Engagement?.CurrentScore ?? 0).ToList(),
            "longest" => filtered.OrderByDescending(i => i.DaysOpen).ToList(),
            _ => filtered.OrderByDescending(i => i.CreatedAt).ToList() // newest (default)
        };

        if (updateUrl) UpdateUrl();
    }

    private void UpdateUrl()
    {
        var query = new List<string>();
        if (!string.IsNullOrEmpty(SelectedType)) query.Add($"type={Uri.EscapeDataString(SelectedType)}");
        if (!string.IsNullOrEmpty(SelectedArea)) query.Add($"area={Uri.EscapeDataString(SelectedArea)}");
        if (!string.IsNullOrEmpty(SelectedAge)) query.Add($"age={Uri.EscapeDataString(SelectedAge)}");
        if (!string.IsNullOrEmpty(SelectedBackend)) query.Add($"backend={Uri.EscapeDataString(SelectedBackend)}");
        if (!string.IsNullOrEmpty(SelectedOs)) query.Add($"os={Uri.EscapeDataString(SelectedOs)}");
        if (SelectedSort != "newest") query.Add($"sort={SelectedSort}");
        
        var url = "issues" + (query.Count > 0 ? "?" + string.Join("&", query) : "");
        Navigation.NavigateTo(url, replace: true);
    }

    private void ClearFilters()
    {
        SelectedType = "";
        SelectedArea = "";
        SelectedAge = "";
        SelectedBackend = "";
        SelectedOs = "";
        SelectedSort = "newest";
        ApplyFiltersInternal(true);
    }

    private void ExpandIssue(int number)
    {
        ExpandedIssue = ExpandedIssue == number ? null : number;
    }

    private string GetOldest() => _filteredIssues.MaxBy(i => i.DaysOpen)?.DaysOpen is double d ? $"{(int)d} days" : "";
    private string GetNewest() => _filteredIssues.MinBy(i => i.DaysOpen)?.DaysOpen is double d ? $"{(int)d} days" : "";

    private static string GetAgeClass(string ageCategory) => ageCategory switch
    {
        "fresh" => "age-fresh",
        "recent" => "age-recent",
        "aging" => "age-aging",
        "stale" => "age-stale",
        "ancient" => "age-ancient",
        _ => ""
    };

    private static string Truncate(string value, int maxLength)
        => value.Length <= maxLength ? value : value[..(maxLength - 3)] + "...";
}
