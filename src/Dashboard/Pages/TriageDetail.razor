@page "/triage/{Number:int}"
@inject DashboardDataService DataService
@inject NavigationManager Navigation

<PageTitle>@(_issue?.Summary ?? "Triage") - SkiaSharp Dashboard</PageTitle>

@if (_loading)
{
    <p><em>Loading triage data...</em></p>
}
else if (_issue is null)
{
    <h1>Issue Not Found</h1>
    <p>No triage data for issue #@Number.</p>
    <a href="triage" class="btn-back">‚Üê Back to Triage</a>
}
else
{
    <!-- Navigation Bar -->
    <div class="triage-detail-nav">
        <a href="@BackUrl" class="btn-back">‚Üê Back to list</a>
        <div class="nav-position">
            @if (_prevNumber is not null)
            {
                <a href="@DetailUrl(_prevNumber.Value)" class="btn-prev">‚Üê #@_prevNumber</a>
            }
            <span class="nav-counter">@(_currentIndex + 1) of @_totalCount</span>
            @if (_nextNumber is not null)
            {
                <a href="@DetailUrl(_nextNumber.Value)" class="btn-next">#@_nextNumber ‚Üí</a>
            }
        </div>
    </div>

    <!-- Header -->
    <div class="triage-detail-header">
        <div class="detail-title-row">
            <a href="@_issue.Url" target="_blank" class="issue-link-lg">#@_issue.Meta.Number</a>
            <h1>@_issue.Summary</h1>
        </div>
        <div class="detail-badges">
            <span class="badge-type badge-@StripPrefix(_issue.Classification.Type.Value) has-rationale" style="position:relative">
                @FormatLabel(_issue.Classification.Type.Value)
                @{ var hdrTypeR = GetRationale("type"); }
                @if (hdrTypeR is not null) { <span class="rationale-tooltip">@hdrTypeR</span> }
            </span>
            @if (_issue.Evidence.BugSignals?.Severity is not null)
            {
                <span class="badge-severity badge-sev-@_issue.Evidence.BugSignals.Severity.ToJsonString() has-rationale" style="position:relative">
                    @FormatLabel(_issue.Evidence.BugSignals.Severity.ToJsonString())
                    @{ var hdrSevR = GetRationale("bugSignals.severity"); }
                    @if (hdrSevR is not null) { <span class="rationale-tooltip">@hdrSevR</span> }
                </span>
            }
            <span class="badge-action badge-act-@_issue.Output.Actionability.SuggestedAction.ToJsonString() has-rationale" style="position:relative">
                @FormatLabel(_issue.Output.Actionability.SuggestedAction.ToJsonString())
                @{ var hdrActR = GetRationale("actionability.suggestedAction"); }
                @if (hdrActR is not null) { <span class="rationale-tooltip">@hdrActR</span> }
            </span>
            <span class="confidence-pill-lg" title="Overall confidence in the suggested action. 95%+ = explicit evidence, 80-94% = strong inference, 60-79% = ambiguous">
                <span class="confidence-bar @GetConfidenceClass(_issue.Output.Actionability.Confidence)" style="width: @((int)(_issue.Output.Actionability.Confidence * 100))%"></span>
                <span class="confidence-text">@_issue.Output.Actionability.Confidence.ToString("P0")</span>
            </span>
            @if (_issue.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true)
            {
                <span class="badge-closeable" title="Has a close-issue action ‚Äî AI believes this can be closed">‚úì Closeable</span>
            }
            @if (_issue.Output.Actionability.RequiresHumanReview == true)
            {
                <span class="badge-human-review" title="Low confidence or high-risk action ‚Äî a maintainer should verify before acting">‚ö† Needs Human Review</span>
            }
        </div>
        <p class="detail-meta">
            Analyzed: @_issue.Meta.AnalyzedAt.ToString("yyyy-MM-dd HH:mm UTC")
            ¬∑ Repo: <a href="https://github.com/@_issue.Meta.Repo" target="_blank">@_issue.Meta.Repo</a>
        </p>
    </div>

    <!-- Classification & Action (side by side) -->
    <div class="detail-section-grid">
        <div class="detail-card card-classification">
            <h3 title="AI-assigned labels ‚Äî hover each field for rationale">Classification</h3>
            <div class="field-row has-rationale">
                <span class="field-label">Type:</span>
                <span class="badge-type badge-@StripPrefix(_issue.Classification.Type.Value)">@FormatLabel(_issue.Classification.Type.Value)</span>
                <span class="field-confidence">@_issue.Classification.Type.Confidence.ToString("P0")</span>
                @{ var typeRationale = GetRationale("type"); }
                @if (typeRationale is not null)
                {
                    <span class="rationale-tooltip">@typeRationale</span>
                }
            </div>
            @if (_issue.Classification.Area is not null)
            {
                <div class="field-row has-rationale">
                    <span class="field-label">Area:</span>
                    <span class="label label-area">@FormatLabel(_issue.Classification.Area.Value)</span>
                    <span class="field-confidence">@_issue.Classification.Area.Confidence.ToString("P0")</span>
                    @{ var areaRationale = GetRationale("area"); }
                    @if (areaRationale is not null)
                    {
                        <span class="rationale-tooltip">@areaRationale</span>
                    }
                </div>
            }
            @if (_issue.Classification.Platforms is { Count: > 0 })
            {
                <div class="field-row has-rationale">
                    <span class="field-label">Platforms:</span>
                    @foreach (var p in _issue.Classification.Platforms)
                    {
                        <span class="label label-os">@FormatLabel(p.Value)</span>
                    }
                    @{ var platformRationale = GetRationale("platforms"); }
                    @if (platformRationale is not null)
                    {
                        <span class="rationale-tooltip">@platformRationale</span>
                    }
                </div>
            }
            @if (_issue.Classification.Backends is { Count: > 0 })
            {
                <div class="field-row has-rationale">
                    <span class="field-label">Backends:</span>
                    @foreach (var b in _issue.Classification.Backends)
                    {
                        <span class="label label-backend">@FormatLabel(b.Value)</span>
                    }
                    @{ var backendRationale = GetRationale("backends"); }
                    @if (backendRationale is not null)
                    {
                        <span class="rationale-tooltip">@backendRationale</span>
                    }
                </div>
            }
            @if (_issue.Classification.Tenets is { Count: > 0 })
            {
                <div class="field-row has-rationale">
                    <span class="field-label">Tenets:</span>
                    @foreach (var t in _issue.Classification.Tenets)
                    {
                        <span class="label label-tenet">@FormatLabel(t.Value)</span>
                    }
                    @{ var tenetRationale = GetRationale("tenets"); }
                    @if (tenetRationale is not null)
                    {
                        <span class="rationale-tooltip">@tenetRationale</span>
                    }
                </div>
            }
            @if (_issue.Classification.Partner is not null)
            {
                <div class="field-row has-rationale">
                    <span class="field-label">Partner:</span>
                    <span class="label label-partner">@FormatLabel(_issue.Classification.Partner.Value)</span>
                    @{ var partnerRationale = GetRationale("partner"); }
                    @if (partnerRationale is not null)
                    {
                        <span class="rationale-tooltip">@partnerRationale</span>
                    }
                </div>
            }
        </div>

        <div class="detail-card card-action">
            <h3>Suggested Action</h3>
            <div class="action-detail has-rationale">
                <span class="badge-action badge-act-@_issue.Output.Actionability.SuggestedAction.ToJsonString()">
                    @FormatLabel(_issue.Output.Actionability.SuggestedAction.ToJsonString())
                </span>
                <span class="field-confidence">@_issue.Output.Actionability.Confidence.ToString("P0")</span>
                @{ var actionRationale = GetRationale("actionability.suggestedAction"); }
                @if (actionRationale is not null)
                {
                    <span class="rationale-tooltip">@actionRationale</span>
                }
            </div>
            <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Output.Actionability.Reason)</div>
            @if (_issue.Output.Actionability.MissingInfo is { Count: > 0 })
            {
                <div class="missing-info">
                    <strong>Missing:</strong>
                    @foreach (var mi in _issue.Output.Actionability.MissingInfo)
                    {
                        <span class="label label-missing">@FormatLabel(mi.ToJsonString())</span>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Bug Signals -->
    @if (_issue.Evidence.BugSignals is not null)
    {
        <div class="detail-card card-bug-signals">
            <h3 title="Bug indicators extracted from the issue">Bug Signals</h3>
            <div class="bug-signals-grid">
                <span class="signal @(_issue.Evidence.BugSignals.HasCrash ? "signal-yes" : "signal-no")" title="Whether the issue involves a crash or fatal error">
                    @(_issue.Evidence.BugSignals.HasCrash ? "üí• Crash" : "No Crash")
                </span>
                <span class="signal @(_issue.Evidence.BugSignals.HasStackTrace ? "signal-yes" : "signal-no")" title="Whether a stack trace or error log was provided">
                    @(_issue.Evidence.BugSignals.HasStackTrace ? "üìã Stack Trace" : "No Stack Trace")
                </span>
                <span class="signal @(_issue.Evidence.BugSignals.HasWorkaround == true ? "signal-yes" : "signal-no")" title="Whether a workaround has been identified">
                    @(_issue.Evidence.BugSignals.HasWorkaround == true ? "üîß Workaround" : "No Workaround")
                </span>
                <span class="badge-severity badge-sev-@_issue.Evidence.BugSignals.Severity.ToJsonString() has-rationale" style="position:relative">
                    @FormatLabel(_issue.Evidence.BugSignals.Severity.ToJsonString())
                    @{ var sevRationale = GetRationale("bugSignals.severity"); }
                    @if (sevRationale is not null)
                    {
                        <span class="rationale-tooltip">@sevRationale</span>
                    }
                </span>
                <span class="label" title="@GetReproTooltip(_issue.Evidence.BugSignals.ReproQuality)">Repro: @FormatLabel(_issue.Evidence.BugSignals.ReproQuality.ToJsonString())</span>
            </div>
            <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Evidence.BugSignals.SeverityReason)</div>
            @if (_issue.Evidence.BugSignals.WorkaroundSummary is not null)
            {
                <div class="workaround-box">
                    <strong>Workaround:</strong>
                    <div class="md-content">@MarkdownHelper.ToHtml(_issue.Evidence.BugSignals.WorkaroundSummary)</div>
                </div>
            }
            @if (_issue.Evidence.BugSignals.TargetFrameworks is { Count: > 0 })
            {
                <div class="field-row" style="margin-top: 0.5rem">
                    <span class="field-label">Frameworks:</span>
                    @foreach (var fw in _issue.Evidence.BugSignals.TargetFrameworks)
                    {
                        <span class="label">@fw</span>
                    }
                </div>
            }
        </div>
    }

    <!-- Regression & Fix Status (side by side if both exist) -->
    @if (_issue.Evidence.Regression is not null || _issue.Evidence.FixStatus is not null)
    {
        <div class="detail-section-grid">
            @if (_issue.Evidence.Regression is not null)
            {
                <div class="detail-card card-regression">
                    <h3>Regression</h3>
                    @if (_issue.Evidence.Regression.IsRegression)
                    {
                        <span class="badge-regression has-rationale" style="position:relative">
                            ‚ö° Regression
                            @{ var regRationale = GetRationale("regression"); }
                            @if (regRationale is not null) { <span class="rationale-tooltip">@regRationale</span> }
                        </span>
                        <span class="field-confidence">@_issue.Evidence.Regression.Confidence.ToString("P0")</span>
                        @if (_issue.Evidence.Regression.WorkedInVersion is not null)
                        {
                            <div class="field-row">
                                <span class="field-label">Worked in:</span>
                                <strong>@_issue.Evidence.Regression.WorkedInVersion</strong>
                            </div>
                        }
                        @if (_issue.Evidence.Regression.BrokeInVersion is not null)
                        {
                            <div class="field-row">
                                <span class="field-label">Broke in:</span>
                                <strong>@_issue.Evidence.Regression.BrokeInVersion</strong>
                            </div>
                        }
                    }
                    else
                    {
                        <span>Not a regression</span>
                    }
                    <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Evidence.Regression.Reason)</div>
                </div>
            }
            @if (_issue.Evidence.FixStatus is not null)
            {
                <div class="detail-card card-fix-status">
                    <h3>Fix Status</h3>
                    <span class="@(_issue.Evidence.FixStatus.LikelyFixed ? "badge-fixed" : "badge-unfixed")">
                        @(_issue.Evidence.FixStatus.LikelyFixed ? "‚úì Likely Fixed" : "‚úó Not Fixed")
                    </span>
                    <span class="field-confidence">@_issue.Evidence.FixStatus.Confidence.ToString("P0")</span>
                    <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Evidence.FixStatus.Reason)</div>
                    @if (_issue.Evidence.FixStatus.FixedInVersion is not null)
                    {
                        <p>Fixed in: <strong>@_issue.Evidence.FixStatus.FixedInVersion</strong></p>
                    }
                    @if (_issue.Evidence.FixStatus.VerificationStatus is not null)
                    {
                        <span class="label">@FormatLabel(_issue.Evidence.FixStatus.VerificationStatus.Value.ToJsonString())</span>
                    }
                </div>
            }
        </div>
    }

    <!-- Version Analysis -->
    @if (_issue.Evidence.VersionAnalysis is not null)
    {
        <div class="detail-card card-version">
            <h3>Version Analysis</h3>
            @if (_issue.Evidence.VersionAnalysis.MentionedVersions is { Count: > 0 })
            {
                <div class="field-row">
                    <span class="field-label">Versions:</span>
                    @foreach (var v in _issue.Evidence.VersionAnalysis.MentionedVersions)
                    {
                        <span class="label">@v</span>
                    }
                </div>
            }
            @if (_issue.Evidence.VersionAnalysis.CurrentRelevance is not null)
            {
                <div class="field-row">
                    <span class="field-label">Still relevant:</span>
                    <span class="label label-relevance-@_issue.Evidence.VersionAnalysis.CurrentRelevance.Value.ToJsonString()" title="Whether this issue still affects the latest version">@FormatLabel(_issue.Evidence.VersionAnalysis.CurrentRelevance.Value.ToJsonString())</span>
                </div>
            }
            @if (_issue.Evidence.VersionAnalysis.MigrationPath is not null)
            {
                <div class="field-row">
                    <span class="field-label">Migration:</span>
                    <span class="label">@_issue.Evidence.VersionAnalysis.MigrationPath</span>
                </div>
            }
            <div class="reason-text md-content">@MarkdownHelper.ToHtml(_issue.Evidence.VersionAnalysis.Reason)</div>
        </div>
    }

    <!-- Evidence -->
    @if (_issue.Evidence.ReproEvidence is not null)
    {
        var evidence = _issue.Evidence.ReproEvidence;
        <div class="detail-card card-evidence">
            <h3>Evidence</h3>
            @if (evidence.StepsToReproduce is { Count: > 0 })
            {
                <h4>Steps to Reproduce</h4>
                <ol class="repro-steps">
                    @foreach (var step in evidence.StepsToReproduce)
                    {
                        <li>@step</li>
                    }
                </ol>
            }
            @if (evidence.CodeSnippets is { Count: > 0 })
            {
                <h4>Code Snippets</h4>
                @foreach (var snippet in evidence.CodeSnippets)
                {
                    @if (snippet.Context is not null)
                    {
                        <p class="snippet-context">@snippet.Context</p>
                    }
                    <pre class="code-block"><code>@snippet.Code</code></pre>
                }
            }
            @if (evidence.Screenshots is { Count: > 0 })
            {
                <h4>Screenshots (@evidence.Screenshots.Count)</h4>
                @foreach (var ss in evidence.Screenshots)
                {
                    <div class="screenshot-item">
                        <a href="@ss.Url" target="_blank" class="screenshot-link">üì∏ @(ss.Context ?? ss.Url)</a>
                        @if (ss.Source is not null)
                        {
                            <span class="evidence-source">from @ss.Source</span>
                        }
                    </div>
                }
            }
            @if (evidence.Attachments is { Count: > 0 })
            {
                <h4>Attachments</h4>
                @foreach (var att in evidence.Attachments)
                {
                    <div class="attachment-item">
                        <a href="@att.Url" target="_blank">üìé @att.Filename</a>
                        @if (att.Type is not null)
                        {
                            <span class="label">@FormatLabel(att.Type.Value.ToJsonString())</span>
                        }
                    </div>
                }
            }
            @if (evidence.RepoLinks is { Count: > 0 })
            {
                <h4>Repository Links</h4>
                @foreach (var link in evidence.RepoLinks)
                {
                    <div class="repo-link-item">
                        <a href="@link.Url" target="_blank">üîó @(link.Description ?? link.Url)</a>
                    </div>
                }
            }
            @if (evidence.RelatedIssues is { Count: > 0 })
            {
                <h4>Related Issues</h4>
                <div class="related-issues">
                    @foreach (var num in evidence.RelatedIssues)
                    {
                        <a href="https://github.com/@_issue.Meta.Repo/issues/@num" target="_blank" class="related-issue-link">#@num</a>
                    }
                </div>
            }
            @if (evidence.EnvironmentDetails is not null)
            {
                <h4>Environment</h4>
                <p>@evidence.EnvironmentDetails</p>
            }
        </div>
    }

    <!-- Resolution Analysis -->
    @if (_issue.Analysis.Resolution is not null)
    {
        var res = _issue.Analysis.Resolution;
        <div class="detail-card card-resolution">
            <h3>Resolution</h3>
            <div class="resolution-hypothesis">
                <h4>Hypothesis</h4>
                <div class="md-content">@MarkdownHelper.ToHtml(res.Hypothesis)</div>
            </div>

            <div class="proposals-header">
                <h4>Proposals</h4>
                <span class="carousel-hint">‚Üê scroll ‚Üí</span>
            </div>
            <div class="proposals-carousel">
                @{ var sortedProposals = res.Proposals.OrderByDescending(p => p.Title == res.RecommendedProposal).ToList(); }
                @foreach (var proposal in sortedProposals)
                {
                    var isRecommended = proposal.Title == res.RecommendedProposal;
                    <div class="proposal-card @(isRecommended ? "proposal-recommended" : "")">
                        @if (isRecommended)
                        {
                            <span class="badge-recommended">‚òÖ Recommended</span>
                        }
                        <h5>@proposal.Title</h5>
                        <div class="md-content">@MarkdownHelper.ToHtml(proposal.Description)</div>
                        <div class="proposal-meta">
                            @if (proposal.Category is not null)
                            {
                                <span class="label badge-category badge-cat-@proposal.Category.Value.ToJsonString()">@FormatLabel(proposal.Category.Value.ToJsonString())</span>
                            }
                            <span class="label">Effort: @FormatLabel(proposal.Effort.ToJsonString())</span>
                            <span class="field-confidence">@proposal.Confidence.ToString("P0")</span>
                            @if (proposal.Validated is not null)
                            {
                                <span class="label badge-validated badge-val-@proposal.Validated.Value.ToJsonString()">@FormatLabel(proposal.Validated.Value.ToJsonString())</span>
                            }
                        </div>
                        @if (proposal.CodeSnippet is not null)
                        {
                            <details class="proposal-code">
                                <summary>Code Snippet</summary>
                                <pre class="code-block"><code>@proposal.CodeSnippet</code></pre>
                            </details>
                        }
                        @if (isRecommended && res.RecommendedReason is not null)
                        {
                            <div class="recommended-reason">
                                <strong>Why:</strong> @res.RecommendedReason
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    <!-- Actions -->
    @if (_issue.Output.Actions is { Count: > 0 })
    {
        <div class="detail-card card-response">
            <h3 title="Proposed actions the AI recommends ‚Äî each has a risk level and confidence">Actions</h3>
            @foreach (var action in _issue.Output.Actions)
            {
                <div class="action-item" style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid var(--border-color, #dee2e6); border-radius: 0.5rem;">
                    <div class="response-header">
                        <span class="badge-action badge-act-@action.Type.ToJsonString()" title="@GetActionTypeTooltip(action.Type)">@FormatLabel(action.Type.ToJsonString())</span>
                        <span class="badge-risk badge-risk-@action.Risk.ToJsonString()" style="@GetRiskStyle(action.Risk)" title="@GetRiskTooltip(action.Risk)">@FormatLabel(action.Risk.ToJsonString()) risk</span>
                        <span class="field-confidence" title="How confident the AI is in this action">@action.Confidence.ToString("P0")</span>
                    </div>
                    <div class="reason-text md-content">@MarkdownHelper.ToHtml(action.Description)</div>
                    @if (!string.IsNullOrEmpty(action.Reason))
                    {
                        <div class="reason-text-sm md-content" style="margin-top: 0.25rem; opacity: 0.8;">@MarkdownHelper.ToHtml(action.Reason)</div>
                    }

                    @if (action.Type == ActionType.AddComment)
                    {
                        var commentPayload = action.GetCommentPayload();
                        @if (commentPayload?.DraftBody is not null)
                        {
                            <div class="response-draft" style="margin-top: 0.5rem;">
                                <div class="draft-header">
                                    <strong>Draft Response</strong>
                                    @if (commentPayload is not null)
                                    {
                                        <span class="label" style="margin-left: 0.5rem;" title="@GetCommentTypeTooltip(commentPayload.CommentType)">@FormatLabel(commentPayload.CommentType.ToJsonString())</span>
                                    }
                                    @if (commentPayload!.RequiresHumanEdit == true)
                                    {
                                        <span class="badge-human-review" style="margin-left: 0.5rem;" title="AI-drafted text that should be reviewed and edited before posting">‚úè Needs Edit</span>
                                    }
                                    <button class="btn-copy" @onclick="() => CopyToClipboard(commentPayload.DraftBody)">üìã Copy</button>
                                </div>
                                <div class="draft-content md-content">
                                    @MarkdownHelper.ToHtml(commentPayload.DraftBody)
                                </div>
                            </div>
                        }
                    }
                    else if (action.Type == ActionType.UpdateLabels)
                    {
                        var labelsPayload = action.GetLabelsPayload();
                        @if (labelsPayload is not null)
                        {
                            <div style="margin-top: 0.5rem;">
                                @if (labelsPayload.LabelsToAdd is { Count: > 0 })
                                {
                                    <span class="field-label">Add:</span>
                                    @foreach (var lbl in labelsPayload.LabelsToAdd)
                                    {
                                        <span class="label" style="background: #28a745; color: white; margin-right: 0.25rem;">+ @lbl</span>
                                    }
                                }
                                @if (labelsPayload.LabelsToRemove is { Count: > 0 })
                                {
                                    <span class="field-label" style="margin-left: 0.5rem;">Remove:</span>
                                    @foreach (var lbl in labelsPayload.LabelsToRemove)
                                    {
                                        <span class="label" style="background: #dc3545; color: white; margin-right: 0.25rem;">‚àí @lbl</span>
                                    }
                                }
                            </div>
                        }
                    }
                    else if (action.Type == ActionType.CloseIssue)
                    {
                        var closePayload = action.GetClosePayload();
                        @if (closePayload?.Reason is not null)
                        {
                            <p style="margin-top: 0.5rem;">Close reason: <strong>@closePayload.Reason</strong></p>
                        }
                    }
                    else if (action.Type == ActionType.LinkDuplicate)
                    {
                        var dupPayload = action.GetDuplicatePayload();
                        @if (dupPayload?.DuplicateOf is not null)
                        {
                            <p style="margin-top: 0.5rem;">Duplicate of <a href="https://github.com/@_issue.Meta.Repo/issues/@dupPayload.DuplicateOf" target="_blank">#@dupPayload.DuplicateOf</a></p>
                        }
                    }
                    else if (action.Type == ActionType.LinkRelated)
                    {
                        var relPayload = action.GetRelatedPayload();
                        @if (relPayload?.RelatedIssues is { Count: > 0 })
                        {
                            <div class="related-issues" style="margin-top: 0.5rem;">
                                <span class="field-label">Related:</span>
                                @foreach (var num in relPayload.RelatedIssues)
                                {
                                    <a href="https://github.com/@_issue.Meta.Repo/issues/@num" target="_blank" class="related-issue-link">#@num</a>
                                }
                            </div>
                        }
                    }
                    else if (action.Type == ActionType.ConvertToDiscussion)
                    {
                        var discPayload = action.GetDiscussionPayload();
                        @if (discPayload is not null)
                        {
                            <p style="margin-top: 0.5rem;">Convert to discussion: <strong>@discPayload.CategorySlug</strong></p>
                        }
                    }
                    else if (action.Type == ActionType.UpdateProject)
                    {
                        var projPayload = action.GetProjectPayload();
                        @if (projPayload?.FieldUpdates is { Count: > 0 })
                        {
                            <div style="margin-top: 0.5rem;">
                                <span class="field-label">Project updates:</span>
                                @foreach (var field in projPayload.FieldUpdates)
                                {
                                    <span class="label" style="margin-right: 0.25rem;">@field.FieldName ‚Üí @field.Value</span>
                                }
                            </div>
                        }
                    }
                    else if (action.Type == ActionType.SetMilestone)
                    {
                        var msPayload = action.GetMilestonePayload();
                        @if (msPayload is not null)
                        {
                            <p style="margin-top: 0.5rem;">Set milestone: <strong>@msPayload.MilestoneTitle</strong></p>
                        }
                    }
                </div>
            }
        </div>
    }

    <!-- Analysis (Slide-out Sidebar) -->
    <button class="btn-analysis-toggle" @onclick="ToggleAnalysis">
        üî¨ Analysis
    </button>

    <div class="analysis-sidebar @(_analysisOpen ? "open" : "")">
        <div class="sidebar-header">
            <h3>Analysis</h3>
            <button class="btn-sidebar-close" @onclick="ToggleAnalysis">‚úï</button>
        </div>
        <div class="sidebar-body">
            <div class="analysis-summary md-content">
                @MarkdownHelper.ToHtml(_issue.Analysis.Summary)
            </div>

            @if (_issue.Analysis.KeySignals is { Count: > 0 })
            {
                <div class="sidebar-section sidebar-signals">
                    <h4 title="Direct quotes from the issue that drove triage decisions">Key Signals</h4>
                    @foreach (var signal in _issue.Analysis.KeySignals)
                    {
                        <div class="signal-card">
                            <blockquote class="signal-quote">"@signal.Text"</blockquote>
                            <span class="evidence-source">‚Äî @signal.Source</span>
                            <div class="signal-interp md-content">@MarkdownHelper.ToHtml(signal.Interpretation)</div>
                        </div>
                    }
                </div>
            }

            @if (_issue.Analysis.CodeInvestigation is { Count: > 0 })
            {
                <div class="sidebar-section sidebar-code-investigation">
                    <h4 title="Source code files examined during investigation">Code Investigation</h4>
                    @foreach (var entry in _issue.Analysis.CodeInvestigation)
                    {
                        <div class="code-investigation-card">
                            <div class="code-file-ref">
                                <a href="@GetFileUrl(entry)" target="_blank" rel="noopener" title="View on GitHub">
                                    <code>@entry.File</code>
                                    @if (!string.IsNullOrEmpty(entry.Lines) && entry.Lines != "N/A")
                                    {
                                        <span class="code-lines">L@(entry.Lines)</span>
                                    }
                                </a>
                            </div>
                            <div class="code-relevance md-content">@MarkdownHelper.ToHtml(entry.Relevance)</div>
                        </div>
                    }
                </div>
            }

            @if (_issue.Analysis.FieldRationales is { Count: > 0 })
            {
                <div class="sidebar-section sidebar-rationales">
                    <h4 title="Why each classification field was chosen, with alternatives considered">Field Rationales</h4>
                    @foreach (var fr in _issue.Analysis.FieldRationales)
                    {
                        <div class="rationale-card">
                            <div class="rationale-header">
                                <span class="label label-field">@fr.Field</span>
                                <span class="rationale-chosen">‚Üí @fr.Chosen</span>
                            </div>
                            <div class="reason-text md-content">@MarkdownHelper.ToHtml(fr.ExpandedReason)</div>
                            @if (fr.Alternatives is { Count: > 0 })
                            {
                                <details class="alternatives">
                                    <summary>@fr.Alternatives.Count alternative(s) considered</summary>
                                    @foreach (var alt in fr.Alternatives)
                                    {
                                        <div class="alt-item">
                                            <span class="alt-value">@alt.Value</span>
                                            <span class="alt-rejected">‚Äî @alt.WhyRejected</span>
                                        </div>
                                    }
                                </details>
                            }
                        </div>
                    }
                </div>
            }

            @if (_issue.Analysis.Uncertainties is { Count: > 0 })
            {
                <div class="sidebar-section sidebar-uncertainties">
                    <h4 title="What's unclear ‚Äî information that would improve the triage if available">Uncertainties</h4>
                    <ul class="uncertainty-list">
                        @foreach (var u in _issue.Analysis.Uncertainties)
                        {
                            <li>@u</li>
                        }
                    </ul>
                </div>
            }

            @if (_issue.Analysis.Assumptions is { Count: > 0 })
            {
                <div class="sidebar-section sidebar-assumptions">
                    <h4 title="Explicit assumptions made when evidence was insufficient">Assumptions</h4>
                    <ul class="assumption-list">
                        @foreach (var a in _issue.Analysis.Assumptions)
                        {
                            <li>@a</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
    <div class="analysis-backdrop @(_analysisOpen ? "open" : "")" @onclick="ToggleAnalysis"></div>

    <!-- Bottom Navigation -->
    <div class="triage-detail-nav bottom-nav">
        <a href="@BackUrl" class="btn-back">‚Üê Back to list</a>
        <div class="nav-position">
            @if (_prevNumber is not null)
            {
                <a href="@DetailUrl(_prevNumber.Value)" class="btn-prev">‚Üê #@_prevNumber</a>
            }
            <span class="nav-counter">@(_currentIndex + 1) of @_totalCount</span>
            @if (_nextNumber is not null)
            {
                <a href="@DetailUrl(_nextNumber.Value)" class="btn-next">#@_nextNumber ‚Üí</a>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int Number { get; set; }

    [SupplyParameterFromQuery] public string? Action { get; set; }
    [SupplyParameterFromQuery] public string? Type { get; set; }
    [SupplyParameterFromQuery] public string? Area { get; set; }
    [SupplyParameterFromQuery] public string? Severity { get; set; }
    [SupplyParameterFromQuery] public string? Sort { get; set; }
    [SupplyParameterFromQuery] public string? Card { get; set; }

    private TriageData? _data;
    private TriagedIssue? _issue;
    private int? _prevNumber;
    private int? _nextNumber;
    private int _currentIndex;
    private int _totalCount;
    private bool _loading = true;
    private bool _analysisOpen;

    protected override async Task OnInitializedAsync()
    {
        _data = await DataService.GetTriageDataAsync();
        LoadIssue();
        _loading = false;
    }

    protected override void OnParametersSet()
    {
        if (!_loading)
            LoadIssue();
    }

    private void ToggleAnalysis() => _analysisOpen = !_analysisOpen;

    private string? GetRationale(string fieldName)
    {
        if (_issue?.Analysis.FieldRationales is null) return null;
        var match = _issue.Analysis.FieldRationales.FirstOrDefault(r =>
            r.Field.Equals(fieldName, StringComparison.OrdinalIgnoreCase) ||
            r.Field.StartsWith(fieldName, StringComparison.OrdinalIgnoreCase));
        return match?.ExpandedReason;
    }

    private void LoadIssue()
    {
        if (_data is null) return;

        var filtered = ApplyFilters(_data.Issues);
        _totalCount = filtered.Count;
        _currentIndex = filtered.FindIndex(i => i.Meta.Number == Number);

        if (_currentIndex >= 0)
        {
            _issue = filtered[_currentIndex];
            _prevNumber = _currentIndex > 0 ? filtered[_currentIndex - 1].Meta.Number : null;
            _nextNumber = _currentIndex < filtered.Count - 1 ? filtered[_currentIndex + 1].Meta.Number : null;
        }
        else
        {
            _issue = _data.Issues.FirstOrDefault(i => i.Meta.Number == Number);
            _prevNumber = null;
            _nextNumber = null;
            _totalCount = _data.Issues.Count;
            _currentIndex = _data.Issues.FindIndex(i => i.Meta.Number == Number);
        }
    }

    private List<TriagedIssue> ApplyFilters(List<TriagedIssue> issues)
    {
        var query = issues.AsEnumerable();

        if (!string.IsNullOrEmpty(Card))
        {
            query = Card switch
            {
                "needs-investigation" => query.Where(i => i.Output.Actionability.SuggestedAction == SuggestedAction.NeedsInvestigation),
                "closeable" => query.Where(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true),
                "quick-wins" => query.Where(i => i.Output.Actions?.Any(a => a.Type == ActionType.CloseIssue) == true && i.Output.Actionability.RequiresHumanReview != true),
                "regressions" => query.Where(i => i.Evidence.Regression?.IsRegression == true),
                "human-review" => query.Where(i => i.Output.Actionability.RequiresHumanReview == true),
                _ => query
            };
        }

        if (!string.IsNullOrEmpty(Action))
            query = query.Where(i => i.Output.Actionability.SuggestedAction.ToJsonString() == Action);
        if (!string.IsNullOrEmpty(Type))
            query = query.Where(i => i.Classification.Type.Value == Type);
        if (!string.IsNullOrEmpty(Area))
            query = query.Where(i => i.Classification.Area.Value == Area);
        if (!string.IsNullOrEmpty(Severity))
            query = query.Where(i => i.Evidence.BugSignals?.Severity.ToJsonString() == Severity);

        var sort = Sort ?? "newest";
        query = sort switch
        {
            "confidence" => query.OrderByDescending(i => i.Output.Actionability.Confidence),
            "severity" => query.OrderByDescending(i => SeverityOrder(i.Evidence.BugSignals?.Severity)),
            _ => query.OrderByDescending(i => i.Meta.Number)
        };

        return query.ToList();
    }

    private string BackUrl
    {
        get
        {
            var parts = new List<string>();
            if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
            if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
            if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
            if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
            if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
            if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
            return parts.Count > 0 ? $"triage?{string.Join('&', parts)}" : "triage";
        }
    }

    private string DetailUrl(int number)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(Card)) parts.Add($"card={Card}");
        if (!string.IsNullOrEmpty(Action)) parts.Add($"action={Action}");
        if (!string.IsNullOrEmpty(Type)) parts.Add($"type={Type}");
        if (!string.IsNullOrEmpty(Area)) parts.Add($"area={Area}");
        if (!string.IsNullOrEmpty(Severity)) parts.Add($"severity={Severity}");
        if (!string.IsNullOrEmpty(Sort) && Sort != "newest") parts.Add($"sort={Sort}");
        return parts.Count > 0 ? $"triage/{number}?{string.Join('&', parts)}" : $"triage/{number}";
    }

    private static int SeverityOrder(BugSeverity? severity) => severity switch
    {
        BugSeverity.Critical => 4, BugSeverity.High => 3, BugSeverity.Medium => 2, BugSeverity.Low => 1, _ => 0
    };

    private static string FormatLabel(string value) =>
        string.Join(' ', StripPrefix(value).Split('-').Select(w =>
            w.Length > 0 ? char.ToUpper(w[0]) + w[1..] : w));

    private static string StripPrefix(string value)
    {
        var slashIndex = value.IndexOf('/');
        return slashIndex >= 0 ? value[(slashIndex + 1)..] : value;
    }

    private static string GetConfidenceClass(double c) => c switch
    {
        >= 0.85 => "confidence-high",
        >= 0.70 => "confidence-medium",
        _ => "confidence-low"
    };

    private static string GetRiskStyle(ActionRisk risk) => risk switch
    {
        ActionRisk.Low => "background: #28a745; color: white;",
        ActionRisk.Medium => "background: #ffc107; color: #212529;",
        ActionRisk.High => "background: #dc3545; color: white;",
        _ => ""
    };

    private static string GetReproTooltip(ReproQuality quality) => quality switch
    {
        ReproQuality.Complete => "Full reproducible project provided ‚Äî easiest to diagnose",
        ReproQuality.Partial => "Code snippets provided ‚Äî requires assembling into repro",
        ReproQuality.StepsOnly => "Only reproduction steps described ‚Äî no code or project",
        ReproQuality.None => "No reproduction material ‚Äî diagnosis will be difficult",
        _ => "Reproduction quality assessment"
    };

    private static string GetRiskTooltip(ActionRisk risk) => risk switch
    {
        ActionRisk.Low => "Reversible action, cosmetic change ‚Äî safe to auto-apply",
        ActionRisk.Medium => "State change that requires moderate caution",
        ActionRisk.High => "Irreversible or reputation-sensitive ‚Äî needs human review",
        _ => "Action risk level"
    };

    private static string GetActionTypeTooltip(ActionType type) => type switch
    {
        ActionType.UpdateLabels => "Add or remove GitHub labels on the issue",
        ActionType.AddComment => "Post a comment on the issue thread",
        ActionType.CloseIssue => "Close the issue with a reason",
        ActionType.LinkDuplicate => "Mark as duplicate of another issue",
        ActionType.LinkRelated => "Cross-reference related issues",
        ActionType.ConvertToDiscussion => "Convert issue to a GitHub Discussion",
        ActionType.UpdateProject => "Update GitHub project fields",
        ActionType.SetMilestone => "Set milestone on the issue",
        _ => $"Action: {type}"
    };

    private static string GetCommentTypeTooltip(CommentType type) => type switch
    {
        CommentType.Answer => "Direct answer to a support question",
        CommentType.Documentation => "Pointer to relevant docs, samples, or guides",
        CommentType.RequestInfo => "Ask for missing details before proceeding",
        CommentType.CloseMessage => "Explanation provided when closing the issue",
        CommentType.DuplicateNotice => "Reference to the canonical/original issue",
        CommentType.Workaround => "Actionable workaround with code snippet",
        _ => $"Comment type: {type}"
    };

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch { }
    }

    private string GetFileUrl(CodeInvestigationEntry entry)
    {
        var repo = _issue?.Meta.Repo ?? "mono/SkiaSharp";
        var file = entry.File.TrimEnd('/');
        var url = $"https://github.com/{repo}/blob/main/{file}";
        if (!string.IsNullOrEmpty(entry.Lines) && entry.Lines != "N/A" && entry.Lines.Contains('-'))
        {
            var parts = entry.Lines.Split('-');
            if (parts.Length == 2)
                url += $"#L{parts[0]}-L{parts[1]}";
        }
        else if (!string.IsNullOrEmpty(entry.Lines) && entry.Lines != "N/A")
        {
            url += $"#L{entry.Lines}";
        }
        return url;
    }

    [Inject] private Microsoft.JSInterop.IJSRuntime JSRuntime { get; set; } = default!;
}
